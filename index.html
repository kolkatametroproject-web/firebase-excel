<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- OFFICIAL METRO THEME --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
}

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
}
button:hover { background: #004494; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; }
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; transform: scaleX(-1); }

/* UPLOAD SECTION SPECIFIC */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* CHECKBOX LIST FOR ADMIN */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #ced4da;
    padding: 10px;
    background: #fff;
    text-align: left;
}
.checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; }
.checkbox-item input { width: auto; margin-right: 10px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #555; border: 2px solid #888; }
.dot.active { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div><h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:300px; text-align:center;">
        <h3>User Profile Setup</h3>
        <p>Please enter your official name for the records.</p>
        <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
  
  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
      <div id="dot1" class="dot"></div>
      <div id="dot2" class="dot"></div>
      <div id="dot3" class="dot"></div>
  </div>

  <video id="cameraFeed" autoplay playsinline muted></video>
  
  <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:5px; width:280px; box-shadow: 0 0 15px black;">
    <h3 style="color:#dc3545; margin-top:0;">Face ID Failed (3/3)</h3>
    <p style="color:#333; font-size:13px;">Camera Disabled.<br>Enter OTP/PIN:</p>
    <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:18px; letter-spacing:5px; border:2px solid #dc3545;">
    <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
  </div>

  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold;"></div>
  
  <div id="camControls" style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Face Scan</button>
  </div>

  <button id="adminBypassBtn" class="danger hidden" style="margin-top:20px;" onclick="forceAdminEntry()">‚ö†Ô∏è ADMIN FORCE ENTRY</button>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <input id="inpStationName" placeholder="STATION NAME">
          <input id="inpStationLength" placeholder="STATION LENGTH (M)">
          <input id="inpYellowDist" placeholder="YELLOW LINE DIST (CM)">
          <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS (CM)">
      </div>
      <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
      <div style="text-align:right;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Draft</button>
      </div>
    </div>

    <div class="panel upload-panel" style="border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center;">
      <h3 style="color:#003366; margin-top:0;">üìé Evidence Upload Section</h3>
      <p style="font-size:12px; color:#666;">Upload site photos, videos, or PDFs separately here.</p>
      
      <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
      <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
      
      <button class="warning" onclick="uploadEvidenceOnly()">‚¨Ü Upload Evidence to Database</button>
      <div style="margin-top:5px;"><small style="color:red;">* Max 1.5 MB per file (Strict Limit)</small></div>
    </div>

    <div class="panel">
      <h4>Distance Data</h4>
      <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final Data</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between;"><h3>üì¶ Inventory</h3><button class="success" onclick="document.getElementById('addInvForm').classList.toggle('hidden')">+ New Item</button></div>
        <div id="addInvForm" class="hidden" style="padding:15px; border:1px solid #ccc; margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 100px; gap:10px;">
                <input id="invName" placeholder="Product Name"><input id="invQty" type="number" placeholder="Qty"><button onclick="addInventory()">Save</button>
            </div>
        </div>
        <table><thead><tr><th>Product</th><th>Qty</th><th>User</th><th>Action</th></tr></thead><tbody id="inventoryBody"></tbody></table>
    </div>
  </div>

  <div id="tab-gallery" class="hidden">
    <div class="panel">
      <h3>üìÅ Site Evidence Gallery</h3>
      <div id="galleryContainer" class="gallery-grid"></div>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã My Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ°Ô∏è Administrator Console</h3>
        <button onclick="loadAdminPanel()" class="primary">üîÑ Refresh</button>
      </div>

      <h4 style="background:#eee; padding:5px;">1. Work Assignment (Multi-Select)</h4>
      <label>Select Students/Users:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="1" placeholder="Enter Task Details..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:5px;">Assign to Selected Users</button>
      </div>

      <h4 style="background:#eee; padding:5px;">2. User Access & Corrections</h4>
      <table><thead><tr><th>Name (User)</th><th>Biometric Status</th><th>Status</th><th>Admin Actions</th></tr></thead><tbody id="userListBody"></tbody></table>
      
      <h4 style="background:#eee; padding:5px;">3. Monitor Specific User (Real-Time)</h4>
      <div style="margin-bottom:10px;">
          <label>Select User to Monitor:</label>
          <select id="searchUserDropdown" style="width:100%; padding:8px; border:1px solid #003366;" onchange="viewSpecificUserLogs()">
              <option value="">-- Select User --</option>
          </select>
      </div>
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:20px; max-height:150px; overflow-y:scroll; background:#fafafa;">
          <table style="margin-top:0;">
              <thead><tr><th>Time</th><th>Type</th><th>Details</th></tr></thead>
              <tbody id="searchLogBody"><tr><td colspan="3" style="text-align:center; color:grey;">Select a user to view live activity.</td></tr></tbody>
          </table>
      </div>

      <h4 style="background:#eee; padding:5px;">4. Global Task Status Report</h4>
      <table style="margin-bottom:20px;"><thead><tr><th>To (Name)</th><th>Task</th><th>Status</th><th>Action</th></tr></thead><tbody id="globalTaskBody"></tbody></table>

      <h4 style="background:#eee; padding:5px;">5. Recent System Activity (Global Log)</h4>
      <div style="height:300px; overflow-y:scroll; border:1px solid #ccc; background:#fff;">
        <table>
          <thead>
            <tr>
              <th style="position:sticky; top:0; background:#e9ecef;">Time</th>
              <th style="position:sticky; top:0; background:#e9ecef;">User</th>
              <th style="position:sticky; top:0; background:#e9ecef;">Action / Method</th>
            </tr>
          </thead>
          <tbody id="globalLogBody">
             <tr><td colspan="3" style="text-align:center;">Loading logs...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo, get, limitToLast } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let logListenerUnsubscribe = null; 
let regSamples = []; 
let modelsLoaded = false; // Flag to prevent re-loading

// --- 1. OPTIMIZATION: LOAD AI MODELS IMMEDIATELY ---
async function preloadModels() {
    if(modelsLoaded) return; 
    const modelUrl = 'https://justadudewhohacks.github.io/face-api.js/models';
    console.log("Starting Model Preload...");
    try {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
            faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
            faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
        ]);
        modelsLoaded = true;
        console.log("Models Loaded Successfully");
    } catch(e) { console.error("Model Load Failed", e); }
}
preloadModels(); // Call immediately on script load

// --- AUTH & AUTO LOGOUT ---
onAuthStateChanged(auth, (user) => {
  if (!user) { showLogin(); return; }
  
  setupIdleTimer();
  update(ref(db, `users/${user.uid}`), { email: user.email });

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const u = snap.val();
    if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    currentUser = user;
    isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
    failCount = 0;
    
    // 1. Check Name
    if (!u.name) {
        document.getElementById("nameModal").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        return;
    }

    if (!u.pin) { update(ref(db, `users/${user.uid}`), { pin: "1234" }); }

    document.getElementById("userInfo").innerText = `${u.name} (${user.email})`;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("adminBypassBtn").classList.remove("hidden");
      setTimeout(loadAdminPanel, 1000); 
    }

    // 2. CHECK FACE DATA FOR REGISTRATION
    const faceModal = document.getElementById("faceModal");
    faceModal.classList.remove("hidden");
    
    if(!u.faceData) {
        // ENROLLMENT MODE
        document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup (3 Steps)";
        document.getElementById("modalDesc").innerText = "Security Requirement: We need 3 scans of your face.";
        
        document.getElementById("regProgress").classList.remove("hidden");
        updateRegDots(regSamples.length);
        
        document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${regSamples.length + 1} of 3`;
        document.getElementById("btnCapture").onclick = registerNewFace; 
        updateStatus("Ready to Register. Look at camera.", "cyan");
        initCamera(false);
    } else {
        // VERIFICATION MODE
        document.getElementById("modalTitle").innerText = "Biometric Verification";
        document.getElementById("modalDesc").innerText = "System Ready.";
        document.getElementById("regProgress").classList.add("hidden");
        document.getElementById("btnCapture").innerText = "üì∏ Face Scan";
        document.getElementById("btnCapture").onclick = handleFaceScan; 
        initCamera(true);
    }
  });
});

function updateRegDots(count) {
    document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
    document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
    document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

// --- IDLE LOGIC ---
function setupIdleTimer() {
    clearTimeout(idleTimer);
    window.onmousemove = resetTimer;
    window.onclick = resetTimer;
    resetTimer(); 
}
function resetTimer() {
    clearTimeout(idleTimer);
    if(currentUser) {
        idleTimer = setTimeout(() => {
            alert("Session Timeout. Logging out.");
            logActivity("LOGOUT", "Auto-Timeout").then(()=>signOut(auth));
        }, 4 * 60 * 1000); 
    }
}

window.saveOfficialName = () => {
    const name = document.getElementById("officialNameInput").value;
    if(name.length < 3) return alert("Enter full valid name.");
    update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
        document.getElementById("nameModal").classList.add("hidden");
        location.reload(); 
    });
}

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
window.logout = () => { 
    if(currentUser) {
        logActivity("LOGOUT", "User Clicked Logout").then(() => signOut(auth));
    }
};

// --- BIOMETRICS ---
async function initCamera(isVerify) {
    const vid = document.getElementById("cameraFeed");
    try {
        if(!modelsLoaded) updateStatus("Loading AI Models...", "yellow");
        else updateStatus("Starting Camera...", "white");

        // Wait for models if not ready
        if(!modelsLoaded) await preloadModels();

        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        vid.srcObject = stream;
        
        if(isVerify) updateStatus("üîí VERIFICATION REQUIRED", "white");
        else updateStatus("üìù REGISTRATION MODE", "cyan");
    } catch(e) { updateStatus("Camera Failed.", "red"); }
}

function stopCamera() { 
    if(stream) {
        stream.getTracks().forEach(t => t.stop()); 
        stream = null;
    }
    const vid = document.getElementById("cameraFeed");
    if(vid) vid.srcObject = null;
    document.getElementById("faceModal").classList.add("hidden"); 
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }

// --- ENROLLMENT LOGIC (OPTIMIZED: 224px) ---
window.registerNewFace = async () => {
    const vid = document.getElementById("cameraFeed");
    const btn = document.getElementById("btnCapture");
    updateStatus("Scanning...", "cyan");
    
    // Tiny options with 224 input size is VERY FAST
    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
    const detection = await faceapi.detectSingleFace(vid, options).withFaceLandmarks().withFaceDescriptor();

    if(detection) {
        regSamples.push(Array.from(detection.descriptor));
        
        const count = regSamples.length;
        updateRegDots(count);

        if(count < 3) {
            updateStatus(`‚úÖ Sample ${count}/3 Saved! Move head & click.`, "lightgreen");
            btn.innerText = `üì∏ Capture Sample ${count + 1} of 3`;
        } else {
            updateStatus("Finalizing...", "yellow");
            await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
            alert("Registration Complete!");
        }

    } else {
        updateStatus("‚ùå No Face Detected. Try Again.", "red");
    }
};

// --- VERIFICATION LOGIC (OPTIMIZED) ---
window.handleFaceScan = async () => {
    const vid = document.getElementById("cameraFeed");
    const btn = document.getElementById("btnCapture");
    btn.disabled = true; updateStatus("Scanning...", "cyan");

    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
    const detection = await faceapi.detectSingleFace(vid, options).withFaceLandmarks().withFaceDescriptor();

    if(!detection) { 
        updateStatus("‚ùå No Face Detected", "red"); 
        handleFail();
        btn.disabled = false;
        return; 
    }
    
    // Retrieve stored data
    const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
    const storedData = snap.val();
    let matchFound = false;
    
    if(storedData) {
        const currentDesc = detection.descriptor;
        if(storedData[0] instanceof Array || Array.isArray(storedData[0])) {
             for (let sample of storedData) {
                 const dist = faceapi.euclideanDistance(sample, currentDesc);
                 if(dist < 0.5) { matchFound = true; break; } 
             }
        } else {
             const dist = faceapi.euclideanDistance(storedData, currentDesc);
             if(dist < 0.5) matchFound = true;
        }
    }

    if(matchFound) {
        logActivity("LOGIN [Face]", "Biometric Success");
        enterApp();
    } else {
        updateStatus("‚ùå Face Mismatch.", "red");
        handleFail();
        btn.disabled = false;
    }
};

function handleFail() {
    failCount++;
    if(failCount >= 3) {
        stopCamera(); 
        document.getElementById("faceModal").classList.remove("hidden");
        document.getElementById("cameraFeed").classList.add("hidden");
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden"); 
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${3 - failCount}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            logActivity("LOGIN [OTP]", "PIN Entry Success");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

window.forceAdminEntry = () => {
    if(!isAdmin) return;
    logActivity("LOGIN [Admin Bypass]", "Force Entry Used");
    enterApp();
}

function enterApp() {
    stopCamera(); 
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadGallery(); loadInventory(); loadAssignments();
}

// --- APP FEATURES ---

window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    if(!name) return alert("Station Name Required");
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name,
        len: document.getElementById("inpStationLength").value,
        yl: document.getElementById("inpYellowDist").value,
        th: document.getElementById("inpYellowThick").value,
        remarks: document.getElementById("inpRemarks").value
    });
    logActivity("SAVE", "Draft Updated"); alert("Draft Saved");
};

window.uploadEvidenceOnly = () => {
    if(!currentFileBase64) return alert("Select a file first.");
    
    if(confirm("Upload Evidence?")) {
        push(ref(db, "history"), { 
            name: "Evidence Upload", 
            user: currentUser.email, 
            userName: currentUser.name, 
            date: new Date().toLocaleString(),
            fileData: currentFileBase64, 
            fileType: currentFileType
        }).then(() => {
            document.getElementById("evidenceFile").value = "";
            document.getElementById("fileStatus").innerText = "";
            currentFileBase64 = null;
            alert("Evidence Uploaded."); 
            switchTab('gallery');
        });
    }
};

window.submitStationData = () => {
    get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
        const d = s.val();
        if(!d || !d.details) return alert("No Data.");
        if(confirm("Submit Final?")) {
            push(ref(db, "history"), { 
                ...d.details, rows: d.rows, user: currentUser.email, userName: currentUser.name, date: new Date().toLocaleString()
            }).then(() => {
                remove(ref(db, `drafts/${currentUser.uid}`));
                alert("Submitted"); switchTab('gallery');
            });
        }
    });
};

// --- ADMIN LOGIC ---
window.loadAdminPanel = async () => {
    const userList = document.getElementById("userCheckboxList");
    const userTable = document.getElementById("userListBody");
    const reportTable = document.getElementById("globalTaskBody");
    const searchDropdown = document.getElementById("searchUserDropdown");
    
    userList.innerHTML = "Loading...";
    searchDropdown.innerHTML = `<option value="">-- Select User to Monitor --</option>`;

    // 1. Fetch Users & Build Name Map
    const userMap = {};
    const userSnap = await get(ref(db, "users"));
    
    userTable.innerHTML = "";
    userList.innerHTML = "";

    userSnap.forEach(c => {
        const u = c.val();
        const uid = c.key;
        const displayName = u.name || u.email;
        userMap[uid] = displayName; 

        // Checkbox
        userList.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="user-check" value="${uid}"> ${displayName}</label>`;

        // Dropdown (Value is UID now for direct log access)
        searchDropdown.innerHTML += `<option value="${uid}">${displayName} (${u.email})</option>`;

        // Access Table
        const bioStatus = u.faceData ? '<span style="color:green; font-weight:bold;">‚úî Registered</span>' : '<span style="color:red; font-weight:bold;">‚ùå Not Set</span>';
        const pinInput = `<input id="pin_${uid}" placeholder="${u.pin||'1234'}" style="width:50px; text-align:center;"> <button onclick="savePin('${uid}')" style="padding:2px 5px;">Set</button>`;
        const reUploadBtn = `<button class="danger" style="padding:2px 5px;" onclick="forceReUpload('${uid}')">Re-upload Face</button>`;
        const resetNameBtn = `<button class="warning" style="padding:2px 5px;" onclick="retakeName('${uid}')">Reset Name</button>`;

        userTable.innerHTML += `<tr>
            <td>${u.name}<br><small>${u.email}</small></td>
            <td>${bioStatus}</td>
            <td>${u.terminated ? "BANNED" : "Active"}</td>
            <td>${pinInput}<br>${reUploadBtn} ${resetNameBtn}</td>
        </tr>`;
    });

    // 2. Fetch Tasks
    const taskSnap = await get(ref(db, "assignments"));
    reportTable.innerHTML = "";
    taskSnap.forEach(userNode => {
        const uid = userNode.key;
        const recipientName = userMap[uid] || "Unknown User"; 

        userNode.forEach(task => {
            const t = task.val();
            const clearBtn = `<button class="danger" style="padding:2px 5px; font-size:10px;" onclick="removeTask('${userNode.key}', '${task.key}')">Clear</button>`;
            reportTable.innerHTML += `<tr>
                <td>${recipientName}</td>
                <td>${t.desc}</td>
                <td style="color:${t.status=='Done'?'green':'red'}">${t.status}</td>
                <td>${clearBtn}</td>
            </tr>`;
        });
    });

    // 3. Global Logs Listener
    const globBody = document.getElementById("globalLogBody");
    onValue(query(ref(db, "logs"), limitToLast(15)), (snap) => {
        globBody.innerHTML = "";
        const logs = [];
        snap.forEach(c => logs.push(c.val()));
        
        logs.reverse().forEach(x => {
            let color = "#333";
            let bg = "transparent";

            // Color Coding
            if(x.type.includes("LOGIN")) { color = "green"; bg = "#eaffea"; }
            if(x.type.includes("LOGOUT")) { color = "red"; bg = "#ffeaea"; }
            if(x.type.includes("Fail") || x.type.includes("Bypass")) { color = "orange"; }

            globBody.innerHTML += `
            <tr style="background:${bg}">
                <td style="font-size:12px; white-space:nowrap;">${x.time}</td>
                <td style="font-size:12px;">${x.user}</td>
                <td style="color:${color}; font-weight:bold; font-size:12px;">
                    ${x.type} <br>
                    <span style="font-weight:normal; color:#666; font-size:10px;">${x.desc}</span>
                </td>
            </tr>`;
        });
    });
}

// --- 2. LOGGING FIXED ---
// REAL-TIME USER SPECIFIC LOGS (UPDATED to userLogs/{uid})
window.viewSpecificUserLogs = () => {
    const targetUid = document.getElementById("searchUserDropdown").value;
    const body = document.getElementById("searchLogBody");

    if(logListenerUnsubscribe) {
        logListenerUnsubscribe(); 
        logListenerUnsubscribe = null;
    }

    if(!targetUid) {
        body.innerHTML = "<tr><td colspan='3' style='text-align:center;color:gray'>Select a user to monitor.</td></tr>";
        return;
    }
    
    body.innerHTML = "<tr><td colspan='3'>Connecting to live feed...</td></tr>";

    // UPDATED: Reading from specific userLogs node
    const q = query(ref(db, `userLogs/${targetUid}`), limitToLast(20));
    
    logListenerUnsubscribe = onValue(q, (snap) => {
        body.innerHTML = "";
        if(!snap.exists()) {
            body.innerHTML = "<tr><td colspan='3'>No logs found for this user yet.</td></tr>";
            return;
        }
        const logs = [];
        snap.forEach(c => logs.push(c.val()));
        
        logs.reverse().forEach(x => {
            let color = "black";
            if (x.type.includes("LOGIN")) color = "green";
            if (x.type.includes("LOGOUT")) color = "red";
            if (x.type.includes("Fail")) color = "orange";
            
            body.innerHTML += `<tr>
                <td style="font-size:12px;">${x.time}</td>
                <td style="color:${color}; font-weight:bold;">${x.type}</td>
                <td>${x.desc}</td>
            </tr>`;
        });
    });
}

window.assignTaskMulti = () => {
    const desc = document.getElementById("taskDesc").value;
    if(!desc) return alert("Please enter task details.");
    const checkboxes = document.querySelectorAll('.user-check:checked');
    if(checkboxes.length === 0) return alert("Select at least one user.");

    checkboxes.forEach(cb => {
        const uid = cb.value;
        const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };
        push(ref(db, `assignments/${uid}`), task);
    });

    alert(`Task assigned to ${checkboxes.length} user(s).`);
    document.getElementById("taskDesc").value = "";
    checkboxes.forEach(cb => cb.checked = false);
    loadAdminPanel();
};

window.savePin = (uid) => {
    const p = document.getElementById(`pin_${uid}`).value;
    if(p.length >= 4) { update(ref(db, `users/${uid}`), { pin: p }); alert("PIN Updated"); }
}

window.forceReUpload = (uid) => {
    if(confirm("Reset Face Data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset. User must scan face on next login.")); }
}
window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));
window.removeTask = (uid, tid) => remove(ref(db, `assignments/${uid}/${tid}`)).then(loadAdminPanel);

// UPDATED LOGGING FUNCTION: Writes to TWO places
async function logActivity(type, desc) { 
    if(currentUser) {
        const logData = { user: currentUser.email, type, desc, time: new Date().toLocaleString() };
        
        // 1. Global System Log (Kept for overall admin view)
        await push(ref(db, "logs"), logData);

        // 2. User Specific Log (Fixed path)
        await push(ref(db, `userLogs/${currentUser.uid}`), logData);
    } 
}

window.switchTab = (t) => {
    ['newData','inventory','gallery','assigned','adminPanel'].forEach(x => document.getElementById(`tab-${x}`).classList.add("hidden"));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.remove("hidden");
    if(t==='adminPanel' && isAdmin) loadAdminPanel();
    if(t==='gallery') loadGallery();
};

window.handleFileUpload = () => {
    const file = document.getElementById("evidenceFile").files[0];
    document.getElementById("fileStatus").innerText = "Processing...";
    if(file && file.size < 1.5*1024*1024) { 
        const reader = new FileReader();
        reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
        reader.readAsDataURL(file);
    } else { 
        alert("File too large! Max 1.5MB"); 
        document.getElementById("fileStatus").innerText = "Error: File too large";
    }
}

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
    const div = document.getElementById("galleryContainer"); 
    div.innerHTML = "<p>Loading...</p>";

    onValue(ref(db, "history"), snap => {
        div.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            if(v.fileData) {
                let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
                if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
                else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
                
                let controls = `<br><small style="color:grey;">(View Only)</small>`;
                if(isAdmin) {
                    controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
                }
                div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
            }
        });
        if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
    });
}

window.removeFile = (k) => {
    if(confirm("Remove attached file?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            document.getElementById("inpRemarks").value = d.details?.remarks || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}
function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("inventoryBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr><td>${v.item}</td><td>${v.qty}</td><td>${v.user}</td><td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td></tr>`;
        });
    });
}
window.addInventory = () => { push(ref(db, "inventory"), { item: invName.value, qty: invQty.value, user: currentUser.email }); document.getElementById("addInvForm").classList.add("hidden"); };
window.delInv = (k) => remove(ref(db, `inventory/${k}`));
function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

</script>
</body>
</html>
