<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRPSP | Metro Railway Platform Safety Project</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- OFFICIAL GOVERNMENT & METRO THEME (UPDATED) --- */
:root {
  --metro-blue: #0A2342; /* Deep Professional Navy */
  --metro-gold: #C5A059; /* Metallic Gold Accent */
  --metro-red: #B91C1C;  /* Professional Alert Red */
  --metro-slate: #4A5568; /* Official Slate Text */
  --bg-color: #F8FAFC;    /* Clean Enterprise Background */
  --panel-bg: #FFFFFF;
  --text-main: #1A202C;
  --border-color: #E2E8F0;
  --success-green: #15803d; /* Darker, professional green */
}

body { 
    margin: 0; 
    font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif; 
    background: var(--bg-color); 
    color: var(--text-main); 
    font-size: 14px; 
    line-height: 1.5;
}

/* HEADER - OFFICIAL AUTHORITY STYLE */
header {
  background: var(--metro-blue);
  color: white;
  padding: 12px 25px;
  border-bottom: 4px solid var(--metro-gold);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
  flex-wrap: wrap;
}

/* BUTTONS - ENTERPRISE GRADE */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: var(--metro-blue);
  color: white;
  border: 1px solid #001a33;
  border-radius: 4px;
  font-weight: 600;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.2s ease-in-out;
}
button:hover { background: #163a63; transform: translateY(-1px); }
button:disabled { background: #94a3b8; cursor: not-allowed; border-color: #64748b; opacity: 0.8; transform: none; }

/* STATUS BUTTON VARIANTS */
button.danger { background: var(--metro-red); border-color: #991b1b; }
button.danger:hover { background: #dc2626; }
button.success { background: var(--success-green); border-color: #14532d; }
button.success:hover { background: #166534; }
button.warning { background: #d97706; color: white; border-color: #b45309; }
button.info { background: #0284c7; border-color: #0369a1; color: white; }
button.secondary { background: #64748b; border-color: #475569; color: white; }

/* INPUTS - CLEAN FORM STYLE */
input, select, textarea {
  background: #fff;
  border: 1px solid #cbd5e1;
  color: #334155;
  padding: 10px;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 12px;
  font-size: 14px;
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--metro-blue);
    box-shadow: 0 0 0 2px rgba(10, 35, 66, 0.1);
}

/* LAYOUT */
section { padding: 25px; max-width: 1200px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS - CARD STYLE */
.panel {
  background: var(--panel-bg);
  padding: 30px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 25px;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}
.panel h3 { 
    margin-top: 0; 
    color: var(--metro-blue); 
    border-bottom: 1px solid #e2e8f0; 
    padding-bottom: 15px; 
    margin-bottom: 20px; 
    font-size: 1.15rem; 
    display: flex;
    align-items: center;
    gap: 10px;
}

/* NAVIGATION - TABS STYLE */
.nav-bar { 
    display: flex; 
    gap: 2px; 
    margin-bottom: 25px; 
    border-bottom: 2px solid #e2e8f0; 
    padding-bottom: 0; 
    overflow-x: auto; 
    white-space: nowrap; 
    background: #f1f5f9;
    border-radius: 6px 6px 0 0;
    padding: 5px 5px 0 5px;
}
.nav-btn { 
    background: transparent; 
    color: #64748b; 
    border: none; 
    border-radius: 6px 6px 0 0;
    padding: 12px 20px;
    font-weight: 600;
    transition: all 0.2s;
}
.nav-btn:hover {
    background: #e2e8f0;
    color: var(--metro-blue);
}
.nav-btn.active { 
    background: var(--panel-bg); 
    color: var(--metro-blue); 
    border: 1px solid #e2e8f0;
    border-bottom: 2px solid white; /* Blend with panel */
    margin-bottom: -2px; 
    box-shadow: 0 -2px 5px rgba(0,0,0,0.02);
}

/* DATA TABLES - GOVERNMENT STYLE */
.table-wrapper { 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
    border-radius: 6px; 
    border: 1px solid #e2e8f0; 
}
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; background: white; }
th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
th { 
    background: #f8fafc; 
    color: var(--metro-blue); 
    font-weight: 700; 
    text-transform: uppercase; 
    font-size: 11px; 
    letter-spacing: 0.5px; 
    border-bottom: 2px solid #e2e8f0;
}
tr:nth-child(even) { background-color: #fcfcfc; }
tr:hover { background-color: #f1f5f9; }

/* MODALS */
.modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(15, 23, 42, 0.85); /* Darker, more secure feel */
    backdrop-filter: blur(2px);
    display: flex; justify-content: center; align-items: center; 
    flex-direction: column; z-index: 2000; padding: 20px; box-sizing: border-box; 
}

/* CAMERA UI - HIGH TECH LOOK */
#videoContainer {
    position: relative;
    width: 320px;
    max-width: 100%;
    height: 240px;
    background: #000;
    margin-bottom: 15px;
    border: 4px solid var(--metro-slate);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}
#cameraFeed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}
#overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    transform: scaleX(-1);
}

/* UPLOAD SECTION */
.upload-panel { 
    border: 2px dashed #cbd5e1; 
    background: #f8fafc; 
    padding: 30px; 
    text-align: center; 
    border-radius: 8px; 
    margin-top: 20px; 
    transition: border-color 0.2s;
}
.upload-panel:hover { border-color: var(--metro-blue); background: #f1f5f9; }

/* ADMIN CHECKBOX LIST */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #cbd5e1;
    padding: 15px;
    background: #fff;
    border-radius: 4px;
}
.checkbox-item { 
    display: block; margin-bottom: 8px; cursor: pointer; padding: 5px; border-radius: 4px;
}
.checkbox-item:hover { background: #f1f5f9; }
.checkbox-item input { width: auto; margin-right: 10px; margin-bottom: 0; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
.gallery-item { 
    border: 1px solid #e2e8f0; 
    padding: 10px; 
    border-radius: 6px; 
    text-align: center; 
    background: #fff; 
    transition: transform 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.gallery-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
.gallery-item img { max-width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #94a3b8; border: 2px solid #64748b; }
.dot.active { background: #22c55e; border-color: #16a34a; box-shadow: 0 0 8px #22c55e; }

/* STATUS BADGES */
.badge-online { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #bbf7d0; }
.badge-offline { background: #f1f5f9; color: #64748b; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #e2e8f0; }

/* SIGNATURE CANVAS */
canvas.sig-canvas { border: 2px solid #cbd5e1; background: #fff; cursor: crosshair; touch-action: none; border-radius: 4px; display:block; max-width: 100%; }

/* NEW: BARCODE MODAL STYLES */
#reader { width: 300px; max-width: 100%; background:white; padding:15px; border-radius:8px; }

/* MOBILE RESPONSIVE TWEAKS */
@media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
    #authContainer { margin-top: 10px; align-self: flex-start; }
    .panel { padding: 15px; }
    #videoContainer { width: 100%; height: auto; aspect-ratio: 4/3; }
    .nav-bar { padding-bottom: 5px; }
    .nav-btn { font-size: 12px; padding: 10px 15px; }
    .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    #otpUI { width: 90%; }
}

/* TIMELINE CARD STYLES */
.history-card {
    background: white;
    border-left: 4px solid #cbd5e1;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: relative;
    border: 1px solid #e2e8f0; border-left-width: 4px;
}
.history-card.checkout { border-left-color: #d97706; } /* Warning Orange for OUT */
.history-card.return { border-left-color: #0284c7; }   /* Info Blue for IN */
.history-card.add { border-left-color: #15803d; }      /* Green for ADD */

.hc-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
.hc-user { font-size: 14px; font-weight: bold; color: var(--metro-blue); }
.hc-meta { font-size: 11px; color: #64748b; margin-top: 4px; }

/* --- BANNED SCREEN OVERLAY --- */
.banned-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #450a0a; /* Deep Red */
    color: white;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
}

.banned-card {
    background: white;
    color: #1A202C;
    padding: 40px;
    border-radius: 12px;
    max-width: 500px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 8px solid #991b1b;
}

.banned-timer {
    font-size: 20px;
    font-weight: bold;
    color: #991b1b;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    background: #fee2e2;
    padding: 10px;
    border-radius: 4px;
}

/* ADMIN BAN MODAL */
.ban-btn-select {
    flex: 1;
    padding: 12px;
    background: #f1f5f9;
    color: #334155 !important;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
.ban-btn-select:hover { background: #e2e6ea; }
.ban-btn-select.selected {
    background: var(--metro-red);
    color: white !important;
    border-color: #991b1b;
}

/* INPUTS STYLING FOR BAN MODAL */
.ban-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 14px;
}

/* --- FULL PRINT CSS (LARGE FONTS - AUTHORITY STANDARD) --- */
@media print {
    body { visibility: hidden; background: white; margin: 0; padding: 0; }
    #printableReportContainer {
        visibility: visible;
        position: absolute;
        top: 0; left: 0; width: 100%;
        z-index: 9999;
        background: white;
    }
    #printableReportContainer * { visibility: visible; }
    .no-print { display: none !important; }

    /* A4 MODE */
    body.print-a4 .report-paper {
        width: 100%;
        padding: 40px;
        font-family: 'Times New Roman', serif;
        color: black;
        border: none;
        box-shadow: none;
    }
    body.print-a4 .report-header h2 { 
        font-size: 24pt !important; 
        text-align: center; 
        margin-bottom: 10px; 
        border-bottom: 2px solid black;
        padding-bottom: 15px;
    }
    body.print-a4 .report-meta { font-size: 14pt !important; margin-bottom: 20px; line-height: 1.5; }
    body.print-a4 .report-section-title {
        font-size: 16pt !important;
        font-weight: bold;
        background: #e5e7eb !important;
        border: 2px solid #000;
        padding: 8px;
        margin-top: 25px;
        -webkit-print-color-adjust: exact;
    }
    body.print-a4 .report-table th, 
    body.print-a4 .report-table td {
        font-size: 12pt !important;
        padding: 8px;
        border: 1px solid black;
    }

    /* POS MODE */
    body.print-pos .report-paper {
        width: 100%;
        padding: 0;
        margin: 0;
        font-family: 'Courier New', monospace;
        color: black;
    }
    body.print-pos .report-header h2 { 
        font-size: 18pt !important; 
        text-align: center; 
        font-weight: 900;
        border-bottom: 3px solid black;
        padding-bottom: 5px;
    }
    body.print-pos .report-table td { font-size: 12pt !important; border-bottom: 1px dashed #333; }
}

/* REPORT PREVIEW (SCREEN) */
.report-paper {
    background: white;
    padding: 50px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 800px;
    margin: 40px auto;
    font-family: 'Times New Roman', serif;
    color: #000;
}
.report-header { text-align: center; border-bottom: 2px solid var(--metro-blue); padding-bottom: 20px; margin-bottom: 30px; }
.report-meta { display: flex; justify-content: space-between; margin-bottom: 30px; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
.report-section-title { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px; font-weight: bold; font-size: 14px; margin-top: 30px; color: var(--metro-blue); }
.report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
.report-table th, .report-table td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:45px;height:45px;background:var(--metro-gold);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:4px;flex-shrink:0; font-size: 24px;">M</div>
    <div>
        <h1 style="margin:0; line-height:1.2; font-size: 1.3rem; letter-spacing: 0.5px;">METRO RAILWAY PLATFORM SAFETY PROJECT</h1>
        <small style="color: #cbd5e1; font-weight: 600; text-transform: uppercase; font-size: 10px;">Official Audit & Inspection Portal</small>
    </div>
    <span id="adminBadge" class="hidden" style="background:var(--metro-red); color:white; margin-left:15px; padding:4px 10px; border-radius:12px; font-size:10px; font-weight:bold; letter-spacing: 0.5px;">SYSTEM AUDITOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:11px; margin-right:5px; opacity:0.7;">Logged in as:</span>
    <span id="userInfo" style="margin-right:20px; font-weight:bold; color:var(--metro-gold);"></span>
    <button class="danger" onclick="logout()" style="padding:6px 12px; font-size:11px;">TERMINATE SESSION</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:380px; margin: 80px auto; border-top: 6px solid var(--metro-blue); padding: 40px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
    <div style="text-align:center; margin-bottom:20px;">
        <i class="fas fa-shield-alt" style="font-size: 48px; color: var(--metro-blue);"></i>
        <h3 style="border:none; margin-top:15px; justify-content:center; padding:0;">Metro Platform Safety Project Access</h3>
    </div>
    <input id="email" placeholder="Official Email ID (user@metro.gov)">
    <input id="password" type="password" placeholder="Secure Password">
    <button onclick="login()" style="width:100%; padding:12px; margin-top:15px; font-size: 14px;">VERIFY CREDENTIALS</button>
    
    <p style="font-size:11px; color:#64748b; margin-top:25px; text-align:center; line-height: 1.4;">
        <strong>RESTRICTED SYSTEM:</strong> Unauthorized access is prohibited and monitored. Use of this system constitutes consent to security monitoring and auditing.
    </p>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:350px; max-width:90%; text-align:center;">
        <h3><i class="fas fa-user-edit"></i> Profile Setup</h3>
        <p style="color:#475569; margin-bottom:20px;">Please enter your official name as per records.</p>
        <input id="officialNameInput" placeholder="Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()" class="success" style="width:100%;">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <div class="panel" style="background: #1e293b; border: 1px solid #334155; color: white; width: 360px; text-align:center; padding: 20px;">
      <h2 id="modalTitle" style="color:white; margin-bottom:5px; font-size: 1.2rem;">Biometric Verification</h2>
      <p id="modalDesc" style="color:#94a3b8; margin-bottom:20px; font-size:13px;">Initializing AI Security Models...</p>
      
      <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
          <div id="dot1" class="dot"></div>
          <div id="dot2" class="dot"></div>
          <div id="dot3" class="dot"></div>
      </div>

      <div id="videoContainer" style="margin: 0 auto 20px auto;">
        <video id="cameraFeed" autoplay playsinline muted></video>
        <canvas id="overlayCanvas"></canvas>
      </div>
      
      <div id="otpUI" class="hidden" style="background:white; padding:25px; border-radius:8px; width:280px; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index:20; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <h3 style="color:var(--metro-red); margin-top:0; border-bottom: none;"><i class="fas fa-exclamation-triangle"></i> Verification Failed</h3>
        <p style="color:#333; font-size:13px; margin-bottom: 15px;">Biometric lockout active.<br>Enter Security PIN:</p>
        <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:20px; letter-spacing:8px; border:2px solid var(--metro-red); font-weight: bold;">
        <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
      </div>

      <div id="faceStatus" style="color:var(--metro-gold); margin-bottom:15px; font-weight:bold; height:20px; font-size: 12px; letter-spacing: 0.5px;"></div>
      
      <div id="camControls" style="display:flex; gap:10px; justify-content: center;">
        <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:var(--metro-blue); border:none; padding:12px 25px; font-weight: bold;">üì∏ SCAN FACE</button>
      </div>
  </div>
</div>

<div id="barcodeModal" class="modal-overlay hidden">
    <div class="panel" style="width:360px; max-width:95%; text-align:center; background:#0f172a; border:2px solid var(--metro-gold); padding: 20px;">
        <h3 style="color:white; margin-bottom:15px; border-bottom-color: #334155;"><i class="fas fa-qrcode"></i> Scan Asset Tag</h3>
        <div id="reader" style="border-radius: 8px; overflow: hidden;"></div>
        <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:20px; width:100%;">CANCEL SCAN</button>
    </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
    <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
        <h3>Digital Signature Record</h3>
        <img id="modalSigImage" src="" style="border:1px solid #e2e8f0; background:white; max-width:100%; margin:15px 0; padding: 10px;">
        <br>
        <button onclick="closeSigModal()" class="secondary">Close Viewer</button>
    </div>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew"><i class="fas fa-ruler-combined"></i> Field Inspection</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory"><i class="fas fa-boxes"></i> Asset Tracking</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery"><i class="fas fa-folder-open"></i> Compliance Docs</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign"><i class="fas fa-tasks"></i> Operation Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="color:var(--metro-red); border-color: var(--metro-red);"><i class="fas fa-user-shield"></i> System Oversight</button>
    <button class="nav-btn" onclick="switchTab('dataView')" id="btnDataView"><i class="fas fa-database"></i> Master Logs</button>
    <button class="nav-btn" onclick="switchTab('printReport')" id="btnPrintReport"><i class="fas fa-print"></i> Audit Reports</button>
  </div>

<div id="tab-newData">
  <div class="panel">
    <h3><i class="fas fa-map-marker-alt"></i> Select Inspection Site</h3>
    <label style="font-weight:700; color:var(--metro-blue); font-size: 12px; text-transform: uppercase;">Step 1: Select Corridor</label>
    <select id="lineSelect" onchange="handleLineChange()" style="border:2px solid var(--metro-blue); font-weight:600;">
      <option value="">-- Select Line --</option>
      <option value="Blue Line">Blue Line (North-South: Dakshineswar ‚Üî New Garia)</option>
      <option value="Green Line">Green Line (East-West: Sector V ‚Üî Howrah Maidan)</option>
      <option value="Purple Line">Purple Line (Joka ‚Üî Majerhat)</option>
      <option value="Yellow Line">Yellow Line (Noapara ‚Üî Airport)</option>
      <option value="Orange Line">Orange Line (New Garia ‚Üî Airport)</option>
      <option value="Pink Line">Pink Line (Baranagar ‚Üî Barrackpore)</option>
    </select>

    <label style="font-weight:700; color:var(--metro-blue); margin-top:15px; display:block; font-size: 12px; text-transform: uppercase;">Step 2: Select Station</label>
    <select id="stationSelect" onchange="handleStationChange()" disabled style="background:#f1f5f9;">
      <option value="">-- First Select a Corridor --</option>
    </select>
  </div>

  <div id="mainDataForm" class="hidden">
    
    <div id="dataExistsWarning" class="hidden" style="background:#fff7ed; color:#9a3412; padding:15px; border:1px solid #fed7aa; border-radius:6px; margin-bottom:20px; display: flex; gap: 10px; align-items: center;">
        <i class="fas fa-exclamation-circle" style="font-size: 20px;"></i>
        <div>
            <strong>Existing Record Found</strong><br>
            Primary measurement data is locked. You may append additional rake data below.
        </div>
    </div>

    <div class="panel" id="stationDetailsPanel" style="border-left: 4px solid var(--success-green);">
      <h3 id="formTitle">üìù Yellow Line Specification</h3>
      <input id="inpStationName" type="hidden"> 
      
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:20px; margin-bottom: 20px;">
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">PLATFORM LENGTH (m)</label>
            <input id="inpStationLength" placeholder="e.g. 180">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">YL DISTANCE (cm)</label>
            <input id="inpYellowDist" placeholder="e.g. 85">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">YL THICKNESS (cm)</label>
            <input id="inpYellowThick" placeholder="e.g. 10">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">IMPLEMENTATION STATUS</label>
            <select id="inpImplementation" style="font-weight:bold; border:2px solid var(--metro-blue);">
                <option value="">-- Select Status --</option>
                <option value="YES">‚úÖ COMPLIANT (YES)</option>
                <option value="NO">‚ùå NON-COMPLIANT (NO)</option>
            </select>
          </div>
      </div>
      <label style="font-size:11px; font-weight:bold; color:#64748b;">INSPECTOR REMARKS</label>
      <textarea id="inpRemarks" placeholder="Observations regarding safety compliance..." rows="3"></textarea>
      
      <div style="text-align:right; margin-top: 15px;">
          <button class="secondary" id="btnSaveDraft" onclick="saveStationDetails()"><i class="fas fa-save"></i> Save Draft</button>
      </div>
    </div>

   <div class="panel">
    <h4><i class="fas fa-train"></i> Rake Clearance Data</h4>
    
    <div class="table-wrapper" style="margin-top:15px;">
        <table style="width:100%">
            <thead>
                <tr>
                    <th style="width:50px; text-align:center;">#</th>
                    <th>Rake ID</th>
                    <th>Rake Series</th>
                    <th>Front Clearance (mm)</th>
                    <th>Rear Clearance (mm)</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="distanceBody"></tbody>
        </table>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items: center;">
        <button class="info" onclick="addDistanceRow()">+ Add Measurement Row</button>
        
        <button onclick="submitStationData()" id="btnFinalSubmit" class="success" style="padding: 12px 24px;">
            <i class="fas fa-check-circle"></i> SUBMIT FINAL REPORT
        </button>
    </div>
   </div>

  </div> 
</div>

<div id="tab-inventory" class="hidden">
    
    <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; padding: 10px; background: #e2e8f0; border-radius: 6px;">
        <button onclick="toggleInvMode('list')" class="info"><i class="fas fa-list"></i> View Stock</button>
        <button onclick="toggleInvMode('add')" class="success"><i class="fas fa-plus"></i> New Asset</button>
        <button onclick="toggleInvMode('checkout')" class="warning"><i class="fas fa-sign-out-alt"></i> Checkout</button>
        <button onclick="toggleInvMode('return')" class="info" style="background:var(--metro-blue); border-color:var(--metro-blue);"><i class="fas fa-sign-in-alt"></i> Return</button>
        <button onclick="toggleInvMode('history')" class="secondary"><i class="fas fa-history"></i> Audit Trail</button>
    </div>

<div id="inv-add" class="panel hidden" style="border-top: 4px solid var(--success-green);">
    <h3 style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> Register New Asset</h3>
    <p style="font-size:12px; color:#64748b; margin-bottom: 20px;">
        <strong>Protocol:</strong> Every physical asset must be serialized. Scan unique barcode to verify database availability.
    </p>
      
    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:15px;">
        <div style="display:flex; gap:5px;">
            <input id="invBarcode" placeholder="Scan Unique Asset Tag / Barcode" onchange="checkBarcodeUnique(this.value)">
            <button onclick="openBarcodeScanner('ADD')" class="secondary" style="width:60px; padding:0;"><i class="fas fa-qrcode"></i></button>
        </div>
        <input id="invName" placeholder="Asset Name (e.g. Hilti Drill X4)">
    </div>
      
    <div id="barcodeError" class="hidden" style="background:#fee2e2; color:#991b1b; padding:12px; border-radius:4px; margin-bottom:15px; font-weight: bold; border: 1px solid #fecaca;">
        <i class="fas fa-ban"></i> Error: Duplicate Barcode Detected.
    </div>

    <div style="text-align:left; background:#f8fafc; padding:20px; border:1px solid #e2e8f0; border-radius:6px; margin-bottom:20px;">
        
        <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase;">Storage Facility</label>
        <select id="addLocSelect" onchange="toggleAddOtherInput()" style="margin-bottom:10px;">
            <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
            <option value="Other">Other (Specify...)</option>
        </select>

        <div id="divAddOtherLoc" class="hidden">
            <input id="addLocOther" placeholder="Specify Facility Name" style="background:white;">
        </div>

        <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase; margin-top: 10px; display: block;">Storage Unit / Rack</label>
        <input id="addLocSpot" placeholder="e.g. Cabinet A, Shelf 2">
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <select id="invCondition">
            <option value="New">Condition: New</option>
            <option value="Good" selected>Condition: Good</option>
            <option value="Fair">Condition: Fair</option>
            <option value="Damaged">Condition: Damaged</option>
        </select>
        <button id="btnAddStock" onclick="addUniqueItem()" class="success">REGISTER ASSET</button>
    </div>
</div><div id="inv-checkout" class="panel hidden" style="border-top: 4px solid #d97706;">
    <h3 style="color:#d97706;"><i class="fas fa-sign-out-alt"></i> Asset Checkout Protocol</h3>
    <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
        Scan asset barcode to initiate checkout sequence.
    </p>
    
    <div style="text-align:center; padding:20px; background: #fff7ed; border-radius: 8px;">
        <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px;">
            <i class="fas fa-qrcode"></i> INITIATE SCAN
        </button>
    </div>

    <div id="checkout_display" class="hidden" style="background:#fffbeb; padding:25px; border:1px solid #fcd34d; text-align:center; margin-top:20px; border-radius:6px;">
        <h2 id="checkout_item_name" style="color:#92400e; margin:0 0 10px 0;">--</h2>
        <div style="font-family:'Courier New', monospace; font-size:14px; color:#78350f; margin-bottom:20px;">
            ID: <span id="checkout_item_code" style="font-weight:bold;">--</span>
        </div>
        
        <label style="display:block; text-align:left; font-size:11px; font-weight:bold; color:#92400e; margin-bottom: 5px;">PURPOSE OF USAGE</label>
        <input id="checkoutPurpose" placeholder="e.g. Scheduled Maintenance, Testing" style="border-color: #f59e0b;">

        <div id="btn_checkout_verify" style="margin-top: 15px;">
             <button onclick="submitTransactionNoFace('CHECKOUT')" style="background:#d97706; border:none; width:100%;">
                CONFIRM WITHDRAWAL
             </button>
        </div>
    </div>
</div>

<div id="inv-return" class="panel hidden" style="border-top: 4px solid var(--metro-blue);">
    <h3 style="color:var(--metro-blue);"><i class="fas fa-undo"></i> Asset Return Protocol</h3>
    <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
        Scan asset barcode to verify return and update inventory location.
    </p>
    
    <div style="text-align:center; padding:20px; background: #f0f9ff; border-radius: 8px;">
        <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px; background: var(--metro-blue); border-color: var(--metro-blue);">
            <i class="fas fa-qrcode"></i> INITIATE RETURN SCAN
        </button>
    </div>

    <div id="return_display" class="hidden" style="background:#f1f5f9; padding:25px; border:1px solid #cbd5e1; text-align:center; margin-top:20px; border-radius:6px;">
        
        <h2 id="return_item_name" style="color:var(--metro-blue); margin:0 0 10px 0;">--</h2>
        <div style="font-family:'Courier New', monospace; font-size:14px; color:#475569; margin-bottom:20px;">
            ID: <span id="return_item_code" style="font-weight:bold;">--</span>
        </div>

        <div style="text-align:left; background:white; padding:15px; border-radius:6px; border: 1px solid #e2e8f0;">
            
            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase;">Return Facility</label>
            <select id="returnLocSelect" onchange="toggleOtherInput()" style="margin-bottom:10px;">
                <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
                <option value="Other">Other (Specify...)</option>
            </select>

            <div id="divOtherLoc" class="hidden">
                <input id="returnLocOther" placeholder="Specify Facility Name">
            </div>

            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase; margin-top: 10px; display: block;">Storage Unit / Rack</label>
            <input id="returnLocSpot" placeholder="e.g. Cabinet A, Shelf 2">
        </div>

        <div id="btn_return_verify" style="margin-top:20px;">
             <button onclick="submitTransactionNoFace('RETURN')" class="info" style="width:100%; background: var(--metro-blue);">
                CONFIRM RETURN
             </button>
        </div>
    </div>
</div>

<div id="inv-history" class="panel hidden">
    <div style="text-align:center; padding:40px 20px;">
        <h2 style="color:var(--metro-blue); margin-bottom:10px;">Asset Audit Trail</h2>
        <p style="color:#64748b; margin-bottom:20px;">Scan barcode to retrieve complete lifecycle history.</p>
        
        <div style="max-width:400px; margin:0 auto; display:flex; gap:10px;">
            <input 
                id="auditSearchInput" 
                placeholder="Scan or Enter Asset Tag..." 
                style="padding:12px; font-size:16px; border:2px solid var(--metro-blue); flex-grow:1;"
                onchange="fetchAuditHistory(this.value)"
            >
            <button 
                onclick="openBarcodeScanner('AUDIT_SEARCH')" 
                class="warning" 
                style="padding:12px 20px; font-size:18px;"
            >
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>
</div>

<div id="auditResultModal" class="modal-overlay hidden">
    <div class="panel" style="width:450px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; background:#f8fafc; border: none;">
        
        <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-size:16px; border:none; color:white; padding:0;">Asset Lifecycle</h3>
                <small id="auditModalBarcode" style="opacity:0.8; font-family:'Courier New', monospace;">--</small>
            </div>
            <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div id="auditTimelineContainer" style="overflow-y:auto; padding:20px; flex-grow:1;">
            <div style="text-align:center; color:#64748b;">Retrieving records...</div>
        </div>

    </div>
</div>

<div id="inv-list" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
        <div>
            <h3 style="margin:0; border:none; padding:0;">Current Inventory</h3>
            <small id="stockSummaryText" style="color:var(--metro-blue); font-weight:bold;">Syncing Database...</small>
        </div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="mainStockSearch" onkeyup="filterStockTable()" placeholder="Search Assets..." style="width:250px; margin:0;">
            <button onclick="openBarcodeScanner('SEARCH_STOCK')" class="secondary" title="Scan to Search">
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>

    <div class="table-wrapper" style="max-height:600px; overflow-y:auto;">
        <table>
            <thead style="position:sticky; top:0;">
                <tr>
                    <th>Tag ID</th>
                    <th>Asset Name</th>
                    <th>Registrar</th>
                    <th>Cycle Count</th>
                    <th>Custodian</th>
                    <th>Location</th> 
                    <th>Status</th>
                    <th>Controls</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
</div>

</div> 
<div id="tab-gallery" class="hidden">
  
  <div class="panel">
    <h3><i class="fas fa-folder-open"></i> Compliance Documentation</h3>
    
    <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:20px;">
        <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px; text-transform: uppercase;">1. Select Target Site</label>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <select id="galleryLineSelect" onchange="handleGalleryLineChange()" style="flex:1; border:2px solid var(--metro-blue);">
              <option value="">-- Select Line --</option>
              <option value="Blue Line">Blue Line</option>
              <option value="Green Line">Green Line</option>
              <option value="Purple Line">Purple Line</option>
              <option value="Yellow Line">Yellow Line</option>
              <option value="Orange Line">Orange Line</option>
              <option value="Pink Line">Pink Line</option>
            </select>

            <select id="galleryStationSelect" onchange="handleGalleryStationChange()" disabled style="flex:1; background:#f1f5f9;">
              <option value="">-- Select Line First --</option>
            </select>
        </div>
    </div>

    <div id="galleryUploadSection" class="hidden">
        <h4 style="margin:0 0 10px 0; color:var(--metro-blue);">2. Capture or Upload Evidence</h4>
        <p id="uploadTargetText" style="font-weight:bold; color:var(--success-green); margin-bottom:15px;">Target: None</p>

        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            
            <div class="panel" style="flex:1; min-width:300px; padding:20px; text-align:center; border:2px dashed var(--metro-blue);">
                <h5 style="margin-top:0;"><i class="fas fa-camera"></i> Live Capture</h5>
                
                <div id="evidenceVideoContainer" style="background:black; width:100%; height:200px; margin-bottom:10px; border-radius:4px; display:none; overflow:hidden;">
                    <video id="evidenceVideo" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
                </div>
                
                <img id="evidencePreview" style="max-width:100%; max-height:200px; display:none; margin:0 auto 10px auto; border:2px solid #22c55e;">

                <div id="evidenceCamControls">
                    <button onclick="startEvidenceCamera()" class="info" style="width:100%;"><i class="fas fa-video"></i> Start Camera</button>
                </div>
                
                <div id="evidenceCaptureControls" class="hidden" style="display:flex; gap:5px;">
                    <button onclick="captureEvidencePhoto()" class="warning" style="flex:1;"><i class="fas fa-camera"></i> Click</button>
                    <button onclick="stopEvidenceCamera()" class="danger" style="width:40px;"><i class="fas fa-times"></i></button>
                </div>

                <div id="evidenceSaveControls" class="hidden" style="display:flex; gap:5px;">
                    <button onclick="uploadCapturedEvidence()" class="success" style="flex:1;">‚¨Ü Upload Photo</button>
                    <button onclick="retryEvidencePhoto()" class="secondary" style="width:40px;"><i class="fas fa-redo"></i></button>
                </div>
            </div>

            <div class="panel" style="flex:1; min-width:300px; padding:20px; text-align:center; border:2px dashed #cbd5e1;">
                <h5 style="margin-top:0;"><i class="fas fa-upload"></i> File Upload</h5>
                <p style="font-size:11px; color:#666;">Max Size: 3MB | Formats: JPG, PNG, PDF</p>
                <p style="font-size:11px; color:#666;">Limits: PDF (3MB) | Images (10MB)</p>                
                <input type="file" id="evidenceFile" accept="image/*,application/pdf" style="margin-bottom:15px;">
                <button onclick="uploadFileEvidence()" class="info" style="width:100%;">‚¨Ü Upload File</button>
            </div>
        </div>

        <hr style="margin:25px 0; border:0; border-top:1px solid #e2e8f0;">
        
        <h4 style="color:var(--metro-blue);"><i class="fas fa-images"></i> Digital Repository</h4>
        <div id="galleryContainer" class="gallery-grid">
            <p style="color:#666; font-style:italic;">Select a station to view documents.</p>
        </div>
    </div>
  </div>
</div>
<div id="tab-assigned" class="hidden">
    <div class="panel"><h3><i class="fas fa-clipboard-check"></i> Assigned Operations</h3><div id="taskList"></div></div>
</div>

<div id="tab-adminPanel" class="hidden">
    <div class="panel" style="border-top: 5px solid var(--metro-red);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="color:var(--metro-red);"><i class="fas fa-shield-alt"></i> System Oversight Console</h3>
        <button onclick="loadAdminPanel()" class="secondary"><i class="fas fa-sync"></i> Refresh Data</button>
      </div>

      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 20px;">1. Personnel Status & Security</h4>
      <div class="table-wrapper">
      <table>
          <thead>
              <tr>
                  <th>User Profile</th>
                  <th>Connection</th>
                  <th>Task Load</th>
                  <th>Biometrics</th>
                  <th>Admin Actions</th>
              </tr>
          </thead>
          <tbody id="userListBody"></tbody>
      </table>
      </div>
      
      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 30px;">2. Task Assignment</h4>
      <label style="font-size: 12px; font-weight: bold;">Select Personnel:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="2" placeholder="Enter detailed operational instructions..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:10px;">Dispatch Orders</button>
      </div>
    </div>
</div>

<div id="adminTaskModal" class="modal-overlay hidden">
    <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
        <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:white; border:none; padding:0;">Task Log: <span id="modalTaskUserName">User</span></h3>
            <button class="danger" onclick="closeTaskModal()" style="padding:4px 10px; font-size:12px;">CLOSE</button>
        </div>
        
        <div style="overflow-y:auto; flex-grow:1; background:#f8fafc; padding: 20px;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Control</th>
                        </tr>
                    </thead>
                    <tbody id="adminTaskBody">
                        <tr><td colspan="4" style="text-align:center;">Retrieving...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="bannedScreen" class="banned-overlay hidden">
    <div class="banned-card">
        <h1 style="color:#991b1b; margin:0; font-size: 32px; letter-spacing: 2px;">ACCESS DENIED</h1>
        <p style="color:#333; margin-top: 10px;">Security protocols have suspended this account.</p>
        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 20px 0;">
        <div id="displayBanReason" style="font-weight:bold; font-size: 18px; color: #1f2937;">--</div>
        <div id="bannedTimeDisplay" class="banned-timer">--</div>
        <div style="margin-top:30px;">
            <button onclick="logout()" style="background:#991b1b; color:white; padding:15px 30px; font-size: 16px; border:none; border-radius: 6px;">FORCE LOGOUT</button>
        </div>
    </div>
</div>

<div id="adminBanModal" class="modal-overlay hidden">
    <div class="panel" style="width:500px; max-width:95%; border-top: 6px solid var(--metro-red);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="color:var(--metro-red); margin:0; border:none; padding:0;">‚õî Suspend User Access</h3>
            <button onclick="closeBanModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
        </div>
        
        <p style="background:#fee2e2; padding:15px; border-radius:6px; color:#991b1b; margin-bottom:20px; font-weight: bold; border: 1px solid #fecaca;">
            Target: <span id="banTargetName">User</span>
        </p>

        <label style="font-weight:bold; display:block; font-size: 12px; margin-bottom: 5px;">1. Violation Category</label>
        <select id="banReasonInput" class="ban-input" onchange="toggleBanOtherInput()">
            <option value="Misconduct">Code of Conduct Violation</option>
            <option value="Security Violation">Security Protocol Breach</option>
            <option value="Asset Damage">Asset Mishandling / Damage</option>
            <option value="Attendance">Attendance Irregularity</option>
            <option value="Pending Investigation">Pending Internal Investigation</option>
            <option value="Other">Other (Specify)</option>
        </select>

        <div id="divBanOther" class="hidden">
            <input id="banReasonOther" class="ban-input" placeholder="Specify Details..." style="border-left: 4px solid var(--metro-red);">
        </div>

        <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">2. Remedial Action Required</label>
        <input id="banActionInput" class="ban-input" placeholder="e.g. Report to HR, Submit Incident Report...">

        <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">3. Suspension Duration</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <button class="ban-btn-select" onclick="selectBanDuration(1, this)">24 Hours</button>
            <button class="ban-btn-select" onclick="selectBanDuration(3, this)">3 Days</button>
            <button class="ban-btn-select" onclick="selectBanDuration(7, this)">1 Week</button>
            <input type="date" id="banCustomDate" class="ban-input" style="margin:0; height:100%; text-align:center;" onchange="selectBanCustomDate(this)">
        </div>
        
        <label style="font-weight:bold; display:block; margin-top: 15px; font-size: 12px; margin-bottom: 5px;">4. Administrative Remarks</label>
        <textarea id="banRemarks" rows="2" class="ban-input" placeholder="Internal notes..."></textarea>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button onclick="closeBanModal()" class="secondary">Cancel</button>
            <button onclick="submitBan()" class="danger" style="font-weight:bold; padding: 10px 20px;">CONFIRM SUSPENSION</button>
        </div>
    </div>
</div>
<div id="tab-dataView" class="hidden">
  
  <div class="panel">
    <h3><i class="fas fa-database"></i> Master Log Database</h3>
    
    <div style="background: #e2e8f0; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Filter by Location:</label>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <select id="logLineSelect" onchange="handleLogLineChange()" style="flex: 1; border:1px solid #cbd5e1;">
              <option value="">-- Select Line --</option>
              <option value="Blue Line">Blue Line</option>
              <option value="Green Line">Green Line</option>
              <option value="Purple Line">Purple Line</option>
              <option value="Yellow Line">Yellow Line</option>
              <option value="Orange Line">Orange Line</option>
              <option value="Pink Line">Pink Line</option>
            </select>

            <select id="logStationSelect" onchange="loadSpecificStationData()" disabled style="flex: 1; background:#f1f5f9;">
              <option value="">-- Select Line First --</option>
            </select>
        </div>
    </div>
  </div>

  <div id="logResultsPanel">
    
    <div class="panel" style="border-left: 4px solid var(--metro-blue);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <h4 id="logTableTitle" style="margin:0; color:var(--metro-blue);">üìä Recent Station Records</h4>
          <button onclick="loadSpecificStationData()" class="secondary" style="font-size:11px; padding: 6px 12px;"><i class="fas fa-sync"></i> Refresh Table</button>
      </div>
      <div class="table-wrapper" style="margin-top:15px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Inspector</th>
              <th>Length</th>
              <th>Dist</th>
              <th>Thick</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Control</th>
            </tr>
          </thead>
          <tbody id="viewTable1Body">
            <tr><td colspan="8" style="text-align:center;">‚è≥ Syncing Database...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    </div>
</div>
<div id="rakeDataModal" class="modal-overlay hidden">
    <div class="panel" style="width:700px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--metro-blue); color:white; padding:15px 20px;">
            <h3 style="margin:0; color:white; border:none; padding:0;">Rake Clearance Table</h3>
            <button class="danger" onclick="closeRakeModal()" style="font-size:12px; padding: 5px 10px;">CLOSE</button>
        </div>
        
        <div class="table-wrapper" style="overflow-y:auto; flex-grow:1; padding: 20px; background: #f8fafc;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>RAKE NO</th>
                        <th>TYPE</th>
                        <th>FRONT</th>
                        <th>REAR</th>
                        <th>ACT</th>
                    </tr>
                </thead>
                <tbody id="modalRakeBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-printReport" class="hidden">
    <div class="panel">
        <h3><i class="fas fa-print"></i> Report Generation Center</h3>
        
        <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
            <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Select Inspection Site:</label>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
                <select id="printLineSelect" onchange="handlePrintLineChange()" style="flex:1;">
                    <option value="">-- Select Line --</option>
                    <option value="Blue Line">Blue Line</option>
                    <option value="Green Line">Green Line</option>
                    <option value="Purple Line">Purple Line</option>
                    <option value="Yellow Line">Yellow Line</option>
                    <option value="Orange Line">Orange Line</option>
                    <option value="Pink Line">Pink Line</option>
                </select>
                <select id="printStationSelect" onchange="fetchLogsForPrint()" disabled style="flex:1;">
                    <option value="">-- Select Line First --</option>
                </select>
            </div>
        </div>

        <div id="printLogList" class="hidden" style="margin-top:25px;">
            <h4>Available Inspection Records:</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Station</th>
                            <th>Inspector</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="printLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="printOptionsModal" class="modal-overlay hidden">
    <div class="panel" style="width:450px; max-width:95%;">
        <h3 style="color:var(--metro-blue); border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-top:0;">Configure Audit Report</h3>
        
        <p style="margin-bottom:20px; background: #f1f5f9; padding: 10px; border-radius: 4px;"><strong>Record Date:</strong> <span id="modalPrintDate" style="color:var(--metro-blue); font-weight:bold;">--</span></p>

        <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">1. Data Sections to Include:</label>
        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
                <input type="checkbox" id="chkStationDetails" checked> 
                Measurement Data
            </label>
            <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
                <input type="checkbox" id="chkRakeData" checked> 
                Clearance Data
            </label>
        </div>

        <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">2. Authorization Signatories:</label>
        
        <div style="margin-bottom:15px;">
            <small style="color: #64748b;">Conducting Officer:</small>
            <select id="selPrintInspector" style="margin-top: 5px;">
                <option value="">Loading...</option>
            </select>
        </div>

        <div style="margin-bottom:25px;">
            <small style="color: #64748b;">Approving Authority:</small>
            <select id="selPrintAuthority" style="margin-top: 5px; border-color: var(--metro-gold); background: #fffbeb;">
                <option value="">-- Select Authority --</option>
                <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
                <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; border-top:1px solid #e2e8f0; padding-top:20px;">
            <button class="secondary" onclick="closePrintModal()" style="flex:1;">Cancel</button>
            <button class="info" onclick="generateFinalReport()" style="flex:2;">GENERATE REPORT</button>
        </div>
    </div>
</div>

<div id="printableReportContainer" class="hidden">
    <div class="no-print" style="text-align:center; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding:15px; background:#f8fafc;">
        <h3 style="margin:0 0 15px 0; color: var(--metro-blue);">Report Preview</h3>
        
        <button class="danger" onclick="closeReportPreview()" style="margin-right:20px;">CLOSE PREVIEW</button>

        <button onclick="printReport('A4')" style="background:var(--metro-blue); color:white; margin-right:10px;">
            <i class="fas fa-file-pdf"></i> PRINT STANDARD (A4)
        </button>

        <button onclick="printReport('POS')" style="background:#1e293b; color:white;">
            <i class="fas fa-receipt"></i> PRINT RECEIPT
        </button>
    </div>

    <div class="report-paper">
    <div class="report-header">
        <h2 style="margin:0; text-transform:uppercase; color:var(--metro-blue);">METRO RAILWAY PLATFORM SAFETY PROJECT</h2>
        <small style="letter-spacing: 2px; font-weight:bold; text-transform: uppercase;">Official Inspection Record</small>
    </div>

        <div class="report-meta">
            <div>
                <strong>Site:</strong> <span id="rptStationName">--</span><br>
                <strong>Corridor:</strong> <span id="rptLineName">--</span>
            </div>
            <div style="text-align:right;">
                <strong>Date:</strong> <span id="rptDate">--</span><br>
                <strong>Inspector:</strong> <span id="rptUser">--</span>
            </div>
        </div>

        <div id="sectionStationDetails">
            <div class="report-section-title">A. YELLOW LINE COMPLIANCE</div>
            <table class="report-table">
                <tr>
                    <td style="background:#f8fafc; width:40%; font-weight: bold;">Platform Length</td>
                    <td id="rptLen">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">YL Distance</td>
                    <td id="rptYl">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">YL Thickness</td>
                    <td id="rptTh">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">Compliance Status</td>
                    <td id="rptStatus">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">Remarks</td>
                    <td id="rptRem">--</td>
                </tr>
            </table>
        </div>

        <div id="sectionRakeData" style="margin-top:20px;">
            <div class="report-section-title">B. RAKE CLEARANCE DATA</div>
            <table class="report-table">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="width:30px;">#</th>
                        <th>Rake ID</th>
                        <th>Type</th>
                        <th>Front</th>
                        <th>Rear</th>
                    </tr>
                </thead>
                <tbody id="rptRakeBody"></tbody>
            </table>
        </div>

        <div class="report-footer" style="margin-top:60px; display:flex; justify-content:space-between; page-break-inside: avoid;">
            <div style="text-align:center; min-width:180px;">
                <p style="margin-bottom:5px;">_______________________</p>
                <div id="rptSigInspectorName" style="font-weight:bold; font-size:12px;">--</div>
                <small style="text-transform: uppercase; color: #64748b;">Conducting Officer</small>
            </div>

            <div style="text-align:center; min-width:180px;">
                <p style="margin-bottom:5px;">_______________________</p>
                <div id="rptSigAuthName" style="font-weight:bold; font-size:12px;">--</div>
                <small style="text-transform: uppercase; color: #64748b;">Approving Authority</small>
            </div>
        </div>
    </div>
</div>

</section>
<script type="module">
// --- FIREBASE IMPORTS (Standard Stable Version) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

// --- INITIALIZE ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
let isSwitching = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];
let modelsLoaded = false;
let isTransactionAuth = false;
let currentTransactionType = "";
// --- GLOBAL LISTENER TRACKERS (PREVENTS CROSSTALK) ---
     // For Field Inspection (Rake Table)
let galleryListener = null;   // For Compliance Docs (Gallery Grid)
let logViewListener = null;   // For Master Log Database (Data View Table)
let printListener = null;     // For Print Report List
let scanMode = 'LOGIN';

let receiverVerified = false;

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null; // Stores details of scanned item for Checkout/Return// --- GLOBAL STATE TRACKERS ---
let scanner = null;
let existingItemKey = null; // To track if we are updating existing stock

// --- SIGNATURE PAD LOGIC (UPDATED FOR MOBILE) ---
function setupCanvas(id) {
    const canvas = document.getElementById(id);
    if (!canvas) return; // Safety check

    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 3;       // Thicker line for better visibility on mobile
    ctx.lineCap = 'round';   // Smooth edges
    ctx.strokeStyle = '#000000';

    let isDrawing = false;

    // 1. FORCE DISABLE SCROLLING ON CANVAS via JS
    canvas.style.touchAction = 'none';

    // Helper to get exact coordinates
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        // Calculate scaling (vital if CSS shrinks the canvas)
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    // --- POINTER EVENTS (Handles Mouse + Touch automatically) ---

    // Start Drawing
    canvas.addEventListener('pointerdown', (e) => {
        isDrawing = true;
        canvas.setPointerCapture(e.pointerId); // LOCKS pointer to canvas so you can't scroll away
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
    });

    // Draw Line
    canvas.addEventListener('pointermove', (e) => {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
    });

    // Stop Drawing
    canvas.addEventListener('pointerup', (e) => {
        isDrawing = false;
        canvas.releasePointerCapture(e.pointerId);
    });

    // Cancel (e.g. finger slides off screen edge)
    canvas.addEventListener('pointercancel', () => {
        isDrawing = false;
    });
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
// A. HARD RESET FOR INPUT FORM
function resetInputForm() {
    // 1. Cut the Connection
    if (rowListener) { off(ref(db), rowListener); rowListener = null; }

    // 2. Wipe Variables
    rtStationKey = null;
    rtRakeKey = null;

    // 3. Wipe UI Inputs
    const inputs = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) { el.value = ""; el.oninput = null; el.onchange = null; } // Detach events
    });

    // 4. Wipe Table
    document.getElementById("distanceBody").innerHTML = "";
    
    // 5. Reset Buttons
    document.getElementById("btnFinalSubmit").innerText = "Loading...";
    document.getElementById("btnFinalSubmit").disabled = true;
}

  // UPDATED: Handle Gallery Station Change
window.handleGalleryStationChange = () => {
    const line = document.getElementById("galleryLineSelect").value;
    const stn = document.getElementById("galleryStationSelect").value;
    const galleryDiv = document.getElementById("galleryContainer");
    const uploadSection = document.getElementById("galleryUploadSection");
    const targetText = document.getElementById("uploadTargetText");

    // 1. STOP OLD LISTENER (Fixes Bleeding)
    if (galleryListener) {
        off(ref(db, "history"), galleryListener); // Note: Detaching from specific query needs care, simplifying by clearing UI first
        galleryListener = null;
    }

    // 2. WIPE UI
    galleryDiv.innerHTML = ""; 
    
    if (!line || !stn) {
        uploadSection.classList.add("hidden");
        return;
    }

    // 3. START NEW SESSION
    uploadSection.classList.remove("hidden");
    const targetName = `${stn} (${line})`;
    targetText.innerText = `Target: ${targetName}`;

    galleryDiv.innerHTML = `<p style="text-align:center; width:100%;">Loading evidence...</p>`;

    // 4. FETCH ONLY FOR THIS STATION
    const q = query(ref(db, "history"), orderByChild("stationName"), equalTo(targetName));
    
    // We use onValue to allow real-time updates of images
    galleryListener = onValue(q, (snap) => {
        galleryDiv.innerHTML = "";
        
        if (!snap.exists()) {
            galleryDiv.innerHTML = `<p style="text-align:center; color:#888; width:100%;">No evidence uploaded yet.</p>`;
            return;
        }

        snap.forEach(c => {
            const v = c.val();
            // (Your existing gallery render logic here)
            let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
            if(v.fileType && v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
            else if(v.fileType && v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
            
            let controls = `<br><small style="color:grey;">(View Only)</small>`;
            if(isAdmin) {
                controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:var(--metro-blue); color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove</button></div>`;
            }
            galleryDiv.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name || 'Evidence'}</b><br>by ${v.userName}</div>${controls}</div>`;
        });
    });
};
// --- NEW HELPER: Signature Modal ---
window.viewSignature = (sigData) => {
    document.getElementById("modalSigImage").src = sigData;
    document.getElementById("sigModal").classList.remove("hidden");
};
window.closeSigModal = () => document.getElementById("sigModal").classList.add("hidden");

// --- NEW BARCODE LOGIC ---
window.openBarcodeScanner = (mode) => {
    scanMode = mode;
    document.getElementById("barcodeModal").classList.remove("hidden");
    
    // START SCANNER
    if(!scanner) {
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess, onScanFailure);
    }
}
// ==========================================
// 1. ADMIN PANEL (With Unban Logic)
// ==========================================
let adminListener = null;

// B. Save Field Real-Time Helper
window.saveFieldRealTime = (id) => {
    if(!rtStationKey) return;
    
    const map = {
        "inpStationLength": "len",
        "inpYellowDist": "yl",
        "inpYellowThick": "th",
        "inpRemarks": "remarks",
        "inpImplementation": "impl"
    };

    const dbField = map[id];
    const val = document.getElementById(id).value;

    // Update Master Log Directly
    update(ref(db, `station_logs/${rtStationKey}`), {
        [dbField]: val,
        last_modified: serverTimestamp() // Audit trail
    });
};

// C. Load Rows from Rake Logs (Master)
let rowListener = null;
function loadRealTimeRows() {
    if(rowListener) { off(ref(db), rowListener); rowListener = null; } // Cleanup

    const tbody = document.getElementById("distanceBody");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Syncing...</td></tr>";

    const rowsRef = ref(db, `rake_logs/${rtRakeKey}`);
    
    // Real-time listener on the MASTER LOG rake node
    rowListener = onValue(rowsRef, (snap) => {
        tbody.innerHTML = "";
        if(!snap.exists()) return;

        let i = 1;
        snap.forEach(c => {
            const rowKey = c.key;
            const v = c.val();
            renderRealTimeRow(rowKey, v, i++);
        });
    });
}

// D. Render Row (With Direct Master Log Bindings)
function renderRealTimeRow(key, v, index) {
    const tbody = document.getElementById("distanceBody");
    const isSel = (val) => (v.type === val ? "selected" : "");

    // Note the function calls: upRowRealTime and delRowRealTime
    const html = `
        <tr>
            <td style="text-align:center; font-weight:bold;">${index}</td>
            <td>
                <input style="width:100%" value="${v.rake || ''}" 
                 oninput="upRowRealTime('${key}','rake',this.value)" placeholder="Rake ID">
            </td>
            <td>
                <select style="width:100%; padding:5px;" onchange="upRowRealTime('${key}','type',this.value)">
                    <option value="" ${isSel("")}>-- Select --</option>
                    <option value="BHEL RAKE" ${isSel("BHEL RAKE")}>BHEL RAKE</option>
                    <option value="MEDHA RAKE" ${isSel("MEDHA RAKE")}>MEDHA RAKE</option>
                    <option value="DALIAN RAKE" ${isSel("DALIAN RAKE")}>DALIAN RAKE</option>
                </select>
            </td>
            <td><input style="width:100%" value="${v.f || ''}" oninput="upRowRealTime('${key}','f',this.value)" placeholder="Front"></td>
            <td><input style="width:100%" value="${v.r || ''}" oninput="upRowRealTime('${key}','r',this.value)" placeholder="Rear"></td>
            <td style="text-align:center;">
                <button class="danger" onclick="delRowRealTime('${key}')">X</button>
            </td>
        </tr>`;
    tbody.innerHTML += html;
}
// Updated Row Edit Function
window.upRow = (k, f, v) => {
    // üõë SAFETY LOCK: If we are switching, ignore this old event
    if (isSwitching) {
        console.warn("Blocked ghost write during switch.");
        return;
    }
    update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), { [f]: v });
};

// Updated Add Row Function
window.addDistanceRow = () => {
    if (isSwitching) return; // üõë Block add during switch
    push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });
};

// Updated Delete Row Function
window.delRow = (k) => {
    if (isSwitching) return; // üõë Block delete during switch
    remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
};
window.upRowRealTime = (rowKey, field, val) => {
    update(ref(db, `rake_logs/${rtRakeKey}/${rowKey}`), { [field]: val });
};

window.delRowRealTime = (rowKey) => {
    if(confirm("Delete this row permanently?")) {
        remove(ref(db, `rake_logs/${rtRakeKey}/${rowKey}`));
    }
};
window.closeBarcodeScanner = () => {
    document.getElementById("barcodeModal").classList.add("hidden");
    if(scanner) {
        scanner.clear();
        scanner = null;
    }
}
// --- NEW AUDIT LOGIC ---
window.closeAuditModal = () => document.getElementById("auditResultModal").classList.add("hidden");
window.fetchAuditHistory = async (barcode) => {
    if (!barcode) return;

    // Open popup
    const modal = document.getElementById("auditResultModal");
    const container = document.getElementById("auditTimelineContainer");
    document.getElementById("auditModalBarcode").innerText = "Barcode: " + barcode;
    modal.classList.remove("hidden");

    container.innerHTML = `<div style="text-align:center; padding:20px;">Loading...</div>`;

    try {
        const q = query(
            ref(db, "logs"),
            orderByChild("barcode"),
            equalTo(barcode)
        );

        const snap = await get(q);

        if (!snap.exists()) {
            container.innerHTML = `<div style="text-align:center;color:#777;">No history found</div>`;
            return;
        }

        // 1. collect only checkout & return
        let raw = [];
        snap.forEach(c => {
            const v = c.val();
            if (v.type === "CHECKOUT" || v.type === "RETURN") {
                raw.push(v);
            }
        });

        // 2. sort old ‚Üí new
        raw.sort((a, b) => a.time - b.time);

        // 3. pair checkout + return
        let records = [];
        let open = null;

        raw.forEach(l => {
            if (l.type === "CHECKOUT") {
                open = {
                    user: l.takenBy,
                    checkout: l.time,
                    return: null
                };
                records.push(open);
            }

            if (l.type === "RETURN" && open) {
                open.return = l.time;
                open = null;
            }
        });

        // 4. last 4 only (latest first)
        records = records.slice(-20).reverse();

        // 5. render popup cards
        container.innerHTML = "";

        records.forEach(r => {
            const co = new Date(r.checkout).toLocaleString("en-IN", {
                timeZone: "Asia/Kolkata",
                day: "2-digit",
                month: "short",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                hour12: true
            });

            const ro = r.return
                ? new Date(r.return).toLocaleString("en-IN", {
                    timeZone: "Asia/Kolkata",
                    day: "2-digit",
                    month: "short",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true
                })
                : "Still Holding";

            container.innerHTML += `
                <div class="history-card ${r.return ? 'return' : 'checkout'}">
                    <div class="hc-header">
                        <span class="hc-user">üë§ ${r.user}</span>
                        <span style="font-size:11px;color:#666;">
                            ${r.return ? 'RETURNED' : 'OUT'}
                        </span>
                    </div>
                    <div class="hc-meta">
                        üì§ Checkout: <b>${co}</b><br>
                        üì• Return: <b>${ro}</b>
                    </div>
                </div>
            `;
        });

    } catch (e) {
        console.error(e);
        container.innerHTML = `<div style="color:red;text-align:center;">Error loading data</div>`;
    }
};

// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};

// --- 4. DUMMY FUNCTION (To prevent errors if HTML still calls it) ---
// --- REAL-TIME HISTORY LOGIC ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Syncing Live Data...</td></tr>";

    // This listener stays open and updates automatically when DB changes
    const dbRef = getDatabase();
    const q = query(ref(dbRef, "logs"), limitToLast(100));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); // Show newest events at the top

        // Filter: Show only inventory-related events (Checkout, Return, Add)
        const invLogs = logs.filter(l => 
            l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE'
        );

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded recently.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        
        invLogs.forEach(l => {
            // Badge Styling
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            // Barcode formatting
            const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px; letter-spacing:1px;">${l.barcode}</div>` : '';

            // Row HTML
            const row = `
            <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
                <td style="vertical-align:middle;">${barcodeDisplay}</td>
                <td style="font-weight:bold; vertical-align:middle;">${l.takenBy || 'Unknown'}</td>
                <td style="vertical-align:middle;">
                    ${formatTime(l.time)}
                </td>
                <td style="text-align:center; vertical-align:middle;">${badge}</td>
                <td style="vertical-align:middle;">
                    <span style="font-size:13px; font-weight:bold; color:#333;">${l.item}</span><br>
                    <small style="color:#777;">Auth: ${l.approvedBy || 'System'}</small>
                </td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    });
};
// --- FULL FUNCTION: Print Report Handler ---
window.printReport = (mode) => {
    // 1. Clean previous classes to ensure no conflicts
    document.body.classList.remove('print-a4', 'print-pos');

    // 2. Add the selected class based on button click
    if (mode === 'A4') {
        document.body.classList.add('print-a4');
    } else {
        document.body.classList.add('print-pos');
    }

    // 3. Trigger the browser's print dialog
    window.print();
};

// --- FULL FUNCTION: Close Preview Handler ---
window.closeReportPreview = () => {
    // 1. Hide the container div
    document.getElementById("printableReportContainer").classList.add("hidden");
    
    // 2. Remove the print classes so the main app returns to normal styling
    document.body.classList.remove('print-a4', 'print-pos');
};
window.onScanSuccess = async function(decodedText) {
    closeBarcodeScanner();
    console.log("SCANNED:", decodedText, "MODE:", scanMode);

    // ---------------- ADD STOCK ----------------
    if (scanMode === 'ADD') {
        document.getElementById("invBarcode").value = decodedText;
        checkBarcodeUnique(decodedText);
        return;
    }

    // ---------------- CHECKOUT / RETURN ----------------
    if (scanMode === 'CHECKOUT' || scanMode === 'RETURN') {

        const isCheckout = scanMode === 'CHECKOUT';

        const displayId = isCheckout ? "checkout_display" : "return_display";
        const nameId    = isCheckout ? "checkout_item_name" : "return_item_name";
        const codeId    = isCheckout ? "checkout_item_code" : "return_item_code";
        const authBtnId = isCheckout ? "btn_checkout_verify" : "btn_return_verify";

        document.getElementById(displayId).classList.remove("hidden");
        document.getElementById(nameId).innerHTML = "üîç Checking inventory...";
        document.getElementById(codeId).innerText = decodedText;

        try {
            const q = query(
                ref(db, "inventory"),
                orderByChild("barcode"),
                equalTo(decodedText)
            );

            const snap = await get(q);

            if (!snap.exists()) {
                document.getElementById(nameId).innerHTML =
                    `<span style="color:red;">‚ùå Item not found</span>`;
                alert("This barcode does not exist in inventory.");
                return;
            }

            let item = null;
            let itemKey = null;
            snap.forEach(c => {
                item = c.val();
                itemKey = c.key;
            });

            const currentUserName =
                currentUser.name || currentUser.email;

            // ---------- CHECKOUT RULE ----------
            if (isCheckout && item.status !== "In Stock") {
                document.getElementById(nameId).innerHTML = `
                    <span style="color:red;font-weight:bold;">‚õî ALREADY CHECKED OUT</span><br>
                    ${item.item}<br>
                    <small>Held by: <b>${item.holder}</b></small>
                `;
                document.getElementById(authBtnId).style.display = "none";
                return;
            }

            // ---------- RETURN RULE ----------
            if (!isCheckout) {

                if (item.status === "In Stock") {
                    document.getElementById(nameId).innerHTML = `
                        <span style="color:red;font-weight:bold;">‚õî ALREADY RETURNED</span><br>
                        ${item.item}
                    `;
                    document.getElementById(authBtnId).style.display = "none";
                    return;
                }

                // üö® CORE SECURITY RULE
                if (item.holder !== currentUserName) {
                    document.getElementById(nameId).innerHTML = `
                        <span style="color:red;font-weight:bold;">‚õî RETURN DENIED</span><br>
                        ${item.item}<br>
                        <small>
                            Checked out by: <b>${item.holder}</b>
                        </small>
                    `;
                    document.getElementById(authBtnId).style.display = "none";

                    alert(
                        "Return blocked.\n\n" +
                        "Item was checked out by:\n" +
                        item.holder + "\n\n" +
                        "Only the same user can return it."
                    );
                    return;
                }
            }

            // ---------- SUCCESS ----------
            document.getElementById(nameId).innerHTML = `
                <span style="color:${isCheckout ? '#b38600' : '#17a2b8'}; font-weight:bold;">
                    ‚úî Ready to ${isCheckout ? 'Checkout' : 'Return'}
                </span><br>
                <span style="font-size:1.2em">${item.item}</span>
            `;

            pendingTransactionItem = {
                key: itemKey,
                ...item
            };

            document.getElementById(authBtnId).style.display = "block";

        } catch (err) {
            console.error(err);
            alert("Database error.");
        }
    }

    // ---------------- AUDIT SEARCH ----------------
    if (scanMode === 'AUDIT_SEARCH') {

    if (!isAdmin) {
        alert("Audit scanning is restricted to administrators.");
        return;
    }

    document.getElementById("auditSearchInput").value = decodedText;
    fetchAuditHistory(decodedText);
}


    // ---------------- STOCK SEARCH ----------------
    if (scanMode === 'SEARCH_STOCK') {
        document.getElementById("mainStockSearch").value = decodedText;
        filterStockTable();
    }
};

// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};

// --- 4. EMPTY/DUMMY LOAD HISTORY (Prevents errors when clicking tab) ---
window.loadInventoryHistory = () => {
    // Intentionally empty or just focuses the search box
    // Because we removed the table
    setTimeout(() => document.getElementById("auditSearchInput").focus(), 300);
};

// --- 2. UNIFIED SCANNER HANDLER (This replaces your old one) ---


// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};


window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; // Clear input
};
// --- UNIFIED SCANNER HANDLER ---

function onScanFailure(error) {
    // Do nothing, keep scanning
}

// --- INNOVATIVE BARCODE LOGIC: CHECK EXISTENCE ---
// --- NEW LOGIC: PREVENT DUPLICATE BARCODES ---
window.checkBarcodeUnique = async (code) => {
    if(!code) return;
    
    // Reset UI
    document.getElementById("barcodeError").classList.add("hidden");
    document.getElementById("btnAddStock").disabled = false;
    document.getElementById("btnAddStock").innerText = "Save Item to Stock";

    // Query DB to see if barcode exists
    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(code));
    const snap = await get(q);

    if(snap.exists()) {
        // ERROR: DUPLICATE FOUND
        document.getElementById("barcodeError").classList.remove("hidden");
        document.getElementById("btnAddStock").disabled = true;
        document.getElementById("btnAddStock").innerText = "‚õî Duplicate Barcode";
        
        // Optional: Show who has it
        let existingItem = null;
        snap.forEach(c => existingItem = c.val());
        alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
    }
}
// --- HELPER: TOGGLE 'OTHER' INPUT ---
window.toggleOtherInput = () => {
    const val = document.getElementById("returnLocSelect").value;
    const otherDiv = document.getElementById("divOtherLoc");
    
    if(val === "Other") {
        otherDiv.classList.remove("hidden");
        document.getElementById("returnLocOther").focus();
    } else {
        otherDiv.classList.add("hidden");
    }
};
// --- NEW: TRIGGER RECEIVER SCAN ---
window.startReceiverScan = (type) => {
    scanMode = 'RECEIVER';
    currentTransactionType = type; // 'CHECKOUT' or 'RETURN'
    
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "üë§ Receiver Verification";
    document.getElementById("modalDesc").innerText = "Please look at the camera to verify identity.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Verify My Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
    
    // UI Cleanup
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
    
    initCamera(true);
};
// --- 1. LOAD AI MODELS ---
async function preloadModels() {
    if(modelsLoaded) return;
    try {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]);
        modelsLoaded = true;
    } catch(e) { console.error("Model Error", e); }
}
preloadModels();
// ==========================================
// 1. UPDATED LOGIN FUNCTION
// ==========================================
window.login = () => {
    const emailField = document.getElementById("email");
    const passField = document.getElementById("password");
    const btn = document.querySelector("#loginSection button");
    
    if(!emailField.value || !passField.value) return alert("Please enter email and password.");

    // Visual Feedback
    btn.innerText = "üîÑ Verifying Credentials...";
    btn.disabled = true;

    signInWithEmailAndPassword(auth, emailField.value, passField.value)
    .then(() => {
        // Success: onAuthStateChanged will handle the rest
        console.log("Credentials accepted.");
    })
    .catch(e => {
        btn.innerText = "SECURE LOGIN";
        btn.disabled = false;
        alert("Login Failed: " + e.message);
    });
};
// --- EVIDENCE CAMERA LOGIC ---
let evidenceStream = null;
let capturedEvidenceBlob = null; // Stores the photo data

// 1. START CAMERA
window.startEvidenceCamera = async () => {
    const video = document.getElementById("evidenceVideo");
    const container = document.getElementById("evidenceVideoContainer");
    
    // UI Updates
    container.style.display = "block";
    document.getElementById("evidencePreview").style.display = "none";
    document.getElementById("evidenceCamControls").classList.add("hidden");
    document.getElementById("evidenceCaptureControls").classList.remove("hidden");
    document.getElementById("evidenceSaveControls").classList.add("hidden");

    try {
        evidenceStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } // Tries to use back camera on mobile
        });
        video.srcObject = evidenceStream;
    } catch(err) {
        alert("Camera Error: " + err.message);
        stopEvidenceCamera();
    }
};

// 2. CAPTURE PHOTO
window.captureEvidencePhoto = () => {
    const video = document.getElementById("evidenceVideo");
    const canvas = document.createElement("canvas");
    
    // Set canvas size to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw image
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    // Convert to data (Quality 0.8 to compress slightly)
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show Preview
    const img = document.getElementById("evidencePreview");
    img.src = dataUrl;
    img.style.display = "block";
    
    // Hide Video
    document.getElementById("evidenceVideoContainer").style.display = "none";
    
    // Store for upload
    capturedEvidenceBlob = dataUrl;

    // UI Updates
    document.getElementById("evidenceCaptureControls").classList.add("hidden");
    document.getElementById("evidenceSaveControls").classList.remove("hidden");
    
    // Stop stream to save battery
    if(evidenceStream) {
        evidenceStream.getTracks().forEach(t => t.stop());
    }
};

// 3. RETRY PHOTO
window.retryEvidencePhoto = () => {
    capturedEvidenceBlob = null;
    startEvidenceCamera();
};

// 4. STOP CAMERA
window.stopEvidenceCamera = () => {
    if(evidenceStream) {
        evidenceStream.getTracks().forEach(t => t.stop());
        evidenceStream = null;
    }
    document.getElementById("evidenceVideoContainer").style.display = "none";
    document.getElementById("evidencePreview").style.display = "none";
    document.getElementById("evidenceCamControls").classList.remove("hidden");
    document.getElementById("evidenceCaptureControls").classList.add("hidden");
    document.getElementById("evidenceSaveControls").classList.add("hidden");
};
// --- UPLOAD LOGIC (UPDATED LIMITS) ---

// A. UPLOAD CAPTURED PHOTO (10MB Limit)
window.uploadCapturedEvidence = async () => {
    if(!capturedEvidenceBlob) return alert("No photo captured!");
    
    // Check approximate size (Base64 length * 0.75 = bytes)
    const sizeInBytes = (capturedEvidenceBlob.length * 0.75);
    
    // LIMIT: 10MB for Camera Captures
    if(sizeInBytes > 10 * 1024 * 1024) {
        return alert("‚ùå Error: Captured image exceeds 10MB limit.");
    }

    await processUpload(capturedEvidenceBlob, "image/jpeg", "Live Capture.jpg");
    
    // Reset UI
    stopEvidenceCamera();
    alert("‚úÖ Photo Uploaded Successfully!");
};

// B. UPLOAD FROM FILE (Smart Limits: PDF=3MB, IMG=10MB)
window.uploadFileEvidence = async () => {
    const fileInput = document.getElementById("evidenceFile");
    const file = fileInput.files[0];

    if(!file) return alert("Please select a file first.");

    // DEFINE LIMITS
    const LIMIT_PDF = 3 * 1024 * 1024;  // 3 MB
    const LIMIT_IMG = 10 * 1024 * 1024; // 10 MB

    // CHECK BASED ON TYPE
    if(file.type.includes("pdf")) {
        if(file.size > LIMIT_PDF) return alert("‚ùå Error: PDF files cannot exceed 3MB.");
    } 
    else if(file.type.includes("image")) {
        if(file.size > LIMIT_IMG) return alert("‚ùå Error: Image files cannot exceed 10MB.");
    } 
    else {
        // Fallback for other types (default to 3MB safety)
        if(file.size > LIMIT_PDF) return alert("‚ùå Error: File size exceeds 3MB limit.");
    }

    // Convert to Base64
    const reader = new FileReader();
    reader.onload = async function(e) {
        await processUpload(e.target.result, file.type, file.name);
        alert("‚úÖ File Uploaded Successfully!");
        fileInput.value = ""; // Clear input
    };
    reader.readAsDataURL(file);
};
// ==========================================
// 2. CRASH-PROOF AUTH LISTENER (FIXED)
// ==========================================
onAuthStateChanged(auth, (user) => {
    // A. NO USER -> SHOW LOGIN SCREEN
    if (!user) { 
        showLoginScreen(); 
        return; 
    }

    currentUser = user;
    
    // --- FIX START: Turn on the Presence System ---
    // This sends the "Online" signal to the database
    startPresenceSystem(user);  
    // --- FIX END ---

    // B. USER FOUND -> TRY TO LOAD DATA
    const userRef = ref(db, `users/${user.uid}`);
    
    onValue(userRef, (snap) => {
        const u = snap.val();

        // 1. DATA MISSING? FORCE LOGOUT (Fixes blank screen glitch)
        if (!u) {
            console.log("User data missing. Force logout.");
            alert("Account data not found. Please contact admin.");
            signOut(auth);
            return;
        }

        // 2. TERMINATED?
        if (u.terminated) { 
            alert("ACCOUNT TERMINATED."); 
            signOut(auth); 
            return; 
        }

        // 3. BANNED? -> SHOW RED SCREEN
        if (u.banned) {
            // Hide everything else
            document.querySelector("header").style.display = "none";
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("appScreen").classList.add("hidden");
            document.getElementById("faceModal").classList.add("hidden");
            
            // Show Ban Screen
            const banScreen = document.getElementById("bannedScreen");
            if(banScreen) {
                banScreen.classList.remove("hidden");
                // Fill details
                document.getElementById("displayBanReason").innerText = u.banReason || "Admin Action";
                const deadline = u.banExpires || 0;
                if(deadline > 0) {
                      const dateStr = new Date(deadline).toLocaleString();
                      document.getElementById("bannedTimeDisplay").innerText = "Deadline: " + dateStr;
                } else {
                      document.getElementById("bannedTimeDisplay").innerText = "PERMANENT BAN";
                }
            } else {
                // Fallback if HTML is missing
                document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:50px;'>‚õî BANNED (Overlay Missing)</h1><button onclick='logout()'>Log Out</button>";
            }
            return; 
        }

        // 4. ACTIVE & CLEAN -> SHOW DASHBOARD
        // Hide Ban Screen / Login Screen
        document.getElementById("bannedScreen")?.classList.add("hidden");
        document.querySelector("header").style.display = "flex";
        
        // Setup User Session
        currentUser.name = u.name;
        isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());

        if (!u.name) {
            document.getElementById("nameModal").classList.remove("hidden");
            document.getElementById("loginSection").classList.add("hidden");
            return;
        }
        
        // UPDATE UI
        document.getElementById("userInfo").innerText = `${u.name}`;
        document.getElementById("authContainer").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");

        // LOAD ADMIN TOOLS
        if (isAdmin) {
            document.getElementById("adminBadge").classList.remove("hidden");
            document.getElementById("btnAdmin").classList.remove("hidden");
            setTimeout(loadAdminPanel, 2000);
        }

        // BIOMETRIC CHECK
        if(!isTransactionAuth) {
            const faceModal = document.getElementById("faceModal");
            faceModal.classList.remove("hidden");
            
            if(!u.faceData) {
                document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup";
                document.getElementById("regProgress").classList.remove("hidden");
                document.getElementById("btnCapture").onclick = registerNewFace;
                initCamera(false);
            } else {
                document.getElementById("modalTitle").innerText = "Biometric Verification";
                document.getElementById("regProgress").classList.add("hidden");
                document.getElementById("btnCapture").onclick = handleFaceScan;
                initCamera(true);
            }
        }
    }, (error) => {
        // IF DATABASE FAILS -> LOGOUT
        console.error(error);
        alert("Connection Error. Logging out...");
        signOut(auth);
    });
});
// Helper to reliably show login
function showLoginScreen() {
    document.querySelector("header").style.display = "flex";
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("bannedScreen")?.classList.add("hidden");
    document.getElementById("faceModal").classList.add("hidden");
    stopCamera();
    
    // Reset Button State
    const btn = document.querySelector("#loginSection button");
    if(btn) {
        btn.innerText = "SECURE LOGIN";
        btn.disabled = false;
    }
}

// --- HELPER: TOGGLE 'OTHER' INPUT FOR ADD STOCK ---
window.toggleAddOtherInput = () => {
    const val = document.getElementById("addLocSelect").value;
    const otherDiv = document.getElementById("divAddOtherLoc");
    
    if(val === "Other") {
        otherDiv.classList.remove("hidden");
        document.getElementById("addLocOther").focus();
    } else {
        otherDiv.classList.add("hidden");
    }
};
// --- TOGGLE 'OTHER' INPUT ---
window.toggleBanOtherInput = () => {
    const val = document.getElementById("banReasonInput").value;
    const div = document.getElementById("divBanOther");
    if(val === "Other") {
        div.classList.remove("hidden");
        document.getElementById("banReasonOther").focus();
    } else {
        div.classList.add("hidden");
    }
};

// --- HANDLE CUSTOM DATE SELECTION ---
window.selectBanCustomDate = (input) => {
    if(input.value) {
        // Deselect all buttons if date is picked
        currentBanDays = 'CUSTOM';
        document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
        input.style.border = "2px solid #dc3545";
    }
};

// --- UPDATED BUTTON SELECTION ---
window.selectBanDuration = (days, btn) => {
    currentBanDays = days;
    // Clear Date Input
    document.getElementById("banCustomDate").value = "";
    document.getElementById("banCustomDate").style.border = "1px solid #ccc";
    
    // Highlight Button
    document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
};
// --- NEW HEARTBEAT SYSTEM ---
function startPresenceSystem(user) {
    const userStatusRef = ref(db, `status/${user.uid}`);
    set(userStatusRef, { state: 'online', last_changed: serverTimestamp(), email: user.email, name: user.displayName || "User" });
    onDisconnect(userStatusRef).set({ state: 'offline', last_changed: serverTimestamp(), email: user.email });
    setInterval(() => { if(currentUser) update(userStatusRef, { last_seen: serverTimestamp() }); }, 5000);
}

function updateRegDots(count) {
    document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
    document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
    document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

function setupIdleTimer() {
    // Detect mouse, clicks, touches (mobile), and keyboard
    window.onmousemove = resetTimer;
    window.onmousedown = resetTimer; 
    window.onclick = resetTimer;
    window.onkeypress = resetTimer;
    window.ontouchstart = resetTimer; // Mobile touch
    window.addEventListener('scroll', resetTimer, true); // Scrolling
    
    resetTimer(); // Start the first count
}
function resetTimer() {
    clearTimeout(idleTimer);
    if(currentUser) {
        idleTimer = setTimeout(() => {
            const logData = { user: currentUser.email, type: "LOGOUT", method: "Auto-Timeout", time: serverTimestamp() };
            push(ref(db, "logs"), logData);
            signOut(auth);
            alert("Session Timeout.");
        }, 3 * 60 * 1000);
    }
}

window.saveOfficialName = () => {
    const name = document.getElementById("officialNameInput").value;
    if(name.length < 3) return alert("Enter full valid name.");
    update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
        document.getElementById("nameModal").classList.add("hidden");
        location.reload();
    });
}

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}
window.logout = async () => {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGOUT", method: "Manual Click", time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
        signOut(auth);
    }
};

async function recordLogin(method) {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
    }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
   
    try {
        if(!modelsLoaded) {
            updateStatus("Loading AI Models...", "yellow");
            await preloadModels();
        }
        
        // Remove specific width/height constraints to let the camera decide
stream = await navigator.mediaDevices.getUserMedia({ video: true });
        vid.srcObject = stream;
        vid.onloadedmetadata = () => {
            vid.play();
            startRealTimeDetection(vid, canvas);
        };

        if(isVerify) updateStatus("LOOK AT CAMERA", "white");
        else updateStatus("REGISTRATION: CENTER FACE", "cyan");

    } catch(e) {
        console.error(e);
        updateStatus("Camera Hardware Error", "red");
    }
}
// --- 1. DEFINE METRO DATA ---
const METRO_STATIONS = {
    "Blue Line": [
        "Dakshineswar", "Baranagar", "Noapara", "Dum Dum", "Belgachia", 
        "Shyambazar", "Shobhabazar Sutanuti", "Girish Park", "Mahatma Gandhi Road", 
        "Central", "Chandni Chowk", "Esplanade", "Park Street", "Maidan", 
        "Rabindra Sadan", "Netaji Bhavan", "Jatin Das Park", "Kalighat", 
        "Rabindra Sarobar", "Mahanayak Uttam Kumar", "Netaji", 
        "Masterda Surya Sen", "Gitanjali", "Kavi Nazrul", "Shahid Khudiram", 
        "Kavi Subhash (New Garia)"
    ],
    "Green Line": [
        "Salt Lake Sector V", "Karunamoyee", "Central Park", "City Centre", 
        "Bengal Chemical", "Salt Lake Stadium", "Phoolbagan", "Sealdah", 
        "Esplanade", "Mahakaran", "Howrah", "Howrah Maidan"
    ],
    "Purple Line": [
        "Joka", "Thakurpukur", "Sakher Bazar", "Behala Chowrasta", 
        "Behala Bazar", "Taratala", "Majerhat"
    ],
    "Yellow Line": [
        "Noapara", "Dum Dum Cantonment", "Jessore Road", "Jai Hind (Airport)"
    ],
    "Orange Line": [
        "Kavi Subhash (New Garia)", "Satyajit Ray", "Jyotirindra Nandi", 
        "Kavi Sukanta", "Hemanta Mukhopadhyay"
    ],
    "Pink Line": [
        "Baranagar", "Barrackpore" // Endpoints added as placeholders
    ]
};

// --- 2. HANDLE LINE CHANGE ---
window.handleLineChange = () => {
    const lineSel = document.getElementById("lineSelect");
    const stnSel = document.getElementById("stationSelect");
    const formDiv = document.getElementById("mainDataForm");
    
    // Reset
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    formDiv.classList.add("hidden");
    document.getElementById("inpStationName").value = ""; // Clear hidden input

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        // Populate Stations
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        
        stnSel.disabled = false;
        stnSel.style.background = "#fff";
    }
};
window.handleStationChange = async () => {
    const stnSel = document.getElementById("stationSelect");
    const lineSel = document.getElementById("lineSelect");
    const formDiv = document.getElementById("mainDataForm");
    const submitBtn = document.getElementById("btnFinalSubmit");

    // üõë STEP 1: NUCLEAR WIPE (Force the system to forget Station A)
    await nuclearReset(); 
    
    // üõë STEP 2: MANUALLY CLEAR KEYS (Double Protection)
    currentStationKey = null; 
    currentRakeKey = null;

    if (!stnSel.value) {
        formDiv.classList.add("hidden");
        isSwitching = false;
        return;
    }

    // === STEP 3: SETUP NEW STATION ===
    formDiv.classList.remove("hidden"); // This shows the form inputs
    const fullStationName = `${stnSel.value} (${lineSel.value})`;
    
    document.getElementById("inpStationName").value = fullStationName;
    document.getElementById("formTitle").innerText = `üìù Entry: ${stnSel.value}`;

    // === STEP 4: CHECK IF DATA ALREADY EXISTS ===
    // We check the database: "Do we have data for THIS specific station?"
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(fullStationName));
    const snap = await get(q);

    if (snap.exists()) {
        // --- OLD DATA FOUND (Edit Mode) ---
        let data = null;
        snap.forEach(c => { data = c.val(); currentStationKey = c.key; }); // Load the EXISTING ID
        
        // Fill inputs
        document.getElementById("inpStationLength").value = data.len || "";
        document.getElementById("inpYellowDist").value = data.yl || "";
        document.getElementById("inpYellowThick").value = data.th || "";
        document.getElementById("inpRemarks").value = data.remarks || "";
        document.getElementById("inpImplementation").value = data.impl || "";

        // Button becomes orange
        document.getElementById("dataExistsWarning").classList.remove("hidden");
        document.getElementById("dataExistsWarning").innerHTML = "‚ö†Ô∏è <strong>EDIT MODE:</strong> Modifying Existing Master Record.";
        submitBtn.innerText = "üíæ Update Master Record";
        submitBtn.style.background = "#d97706"; 

        // Load rows
        currentRakeKey = data.linkedRakeKey || currentStationKey;
        const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
        if(rakeSnap.exists()) {
            await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
        }

    } else {
        // --- NO DATA FOUND (New Mode) ---
        // currentStationKey MUST BE NULL here.
        submitBtn.innerText = "‚úî Submit New Log";
        submitBtn.style.background = "#0A2342"; 
    }

    // === STEP 5: START LISTENER ===
    loadDraft(); 
    
    // Unlock the safety
    setTimeout(() => {
        isSwitching = false;
    }, 300);
};
// --- 1. HANDLE TAB & DROPDOWNS ---

// Reuse Station Data Logic for Print Tab
window.handlePrintLineChange = () => {
    const lineSel = document.getElementById("printLineSelect");
    const stnSel = document.getElementById("printStationSelect");
    
    // Reset
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    document.getElementById("printLogList").classList.add("hidden");

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        stnSel.disabled = false;
    }
};
window.deleteStationLog = async (key) => {
    if(!confirm("‚ö†Ô∏è PERMANENTLY DELETE this record?\n\nThis cannot be undone.")) return;

    const btn = document.activeElement; // The delete button you clicked
    if(btn) btn.innerText = "‚è≥";

    try {
        // 1. GET DATA TO FIND LINKS
        const snap = await get(ref(db, `station_logs/${key}`));
        let rakeKey = key; 
        if(snap.exists()) {
             rakeKey = snap.val().linkedRakeKey || key;
        }

        // 2. DELETE BOTH (Atomic removal)
        await remove(ref(db, `station_logs/${key}`));
        await remove(ref(db, `rake_logs/${rakeKey}`));

        // 3. REFRESH THE VIEW INSTANTLY
        // This proves to you immediately that the specific row is gone
        await loadSpecificStationData(); 
        
        alert("‚úÖ Record Removed.");

    } catch(e) {
        alert("‚ùå Error deleting: " + e.message);
        if(btn) btn.innerText = "üóë";
    }
};
// --- 2. FETCH LOGS FOR STATION ---
// UPDATED: Fetch Logs for Print
window.fetchLogsForPrint = async () => {
    const line = document.getElementById("printLineSelect").value;
    const stn = document.getElementById("printStationSelect").value;
    const tbody = document.getElementById("printLogBody");
    const listDiv = document.getElementById("printLogList");

    // 1. WIPE UI (The Fix)
    tbody.innerHTML = "";
    if(!line || !stn) {
        listDiv.classList.add("hidden");
        return;
    }

    listDiv.classList.remove("hidden");
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>üîç Searching Records...</td></tr>";

    // 2. FETCH NEW
    const searchName = `${stn} (${line})`;
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
    
    try {
        const snap = await get(q);
        tbody.innerHTML = ""; // Clear Loading Message

        if(!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>No records found.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const d = c.val();
            const btn = `<button class="info" onclick="openPrintSetup('${c.key}')">üñ®Ô∏è Select</button>`;
            tbody.innerHTML += `
                <tr>
                    <td>${d.date}</td>
                    <td style="font-weight:bold;">${d.name}</td>
                    <td>${d.userName}</td>
                    <td style="text-align:center;">${btn}</td>
                </tr>
            `;
        });
    } catch (e) {
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Connection Error</td></tr>";
    }
};
// --- 3. OPEN CONFIG MODAL ---
let currentPrintKey = null;

// --- UPDATED OPEN CONFIG MODAL ---
window.openPrintSetup = (key) => {
    currentPrintKey = key;
    
    // 1. Fetch Date for display
    get(ref(db, `station_logs/${key}/date`)).then(snap => {
        document.getElementById("modalPrintDate").innerText = snap.val();
    });

    // 2. Populate the "Test Conducting Member" dropdown dynamically
    populateUserDropdown();

    // 3. Show Modal
    document.getElementById("printOptionsModal").classList.remove("hidden");
};

window.closePrintModal = () => {
    document.getElementById("printOptionsModal").classList.add("hidden");
    currentPrintKey = null;
};
window.generateFinalReport = async () => {
    if(!currentPrintKey) return alert("Error: No record selected.");

    // 1. Get Checkbox States
    const includeStation = document.getElementById("chkStationDetails").checked;
    const includeRake = document.getElementById("chkRakeData").checked;

    // 2. Get Authority Names for Signature
    let inspectorName = document.getElementById("selPrintInspector").value;
    const authName = document.getElementById("selPrintAuthority").value;
    
    // Handle "Self" selection
    if(inspectorName === "Self" || inspectorName === "Self (Current User)" || inspectorName === "") {
        inspectorName = currentUser.name || currentUser.email;
    }

    try {
        // --- STEP 1: FETCH MAIN LOG DATA ---
        const sSnap = await get(ref(db, `station_logs/${currentPrintKey}`));
        if(!sSnap.exists()) return alert("Error: Data record not found in DB.");
        const sData = sSnap.val();

        // 3. Fill Report Header (Common Info)
        const cleanName = sData.name.split('(')[0].trim();
        const lineMatch = sData.name.match(/\(([^)]+)\)/);
        
        document.getElementById("rptStationName").innerText = cleanName;
        document.getElementById("rptLineName").innerText = lineMatch ? lineMatch[1] : "Metro Line";
        document.getElementById("rptDate").innerText = sData.date;
        
        // --- FIX IS HERE: USE SELECTED NAME INSTEAD OF SAVED USER ---
        document.getElementById("rptUser").innerText = inspectorName; 
        
        document.getElementById("rptSigInspectorName").innerText = inspectorName;
        document.getElementById("rptSigAuthName").innerText = authName;

        // ============================================================
        // BLOCK A: STATION DETAILS (YELLOW LINE) LOGIC
        // ============================================================
        const secA = document.getElementById("sectionStationDetails");
        
        if(includeStation) {
            secA.style.display = "block";
            document.getElementById("rptLen").innerText = (sData.len || '-') + " m";
            document.getElementById("rptYl").innerText = (sData.yl || '-') + " cm";
            document.getElementById("rptTh").innerText = (sData.th || '-') + " cm";
            document.getElementById("rptRem").innerText = sData.remarks || '-';

            const statusEl = document.getElementById("rptStatus");
            if(sData.impl === "YES") {
                 statusEl.innerHTML = "<span style='color:green; font-weight:bold;'>‚úÖ YES</span>";
            } else if (sData.impl === "NO") {
                 statusEl.innerHTML = "<span style='color:red; font-weight:bold;'>‚ùå NO</span>";
            } else {
                 statusEl.innerHTML = "--";
            }
        } else {
            secA.style.display = "none";
        }

        // ============================================================
        // BLOCK B: RAKE DATA (TABLE) LOGIC
        // ============================================================
        const secB = document.getElementById("sectionRakeData");
        const tbody = document.getElementById("rptRakeBody");

        if(includeRake) {
            secB.style.display = "block";
            tbody.innerHTML = ""; 

            const rakeKey = sData.linkedRakeKey || currentPrintKey;
            const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));

            if(rSnap.exists()) {
                const rRows = rSnap.val();
                let count = 1;
                Object.values(rRows).forEach(r => {
                    const html = `
                        <tr>
                            <td style="text-align:center;">${count++}</td>
                            <td style="font-weight:bold;">${r.rake || '-'}</td>
                            <td>${r.type || '-'}</td>
                            <td>${r.f || '-'}</td>
                            <td>${r.r || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += html;
                });
            } else {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:10px; color:#666;'>No Rake Data Recorded for this Station</td></tr>";
            }
        } else {
            secB.style.display = "none";
        }

        // --- STEP 4: SHOW THE REPORT ---
        closePrintModal();
        document.getElementById("printableReportContainer").classList.remove("hidden");
        window.scrollTo(0,0);

    } catch(err) {
        console.error(err);
        alert("Error generating report: " + err.message);
    }
};
window.closeReportPreview = () => {
    document.getElementById("printableReportContainer").classList.add("hidden");
};
async function startRealTimeDetection(video, canvas) {
    const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
    faceapi.matchDimensions(canvas, displaySize);
    if (detectionLoop) clearInterval(detectionLoop);
    detectionLoop = setInterval(async () => {
        if (!stream) return;
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (detection) {
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            const box = resizedDetections.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
            drawBox.draw(canvas);
            currentDescriptor = detection.descriptor;
            const btn = document.getElementById("btnCapture");
            if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00";
        } else {
            currentDescriptor = null;
            const btn = document.getElementById("btnCapture");
            if(btn) btn.style.border = "1px solid #004494";
        }
    }, 100);
}

function stopCamera() {
    if(detectionLoop) clearInterval(detectionLoop);
    if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    if(vid) vid.srcObject = null;
    if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
    document.getElementById("faceModal").classList.add("hidden");
    isTransactionAuth = false;
    currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }
window.handleFaceScan = async () => {
    const btn = document.getElementById("btnCapture");
    if(!currentDescriptor) { updateStatus("‚ùå No Face Detected.", "red"); return; }
    
    btn.disabled = true;
    btn.innerText = "Processing...";
    updateStatus("Analyzing Biometrics...", "cyan");

    try {
        // --- MODE 1: RECEIVER VERIFICATION ---
        if(scanMode === 'RECEIVER') {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            
            let match = false;
            // Check match against logged-in user
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                    if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }

            if(match) {
                updateStatus("‚úÖ IDENTITY CONFIRMED", "#00ff00");
                setTimeout(() => {
                    stopCamera();
                    receiverVerified = true;
                    // Update UI based on transaction type
                    if(currentTransactionType === 'CHECKOUT') {
                        document.getElementById("checkout_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("checkout_status_text").style.color = "green";
                        document.getElementById("btn_checkout_verify").classList.add("hidden");
                        // Enable Admin Button
                        const subBtn = document.getElementById("btn_checkout_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#b38600";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    } else {
                        document.getElementById("return_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("return_status_text").style.color = "green";
                        document.getElementById("btn_return_verify").classList.add("hidden");
                        // Enable Admin Button
                        const subBtn = document.getElementById("btn_return_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#17a2b8";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    }
                }, 1000);
            } else {
                throw new Error("Face Does Not Match User");
            }
        }

        // --- MODE 2: ADMIN AUTHORIZATION ---
        else if(scanMode === 'ADMIN') {
    // Step 1: must be logged in admin
    if (!isAdmin) {
        throw new Error("You are not an admin account");
    }

    // Step 2: match only against his own face
    const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
    const storedData = snap.val();

    let match = false;
    if (storedData) {
        const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
        for (let s of samples) {
            if (faceapi.euclideanDistance(s, currentDescriptor) < 0.55) {
                match = true;
                break;
            }
        }
    }

    if (match) {
        updateStatus("‚úÖ ADMIN AUTHORIZED", "#00ff00");
        await processTransaction(currentUser.name);
    } else {
        throw new Error("Admin face does not match");
    }
}
        // --- MODE 3: LOGIN ---
        else {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            let match = false;
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                     if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }
            if(match) {
                updateStatus("‚úÖ VERIFIED", "#00ff00");
                await recordLogin("Biometric");
                enterApp();
            } else {
                throw new Error("Face Mismatch");
            }
        }

    } catch (error) {
        console.error(error);
        updateStatus("‚ùå " + error.message, "red");
        btn.disabled = false;
        btn.innerText = "üì∏ Retry Scan";
    }
};

window.registerNewFace = async () => {
    if(!currentDescriptor) { updateStatus("‚ùå Camera cannot see face clearly.", "orange"); return; }
    regSamples.push(Array.from(currentDescriptor));
    const count = regSamples.length;
    updateRegDots(count);
    if(count < 3) {
        updateStatus(`‚úÖ Sample ${count}/3 Captured.`, "lightgreen");
        document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${count + 1} of 3`;
    } else {
        updateStatus("üíæ Saving...", "yellow");
        await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
        alert("Registration Complete!"); location.reload();
    }
};
// --- FIXED: LOAD ALL STATION DATA (Corrected ID Match) ---
window.loadStationData = () => {
    // 1. SHOW THE PANEL
    const panel = document.getElementById("logResultsPanel");
    if(panel) panel.classList.remove("hidden"); 
    
    const title = document.getElementById("logTableTitle");
    if(title) title.innerText = "Recent Station Logs (All)";

    // 2. GET THE CORRECT TABLE BODY (Updated ID for Professional HTML)
    // We check for both IDs just to be safe
    const tbody = document.getElementById("viewTable1Body") || document.getElementById("stationDataViewBody");
    
    // 3. CRASH PREVENTION
    if (!tbody) {
        console.warn("Table Body not found. Skipping render.");
        return; 
    }

    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‚è≥ Loading Station Logs...</td></tr>";

    // 4. FETCH DATA
    const q = query(ref(db, "station_logs"), limitToLast(50));

    onValue(q, (snap) => {
        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No data found.</td></tr>";
            return;
        }

        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); 

        tbody.innerHTML = "";

        logs.forEach(d => {
            // View Button
            const rowButton = `<button class="info" onclick="fetchAndShowRakes('${d.key}')" style="padding:4px 8px; font-size:11px;">üìÑ View Table</button>`;
            
            // Admin Delete Button
            let deleteBtn = "";
            if (isAdmin) {
                deleteBtn = `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:4px 8px; font-size:11px; margin-left:5px;">üóë</button>`;
            }

            // Render Row
            const html = `
            <tr class="station-row-item">
                <td style="font-size:12px;">${d.date}</td>
                <td style="font-size:12px;">${d.userName}</td>
                
                <td style="font-weight:bold;">${d.len || '-'} m</td>
                <td style="font-weight:bold;">${d.yl || '-'} cm</td>
                <td>${d.th || '-'} cm</td>
                
                <td style="text-align:center;">${d.impl === 'YES' ? '<span style="color:green">‚úÖ YES</span>' : '<span style="color:red">‚ùå NO</span>'}</td>
                
                <td style="font-style:italic; color:#555; font-size:11px;">${d.remarks || '--'}</td>
                
                <td style="text-align:center; white-space:nowrap;">
                    ${rowButton}
                    ${deleteBtn}
                </td>
            </tr>`;
            tbody.innerHTML += html;
        });
    }, { onlyOnce: true });
};
// =========================================================
// üöÄ ENGINE CORE: DATA ISOLATION SYSTEM (Unified)
// =========================================================

// Global State Trackers
let currentStationKey = null; 
let currentRakeKey = null;
let draftRef = null;
let draftListener = null;
async function nuclearReset() {
    console.log("‚ò¢Ô∏è NUCLEAR RESET: Hard reset initiated.");
    
    // 1. ENGAGE SAFETY LOCK
    isSwitching = true; 

    // 2. DETACH LISTENERS (Swallow errors to prevent crash)
    if (draftRef) { 
        try { off(draftRef); } catch(e) { console.log("Listener clear error", e); }
        draftRef = null;
    }
    draftListener = null; 

    // 3. WIPE MEMORY
    currentStationKey = null;
    currentRakeKey = null;

    // 4. WIPE INPUTS (Physically clear the box)
    const uiIds = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
    uiIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) { 
            el.value = ""; 
            el.disabled = false; 
            el.blur(); // Remove focus
        }
    });
    
    // 5. WIPE TABLE
    const tbody = document.getElementById("distanceBody");
    if(tbody) tbody.innerHTML = "";

    // 6. RESET BUTTONS
    const warningEl = document.getElementById("dataExistsWarning");
    if(warningEl) warningEl.classList.add("hidden");
    
    const titleEl = document.getElementById("formTitle");
    if(titleEl) titleEl.innerText = "üìù New Entry";
    
    const btn = document.getElementById("btnFinalSubmit");
    if(btn) {
        btn.innerText = "‚úî Submit to Master Database";
        btn.style.background = "#0A2342"; 
        btn.disabled = false;
    }

    // 7. DATABASE PURGE (Clear the user's draft node completely)
    if(currentUser) {
        try {
            await set(ref(db, `drafts/${currentUser.uid}`), null);
        } catch(e) { console.error("Draft wipe failed", e); }
    }
}
window.handleStationChange = async () => {
    const stnSel = document.getElementById("stationSelect");
    const lineSel = document.getElementById("lineSelect");
    const formDiv = document.getElementById("mainDataForm");
    const submitBtn = document.getElementById("btnFinalSubmit");

    // üõë STEP 1: FORCE RESET & WAIT
    await nuclearReset(); 

    if (!stnSel.value) {
        formDiv.classList.add("hidden");
        isSwitching = false;
        return;
    }

    // === STEP 2: SHOW FORM ===
    formDiv.classList.remove("hidden");
    const fullStationName = `${stnSel.value} (${lineSel.value})`;
    
    document.getElementById("inpStationName").value = fullStationName;
    document.getElementById("formTitle").innerText = `üìù Entry: ${stnSel.value}`;

    // === STEP 3: CHECK DATABASE ===
    // Use once() via get() to prevent lingering connections
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(fullStationName));
    const snap = await get(q);

    if (snap.exists()) {
        // --- EDIT MODE ---
        let data = null;
        snap.forEach(c => { data = c.val(); currentStationKey = c.key; });
        
        document.getElementById("inpStationLength").value = data.len || "";
        document.getElementById("inpYellowDist").value = data.yl || "";
        document.getElementById("inpYellowThick").value = data.th || "";
        document.getElementById("inpRemarks").value = data.remarks || "";
        document.getElementById("inpImplementation").value = data.impl || "";

        document.getElementById("dataExistsWarning").classList.remove("hidden");
        document.getElementById("dataExistsWarning").innerHTML = "‚ö†Ô∏è <strong>EDIT MODE:</strong> Modifying Existing Record.";
        submitBtn.innerText = "üíæ Update Master Record";
        submitBtn.style.background = "#d97706"; 

        currentRakeKey = data.linkedRakeKey || currentStationKey;
        
        // Copy Rake Data to Drafts for editing
        const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
        if(rakeSnap.exists()) {
            await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
        }

    } else {
        // --- NEW ENTRY MODE ---
        // currentStationKey is NULL from nuclearReset
        submitBtn.innerText = "‚úî Submit New Log";
        submitBtn.style.background = "#0A2342"; 
    }

    // === STEP 4: START DRAFT LISTENER ===
    loadDraft(); 
    
    // Release the safety lock
    setTimeout(() => { isSwitching = false; }, 500);
};
// --- 3. DRAFT TABLE LOADER (Corrected Name) ---
window.loadDraft = () => {
    // 1. Set the reference to the user's draft rows
    draftRef = ref(db, `drafts/${currentUser.uid}/rows`);
    
    // 2. Start the Realtime Listener
    draftListener = onValue(draftRef, (snap) => {
        const tbody = document.getElementById("distanceBody");
        
        // Safety check: ensure table exists before trying to write to it
        if (!tbody) return; 
        
        tbody.innerHTML = ""; // Clear existing rows

        if(!snap.exists()) return; // If no data, stop here

        const rows = snap.val();
        let count = 1;
        
        // 3. Loop through rows and render HTML
        Object.entries(rows).forEach(([key, val]) => {
            const html = `
                <tr>
                    <td style="text-align:center;">${count++}</td>
                    <td>
                        <input value="${val.rake || ''}" onchange="upRow('${key}','rake',this.value)" placeholder="Rake ID" style="width:100%">
                    </td>
                    <td>
                        <select onchange="upRow('${key}','type',this.value)" style="width:100%">
                            <option value="">Select...</option>
                            <option value="BHEL" ${val.type === 'BHEL' ? 'selected' : ''}>BHEL</option>
                            <option value="MEDHA" ${val.type === 'MEDHA' ? 'selected' : ''}>MEDHA</option>
                            <option value="DALIAN" ${val.type === 'DALIAN' ? 'selected' : ''}>DALIAN</option>
                            <option value="CRRC" ${val.type === 'CRRC' ? 'selected' : ''}>CRRC</option>
                        </select>
                    </td>
                    <td>
                        <input value="${val.f || ''}" onchange="upRow('${key}','f',this.value)" placeholder="Front" style="width:100%">
                    </td>
                    <td>
                        <input value="${val.r || ''}" onchange="upRow('${key}','r',this.value)" placeholder="Rear" style="width:100%">
                    </td>
                    <td style="text-align:center;">
                        <button class="danger" onclick="delRow('${key}')">X</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += html;
        });
    });
};
window.submitStationData = async () => {
    const btn = document.getElementById("btnFinalSubmit");
    btn.innerText = "‚è≥ Saving...";
    btn.disabled = true;

    try {
        const lineSel = document.getElementById("lineSelect");
        const stnSel = document.getElementById("stationSelect");
        
        if (!lineSel.value || !stnSel.value) throw new Error("No station selected.");

        const fullStationName = `${stnSel.value} (${lineSel.value})`;

        const formData = {
            name: fullStationName,
            len: document.getElementById("inpStationLength").value,
            yl: document.getElementById("inpYellowDist").value,
            th: document.getElementById("inpYellowThick").value,
            remarks: document.getElementById("inpRemarks").value,
            impl: document.getElementById("inpImplementation").value,
            user: currentUser.email,
            userName: currentUser.name,
            date: new Date().toLocaleString('en-IN'), 
            timestamp: serverTimestamp()
        };

        const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/rows`));
        const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

        const updates = {};
        let targetKey = currentStationKey;
        let targetRakeKey = currentRakeKey;

        if (targetKey) {
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        } else {
            targetKey = push(ref(db, "station_logs")).key;
            targetRakeKey = targetKey; 
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        }

        updates[`rake_logs/${targetRakeKey}`] = rowsData || null;

        await update(ref(db), updates);
        await remove(ref(db, `drafts/${currentUser.uid}`));
        
        alert(`‚úÖ Saved: ${stnSel.value}`);
        
        // 1. Clear everything
        await nuclearReset(); 
        document.getElementById("mainDataForm").classList.add("hidden");
        document.getElementById("stationSelect").value = "";

        // 2. Switch Tab BUT DO NOT LOAD TABLE
        switchTab('dataView');

    } catch(e) {
        console.error(e);
        alert("‚ùå ERROR: " + e.message);
    } finally {
        if(btn) {
            btn.innerText = "‚úî Submit to Master Database";
            btn.disabled = false;
        }
    }
};
window.viewRakeRows = (rowsEncoded, stationName) => {
    try {
        const rows = JSON.parse(decodeURIComponent(rowsEncoded));
        let msg = `DETAILS FOR: ${stationName}\n\n`;
        msg += `SL | RAKE | TYPE | FRONT | REAR\n`;
        msg += `--------------------------------\n`;
        
        // Loop through the rows object
        let count = 1;
        for (let key in rows) {
            let r = rows[key];
            msg += `${count}. ${r.rake || '-'} | ${r.type || '-'} | ${r.f || '-'} | ${r.r || '-'}\n`;
            count++;
        }
        alert(msg);
    } catch(e) {
        console.error(e);
        alert("Error reading row data.");
    }
};

// --- SEARCH FILTER ---
window.filterStationData = () => {
    const input = document.getElementById("stationLogSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("station-row-item");
    
    Array.from(rows).forEach(row => {
        const stationName = row.cells[1].innerText.toLowerCase(); // Search Station Name
        const submittedBy = row.cells[2].innerText.toLowerCase(); // Search User Name
        
        if (stationName.includes(input) || submittedBy.includes(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};
// List of allowed admin emails (LOWERCASE)
  function checkAdminStatus() {
    const ADMINS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
    
    if (currentUser && ADMINS.includes(currentUser.email.toLowerCase())) {
        isAdmin = true;
        // Force the tab button to show
        const btnAdmin = document.getElementById("btnAdmin");
        const badge = document.getElementById("adminBadge");
        if(btnAdmin) btnAdmin.classList.remove("hidden");
        if(badge) badge.classList.remove("hidden");
        console.log("‚úÖ Admin Mode Active for:", currentUser.email);
    } else {
        isAdmin = false;
        console.log("üë§ User Mode Active for:", currentUser.email);
    }
}
function handleFail() {
    failCount++;
    if(failCount >= 3) {
        stopCamera();
        document.getElementById("faceModal").classList.remove("hidden");
        document.getElementById("videoContainer").classList.add("hidden");
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden");
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${3 - failCount}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            await recordLogin("PIN Entry");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

function enterApp() {
    stopCamera();
    document.getElementById("faceModal").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    
    // Load Tabs
    switchTab('newData');
    loadDraft(); 
    loadGallery(); 
    loadInventory(); 
    loadAssignments();

    // --- FIX: START THE TIMER NOW ---
    setupIdleTimer(); 
}
// --- FIXED TOGGLE FUNCTION (Crash-Free for Checkout & Return) ---
window.toggleInvMode = (mode) => {
    // 1. Hide All Panels
    document.getElementById("inv-add").classList.add("hidden");
    document.getElementById("inv-checkout").classList.add("hidden");
    document.getElementById("inv-return").classList.add("hidden");
    document.getElementById("inv-history").classList.add("hidden");
    document.getElementById("inv-list").classList.add("hidden");
    
    // 2. Show the Selected Panel
    const targetPanel = document.getElementById(`inv-${mode}`);
    if(targetPanel) targetPanel.classList.remove("hidden");
    
    // 3. (REMOVED) Old Dropdown Logic
    // We strictly removed the calls to 'populateCheckoutSelect' 
    // and 'populateReturnSelect' here. 
    // This stops the "innerHTML of null" error completely.

    // 4. Special Focus Logic for History Tab
    if(mode === 'history') {
        setTimeout(() => {
             const searchInput = document.getElementById("auditSearchInput");
             if(searchInput) searchInput.focus();
        }, 100);
    }
};
// 1. POPULATE CHECKOUT (Show All Items)
function populateCheckoutSelect() {
    const sel = document.getElementById("checkoutSelect");
    sel.innerHTML = "<option value=''>Loading...</option>";
    onValue(ref(db, "inventory"), snap => {
        sel.innerHTML = "<option value=''>Select Item...</option>";
        snap.forEach(c => {
            const v = c.val();
            const opt = document.createElement("option");
            opt.value = c.key;
            opt.text = `${v.item} (Avail: ${v.qty})`;
            opt.dataset.qty = v.qty;
            opt.dataset.name = v.item;
            // NEW: STORE BARCODE
            if(v.barcode) opt.dataset.barcode = v.barcode;
            sel.appendChild(opt);
        });
    }, { onlyOnce: true });
}

// 2. POPULATE RETURN (Show Only Items You Hold)
async function populateReturnSelect() {
    const sel = document.getElementById("returnSelect");
    sel.innerHTML = "<option value=''>Calculating your holdings...</option>";

    try {
        // A. Get current Inventory (for keys)
        const invSnap = await get(ref(db, "inventory"));
        const inventoryMap = {}; // Maps ItemName -> { key, exists, barcode }
        invSnap.forEach(c => {
            const val = c.val();
            inventoryMap[val.item] = { key: c.key, exists: true, barcode: val.barcode };
        });

        // B. Get User Logs
        const logsSnap = await get(query(ref(db, "logs")));
        const myHoldings = {}; // ItemName -> NetQuantity

        logsSnap.forEach(c => {
            const l = c.val();
            // Check if this log belongs to current user
            const isMe = (l.takenBy === currentUser.name) || (l.takenBy === currentUser.email);
            
            if (isMe) {
                if(l.type === 'CHECKOUT') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) + parseInt(l.qty);
                } else if (l.type === 'RETURN') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) - parseInt(l.qty);
                }
            }
        });

        // C. Render
        sel.innerHTML = "<option value=''>Select Item...</option>";
        let foundAny = false;

        for (const [itemName, netQty] of Object.entries(myHoldings)) {
            if (netQty > 0 && inventoryMap[itemName]) {
                foundAny = true;
                const opt = document.createElement("option");
                opt.value = inventoryMap[itemName].key; // Use inventory key for update
                opt.text = `${itemName} (You have: ${netQty})`;
                opt.dataset.qty = netQty; // Max returnable
                opt.dataset.name = itemName;
                // NEW: STORE BARCODE
                if(inventoryMap[itemName].barcode) opt.dataset.barcode = inventoryMap[itemName].barcode;
                sel.appendChild(opt);
            }
        }

        if(!foundAny) {
            sel.innerHTML = "<option value=''>No items to return.</option>";
        }

    } catch (e) {
        console.error(e);
        sel.innerHTML = "<option>Error loading.</option>";
    }
}

window.updateMaxQty = () => {
    const isCheckout = !document.getElementById("inv-checkout").classList.contains("hidden");
    const selId = isCheckout ? "checkoutSelect" : "returnSelect";
    const inpId = isCheckout ? "checkoutAvail" : "returnAvail";
    
    const sel = document.getElementById(selId);
    const opt = sel.options[sel.selectedIndex];
    
    if(opt && opt.dataset.qty) {
        document.getElementById(inpId).value = opt.dataset.qty;
    } else {
        document.getElementById(inpId).value = "";
    }
};

// --- NEW HISTORY LOADING LOGIC (FIXED) ---

function formatTime(ts) {
    if (!ts) return "N/A";
    const d = new Date(ts);
    
    // Convert to Indian Standard Time (Asia/Kolkata)
    return d.toLocaleString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}
// --- LINEAR HISTORY LOGIC (SIMPLE LIST + BARCODES) ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Retrieving Secure Records...</td></tr>";

    // Fetch last 300 logs
    const q = query(ref(db, "logs"), limitToLast(300));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); // Show newest events at the top

        // Filter: Show only inventory-related events
        const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE');

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded in recent history.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        
        invLogs.forEach(l => {
            // Badge Styling
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            // Barcode formatting
            const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px;">||| ${l.barcode}</div>` : '';

            // Row HTML
            const row = `
            <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
                <td style="font-weight:bold; color:#003366;">${l.barcode || '--'}</td>
                <td style="font-weight:bold;">${l.takenBy || 'Unknown'}</td>
                <td>
                    ${formatTime(l.time)}<br>
                    <small style="color:#555;">Auth: ${l.approvedBy || 'System'}</small>
                </td>
                <td style="text-align:center;">${badge}</td>
                <td>
                    <span style="font-size:13px;">${l.item}</span>
                </td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    }, { onlyOnce: true });
};
// --- NEW SEARCH FUNCTION FOR INVENTORY ---
window.filterInvLogs = () => {
    const input = document.getElementById("invSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("inv-log-row");
   
    Array.from(rows).forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
};
// --- UPDATED SUBMIT FUNCTION (COMBINED LOCATION LOGIC) ---
window.submitTransactionNoFace = (type) => {
    if(!pendingTransactionItem) return alert("Please SCAN an item first.");
    
    // --- CHECKOUT VALIDATION ---
    if(type === 'CHECKOUT') {
        const purpose = document.getElementById("checkoutPurpose").value;
        if(!purpose || purpose.trim() === "") return alert("Please enter the PURPOSE for this checkout.");
    }
    
    // --- RETURN VALIDATION & FORMATTING ---
    let finalLocation = "";
    
    if(type === 'RETURN') {
        // 1. Get Main Place
        const selection = document.getElementById("returnLocSelect").value;
        let mainPlace = selection;
        
        if(selection === "Other") {
            const otherText = document.getElementById("returnLocOther").value.trim();
            if(!otherText) return alert("Please specify the 'Other' location name.");
            mainPlace = otherText;
        }

        // 2. Get Specific Spot (Cabinet/Almirah)
        const spot = document.getElementById("returnLocSpot").value.trim();
        if(!spot) return alert("Please specify the Exact Spot (e.g., Cabinet, Almirah).");

        // 3. Combine them
        // Format: "D2 Building - Heerok Sir Lab [Upper Cabinet]"
        finalLocation = `${mainPlace} [${spot}]`;
    }

    scanMode = 'DIRECT'; 
    currentTransactionType = type;
    
    // Pass the calculated location to the processor
    processTransaction("Self/System", finalLocation);
};
// --- UPDATED TRANSACTION LOGIC ---
// --- UPDATED PROCESSOR TO ACCEPT LOCATION ARGUMENT ---
async function processTransaction(adminName, customReturnLocation = null) {
    const isCheckout = currentTransactionType === 'CHECKOUT';
    
    if(!pendingTransactionItem) return alert("System Error: No item scanned.");

    const itemKey = pendingTransactionItem.key;
    const itemName = pendingTransactionItem.item;
    const barcode = pendingTransactionItem.barcode;

    // Get Checkout Purpose (if applicable)
    const purposeInput = isCheckout ? document.getElementById("checkoutPurpose").value : null;

    // 1. Fetch Fresh Data
    const invRef = ref(db, `inventory/${itemKey}`);
    const invSnap = await get(invRef);
    
    if(!invSnap.exists()) return alert("Item vanished from DB.");
    
    const val = invSnap.val();
    const currentStatus = val.status;
    const currentUsage = val.usageCount || 0; 

    // 2. Logic Gates
    if(isCheckout && currentStatus === 'Checked Out') return alert(`Item already taken by: ${val.holder}`);
    if(!isCheckout && currentStatus === 'In Stock') return alert(`Item is already in the store.`);

    // 3. Prepare Update Data
    const uSnap = await get(ref(db, `users/${currentUser.uid}`));
    const realUserName = uSnap.val()?.name || currentUser.email;

    let updateData = {};

    if (isCheckout) {
        // CHECKOUT
        updateData = {
            status: "Checked Out",
            holder: realUserName,
            purpose: purposeInput,
            location: "Out with User", 
            usageCount: currentUsage + 1 
        };
    } else {
        // RETURN - USE THE CUSTOM LOCATION WE BUILT
        updateData = {
            status: "In Stock",
            holder: "Store",
            purpose: null,
            location: customReturnLocation // Saves "D2 Lab [Cabinet]"
        };
    }

    // 4. Update Database
    await update(invRef, updateData);

    // 5. Log It
    const logData = {
        type: currentTransactionType,
        item: itemName,
        barcode: barcode,
        qty: 1,
        takenBy: realUserName,
        approvedBy: "Direct (No Admin)",
        location: isCheckout ? "Out" : customReturnLocation, 
        purpose: isCheckout ? purposeInput : "Return",
        time: serverTimestamp()
    };

    await push(ref(db, "logs"), logData);
    
    alert(`‚úÖ ${currentTransactionType} Successful!\nItem: ${itemName}`);
    
    // Clear Inputs
    if(document.getElementById("checkoutPurpose")) document.getElementById("checkoutPurpose").value = "";
    if(document.getElementById("returnLocOther")) document.getElementById("returnLocOther").value = "";
    if(document.getElementById("returnLocSpot")) document.getElementById("returnLocSpot").value = "";

    // UI Cleanup
    document.getElementById("checkout_display").classList.add("hidden");
    document.getElementById("return_display").classList.add("hidden");
    pendingTransactionItem = null;
    toggleInvMode('list');
}
// --- NEW HELPER: POPULATE USER DROPDOWN ---
window.populateUserDropdown = async () => {
    const sel = document.getElementById("selPrintInspector");
    
    // 1. Reset with "Self" option (Convenience)
    const currentName = currentUser.name || currentUser.email;
    sel.innerHTML = `<option value="">-- Select Member --</option>
                     <option value="Self">Self (${currentName})</option>
                     <optgroup label="All Registered Users:">`;

    // 2. Fetch all users from DB
    try {
        const snap = await get(ref(db, "users"));
        if (snap.exists()) {
            snap.forEach(c => {
                const u = c.val();
                const uName = u.name || u.email; // Use email if name is missing
                
                // Add to dropdown
                const opt = document.createElement("option");
                opt.value = uName;
                opt.innerText = uName;
                sel.appendChild(opt);
            });
        }
    } catch (e) {
        console.error("Error loading users:", e);
        sel.innerHTML += `<option disabled>Error loading users</option>`;
    }
};
window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    if(!name) return alert("Station Name Required");
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name,
        len: document.getElementById("inpStationLength").value,
        yl: document.getElementById("inpYellowDist").value,
        th: document.getElementById("inpYellowThick").value,
        remarks: document.getElementById("inpRemarks").value
    });
    alert("Draft Saved");
};
// --- 1. HANDLE LOG LINE CHANGE (Populate Station Dropdown) ---
window.handleLogLineChange = () => {
    const lineSel = document.getElementById("logLineSelect");
    const stnSel = document.getElementById("logStationSelect");
    const resultsDiv = document.getElementById("logResultsPanel");
    
    // Reset
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    resultsDiv.classList.add("hidden");

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        // Populate Stations using the existing METRO_STATIONS data
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        
        stnSel.disabled = false;
        stnSel.style.background = "#fff";
    }
};
window.loadSpecificStationData = async () => {
    const stnSel = document.getElementById("logStationSelect");
    const lineSel = document.getElementById("logLineSelect");
    const resultsDiv = document.getElementById("logResultsPanel");
    
    // 1. IDENTIFY THE TABLE BODY CORRECTLY
    const tbody = document.getElementById("viewTable1Body") || document.getElementById("stationDataViewBody");
    if (!tbody) return console.error("Table Body missing!");

    // 2. CLEAR UI & SHOW LOADING
    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>üîç Searching Database...</td></tr>";
    resultsDiv.classList.remove("hidden");

    if (!stnSel.value || !lineSel.value) return;
    
    // 3. STRICT SEARCH PARAMETER
    const searchName = `${stnSel.value} (${lineSel.value})`; 

    // 4. PRECISE DATABASE QUERY
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
    
    try {
        const snap = await get(q);
        tbody.innerHTML = ""; // Wipe "Loading..." message
        
        if (!snap.exists()) {
            tbody.innerHTML = `<tr><td colspan='8' style='text-align:center; color:red; font-weight:bold;'>‚ùå No records found for ${stnSel.value}</td></tr>`;
            return;
        }

        // 5. RENDER ONLY MATCHING RECORDS
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        
        // Sort by Newest First
        logs.sort((a, b) => b.timestamp - a.timestamp);

        logs.forEach(d => {
             let buttonsHtml = `<button onclick="openRakeModal('${d.key}')" class="info" style="padding:2px 6px; font-size:11px; margin-right:4px;">üìÑ View Table</button>`;
             
             // Admin & Owner Controls
             if (isAdmin || d.user === currentUser.email) {
                buttonsHtml += `<button class="warning" onclick="editStationLog('${d.key}')" style="padding:2px 6px; font-size:11px; margin-right:4px;">‚úèÔ∏è Edit</button>`;
             }
             if (isAdmin) {
                buttonsHtml += `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:2px 6px; font-size:11px;">üóë</button>`;
             }

             const row = `
            <tr>
                <td style="font-size:12px;">${d.date}</td>
                <td style="font-size:12px;">${d.userName}</td>
                <td style="font-weight:bold;">${d.len || '-'} m</td>
                <td style="font-weight:bold; color:#e31e24;">${d.yl || '-'} cm</td>
                <td>${d.th || '-'} cm</td>
                <td style="text-align:center; font-weight:bold;">
                    ${d.impl === 'YES' ? '<span style="color:green">‚úÖ YES</span>' : (d.impl === 'NO' ? '<span style="color:red">‚ùå NO</span>' : '-')}
                </td>
                <td style="font-style:italic; font-size:12px;">${d.remarks || '--'}</td>
                <td style="white-space:nowrap;">${buttonsHtml}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan='8' style='color:red;'>Connection Error: ${e.message}</td></tr>`;
    }
};
// 2. NEW: Function to open the Rake Data in a POPUP MODAL
window.openRakeModal = async (key) => {
    const modal = document.getElementById("rakeDataModal");
    const tbody = document.getElementById("modalRakeBody");
    
    // Show Modal immediately
    modal.classList.remove("hidden");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>‚è≥ Fetching Rake Data...</td></tr>";

    try {
        // First get the station log to find the linkedRakeKey
        const sSnap = await get(ref(db, `station_logs/${key}`));
        if(!sSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Log not found.</td></tr>";
            return;
        }
        
        const sData = sSnap.val();
        const rakeKey = sData.linkedRakeKey || key;

        // Fetch the Rake Data
        const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
        
        if(!rSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#666;'>No Rake Clearance Data recorded for this entry.</td></tr>";
            return;
        }

        // Populate Modal Table
        tbody.innerHTML = "";
        const rows = rSnap.val();
        let count = 1;
        
        Object.values(rows).forEach(r => {
            const html = `
                <tr>
                    <td style="text-align:center;">${count++}</td>
                    <td style="font-weight:bold;">${r.rake || '-'}</td>
                    <td>${r.type || '-'}</td>
                    <td>${r.f || '-'}</td>
                    <td>${r.r || '-'}</td>
                    <td style="text-align:center;">${r.act || '-'}</td>
                </tr>
            `;
            tbody.innerHTML += html;
        });

    } catch(e) {
        console.error(e);
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
    }
};

// 3. Ensure Close Function Exists
window.closeRakeModal = () => {
    document.getElementById("rakeDataModal").classList.add("hidden");
};
// 2. NEW: Function to open the Rake Data in the MODAL
window.openRakeModal = async (key) => {
    const modal = document.getElementById("rakeDataModal");
    const tbody = document.getElementById("modalRakeBody");
    
    // Show Modal immediately
    modal.classList.remove("hidden");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>‚è≥ Fetching Rake Data...</td></tr>";

    try {
        // First get the station log to find the linkedRakeKey
        const sSnap = await get(ref(db, `station_logs/${key}`));
        if(!sSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Log not found.</td></tr>";
            return;
        }
        
        const sData = sSnap.val();
        const rakeKey = sData.linkedRakeKey || key;

        // Fetch the Rake Data
        const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
        
        if(!rSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#666;'>No Rake Clearance Data recorded for this entry.</td></tr>";
            return;
        }

        // Populate Modal Table
        tbody.innerHTML = "";
        const rows = rSnap.val();
        let count = 1;
        
        Object.values(rows).forEach(r => {
            const html = `
                <tr>
                    <td style="text-align:center;">${count++}</td>
                    <td style="font-weight:bold;">${r.rake || '-'}</td>
                    <td>${r.type || '-'}</td>
                    <td>${r.f || '-'}</td>
                    <td>${r.r || '-'}</td>
                    <td style="text-align:center;">${r.act || '-'}</td>
                </tr>
            `;
            tbody.innerHTML += html;
        });

    } catch(e) {
        console.error(e);
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
    }
};
// --- 3. SUBMIT FUNCTION (Saves Station-Wise to Master DB) ---
window.submitStationData = async () => {
    const btn = document.getElementById("btnFinalSubmit");
    btn.innerText = "‚è≥ Saving to Master DB...";
    btn.disabled = true;

    try {
        const lineSel = document.getElementById("lineSelect");
        const stnSel = document.getElementById("stationSelect");
        
        // 1. Double Check: Ensure we have a valid station selected
        if (!lineSel.value || !stnSel.value) {
            throw new Error("No station selected. Please refresh.");
        }

        const fullStationName = `${stnSel.value} (${lineSel.value})`;

        // 2. Gather UI Inputs
        const formData = {
            name: fullStationName,
            len: document.getElementById("inpStationLength").value,
            yl: document.getElementById("inpYellowDist").value,
            th: document.getElementById("inpYellowThick").value,
            remarks: document.getElementById("inpRemarks").value,
            impl: document.getElementById("inpImplementation").value,
            user: currentUser.email,
            userName: currentUser.name,
            date: new Date().toLocaleString(),
            timestamp: serverTimestamp()
        };

        // 3. Fetch Your Draft Rows (The Rake Table)
        const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/rows`));
        const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

        const updates = {};
        let targetKey = currentStationKey;
        let targetRakeKey = currentRakeKey;

        // 4. Logic: Are we Updating or Creating?
        if (targetKey) {
            // --- UPDATING EXISTING MASTER RECORD ---
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        } else {
            // --- CREATING NEW MASTER RECORD ---
            targetKey = push(ref(db, "station_logs")).key;
            targetRakeKey = targetKey; // Link them
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        }

        // 5. OVERWRITE RAKE LOGS
        // We replace the Public Rake Logs with exactly what is in your Draft table
        // This ensures the Master DB matches your screen exactly.
        updates[`rake_logs/${targetRakeKey}`] = rowsData || null;

        // 6. COMMIT TO DATABASE
        await update(ref(db), updates);

        // 7. CLEANUP: Delete your private draft
        // This ensures your personal data doesn't persist. 
        // The data is now fully "Station-Wise" in the shared DB.
        await remove(ref(db, `drafts/${currentUser.uid}`));
        
        alert(`‚úÖ SUCCESS: Data for ${stnSel.value} saved to Master Database.`);
        
        // 8. Refresh and Close
        document.getElementById("distanceBody").innerHTML = ""; 
        switchTab('dataView');
        loadStationData(); 
        
        // Reset inputs to prevent accidental double submission
        await nuclearReset();
        document.getElementById("mainDataForm").classList.add("hidden");
        document.getElementById("stationSelect").value = "";

    } catch(e) {
        console.error(e);
        alert("‚ùå ERROR: " + e.message);
    } finally {
        btn.innerText = "‚úî Submit to Master Database";
        btn.disabled = false;
    }
};
// 3. Ensure Close Function Exists
window.closeRakeModal = () => {
    document.getElementById("rakeDataModal").classList.add("hidden");
};
window.editStationLog = async (key) => {
    if (!confirm("‚úèÔ∏è Edit this record?")) return;

    try {
        // 1. Fetch Station Data
        const stationSnap = await get(ref(db, `station_logs/${key}`));
        if (!stationSnap.exists()) return alert("Record not found.");
        const sData = stationSnap.val();

        // 2. Set Global Editing Keys
        currentStationKey = key;
        currentRakeKey = sData.linkedRakeKey || key;

        // 3. CLEAN UP DRAFTS (Fixes the "Double Rows" bug)
        // We wipe the draft folder clean before loading data
        await remove(ref(db, `drafts/${currentUser.uid}`));
        document.getElementById("distanceBody").innerHTML = "";

        // 4. Switch to Form Tab
        switchTab('newData');
        document.getElementById("mainDataForm").classList.remove("hidden");
        document.getElementById("dataExistsWarning").classList.add("hidden"); // Hide the "Locked" warning

        // 5. Fill Station Details & UNLOCK THEM
        document.getElementById("inpStationName").value = sData.name;
        document.getElementById("formTitle").innerText = `‚úèÔ∏è EDITING: ${sData.name}`;
        
        const inpLen = document.getElementById("inpStationLength");
        const inpYl = document.getElementById("inpYellowDist");
        const inpTh = document.getElementById("inpYellowThick");
        const inpRem = document.getElementById("inpRemarks");
        const inpImpl = document.getElementById("inpImplementation");

        inpLen.value = sData.len || "";
        inpYl.value = sData.yl || "";
        inpTh.value = sData.th || "";
        inpRem.value = sData.remarks || "";
        inpImpl.value = sData.impl || "";

        // Unlock inputs so you can edit Yellow Line details
        inpLen.disabled = false;
        inpYl.disabled = false;
        inpTh.disabled = false;
        inpRem.disabled = false;
        inpImpl.disabled = false;
        document.getElementById("btnSaveDraft").disabled = false;

        // 6. Update Submit Button
        const submitBtn = document.getElementById("btnFinalSubmit");
        submitBtn.innerText = "üíæ Save Changes";
        submitBtn.disabled = false;
        submitBtn.style.background = "#ffc107"; // Orange
        submitBtn.style.color = "#000";
        submitBtn.style.cursor = "pointer";

        // 7. Load Rake Data (Exactly as it is in DB)
        const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
        if (rakeSnap.exists()) {
            // Copy exact DB rows to Drafts
            await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
        }

        // 8. Render Table
        loadDraft();

    } catch (e) {
        console.error(e);
        alert("Error loading for edit: " + e.message);
    }
};

async function hardResetForm() {
    // A. Wipe Visual Inputs
    document.getElementById("inpStationLength").value = "";
    document.getElementById("inpYellowDist").value = "";
    document.getElementById("inpYellowThick").value = "";
    document.getElementById("inpRemarks").value = "";
    document.getElementById("inpImplementation").value = "";
    document.getElementById("distanceBody").innerHTML = ""; // Clear Rake Table
    
    // B. Clear Global Key variables
    currentStationKey = null;
    currentRakeKey = null;

    // C. CRITICAL: Wipe the 'Draft' node in Firebase for this user
    // This ensures data from the previous station doesn't persist
    if(currentUser) {
        await remove(ref(db, `drafts/${currentUser.uid}`));
    }
}
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
};
window.deleteUserTask = (uid, taskKey) => {
    if(confirm("Are you sure you want to remove this task?")) {
        remove(ref(db, `assignments/${uid}/${taskKey}`))
            .then(() => {
                // View updates automatically via listener
            })
            .catch(err => alert("Error: " + err.message));
    }
};
// =========================================================================
// üëë COMPLETE ADMIN SYSTEM (Assignments, Resets, Tracking, Banning)
// =========================================================================
// --- 1. LOAD ADMIN PANEL (Fixed Duplication Logic) ---
window.loadAdminPanel = () => {
    if (!isAdmin) return; 

    const userTable = document.getElementById("userListBody");
    const taskCheckboxList = document.getElementById("userCheckboxList");
    
    // üõë STOP PREVIOUS LISTENER (THE FIX)
    // In Modular Firebase, onValue returns a function. We call IT to unsubscribe.
    if (window.adminListener && typeof window.adminListener === "function") {
        window.adminListener(); // This kills the old listener immediately
        window.adminListener = null;
    }

    userTable.innerHTML = "<tr><td colspan='6' style='text-align:center;'>üîÑ Syncing Database...</td></tr>";

    // Start New Listener
    window.adminListener = onValue(ref(db, "users"), async (snap) => {
        // 1. Clear UI immediately
        userTable.innerHTML = "";
        if(taskCheckboxList) taskCheckboxList.innerHTML = "";

        if (!snap.exists()) {
            userTable.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No users found.</td></tr>";
            return;
        }

        // 2. Fetch Status (Wait for it)
        const statusSnap = await get(ref(db, "status"));
        const statusMap = statusSnap.val() || {};

        // 3. Render Loop
        snap.forEach(c => {
            const u = c.val();
            const uid = c.key;
            const name = u.name || u.email;
            const isBanned = (u.banned === true);

            // ONLINE BADGE
            const s = statusMap[uid];
            // Check if last seen within 20 seconds
            const isOnline = (s && s.state === 'online' && (Date.now() - (s.last_seen || 0)) < 20000);
            
            const badge = isOnline ? 
                `<span class="badge-online" style="background:#dcfce7; color:green; border:1px solid #bbf7d0;">‚óè ONLINE</span>` : 
                `<span class="badge-offline" style="background:#f1f5f9; color:grey;">‚óã OFFLINE</span>`;

            // FACE STATUS
            const faceIcon = u.faceData ? `<span style="color:green">‚úî Reg</span>` : `<span style="color:red">‚ùå No</span>`;

            // ACTION BUTTONS
            let mainActionBtn = "";
            let rowStyle = "";
            
            if (isBanned) {
                rowStyle = "background-color: #fee2e2; border-left: 4px solid #991b1b;";
                mainActionBtn = `<button onclick="unbanUser('${uid}', '${name}')" class="success" style="font-size:10px; padding:4px 8px;">‚úÖ UNBAN</button>`;
            } else {
                mainActionBtn = `<button onclick="openBanModal('${uid}', '${name}')" class="danger" style="font-size:10px; padding:4px 8px;">üö´ BAN</button>`;
                
                // Populate Checkboxes (Only for active users)
                if(taskCheckboxList) {
                    taskCheckboxList.innerHTML += `
                        <label class="checkbox-item" style="display:flex; align-items:center; gap:8px; padding:5px; border-bottom:1px solid #eee;">
                            <input type="checkbox" class="user-check" value="${uid}"> 
                            <span>${name}</span>
                        </label>`;
                }
            }

            // RENDER HTML
            const html = `
                <tr style="${rowStyle}">
                    <td>
                        <strong>${name}</strong><br>
                        <small style="color:#666;">${u.email}</small>
                        ${isBanned ? '<br><b style="color:red; font-size:10px;">(SUSPENDED)</b>' : ''}
                    </td>
                    <td style="text-align:center;">${badge}</td>
                    
                    <td style="text-align:center;" id="task_stat_${uid}">
                        <small>Loading...</small>
                    </td>

                    <td style="text-align:center;">${faceIcon}</td>

                    <td>
                        <button class="info" onclick="viewUserTasks('${uid}', '${name}')" style="font-size:10px; padding:4px 8px; margin-bottom:4px; width:100%;">
                            üìã Track Work
                        </button>
                        ${mainActionBtn}
                    </td>

                    <td>
                        <button class="warning" onclick="resetUserName('${uid}')" style="font-size:10px; padding:3px 6px; margin-bottom:4px; width:100%;">
                            üîÑ Reset Name
                        </button>
                        <button class="secondary" onclick="resetUserFace('${uid}')" style="font-size:10px; padding:3px 6px; width:100%; background:#334155; color:white;">
                            üë§ Reset Face
                        </button>
                    </td>
                </tr>
            `;
            userTable.innerHTML += html;

            // LIVE TASK MONITOR (Keep this separate)
            onValue(ref(db, `assignments/${uid}`), (taskSnap) => {
                const el = document.getElementById(`task_stat_${uid}`);
                if (el) {
                    let pending = 0, done = 0;
                    if (taskSnap.exists()) {
                        taskSnap.forEach(t => { t.val().status === 'Done' ? done++ : pending++; });
                        el.innerHTML = `<span style="color:green; font-weight:bold;">${done}</span> / <span style="color:orange; font-weight:bold;">${pending}</span>`;
                    } else {
                        el.innerHTML = `<span style="color:#ccc;">-</span>`;
                    }
                }
            }, { onlyOnce: false });
        });
    });
};
// --- 2. ASSIGN TASK (Multi-User) ---
window.assignTaskMulti = async () => {
    const descInput = document.getElementById("taskDesc");
    const desc = descInput.value.trim();
    
    if(!desc) return alert("Please enter task instructions.");

    // Select all checked boxes
    const checkboxes = document.querySelectorAll('.user-check:checked');
    if(checkboxes.length === 0) return alert("Please select at least one personnel.");

    let count = 0;
    const updates = {};

    checkboxes.forEach(cb => {
        const uid = cb.value;
        const newKey = push(ref(db, `assignments/${uid}`)).key;
        
        updates[`assignments/${uid}/${newKey}`] = {
            desc: desc,
            by: currentUser.email,
            date: new Date().toLocaleString(),
            status: "Pending",
            timestamp: serverTimestamp()
        };
        count++;
    });

    try {
        await update(ref(db), updates);
        alert(`‚úÖ Task dispatched to ${count} users.`);
        descInput.value = ""; // Clear input
        checkboxes.forEach(cb => cb.checked = false); // Uncheck all
    } catch(e) {
        alert("Error assigning task: " + e.message);
    }
};

// --- 3. TRACK WORK (View User Tasks) ---
window.viewUserTasks = (uid, name) => {
    // Show Modal
    document.getElementById("adminTaskModal").classList.remove("hidden");
    document.getElementById("modalTaskUserName").innerText = decodeURIComponent(name);
    
    const tbody = document.getElementById("adminTaskBody");
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Fetching Tasks...</td></tr>";

    // Listen to tasks
    onValue(ref(db, `assignments/${uid}`), (snap) => {
        tbody.innerHTML = "";
        
        if(!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#999;'>No active tasks.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const t = c.val();
            const statusBadge = t.status === 'Done' 
                ? `<span style="color:green; font-weight:bold; background:#dcfce7; padding:2px 6px; border-radius:4px;">‚úî DONE</span>` 
                : `<span style="color:#d97706; font-weight:bold; background:#fef3c7; padding:2px 6px; border-radius:4px;">‚è≥ PENDING</span>`;

            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="font-size:12px;">${t.date}</td>
                    <td style="font-weight:600;">${t.desc}</td>
                    <td style="text-align:center;">${statusBadge}</td>
                    <td style="text-align:center;">
                        <button class="danger" onclick="deleteUserTask('${uid}', '${c.key}')" style="font-size:10px; padding:4px 8px;">üóë</button>
                    </td>
                </tr>
            `;
        });
    });
};

// --- 4. DELETE SINGLE TASK ---
window.deleteUserTask = async (uid, taskKey) => {
    if(confirm("Remove this task?")) {
        await remove(ref(db, `assignments/${uid}/${taskKey}`));
    }
};

// --- 5. RESET NAME (Fixes "Not Reset Name") ---
window.resetUserName = async (uid) => {
    if(confirm("‚ö†Ô∏è Reset Name?\n\nThe user will be forced to set their 'Official Name' again on next login.")) {
        try {
            await update(ref(db, `users/${uid}`), { name: null });
            alert("‚úÖ Name Reset. User must re-enter it.");
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
};

// --- 6. RESET FACE (Fixes "Not Reset Face") ---
window.resetUserFace = async (uid) => {
    if(confirm("‚ö†Ô∏è Reset Face ID?\n\nThis deletes their biometric data. They must re-register their face to access the system.")) {
        try {
            await update(ref(db, `users/${uid}`), { faceData: null });
            alert("‚úÖ Face ID Wiped. User must re-register.");
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
};

// --- 7. CLOSE TASK MODAL ---
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
};
// ==============================================
//            FULL BAN SYSTEM LOGIC
// ==============================================

let currentBanTargetUid = null;
let currentBanDays = 0; // Stores days OR 'CUSTOM'

// 1. OPEN MODAL
window.openBanModal = (uid, encodedName) => {
    if(!isAdmin) return alert("Admins Only.");
    if(uid === currentUser.uid) return alert("You cannot ban yourself.");
    
    currentBanTargetUid = uid;
    document.getElementById("banTargetName").innerText = decodeURIComponent(encodedName);
    document.getElementById("adminBanModal").classList.remove("hidden");
    
    // Reset Form
    document.getElementById("banReasonInput").selectedIndex = 0;
    toggleBanOtherInput(); // Hide 'Other' input
    document.getElementById("banReasonOther").value = "";
    document.getElementById("banActionInput").value = "";
    document.getElementById("banRemarks").value = "";
    document.getElementById("banCustomDate").value = "";
    
    // Reset Buttons
    currentBanDays = 0;
    document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
};

// 2. CLOSE MODAL
window.closeBanModal = () => {
    document.getElementById("adminBanModal").classList.add("hidden");
    currentBanTargetUid = null;
};

// 4. SUBMIT BAN (MAIN FUNCTION)
window.submitBan = async () => {
    if(!currentBanTargetUid) return;

    // --- STEP A: REASON VALIDATION ---
    let reason = document.getElementById("banReasonInput").value;
    if(reason === "Other") {
        const otherText = document.getElementById("banReasonOther").value.trim();
        if(!otherText) return alert("Please specify the 'Other' reason details.");
        reason = "Other: " + otherText;
    }

    // --- STEP B: ACTION VALIDATION ---
    const actionInst = document.getElementById("banActionInput").value.trim();
    if(!actionInst) return alert("Please enter 'Action Required' (How to dispose this matter).");

    // --- STEP C: DEADLINE CALCULATION ---
    let expiryTimestamp = 0;
    
    if(currentBanDays === 'CUSTOM') {
        const dateVal = document.getElementById("banCustomDate").value;
        if(!dateVal) return alert("Please select a Deadline Date.");
        
        // Set expiry to the END of that day (23:59:59)
        const d = new Date(dateVal);
        d.setHours(23, 59, 59, 999);
        expiryTimestamp = d.getTime();
        
        // Sanity check: Date cannot be in the past
        if(expiryTimestamp < Date.now()) return alert("Deadline cannot be in the past.");
    } 
    else if (typeof currentBanDays === 'number' && currentBanDays > 0) {
        // Calculate future timestamp: Now + (Days * ms)
        expiryTimestamp = Date.now() + (currentBanDays * 24 * 60 * 60 * 1000);
    } 
    else {
        return alert("Please select a valid Tenure/Deadline.");
    }

    const remarks = document.getElementById("banRemarks").value;
    const deadlineDateString = new Date(expiryTimestamp).toLocaleDateString();

    // --- STEP D: CONFIRMATION ---
    if(confirm(`‚ö† CONFIRM BAN?\n\nUser: ${document.getElementById("banTargetName").innerText}\nReason: ${reason}\nDeadline: ${deadlineDateString}\n\nIf the user does not resolve this by the deadline, they will be permanently locked out.`)) {
        try {
            // Update User Profile
            await update(ref(db, `users/${currentBanTargetUid}`), {
                banned: true,
                banReason: reason,
                banAction: actionInst,
                banExpires: expiryTimestamp,
                banRemarks: remarks,
                banDate: serverTimestamp(),
                bannedBy: currentUser.email
            });
            
            // Log to System
            await push(ref(db, "logs"), {
                type: "USER_BAN",
                user: "System",
                details: `Banned UID: ${currentBanTargetUid}`,
                reason: `${reason} | Deadline: ${deadlineDateString}`,
                approvedBy: currentUser.email,
                time: serverTimestamp()
            });

            alert("‚úÖ User Banned Successfully.");
            closeBanModal();
            loadAdminPanel(); // Refresh list
            
        } catch(e) {
            console.error(e);
            alert("Database Error: " + e.message);
        }
    }
};
window.unbanUser = async (uid, name) => {
    if(!isAdmin) return alert("Admins Only.");
    
    if(confirm(`üü¢ Restore access for ${name}?`)) {
        try {
            // We set fields to null to DELETE them from the database
            await update(ref(db, `users/${uid}`), {
                banned: null,
                banReason: null,
                banExpires: null
            });
            alert("‚úÖ User Unbanned Successfully.");
            // Table updates automatically via listener
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
};
window.switchTab = (t) => {
    // 1. Hide all tabs
    const allTabs = ['newData', 'inventory', 'gallery', 'assigned', 'adminPanel', 'dataView', 'printReport'];
    allTabs.forEach(x => {
        const el = document.getElementById(`tab-${x}`);
        if(el) el.classList.add("hidden");
    });

    // 2. Reset Buttons
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

    // 3. Show Target
    const target = document.getElementById(`tab-${t}`);
    if(target) target.classList.remove("hidden");

    // 4. Highlight Button
    let btnId = '';
    if (t === 'newData') btnId = 'btnNew';
    else if (t === 'inventory') btnId = 'btnInventory';
    else if (t === 'gallery') btnId = 'btnGallery';
    else if (t === 'assigned') btnId = 'btnAssign';
    else if (t === 'adminPanel') btnId = 'btnAdmin';
    else if (t === 'dataView') btnId = 'btnDataView'; 
    else if (t === 'printReport') btnId = 'btnPrintReport';

    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add("active");

    // 5. AUTO-LOADS
    if(t === 'adminPanel' && isAdmin) loadAdminPanel();
    if(t === 'gallery') loadGallery();
    if(t === 'inventory') loadInventory();
    
    // 6. FORCE HIDE LOG TABLE
    if(t === 'dataView') {
        document.getElementById("logResultsPanel").classList.add("hidden");
        document.getElementById("logLineSelect").value = "";
        const stnSel = document.getElementById("logStationSelect");
        stnSel.innerHTML = "<option value=''>-- Select Line First --</option>";
        stnSel.disabled = true;
    }
};
window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
    const div = document.getElementById("galleryContainer");
    div.innerHTML = "<p>Loading...</p>";

    onValue(ref(db, "history"), snap => {
        div.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            if(v.fileData) {
                let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
                if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
                else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
                
                let controls = `<br><small style="color:grey;">(View Only)</small>`;
                if(isAdmin) {
                    controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:var(--metro-blue); color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
                }
                div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
            }
        });
        if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
    });
}

window.removeFile = (k) => {
    if(confirm("Remove attached file?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}
async function clearPreviousSession() {
    // A. Stop listening to the old station's draft
    if (draftRef) { off(draftRef); draftRef = null; }
    
    // B. Wipe Global IDs
    currentStationKey = null;
    currentRakeKey = null;

    // C. Wipe UI Inputs
    document.getElementById("inpStationLength").value = "";
    document.getElementById("inpYellowDist").value = "";
    document.getElementById("inpYellowThick").value = "";
    document.getElementById("inpRemarks").value = "";
    document.getElementById("inpImplementation").value = "";
    
    // D. Wipe Table
    document.getElementById("distanceBody").innerHTML = "";

    // E. Wipe Draft Node in Database (Prevents data crossover)
    if(currentUser) {
        await set(ref(db, `drafts/${currentUser.uid}`), null);
    }
}
function renderRow(k, v, i) {
    const b = document.getElementById("distanceBody");
    
    // Helper to check which option was previously saved
    const isSel = (val) => (v.type === val ? "selected" : "");

    b.innerHTML += `
        <tr>
            <td style="text-align:center; font-weight:bold;">${i}</td>
            
            <td>
                <input style="width:100%" value="${v.rake}" onchange="upRow('${k}','rake',this.value)" placeholder="Type _ if empty">
            </td>
            
            <td>
                <select style="width:100%; padding:5px; font-weight:bold; border:1px solid #ced4da; border-radius:3px;" onchange="upRow('${k}','type',this.value)">
                    <option value="" ${isSel("")}>-- Select Type --</option>
                    <option value="BHEL RAKE (300 SERIES)" ${isSel("BHEL RAKE (300 SERIES)")}>BHEL RAKE (300 SERIES)</option>
                    <option value="MEDHA RAKE (400 SERIES)" ${isSel("MEDHA RAKE (400 SERIES)")}>MEDHA RAKE (400 SERIES)</option>
                    <option value="DALIAN RAKE (500 SERIES)" ${isSel("DALIAN RAKE (500 SERIES)")}>DALIAN RAKE (500 SERIES)</option>
                </select>
            </td>

            <td>
                <input style="width:100%" value="${v.f}" onchange="upRow('${k}','f',this.value)" placeholder="_">
            </td>
            
            <td>
                <input style="width:100%" value="${v.r}" onchange="upRow('${k}','r',this.value)" placeholder="_">
            </td>
            
            <td style="text-align:center;">
                <button class="danger" onclick="delRow('${k}')" style="padding:5px 10px;">X</button>
            </td>
        </tr>`;
}
function loadInventory() {
    const b = document.getElementById("inventoryBody");
    const summaryEl = document.getElementById("stockSummaryText");
    
    b.innerHTML = "<tr><td colspan='8' style='text-align:center;'>Loading live stock...</td></tr>";

    onValue(ref(db, "inventory"), snap => {
        b.innerHTML = "";
        let totalItems = 0;
        let inStockCount = 0;

        if(!snap.exists()) {
             b.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No inventory found. Add items first.</td></tr>";
             if(summaryEl) summaryEl.innerText = "Total Items: 0";
             return;
        }

        snap.forEach(c => {
            const v = c.val();
            const k = c.key;
            
            totalItems++;
            if(v.status !== "Checked Out") inStockCount++;

            // Handle "Holder" display
            let holderDisplay = "-";
            if(v.status === "Checked Out") {
                holderDisplay = `<span style="color:#b38600; font-weight:bold;">üë§ ${v.holder}</span>`;
            }

            // Handle "Status" Badge
            let statusBadge = `<span style="color:green; font-weight:bold; background:#d4edda; padding:2px 6px; border-radius:4px;">In Stock</span>`;
            if(v.status === "Checked Out") {
                statusBadge = `<span style="color:#856404; font-weight:bold; background:#fff3cd; padding:2px 6px; border-radius:4px;">üì§ Out</span>`;
            }

            // Handle Defaults
            const addedBy = v.addedBy || "Unknown";
            const usage = v.usageCount || 0;
            const barcode = v.barcode || "--";
            
            let locDisplay = v.location || "Not Set";
            if(v.status === "Checked Out") locDisplay = "üì§ (Checked Out)";

            const row = `
            <tr class="stock-row">
                <td style="font-family:monospace; color:var(--metro-blue); font-weight:bold;">${barcode}</td>
                <td class="search-name">${v.item}</td>
                <td style="font-size:12px; color:#555;">${addedBy}</td>
                <td style="text-align:center; font-weight:bold;">${usage}</td>
                <td>${holderDisplay}</td>
                <td style="font-size:12px; font-weight:bold; color:var(--metro-blue);">${locDisplay}</td> <td>${statusBadge}</td>
                <td>
                    ${isAdmin ? `<button class="danger" onclick="delInv('${k}')" style="padding:2px 5px; font-size:10px;">Remove</button>` : ''}
                </td>
            </tr>`;
            
            b.innerHTML += row;
        });

        if(summaryEl) {
            summaryEl.innerHTML = `Total Items: ${totalItems} | <span style="color:green;">Available: ${inStockCount}</span>`;
        }
    });
}

window.addUniqueItem = async () => {
    // 1. Get Basic Data
    const item = document.getElementById("invName").value;
    const cond = document.getElementById("invCondition").value;
    const barcode = document.getElementById("invBarcode").value;

    if(!item || !barcode) return alert("Product Name and Barcode are required.");

    // 2. Get Location Data
    const locSelect = document.getElementById("addLocSelect");
    const locOther = document.getElementById("addLocOther");
    const locSpot = document.getElementById("addLocSpot");

    if(!locSelect || !locSpot) {
        return alert("Error: Location inputs not found in HTML. Please check code.");
    }

    let mainPlace = locSelect.value;
    
    if(mainPlace === "Other") {
        const otherText = locOther.value.trim();
        if(!otherText) return alert("Please specify the 'Other' location name.");
        mainPlace = otherText;
    }

    const spotText = locSpot.value.trim();
    if(!spotText) return alert("Please specify the Exact Spot (e.g., Cabinet, Almirah).");

    const finalLocation = `${mainPlace} [${spotText}]`;

    // 4. Check Uniqueness
    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(barcode));
    const snap = await get(q);

    if(snap.exists()) return alert("CRITICAL ERROR: Barcode already exists.");

    // 5. Save to Inventory
    await push(ref(db, "inventory"), {
        barcode: barcode,
        item: item,
        condition: cond,
        status: "In Stock",
        holder: "Store",
        location: finalLocation, 
        usageCount: 0, 
        addedBy: currentUser.name || currentUser.email, 
        dateAdded: serverTimestamp()
    });

    // 6. Log the Action
    await push(ref(db, "logs"), {
        type: "STOCK_ADD",
        item: item,
        barcode: barcode,
        qty: 1,
        location: finalLocation,
        takenBy: currentUser.name,
        approvedBy: "Self",
        time: serverTimestamp()
    });

    alert("‚úÖ Item Added to: " + finalLocation);
    
    // 7. Reset Form
    document.getElementById("invBarcode").value = "";
    document.getElementById("invName").value = "";
    document.getElementById("addLocOther").value = "";
    document.getElementById("addLocSpot").value = "";
    document.getElementById("addLocSelect").value = "D2 Building - Heerok Sir Lab"; 
    document.getElementById("divAddOtherLoc").classList.add("hidden");
    
    document.getElementById("invBarcode").focus();
};

window.filterStockTable = () => {
    const input = document.getElementById("mainStockSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("stock-row");

    Array.from(rows).forEach(row => {
        const barcode = row.cells[0].innerText.toLowerCase();
        const name = row.cells[1].innerText.toLowerCase();
        const holder = row.cells[3].innerText.toLowerCase();

        if (name.includes(input) || barcode.includes(input) || holder.includes(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};

window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #d97706";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')" class="success">Mark Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });
window.debugConnection = async () => {
    try {
        console.log("Testing DB Connection...");
        const testRef = ref(db, ".info/connected");
        const snap = await get(testRef);
        if(snap.val() === true) {
            alert("‚úÖ Database Connected Successfully!");
        } else {
            alert("‚ùå Database Offline. Check Internet.");
        }
    } catch (e) {
        alert("CRITICAL ERROR: " + e.message);
    }
};
// Run automatically on load
setTimeout(debugConnection, 3000);
</script>
</body>
</html>
