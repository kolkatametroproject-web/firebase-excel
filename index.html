<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- OFFICIAL METRO THEME (PRESERVED) --- */
:root {
Â  --metro-blue: #003366;
Â  --metro-gold: #b38600;
Â  --metro-red: #e31e24;
Â  --bg-color: #f4f6f9;
Â  --panel-bg: #ffffff;
Â  --text-main: #212529;
Â  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
Â  background: var(--metro-blue);
Â  color: white;
Â  padding: 15px 25px;
Â  border-bottom: 4px solid #b38600;
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  position: relative; z-index: 1001;
Â  flex-wrap: wrap; /* Mobile friendly */
}

/* BUTTONS */
button {
Â  padding: 8px 16px;
Â  cursor: pointer;
Â  background: #0056b3;
Â  color: white;
Â  border: 1px solid #004494;
Â  border-radius: 3px;
Â  font-weight: bold;
Â  font-size: 13px;
Â  transition: all 0.2s;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; opacity: 0.7; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button.info { background: #17a2b8; border-color: #117a8b; color: white; }
button.secondary { background: #6c757d; border-color: #545b62; color: white; }

/* INPUTS */
input, select, textarea {
Â  background: #fff;
Â  border: 1px solid #ced4da;
Â  color: #495057;
Â  padding: 8px;
Â  border-radius: 3px;
Â  width: 100%;
Â  box-sizing: border-box;
Â  margin-bottom: 10px;
Â  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
Â  background: var(--panel-bg);
Â  padding: 25px;
Â  border: 1px solid var(--border-color);
Â  border-radius: 4px;
Â  margin-bottom: 20px;
Â  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; white-space: nowrap; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES (UPDATED FOR GOVT STYLE + MOBILE RESPONSIVE) */
.table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; min-width: 600px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; padding: 20px; box-sizing: border-box; }

/* NEW HIGH PERFORMANCE CAMERA UI */
#videoContainer {
Â  Â  position: relative;
Â  Â  width: 320px;
Â  Â  max-width: 100%;
Â  Â  height: 240px;
Â  Â  background: #000;
Â  Â  margin-bottom: 15px;
Â  Â  border: 5px solid white;
Â  Â  box-shadow: 0 0 20px rgba(0,255,0,0.2);
}
#cameraFeed {
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  object-fit: cover;
Â  Â  transform: scaleX(-1); /* Mirror effect */
}
#overlayCanvas {
Â  Â  position: absolute;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  z-index: 10;
Â  Â  transform: scaleX(-1); /* Mirror overlay to match video */
}

/* UPLOAD SECTION SPECIFIC */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* CHECKBOX LIST FOR ADMIN */
.checkbox-list {
Â  Â  max-height: 200px;
Â  Â  overflow-y: scroll;
Â  Â  border: 1px solid #ced4da;
Â  Â  padding: 10px;
Â  Â  background: #fff;
Â  Â  text-align: left;
}
.checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; }
.checkbox-item input { width: auto; margin-right: 10px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #555; border: 2px solid #888; }
.dot.active { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 5px #00ff00; }

/* STATUS BADGES */
.badge-online { background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.badge-offline { background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }

/* SIGNATURE CANVAS */
canvas.sig-canvas { border: 2px solid #003366; background: #fff; cursor: crosshair; touch-action: none; border-radius: 4px; display:block; max-width: 100%; }

/* NEW: BARCODE MODAL STYLES */
#reader { width: 300px; max-width: 100%; background:white; padding:10px; border-radius:4px; }

/* MOBILE RESPONSIVE TWEAKS */
@media (max-width: 600px) {
Â  Â  header { flex-direction: column; align-items: flex-start; gap: 10px; }
Â  Â  #authContainer { margin-top: 10px; align-self: flex-start; }
Â  Â  .panel { padding: 15px; }
Â  Â  #videoContainer { width: 100%; height: auto; aspect-ratio: 4/3; }
Â  Â  .nav-bar { padding-bottom: 15px; }
Â  Â  .nav-btn { font-size: 12px; padding: 6px 10px; }
Â  Â  .gallery-grid { grid-template-columns: repeat(2, 1fr); }
Â  Â  #otpUI { width: 90%; }
}
@keyframes blink {
Â  0% { opacity: 1; }
Â  50% { opacity: 0.6; }
Â  100% { opacity: 1; }
}
/* TIMELINE CARD STYLES */
.history-card {
Â  Â  background: white;
Â  Â  border-left: 5px solid #ccc; /* Default color */
Â  Â  padding: 12px;
Â  Â  margin-bottom: 10px;
Â  Â  border-radius: 4px;
Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
Â  Â  position: relative;
}
/* --- BANNED SCREEN OVERLAY --- */
.banned-overlay {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background: #721c24; /* Dark Red */
Â  Â  color: white;
Â  Â  z-index: 9999; /* On top of everything */
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  text-align: center;
Â  Â  padding: 20px;
Â  Â  box-sizing: border-box;
}

.banned-card {
Â  Â  background: white;
Â  Â  color: #333;
Â  Â  padding: 30px;
Â  Â  border-radius: 8px;
Â  Â  max-width: 500px;
Â  Â  box-shadow: 0 0 50px rgba(0,0,0,0.5);
Â  Â  border: 5px solid #bd2130;
}

.banned-timer {
Â  Â  font-size: 24px;
Â  Â  font-weight: bold;
Â  Â  color: #dc3545;
Â  Â  margin: 15px 0;
Â  Â  font-family: monospace;
}

/* ADMIN BAN MODAL */
..ban-btn-select {
Â  Â  flex: 1;
Â  Â  padding: 12px;
Â  Â  background: #f8f9fa; /* Light Grey */
Â  Â  color: #333 !important; /* FORCE DARK TEXT */
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 4px;
Â  Â  cursor: pointer;
Â  Â  font-weight: bold;
Â  Â  transition: all 0.2s;
}
.ban-btn-select:hover { background: #e2e6ea; }
.ban-btn-select.selected {
Â  Â  background: #dc3545; /* Red background when selected */
Â  Â  color: white !important; /* White text when selected */
Â  Â  border-color: #bd2130;
}
/* New Inputs Styling */
.ban-input {
Â  Â  width: 100%;
Â  Â  padding: 10px;
Â  Â  margin-bottom: 10px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 4px;
Â  Â  box-sizing: border-box;
}
Â  /* --- BANNED SCREEN BUTTON GRID --- */
.banned-action-grid {
Â  Â  display: flex;
Â  Â  gap: 15px;
Â  Â  margin-top: 25px;
}
.banned-btn {
Â  Â  flex: 1;
Â  Â  padding: 15px;
Â  Â  font-size: 14px;
Â  Â  font-weight: bold;
Â  Â  border: none;
Â  Â  border-radius: 5px;
Â  Â  cursor: pointer;
Â  Â  text-transform: uppercase;
}
.btn-retry {
Â  Â  background: #0056b3;
Â  Â  color: white;
Â  Â  border: 1px solid #004494;
}
.btn-retry:hover { background: #004494; }

.btn-logout {
Â  Â  background: #dc3545;
Â  Â  color: white;
Â  Â  border: 1px solid #bd2130;
}
select:disabled {
Â  Â  background-color: #e9ecef;
Â  Â  color: #6c757d;
Â  Â  cursor: not-allowed;
Â  Â  border-color: #ced4da;
}
.btn-logout:hover { background: #c82333; }
.history-card.checkout { border-left-color: #b38600; } /* Yellow for OUT */
.history-card.return { border-left-color: #17a2b8; }Â  Â /* Blue for IN */
.history-card.add { border-left-color: #28a745; }Â  Â  Â  /* Green for ADD */

.hc-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
.hc-user { font-size: 14px; font-weight: bold; color: #333; }
.hc-meta { font-size: 11px; color: #666; margin-top: 4px; }
.hc-sig { position: absolute; right: 10px; bottom: 10px; }
/* --- FULL PRINT CSS (LARGE FONTS) --- */
@media print {
Â  Â  /* 1. Reset Global Visibility */
Â  Â  body {
Â  Â  Â  Â  visibility: hidden;
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  }

Â  Â  /* 2. Show Only Report Container */
Â  Â  #printableReportContainer {
Â  Â  Â  Â  visibility: visible;
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  z-index: 9999;
Â  Â  Â  Â  background: white;
Â  Â  }
Â  Â Â 
Â  Â  #printableReportContainer * {
Â  Â  Â  Â  visibility: visible;
Â  Â  }

Â  Â  .no-print { display: none !important; }

Â  Â  /* ============================
Â  Â  Â  Â MODE A: A4 PAPER (LARGE)
Â  Â  Â  Â ============================ */
Â  Â  body.print-a4 .report-paper {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 20px 40px; /* Reduced top padding, kept side padding */
Â  Â  Â  Â  font-family: 'Times New Roman', serif;
Â  Â  Â  Â  color: black;
Â  Â  }

Â  Â  /* HEADING: 20pt */
Â  Â  body.print-a4 .report-header h2 {Â 
Â  Â  Â  Â  font-size: 24pt !important; /* Made even larger for A4 title */
Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  }

Â  Â  /* META INFO: 14pt */
Â  Â  body.print-a4 .report-meta {
Â  Â  Â  Â  font-size: 14pt !important;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  line-height: 1.5;
Â  Â  }

Â  Â  /* SUB-HEADING: 18pt */
Â  Â  body.print-a4 .report-section-title {
Â  Â  Â  Â  font-size: 18pt !important;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  background: #eee !important;
Â  Â  Â  Â  border: 2px solid #000;
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  margin-top: 25px;
Â  Â  Â  Â  -webkit-print-color-adjust: exact;
Â  Â  }

Â  Â  /* TABLE TEXT: 14pt MINIMUM */
Â  Â  body.print-a4 .report-table th,Â 
Â  Â  body.print-a4 .report-table td {
Â  Â  Â  Â  font-size: 15pt !important; /* 15pt for clarity */
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border: 2px solid black; /* Thicker border */
Â  Â  }

Â  Â  /* SIGNATURES: 14pt */
Â  Â  body.print-a4 .report-footer div,
Â  Â  body.print-a4 .report-footer small {
Â  Â  Â  Â  font-size: 14pt !important;
Â  Â  }

Â  Â  /* ============================
Â  Â  Â  Â MODE B: POS (RECEIPT) (LARGE)
Â  Â  Â  Â ============================ */
Â  Â  body.print-pos .report-paper {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  font-family: 'Courier New', monospace; /* Monospace is best for receipts */
Â  Â  Â  Â  color: black;
Â  Â  }

Â  Â  /* POS HEADING: 20pt */
Â  Â  body.print-pos .report-header h2 {Â 
Â  Â  Â  Â  font-size: 20pt !important;Â 
Â  Â  Â  Â  line-height: 1.1;Â 
Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  font-weight: 900;
Â  Â  Â  Â  border-bottom: 3px solid black;
Â  Â  Â  Â  padding-bottom: 5px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â Â 
Â  Â  /* POS META: 14pt */
Â  Â  body.print-pos .report-meta {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  font-size: 14pt !important;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  border-bottom: 2px dashed black;
Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  body.print-pos .report-meta div {
Â  Â  Â  Â  text-align: left !important;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }

Â  Â  /* POS SUB-HEADING: 18pt */
Â  Â  body.print-pos .report-section-title {
Â  Â  Â  Â  font-size: 18pt !important;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  border-bottom: 2px solid black;
Â  Â  Â  Â  margin: 15px 0 5px 0;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  }

Â  Â  /* POS TABLE: 14pt */
Â  Â  body.print-pos .report-table {
Â  Â  Â  Â  width: 100%;
Â  Â  }
Â  Â Â 
Â  Â  body.print-pos .report-table th {
Â  Â  Â  Â  font-size: 14pt !important;
Â  Â  Â  Â  border-bottom: 2px solid black;
Â  Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  body.print-pos .report-table td {
Â  Â  Â  Â  font-size: 14pt !important;
Â  Â  Â  Â  border-bottom: 1px dashed #333;
Â  Â  Â  Â  padding: 8px 2px;
Â  Â  Â  Â  word-wrap: break-word; /* Ensures large text wraps on narrow paper */
Â  Â  }

Â  Â  /* POS FOOTER */
Â  Â  body.print-pos .report-footer {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  margin-top: 30px;
Â  Â  }
Â  Â  body.print-pos .report-footer > div {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-bottom: 40px;
Â  Â  Â  Â  font-size: 14pt !important;
Â  Â  }
}
/* Report Preview Styling (On Screen) */
.report-paper {
Â  Â  background: white;
Â  Â  padding: 40px;
Â  Â  border: 1px solid #ccc;
Â  Â  box-shadow: 0 0 15px rgba(0,0,0,0.1);
Â  Â  max-width: 800px;
Â  Â  margin: 20px auto;
Â  Â  font-family: 'Times New Roman', serif;
Â  Â  color: #000;
}
.report-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
.report-meta { display: flex; justify-content: space-between; margin-bottom: 20px; font-family: sans-serif; font-size: 14px; }
.report-section-title { background: #eee; border: 1px solid #000; padding: 5px; font-weight: bold; font-size: 14px; margin-top: 20px; }
.report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; }
.report-table th, .report-table td { border: 1px solid #000; padding: 8px; text-align: left; }
Â  @media print {
Â  Â  /* Ensure hidden sections do not occupy space */
Â  Â  #sectionStationDetails:empty,Â 
Â  Â  #sectionRakeData:empty,
Â  Â  .hidden-section {
Â  Â  Â  Â  display: none !important;
Â  Â  }

Â  Â  /* Page break optimization */
Â  Â  .report-paper {
Â  Â  Â  Â  page-break-after: always;
Â  Â  }
Â  Â Â 
Â  Â  .report-section-title {
Â  Â  Â  Â  -webkit-print-color-adjust: exact;
Â  Â  Â  Â  margin-top: 15px !important;
Â  Â  }
}
</style>
</head>

<body>

<header>
Â  <div style="display:flex; align-items:center">
Â  Â  <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;flex-shrink:0;">M</div>
Â  Â  <div><h1 style="margin:0; line-height:1.2; font-size: 1.2rem;">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
Â  Â  <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
Â  </div>
Â  <div id="authContainer" class="hidden">
Â  Â  <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
Â  Â  <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
Â  Â  <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
Â  </div>
</header>

<section id="loginSection">
Â  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
Â  Â  <h3>Authorized Access Only</h3>
Â  Â  <input id="email" placeholder="user@metro.project">
Â  Â  <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
Â  Â  <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
Â  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:300px; max-width:90%; text-align:center;">
Â  Â  Â  Â  <h3>User Profile Setup</h3>
Â  Â  Â  Â  <p>Please enter your official name for the records.</p>
Â  Â  Â  Â  <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
Â  Â  Â  Â  <button onclick="saveOfficialName()">Save & Continue</button>
Â  Â  </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
Â  <h2 id="modalTitle" style="color:white; margin-bottom:5px; text-align:center;">Biometric Verification</h2>
Â  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px; text-align:center;">Initializing AI Models...</p>
Â 
Â  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
Â  Â  Â  <div id="dot1" class="dot"></div>
Â  Â  Â  <div id="dot2" class="dot"></div>
Â  Â  Â  <div id="dot3" class="dot"></div>
Â  </div>

Â  <div id="videoContainer">
Â  Â  <video id="cameraFeed" autoplay playsinline muted></video>
Â  Â  <canvas id="overlayCanvas"></canvas>
Â  </div>
Â <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:8px; width:300px; box-shadow: 0 0 25px rgba(0,0,0,0.5); position:absolute; z-index:3000; border: 3px solid #dc3545;">
Â  Â  <i class="fas fa-lock-alt" style="font-size: 30px; color: #dc3545;"></i>
Â  Â  <h3 style="color:#dc3545; margin:10px 0 5px 0;">Security Lockout</h3>
Â  Â  <p style="color:#333; font-size:12px; margin-bottom:15px;">Face verification failed 3 times.<br><b>Admin must enter PIN to unlock.</b></p>
Â  Â Â 
Â  Â  <input id="adminPinInput" type="password" placeholder="ADMIN PIN" style="text-align:center; font-size:20px; letter-spacing:8px; border:2px solid #333; margin-bottom:10px;">
Â  Â Â 
Â  Â  <button class="danger" onclick="verifyAdminBypass()" style="width:100%; padding:12px; font-weight:bold;">AUTHORIZE BYPASS</button>
Â  Â  <button class="secondary" onclick="logout()" style="width:100%; margin-top:10px; font-size:11px;">Cancel & Logout</button>
</div>

Â  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold; height:20px; text-align:center;"></div>
Â 
Â  <div id="camControls" style="display:flex; gap:10px;">
Â  Â  <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">ğŸ“¸ Face Scan</button>
Â  </div>
</div>

<div id="barcodeModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:340px; max-width:95%; text-align:center; background:#000; border:2px solid #b38600;">
Â  Â  Â  Â  <h3 style="color:white; margin-bottom:10px;">Scan Barcode</h3>
Â  Â  Â  Â  <div id="reader"></div>
Â  Â  Â  Â  <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:15px; width:100%;">Cancel / Close</button>
Â  Â  </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
Â  Â  <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
Â  Â  Â  Â  <h3>Digital Signature Verification</h3>
Â  Â  Â  Â  <img id="modalSigImage" src="" style="border:1px solid #000; background:white; max-width:100%; margin:10px 0;">
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <button onclick="closeSigModal()">Close</button>
Â  Â  </div>
</div>

<section id="appScreen" class="hidden">
Â 
Â  <div class="nav-bar">
Â  Â  <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
Â  Â  <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
Â  Â  <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
Â  Â  <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
Â  Â  <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
Â  Â  <button class="nav-btn" onclick="switchTab('dataView')" id="btnDataView">5.ğŸ“‹ Data Logs</button>
Â  Â  <button class="nav-btn" onclick="switchTab('printReport')" id="btnPrintReport">6. ğŸ–¨ï¸ Print Reports</button>
    <button class="nav-btn" onclick="switchTab('demoResult')" id="btnDemo">7. ğŸ§ª Demo Results</button>
Â  </div>
<div id="tab-newData">
Â  <div class="panel">
Â  Â  <h3>ğŸ†• Select Location</h3>
Â  Â  <label style="font-weight:bold; color:#003366;">Step 1: Select Metro Line</label>
Â  Â  <select id="lineSelect" onchange="handleLineChange()" style="background:#eef2f7; font-weight:bold; border:2px solid #003366;">
Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  <option value="Blue Line">Blue Line (North-South: Dakshineswar â†” New Garia)</option>
Â  Â  Â  <option value="Green Line">Green Line (East-West: Sector V â†” Howrah Maidan)</option>
Â  Â  Â  <option value="Purple Line">Purple Line (Joka â†” Majerhat)</option>
Â  Â  Â  <option value="Yellow Line">Yellow Line (Noapara â†” Airport)</option>
Â  Â  Â  <option value="Orange Line">Orange Line (New Garia â†” Airport)</option>
Â  Â  Â  <option value="Pink Line">Pink Line (Baranagar â†” Barrackpore)</option>
Â  Â  </select>

Â  Â  <label style="font-weight:bold; color:#003366; margin-top:10px; display:block;">Step 2: Select Station</label>
Â  Â  <select id="stationSelect" onchange="handleStationChange()" disabled style="background:#e9ecef;">
Â  Â  Â  <option value="">-- First Select a Line --</option>
Â  Â  </select>
Â  </div>

Â  <div id="mainDataForm" class="hidden">
Â  Â Â 
Â  Â  <div id="dataExistsWarning" class="hidden" style="background:#fff3cd; color:#856404; padding:15px; border:1px solid #ffeeba; border-radius:4px; margin-bottom:15px;">
Â  Â  Â  Â  <strong>âš ï¸ Data Already Exists!</strong><br>
Â  Â  Â  Â  Measurement data for this station has already been recorded.Â 
Â  Â  Â  Â  <br>You cannot enter "Yellow Line" data again unless an Admin deletes the existing log.
Â  Â  </div>

Â  Â  <div class="panel" id="stationDetailsPanel" style="border-top: 5px solid #28a745;">
Â  Â  Â  <h3 id="formTitle">ğŸ“ 1. Yellow Line Measurement</h3>
Â  Â  Â  <input id="inpStationName" type="hidden">Â 
Â  Â  Â Â 
Â  Â  Â  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Station Length (m)</label>
Â  Â  Â  Â  Â  Â  <input id="inpStationLength" placeholder="e.g. 180">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Yellow Line Dist (cm)</label>
Â  Â  Â  Â  Â  Â  <input id="inpYellowDist" placeholder="e.g. 85">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">YL Thickness (cm)</label>
Â  Â  Â  Â  Â  Â  <input id="inpYellowThick" placeholder="e.g. 10">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#003366;">System Implementable?</label>
Â  Â  Â  Â  Â  Â  <select id="inpImplementation" style="font-weight:bold; border:2px solid #003366;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select --</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="YES">âœ… YES</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="NO">âŒ NO</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
Â  Â  Â Â 
Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  <button class="success" id="btnSaveDraft" onclick="saveStationDetails()">ğŸ’¾ Save Draft</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â <div class="panel">
Â  Â  <h4>ğŸ“ 2. Distance Data (Rakes)</h4>
Â  Â Â 
Â  Â  <div class="table-wrapper" style="margin-top:10px;">
Â  Â  Â  Â  <table style="width:100%">
Â  Â  Â  Â  Â  Â  <thead style="background:#e9ecef;">
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:50px; text-align:center;">SL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rake No (Input)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rake Type</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Front (mm)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rear (mm)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center;">Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="distanceBody">
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <div style="margin-top:10px; display:flex; justify-content:space-between;">
Â  Â  Â  Â  <button class="primary" onclick="addDistanceRow()">+ Add Row</button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button onclick="submitStationData()" id="btnFinalSubmit" style="background:#003366;">
Â  Â  Â  Â  Â  Â  âœ” Submit Final Data
Â  Â  Â  Â  </button>
Â  Â  </div>
</div>

Â  </div>Â 
</div>
Â  <div id="tab-inventory" class="hidden">
Â  Â Â 
Â  Â  <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
Â  Â  Â  Â  <button onclick="toggleInvMode('list')" class="primary">ğŸ“¦ View Stock</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('add')" class="success">â• Add New Item</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('checkout')" class="warning">ğŸ“¤ Checkout</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('return')" class="info">ğŸ“¥ Return Item</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('history')" class="secondary">ğŸ“œ Audit Trail</button>
Â  Â  </div>
<div id="inv-add" class="panel hidden" style="background:#f8f9fa;">
Â  Â  <h3 style="color:#003366;">Add Unique Item (Serialize)</h3>
Â  Â  <p style="font-size:12px; color:#666;">
Â  Â  Â  Â  <strong>Strict Rule:</strong> Every physical item must have a unique barcode.<br>
Â  Â  Â  Â  If you have 5 drills, scan each one separately.
Â  Â  </p>
Â  Â  Â Â 
Â  Â  <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px;">
Â  Â  Â  Â  <div style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  <input id="invBarcode" placeholder="Scan Unique Barcode" onchange="checkBarcodeUnique(this.value)">
Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('ADD')" class="info" style="width:60px; padding:0;"><i class="fas fa-qrcode"></i></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input id="invName" placeholder="Product Name (e.g. Drill Machine)">
Â  Â  </div>
Â  Â  Â Â 
Â  Â  <div id="barcodeError" class="hidden" style="background:#f8d7da; color:#721c24; padding:10px; border-radius:4px; margin-bottom:10px;">
Â  Â  Â  Â  âŒ <strong>Error:</strong> This barcode already exists! You cannot add duplicates.
Â  Â  </div>

Â  Â  <div style="text-align:left; background:white; padding:10px; border:1px solid #ced4da; border-radius:5px; margin-bottom:15px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <label style="font-size:12px; font-weight:bold; color:#003366;">ğŸ“ Storage Location:</label>
Â  Â  Â  Â  <select id="addLocSelect" onchange="toggleAddOtherInput()" style="margin-bottom:10px; border:1px solid #003366;">
Â  Â  Â  Â  Â  Â  <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
Â  Â  Â  Â  Â  Â  <option value="Other">Other (Specify...)</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div id="divAddOtherLoc" class="hidden">
Â  Â  Â  Â  Â  Â  <input id="addLocOther" placeholder="âœ Specify Place (e.g. Main Office, Store Room)" style="border:1px dashed #003366; background:#f0f8ff;">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="font-size:12px; font-weight:bold; color:#003366;">ğŸ—„ï¸ Exact Spot (Cabinet/Almirah):</label>
Â  Â  Â  Â  <input id="addLocSpot" placeholder="e.g. Upper Cabinet, Blue Almirah, Rack 3" style="border:1px solid #003366;">
Â  Â  </div>

Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
Â  Â  Â  Â  <select id="invCondition">
Â  Â  Â  Â  Â  Â  <option value="New">New</option>
Â  Â  Â  Â  Â  Â  <option value="Good" selected>Good</option>
Â  Â  Â  Â  Â  Â  <option value="Fair">Fair</option>
Â  Â  Â  Â  Â  Â  <option value="Damaged">Damaged</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button id="btnAddStock" onclick="addUniqueItem()" class="success">Save Item to Stock</button>
Â  Â  </div>
</div>
Â  Â  <div id="inv-checkout" class="panel hidden" style="border: 2px solid #b38600;">
Â  Â  <h3 style="color:#b38600;">ğŸ“¤ Checkout Item</h3>
Â  Â  <p style="text-align:center; color:#666; font-size:12px;">Scan a unique barcode to check it out.</p>
Â  Â Â 
Â  Â  <div style="text-align:center; padding:20px;">
Â  Â  Â  Â  <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:16px; padding:15px 30px; width:100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i> SCAN ITEM BARCODE
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="checkout_display" class="hidden" style="background:#fff3cd; padding:15px; border:1px solid #ffeeba; text-align:center; margin-top:10px; border-radius:4px;">
Â  Â  Â  Â  <h2 id="checkout_item_name" style="color:#856404; margin:10px 0 5px 0;">--</h2>
Â  Â  Â  Â  <div style="font-family:monospace; font-size:14px; color:#555; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Barcode: <span id="checkout_item_code" style="font-weight:bold;">--</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input id="checkoutPurpose" placeholder="Enter Purpose (e.g. Project Testing, Circuit Repair)" style="border: 2px solid #b38600;">

Â  Â  Â  Â  <div id="btn_checkout_verify">
Â  Â  Â  Â  Â  Â  Â <button onclick="submitTransactionNoFace('CHECKOUT')" style="background:#b38600; color:white; padding:12px 20px; width:100%; font-weight:bold; border:none; border-radius:4px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  âœ” Confirm Checkout
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="inv-return" class="panel hidden" style="border: 2px solid #17a2b8;">
Â  Â  <h3 style="color:#17a2b8;">ğŸ“¥ Return Item</h3>
Â  Â  <p style="text-align:center; color:#666; font-size:12px;">Scan an item to return it to the store.</p>
Â  Â Â 
Â  Â  <div style="text-align:center; padding:20px;">
Â  Â  Â  Â  <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:16px; padding:15px 30px; width:100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i> SCAN ITEM TO RETURN
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="return_display" class="hidden" style="background:#d1ecf1; padding:15px; border:1px solid #bee5eb; text-align:center; margin-top:10px; border-radius:4px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h2 id="return_item_name" style="color:#0c5460; margin:10px 0 5px 0;">--</h2>
Â  Â  Â  Â  <div style="font-family:monospace; font-size:14px; color:#555; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Barcode: <span id="return_item_code" style="font-weight:bold;">--</span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:left; background:rgba(255,255,255,0.6); padding:10px; border-radius:5px;">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label style="font-size:12px; font-weight:bold; color:#0c5460;">ğŸ“ Where are you returning it?</label>
Â  Â  Â  Â  Â  Â  <select id="returnLocSelect" onchange="toggleOtherInput()" style="margin-bottom:10px; border:1px solid #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other (Specify...)</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <div id="divOtherLoc" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="returnLocOther" placeholder="âœ Specify Place (e.g. Main Office, Store Room)" style="border:1px dashed #17a2b8; background:#fff;">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label style="font-size:12px; font-weight:bold; color:#0c5460;">ğŸ—„ï¸ Exact Spot (Cabinet/Almirah):</label>
Â  Â  Â  Â  Â  Â  <input id="returnLocSpot" placeholder="e.g. Upper Cabinet, Blue Almirah, Rack 3" style="border:1px solid #17a2b8;">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="btn_return_verify" style="margin-top:15px;">
Â  Â  Â  Â  Â  Â  Â <button onclick="submitTransactionNoFace('RETURN')" style="background:#17a2b8; color:white; padding:12px 20px; width:100%; font-weight:bold; border:none; border-radius:4px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  âœ” Confirm Return
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="inv-history" class="panel hidden">
Â  Â  <div style="text-align:center; padding:40px 20px;">
Â  Â  Â  Â  <h2 style="color:#003366; margin-bottom:10px;">ğŸ” Item Audit Trail</h2>
Â  Â  Â  Â  <p style="color:#666; margin-bottom:20px;">Scan a barcode to open the history window.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="max-width:400px; margin:0 auto; display:flex; gap:10px;">
Â  Â  Â  Â  Â  Â  <inputÂ 
Â  Â  Â  Â  Â  Â  Â  Â  id="auditSearchInput"Â 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Scan or Enter Barcode..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="padding:12px; font-size:16px; border:2px solid #003366; border-radius:5px; flex-grow:1;"
Â  Â  Â  Â  Â  Â  Â  Â  onchange="fetchAuditHistory(this.value)"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  onclick="openBarcodeScanner('AUDIT_SEARCH')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="warning"Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="padding:12px 20px; font-size:18px;"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  </div>

<div id="auditResultModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:400px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; background:#f4f6f9;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background:#003366; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin:0; font-size:16px; border:none; color:white;">ğŸ“¦ Item Lifecycle</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <small id="auditModalBarcode" style="opacity:0.8; font-family:monospace;">--</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="auditTimelineContainer" style="overflow-y:auto; padding:15px; flex-grow:1;">
Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:#777;">Loading data...</div>
Â  Â  Â  Â  </div>

Â  Â  </div>
</div>
<div id="auditResultModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:400px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background:#003366; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin:0; font-size:16px; border:none; color:white;">ğŸ“¦ Item History</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <small id="auditModalBarcode" style="opacity:0.8;">--</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:20px;">âœ•</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="auditTimelineContainer" style="overflow-y:auto; padding:15px; background:#f4f6f9; flex-grow:1;">
Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:#777;">Loading data...</div>
Â  Â  Â  Â  </div>

Â  Â  </div>
</div>
Â  Â  <div id="inv-list" class="panel">
Â  Â  <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #003366; padding-bottom:10px; margin-bottom:10px;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h3 style="margin:0;">Current Stock</h3>
Â  Â  Â  Â  Â  Â  <small id="stockSummaryText" style="color:#003366; font-weight:bold;">Loading...</small>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  <input type="text" id="mainStockSearch" onkeyup="filterStockTable()" placeholder="ğŸ” Search Product or Barcode..." style="width:200px; margin:0;">
Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('SEARCH_STOCK')" class="info" style="padding:5px 10px;" title="Scan to Search">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="table-wrapper" style="max-height:600px; overflow-y:auto;">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead style="position:sticky; top:0; background:#e9ecef;">
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Barcode</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Product</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Added By</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Usage</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Current Holder</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Location / Place</th> <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="inventoryBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>
Â  </div>
<div id="tab-gallery" class="hidden">
Â Â 
Â  <div class="panel">
Â  Â  <h3>ğŸ“‚ Evidence Management</h3>
Â  Â Â 
Â  Â  <label style="font-weight:bold; color:#003366;">Step 1: Select Metro Line</label>
Â  Â  <select id="galleryLineSelect" onchange="handleGalleryLineChange()" style="background:#eef2f7; font-weight:bold; border:2px solid #003366;">
Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  <option value="Blue Line">Blue Line (North-South: Dakshineswar â†” New Garia)</option>
Â  Â  Â  <option value="Green Line">Green Line (East-West: Sector V â†” Howrah Maidan)</option>
Â  Â  Â  <option value="Purple Line">Purple Line (Joka â†” Majerhat)</option>
Â  Â  Â  <option value="Yellow Line">Yellow Line (Noapara â†” Airport)</option>
Â  Â  Â  <option value="Orange Line">Orange Line (New Garia â†” Airport)</option>
Â  Â  Â  <option value="Pink Line">Pink Line (Baranagar â†” Barrackpore)</option>
Â  Â  </select>

Â  Â  <label style="font-weight:bold; color:#003366; margin-top:10px; display:block;">Step 2: Select Station</label>
Â  Â  <select id="galleryStationSelect" onchange="handleGalleryStationChange()" disabled style="background:#e9ecef;">
Â  Â  Â  <option value="">-- First Select a Line --</option>
Â  Â  </select>
Â  </div>

Â  <div id="galleryUploadSection" class="hidden">
Â  Â  Â  <div class="panel upload-panel" style="border: 2px dashed #003366; background: #eef2f7;">
Â  Â  Â  Â  <h3 style="color:#003366; margin-top:0;">ğŸ“ Upload Evidence</h3>
Â  Â  Â  Â  <p id="uploadTargetText" style="font-weight:bold; color:#28a745;">Target: None</p>
Â  Â  Â  Â  <p style="font-size:12px; color:#666;">Select file (Image/PDF/Video)</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
Â  Â  Â  Â  <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button class="warning" onclick="uploadEvidenceOnly()">â¬† Upload to Selected Station</button>
Â  Â  Â  Â  <div style="margin-top:5px;"><small style="color:red;">* Max 1.5 MB per file</small></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>ğŸ“ Evidence Repository</h3>
Â  Â  Â  Â  <div id="galleryContainer" class="gallery-grid"></div>
Â  Â  Â  </div>
Â  </div>

</div>

Â  <div id="tab-assigned" class="hidden">
Â  Â  <div class="panel"><h3>ğŸ“‹ My Assigned Tasks</h3><div id="taskList"></div></div>
Â  </div>

Â  <div id="tab-adminPanel" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  <h3>ğŸ›¡ï¸ Administrator Console</h3>
Â  Â  Â  Â  <button onclick="loadAdminPanel()" class="primary">ğŸ”„ Refresh</button>
Â  Â  Â  </div>

Â  Â  Â  <h4 style="background:#eee; padding:5px;">1. User Status & Permissions</h4>
Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Name (User)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Online Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Task Summary (Live)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Biometric Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Admin Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="userListBody"></tbody>
Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â 
Â  Â  Â  <h4 style="background:#eee; padding:5px;">2. Assign Work</h4>
Â  Â  Â  <label>Select Students/Users:</label>
Â  Â  Â  <div id="userCheckboxList" class="checkbox-list"></div>
Â  Â  Â  <div style="margin-top:15px;">
Â  Â  Â  Â  <textarea id="taskDesc" rows="1" placeholder="Enter Task Details..."></textarea>
Â  Â  Â  Â  <button onclick="assignTaskMulti()" style="width:100%; margin-top:5px;">Assign to Selected Users</button>
</div>Â 
Â <div id="adminTaskModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #003366; padding-bottom:10px; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:#003366;">ğŸ“‹ Task Tracking: <span id="modalTaskUserName">User</span></h3>
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeTaskModal()" style="padding:5px 10px;">Close X</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="overflow-y:auto; flex-grow:1;">
Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background:#003366; color:white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Task Description</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Assigned By</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="adminTaskBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="5" style="text-align:center;">Loading tasks...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
Â  Â  </div>
Â  </div>
<div id="bannedScreen" class="banned-overlay hidden">
Â  Â  <div class="banned-card">
Â  Â  Â  Â  <h1 style="color:#bd2130; margin:0;">ACCESS DENIED</h1>
Â  Â  Â  Â  <p style="color:#666;">Your account has been suspended.</p>
Â  Â  Â  Â  <hr>
Â  Â  Â  Â  <div id="displayBanReason" style="font-weight:bold; margin:10px 0;">--</div>
Â  Â  Â  Â  <div id="bannedTimeDisplay" class="banned-timer" style="background:#000; color:white; padding:5px;">--</div>
Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-top:20px;">
Â  Â  Â  Â  Â  Â  <button onclick="logout()" style="flex:1; background:#dc3545; color:white; padding:12px; border:none; cursor:pointer;">ğŸšª Force Log Out</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="adminBanModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:500px; max-width:95%; border-top: 5px solid #dc3545;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  <h3 style="color:#dc3545; margin:0;">ğŸš« Ban / Suspend User</h3>
Â  Â  Â  Â  Â  Â  <button onclick="closeBanModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p style="background:#f8d7da; padding:10px; border-radius:4px; color:#721c24; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Target: <strong id="banTargetName" style="font-size:16px;">User</strong>
Â  Â  Â  Â  </p>

Â  Â  Â  Â  <label style="font-weight:bold; display:block;">1. Select Reason:</label>
Â  Â  Â  Â  <select id="banReasonInput" class="ban-input" onchange="toggleBanOtherInput()">
Â  Â  Â  Â  Â  Â  <option value="Misconduct">Misconduct / Behavior</option>
Â  Â  Â  Â  Â  Â  <option value="Security Violation">Security Violation</option>
Â  Â  Â  Â  Â  Â  <option value="Asset Damage">Asset Damage / Theft</option>
Â  Â  Â  Â  Â  Â  <option value="Attendance">Attendance Irregularity</option> <option value="Pending Investigation">Pending Investigation</option>
Â  Â  Â  Â  Â  Â  <option value="Other">Other (Specify below)</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div id="divBanOther" class="hidden">
Â  Â  Â  Â  Â  Â  <input id="banReasonOther" class="ban-input" placeholder="âœ Specify the reason here..." style="border-left: 4px solid #dc3545;">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; margin-top:5px;">2. Action Required (How to Dispose):</label>
Â  Â  Â  Â  <input id="banActionInput" class="ban-input" placeholder="E.g. Meet HR Dept, Submit Written Apology, Pay Fine..." style="border:1px solid #003366;">

Â  Â  Â  Â  <label style="font-weight:bold; display:block; margin-top:5px;">3. Deadline Date (Max Time to Resolve):</label>
Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <button class="ban-btn-select" onclick="selectBanDuration(1, this)">24 Hours</button>
Â  Â  Â  Â  Â  Â  <button class="ban-btn-select" onclick="selectBanDuration(3, this)">3 Days</button>
Â  Â  Â  Â  Â  Â  <button class="ban-btn-select" onclick="selectBanDuration(7, this)">1 Week</button>
Â  Â  Â  Â  Â  Â  <input type="date" id="banCustomDate" class="ban-input" style="margin:0; height:100%; text-align:center;" onchange="selectBanCustomDate(this)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  * If not resolved by this date, ban becomes <strong>PERMANENT</strong>.
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="font-weight:bold; display:block;">4. Internal Remarks (Admin Only):</label>
Â  Â  Â  Â  <textarea id="banRemarks" rows="2" class="ban-input" placeholder="Internal notes..."></textarea>

Â  Â  Â  Â  <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
Â  Â  Â  Â  Â  Â  <button onclick="closeBanModal()" class="secondary">Cancel</button>
Â  Â  Â  Â  Â  Â  <button onclick="submitBan()" class="danger" style="font-weight:bold; width:150px;">âš  CONFIRM BAN</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
Â Â 
<div id="tab-dataView" class="hidden">
Â Â 
Â  <div class="panel">
Â  Â  <h3>ğŸ“‹ View Data Logs</h3>
Â  Â  <label style="font-weight:bold; color:#003366;">Step 1: Select Metro Line</label>
Â  Â  <select id="logLineSelect" onchange="handleLogLineChange()" style="background:#eef2f7; font-weight:bold; border:2px solid #003366;">
Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  <option value="Orange Line">Orange Line</option>
Â  Â  Â  <option value="Pink Line">Pink Line</option>
Â  Â  </select>

Â  Â  <label style="font-weight:bold; color:#003366; margin-top:10px; display:block;">Step 2: Select Station</label>
Â  Â  <select id="logStationSelect" onchange="loadSpecificStationData()" disabled style="background:#e9ecef;">
Â  Â  Â  <option value="">-- First Select a Line --</option>
Â  Â  </select>
Â  </div>

Â  <div id="logResultsPanel" class="hidden">
Â  Â Â 
Â  Â  <div class="panel" style="border-left: 5px solid #003366;">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  <h4 style="margin:0; color:#003366;">ğŸ“Š Table 1: Yellow Line & Station Details</h4>
Â  Â  Â  Â  Â  <button onclick="loadSpecificStationData()" class="primary" style="padding:5px 10px; font-size:12px;">ğŸ”„ Refresh</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="table-wrapper" style="margin-top:10px;">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead style="background:#e9ecef;">
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  <th>User</th>
Â  Â  Â  Â  Â  Â  Â  <th>Stn Length</th>
Â  Â  Â  Â  Â  Â  Â  <th>YL Dist</th>
Â  Â  Â  Â  Â  Â  Â  <th>YL Thick</th>
Â  Â  Â  Â  Â  Â  Â  <th>Remarks</th>
Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="viewTable1Body">
Â  Â  Â  Â  Â  Â  <tr><td colspan="7" style="text-align:center;">Select a station...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="panel" style="border-left: 5px solid #28a745;">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  <h4 style="margin:0; color:#28a745;">ğŸš† Table 2: Distance Data (Rakes)</h4>
Â  Â  Â  <button id="btnDeleteAllRakes" class="danger" style="padding:4px 10px; font-size:11px; display:none;" onclick="triggerDeleteAll()">ğŸ—‘ Delete All Rakes</button>
Â  </div>
Â  Â  Â  <div class="table-wrapper" style="margin-top:10px;">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead style="background:#e9ecef;">
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>SL</th>
Â  Â  Â  Â  Â  Â  Â  <th>Rake No</th>
Â  Â  Â  Â  Â  Â  Â  <th> Rake Type</th>
Â  Â  Â  Â  Â  Â  Â  <th>Front</th>
Â  Â  Â  Â  Â  Â  Â  <th>Rear</th>
Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="viewTable2Body">
Â  Â  Â  Â  Â  Â  <tr><td colspan="6" style="text-align:center;">Select a station...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  </div>

</div>
Â  <div id="rakeDataModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:700px; max-width:95%; max-height:85vh; display:flex; flex-direction:column;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #003366; padding-bottom:10px; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:#003366;">ğŸš† Rake Distance Table</h3>
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeRakeModal()" style="padding:5px 15px;">Close X</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="table-wrapper" style="overflow-y:auto; flex-grow:1;">
Â  Â  Â  Â  Â  Â  <table style="width:100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background:#003366; color:white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>SL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>RAKE NO</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>TYPE</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>FRONT</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>REAR</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ACT</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="modalRakeBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
Â  <div id="tab-printReport" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>ğŸ–¨ï¸ Report Generation Center</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background:#eef2f7; padding:15px; border-radius:5px; border:1px solid #003366;">
Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; color:#003366;">1. Select Station to Find Logs:</label>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-top:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="printLineSelect" onchange="handlePrintLineChange()" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Orange Line">Orange Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pink Line">Pink Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="printStationSelect" onchange="fetchLogsForPrint()" disabled style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- First Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="printLogList" class="hidden" style="margin-top:20px;">
Â  Â  Â  Â  Â  Â  <h4>2. Available Records:</h4>
Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Station</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Submitted By</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="printLogBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
<div id="printOptionsModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:450px; max-width:95%;">
Â  Â  Â  Â  <h3 style="color:#003366; border-bottom:2px solid #b38600; padding-bottom:10px; margin-top:0;">ğŸ–¨ï¸ Configure Report</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p style="margin-bottom:15px;"><strong>Record Date:</strong> <span id="modalPrintDate" style="color:#003366; font-weight:bold;">--</span></p>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; color:#003366;">1. Select Data to Include:</label>
Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  <label class="checkbox-item" style="flex:1; padding:10px; background:#f8f9fa; border:1px solid #ddd; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="chkStationDetails" checked>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Station Details
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <label class="checkbox-item" style="flex:1; padding:10px; background:#f8f9fa; border:1px solid #ddd; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="chkRakeData" checked>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Rake Table
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; color:#003366;">2. Signature Authority:</label>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <small>Test Conducting Member:</small>
Â  Â  Â  Â  Â  Â  <select id="selPrintInspector" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Loading...</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <small>Approved By (Chief Authority):</small>
Â  Â  Â  Â  Â  Â  <select id="selPrintAuthority" style="width:100%; padding:8px; border:1px solid #b38600; background:#fffdf5; border-radius:4px; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Authority --</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="display:flex; gap:10px; border-top:1px solid #eee; padding-top:15px;">
Â  Â  Â  Â  Â  Â  <button class="secondary" onclick="closePrintModal()" style="flex:1;">Cancel</button>
Â  Â  Â  Â  Â  Â  <button class="primary" onclick="generateFinalReport()" style="flex:2;">ğŸ“„ Generate & Print</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
Â  Â  </div>

<div id="printableReportContainer" class="hidden">
Â  Â  <div class="no-print" style="text-align:center; margin-bottom:20px; border-bottom:1px solid #ccc; padding:15px; background:#f8f9fa;">
Â  Â  Â  Â  <h3 style="margin:0 0 10px 0;">Select Print Format</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()" style="margin-right:20px;">
Â  Â  Â  Â  Â  Â  âŒ Close
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button onclick="printReport('A4')" style="background:#003366; color:white; padding:10px 20px; font-size:16px; margin-right:10px; border:1px solid #002244;">
Â  Â  Â  Â  Â  Â  ğŸ“„ Print A4 (Standard)
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button onclick="printReport('POS')" style="background:#000; color:white; padding:10px 20px; font-size:16px; border:2px solid #b38600;">
Â  Â  Â  Â  Â  Â  ğŸ§¾ Print Receipt (POS)
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div class="report-paper">
Â  Â  Â  Â  <div class="report-header">
Â  Â  Â  Â  Â  Â  <h2 style="margin:0; text-transform:uppercase; color:#003366;">METRO RAILWAY SAFETY</h2>
Â  Â  Â  Â  Â  Â  <small style="letter-spacing: 2px; font-weight:bold;">INSPECTION REPORT</small>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="report-meta">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <strong>Station:</strong> <span id="rptStationName">--</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <strong>Line:</strong> <span id="rptLineName">--</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>Date:</strong> <span id="rptDate">--</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <strong>User:</strong> <span id="rptUser">--</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sectionStationDetails">
Â  Â  Â  Â  Â  Â  <div class="report-section-title">A. STATION MEASUREMENTS</div>
Â  Â  Â  Â  Â  Â  <table class="report-table">
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="background:#f0f0f0; width:40%;"><strong>Length</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td id="rptLen">--</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="background:#f0f0f0;"><strong>Y-Line Dist</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td id="rptYl">--</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="background:#f0f0f0;"><strong>Thickness</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td id="rptTh">--</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="background:#f0f0f0;"><strong>Impl?</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td id="rptStatus">--</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="background:#f0f0f0;"><strong>Remarks</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td id="rptRem">--</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sectionRakeData" style="margin-top:20px;">
Â  Â  Â  Â  Â  Â  <div class="report-section-title">B. RAKE DATA</div>
Â  Â  Â  Â  Â  Â  <table class="report-table">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background:#f0f0f0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:30px;">#</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rake</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Type</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>F</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>R</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="rptRakeBody"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="report-footer" style="margin-top:50px; display:flex; justify-content:space-between; page-break-inside: avoid;">
Â  Â  Â  Â  Â  Â  <div style="text-align:center; min-width:150px;">
Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-bottom:5px;">_________________</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rptSigInspectorName" style="font-weight:bold; font-size:12px;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <small>Test In-Charge</small>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="text-align:center; min-width:150px;">
Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-bottom:5px;">_________________</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rptSigAuthName" style="font-weight:bold; font-size:12px;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <small>APPROVED BY</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
</div>
  <div id="tab-demoResult" class="hidden">
    <div class="panel">
        <h3>ğŸ§ª New Demo Test Recording</h3>
        <label style="font-weight:bold; color:#003366;">Test Environment / Location</label>
        <input id="demoLocation" placeholder="e.g. Lab Test Bench 1 / Sector V Platform Demo">
        
        <div class="table-wrapper">
            <table>
                <thead style="background:#003366; color:white;">
                    <tr>
                        <th style="width:50px; text-align:center;">SL No.</th>
                        <th>Distance (cm)</th>
                        <th>System Response</th>
                        <th style="text-align:center;">Action</th>
                    </tr>
                </thead>
                <tbody id="demoTableBody">
                    </tbody>
            </table>
        </div>
        
        <div style="margin-top:10px; display:flex; justify-content:space-between;">
            <button class="primary" onclick="addDemoRow()">+ Add Reading</button>
            <button class="success" onclick="submitDemoData()" id="btnSaveDemo">ğŸ’¾ Save Demo Result</button>
        </div>
        
        <div style="margin-top:15px;">
            <label style="font-weight:bold;">General Comments / Observations:</label>
            <textarea id="demoComments" rows="2" placeholder="Write overall performance comments here..."></textarea>
        </div>
    </div>

    <div class="panel" style="border-top: 5px solid #17a2b8;">
        <h3>ğŸ“œ Previous Demo Logs</h3>
        <div class="table-wrapper">
            <table id="demoLogTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Location</th>
                        <th>User</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="demoHistoryBody"></tbody>
            </table>
        </div>
    </div>
</div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
Â  authDomain: "metro-railway-project.firebaseapp.com",
Â  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
Â  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];
let modelsLoaded = false;
let isTransactionAuth = false;
let currentTransactionType = "";

// --- UNIFIED SCAN MODE VARIABLE ---
// I have removed the duplicate 'let scanMode'.
// This single variable now handles ALL modes: 'LOGIN', 'RECEIVER', 'ADMIN', 'ADD', 'CHECKOUT', 'RETURN'
let scanMode = 'LOGIN';

let receiverVerified = false;

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null; // Stores details of scanned item for Checkout/Return
// --- NEW BARCODE VARS ---
let scanner = null;
let existingItemKey = null; // To track if we are updating existing stock

// --- SIGNATURE PAD LOGIC (UPDATED FOR MOBILE) ---
// --- ROBUST SIGNATURE LOGIC (PC + MOBILE FIX) ---
// --- FINAL ROBUST SIGNATURE (POINTER EVENTS) ---
function setupCanvas(id) {
Â  Â  const canvas = document.getElementById(id);
Â  Â  if (!canvas) return; // Safety check

Â  Â  const ctx = canvas.getContext('2d');
Â  Â  ctx.lineWidth = 3;Â  Â  Â  Â // Thicker line for better visibility on mobile
Â  Â  ctx.lineCap = 'round';Â  Â // Smooth edges
Â  Â  ctx.strokeStyle = '#000000';

Â  Â  let isDrawing = false;

Â  Â  // 1. FORCE DISABLE SCROLLING ON CANVAS via JS
Â  Â  // This effectively tells the browser: "The user cannot scroll when touching this box"
Â  Â  canvas.style.touchAction = 'none';

Â  Â  // Helper to get exact coordinates
Â  Â  function getPos(e) {
Â  Â  Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  Â  Â  // Calculate scaling (vital if CSS shrinks the canvas)
Â  Â  Â  Â  const scaleX = canvas.width / rect.width;
Â  Â  Â  Â  const scaleY = canvas.height / rect.height;
Â  Â  Â  Â 
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  x: (e.clientX - rect.left) * scaleX,
Â  Â  Â  Â  Â  Â  y: (e.clientY - rect.top) * scaleY
Â  Â  Â  Â  };
Â  Â  }

Â  Â  // --- POINTER EVENTS (Handles Mouse + Touch automatically) ---

Â  Â  // Start Drawing
Â  Â  canvas.addEventListener('pointerdown', (e) => {
Â  Â  Â  Â  isDrawing = true;
Â  Â  Â  Â  canvas.setPointerCapture(e.pointerId); // LOCKS pointer to canvas so you can't scroll away
Â  Â  Â  Â  const pos = getPos(e);
Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  ctx.moveTo(pos.x, pos.y);
Â  Â  Â  Â  e.preventDefault();
Â  Â  });

Â  Â  // Draw Line
Â  Â  canvas.addEventListener('pointermove', (e) => {
Â  Â  Â  Â  if (!isDrawing) return;
Â  Â  Â  Â  const pos = getPos(e);
Â  Â  Â  Â  ctx.lineTo(pos.x, pos.y);
Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  e.preventDefault();
Â  Â  });

Â  Â  // Stop Drawing
Â  Â  canvas.addEventListener('pointerup', (e) => {
Â  Â  Â  Â  isDrawing = false;
Â  Â  Â  Â  canvas.releasePointerCapture(e.pointerId);
Â  Â  });

Â  Â  // Cancel (e.g. finger slides off screen edge)
Â  Â  canvas.addEventListener('pointercancel', () => {
Â  Â  Â  Â  isDrawing = false;
Â  Â  });
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => {
Â  Â  const canvas = document.getElementById(id);
Â  Â  const ctx = canvas.getContext('2d');
Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// --- NEW HELPER: Signature Modal ---
window.viewSignature = (sigData) => {
Â  Â  document.getElementById("modalSigImage").src = sigData;
Â  Â  document.getElementById("sigModal").classList.remove("hidden");
};
window.closeSigModal = () => document.getElementById("sigModal").classList.add("hidden");

// --- NEW BARCODE LOGIC ---
window.openBarcodeScanner = (mode) => {
Â  Â  scanMode = mode;
Â  Â  document.getElementById("barcodeModal").classList.remove("hidden");
Â  Â 
Â  Â  // START SCANNER
Â  Â  if(!scanner) {
Â  Â  Â  Â  scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
Â  Â  Â  Â  scanner.render(onScanSuccess, onScanFailure);
Â  Â  }
}

window.closeBarcodeScanner = () => {
Â  Â  document.getElementById("barcodeModal").classList.add("hidden");
Â  Â  if(scanner) {
Â  Â  Â  Â  scanner.clear();
Â  Â  Â  Â  scanner = null;
Â  Â  }
}
// --- NEW AUDIT LOGIC ---
window.closeAuditModal = () => document.getElementById("auditResultModal").classList.add("hidden");
window.fetchAuditHistory = async (barcode) => {
Â  Â  if (!barcode) return;

Â  Â  // Open popup
Â  Â  const modal = document.getElementById("auditResultModal");
Â  Â  const container = document.getElementById("auditTimelineContainer");
Â  Â  document.getElementById("auditModalBarcode").innerText = "Barcode: " + barcode;
Â  Â  modal.classList.remove("hidden");

Â  Â  container.innerHTML = `<div style="text-align:center; padding:20px;">Loading...</div>`;

Â  Â  try {
Â  Â  Â  Â  const q = query(
Â  Â  Â  Â  Â  Â  ref(db, "logs"),
Â  Â  Â  Â  Â  Â  orderByChild("barcode"),
Â  Â  Â  Â  Â  Â  equalTo(barcode)
Â  Â  Â  Â  );

Â  Â  Â  Â  const snap = await get(q);

Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  container.innerHTML = `<div style="text-align:center;color:#777;">No history found</div>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 1. collect only checkout & return
Â  Â  Â  Â  let raw = [];
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  if (v.type === "CHECKOUT" || v.type === "RETURN") {
Â  Â  Â  Â  Â  Â  Â  Â  raw.push(v);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2. sort old â†’ new
Â  Â  Â  Â  raw.sort((a, b) => a.time - b.time);

Â  Â  Â  Â  // 3. pair checkout + return
Â  Â  Â  Â  let records = [];
Â  Â  Â  Â  let open = null;

Â  Â  Â  Â  raw.forEach(l => {
Â  Â  Â  Â  Â  Â  if (l.type === "CHECKOUT") {
Â  Â  Â  Â  Â  Â  Â  Â  open = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user: l.takenBy,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkout: l.time,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return: null
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  records.push(open);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (l.type === "RETURN" && open) {
Â  Â  Â  Â  Â  Â  Â  Â  open.return = l.time;
Â  Â  Â  Â  Â  Â  Â  Â  open = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 4. last 4 only (latest first)
Â  Â  Â  Â  records = records.slice(-20).reverse();

Â  Â  Â  Â  // 5. render popup cards
Â  Â  Â  Â  container.innerHTML = "";

Â  Â  Â  Â  records.forEach(r => {
Â  Â  Â  Â  Â  Â  const co = new Date(r.checkout).toLocaleString("en-IN", {
Â  Â  Â  Â  Â  Â  Â  Â  timeZone: "Asia/Kolkata",
Â  Â  Â  Â  Â  Â  Â  Â  day: "2-digit",
Â  Â  Â  Â  Â  Â  Â  Â  month: "short",
Â  Â  Â  Â  Â  Â  Â  Â  year: "numeric",
Â  Â  Â  Â  Â  Â  Â  Â  hour: "2-digit",
Â  Â  Â  Â  Â  Â  Â  Â  minute: "2-digit",
Â  Â  Â  Â  Â  Â  Â  Â  hour12: true
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const ro = r.return
Â  Â  Â  Â  Â  Â  Â  Â  ? new Date(r.return).toLocaleString("en-IN", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeZone: "Asia/Kolkata",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day: "2-digit",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month: "short",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  year: "numeric",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hour: "2-digit",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  minute: "2-digit",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hour12: true
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  : "Still Holding";

Â  Â  Â  Â  Â  Â  container.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="history-card ${r.return ? 'return' : 'checkout'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="hc-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hc-user">ğŸ‘¤ ${r.user}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:11px;color:#666;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.return ? 'RETURNED' : 'OUT'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="hc-meta">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¤ Checkout: <b>${co}</b><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¥ Return: <b>${ro}</b>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  container.innerHTML = `<div style="color:red;text-align:center;">Error loading data</div>`;
Â  Â  }
};

// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = "";Â 
};
// --- DEMO RESULTS LOGIC ---

// 1. Add Row to the dynamic table
window.addDemoRow = () => {
    const tbody = document.getElementById("demoTableBody");
    const sl = tbody.rows.length + 1;
    const row = document.createElement("tr");
    row.innerHTML = `
        <td style="text-align:center; font-weight:bold;">${sl}</td>
        <td><input type="number" class="demo-dist" placeholder="0.0" style="margin:0;"></td>
        <td><input type="text" class="demo-resp" placeholder="e.g. Alarm Triggered" style="margin:0;"></td>
        <td style="text-align:center;"><button class="danger" onclick="this.parentElement.parentElement.remove(); updateDemoSL();">X</button></td>
    `;
    tbody.appendChild(row);
};

// 2. Re-calculate SL Numbers if a row is deleted
window.updateDemoSL = () => {
    const rows = document.getElementById("demoTableBody").rows;
    for(let i=0; i<rows.length; i++) {
        rows[i].cells[0].innerText = i + 1;
    }
};

// 3. Submit Demo Data to Firebase
window.submitDemoData = async () => {
    const loc = document.getElementById("demoLocation").value;
    const comm = document.getElementById("demoComments").value;
    const rows = document.querySelectorAll("#demoTableBody tr");

    if(!loc || rows.length === 0) return alert("Please enter location and at least one reading.");

    const readings = [];
    rows.forEach(r => {
        readings.push({
            dist: r.querySelector(".demo-dist").value,
            resp: r.querySelector(".demo-resp").value
        });
    });

    const demoKey = push(ref(db, "demo_logs")).key;
    const demoData = {
        location: loc,
        comments: comm,
        readings: readings,
        userName: currentUser.name || currentUser.email,
        date: new Date().toLocaleString(),
        timestamp: serverTimestamp()
    };

    try {
        await set(ref(db, `demo_logs/${demoKey}`), demoData);
        alert("âœ… Demo Results Stored Successfully!");
        
        // Reset Form
        document.getElementById("demoLocation").value = "";
        document.getElementById("demoComments").value = "";
        document.getElementById("demoTableBody").innerHTML = "";
        loadDemoHistory();
    } catch (e) {
        alert("Error saving demo: " + e.message);
    }
};

// 4. Load History
function loadDemoHistory() {
    const tbody = document.getElementById("demoHistoryBody");
    onValue(ref(db, "demo_logs"), snap => {
        tbody.innerHTML = "";
        if(!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No demo records.</td></tr>";
            return;
        }
        snap.forEach(c => {
            const d = c.val();
            tbody.innerHTML += `
                <tr>
                    <td>${d.date}</td>
                    <td><b>${d.location}</b></td>
                    <td>${d.userName}</td>
                    <td><span class="badge-online">Recorded</span></td>
                    <td>
                        <button class="info" onclick="viewDemoDetails('${c.key}')">View</button>
                        ${isAdmin ? `<button class="danger" onclick="deleteDemo('${c.key}')">ğŸ—‘</button>` : ''}
                    </td>
                </tr>
            `;
        });
    });
}

// 5. Delete Function (Admin)
window.deleteDemo = (key) => {
    if(confirm("Delete this demo record?")) {
        remove(ref(db, `demo_logs/${key}`));
    }
};

// Update switchTab to include 'demoResult'
// (Find your existing switchTab and ensure 'demoResult' is in the array)
window.loadInventoryHistory = () => {
Â  Â  const tbody = document.getElementById("invHistoryBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Syncing Live Data...</td></tr>";

Â  Â  // This listener stays open and updates automatically when DB changes
Â  Â  const dbRef = getDatabase();
Â  Â  const q = query(ref(dbRef, "logs"), limitToLast(100));
Â  Â Â 
Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse(); // Show newest events at the top

Â  Â  Â  Â  // Filter: Show only inventory-related events (Checkout, Return, Add)
Â  Â  Â  Â  const invLogs = logs.filter(l =>Â 
Â  Â  Â  Â  Â  Â  l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE'
Â  Â  Â  Â  );

Â  Â  Â  Â  if(invLogs.length === 0) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded recently.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  invLogs.forEach(l => {
Â  Â  Â  Â  Â  Â  // Badge Styling
Â  Â  Â  Â  Â  Â  let badge = "";
Â  Â  Â  Â  Â  Â  if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">ğŸ“¤ OUT</span>`;
Â  Â  Â  Â  Â  Â  else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">ğŸ“¥ IN</span>`;
Â  Â  Â  Â  Â  Â  else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">â• ADD</span>`;

Â  Â  Â  Â  Â  Â  // Barcode formatting
Â  Â  Â  Â  Â  Â  const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px; letter-spacing:1px;">${l.barcode}</div>` : '';

Â  Â  Â  Â  Â  Â  // Row HTML
Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle;">${barcodeDisplay}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; vertical-align:middle;">${l.takenBy || 'Unknown'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${formatTime(l.time)}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; vertical-align:middle;">${badge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:13px; font-weight:bold; color:#333;">${l.item}</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:#777;">Auth: ${l.approvedBy || 'System'}</small>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  });
Â  Â  });
};
// --- FULL FUNCTION: Print Report Handler ---
window.printReport = (mode) => {
Â  Â  // 1. Clean previous classes to ensure no conflicts
Â  Â  document.body.classList.remove('print-a4', 'print-pos');

Â  Â  // 2. Add the selected class based on button click
Â  Â  if (mode === 'A4') {
Â  Â  Â  Â  document.body.classList.add('print-a4');
Â  Â  } else {
Â  Â  Â  Â  document.body.classList.add('print-pos');
Â  Â  }

Â  Â  // 3. Trigger the browser's print dialog
Â  Â  window.print();
};

// --- FULL FUNCTION: Close Preview Handler ---
window.closeReportPreview = () => {
Â  Â  // 1. Hide the container div
Â  Â  document.getElementById("printableReportContainer").classList.add("hidden");
Â  Â Â 
Â  Â  // 2. Remove the print classes so the main app returns to normal styling
Â  Â  document.body.classList.remove('print-a4', 'print-pos');
};
window.onScanSuccess = async function(decodedText) {
Â  Â  closeBarcodeScanner();
Â  Â  console.log("SCANNED:", decodedText, "MODE:", scanMode);

Â  Â  // ---------------- ADD STOCK ----------------
Â  Â  if (scanMode === 'ADD') {
Â  Â  Â  Â  document.getElementById("invBarcode").value = decodedText;
Â  Â  Â  Â  checkBarcodeUnique(decodedText);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ---------------- CHECKOUT / RETURN ----------------
Â  Â  if (scanMode === 'CHECKOUT' || scanMode === 'RETURN') {

Â  Â  Â  Â  const isCheckout = scanMode === 'CHECKOUT';

Â  Â  Â  Â  const displayId = isCheckout ? "checkout_display" : "return_display";
Â  Â  Â  Â  const nameIdÂ  Â  = isCheckout ? "checkout_item_name" : "return_item_name";
Â  Â  Â  Â  const codeIdÂ  Â  = isCheckout ? "checkout_item_code" : "return_item_code";
Â  Â  Â  Â  const authBtnId = isCheckout ? "btn_checkout_verify" : "btn_return_verify";

Â  Â  Â  Â  document.getElementById(displayId).classList.remove("hidden");
Â  Â  Â  Â  document.getElementById(nameId).innerHTML = "ğŸ” Checking inventory...";
Â  Â  Â  Â  document.getElementById(codeId).innerText = decodedText;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const q = query(
Â  Â  Â  Â  Â  Â  Â  Â  ref(db, "inventory"),
Â  Â  Â  Â  Â  Â  Â  Â  orderByChild("barcode"),
Â  Â  Â  Â  Â  Â  Â  Â  equalTo(decodedText)
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  const snap = await get(q);

Â  Â  Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(nameId).innerHTML =
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<span style="color:red;">âŒ Item not found</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  alert("This barcode does not exist in inventory.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let item = null;
Â  Â  Â  Â  Â  Â  let itemKey = null;
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  item = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  itemKey = c.key;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const currentUserName =
Â  Â  Â  Â  Â  Â  Â  Â  currentUser.name || currentUser.email;

Â  Â  Â  Â  Â  Â  // ---------- CHECKOUT RULE ----------
Â  Â  Â  Â  Â  Â  if (isCheckout && item.status !== "In Stock") {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(nameId).innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:red;font-weight:bold;">â›” ALREADY CHECKED OUT</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.item}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>Held by: <b>${item.holder}</b></small>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(authBtnId).style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ---------- RETURN RULE ----------
Â  Â  Â  Â  Â  Â  if (!isCheckout) {

Â  Â  Â  Â  Â  Â  Â  Â  if (item.status === "In Stock") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(nameId).innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:red;font-weight:bold;">â›” ALREADY RETURNED</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.item}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(authBtnId).style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // ğŸš¨ CORE SECURITY RULE
Â  Â  Â  Â  Â  Â  Â  Â  if (item.holder !== currentUserName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(nameId).innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:red;font-weight:bold;">â›” RETURN DENIED</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.item}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Checked out by: <b>${item.holder}</b>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(authBtnId).style.display = "none";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Return blocked.\n\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Item was checked out by:\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.holder + "\n\n" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Only the same user can return it."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ---------- SUCCESS ----------
Â  Â  Â  Â  Â  Â  document.getElementById(nameId).innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:${isCheckout ? '#b38600' : '#17a2b8'}; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ” Ready to ${isCheckout ? 'Checkout' : 'Return'}
Â  Â  Â  Â  Â  Â  Â  Â  </span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:1.2em">${item.item}</span>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  pendingTransactionItem = {
Â  Â  Â  Â  Â  Â  Â  Â  key: itemKey,
Â  Â  Â  Â  Â  Â  Â  Â  ...item
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  document.getElementById(authBtnId).style.display = "block";

Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  alert("Database error.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ---------------- AUDIT SEARCH ----------------
Â  Â  if (scanMode === 'AUDIT_SEARCH') {

Â  Â  if (!isAdmin) {
Â  Â  Â  Â  alert("Audit scanning is restricted to administrators.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  document.getElementById("auditSearchInput").value = decodedText;
Â  Â  fetchAuditHistory(decodedText);
}


Â  Â  // ---------------- STOCK SEARCH ----------------
Â  Â  if (scanMode === 'SEARCH_STOCK') {
Â  Â  Â  Â  document.getElementById("mainStockSearch").value = decodedText;
Â  Â  Â  Â  filterStockTable();
Â  Â  }
};

// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = "";Â 
};

// --- 4. EMPTY/DUMMY LOAD HISTORY (Prevents errors when clicking tab) ---
window.loadInventoryHistory = () => {
Â  Â  // Intentionally empty or just focuses the search box
Â  Â  // Because we removed the table
Â  Â  setTimeout(() => document.getElementById("auditSearchInput").focus(), 300);
};

// --- 2. UNIFIED SCANNER HANDLER (This replaces your old one) ---


// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = "";Â 
};


window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = ""; // Clear input
};
// --- UNIFIED SCANNER HANDLER ---

function onScanFailure(error) {
Â  Â  // Do nothing, keep scanning
}

// --- INNOVATIVE BARCODE LOGIC: CHECK EXISTENCE ---
// --- NEW LOGIC: PREVENT DUPLICATE BARCODES ---
window.checkBarcodeUnique = async (code) => {
Â  Â  if(!code) return;
Â  Â Â 
Â  Â  // Reset UI
Â  Â  document.getElementById("barcodeError").classList.add("hidden");
Â  Â  document.getElementById("btnAddStock").disabled = false;
Â  Â  document.getElementById("btnAddStock").innerText = "Save Item to Stock";

Â  Â  // Query DB to see if barcode exists
Â  Â  const invRef = ref(db, "inventory");
Â  Â  const q = query(invRef, orderByChild("barcode"), equalTo(code));
Â  Â  const snap = await get(q);

Â  Â  if(snap.exists()) {
Â  Â  Â  Â  // ERROR: DUPLICATE FOUND
Â  Â  Â  Â  document.getElementById("barcodeError").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("btnAddStock").disabled = true;
Â  Â  Â  Â  document.getElementById("btnAddStock").innerText = "â›” Duplicate Barcode";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Optional: Show who has it
Â  Â  Â  Â  let existingItem = null;
Â  Â  Â  Â  snap.forEach(c => existingItem = c.val());
Â  Â  Â  Â  alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
Â  Â  }
}
// --- HELPER: TOGGLE 'OTHER' INPUT ---
window.toggleOtherInput = () => {
Â  Â  const val = document.getElementById("returnLocSelect").value;
Â  Â  const otherDiv = document.getElementById("divOtherLoc");
Â  Â Â 
Â  Â  if(val === "Other") {
Â  Â  Â  Â  otherDiv.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("returnLocOther").focus();
Â  Â  } else {
Â  Â  Â  Â  otherDiv.classList.add("hidden");
Â  Â  }
};
// --- NEW: TRIGGER RECEIVER SCAN ---
window.startReceiverScan = (type) => {
Â  Â  scanMode = 'RECEIVER';
Â  Â  currentTransactionType = type; // 'CHECKOUT' or 'RETURN'
Â  Â 
Â  Â  document.getElementById("faceModal").classList.remove("hidden");
Â  Â  document.getElementById("modalTitle").innerText = "ğŸ‘¤ Receiver Verification";
Â  Â  document.getElementById("modalDesc").innerText = "Please look at the camera to verify identity.";
Â  Â  document.getElementById("regProgress").classList.add("hidden");
Â  Â  document.getElementById("btnCapture").innerText = "ğŸ“¸ Verify My Face";
Â  Â  document.getElementById("btnCapture").disabled = false;
Â  Â  document.getElementById("btnCapture").onclick = handleFaceScan;
Â  Â 
Â  Â  // UI Cleanup
Â  Â  document.getElementById("videoContainer").classList.remove("hidden");
Â  Â  document.getElementById("camControls").classList.remove("hidden");
Â  Â  document.getElementById("otpUI").classList.add("hidden");
Â  Â 
Â  Â  initCamera(true);
};
// --- 1. LOAD AI MODELS ---
async function preloadModels() {
Â  Â  if(modelsLoaded) return;
Â  Â  try {
Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
Â  Â  Â  Â  Â  Â  faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
Â  Â  Â  Â  Â  Â  faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
Â  Â  Â  Â  ]);
Â  Â  Â  Â  modelsLoaded = true;
Â  Â  } catch(e) { console.error("Model Error", e); }
}
preloadModels();
// ==========================================
// 1. UPDATED LOGIN FUNCTION
// ==========================================
window.login = () => {
Â  Â  const emailField = document.getElementById("email");
Â  Â  const passField = document.getElementById("password");
Â  Â  const btn = document.querySelector("#loginSection button");
Â  Â Â 
Â  Â  if(!emailField.value || !passField.value) return alert("Please enter email and password.");

Â  Â  // Visual Feedback
Â  Â  btn.innerText = "ğŸ”„ Verifying Credentials...";
Â  Â  btn.disabled = true;

Â  Â  signInWithEmailAndPassword(auth, emailField.value, passField.value)
Â  Â  .then(() => {
Â  Â  Â  Â  // Success: onAuthStateChanged will handle the rest
Â  Â  Â  Â  console.log("Credentials accepted.");
Â  Â  })
Â  Â  .catch(e => {
Â  Â  Â  Â  btn.innerText = "SECURE LOGIN";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  alert("Login Failed: " + e.message);
Â  Â  });
};
// ==========================================
// 2. CRASH-PROOF AUTH LISTENER (FIXED)
// ==========================================
onAuthStateChanged(auth, (user) => {
Â  Â  // A. NO USER -> SHOW LOGIN SCREEN
Â  Â  if (!user) {Â 
Â  Â  Â  Â  showLoginScreen();Â 
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  currentUser = user;
Â  Â Â 
Â  Â  // --- FIX START: Turn on the Presence System ---
Â  Â  // This sends the "Online" signal to the database
Â  Â  startPresenceSystem(user);Â Â 
Â  Â  // --- FIX END ---

Â  Â  // B. USER FOUND -> TRY TO LOAD DATA
Â  Â  const userRef = ref(db, `users/${user.uid}`);
Â  Â Â 
Â  Â  onValue(userRef, (snap) => {
Â  Â  Â  Â  const u = snap.val();

Â  Â  Â  Â  // 1. DATA MISSING? FORCE LOGOUT (Fixes blank screen glitch)
Â  Â  Â  Â  if (!u) {
Â  Â  Â  Â  Â  Â  console.log("User data missing. Force logout.");
Â  Â  Â  Â  Â  Â  alert("Account data not found. Please contact admin.");
Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. TERMINATED?
Â  Â  Â  Â  if (u.terminated) {Â 
Â  Â  Â  Â  Â  Â  alert("ACCOUNT TERMINATED.");Â 
Â  Â  Â  Â  Â  Â  signOut(auth);Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. BANNED? -> SHOW RED SCREEN
Â  Â  Â  Â  if (u.banned) {
Â  Â  Â  Â  Â  Â  // Hide everything else
Â  Â  Â  Â  Â  Â  document.querySelector("header").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Show Ban Screen
Â  Â  Â  Â  Â  Â  const banScreen = document.getElementById("bannedScreen");
Â  Â  Â  Â  Â  Â  if(banScreen) {
Â  Â  Â  Â  Â  Â  Â  Â  banScreen.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  // Fill details
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("displayBanReason").innerText = u.banReason || "Admin Action";
Â  Â  Â  Â  Â  Â  Â  Â  const deadline = u.banExpires || 0;
Â  Â  Â  Â  Â  Â  Â  Â  if(deadline > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const dateStr = new Date(deadline).toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById("bannedTimeDisplay").innerText = "Deadline: " + dateStr;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById("bannedTimeDisplay").innerText = "PERMANENT BAN";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback if HTML is missing
Â  Â  Â  Â  Â  Â  Â  Â  document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:50px;'>â›” BANNED (Overlay Missing)</h1><button onclick='logout()'>Log Out</button>";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. ACTIVE & CLEAN -> SHOW DASHBOARD
Â  Â  Â  Â  // Hide Ban Screen / Login Screen
Â  Â  Â  Â  document.getElementById("bannedScreen")?.classList.add("hidden");
Â  Â  Â  Â  document.querySelector("header").style.display = "flex";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Setup User Session
Â  Â  Â  Â  currentUser.name = u.name;
Â  Â  Â  Â  isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());

Â  Â  Â  Â  if (!u.name) {
Â  Â  Â  Â  Â  Â  document.getElementById("nameModal").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // UPDATE UI
Â  Â  Â  Â  document.getElementById("userInfo").innerText = `${u.name}`;
Â  Â  Â  Â  document.getElementById("authContainer").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");

Â  Â  Â  Â  // LOAD ADMIN TOOLS
Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  document.getElementById("adminBadge").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("btnAdmin").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  setTimeout(loadAdminPanel, 2000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // BIOMETRIC CHECK
Â  Â  Â  Â  if(!isTransactionAuth) {
Â  Â  Â  Â  Â  Â  const faceModal = document.getElementById("faceModal");
Â  Â  Â  Â  Â  Â  faceModal.classList.remove("hidden");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(!u.faceData) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "âš ï¸ Face ID Setup";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("regProgress").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btnCapture").onclick = registerNewFace;
Â  Â  Â  Â  Â  Â  Â  Â  initCamera(false);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "Biometric Verification";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("regProgress").classList.add("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btnCapture").onclick = handleFaceScan;
Â  Â  Â  Â  Â  Â  Â  Â  initCamera(true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }, (error) => {
Â  Â  Â  Â  // IF DATABASE FAILS -> LOGOUT
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  alert("Connection Error. Logging out...");
Â  Â  Â  Â  signOut(auth);
Â  Â  });
});
// Helper to reliably show login
function showLoginScreen() {
Â  Â  document.querySelector("header").style.display = "flex";
Â  Â  document.getElementById("loginSection").classList.remove("hidden");
Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  document.getElementById("authContainer").classList.add("hidden");
Â  Â  document.getElementById("bannedScreen")?.classList.add("hidden");
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  stopCamera();
Â  Â Â 
Â  Â  // Reset Button State
Â  Â  const btn = document.querySelector("#loginSection button");
Â  Â  if(btn) {
Â  Â  Â  Â  btn.innerText = "SECURE LOGIN";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }
}

// --- HELPER: TOGGLE 'OTHER' INPUT FOR ADD STOCK ---
window.toggleAddOtherInput = () => {
Â  Â  const val = document.getElementById("addLocSelect").value;
Â  Â  const otherDiv = document.getElementById("divAddOtherLoc");
Â  Â Â 
Â  Â  if(val === "Other") {
Â  Â  Â  Â  otherDiv.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("addLocOther").focus();
Â  Â  } else {
Â  Â  Â  Â  otherDiv.classList.add("hidden");
Â  Â  }
};
// --- TOGGLE 'OTHER' INPUT ---
window.toggleBanOtherInput = () => {
Â  Â  const val = document.getElementById("banReasonInput").value;
Â  Â  const div = document.getElementById("divBanOther");
Â  Â  if(val === "Other") {
Â  Â  Â  Â  div.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("banReasonOther").focus();
Â  Â  } else {
Â  Â  Â  Â  div.classList.add("hidden");
Â  Â  }
};

// --- HANDLE CUSTOM DATE SELECTION ---
window.selectBanCustomDate = (input) => {
Â  Â  if(input.value) {
Â  Â  Â  Â  // Deselect all buttons if date is picked
Â  Â  Â  Â  currentBanDays = 'CUSTOM';
Â  Â  Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
Â  Â  Â  Â  input.style.border = "2px solid #dc3545";
Â  Â  }
};

// --- UPDATED BUTTON SELECTION ---
window.selectBanDuration = (days, btn) => {
Â  Â  currentBanDays = days;
Â  Â  // Clear Date Input
Â  Â  document.getElementById("banCustomDate").value = "";
Â  Â  document.getElementById("banCustomDate").style.border = "1px solid #ccc";
Â  Â Â 
Â  Â  // Highlight Button
Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
Â  Â  btn.classList.add("selected");
};
// --- NEW HEARTBEAT SYSTEM ---
function startPresenceSystem(user) {
Â  Â  const userStatusRef = ref(db, `status/${user.uid}`);
Â  Â  set(userStatusRef, { state: 'online', last_changed: serverTimestamp(), email: user.email, name: user.displayName || "User" });
Â  Â  onDisconnect(userStatusRef).set({ state: 'offline', last_changed: serverTimestamp(), email: user.email });
Â  Â  setInterval(() => { if(currentUser) update(userStatusRef, { last_seen: serverTimestamp() }); }, 5000);
}

function updateRegDots(count) {
Â  Â  document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
Â  Â  document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
Â  Â  document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

function setupIdleTimer() {
Â  Â  // Detect mouse, clicks, touches (mobile), and keyboard
Â  Â  window.onmousemove = resetTimer;
Â  Â  window.onmousedown = resetTimer;Â 
Â  Â  window.onclick = resetTimer;
Â  Â  window.onkeypress = resetTimer;
Â  Â  window.ontouchstart = resetTimer; // Mobile touch
Â  Â  window.addEventListener('scroll', resetTimer, true); // Scrolling
Â  Â Â 
Â  Â  resetTimer(); // Start the first count
}
function resetTimer() {
Â  Â  clearTimeout(idleTimer);
Â  Â  if(currentUser) {
Â  Â  Â  Â  idleTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGOUT", method: "Auto-Timeout", time: serverTimestamp() };
Â  Â  Â  Â  Â  Â  push(ref(db, "logs"), logData);
Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  alert("Session Timeout.");
Â  Â  Â  Â  }, 3 * 60 * 1000);
Â  Â  }
}

window.saveOfficialName = () => {
Â  Â  const name = document.getElementById("officialNameInput").value;
Â  Â  if(name.length < 3) return alert("Enter full valid name.");
Â  Â  update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
Â  Â  Â  Â  document.getElementById("nameModal").classList.add("hidden");
Â  Â  Â  Â  location.reload();
Â  Â  });
}

function showLogin() {
Â  Â  document.getElementById("loginSection").classList.remove("hidden");
Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  document.getElementById("authContainer").classList.add("hidden");
Â  Â  document.getElementById("nameModal").classList.add("hidden");
Â  Â  stopCamera();
}
window.logout = async () => {
Â  Â  if(currentUser) {
Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGOUT", method: "Manual Click", time: serverTimestamp() };
Â  Â  Â  Â  await push(ref(db, "logs"), logData);
Â  Â  Â  Â  signOut(auth);
Â  Â  }
};

async function recordLogin(method) {
Â  Â  if(currentUser) {
Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
Â  Â  Â  Â  await push(ref(db, "logs"), logData);
Â  Â  }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
Â  Â  const vid = document.getElementById("cameraFeed");
Â  Â  const canvas = document.getElementById("overlayCanvas");
Â  Â 
Â  Â  try {
Â  Â  Â  Â  if(!modelsLoaded) {
Â  Â  Â  Â  Â  Â  updateStatus("Loading AI Models...", "yellow");
Â  Â  Â  Â  Â  Â  await preloadModels();
Â  Â  Â  Â  }
Â  Â  Â  Â 
Â  Â  Â  Â  // Remove specific width/height constraints to let the camera decide
stream = await navigator.mediaDevices.getUserMedia({ video: true });
Â  Â  Â  Â  vid.srcObject = stream;
Â  Â  Â  Â  vid.onloadedmetadata = () => {
Â  Â  Â  Â  Â  Â  vid.play();
Â  Â  Â  Â  Â  Â  startRealTimeDetection(vid, canvas);
Â  Â  Â  Â  };

Â  Â  Â  Â  if(isVerify) updateStatus("LOOK AT CAMERA", "white");
Â  Â  Â  Â  else updateStatus("REGISTRATION: CENTER FACE", "cyan");

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  updateStatus("Camera Hardware Error", "red");
Â  Â  }
}
// --- 1. DEFINE METRO DATA ---
const METRO_STATIONS = {
Â  Â  "Blue Line": [
Â  Â  Â  Â  "Dakshineswar", "Baranagar", "Noapara", "Dum Dum", "Belgachia",Â 
Â  Â  Â  Â  "Shyambazar", "Shobhabazar Sutanuti", "Girish Park", "Mahatma Gandhi Road",Â 
Â  Â  Â  Â  "Central", "Chandni Chowk", "Esplanade", "Park Street", "Maidan",Â 
Â  Â  Â  Â  "Rabindra Sadan", "Netaji Bhavan", "Jatin Das Park", "Kalighat",Â 
Â  Â  Â  Â  "Rabindra Sarobar", "Mahanayak Uttam Kumar", "Netaji",Â 
Â  Â  Â  Â  "Masterda Surya Sen", "Gitanjali", "Kavi Nazrul", "Shahid Khudiram",Â 
Â  Â  Â  Â  "Kavi Subhash (New Garia)"
Â  Â  ],
Â  Â  "Green Line": [
Â  Â  Â  Â  "Salt Lake Sector V", "Karunamoyee", "Central Park", "City Centre",Â 
Â  Â  Â  Â  "Bengal Chemical", "Salt Lake Stadium", "Phoolbagan", "Sealdah",Â 
Â  Â  Â  Â  "Esplanade", "Mahakaran", "Howrah", "Howrah Maidan"
Â  Â  ],
Â  Â  "Purple Line": [
Â  Â  Â  Â  "Joka", "Thakurpukur", "Sakher Bazar", "Behala Chowrasta",Â 
Â  Â  Â  Â  "Behala Bazar", "Taratala", "Majerhat"
Â  Â  ],
Â  Â  "Yellow Line": [
Â  Â  Â  Â  "Noapara", "Dum Dum Cantonment", "Jessore Road", "Jai Hind (Airport)"
Â  Â  ],
Â  Â  "Orange Line": [
Â  Â  Â  Â  "Kavi Subhash (New Garia)", "Satyajit Ray", "Jyotirindra Nandi",Â 
Â  Â  Â  Â  "Kavi Sukanta", "Hemanta Mukhopadhyay"
Â  Â  ],
Â  Â  "Pink Line": [
Â  Â  Â  Â  "Baranagar", "Barrackpore" // Endpoints added as placeholders
Â  Â  ]
};

// --- 2. HANDLE LINE CHANGE ---
window.handleLineChange = () => {
Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  const formDiv = document.getElementById("mainDataForm");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  formDiv.classList.add("hidden");
Â  Â  document.getElementById("inpStationName").value = ""; // Clear hidden input

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  // Populate Stations
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};
// Global variables to track editing state
let currentStationKey = null; // Key of the station_log
let currentRakeKey = null;Â  Â  // Key of the rake_log
// --- STRICT HANDLE STATION CHANGE ---
window.handleStationChange = async () => {
Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  const formDiv = document.getElementById("mainDataForm");
Â  Â Â 
Â  Â  if (!stnSel.value) {
Â  Â  Â  Â  formDiv.classList.add("hidden");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 1. Show the form and reset UI state
Â  Â  formDiv.classList.remove("hidden");
Â  Â  document.getElementById("formTitle").innerText = `ğŸ“ New Inspection: ${stnSel.value}`;
Â  Â  document.getElementById("inpStationName").value = `${stnSel.value} (${lineSel.value})`;
Â  Â Â 
Â  Â  // 2. Unlock all fields for fresh data entry
Â  Â  const fields = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
Â  Â  fields.forEach(id => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if(el) {
Â  Â  Â  Â  Â  Â  el.value = "";
Â  Â  Â  Â  Â  Â  el.disabled = false;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // 3. Clear the UI table for Rakes
Â  Â  document.getElementById("distanceBody").innerHTML = "";
Â  Â Â 
Â  Â  // 4. Reset Global Keys (Ensures we aren't "editing" an old station)
Â  Â  currentStationKey = null;
Â  Â  currentRakeKey = null;

Â  Â  // 5. Load any existing draft for THIS specific station if the user left it mid-way
Â  Â  loadDraft();
};
// --- 1. HANDLE TAB & DROPDOWNS ---

// Reuse Station Data Logic for Print Tab
window.handlePrintLineChange = () => {
Â  Â  const lineSel = document.getElementById("printLineSelect");
Â  Â  const stnSel = document.getElementById("printStationSelect");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  document.getElementById("printLogList").classList.add("hidden");

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  }
};

// --- 2. FETCH LOGS FOR STATION ---
window.fetchLogsForPrint = async () => {
Â  Â  const line = document.getElementById("printLineSelect").value;
Â  Â  const stn = document.getElementById("printStationSelect").value;
Â  Â  const tbody = document.getElementById("printLogBody");
Â  Â  const listDiv = document.getElementById("printLogList");

Â  Â  if(!line || !stn) return;

Â  Â  listDiv.classList.remove("hidden");
Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>ğŸ” Searching Records...</td></tr>";

Â  Â  // Search by Station Name
Â  Â  const searchName = `${stn} (${line})`;
Â  Â Â 
Â  Â  const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
Â  Â  const snap = await get(q);

Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>No records found for this station.</td></tr>";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  tbody.innerHTML = "";
Â  Â  snap.forEach(c => {
Â  Â  Â  Â  const d = c.val();
Â  Â  Â  Â  // Create "Select" Button
Â  Â  Â  Â  const btn = `<button class="info" onclick="openPrintSetup('${c.key}')">ğŸ–¨ï¸ Select</button>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${d.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.userName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${btn}</td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  });
};

// --- 3. OPEN CONFIG MODAL ---
let currentPrintKey = null;

// --- UPDATED OPEN CONFIG MODAL ---
window.openPrintSetup = (key) => {
Â  Â  currentPrintKey = key;
Â  Â Â 
Â  Â  // 1. Fetch Date for display
Â  Â  get(ref(db, `station_logs/${key}/date`)).then(snap => {
Â  Â  Â  Â  document.getElementById("modalPrintDate").innerText = snap.val();
Â  Â  });

Â  Â  // 2. Populate the "Test Conducting Member" dropdown dynamically
Â  Â  populateUserDropdown();

Â  Â  // 3. Show Modal
Â  Â  document.getElementById("printOptionsModal").classList.remove("hidden");
};

window.closePrintModal = () => {
Â  Â  document.getElementById("printOptionsModal").classList.add("hidden");
Â  Â  currentPrintKey = null;
};
window.generateFinalReport = async () => {
Â  Â  if(!currentPrintKey) return alert("Error: No record selected.");

Â  Â  // 1. Get user preferences from checkboxes
Â  Â  const includeStation = document.getElementById("chkStationDetails").checked;
Â  Â  const includeRake = document.getElementById("chkRakeData").checked;

Â  Â  if(!includeStation && !includeRake) return alert("Please select at least one data section to print.");

Â  Â  let inspectorName = document.getElementById("selPrintInspector").value;
Â  Â  const authName = document.getElementById("selPrintAuthority").value;
Â  Â Â 
Â  Â  if(inspectorName === "Self" || inspectorName === "") {
Â  Â  Â  Â  inspectorName = currentUser.name || currentUser.email;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const sSnap = await get(ref(db, `station_logs/${currentPrintKey}`));
Â  Â  Â  Â  if(!sSnap.exists()) return alert("Error: Data record not found.");
Â  Â  Â  Â  const sData = sSnap.val();

Â  Â  Â  Â  // 2. Set Official Titles and Labels
Â  Â  Â  Â  const titleEl = document.querySelector(".report-header h2");
Â  Â  Â  Â  if(titleEl) titleEl.innerText = "METRO RAILWAY PLATFORM SAFETY PROJECT";

Â  Â  Â  Â  document.getElementById("rptSigInspectorName").innerText = inspectorName;
Â  Â  Â  Â  document.getElementById("rptSigAuthName").innerText = authName;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const footerLabel = document.querySelector(".report-footer small");
Â  Â  Â  Â  if(footerLabel) footerLabel.innerText = "Test Conducted By:";

Â  Â  Â  Â  // 3. Fill Meta Data
Â  Â  Â  Â  document.getElementById("rptStationName").innerText = sData.name.split('(')[0].trim();
Â  Â  Â  Â  document.getElementById("rptLineName").innerText = sData.name.match(/\(([^)]+)\)/)?.[1] || "Blue Line";
Â  Â  Â  Â  document.getElementById("rptDate").innerText = sData.date;
Â  Â  Â  Â  document.getElementById("rptUser").innerText = inspectorName;

Â  Â  Â  Â  // 4. CONDITIONAL SECTION RENDERING
Â  Â  Â  Â  // --- Section A: Station Measurements ---
Â  Â  Â  Â  const secA = document.getElementById("sectionStationDetails");
Â  Â  Â  Â  if(includeStation) {
Â  Â  Â  Â  Â  Â  secA.style.display = "block";
Â  Â  Â  Â  Â  Â  document.getElementById("rptLen").innerText = (sData.len || '-') + " m";
Â  Â  Â  Â  Â  Â  document.getElementById("rptYl").innerText = (sData.yl || '-') + " cm";
Â  Â  Â  Â  Â  Â  document.getElementById("rptTh").innerText = (sData.th || '-') + " cm";
Â  Â  Â  Â  Â  Â  document.getElementById("rptRem").innerText = sData.remarks || '-';
Â  Â  Â  Â  Â  Â  document.getElementById("rptStatus").innerText = sData.impl === "YES" ? "âœ” YES" : "âœ˜ NO";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  secA.style.display = "none"; // Hide Section A title and table
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Section B: Rake Data ---
Â  Â  Â  Â  const secB = document.getElementById("sectionRakeData");
Â  Â  Â  Â  const tbody = document.getElementById("rptRakeBody");
Â  Â  Â  Â  if(includeRake) {
Â  Â  Â  Â  Â  Â  secB.style.display = "block";
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  Â  Â  const rakeKey = sData.linkedRakeKey || currentPrintKey;
Â  Â  Â  Â  Â  Â  const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));

Â  Â  Â  Â  Â  Â  if(rSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(rSnap.val()).forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${count++}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${r.rake || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.type || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.f || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.r || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No Rake Data Found</td></tr>";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  secB.style.display = "none"; // Hide Section B title and table
Â  Â  Â  Â  }

Â  Â  Â  Â  // 5. Show Preview
Â  Â  Â  Â  closePrintModal();
Â  Â  Â  Â  document.getElementById("printableReportContainer").classList.remove("hidden");
Â  Â  Â  Â  window.scrollTo(0,0);

Â  Â  } catch(err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  alert("Error generating report: " + err.message);
Â  Â  }
};
window.closeReportPreview = () => {
Â  Â  document.getElementById("printableReportContainer").classList.add("hidden");
};
// --- ADMIN PIN BYPASS LOGIC ---
window.verifyAdminBypass = async () => {
Â  Â  const enteredPin = document.getElementById("adminPinInput").value;
Â  Â  const statusEl = document.getElementById("faceStatus");

Â  Â  updateStatus("Verifying Admin Authorization...", "orange");

Â  Â  try {
Â  Â  Â  Â  // 1. Fetch Admin PINs (we check against known admin UIDs)
Â  Â  Â  Â  const adminsSnap = await get(ref(db, "users"));
Â  Â  Â  Â  let authorized = false;
Â  Â  Â  Â  let adminName = "";

Â  Â  Â  Â  adminsSnap.forEach(snap => {
Â  Â  Â  Â  Â  Â  const userData = snap.val();
Â  Â  Â  Â  Â  Â  // Check if this user is an Admin AND the PIN matches
Â  Â  Â  Â  Â  Â  if (ADMIN_EMAILS.includes(userData.email) && userData.pin === enteredPin) {
Â  Â  Â  Â  Â  Â  Â  Â  authorized = true;
Â  Â  Â  Â  Â  Â  Â  Â  adminName = userData.name || userData.email;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (authorized) {
Â  Â  Â  Â  Â  Â  // 2. Set Bypass Expiry (Current Time + 5 Minutes)
Â  Â  Â  Â  Â  Â  const expiryTime = Date.now() + (5 * 60 * 1000);
Â  Â  Â  Â  Â  Â  localStorage.setItem("adminBypassExpiry", expiryTime);

Â  Â  Â  Â  Â  Â  updateStatus("âœ… ACCESS GRANTED BY ADMIN", "#00ff00");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Log the bypass event for audit
Â  Â  Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  Â  Â  type: "ADMIN_BYPASS",
Â  Â  Â  Â  Â  Â  Â  Â  user: currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  authorizedBy: adminName,
Â  Â  Â  Â  Â  Â  Â  Â  time: serverTimestamp()
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 4. Enter App
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("âŒ INVALID ADMIN PIN");
Â  Â  Â  Â  Â  Â  updateStatus("Unauthorized PIN Entry", "red");
Â  Â  Â  Â  Â  Â  document.getElementById("adminPinInput").value = "";
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Connection Error during authorization.");
Â  Â  }
};
async function startRealTimeDetection(video, canvas) {
Â  Â  const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
Â  Â  faceapi.matchDimensions(canvas, displaySize);
Â  Â  if (detectionLoop) clearInterval(detectionLoop);
Â  Â  detectionLoop = setInterval(async () => {
Â  Â  Â  Â  if (!stream) return;
Â  Â  Â  Â  const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
Â  Â  Â  Â  const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  if (detection) {
Â  Â  Â  Â  Â  Â  const resizedDetections = faceapi.resizeResults(detection, displaySize);
Â  Â  Â  Â  Â  Â  const box = resizedDetections.detection.box;
Â  Â  Â  Â  Â  Â  const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
Â  Â  Â  Â  Â  Â  drawBox.draw(canvas);
Â  Â  Â  Â  Â  Â  currentDescriptor = detection.descriptor;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  Â  Â  Â  Â  if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  currentDescriptor = null;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  Â  Â  Â  Â  if(btn) btn.style.border = "1px solid #004494";
Â  Â  Â  Â  }
Â  Â  }, 100);
}

function stopCamera() {
Â  Â  if(detectionLoop) clearInterval(detectionLoop);
Â  Â  if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
Â  Â  const vid = document.getElementById("cameraFeed");
Â  Â  const canvas = document.getElementById("overlayCanvas");
Â  Â  if(vid) vid.srcObject = null;
Â  Â  if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  isTransactionAuth = false;
Â  Â  currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }
window.handleFaceScan = async () => {
Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  if (!currentDescriptor) {Â 
Â  Â  Â  Â  updateStatus("âŒ No Face Detected.", "red");Â 
Â  Â  Â  Â  return;Â 
Â  Â  }
Â  Â 
Â  Â  btn.disabled = true;
Â  Â  btn.innerText = "Processing...";
Â  Â  updateStatus("Analyzing Biometrics...", "cyan");

Â  Â  try {
Â  Â  Â  Â  // Fetch Stored Face Data
Â  Â  Â  Â  const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
Â  Â  Â  Â  const storedData = snap.val();
Â  Â  Â  Â  let match = false;

Â  Â  Â  Â  if (storedData) {
Â  Â  Â  Â  Â  Â  const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
Â  Â  Â  Â  Â  Â  for (let s of samples) {
Â  Â  Â  Â  Â  Â  Â  Â  // Biometric Threshold: 0.55 (Lower is stricter)
Â  Â  Â  Â  Â  Â  Â  Â  if (faceapi.euclideanDistance(s, currentDescriptor) < 0.55) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  match = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  updateStatus("âœ… IDENTITY CONFIRMED", "#00ff00");
Â  Â  Â  Â  Â  Â  failCount = 0; // Reset fails on success
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (scanMode === 'RECEIVER') {
Â  Â  Â  Â  Â  Â  Â  Â  receiverVerified = true;
Â  Â  Â  Â  Â  Â  Â  Â  stopCamera();
Â  Â  Â  Â  Â  Â  Â  Â  // Custom logic for inventory transactions
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(currentTransactionType === 'CHECKOUT' ? "btn_checkout_verify" : "btn_return_verify").classList.add("hidden");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await recordLogin("Biometric");
Â  Â  Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Trigger the 3-fail security lockout
Â  Â  Â  Â  Â  Â  handleFail();Â 
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.innerText = "ğŸ“¸ Retry Scan";
Â  Â  Â  Â  }

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  updateStatus("âŒ System Error", "red");
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }
};

// --- THE ADMIN BYPASS FUNCTION ---
window.verifyAdminBypass = async () => {
Â  Â  const enteredPin = document.getElementById("adminPinInput").value;
Â  Â  updateStatus("Verifying Admin PIN...", "orange");

Â  Â  try {
Â  Â  Â  Â  const usersSnap = await get(ref(db, "users"));
Â  Â  Â  Â  let authorized = false;
Â  Â  Â  Â  let adminName = "";

Â  Â  Â  Â  usersSnap.forEach(s => {
Â  Â  Â  Â  Â  Â  const u = s.val();
Â  Â  Â  Â  Â  Â  // Check if user is in ADMIN_EMAILS and PIN matches
Â  Â  Â  Â  Â  Â  if (ADMIN_EMAILS.includes(u.email) && u.pin === enteredPin) {
Â  Â  Â  Â  Â  Â  Â  Â  authorized = true;
Â  Â  Â  Â  Â  Â  Â  Â  adminName = u.name || u.email;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (authorized) {
Â  Â  Â  Â  Â  Â  // VALID FOR 5 MINUTES (300,000 ms)
Â  Â  Â  Â  Â  Â  const expiry = Date.now() + (5 * 60 * 1000);
Â  Â  Â  Â  Â  Â  localStorage.setItem("adminBypassExpiry", expiry);

Â  Â  Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  Â  Â  type: "ADMIN_BYPASS",
Â  Â  Â  Â  Â  Â  Â  Â  user: currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  authorizedBy: adminName,
Â  Â  Â  Â  Â  Â  Â  Â  time: serverTimestamp()
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  updateStatus("âœ… BYPASS AUTHORIZED", "#00ff00");
Â  Â  Â  Â  Â  Â  setTimeout(enterApp, 1000);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("âŒ INVALID ADMIN PIN");
Â  Â  Â  Â  Â  Â  document.getElementById("adminPinInput").value = "";
Â  Â  Â  Â  }
Â  Â  } catch (e) { alert("Auth Failed"); }
};

window.registerNewFace = async () => {
Â  Â  if(!currentDescriptor) { updateStatus("âŒ Camera cannot see face clearly.", "orange"); return; }
Â  Â  regSamples.push(Array.from(currentDescriptor));
Â  Â  const count = regSamples.length;
Â  Â  updateRegDots(count);
Â  Â  if(count < 3) {
Â  Â  Â  Â  updateStatus(`âœ… Sample ${count}/3 Captured.`, "lightgreen");
Â  Â  Â  Â  document.getElementById("btnCapture").innerText = `ğŸ“¸ Capture Sample ${count + 1} of 3`;
Â  Â  } else {
Â  Â  Â  Â  updateStatus("ğŸ’¾ Saving...", "yellow");
Â  Â  Â  Â  await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
Â  Â  Â  Â  alert("Registration Complete!"); location.reload();
Â  Â  }
};
window.loadStationData = () => {
Â  Â  // 1. Make sure the panel is visible!
Â  Â  document.getElementById("logResultsPanel").classList.remove("hidden");Â 
Â  Â  document.getElementById("logTableTitle").innerText = "Recent Station Logs (All)";

Â  Â  const tbody = document.getElementById("stationDataViewBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;'>Loading Station Logs...</td></tr>";

Â  Â  // FETCH FROM "station_logs"
Â  Â  const q = query(ref(db, "station_logs"), limitToLast(50));

Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;'>No data found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse();Â 

Â  Â  Â  Â  tbody.innerHTML = "";

Â  Â  Â  Â  logs.forEach(d => {
Â  Â  Â  Â  Â  Â  // Updated View Button to use the correct modal function
Â  Â  Â  Â  Â  Â  const rowButton = `<button class="info" onclick="fetchAndShowRakes('${d.key}')" style="padding:4px 8px; font-size:11px;">ğŸ“„ View Table</button>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let deleteBtn = "";
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn = `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:4px 8px; font-size:11px; margin-left:5px;">ğŸ—‘</button>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  <tr class="station-row-item">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${d.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:#003366;">${d.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.userName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">L: ${d.len || '-'} | YL: ${d.yl || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-style:italic; color:#555;">${d.remarks || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${rowButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${deleteBtn}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += html;
Â  Â  Â  Â  });
Â  Â  }, { onlyOnce: true });
};
window.deleteStationLog = async (key) => {
Â  Â  if (!isAdmin) return alert("Access Denied: Admins Only.");

Â  Â  try {
Â  Â  Â  Â  // 1. Check if Rake Data exists for this entry
Â  Â  Â  Â  const rakeSnap = await get(ref(db, `rake_logs/${key}`));
Â  Â  Â  Â  const hasRakeData = rakeSnap.exists();

Â  Â  Â  Â  if (hasRakeData) {
Â  Â  Â  Â  Â  Â  // --- SCENARIO A: Rake Data Exists (PROTECT IT) ---
Â  Â  Â  Â  Â  Â  if (confirm(
Â  Â  Â  Â  Â  Â  Â  Â  "âš ï¸ SAFETY ALERT\n\n" +
Â  Â  Â  Â  Â  Â  Â  Â  "This record contains Distance/Rake Data (Table 2).\n" +
Â  Â  Â  Â  Â  Â  Â  Â  "We cannot delete the entire row, or you will lose access to Table 2.\n\n" +
Â  Â  Â  Â  Â  Â  Â  Â  "Click OK to CLEAR the Yellow Line details only (Length, Dist, etc).\n" +
Â  Â  Â  Â  Â  Â  Â  Â  "The row will remain visible."
Â  Â  Â  Â  Â  Â  )) {
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  Â  Â  Â  Â  updates[`station_logs/${key}/len`] = null;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`station_logs/${key}/yl`] = null;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`station_logs/${key}/th`] = null;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`station_logs/${key}/remarks`] = "(Details Cleared)";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  Â  Â  Â  Â  alert("âœ… Yellow Line details cleared. Distance Data saved.");
Â  Â  Â  Â  Â  Â  Â  Â  loadSpecificStationData(); // Refresh
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // --- SCENARIO B: No Rake Data (SAFE TO DELETE) ---
Â  Â  Â  Â  Â  Â  if (confirm("âš  This record is empty. Delete row permanently?")) {
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  Â  Â  Â  Â  updates[`station_logs/${key}`] = null;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`rake_logs/${key}`] = null; // Cleanup
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  Â  Â  Â  Â  alert("âœ… Record deleted.");
Â  Â  Â  Â  Â  Â  Â  Â  loadSpecificStationData(); // Refresh
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  }
};
// --- VIEW RAKE ROWS (POPUP) ---
window.viewRakeRows = (rowsEncoded, stationName) => {
Â  Â  try {
Â  Â  Â  Â  const rows = JSON.parse(decodeURIComponent(rowsEncoded));
Â  Â  Â  Â  let msg = `DETAILS FOR: ${stationName}\n\n`;
Â  Â  Â  Â  msg += `SL | RAKE | TYPE | FRONT | REAR\n`;
Â  Â  Â  Â  msg += `--------------------------------\n`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Loop through the rows object
Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â  for (let key in rows) {
Â  Â  Â  Â  Â  Â  let r = rows[key];
Â  Â  Â  Â  Â  Â  msg += `${count}. ${r.rake || '-'} | ${r.type || '-'} | ${r.f || '-'} | ${r.r || '-'}\n`;
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  }
Â  Â  Â  Â  alert(msg);
Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Error reading row data.");
Â  Â  }
};

// --- SEARCH FILTER ---
window.filterStationData = () => {
Â  Â  const input = document.getElementById("stationLogSearch").value.toLowerCase();
Â  Â  const rows = document.getElementsByClassName("station-row-item");
Â  Â Â 
Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  const stationName = row.cells[1].innerText.toLowerCase(); // Search Station Name
Â  Â  Â  Â  const submittedBy = row.cells[2].innerText.toLowerCase(); // Search User Name
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (stationName.includes(input) || submittedBy.includes(input)) {
Â  Â  Â  Â  Â  Â  row.style.display = "";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  row.style.display = "none";
Â  Â  Â  Â  }
Â  Â  });
};
function handleFail() {
Â  Â  failCount++;
Â  Â  if(failCount >= 3) {
Â  Â  Â  Â  stopCamera();
Â  Â  Â  Â  document.getElementById("faceModal").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("videoContainer").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("camControls").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("otpUI").classList.remove("hidden");
Â  Â  Â  Â  updateStatus("âš ï¸ Camera Disabled. Enter PIN.", "red");
Â  Â  } else {
Â  Â  Â  Â  updateStatus(`âŒ Failed. Attempts left: ${3 - failCount}`, "orange");
Â  Â  }
}

window.verifyOTP = () => {
Â  Â  const input = document.getElementById("otpInput").value;
Â  Â  get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
Â  Â  Â  Â  const actualPin = snap.val() || "1234";
Â  Â  Â  Â  if(input === actualPin) {
Â  Â  Â  Â  Â  Â  await recordLogin("PIN Entry");
Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("Wrong PIN âŒ");
Â  Â  Â  Â  }
Â  Â  });
}

function enterApp() {
Â  Â  stopCamera();
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  document.getElementById("appScreen").classList.remove("hidden");
Â  Â Â 
Â  Â  // Load Tabs
Â  Â  switchTab('newData');
Â  Â  loadDraft();Â 
Â  Â  loadGallery();Â 
Â  Â  loadInventory();Â 
Â  Â  loadAssignments();

Â  Â  // --- FIX: START THE TIMER NOW ---
Â  Â  setupIdleTimer();Â 
}
// --- FIXED TOGGLE FUNCTION (Crash-Free for Checkout & Return) ---
window.toggleInvMode = (mode) => {
Â  Â  // 1. Hide All Panels
Â  Â  document.getElementById("inv-add").classList.add("hidden");
Â  Â  document.getElementById("inv-checkout").classList.add("hidden");
Â  Â  document.getElementById("inv-return").classList.add("hidden");
Â  Â  document.getElementById("inv-history").classList.add("hidden");
Â  Â  document.getElementById("inv-list").classList.add("hidden");
Â  Â Â 
Â  Â  // 2. Show the Selected Panel
Â  Â  const targetPanel = document.getElementById(`inv-${mode}`);
Â  Â  if(targetPanel) targetPanel.classList.remove("hidden");
Â  Â Â 
Â  Â  // 3. (REMOVED) Old Dropdown Logic
Â  Â  // We strictly removed the calls to 'populateCheckoutSelect'Â 
Â  Â  // and 'populateReturnSelect' here.Â 
Â  Â  // This stops the "innerHTML of null" error completely.

Â  Â  // 4. Special Focus Logic for History Tab
Â  Â  if(mode === 'history') {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â const searchInput = document.getElementById("auditSearchInput");
Â  Â  Â  Â  Â  Â  Â if(searchInput) searchInput.focus();
Â  Â  Â  Â  }, 100);
Â  Â  }
};
// 1. POPULATE CHECKOUT (Show All Items)
function populateCheckoutSelect() {
Â  Â  const sel = document.getElementById("checkoutSelect");
Â  Â  sel.innerHTML = "<option value=''>Loading...</option>";
Â  Â  onValue(ref(db, "inventory"), snap => {
Â  Â  Â  Â  sel.innerHTML = "<option value=''>Select Item...</option>";
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = c.key;
Â  Â  Â  Â  Â  Â  opt.text = `${v.item} (Avail: ${v.qty})`;
Â  Â  Â  Â  Â  Â  opt.dataset.qty = v.qty;
Â  Â  Â  Â  Â  Â  opt.dataset.name = v.item;
Â  Â  Â  Â  Â  Â  // NEW: STORE BARCODE
Â  Â  Â  Â  Â  Â  if(v.barcode) opt.dataset.barcode = v.barcode;
Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  }, { onlyOnce: true });
}

// 2. POPULATE RETURN (Show Only Items You Hold)
async function populateReturnSelect() {
Â  Â  const sel = document.getElementById("returnSelect");
Â  Â  sel.innerHTML = "<option value=''>Calculating your holdings...</option>";

Â  Â  try {
Â  Â  Â  Â  // A. Get current Inventory (for keys)
Â  Â  Â  Â  const invSnap = await get(ref(db, "inventory"));
Â  Â  Â  Â  const inventoryMap = {}; // Maps ItemName -> { key, exists, barcode }
Â  Â  Â  Â  invSnap.forEach(c => {
Â  Â  Â  Â  Â  Â  const val = c.val();
Â  Â  Â  Â  Â  Â  inventoryMap[val.item] = { key: c.key, exists: true, barcode: val.barcode };
Â  Â  Â  Â  });

Â  Â  Â  Â  // B. Get User Logs
Â  Â  Â  Â  const logsSnap = await get(query(ref(db, "logs")));
Â  Â  Â  Â  const myHoldings = {}; // ItemName -> NetQuantity

Â  Â  Â  Â  logsSnap.forEach(c => {
Â  Â  Â  Â  Â  Â  const l = c.val();
Â  Â  Â  Â  Â  Â  // Check if this log belongs to current user
Â  Â  Â  Â  Â  Â  const isMe = (l.takenBy === currentUser.name) || (l.takenBy === currentUser.email);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (isMe) {
Â  Â  Â  Â  Â  Â  Â  Â  if(l.type === 'CHECKOUT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myHoldings[l.item] = (myHoldings[l.item] || 0) + parseInt(l.qty);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (l.type === 'RETURN') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myHoldings[l.item] = (myHoldings[l.item] || 0) - parseInt(l.qty);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // C. Render
Â  Â  Â  Â  sel.innerHTML = "<option value=''>Select Item...</option>";
Â  Â  Â  Â  let foundAny = false;

Â  Â  Â  Â  for (const [itemName, netQty] of Object.entries(myHoldings)) {
Â  Â  Â  Â  Â  Â  if (netQty > 0 && inventoryMap[itemName]) {
Â  Â  Â  Â  Â  Â  Â  Â  foundAny = true;
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = inventoryMap[itemName].key; // Use inventory key for update
Â  Â  Â  Â  Â  Â  Â  Â  opt.text = `${itemName} (You have: ${netQty})`;
Â  Â  Â  Â  Â  Â  Â  Â  opt.dataset.qty = netQty; // Max returnable
Â  Â  Â  Â  Â  Â  Â  Â  opt.dataset.name = itemName;
Â  Â  Â  Â  Â  Â  Â  Â  // NEW: STORE BARCODE
Â  Â  Â  Â  Â  Â  Â  Â  if(inventoryMap[itemName].barcode) opt.dataset.barcode = inventoryMap[itemName].barcode;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(!foundAny) {
Â  Â  Â  Â  Â  Â  sel.innerHTML = "<option value=''>No items to return.</option>";
Â  Â  Â  Â  }

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  sel.innerHTML = "<option>Error loading.</option>";
Â  Â  }
}

window.updateMaxQty = () => {
Â  Â  const isCheckout = !document.getElementById("inv-checkout").classList.contains("hidden");
Â  Â  const selId = isCheckout ? "checkoutSelect" : "returnSelect";
Â  Â  const inpId = isCheckout ? "checkoutAvail" : "returnAvail";
Â  Â 
Â  Â  const sel = document.getElementById(selId);
Â  Â  const opt = sel.options[sel.selectedIndex];
Â  Â 
Â  Â  if(opt && opt.dataset.qty) {
Â  Â  Â  Â  document.getElementById(inpId).value = opt.dataset.qty;
Â  Â  } else {
Â  Â  Â  Â  document.getElementById(inpId).value = "";
Â  Â  }
};

// --- NEW HISTORY LOADING LOGIC (FIXED) ---

function formatTime(ts) {
Â  Â  if (!ts) return "N/A";
Â  Â  const d = new Date(ts);
Â  Â Â 
Â  Â  // Convert to Indian Standard Time (Asia/Kolkata)
Â  Â  return d.toLocaleString('en-IN', {Â 
Â  Â  Â  Â  timeZone: 'Asia/Kolkata',
Â  Â  Â  Â  day: '2-digit',Â 
Â  Â  Â  Â  month: '2-digit',Â 
Â  Â  Â  Â  year: 'numeric',Â 
Â  Â  Â  Â  hour: '2-digit',Â 
Â  Â  Â  Â  minute: '2-digit',
Â  Â  Â  Â  hour12: trueÂ 
Â  Â  });
}
// --- LINEAR HISTORY LOGIC (SIMPLE LIST + BARCODES) ---
window.loadInventoryHistory = () => {
Â  Â  const tbody = document.getElementById("invHistoryBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Retrieving Secure Records...</td></tr>";

Â  Â  // Fetch last 300 logs
Â  Â  const q = query(ref(db, "logs"), limitToLast(300));
Â  Â Â 
Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse(); // Show newest events at the top

Â  Â  Â  Â  // Filter: Show only inventory-related events
Â  Â  Â  Â  const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE');

Â  Â  Â  Â  if(invLogs.length === 0) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded in recent history.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  invLogs.forEach(l => {
Â  Â  Â  Â  Â  Â  // Badge Styling
Â  Â  Â  Â  Â  Â  let badge = "";
Â  Â  Â  Â  Â  Â  if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">ğŸ“¤ OUT</span>`;
Â  Â  Â  Â  Â  Â  else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">ğŸ“¥ IN</span>`;
Â  Â  Â  Â  Â  Â  else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">â• ADD</span>`;

Â  Â  Â  Â  Â  Â  // Barcode formatting
Â  Â  Â  Â  Â  Â  const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px;">||| ${l.barcode}</div>` : '';

Â  Â  Â  Â  Â  Â  // Row HTML
Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:#003366;">${l.barcode || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${l.takenBy || 'Unknown'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${formatTime(l.time)}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:#555;">Auth: ${l.approvedBy || 'System'}</small>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${badge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:13px;">${l.item}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  });
Â  Â  }, { onlyOnce: true });
};
// --- NEW SEARCH FUNCTION FOR INVENTORY ---
window.filterInvLogs = () => {
Â  Â  const input = document.getElementById("invSearch").value.toLowerCase();
Â  Â  const rows = document.getElementsByClassName("inv-log-row");
Â  Â 
Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  const text = row.innerText.toLowerCase();
Â  Â  Â  Â  row.style.display = text.includes(input) ? "" : "none";
Â  Â  });
};
// --- UPDATED SUBMIT FUNCTION (COMBINED LOCATION LOGIC) ---
window.submitTransactionNoFace = (type) => {
Â  Â  if(!pendingTransactionItem) return alert("Please SCAN an item first.");
Â  Â Â 
Â  Â  // --- CHECKOUT VALIDATION ---
Â  Â  if(type === 'CHECKOUT') {
Â  Â  Â  Â  const purpose = document.getElementById("checkoutPurpose").value;
Â  Â  Â  Â  if(!purpose || purpose.trim() === "") return alert("Please enter the PURPOSE for this checkout.");
Â  Â  }
Â  Â Â 
Â  Â  // --- RETURN VALIDATION & FORMATTING ---
Â  Â  let finalLocation = "";
Â  Â Â 
Â  Â  if(type === 'RETURN') {
Â  Â  Â  Â  // 1. Get Main Place
Â  Â  Â  Â  const selection = document.getElementById("returnLocSelect").value;
Â  Â  Â  Â  let mainPlace = selection;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(selection === "Other") {
Â  Â  Â  Â  Â  Â  const otherText = document.getElementById("returnLocOther").value.trim();
Â  Â  Â  Â  Â  Â  if(!otherText) return alert("Please specify the 'Other' location name.");
Â  Â  Â  Â  Â  Â  mainPlace = otherText;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Get Specific Spot (Cabinet/Almirah)
Â  Â  Â  Â  const spot = document.getElementById("returnLocSpot").value.trim();
Â  Â  Â  Â  if(!spot) return alert("Please specify the Exact Spot (e.g., Cabinet, Almirah).");

Â  Â  Â  Â  // 3. Combine them
Â  Â  Â  Â  // Format: "D2 Building - Heerok Sir Lab [Upper Cabinet]"
Â  Â  Â  Â  finalLocation = `${mainPlace} [${spot}]`;
Â  Â  }

Â  Â  scanMode = 'DIRECT';Â 
Â  Â  currentTransactionType = type;
Â  Â Â 
Â  Â  // Pass the calculated location to the processor
Â  Â  processTransaction("Self/System", finalLocation);
};
// --- UPDATED TRANSACTION LOGIC ---
// --- UPDATED PROCESSOR TO ACCEPT LOCATION ARGUMENT ---
async function processTransaction(adminName, customReturnLocation = null) {
Â  Â  const isCheckout = currentTransactionType === 'CHECKOUT';
Â  Â Â 
Â  Â  if(!pendingTransactionItem) return alert("System Error: No item scanned.");

Â  Â  const itemKey = pendingTransactionItem.key;
Â  Â  const itemName = pendingTransactionItem.item;
Â  Â  const barcode = pendingTransactionItem.barcode;

Â  Â  // Get Checkout Purpose (if applicable)
Â  Â  const purposeInput = isCheckout ? document.getElementById("checkoutPurpose").value : null;

Â  Â  // 1. Fetch Fresh Data
Â  Â  const invRef = ref(db, `inventory/${itemKey}`);
Â  Â  const invSnap = await get(invRef);
Â  Â Â 
Â  Â  if(!invSnap.exists()) return alert("Item vanished from DB.");
Â  Â Â 
Â  Â  const val = invSnap.val();
Â  Â  const currentStatus = val.status;
Â  Â  const currentUsage = val.usageCount || 0;Â 

Â  Â  // 2. Logic Gates
Â  Â  if(isCheckout && currentStatus === 'Checked Out') return alert(`Item already taken by: ${val.holder}`);
Â  Â  if(!isCheckout && currentStatus === 'In Stock') return alert(`Item is already in the store.`);

Â  Â  // 3. Prepare Update Data
Â  Â  const uSnap = await get(ref(db, `users/${currentUser.uid}`));
Â  Â  const realUserName = uSnap.val()?.name || currentUser.email;

Â  Â  let updateData = {};

Â  Â  if (isCheckout) {
Â  Â  Â  Â  // CHECKOUT
Â  Â  Â  Â  updateData = {
Â  Â  Â  Â  Â  Â  status: "Checked Out",
Â  Â  Â  Â  Â  Â  holder: realUserName,
Â  Â  Â  Â  Â  Â  purpose: purposeInput,
Â  Â  Â  Â  Â  Â  location: "Out with User",Â 
Â  Â  Â  Â  Â  Â  usageCount: currentUsage + 1Â 
Â  Â  Â  Â  };
Â  Â  } else {
Â  Â  Â  Â  // RETURN - USE THE CUSTOM LOCATION WE BUILT
Â  Â  Â  Â  updateData = {
Â  Â  Â  Â  Â  Â  status: "In Stock",
Â  Â  Â  Â  Â  Â  holder: "Store",
Â  Â  Â  Â  Â  Â  purpose: null,
Â  Â  Â  Â  Â  Â  location: customReturnLocation // Saves "D2 Lab [Cabinet]"
Â  Â  Â  Â  };
Â  Â  }

Â  Â  // 4. Update Database
Â  Â  await update(invRef, updateData);

Â  Â  // 5. Log It
Â  Â  const logData = {
Â  Â  Â  Â  type: currentTransactionType,
Â  Â  Â  Â  item: itemName,
Â  Â  Â  Â  barcode: barcode,
Â  Â  Â  Â  qty: 1,
Â  Â  Â  Â  takenBy: realUserName,
Â  Â  Â  Â  approvedBy: "Direct (No Admin)",
Â  Â  Â  Â  location: isCheckout ? "Out" : customReturnLocation,Â 
Â  Â  Â  Â  purpose: isCheckout ? purposeInput : "Return",
Â  Â  Â  Â  time: serverTimestamp()
Â  Â  };

Â  Â  await push(ref(db, "logs"), logData);
Â  Â Â 
Â  Â  alert(`âœ… ${currentTransactionType} Successful!\nItem: ${itemName}`);
Â  Â Â 
Â  Â  // Clear Inputs
Â  Â  if(document.getElementById("checkoutPurpose")) document.getElementById("checkoutPurpose").value = "";
Â  Â  if(document.getElementById("returnLocOther")) document.getElementById("returnLocOther").value = "";
Â  Â  if(document.getElementById("returnLocSpot")) document.getElementById("returnLocSpot").value = "";

Â  Â  // UI Cleanup
Â  Â  document.getElementById("checkout_display").classList.add("hidden");
Â  Â  document.getElementById("return_display").classList.add("hidden");
Â  Â  pendingTransactionItem = null;
Â  Â  toggleInvMode('list');
}
// --- NEW HELPER: POPULATE USER DROPDOWN ---
window.populateUserDropdown = async () => {
Â  Â  const sel = document.getElementById("selPrintInspector");
Â  Â Â 
Â  Â  // 1. Reset with "Self" option (Convenience)
Â  Â  const currentName = currentUser.name || currentUser.email;
Â  Â  sel.innerHTML = `<option value="">-- Select Member --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Self">Self (${currentName})</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <optgroup label="All Registered Users:">`;

Â  Â  // 2. Fetch all users from DB
Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "users"));
Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const u = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  const uName = u.name || u.email; // Use email if name is missing
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Add to dropdown
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = uName;
Â  Â  Â  Â  Â  Â  Â  Â  opt.innerText = uName;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error loading users:", e);
Â  Â  Â  Â  sel.innerHTML += `<option disabled>Error loading users</option>`;
Â  Â  }
};
window.saveStationDetails = () => {
Â  Â  const name = document.getElementById("inpStationName").value.trim();
Â  Â  if(!name) return alert("Station Name Required");
Â  Â  update(ref(db, `drafts/${currentUser.uid}/details`), {
Â  Â  Â  Â  name: name,
Â  Â  Â  Â  len: document.getElementById("inpStationLength").value,
Â  Â  Â  Â  yl: document.getElementById("inpYellowDist").value,
Â  Â  Â  Â  th: document.getElementById("inpYellowThick").value,
Â  Â  Â  Â  remarks: document.getElementById("inpRemarks").value
Â  Â  });
Â  Â  alert("Draft Saved");
};
// --- 1. HANDLE LOG LINE CHANGE (Populate Station Dropdown) ---
window.handleLogLineChange = () => {
Â  Â  const lineSel = document.getElementById("logLineSelect");
Â  Â  const stnSel = document.getElementById("logStationSelect");
Â  Â  const resultsDiv = document.getElementById("logResultsPanel");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  resultsDiv.classList.add("hidden");

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  // Populate Stations using the existing METRO_STATIONS data
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};
window.loadSpecificStationData = async () => {
Â  Â  const stnSel = document.getElementById("logStationSelect");
Â  Â  const lineSel = document.getElementById("logLineSelect");
Â  Â  const resultsDiv = document.getElementById("logResultsPanel");
Â  Â  const body1 = document.getElementById("viewTable1Body");
Â  Â  const body2 = document.getElementById("viewTable2Body");

Â  Â  if (!stnSel.value) return;

Â  Â  const searchName = `${stnSel.value} (${lineSel.value})`;
Â  Â  resultsDiv.classList.remove("hidden");
Â  Â  body1.innerHTML = "<tr><td colspan='8' style='text-align:center;'>ğŸ” Searching All Records...</td></tr>";
Â  Â  body2.innerHTML = "";

Â  Â  try {
Â  Â  Â  Â  // 1. Fetch all logs
Â  Â  Â  Â  const snap = await get(ref(db, "station_logs"));
Â  Â  Â  Â  body1.innerHTML = "";Â 

Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  body1.innerHTML = "<tr><td colspan='8'>No records in database.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let foundCount = 0;

Â  Â  Â  Â  // 2. Loop through every log to find ALL matches for "Park Street" or "Uttam Kumar"
Â  Â  Â  Â  snap.forEach(child => {
Â  Â  Â  Â  Â  Â  const d = child.val();
Â  Â  Â  Â  Â  Â  const logKey = child.key;

Â  Â  Â  Â  Â  Â  if (d.name === searchName) {
Â  Â  Â  Â  Â  Â  Â  Â  foundCount++;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Determine row style (Highlight the most recent one)
Â  Â  Â  Â  Â  Â  Â  Â  const rowStyle = foundCount === 1 ? "background:#e8f4ff; font-weight:bold;" : "";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="${rowStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.userName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.len || '-'} m</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:red;">${d.yl || '-'} cm</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.th || '-'} cm</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.impl || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">${d.remarks || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="loadRakeTable('${logKey}')" class="info" style="padding:2px 6px;">ğŸ‘ï¸ View Rakes</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdmin ? `<button class="danger" onclick="deleteStationLog('${logKey}')" style="padding:2px 6px;">ğŸ—‘</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Use prepend so newest records appear at the top
Â  Â  Â  Â  Â  Â  Â  Â  body1.insertAdjacentHTML('afterbegin', row);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (foundCount === 0) {
Â  Â  Â  Â  Â  Â  body1.innerHTML = `<tr><td colspan='8' style='text-align:center; color:red;'>No data found for ${searchName}.</td></tr>`;
Â  Â  Â  Â  }

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  body1.innerHTML = "<tr><td colspan='8'>Error loading logs.</td></tr>";
Â  Â  }
};
window.editStationLog = async (key) => {
Â  Â  if (!confirm("âœï¸ Edit this record?")) return;

Â  Â  try {
Â  Â  Â  Â  // 1. Fetch Station Data
Â  Â  Â  Â  const stationSnap = await get(ref(db, `station_logs/${key}`));
Â  Â  Â  Â  if (!stationSnap.exists()) return alert("Record not found.");
Â  Â  Â  Â  const sData = stationSnap.val();

Â  Â  Â  Â  // 2. Set Global Editing Keys
Â  Â  Â  Â  currentStationKey = key;
Â  Â  Â  Â  currentRakeKey = sData.linkedRakeKey || key;

Â  Â  Â  Â  // 3. CLEAN UP DRAFTS (Fixes the "Double Rows" bug)
Â  Â  Â  Â  // We wipe the draft folder clean before loading data
Â  Â  Â  Â  await remove(ref(db, `drafts/${currentUser.uid}`));
Â  Â  Â  Â  document.getElementById("distanceBody").innerHTML = "";

Â  Â  Â  Â  // 4. Switch to Form Tab
Â  Â  Â  Â  switchTab('newData');
Â  Â  Â  Â  document.getElementById("mainDataForm").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("dataExistsWarning").classList.add("hidden"); // Hide the "Locked" warning

Â  Â  Â  Â  // 5. Fill Station Details & UNLOCK THEM
Â  Â  Â  Â  document.getElementById("inpStationName").value = sData.name;
Â  Â  Â  Â  document.getElementById("formTitle").innerText = `âœï¸ EDITING: ${sData.name}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const inpLen = document.getElementById("inpStationLength");
Â  Â  Â  Â  const inpYl = document.getElementById("inpYellowDist");
Â  Â  Â  Â  const inpTh = document.getElementById("inpYellowThick");
Â  Â  Â  Â  const inpRem = document.getElementById("inpRemarks");
Â  Â  Â  Â  const inpImpl = document.getElementById("inpImplementation");

Â  Â  Â  Â  inpLen.value = sData.len || "";
Â  Â  Â  Â  inpYl.value = sData.yl || "";
Â  Â  Â  Â  inpTh.value = sData.th || "";
Â  Â  Â  Â  inpRem.value = sData.remarks || "";
Â  Â  Â  Â  inpImpl.value = sData.impl || "";

Â  Â  Â  Â  // Unlock inputs so you can edit Yellow Line details
Â  Â  Â  Â  inpLen.disabled = false;
Â  Â  Â  Â  inpYl.disabled = false;
Â  Â  Â  Â  inpTh.disabled = false;
Â  Â  Â  Â  inpRem.disabled = false;
Â  Â  Â  Â  inpImpl.disabled = false;
Â  Â  Â  Â  document.getElementById("btnSaveDraft").disabled = false;

Â  Â  Â  Â  // 6. Update Submit Button
Â  Â  Â  Â  const submitBtn = document.getElementById("btnFinalSubmit");
Â  Â  Â  Â  submitBtn.innerText = "ğŸ’¾ Save Changes";
Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  submitBtn.style.background = "#ffc107"; // Orange
Â  Â  Â  Â  submitBtn.style.color = "#000";
Â  Â  Â  Â  submitBtn.style.cursor = "pointer";

Â  Â  Â  Â  // 7. Load Rake Data (Exactly as it is in DB)
Â  Â  Â  Â  const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
Â  Â  Â  Â  if (rakeSnap.exists()) {
Â  Â  Â  Â  Â  Â  // Copy exact DB rows to Drafts
Â  Â  Â  Â  Â  Â  await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
Â  Â  Â  Â  }

Â  Â  Â  Â  // 8. Render Table
Â  Â  Â  Â  loadDraft();

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Error loading for edit: " + e.message);
Â  Â  }
};
window.loadRakeTable = async (key) => {
Â  Â  const body2 = document.getElementById("viewTable2Body");
Â  Â  const delAllBtn = document.getElementById("btnDeleteAllRakes"); // Get the button
Â  Â Â 
Â  Â  // Define the trigger function globally so the HTML button can use the current 'key'
Â  Â  window.triggerDeleteAll = () => deleteAllRakeData(key);

Â  Â  body2.innerHTML = "<tr><td colspan='6' style='text-align:center;'>â³ Loading details...</td></tr>";
Â  Â  if(delAllBtn) delAllBtn.style.display = "none"; // Hide button while loading

Â  Â  try {
Â  Â  Â  Â  const snap2 = await get(ref(db, `rake_logs/${key}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!snap2.exists()) {
Â  Â  Â  Â  Â  Â  body2.innerHTML = "<tr><td colspan='6' style='text-align:center; color:#777;'>âŒ No distance data found.</td></tr>";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  body2.innerHTML = "";Â 
Â  Â  Â  Â  Â  Â  if(isAdmin && delAllBtn) delAllBtn.style.display = "block"; // Show button if data exists and is Admin

Â  Â  Â  Â  Â  Â  const rows = snap2.val();
Â  Â  Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Object.entries(rows).forEach(([rKey, r]) => {
Â  Â  Â  Â  Â  Â  Â  Â  // ... (Existing row rendering code) ...
Â  Â  Â  Â  Â  Â  Â  Â  const actionHtml = isAdminÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<button class="danger" onclick="deleteRakeRow('${key}', '${rKey}')" style="padding:2px 6px; font-size:11px;">ğŸ—‘</button>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<span style="color:green; font-size:10px;">âœ” Saved</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  const rRow = `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${count++}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${r.rake || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.type || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.f || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.r || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${actionHtml}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  body2.innerHTML += rRow;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  body2.innerHTML = `<tr><td colspan='6' style='color:red'>Error: ${e.message}</td></tr>`;
Â  Â  }
};
// --- 2. FETCH RAKES (Populate Table 2 in Modal) ---
window.fetchAndShowRakes = async (key) => {
Â  Â  if(!key) return alert("Error: No Record ID found.");

Â  Â  // Open Modal and Show Loading
Â  Â  document.getElementById("rakeDataModal").classList.remove("hidden");
Â  Â  const tbody = document.getElementById("modalRakeBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>â³ Fetching Rake Data...</td></tr>";

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, `rake_logs/${key}`));

Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>No rake data found for this entry.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const rows = snap.val();
Â  Â  Â  Â  tbody.innerHTML = ""; // Clear loading message

Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â  for (let rKey in rows) {
Â  Â  Â  Â  Â  Â  let r = rows[rKey];
Â  Â  Â  Â  Â  Â  // Render the Separate Rake Table
Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${count}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${r.rake || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.type || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.f || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.r || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.act || '-'}</td>Â 
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  }

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
Â  Â  }
};

// --- 3. CLOSE MODAL ---
window.closeRakeModal = () => {
Â  Â  document.getElementById("rakeDataModal").classList.add("hidden");
};
Â  window.deleteAllRakeData = async (key) => {
Â  Â  if (!isAdmin) return alert("Access Denied: Admins Only.");

Â  Â  if (confirm("âš  WARNING: Delete ALL Distance/Rake data for this station?\n\n(Table 1 Station Details will remain safe).")) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Only remove the rake_logs entry
Â  Â  Â  Â  Â  Â  await remove(ref(db, `rake_logs/${key}`));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  alert("âœ… Distance Data Cleared.");
Â  Â  Â  Â  Â  Â  loadRakeTable(key); // Refresh Table 2 (It will now be empty)

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};
window.deleteRakeRow = async (stationLogKey, rowKey) => {
Â  Â  if(confirm("âš  Delete this single row?")) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Remove specific child in rake_logs
Â  Â  Â  Â  Â  Â  await remove(ref(db, `rake_logs/${stationLogKey}/${rowKey}`));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Refresh Table 2
Â  Â  Â  Â  Â  Â  loadRakeTable(stationLogKey);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};
window.uploadEvidenceOnly = () => {
Â  Â  if(!currentFileBase64) return alert("Select a file first.");
Â  Â 
Â  Â  if(confirm("Upload Evidence?")) {
Â  Â  Â  Â  push(ref(db, "history"), {
Â  Â  Â  Â  Â  Â  name: "Evidence Upload",
Â  Â  Â  Â  Â  Â  user: currentUser.email,
Â  Â  Â  Â  Â  Â  userName: currentUser.name,
Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString(),
Â  Â  Â  Â  Â  Â  fileData: currentFileBase64,
Â  Â  Â  Â  Â  Â  fileType: currentFileType
Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  document.getElementById("evidenceFile").value = "";
Â  Â  Â  Â  Â  Â  document.getElementById("fileStatus").innerText = "";
Â  Â  Â  Â  Â  Â  currentFileBase64 = null;
Â  Â  Â  Â  Â  Â  alert("Evidence Uploaded.");
Â  Â  Â  Â  Â  Â  switchTab('gallery');
Â  Â  Â  Â  });
Â  Â  }
};
// --- NEW FUNCTION: TRY AGAIN ---
window.retryLogin = () => {
Â  Â  // Shows a loading state
Â  Â  const btn = document.querySelector('.btn-retry');
Â  Â  if(btn) btn.innerText = "Checking...";
Â  Â Â 
Â  Â  // Reloads the page to force a fresh data fetch
Â  Â  setTimeout(() => {
Â  Â  Â  Â  window.location.reload();
Â  Â  }, 500);
};
window.handleFileUpload = () => {
Â  Â  const file = document.getElementById("evidenceFile").files[0];
Â  Â  document.getElementById("fileStatus").innerText = "Processing...";
Â  Â  if(file && file.size < 1.5*1024*1024) {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  } else {
Â  Â  Â  Â  alert("File too large! Max 1.5MB");
Â  Â  Â  Â  document.getElementById("fileStatus").innerText = "Error: File too large";
Â  Â  }
}
// --- 1. HANDLE GALLERY LINE CHANGE ---
window.handleGalleryLineChange = () => {
Â  Â  const lineSel = document.getElementById("galleryLineSelect");
Â  Â  const stnSel = document.getElementById("galleryStationSelect");
Â  Â  const uploadDiv = document.getElementById("galleryUploadSection");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  uploadDiv.classList.add("hidden");

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};

// --- 2. HANDLE GALLERY STATION CHANGE ---
window.handleGalleryStationChange = () => {
Â  Â  const stnSel = document.getElementById("galleryStationSelect");
Â  Â  const lineSel = document.getElementById("galleryLineSelect");
Â  Â  const uploadDiv = document.getElementById("galleryUploadSection");
Â  Â Â 
Â  Â  if (stnSel.value) {
Â  Â  Â  Â  uploadDiv.classList.remove("hidden");
Â  Â  Â  Â  // Update visual feedback
Â  Â  Â  Â  const targetName = `${stnSel.value} (${lineSel.value})`;
Â  Â  Â  Â  document.getElementById("uploadTargetText").innerText = `Target: ${targetName}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Optional: You could call loadGallery() here if you want to filter the grid
Â  Â  Â  Â  loadGallery();Â 
Â  Â  } else {
Â  Â  Â  Â  uploadDiv.classList.add("hidden");
Â  Â  }
};

// --- 3. UPDATED UPLOAD FUNCTION (Validates Location) ---
window.uploadEvidenceOnly = () => {
Â  Â  // Check File
Â  Â  if(!currentFileBase64) return alert("Please select a file first.");

Â  Â  // Check Location (From Gallery Dropdowns)
Â  Â  const stnSel = document.getElementById("galleryStationSelect");
Â  Â  const lineSel = document.getElementById("galleryLineSelect");
Â  Â Â 
Â  Â  if (!stnSel || !stnSel.value || !lineSel.value) {
Â  Â  Â  Â  return alert("âŒ Error: Please select a Line and Station before uploading.");
Â  Â  }

Â  Â  // Format Exact Location String
Â  Â  const exactLocation = `${stnSel.value} (${lineSel.value})`;

Â  Â  if(confirm(`Upload evidence for:\n${exactLocation}?`)) {
Â  Â  Â  Â  push(ref(db, "history"), {
Â  Â  Â  Â  Â  Â  name: "Evidence Upload",
Â  Â  Â  Â  Â  Â  location: exactLocation, // <-- KEY: Stored Station-Wise
Â  Â  Â  Â  Â  Â  user: currentUser.email,
Â  Â  Â  Â  Â  Â  userName: currentUser.name,
Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString(),
Â  Â  Â  Â  Â  Â  fileData: currentFileBase64,
Â  Â  Â  Â  Â  Â  fileType: currentFileType
Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  // Reset
Â  Â  Â  Â  Â  Â  document.getElementById("evidenceFile").value = "";
Â  Â  Â  Â  Â  Â  document.getElementById("fileStatus").innerText = "";
Â  Â  Â  Â  Â  Â  currentFileBase64 = null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  alert("âœ… Evidence Uploaded Successfully!");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Refresh Gallery to show new image
Â  Â  Â  Â  Â  Â  loadGallery();
Â  Â  Â  Â  });
Â  Â  }
};
window.submitStationData = async () => {
Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â Â 
Â  Â  if (!lineSel.value || !stnSel.value) return alert("âŒ Select Line and Station.");

Â  Â  const stationName = `${stnSel.value} (${lineSel.value})`;
Â  Â  const stationId = `${lineSel.value}_${stnSel.value}`.replace(/\s+/g, '_');

Â  Â  // 1. Generate a brand new UNIQUE Key for this specific report
Â  Â  const reportKey = push(ref(db, "station_logs")).key;

Â  Â  const finalData = {
Â  Â  Â  Â  name: stationName,
Â  Â  Â  Â  len: document.getElementById("inpStationLength").value,
Â  Â  Â  Â  yl: document.getElementById("inpYellowDist").value,
Â  Â  Â  Â  th: document.getElementById("inpYellowThick").value,
Â  Â  Â  Â  remarks: document.getElementById("inpRemarks").value,
Â  Â  Â  Â  impl: document.getElementById("inpImplementation").value,
Â  Â  Â  Â  userName: currentUser.name || currentUser.email,
Â  Â  Â  Â  date: new Date().toLocaleString(),
Â  Â  Â  Â  timestamp: serverTimestamp()Â 
Â  Â  };

Â  Â  // 2. Fetch the Rake rows from the station-specific draft
Â  Â  const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/${stationId}/rows`));
Â  Â  const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

Â  Â  try {
Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  // Save Master Log
Â  Â  Â  Â  updates[`station_logs/${reportKey}`] = finalData;
Â  Â  Â  Â  // Save Linked Rake Table
Â  Â  Â  Â  if (rowsData) updates[`rake_logs/${reportKey}`] = rowsData;

Â  Â  Â  Â  // 3. Execute simultaneous storage
Â  Â  Â  Â  await update(ref(db), updates);

Â  Â  Â  Â  // 4. Cleanup ONLY this station's draft
Â  Â  Â  Â  await remove(ref(db, `drafts/${currentUser.uid}/${stationId}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert(`âœ… Inspection Saved: ${stationName}`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. Reset UI for next station
Â  Â  Â  Â  document.getElementById("mainDataForm").classList.add("hidden");
Â  Â  Â  Â  stnSel.value = "";
Â  Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Critical Error: Data not stored.");
Â  Â  }
};
window.loadAdminPanel = async () => {
Â  Â  const userList = document.getElementById("userCheckboxList");
Â  Â  const userTable = document.getElementById("userListBody");
Â  Â Â 
Â  Â  // Listen to all users in real-time
Â  Â  onValue(ref(db, "users"), async (userSnap) => {
Â  Â  Â  Â  const statusSnap = await get(ref(db, "status"));
Â  Â  Â  Â  const statusMap = statusSnap.val() || {};
Â  Â  Â  Â Â 
Â  Â  Â  Â  userTable.innerHTML = "";
Â  Â  Â  Â  userList.innerHTML = "";

Â  Â  Â  Â  userSnap.forEach(c => {
Â  Â  Â  Â  Â  Â  const u = c.val();
Â  Â  Â  Â  Â  Â  const uid = c.key;
Â  Â  Â  Â  Â  Â  const displayName = u.name || u.email;

Â  Â  Â  Â  Â  Â  // Update Checkbox List for assigning new work
Â  Â  Â  Â  Â  Â  userList.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="user-check" value="${uid}"> ${displayName}</label>`;

Â  Â  Â  Â  Â  Â  // Online/Offline Logic
Â  Â  Â  Â  Â  Â  const s = statusMap[uid];
Â  Â  Â  Â  Â  Â  const isOnline = (s && s.state === 'online' && (Date.now() - (s.last_seen || 0)) < 25000);
Â  Â  Â  Â  Â  Â  const statusBadge = isOnline ? `<span class="badge-online">â— ONLINE</span>` : `<span class="badge-offline">â—‹ OFFLINE</span>`;

Â  Â  Â  Â  Â  Â  // Create Row
Â  Â  Â  Â  Â  Â  const row = document.createElement("tr");
Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${displayName}</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:#666;">${u.email}</small>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${statusBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;" id="task_stat_${uid}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>Syncing tasks...</small>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.faceData ? '<span style="color:green;">âœ” Registered</span>' : '<span style="color:red;">âŒ Pending</span>'}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="info" onclick="viewUserTasks('${uid}', '${encodeURIComponent(displayName)}')" style="font-size:10px; padding:5px 8px;">ğŸ“‹ Track</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="openBanModal('${uid}', '${encodeURIComponent(displayName)}')" style="font-size:10px; padding:5px 8px;">ğŸš« Ban</button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  userTable.appendChild(row);

Â  Â  Â  Â  Â  Â  // NESTED LIVE LISTENER: Update the specific "Task Progress" cell
Â  Â  Â  Â  Â  Â  onValue(ref(db, `assignments/${uid}`), (taskSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const targetCell = document.getElementById(`task_stat_${uid}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (!targetCell) return;

Â  Â  Â  Â  Â  Â  Â  Â  let pending = 0, done = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (taskSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taskSnap.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.val().status === 'Done' ? done++ : pending++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetCell.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b style="color:green;">${done} Done</b><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b style="color:#b38600;">${pending} Pending</b>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetCell.innerHTML = `<span style="color:#999;">No Tasks</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  });
};
// --- NEW FUNCTION: RESET NAME ---
window.resetUserName = async (uid) => {
Â  Â  if(confirm("âš  Reset this user's name?\n\nThey will be asked to enter their 'Official Name' again on the next login.")) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${uid}`), { name: null });
Â  Â  Â  Â  Â  Â  alert("âœ… Name cleared. User will be prompted to rename on next login.");
Â  Â  Â  Â  Â  Â  loadAdminPanel(); // Refresh list
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};
// --- NEW FUNCTION: RESET NAME ---
window.resetUserName = async (uid) => {
Â  Â  if(confirm("âš  Reset this user's name?\n\nThey will be asked to enter their 'Official Name' again on the next login.")) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${uid}`), { name: null });
Â  Â  Â  Â  Â  Â  alert("âœ… Name cleared. User will be prompted to rename on next login.");
Â  Â  Â  Â  Â  Â  loadAdminPanel(); // Refresh list
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};
window.viewUserTasks = (uid, encodedName) => {
Â  Â  const userName = decodeURIComponent(encodedName);
Â  Â  document.getElementById("modalTaskUserName").innerText = userName;
Â  Â  document.getElementById("adminTaskModal").classList.remove("hidden");
Â  Â Â 
Â  Â  const tbody = document.getElementById("adminTaskBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>ğŸ”„ Syncing Live...</td></tr>";

Â  Â  // REMOVE '{ onlyOnce: true }' to make it live
Â  Â  const taskRef = ref(db, `assignments/${uid}`);
Â  Â  onValue(taskRef, (snap) => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>ğŸ“­ No tasks assigned yet.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const task = c.val();
Â  Â  Â  Â  Â  Â  const key = c.key;
Â  Â  Â  Â  Â  Â  const isDone = task.status === 'Done';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr style="background: ${isDone ? '#f0fff4' : '#fff'};">
Â  Â  Â  Â  Â  Â  Â  Â  <td>${task.date || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${task.desc}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${task.by.split('@')[0]}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: ${isDone ? 'green' : '#b38600'}; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isDone ? 'âœ… COMPLETED' : 'â³ IN PROGRESS'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="deleteUserTask('${uid}', '${key}')">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  });
};
// 2. Close the Modal
window.closeTaskModal = () => {
Â  Â  document.getElementById("adminTaskModal").classList.add("hidden");
};

// 3. Delete a specific task
window.deleteUserTask = (uid, taskKey) => {
Â  Â  if(confirm("Permanently delete this task?")) {
Â  Â  Â  Â  remove(ref(db, `assignments/${uid}/${taskKey}`))
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  // Refresh view by calling viewUserTasks again or letting live listener handle it
Â  Â  Â  Â  Â  Â  Â  Â  // If using onValue live, it updates automatically.
Â  Â  Â  Â  Â  Â  Â  Â  // If using {onlyOnce:true}, we need to reload:
Â  Â  Â  Â  Â  Â  Â  Â  // viewUserTasks(uid, document.getElementById("modalTaskUserName").innerText);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Task Deleted");
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(err => alert("Error: " + err.message));
Â  Â  }
};

// 2. Close Modal
window.closeTaskModal = () => {
Â  Â  document.getElementById("adminTaskModal").classList.add("hidden");
Â  Â  // Optional: Stop listening to data to save bandwidth (requires off() method if optimized)
};

// 3. Delete Task
window.deleteUserTask = (uid, taskKey) => {
Â  Â  if(confirm("Permanently delete this task?")) {
Â  Â  Â  Â  remove(ref(db, `assignments/${uid}/${taskKey}`))
Â  Â  Â  Â  Â  Â  .then(() => console.log("Task deleted"))
Â  Â  Â  Â  Â  Â  .catch(err => alert("Error: " + err.message));
Â  Â  }
};
// --- NEW: CLOSE MODAL ---
window.closeTaskModal = () => {
Â  Â  document.getElementById("adminTaskModal").classList.add("hidden");
};

// --- NEW: DELETE TASK (ADMIN OVERRIDE) ---
// SINGLE, CORRECT VERSION
window.deleteUserTask = (uid, taskKey) => {
Â  Â  if(confirm("Are you sure you want to remove this task?")) {
Â  Â  Â  Â  remove(ref(db, `assignments/${uid}/${taskKey}`))
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  // Determine if we need to refresh the view manually
Â  Â  Â  Â  Â  Â  Â  Â  // If the modal is open, we can try to refresh it
Â  Â  Â  Â  Â  Â  Â  Â  const nameEl = document.getElementById("modalTaskUserName");
Â  Â  Â  Â  Â  Â  Â  Â  if(nameEl && !document.getElementById("adminTaskModal").classList.contains("hidden")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  viewUserTasks(uid, encodeURIComponent(nameEl.innerText));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(err => alert("Error: " + err.message));
Â  Â  }
};
// --- NEW SYSTEM LOGS LOGIC (AUDIT READY) ---
window.loadSysLogs = () => {
Â  Â  const tbody = document.getElementById("fullLogBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>Syncing System Logs...</td></tr>";

Â  Â  const q = query(ref(db, "logs"), limitToLast(200));

Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse();

Â  Â  Â  Â  if(logs.length === 0) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>System Clean. No logs generated.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  logs.forEach(x => {
Â  Â  Â  Â  Â  Â  // Contextual Styling
Â  Â  Â  Â  Â  Â  let rowStyle = "border-bottom:1px solid #eee;";
Â  Â  Â  Â  Â  Â  let level = `<span style="color:gray; font-weight:bold;">INFO</span>`;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if(x.type === "LOGIN") {
Â  Â  Â  Â  Â  Â  Â  Â  level = `<span style="color:green; font-weight:bold;">AUTH</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  rowStyle += "background:#f0fff4;";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(x.type === "LOGOUT") {
Â  Â  Â  Â  Â  Â  Â  Â  level = `<span style="color:orange; font-weight:bold;">EXIT</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  rowStyle += "background:#fffbf0;";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(x.type.includes("Fail") || x.type.includes("Error")) {
Â  Â  Â  Â  Â  Â  Â  Â  level = `<span style="color:red; font-weight:bold;">ALERT</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  rowStyle += "background:#fff0f0;";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(x.type === "CHECKOUT" || x.type === "RETURN" || x.type.includes("STOCK")) {
Â  Â  Â  Â  Â  Â  Â  Â  level = `<span style="color:#003366; font-weight:bold;">TRANS</span>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Clean up details
Â  Â  Â  Â  Â  Â  let details = x.method || x.item || "System Event";
Â  Â  Â  Â  Â  Â  if(x.qty) details += ` (Qty: ${x.qty})`;
Â  Â  Â  Â  Â  Â  if(x.approvedBy) details += ` | Auth: ${x.approvedBy}`;

Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr class="sys-log-row" style="${rowStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px; color:#555;">${formatTime(x.time)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">${level}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; font-size:12px;">${x.type}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${x.user || x.takenBy}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px; font-family:monospace;">${details}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  });
};
// ==============================================
//Â  Â  Â  Â  Â  Â FULL BAN SYSTEM LOGIC
// ==============================================

let currentBanTargetUid = null;
let currentBanDays = 0; // Stores days OR 'CUSTOM'

// 1. OPEN MODAL
window.openBanModal = (uid, encodedName) => {
Â  Â  if(!isAdmin) return alert("Admins Only.");
Â  Â  if(uid === currentUser.uid) return alert("You cannot ban yourself.");
Â  Â Â 
Â  Â  currentBanTargetUid = uid;
Â  Â  document.getElementById("banTargetName").innerText = decodeURIComponent(encodedName);
Â  Â  document.getElementById("adminBanModal").classList.remove("hidden");
Â  Â Â 
Â  Â  // Reset Form
Â  Â  document.getElementById("banReasonInput").selectedIndex = 0;
Â  Â  toggleBanOtherInput(); // Hide 'Other' input
Â  Â  document.getElementById("banReasonOther").value = "";
Â  Â  document.getElementById("banActionInput").value = "";
Â  Â  document.getElementById("banRemarks").value = "";
Â  Â  document.getElementById("banCustomDate").value = "";
Â  Â Â 
Â  Â  // Reset Buttons
Â  Â  currentBanDays = 0;
Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
};

// 2. CLOSE MODAL
window.closeBanModal = () => {
Â  Â  document.getElementById("adminBanModal").classList.add("hidden");
Â  Â  currentBanTargetUid = null;
};

// 3. UI HELPERS
window.toggleBanOtherInput = () => {
Â  Â  const val = document.getElementById("banReasonInput").value;
Â  Â  const div = document.getElementById("divBanOther");
Â  Â  if(val === "Other") {
Â  Â  Â  Â  div.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("banReasonOther").focus();
Â  Â  } else {
Â  Â  Â  Â  div.classList.add("hidden");
Â  Â  }
};

window.selectBanDuration = (days, btn) => {
Â  Â  currentBanDays = days;
Â  Â  // Clear Custom Date
Â  Â  const dateInput = document.getElementById("banCustomDate");
Â  Â  dateInput.value = "";
Â  Â  dateInput.style.border = "1px solid #ccc";
Â  Â Â 
Â  Â  // Highlight Button
Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
Â  Â  btn.classList.add("selected");
};

window.selectBanCustomDate = (input) => {
Â  Â  if(input.value) {
Â  Â  Â  Â  currentBanDays = 'CUSTOM';
Â  Â  Â  Â  // Deselect buttons
Â  Â  Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
Â  Â  Â  Â  input.style.border = "2px solid #dc3545"; // Red border to show selection
Â  Â  }
};

// 4. SUBMIT BAN (MAIN FUNCTION)
window.submitBan = async () => {
Â  Â  if(!currentBanTargetUid) return;

Â  Â  // --- STEP A: REASON VALIDATION ---
Â  Â  let reason = document.getElementById("banReasonInput").value;
Â  Â  if(reason === "Other") {
Â  Â  Â  Â  const otherText = document.getElementById("banReasonOther").value.trim();
Â  Â  Â  Â  if(!otherText) return alert("Please specify the 'Other' reason details.");
Â  Â  Â  Â  reason = "Other: " + otherText;
Â  Â  }

Â  Â  // --- STEP B: ACTION VALIDATION ---
Â  Â  const actionInst = document.getElementById("banActionInput").value.trim();
Â  Â  if(!actionInst) return alert("Please enter 'Action Required' (How to dispose this matter).");

Â  Â  // --- STEP C: DEADLINE CALCULATION ---
Â  Â  let expiryTimestamp = 0;
Â  Â Â 
Â  Â  if(currentBanDays === 'CUSTOM') {
Â  Â  Â  Â  const dateVal = document.getElementById("banCustomDate").value;
Â  Â  Â  Â  if(!dateVal) return alert("Please select a Deadline Date.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Set expiry to the END of that day (23:59:59)
Â  Â  Â  Â  const d = new Date(dateVal);
Â  Â  Â  Â  d.setHours(23, 59, 59, 999);
Â  Â  Â  Â  expiryTimestamp = d.getTime();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Sanity check: Date cannot be in the past
Â  Â  Â  Â  if(expiryTimestamp < Date.now()) return alert("Deadline cannot be in the past.");
Â  Â  }Â 
Â  Â  else if (typeof currentBanDays === 'number' && currentBanDays > 0) {
Â  Â  Â  Â  // Calculate future timestamp: Now + (Days * ms)
Â  Â  Â  Â  expiryTimestamp = Date.now() + (currentBanDays * 24 * 60 * 60 * 1000);
Â  Â  }Â 
Â  Â  else {
Â  Â  Â  Â  return alert("Please select a valid Tenure/Deadline.");
Â  Â  }

Â  Â  const remarks = document.getElementById("banRemarks").value;
Â  Â  const deadlineDateString = new Date(expiryTimestamp).toLocaleDateString();

Â  Â  // --- STEP D: CONFIRMATION ---
Â  Â  if(confirm(`âš  CONFIRM BAN?\n\nUser: ${document.getElementById("banTargetName").innerText}\nReason: ${reason}\nDeadline: ${deadlineDateString}\n\nIf the user does not resolve this by the deadline, they will be permanently locked out.`)) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Update User Profile
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${currentBanTargetUid}`), {
Â  Â  Â  Â  Â  Â  Â  Â  banned: true,
Â  Â  Â  Â  Â  Â  Â  Â  banReason: reason,
Â  Â  Â  Â  Â  Â  Â  Â  banAction: actionInst,
Â  Â  Â  Â  Â  Â  Â  Â  banExpires: expiryTimestamp,
Â  Â  Â  Â  Â  Â  Â  Â  banRemarks: remarks,
Â  Â  Â  Â  Â  Â  Â  Â  banDate: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  bannedBy: currentUser.email
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Log to System
Â  Â  Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  Â  Â  type: "USER_BAN",
Â  Â  Â  Â  Â  Â  Â  Â  user: "System",
Â  Â  Â  Â  Â  Â  Â  Â  details: `Banned UID: ${currentBanTargetUid}`,
Â  Â  Â  Â  Â  Â  Â  Â  reason: `${reason} | Deadline: ${deadlineDateString}`,
Â  Â  Â  Â  Â  Â  Â  Â  approvedBy: currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  time: serverTimestamp()
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  alert("âœ… User Banned Successfully.");
Â  Â  Â  Â  Â  Â  closeBanModal();
Â  Â  Â  Â  Â  Â  loadAdminPanel(); // Refresh list to show 'Unban' button
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("Database Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};

// 5. UNBAN USER
window.unbanUser = async (uid) => {
Â  Â  if(!isAdmin) return alert("Admins Only.");
Â  Â Â 
Â  Â  if(confirm("â™» Restore this user's access immediately?")) {
Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â // Clear all ban fields
Â  Â  Â  Â  Â  Â  Â await update(ref(db, `users/${uid}`), {
Â  Â  Â  Â  Â  Â  Â  Â  banned: null,
Â  Â  Â  Â  Â  Â  Â  Â  banReason: null,
Â  Â  Â  Â  Â  Â  Â  Â  banAction: null,
Â  Â  Â  Â  Â  Â  Â  Â  banRemarks: null,
Â  Â  Â  Â  Â  Â  Â  Â  banExpires: null,
Â  Â  Â  Â  Â  Â  Â  Â  banDate: null,
Â  Â  Â  Â  Â  Â  Â  Â  bannedBy: null
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  Â  Â  type: "USER_UNBAN",
Â  Â  Â  Â  Â  Â  Â  Â  user: "System",
Â  Â  Â  Â  Â  Â  Â  Â  details: `Restored access for UID: ${uid}`,
Â  Â  Â  Â  Â  Â  Â  Â  approvedBy: currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  time: serverTimestamp()
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  alert("âœ… User Restored.");
Â  Â  Â  Â  Â  Â  loadAdminPanel();
Â  Â  Â  Â  Â } catch(e) {
Â  Â  Â  Â  Â  Â  Â alert("Error: " + e.message);
Â  Â  Â  Â  Â }
Â  Â  }
};
// --- SEARCH FUNCTION FOR SYSTEM LOGS ---
window.filterSysLogs = () => {
Â  Â  const input = document.getElementById("sysLogSearch").value.toLowerCase();
Â  Â  const rows = document.getElementsByClassName("sys-log-row");
Â  Â 
Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  const text = row.innerText.toLowerCase();
Â  Â  Â  Â  row.style.display = text.includes(input) ? "" : "none";
Â  Â  });
};

window.deleteLogEntry = (key) => {
Â  Â  if(!isAdmin) return alert("Access Denied: Admins Only.");
Â  Â  if(confirm("Permanently delete this log entry?")) {
Â  Â  Â  Â  remove(ref(db, `logs/${key}`)).catch(e => alert("Error: " + e.message));
Â  Â  }
};

window.assignTaskMulti = () => {
Â  Â  const desc = document.getElementById("taskDesc").value;
Â  Â  if(!desc) return alert("Please enter task details.");
Â  Â  const checkboxes = document.querySelectorAll('.user-check:checked');
Â  Â  if(checkboxes.length === 0) return alert("Select at least one user.");

Â  Â  checkboxes.forEach(cb => {
Â  Â  Â  Â  const uid = cb.value;
Â  Â  Â  Â  const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };
Â  Â  Â  Â  push(ref(db, `assignments/${uid}`), task);
Â  Â  });
Â  Â  alert(`Task assigned to ${checkboxes.length} user(s).`);
Â  Â  document.getElementById("taskDesc").value = "";
Â  Â  checkboxes.forEach(cb => cb.checked = false);
};

window.savePin = (uid) => {
Â  Â  const p = document.getElementById(`pin_${uid}`).value;
Â  Â  if(p.length >= 4) { update(ref(db, `users/${uid}`), { pin: p }); alert("PIN Updated"); }
}

window.forceReUpload = (uid) => {
Â  Â  if(confirm("Reset Face Data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset. User must scan face on next login.")); }
}
window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));
window.switchTab = (t) => {
    // 1. All available tabs (Added 'demoResult')
    const allTabs = [
        'newData', 
        'inventory', 
        'gallery', 
        'assigned', 
        'adminPanel', 
        'dataView', 
        'printReport', 
        'demoResult'
    ];
    
    // 2. Hide all tab content sections
    allTabs.forEach(x => {
        const el = document.getElementById(`tab-${x}`);
        if(el) el.classList.add("hidden");
    });

    // 3. Remove 'active' styling from all navigation buttons
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

    // 4. Show the selected tab content
    const target = document.getElementById(`tab-${t}`);
    if(target) target.classList.remove("hidden");

    // 5. Map the tab ID to the button ID for highlighting
    let btnId = '';
    switch(t) {
        case 'newData':     btnId = 'btnNew'; break;
        case 'inventory':   btnId = 'btnInventory'; break;
        case 'gallery':     btnId = 'btnGallery'; break;
        case 'assigned':    btnId = 'btnAssign'; break;
        case 'adminPanel':  btnId = 'btnAdmin'; break;
        case 'dataView':    btnId = 'btnDataView'; break;
        case 'printReport': btnId = 'btnPrintReport'; break;
        case 'demoResult':  btnId = 'btnDemo'; break; // Highlight Demo Button
    }

    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add("active");

    // 6. Context-specific data loading
    if(t === 'adminPanel' && isAdmin) loadAdminPanel();
    if(t === 'gallery') loadGallery();
    if(t === 'demoResult') loadDemoHistory(); // Auto-load previous demo logs
};
window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
Â  Â  const div = document.getElementById("galleryContainer");
Â  Â  div.innerHTML = "<p>Loading...</p>";

Â  Â  onValue(ref(db, "history"), snap => {
Â  Â  Â  Â  div.innerHTML = "";
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  if(v.fileData) {
Â  Â  Â  Â  Â  Â  Â  Â  let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
Â  Â  Â  Â  Â  Â  Â  Â  else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">ğŸ“„ PDF</div>`;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  let controls = `<br><small style="color:grey;">(View Only)</small>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">â¬‡ Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
Â  Â  });
}

window.removeFile = (k) => {
Â  Â  if(confirm("Remove attached file?")) {
Â  Â  Â  Â  update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
Â  Â  }
}
// Global variables to track the active listener
let draftRef = null;
let draftListener = null;
window.loadDraft = () => {
Â  Â  const stn = document.getElementById("stationSelect").value;
Â  Â  const line = document.getElementById("lineSelect").value;
Â  Â  if(!stn || !line) return;

Â  Â  // Create a unique path for this specific station's draft
Â  Â  const stationId = `${line}_${stn}`.replace(/\s+/g, '_');
Â  Â  const tbody = document.getElementById("distanceBody");
Â  Â Â 
Â  Â  // Detach old listeners to prevent memory leaks or data ghosting
Â  Â  if (draftRef && draftListener) off(draftRef, draftListener);

Â  Â  draftRef = ref(db, `drafts/${currentUser.uid}/${stationId}`);
Â  Â Â 
Â  Â  draftListener = onValue(draftRef, (snap) => {
Â  Â  Â  Â  const d = snap.val();
Â  Â  Â  Â  tbody.innerHTML = "";Â 

Â  Â  Â  Â  if(d && d.rows) {
Â  Â  Â  Â  Â  Â  Object.entries(d.rows).forEach(([k, v], i) => {
Â  Â  Â  Â  Â  Â  Â  Â  renderRow(k, v, i + 1, stationId); // Pass stationId to update functions
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
};
function renderRow(k, v, i) {
Â  Â  const b = document.getElementById("distanceBody");
Â  Â Â 
Â  Â  // Helper to check which option was previously saved
Â  Â  const isSel = (val) => (v.type === val ? "selected" : "");

Â  Â  b.innerHTML += `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:bold;">${i}</td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.rake}" onchange="upRow('${k}','rake',this.value)" placeholder="Type _ if empty">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <select style="width:100%; padding:5px; font-weight:bold; border:1px solid #ced4da; border-radius:3px;" onchange="upRow('${k}','type',this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" ${isSel("")}>-- Select Type --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="BHEL RAKE (300 SERIES)" ${isSel("BHEL RAKE (300 SERIES)")}>BHEL RAKE (300 SERIES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="MEDHA RAKE (400 SERIES)" ${isSel("MEDHA RAKE (400 SERIES)")}>MEDHA RAKE (400 SERIES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="DALIAN RAKE (500 SERIES)" ${isSel("DALIAN RAKE (500 SERIES)")}>DALIAN RAKE (500 SERIES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.f}" onchange="upRow('${k}','f',this.value)" placeholder="_">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.r}" onchange="upRow('${k}','r',this.value)" placeholder="_">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="delRow('${k}')" style="padding:5px 10px;">X</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
// --- UPDATED VIEW STOCK SCRIPT ---
function loadInventory() {
Â  Â  const b = document.getElementById("inventoryBody");
Â  Â  const summaryEl = document.getElementById("stockSummaryText");
Â  Â Â 
Â  Â  // Set colspan to 8 to match the new header count
Â  Â  b.innerHTML = "<tr><td colspan='8' style='text-align:center;'>Loading live stock...</td></tr>";

Â  Â  onValue(ref(db, "inventory"), snap => {
Â  Â  Â  Â  b.innerHTML = "";
Â  Â  Â  Â  let totalItems = 0;
Â  Â  Â  Â  let inStockCount = 0;

Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  Â b.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No inventory found. Add items first.</td></tr>";
Â  Â  Â  Â  Â  Â  Â if(summaryEl) summaryEl.innerText = "Total Items: 0";
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  const k = c.key;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  totalItems++;
Â  Â  Â  Â  Â  Â  if(v.status !== "Checked Out") inStockCount++;

Â  Â  Â  Â  Â  Â  // Handle "Holder" display
Â  Â  Â  Â  Â  Â  let holderDisplay = "-";
Â  Â  Â  Â  Â  Â  if(v.status === "Checked Out") {
Â  Â  Â  Â  Â  Â  Â  Â  holderDisplay = `<span style="color:#b38600; font-weight:bold;">ğŸ‘¤ ${v.holder}</span>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Handle "Status" Badge
Â  Â  Â  Â  Â  Â  let statusBadge = `<span style="color:green; font-weight:bold; background:#d4edda; padding:2px 6px; border-radius:4px;">In Stock</span>`;
Â  Â  Â  Â  Â  Â  if(v.status === "Checked Out") {
Â  Â  Â  Â  Â  Â  Â  Â  statusBadge = `<span style="color:#856404; font-weight:bold; background:#fff3cd; padding:2px 6px; border-radius:4px;">ğŸ“¤ Out</span>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Handle Defaults
Â  Â  Â  Â  Â  Â  const addedBy = v.addedBy || "Unknown";
Â  Â  Â  Â  Â  Â  const usage = v.usageCount || 0;
Â  Â  Â  Â  Â  Â  const barcode = v.barcode || "--";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // NEW: Handle Location
Â  Â  Â  Â  Â  Â  // If it's Checked Out, show "With User", otherwise show the saved location
Â  Â  Â  Â  Â  Â  let locDisplay = v.location || "Not Set";
Â  Â  Â  Â  Â  Â  if(v.status === "Checked Out") locDisplay = "ğŸ“¤ (Checked Out)";

Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr class="stock-row">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; color:#003366; font-weight:bold;">${barcode}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="search-name">${v.item}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px; color:#555;">${addedBy}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:bold;">${usage}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${holderDisplay}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px; font-weight:bold; color:#003366;">${locDisplay}</td> <td>${statusBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdmin ? `<button class="danger" onclick="delInv('${k}')" style="padding:2px 5px; font-size:10px;">Remove</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  b.innerHTML += row;
Â  Â  Â  Â  });

Â  Â  Â  Â  if(summaryEl) {
Â  Â  Â  Â  Â  Â  summaryEl.innerHTML = `Total Items: ${totalItems} | <span style="color:green;">Available: ${inStockCount}</span>`;
Â  Â  Â  Â  }
Â  Â  });
}
// --- DUPLICATE CHECK ---
window.checkBarcodeUnique = async (code) => {
Â  Â  if(!code) return;
Â  Â Â 
Â  Â  document.getElementById("barcodeError").classList.add("hidden");
Â  Â  document.getElementById("btnAddStock").disabled = false;
Â  Â  document.getElementById("btnAddStock").innerText = "Save Item to Stock";

Â  Â  const invRef = ref(db, "inventory");
Â  Â  const q = query(invRef, orderByChild("barcode"), equalTo(code));
Â  Â  const snap = await get(q);

Â  Â  if(snap.exists()) {
Â  Â  Â  Â  document.getElementById("barcodeError").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("btnAddStock").disabled = true;
Â  Â  Â  Â  document.getElementById("btnAddStock").innerText = "â›” Duplicate Barcode";
Â  Â  Â  Â Â 
Â  Â  Â  Â  let existingItem = null;
Â  Â  Â  Â  snap.forEach(c => existingItem = c.val());
Â  Â  Â  Â  alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
Â  Â  }
}
// --- UPDATED ADD ITEM FUNCTION (FIXED) ---
window.addUniqueItem = async () => {
Â  Â  console.log("Starting Add Item Process..."); // Debug to ensure new code is running

Â  Â  // 1. Get Basic Data
Â  Â  const item = document.getElementById("invName").value;
Â  Â  const cond = document.getElementById("invCondition").value;
Â  Â  const barcode = document.getElementById("invBarcode").value;

Â  Â  if(!item || !barcode) return alert("Product Name and Barcode are required.");

Â  Â  // 2. Get Location Data (CRITICAL STEP)
Â  Â  // Make sure these IDs match your HTML
Â  Â  const locSelect = document.getElementById("addLocSelect");
Â  Â  const locOther = document.getElementById("addLocOther");
Â  Â  const locSpot = document.getElementById("addLocSpot");

Â  Â  if(!locSelect || !locSpot) {
Â  Â  Â  Â  return alert("Error: Location inputs not found in HTML. Please check code.");
Â  Â  }

Â  Â  let mainPlace = locSelect.value;
Â  Â Â 
Â  Â  // Check if 'Other' is selected
Â  Â  if(mainPlace === "Other") {
Â  Â  Â  Â  const otherText = locOther.value.trim();
Â  Â  Â  Â  if(!otherText) return alert("Please specify the 'Other' location name.");
Â  Â  Â  Â  mainPlace = otherText;
Â  Â  }

Â  Â  const spotText = locSpot.value.trim();
Â  Â  if(!spotText) return alert("Please specify the Exact Spot (e.g., Cabinet, Almirah).");

Â  Â  // 3. Create the Location String
Â  Â  const finalLocation = `${mainPlace} [${spotText}]`;
Â  Â  console.log("Saving Location:", finalLocation);

Â  Â  // 4. Check Uniqueness
Â  Â  const invRef = ref(db, "inventory");
Â  Â  const q = query(invRef, orderByChild("barcode"), equalTo(barcode));
Â  Â  const snap = await get(q);

Â  Â  if(snap.exists()) return alert("CRITICAL ERROR: Barcode already exists.");

Â  Â  // 5. Save to Inventory
Â  Â  await push(ref(db, "inventory"), {
Â  Â  Â  Â  barcode: barcode,
Â  Â  Â  Â  item: item,
Â  Â  Â  Â  condition: cond,
Â  Â  Â  Â  status: "In Stock",
Â  Â  Â  Â  holder: "Store",
Â  Â  Â  Â  location: finalLocation, // <--- THIS SAVES THE LOCATION
Â  Â  Â  Â  usageCount: 0,Â 
Â  Â  Â  Â  addedBy: currentUser.name || currentUser.email,Â 
Â  Â  Â  Â  dateAdded: serverTimestamp()
Â  Â  });

Â  Â  // 6. Log the Action
Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  type: "STOCK_ADD",
Â  Â  Â  Â  item: item,
Â  Â  Â  Â  barcode: barcode,
Â  Â  Â  Â  qty: 1,
Â  Â  Â  Â  location: finalLocation,
Â  Â  Â  Â  takenBy: currentUser.name,
Â  Â  Â  Â  approvedBy: "Self",
Â  Â  Â  Â  time: serverTimestamp()
Â  Â  });

Â  Â  alert("âœ… Item Added to: " + finalLocation);
Â  Â Â 
Â  Â  // 7. Reset Form
Â  Â  document.getElementById("invBarcode").value = "";
Â  Â  document.getElementById("invName").value = "";
Â  Â  document.getElementById("addLocOther").value = "";
Â  Â  document.getElementById("addLocSpot").value = "";
Â  Â  document.getElementById("addLocSelect").value = "D2 Building - Heerok Sir Lab";Â 
Â  Â  document.getElementById("divAddOtherLoc").classList.add("hidden");
Â  Â Â 
Â  Â  document.getElementById("invBarcode").focus();
};
// --- NEW SEARCH FUNCTION ---
window.filterStockTable = () => {
Â  Â  const input = document.getElementById("mainStockSearch").value.toLowerCase();
Â  Â  const rows = document.getElementsByClassName("stock-row");

Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  // Search in Barcode (col 0) and Name (col 1)
Â  Â  Â  Â  const barcode = row.cells[0].innerText.toLowerCase();
Â  Â  Â  Â  const name = row.cells[1].innerText.toLowerCase();
Â  Â  Â  Â  const holder = row.cells[3].innerText.toLowerCase();

Â  Â  Â  Â  if (name.includes(input) || barcode.includes(input) || holder.includes(input)) {
Â  Â  Â  Â  Â  Â  row.style.display = "";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  row.style.display = "none";
Â  Â  Â  Â  }
Â  Â  });
};
window.updateSourcePlaceholder = () => {
Â  Â  const type = document.getElementById("invSourceType").value;
Â  Â  const input = document.getElementById("invSourceName");
Â  Â  input.placeholder = type === "Online" ? "Name of Site" : "Name of Store";
};

window.delInv = (k) => remove(ref(db, `inventory/${k}`));
window.fetchAndShowRakes = async (key, stationName) => {
Â  Â  if(!key) return alert("Error: No Record ID found.");

Â  Â  // Show loading state
Â  Â  alert(`â³ Fetching separate rake data for: ${stationName}...`);

Â  Â  try {
Â  Â  Â  Â  // Go to the separate "rake_logs" container
Â  Â  Â  Â  const snap = await get(ref(db, `rake_logs/${key}`));

Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  alert(`â„¹ No rake data was saved for ${stationName}.`);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const rows = snap.val();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Format the data for display
Â  Â  Â  Â  let msg = `=== RAKE DATA FOR: ${stationName} ===\n\n`;
Â  Â  Â  Â  msg += `SL | RAKE NO | TYPE | FRONT | REAR\n`;
Â  Â  Â  Â  msg += `--------------------------------------\n`;

Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â  for (let rKey in rows) {
Â  Â  Â  Â  Â  Â  let r = rows[rKey];
Â  Â  Â  Â  Â  Â  msg += `${count}.Â  ${r.rake || '-'}Â  |Â  ${r.type || '-'}Â  |Â  ${r.f || '-'}Â  |Â  ${r.r || '-'}\n`;
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Show the data
Â  Â  Â  Â  alert(msg);

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Error fetching data: " + e.message);
Â  Â  }
};
function loadAssignments() {
Â  Â  onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
Â  Â  Â  Â  const list = document.getElementById("taskList"); list.innerHTML = "";
Â  Â  Â  Â  if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const t = c.val();
Â  Â  Â  Â  Â  Â  const div = document.createElement("div"); div.className = "panel";
Â  Â  Â  Â  Â  Â  div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
Â  Â  Â  Â  Â  Â  div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  });
Â  Â  });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

</script>
</body>
</html>
