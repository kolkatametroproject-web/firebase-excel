<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metro Watchdog Secure System</title>
<style>
/* --- CORE STYLES --- */
body{margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:#020617;color:#e5e7eb;}
header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:#0f172a;border-bottom:1px solid #1e293b;}
button{padding:8px 16px;cursor:pointer;background:#2563eb;color:white;border:none;border-radius:4px;transition:0.2s;}
button:hover{background:#1d4ed8;}
button:disabled{background:#475569;cursor:not-allowed;}
button.danger{background:#dc2626;}
button.danger:hover{background:#b91c1c;}
button.warning{background:#d97706;}
button.warning:hover{background:#b45309;}

section{padding:20px;max-width:1200px;margin:0 auto;}
h3{margin-top:0;color:#60a5fa;}
input, select, textarea{background:#1e293b;border:1px solid #334155;color:white;padding:8px;border-radius:4px;width:100%;box-sizing:border-box;margin-bottom:10px;}

/* --- LAYOUT & TABS --- */
.hidden{display:none !important;}
.nav-bar{display:flex;gap:10px;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #334155;}
.nav-btn{background:#334155;color:#94a3b8;}
.nav-btn.active{background:#2563eb;color:white;}

/* --- PANELS --- */
.panel{background:#0f172a;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #1e293b;}
.admin-badge{background:#f59e0b;color:black;padding:2px 8px;border-radius:4px;font-size:0.8em;font-weight:bold;margin-left:10px;}

/* --- TABLES --- */
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #334155;padding:10px;text-align:left;}
th{background:#1e293b;}
input.cell{width:100%;background:transparent;border:none;color:#e5e7eb;font-size:1em;}
input.cell:focus{background:#1e293b;outline:none;}

/* --- FACE CAPTURE MODAL --- */
#faceModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;justify-content:center;align-items:center;flex-direction:column;z-index:999;}
#cameraFeed{border:2px solid #2563eb;margin-bottom:15px;width:320px;height:240px;background:#000;}
</style>
</head>

<body>

<header>
  <div>
    <strong>METRO WATCHDOG</strong>
    <span id="adminBadge" class="hidden admin-badge">ADMIN ACCESS</span>
  </div>
  <div id="authContainer" class="hidden">
    <span id="userInfo" style="margin-right:10px;color:#94a3b8;"></span>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px;margin:50px auto;">
    <h3>Secure Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()" style="width:100%">Login</button>
  </div>
</section>

<div id="faceModal" class="hidden">
  <h2 id="modalTitle" style="color:white">Biometric Verification</h2>
  <p id="modalDesc" style="color:#94a3b8; margin-bottom:10px; text-align:center">Checking identity...</p>
  
  <video id="cameraFeed" autoplay playsinline></video>
  <canvas id="faceCanvas" width="320" height="240" class="hidden"></canvas>
  <canvas id="compareCanvas" width="32" height="32" class="hidden"></canvas> <button id="btnCapture" onclick="handleFaceCapture()">üì∏ Capture Photo</button>
  <p id="faceStatus" style="color:#fbbf24; margin-top:10px; font-weight:bold;"></p>
</div>

<section id="appSection" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data Entry</button>
    <button class="nav-btn" onclick="switchTab('oldData')" id="btnOld">2. Old Data View</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">3. Assigned Work</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#7c2d12;color:#fdba74">Admin Panel</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Session Data Entry</h3>
      <p style="color:#10b981;font-size:0.9em">Data auto-saves as DRAFT. Click Submit to finalize.</p>
      <div style="margin-bottom:10px;">
        <button onclick="addSessionRow()">+ Add Row</button>
        <button onclick="submitSession()" style="background:#10b981">‚úî Submit Final</button>
      </div>
      <table>
        <thead><tr><th>A</th><th>B</th><th>C</th><th>Action</th></tr></thead>
        <tbody id="sessionBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-oldData" class="hidden">
    <div class="panel">
      <h3>üìÅ Global History</h3>
      <table>
        <thead><tr><th>A</th><th>B</th><th>C</th><th>User</th><th>Date</th><th id="adminDelHead" class="hidden">Admin</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel">
      <h3>üìã Work Assigned to You</h3>
      <p id="noWorkMsg">No pending tasks.</p>
      <div id="taskList"></div>
    </div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <h3>üõ† Admin Controls</h3>
      
      <div style="border-bottom:1px solid #334155;padding-bottom:15px;margin-bottom:15px;">
        <h4>Assign Work</h4>
        <select id="userSelect"><option>Loading users...</option></select>
        <textarea id="taskDesc" placeholder="Describe the work assignment..."></textarea>
        <button onclick="assignTask()">Assign Task</button>
      </div>

      <div>
        <h4>User Management</h4>
        <table>
          <thead><tr><th>Email</th><th>Face Data</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="userListBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

/* --- CONFIG --- */
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* --- STATE --- */
let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];

// BIOMETRIC STATE
let tempPhotos = [];
let verificationMode = "register"; // 'register' or 'verify'
let videoStream = null;

/* --- AUTH & LOGIN --- */
// 1. SET PERSISTENCE: REFRESH = LOGOUT
setPersistence(auth, browserSessionPersistence);

window.login = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert("Login Error: " + e.message));
};

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if (!user) {
    // Logged Out
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    stopCamera();
    return;
  }

  // Logged In
  currentUser = user;
  document.getElementById("authContainer").classList.remove("hidden");
  userInfo.innerText = user.email;
  
  isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
  
  // CHECK USER STATUS AND FACE DATA
  const userRef = ref(db, `users/${user.uid}`);
  onValue(userRef, (snap) => {
    const userData = snap.val();
    
    // 1. Terminated Check
    if (userData && userData.terminated === true) {
      alert("ACCOUNT TERMINATED BY ADMIN");
      signOut(auth);
      return;
    }

    // 2. Face Data Check
    loginSection.classList.add("hidden");
    document.getElementById("faceModal").classList.remove("hidden");
    startCamera();

    if (!userData || !userData.faceData || !userData.faceData.photo1 || !userData.faceData.photo2) {
        // MODE: REGISTER (Needs 2 photos)
        verificationMode = "register";
        tempPhotos = [];
        updateModalUI("Registration Required", "Step 1: Take Photo 1 of 2 (Look Straight)");
    } else {
        // MODE: VERIFY (Compare against stored)
        verificationMode = "verify";
        tempPhotos = [userData.faceData.photo1, userData.faceData.photo2];
        updateModalUI("Identity Verification", "Please take a photo to verify it's you.");
    }

  }, { onlyOnce: true });
});

/* --- FACE LOGIC --- */

async function startCamera() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById("cameraFeed").srcObject = videoStream;
  } catch(e) {
    alert("Camera permission denied. Logic cannot proceed.");
  }
}

function stopCamera() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
}

function updateModalUI(title, desc) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalDesc").innerText = desc;
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("faceStatus").innerText = "";
}

window.handleFaceCapture = () => {
  const video = document.getElementById("cameraFeed");
  const canvas = document.getElementById("faceCanvas");
  const context = canvas.getContext('2d');
  
  // Capture
  context.drawImage(video, 0, 0, 320, 240);
  const capturedImg = canvas.toDataURL("image/png");

  const status = document.getElementById("faceStatus");
  const btn = document.getElementById("btnCapture");
  
  btn.disabled = true;
  status.innerText = "Processing...";

  if (verificationMode === "register") {
    // --- REGISTRATION LOGIC ---
    if (tempPhotos.length === 0) {
        tempPhotos.push(capturedImg);
        status.innerText = "Photo 1 Saved.";
        setTimeout(() => {
            updateModalUI("Registration Required", "Step 2: Take Photo 2 of 2 (Slightly different angle)");
        }, 1000);
    } else {
        // Save both
        update(ref(db, `users/${currentUser.uid}/faceData`), {
            photo1: tempPhotos[0],
            photo2: capturedImg
        }).then(() => {
            status.style.color = "#10b981";
            status.innerText = "Registration Complete! Entering system...";
            setTimeout(accessGranted, 1500);
        });
    }
  } 
  else if (verificationMode === "verify") {
    // --- VERIFICATION LOGIC (70% Match) ---
    compareFace(capturedImg, tempPhotos).then(matchScore => {
        if(matchScore >= 70) {
            status.style.color = "#10b981";
            status.innerText = `Match: ${matchScore}% - ACCESS GRANTED`;
            setTimeout(accessGranted, 1500);
        } else {
            status.style.color = "#ef4444";
            status.innerText = `Match: ${matchScore}% - FAILED. Logging out...`;
            setTimeout(logout, 2000);
        }
    });
  }
};

function accessGranted() {
    document.getElementById("faceModal").classList.add("hidden");
    stopCamera();
    initializeAppUI();
}

/* --- IMAGE COMPARISON ALGORITHM (Client-Side Pixel Diff) --- */
function compareFace(newImg, storedImages) {
    return new Promise(resolve => {
        let bestScore = 0;
        let processed = 0;
        
        storedImages.forEach(stored => {
            const img1 = new Image(); img1.src = newImg;
            const img2 = new Image(); img2.src = stored;
            
            img1.onload = () => {
                img2.onload = () => {
                    const score = getSimilarity(img1, img2);
                    if(score > bestScore) bestScore = score;
                    processed++;
                    if(processed === storedImages.length) resolve(Math.floor(bestScore));
                }
            }
        });
    });
}

function getSimilarity(img1, img2) {
    // Resize to small 32x32 for fast comparison
    const c = document.getElementById("compareCanvas");
    const ctx = c.getContext("2d");
    
    ctx.drawImage(img1, 0, 0, 32, 32);
    const d1 = ctx.getImageData(0,0,32,32).data;
    
    ctx.clearRect(0,0,32,32);
    ctx.drawImage(img2, 0, 0, 32, 32);
    const d2 = ctx.getImageData(0,0,32,32).data;
    
    let diff = 0;
    for(let i=0; i<d1.length; i+=4) {
        diff += Math.abs(d1[i] - d2[i]); // R
        diff += Math.abs(d1[i+1] - d2[i+1]); // G
        diff += Math.abs(d1[i+2] - d2[i+2]); // B
    }
    
    const maxDiff = 255 * 3 * 32 * 32;
    // Simple heuristic: invert diff percentage
    let match = 100 - ((diff / maxDiff) * 100);
    
    // Boost score (webcams vary slightly even for same person)
    // If raw match > 85%, treat as 98%. If > 75%, treat as 85%.
    if(match > 85) return match + 10; 
    if(match > 75) return match + 10;
    return match;
}

/* --- MAIN APP LOGIC --- */
function initializeAppUI() {
  loginSection.classList.add("hidden");
  appSection.classList.remove("hidden");

  // Admin UI Adjustments
  if (isAdmin) {
    document.getElementById("adminBadge").classList.remove("hidden");
    document.getElementById("btnAdmin").classList.remove("hidden");
    document.getElementById("adminDelHead").classList.remove("hidden");
    loadAdminPanel();
  }

  // Register User Email
  update(ref(db, `users/${currentUser.uid}`), { email: currentUser.email });

  // Load Data
  loadSession();
  loadHistory();
  loadAssignments();
}

/* --- TAB NAVIGATION --- */
window.switchTab = (tabName) => {
  ['newData', 'oldData', 'assigned', 'adminPanel'].forEach(t => {
    const el = document.getElementById(`tab-${t}`);
    if(el) el.classList.add("hidden");
  });
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tab-${tabName}`).classList.remove("hidden");
  
  const map = { 'newData': 'btnNew', 'oldData': 'btnOld', 'assigned': 'btnAssign', 'adminPanel': 'btnAdmin' };
  if(map[tabName]) document.getElementById(map[tabName]).classList.add("active");
};

/* --- 1. SESSION (NEW DATA) --- */
function loadSession() {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    sessionBody.innerHTML = "";
    snap.forEach(r => {
      const tr = document.createElement("tr");
      ["A", "B", "C"].forEach(c => {
        const td = document.createElement("td");
        const i = document.createElement("input");
        i.className = "cell";
        i.value = r.val()[c] || "";
        i.onchange = () => set(ref(db, `excelData/session/${currentUser.uid}/${r.key}/${c}`), i.value);
        td.appendChild(i);
        tr.appendChild(td);
      });
      const delTd = document.createElement("td");
      delTd.innerHTML = `<button class="danger" onclick="deleteDraft('${r.key}')">X</button>`;
      tr.appendChild(delTd);
      sessionBody.appendChild(tr);
    });
  });
}

window.addSessionRow = () => push(ref(db, "excelData/session/" + currentUser.uid), { A: "", B: "", C: "" });
window.deleteDraft = (key) => remove(ref(db, `excelData/session/${currentUser.uid}/${key}`));

window.submitSession = () => {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    if(!snap.exists()) return alert("Nothing to submit");
    snap.forEach(r => {
      push(ref(db, "excelData/history"), {
        ...r.val(),
        user: currentUser.email,
        date: new Date().toLocaleString()
      });
    });
    remove(ref(db, "excelData/session/" + currentUser.uid));
    alert("Session data submitted to History.");
    switchTab('oldData');
  }, { onlyOnce: true });
};

/* --- 2. OLD DATA (HISTORY) --- */
function loadHistory() {
  onValue(ref(db, "excelData/history"), snap => {
    historyBody.innerHTML = "";
    snap.forEach(r => {
      const d = r.val();
      const tr = document.createElement("tr");
      ["A", "B", "C", "user", "date"].forEach(k => {
        const td = document.createElement("td");
        td.innerText = d[k] || "";
        tr.appendChild(td);
      });
      const actionTd = document.createElement("td");
      if(isAdmin) {
        actionTd.innerHTML = `<button class="danger" style="padding:4px 8px" onclick="deleteHistory('${r.key}')">Delete</button>`;
        actionTd.style.display = "table-cell";
      } else {
        actionTd.style.display = "none";
      }
      tr.appendChild(actionTd);
      historyBody.appendChild(tr);
    });
  });
}

window.deleteHistory = (key) => {
  if(confirm("Admin: Permanently delete this record?")) {
    remove(ref(db, `excelData/history/${key}`));
  }
};

/* --- 3. ASSIGNED WORK --- */
function loadAssignments() {
  onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
    const list = document.getElementById("taskList");
    list.innerHTML = "";
    let count = 0;
    
    snap.forEach(task => {
      count++;
      const div = document.createElement("div");
      div.className = "panel";
      div.style.borderLeft = "4px solid #f59e0b";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between">
            <strong>Assigned by Admin</strong>
            <button class="danger" onclick="completeTask('${task.key}')">Mark Complete</button>
        </div>
        <p style="font-size:1.1em;margin-top:10px">${task.val().description}</p>
        <small style="color:#64748b">${task.val().date}</small>
      `;
      list.appendChild(div);
    });

    if(count > 0) {
        document.getElementById("noWorkMsg").classList.add("hidden");
        if(!sessionStorage.getItem("notified")) {
            alert("üîî NOTIFICATION: You have " + count + " new assigned tasks!");
            sessionStorage.setItem("notified", "true");
        }
    } else {
        document.getElementById("noWorkMsg").classList.remove("hidden");
    }
  });
}

window.completeTask = (key) => {
    if(confirm("Remove this task from your list?")) {
        remove(ref(db, `assignments/${currentUser.uid}/${key}`));
    }
};

/* --- 4. ADMIN PANEL FUNCTIONS --- */
function loadAdminPanel() {
  onValue(ref(db, "users"), snap => {
    const select = document.getElementById("userSelect");
    const tbody = document.getElementById("userListBody");
    
    const currentVal = select.value;
    select.innerHTML = "<option value=''>Select User to Assign Work</option>";
    tbody.innerHTML = "";

    snap.forEach(u => {
      const user = u.val();
      const uid = u.key;
      
      // Dropdown
      const opt = document.createElement("option");
      opt.value = uid;
      opt.innerText = user.email;
      select.appendChild(opt);

      // Table Row
      const tr = document.createElement("tr");
      const isTerminated = user.terminated === true;
      const hasFace = (user.faceData && user.faceData.photo1 && user.faceData.photo2);
      
      tr.innerHTML = `
        <td>${user.email}</td>
        <td>
           ${hasFace ? `<span style="color:#10b981">Captured (2 Photos) ‚úÖ</span>` : `<span style="color:#ef4444">Missing ‚ùå</span>`}
        </td>
        <td>
           ${isTerminated ? `<span style="color:#ef4444">Terminated</span>` : `<span style="color:#10b981">Active</span>`}
        </td>
        <td style="display:flex; gap:5px;">
            ${isTerminated 
                ? `<button style="background:#10b981" onclick="toggleTerm('${uid}', false)">Activate</button>` 
                : `<button class="danger" onclick="toggleTerm('${uid}', true)">Terminate</button>`}
            
            ${hasFace 
                ? `<button class="warning" onclick="resetFace('${uid}')">Reset Face</button>`
                : ``}
        </td>
      `;
      tbody.appendChild(tr);
    });
    if(currentVal) select.value = currentVal;
  });
}

window.assignTask = () => {
  const uid = document.getElementById("userSelect").value;
  const desc = document.getElementById("taskDesc").value;
  
  if(!uid || !desc) return alert("Select user and enter description");
  
  push(ref(db, `assignments/${uid}`), {
    description: desc,
    assignedBy: currentUser.email,
    date: new Date().toLocaleString()
  }).then(() => {
    alert("Work Assigned!");
    document.getElementById("taskDesc").value = "";
  });
};

window.toggleTerm = (uid, status) => {
  update(ref(db, `users/${uid}`), { terminated: status });
};

window.resetFace = (uid) => {
    if(confirm("Reset Face Data? User will need to register 2 new photos next login.")) {
        update(ref(db, `users/${uid}`), { faceData: null });
    }
}

</script>
</body>
</html>
