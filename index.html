<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRPSP | Metro Railway Platform Safety Project</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
/* --- PREMIUM ENTERPRISE METRO THEME --- */
:root {
  --metro-blue: #0f172a;    /* Premium Slate Navy */
  --metro-gold: #fbbf24;    /* Vibrant Gold Accent */
  --metro-red: #e11d48;     /* Modern Rose Red */
  --metro-slate: #64748b;
  --bg-color: #f8fafc;      /* Modern light background */
  --panel-bg: #ffffff;
  --text-main: #1e293b;
  --border-color: #e2e8f0;
  --success-green: #10b981;
  --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

body { 
    margin: 0; 
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
    background: var(--bg-color); 
    color: var(--text-main); 
    font-size: 14px; 
    line-height: 1.6;
    letter-spacing: -0.01em;
}

/* HEADER - MODERN STICKY BAR */
header {
  background: var(--metro-blue);
  color: white;
  padding: 0.8rem 2rem;
  border-bottom: 3px solid var(--metro-gold);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  position: sticky; top: 0; z-index: 1001;
}

/* BUTTONS - REFINED HD STYLE */
button {
  padding: 10px 20px;
  cursor: pointer;
  background: var(--metro-blue);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
button:hover { background: #1e293b; transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
button:active { transform: translateY(0); }
button:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

button.danger { background: var(--metro-red); }
button.success { background: var(--success-green); }
button.warning { background: #f59e0b; }
button.info { background: #3b82f6; }
button.secondary { background: #64748b; }

/* INPUTS - BORDERLESS FOCUS STYLE */
input, select, textarea {
  background: #fff;
  border: 1.5px solid var(--border-color);
  color: var(--text-main);
  padding: 12px;
  border-radius: 8px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 12px;
  font-size: 14px;
  transition: all 0.2s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--metro-gold);
  box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.15);
}

/* NAVIGATION - MODERN HORIZONTAL CHIPS */
.nav-bar { 
    display: flex; 
    overflow-x: auto;
    gap: 8px; 
    margin: 20px auto; 
    padding: 10px; 
    background: #fff;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    max-width: 1200px; 
    border: 1px solid var(--border-color);
    scrollbar-width: none;
}
.nav-bar::-webkit-scrollbar { display: none; }

.nav-btn { 
    background: transparent; 
    color: var(--metro-slate); 
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
    box-shadow: none;
}
.nav-btn.active { 
    background: var(--metro-blue); 
    color: white; 
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
}
.nav-btn:hover:not(.active) { background: #f1f5f9; color: var(--metro-blue); }

/* PANELS - BREATHABLE DATA CARDS */
.panel {
  background: var(--panel-bg);
  padding: 24px;
  border: 1px solid var(--border-color);
  border-radius: 16px;
  margin-bottom: 24px;
  box-shadow: var(--card-shadow);
}
.panel h3 { 
    margin: 0 0 20px 0; 
    color: var(--metro-blue); 
    font-size: 1.15rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid #f1f5f9;
    padding-bottom: 15px;
}

/* TABLES - CLEAN DATA GRID */
.table-wrapper { border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; }
th { 
    background: #f8fafc; 
    color: var(--metro-slate); 
    font-weight: 700; 
    text-transform: uppercase; 
    font-size: 11px; 
    padding: 16px;
    border-bottom: 2px solid var(--border-color);
}
td { padding: 16px; border-bottom: 1px solid var(--border-color); }
tr:hover { background: #fcfcfd; }

/* MODALS - GLASSMORPHISM OVERLAYS */
.modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(15, 23, 42, 0.65); 
    backdrop-filter: blur(8px); 
    display: flex; justify-content: center; align-items: center; 
    z-index: 2000; 
}

#videoContainer { 
    position: relative; width: 320px; height: 240px; 
    background: #000; border-radius: 20px; 
    overflow: hidden; border: 4px solid #fff; 
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

/* DASHBOARD WIDGETS */
.finance-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
.fin-card { 
    background: white; padding: 24px; border-radius: 16px; 
    border-left: 6px solid #cbd5e1; box-shadow: var(--card-shadow);
    transition: transform 0.3s ease;
}
.fin-card:hover { transform: translateY(-5px); }
.amount { font-size: 26px; font-weight: 800; color: var(--metro-blue); margin: 10px 0; }
.fin-card.income { border-left-color: var(--success-green); }
.fin-card.expense { border-left-color: var(--metro-red); }

/* --- PRESERVE ALL ORIGINAL PRINT LOGIC --- */
@media print {
    body * { visibility: hidden !important; height: 0 !important; }
    #printableReportContainer, #printableReportContainer * { visibility: visible !important; height: auto !important; }
    #printableReportContainer { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; margin: 0 !important; }
    .no-print { display: none !important; }
}

#loginSection {
    background: radial-gradient(circle at top right, #f1f5f9, #e2e8f0);
    min-height: 95vh;
    display: flex;
    align-items: center;
}
</style>
</head>

<body>
<header>
Â  <div style="display:flex; align-items:center">
Â  Â  <div style="width:45px;height:45px;background:var(--metro-gold);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:4px;flex-shrink:0; font-size: 24px;">M</div>
Â  Â Â 
Â  Â  <div>
Â  Â  Â  Â  <h1 style="margin:0; line-height:1.2; font-size: 1.3rem; letter-spacing: 0.5px;">METRO RAILWAY PLATFORM SAFETY PROJECT</h1>
Â  Â  Â  Â  <small style="color: #cbd5e1; font-weight: 600; text-transform: uppercase; font-size: 10px;">Official Audit & Inspection Portal</small>
Â  Â  </div>
Â  </div>

Â  <div id="authContainer" class="hidden">
Â  Â  <span style="font-size:11px; margin-right:5px; opacity:0.7;">Logged in as:</span>
Â  Â  <span id="userInfo" style="margin-right:20px; font-weight:bold; color:var(--metro-gold);"></span>
Â  Â  <button class="danger" onclick="logout()" style="padding:6px 12px; font-size:11px;">TERMINATE SESSION</button>
Â  </div>
</header>
<section id="loginSection">
Â  <div class="panel" style="max-width:380px; margin: 80px auto; border-top: 6px solid var(--metro-blue); padding: 40px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
Â  Â  <div style="text-align:center; margin-bottom:20px;">
Â  Â  Â  Â  <i class="fas fa-shield-alt" style="font-size: 48px; color: var(--metro-blue);"></i>
Â  Â  Â  Â  <h3 style="border:none; margin-top:15px; justify-content:center; padding:0;">Metro Platform Safety Project Access</h3>
Â  Â  </div>
Â  Â  <input id="email" placeholder="Official Email ID (user@metro.gov)">
Â  Â  <input id="password" type="password" placeholder="Secure Password">
Â  Â  <button onclick="login()" style="width:100%; padding:12px; margin-top:15px; font-size: 14px;">VERIFY CREDENTIALS</button>
Â  Â Â 
Â  Â  <p style="font-size:11px; color:#64748b; margin-top:25px; text-align:center; line-height: 1.4;">
Â  Â  Â  Â  <strong>RESTRICTED SYSTEM:</strong> Unauthorized access is prohibited and monitored. Use of this system constitutes consent to security monitoring and auditing.
Â  Â  </p>
Â  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:350px; max-width:90%; text-align:center;">
Â  Â  Â  Â  <h3><i class="fas fa-user-edit"></i> Profile Setup</h3>
Â  Â  Â  Â  <p style="color:#475569; margin-bottom:20px;">Please enter your official name as per records.</p>
Â  Â  Â  Â  <input id="officialNameInput" placeholder="Full Name (e.g. Rahul Roy)">
Â  Â  Â  Â  <button onclick="saveOfficialName()" class="success" style="width:100%;">Save & Continue</button>
Â  Â  </div>
</div>
Â <div id="faceModal" class="modal-overlay hidden">
Â  <div class="panel" style="background: #1e293b; border: 1px solid #334155; color: white; width: 360px; text-align:center; padding: 20px;">
Â  Â  Â  <h2 id="modalTitle" style="color:white; margin-bottom:5px; font-size: 1.2rem;">Biometric Verification</h2>
Â  Â  Â  <p id="modalDesc" style="color:#94a3b8; margin-bottom:20px; font-size:13px;">Security Level 2: Face Scan</p>
Â  Â  Â Â 
Â  Â  Â  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
Â  Â  Â  Â  Â  <div id="dot1" class="dot"></div>
Â  Â  Â  Â  Â  <div id="dot2" class="dot"></div>
Â  Â  Â  Â  Â  <div id="dot3" class="dot"></div>
Â  Â  Â  </div>

Â  Â  Â  <div id="videoContainer" style="margin: 0 auto 20px auto;">
Â  Â  Â  Â  <video id="cameraFeed" autoplay playsinline muted></video>
Â  Â  Â  Â  <canvas id="overlayCanvas"></canvas>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div id="otpUI" class="hidden" style="background:white; padding:25px; border-radius:8px; width:280px; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index:20; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
Â  Â  Â  Â  <h3 style="color:var(--metro-red); margin-top:0; border-bottom: none;"><i class="fas fa-shield-alt"></i> Admin PIN</h3>
Â  Â  Â  Â  <input id="otpInput" type="password" placeholder="PIN" style="text-align:center; font-size:20px; letter-spacing:8px; border:2px solid var(--metro-blue); font-weight: bold; color: black; margin-bottom: 15px;">
Â  Â  Â  Â  <button class="success" onclick="verifyOTP()" style="width:100%;">Authorize Access</button>
Â  Â  Â  </div>

Â  Â  Â  <div id="faceStatus" style="color:var(--metro-gold); margin-bottom:15px; font-weight:bold; height:20px; font-size: 12px;"></div>
Â  Â  Â Â 
Â  Â  Â  <div id="camControls" style="display:flex; flex-direction:column; gap:10px; align-items:center;">
Â  Â  Â  Â  <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:var(--metro-blue); border:none; padding:12px 25px; font-weight: bold; width: 100%;">ğŸ“¸ SCAN FACE</button>
Â  Â  Â  Â  <a href="javascript:void(0)" onclick="triggerAdminBypass()" style="color:#94a3b8; font-size:11px; text-decoration:underline;">PC without camera? Use Master Bypass</a>
Â  Â  Â  </div>
Â  </div>
</div>
<div id="barcodeModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:360px; max-width:95%; text-align:center; background:#0f172a; border:2px solid var(--metro-gold); padding: 20px;">
Â  Â  Â  Â  <h3 style="color:white; margin-bottom:15px; border-bottom-color: #334155;"><i class="fas fa-qrcode"></i> Scan Asset Tag</h3>
Â  Â  Â  Â  <div id="reader" style="border-radius: 8px; overflow: hidden;"></div>
Â  Â  Â  Â  <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:20px; width:100%;">CANCEL SCAN</button>
Â  Â  </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
Â  Â  <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
Â  Â  Â  Â  <h3>Digital Signature Record</h3>
Â  Â  Â  Â  <img id="modalSigImage" src="" style="border:1px solid #e2e8f0; background:white; max-width:100%; margin:15px 0; padding: 10px;">
Â  Â  Â  Â  <br>
Â  Â  Â  Â  <button onclick="closeSigModal()" class="secondary">Close Viewer</button>
Â  Â  </div>
</div>

<section id="appScreen" class="hidden">
Â  <div class="nav-bar">
Â  Â  <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">
Â  Â  Â  Â  <i class="fas fa-ruler-combined"></i> Field Inspection
Â  Â  </button>
Â  Â Â 
Â  Â  <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">
Â  Â  Â  Â  <i class="fas fa-boxes"></i> Asset Tracking
Â  Â  </button>
Â  Â Â 
Â  Â  <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">
Â  Â  Â  Â  <i class="fas fa-folder-open"></i> Compliance Docs
Â  Â  </button>
Â  Â Â 
Â  Â  <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">
Â  Â  Â  Â  <i class="fas fa-tasks"></i> Operation Tasks
Â  Â  </button>
Â  Â  <button class="nav-btn" onclick="switchTab('comments')" id="btnComments">
Â  Â  <i class="fas fa-comment-dots"></i> Station Comments
</button>
Â  Â  <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="color:var(--metro-red);">
Â  Â  Â  Â  <i class="fas fa-user-shield"></i> System Oversight
Â  Â  </button>
Â  Â Â 
Â  Â  <button class="nav-btn" onclick="switchTab('dataView')" id="btnDataView">
Â  Â  Â  Â  <i class="fas fa-database"></i> Master Logs
Â  Â  </button>
Â  Â  <button class="nav-btn" onclick="switchTab('funds')" id="btnFunds">
Â  Â  Â  Â  <i class="fas fa-rupee-sign"></i> Project Funds
Â  Â  </button>
Â  Â  <button class="nav-btn" onclick="switchTab('purchase')" id="btnPurchase">
Â  Â  Â  Â  <i class="fas fa-shopping-cart"></i> Procurement
Â  Â  </button>
Â  Â  <button class="nav-btn" onclick="switchTab('printReport')" id="btnPrintReport">
Â  Â  Â  Â  <i class="fas fa-print"></i> Audit Reports
Â  Â  </button>
Â  Â  <button class="nav-btn" onclick="switchTab('directives')" id="btnDirectives">
Â  Â  <i class="fas fa-file-contract"></i>Directives
</button>
Â  Â  <button class="nav-btn" onclick="switchTab('billing')" id="btnBilling">
Â  Â  <i class="fas fa-file-invoice-dollar"></i> Customer Billing
</button>
Â  Â  <button class="nav-btn" onclick="switchTab('warranty')" id="btnWarranty">
Â  Â  <i class="fas fa-shield-halved"></i> Warranty & Claims
</button>
Â  Â  <span id="adminBadge" class="hidden" style="margin-left:auto; background:var(--metro-red); color:white; padding:6px 12px; border-radius:20px; font-size:10px; font-weight:bold; display:flex; align-items:center; letter-spacing: 0.5px;">
Â  Â  Â  Â  <i class="fas fa-shield-alt" style="margin-right:5px;"></i> AUDITOR
Â  Â  </span>
</div>

<div id="tab-newData">
Â  <div class="panel">
Â  Â  <h3><i class="fas fa-map-marker-alt"></i> Select Inspection Site</h3>
Â  Â  <label style="font-weight:700; color:var(--metro-blue); font-size: 12px; text-transform: uppercase;">Step 1: Select Corridor</label>
Â  Â  <select id="lineSelect" onchange="handleLineChange()" style="border:2px solid var(--metro-blue); font-weight:600;">
Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  <option value="Blue Line">Blue Line (North-South: Dakshineswar â†” New Garia)</option>
Â  Â  Â  <option value="Green Line">Green Line (East-West: Sector V â†” Howrah Maidan)</option>
Â  Â  Â  <option value="Purple Line">Purple Line (Joka â†” Majerhat)</option>
Â  Â  Â  <option value="Yellow Line">Yellow Line (Noapara â†” Airport)</option>
Â  Â  Â  <option value="Orange Line">Orange Line (New Garia â†” Airport)</option>
Â  Â  Â  <option value="Pink Line">Pink Line (Baranagar â†” Barrackpore)</option>
Â  Â  </select>

Â  Â  <label style="font-weight:700; color:var(--metro-blue); margin-top:15px; display:block; font-size: 12px; text-transform: uppercase;">Step 2: Select Station</label>
Â  Â  <select id="stationSelect" onchange="handleStationChange()" disabled style="background:#f1f5f9;">
Â  Â  Â  <option value="">-- First Select a Corridor --</option>
Â  Â  </select>
Â  </div>

Â  <div id="mainDataForm" class="hidden">
Â  Â Â 
Â  Â  <div id="dataExistsWarning" class="hidden" style="background:#fff7ed; color:#9a3412; padding:15px; border:1px solid #fed7aa; border-radius:6px; margin-bottom:20px; display: flex; gap: 10px; align-items: center;">
Â  Â  Â  Â  <i class="fas fa-exclamation-circle" style="font-size: 20px;"></i>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <strong>Existing Record Found</strong><br>
Â  Â  Â  Â  Â  Â  Primary measurement data is locked. You may append additional rake data below.
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="panel" id="stationDetailsPanel" style="border-left: 4px solid var(--success-green);">
Â  Â  Â  <h3 id="formTitle">ğŸ“ Yellow Line Specification</h3>
Â  Â  Â  <input id="inpStationName" type="hidden">Â 
Â  Â  Â Â 
Â  Â  Â  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:20px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b;">PLATFORM LENGTH (m)</label>
Â  Â  Â  Â  Â  Â  <input id="inpStationLength" placeholder="e.g. 180">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b;">YL DISTANCE (cm)</label>
Â  Â  Â  Â  Â  Â  <input id="inpYellowDist" placeholder="e.g. 85">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b;">YL THICKNESS (cm)</label>
Â  Â  Â  Â  Â  Â  <input id="inpYellowThick" placeholder="e.g. 10">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">IMPLEMENTATION STATUS</label>
Â  Â  Â  Â  Â  Â  <select id="inpImplementation" style="font-weight:bold; border:2px solid var(--metro-blue);">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Status --</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="YES">âœ… COMPLIANT (YES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="NO">âŒ NON-COMPLIANT (NO)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b;">INSPECTOR REMARKS</label>
Â  Â  Â  <textarea id="inpRemarks" placeholder="Observations regarding safety compliance..." rows="3"></textarea>
Â  Â  Â Â 
Â  Â  Â  <div style="text-align:right; margin-top: 15px;">
Â  Â  Â  Â  Â  <button class="secondary" id="btnSaveDraft" onclick="saveStationDetails()"><i class="fas fa-save"></i> Save Draft</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â <div class="panel">
Â  Â  <h4><i class="fas fa-train"></i> Rake Clearance Data</h4>
Â  Â Â 
Â  Â  <div class="table-wrapper" style="margin-top:15px;">
Â  Â  Â  Â  <table style="width:100%">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width:50px; text-align:center;">#</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rake ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rake Series</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Front Clearance (mm)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Rear Clearance (mm)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center;">Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="distanceBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <div style="margin-top:20px; display:flex; justify-content:space-between; align-items: center;">
Â  Â  Â  Â  <button class="info" onclick="addDistanceRow()">+ Add Measurement Row</button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button onclick="submitStationData()" id="btnFinalSubmit" class="success" style="padding: 12px 24px;">
Â  Â  Â  Â  Â  Â  <i class="fas fa-check-circle"></i> SUBMIT FINAL REPORT
Â  Â  Â  Â  </button>
Â  Â  </div>
Â  Â </div>

Â  </div>Â 
</div>

<div id="tab-inventory" class="hidden">
Â  Â Â 
Â  Â  <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; padding: 10px; background: #e2e8f0; border-radius: 6px;">
Â  Â  Â  Â  <button onclick="toggleInvMode('list')" class="info"><i class="fas fa-list"></i> View Stock</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('add')" class="success"><i class="fas fa-plus"></i> New Asset</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('checkout')" class="warning"><i class="fas fa-sign-out-alt"></i> Checkout</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('return')" class="info" style="background:var(--metro-blue); border-color:var(--metro-blue);"><i class="fas fa-sign-in-alt"></i> Return</button>
Â  Â  Â  Â  <button onclick="toggleInvMode('history')" class="secondary"><i class="fas fa-history"></i> Audit Trail</button>
Â  Â  </div>

<div id="inv-add" class="panel hidden" style="border-top: 4px solid var(--success-green);">
Â  Â  <h3 id="invFormTitle" style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> Register New Asset</h3>
Â  Â  <input type="hidden" id="editItemKey"> <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
Â  Â  Â  Â  <div style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  <input id="invBarcode" placeholder="Scan/Type Tag ID" onchange="checkBarcodeUnique(this.value)">
Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('ADD')" class="secondary" style="width:45px; padding:0;"><i class="fas fa-qrcode"></i></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input id="invName" placeholder="Asset Name (e.g. Raspberry Pi)">
Â  Â  Â  Â  <input type="number" id="invRegPrice" placeholder="Purchase Price (â‚¹)">
Â  Â  </div>
Â  Â  Â Â 
Â  Â  <div id="barcodeError" class="hidden" style="background:#fee2e2; color:#991b1b; padding:10px; border-radius:4px; margin-bottom:15px;">
Â  Â  Â  Â  <i class="fas fa-ban"></i> Error: Tag ID already exists.
Â  Â  </div>

Â  Â  <div style="display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:15px; margin-bottom:15px;">
Â  Â  Â  Â  <select id="addLocSelect">
Â  Â  Â  Â  Â  Â  <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
Â  Â  Â  Â  Â  Â  <option value="Soham Pal Bag">Soham Pal Bag</option>
Â  Â  Â  Â  Â  Â  <option value="Other">Other (Specify...)</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input id="addLocSpot" placeholder="Unit/Rack (e.g. Shelf 1)">
Â  Â  Â  Â  <select id="invCondition">
Â  Â  Â  Â  Â  Â  <option value="New">Condition: New</option>
Â  Â  Â  Â  Â  Â  <option value="Good" selected>Condition: Good</option>
Â  Â  Â  Â  Â  Â  <option value="Damaged">Condition: Damaged</option>
Â  Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  Â  <button id="btnAddStock" onclick="addUniqueItem()" class="success" style="flex:2;">SAVE ASSET DATA</button>
Â  Â  Â  Â  <button id="btnCancelEdit" onclick="resetInvForm()" class="secondary hidden" style="flex:1;">CANCEL EDIT</button>
Â  Â  </div>
</div>
Â  <div id="inv-checkout" class="panel hidden" style="border-top: 4px solid #d97706;">
Â  Â  <h3 style="color:#d97706;"><i class="fas fa-sign-out-alt"></i> Asset Checkout Protocol</h3>
Â  Â  <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
Â  Â  Â  Â  Scan asset barcode to initiate checkout sequence.
Â  Â  </p>
Â  Â Â 
Â  Â  <div style="text-align:center; padding:20px; background: #fff7ed; border-radius: 8px;">
Â  Â  Â  Â  <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px;">
Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i> INITIATE SCAN
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="checkout_display" class="hidden" style="background:#fffbeb; padding:25px; border:1px solid #fcd34d; text-align:center; margin-top:20px; border-radius:6px;">
Â  Â  Â  Â  <h2 id="checkout_item_name" style="color:#92400e; margin:0 0 10px 0;">--</h2>
Â  Â  Â  Â  <div style="font-family:'Courier New', monospace; font-size:14px; color:#78350f; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  ID: <span id="checkout_item_code" style="font-weight:bold;">--</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <label style="display:block; text-align:left; font-size:11px; font-weight:bold; color:#92400e; margin-bottom: 5px;">PURPOSE OF USAGE</label>
Â  Â  Â  Â  <input id="checkoutPurpose" placeholder="e.g. Scheduled Maintenance, Testing" style="border-color: #f59e0b;">

Â  Â  Â  Â  <div id="btn_checkout_verify" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â <button onclick="submitTransactionNoFace('CHECKOUT')" style="background:#d97706; border:none; width:100%;">
Â  Â  Â  Â  Â  Â  Â  Â  CONFIRM WITHDRAWAL
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="inv-return" class="panel hidden" style="border-top: 4px solid var(--metro-blue);">
Â  Â  <h3 style="color:var(--metro-blue);"><i class="fas fa-undo"></i> Asset Return Protocol</h3>
Â  Â  <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
Â  Â  Â  Â  Scan asset barcode to verify return and update inventory location.
Â  Â  </p>
Â  Â Â 
Â  Â  <div style="text-align:center; padding:20px; background: #f0f9ff; border-radius: 8px;">
Â  Â  Â  Â  <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px; background: var(--metro-blue); border-color: var(--metro-blue);">
Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i> INITIATE RETURN SCAN
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="return_display" class="hidden" style="background:#f1f5f9; padding:25px; border:1px solid #cbd5e1; text-align:center; margin-top:20px; border-radius:6px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h2 id="return_item_name" style="color:var(--metro-blue); margin:0 0 10px 0;">--</h2>
Â  Â  Â  Â  <div style="font-family:'Courier New', monospace; font-size:14px; color:#475569; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  ID: <span id="return_item_code" style="font-weight:bold;">--</span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:left; background:white; padding:15px; border-radius:6px; border: 1px solid #e2e8f0;">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase;">Return Facility</label>
Â  Â  Â  Â  Â  Â  <select id="returnLocSelect" onchange="toggleOtherInput()" style="margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other (Specify...)</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <div id="divOtherLoc" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="returnLocOther" placeholder="Specify Facility Name">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase; margin-top: 10px; display: block;">Storage Unit / Rack</label>
Â  Â  Â  Â  Â  Â  <input id="returnLocSpot" placeholder="e.g. Cabinet A, Shelf 2">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="btn_return_verify" style="margin-top:20px;">
Â  Â  Â  Â  Â  Â  Â <button onclick="submitTransactionNoFace('RETURN')" class="info" style="width:100%; background: var(--metro-blue);">
Â  Â  Â  Â  Â  Â  Â  Â  CONFIRM RETURN
Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="inv-history" class="panel hidden">
Â  Â  <div style="text-align:center; padding:40px 20px;">
Â  Â  Â  Â  <h2 style="color:var(--metro-blue); margin-bottom:10px;">Asset Audit Trail</h2>
Â  Â  Â  Â  <p style="color:#64748b; margin-bottom:20px;">Scan barcode to retrieve complete lifecycle history.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="max-width:400px; margin:0 auto; display:flex; gap:10px;">
Â  Â  Â  Â  Â  Â  <inputÂ 
Â  Â  Â  Â  Â  Â  Â  Â  id="auditSearchInput"Â 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Scan or Enter Asset Tag..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="padding:12px; font-size:16px; border:2px solid var(--metro-blue); flex-grow:1;"
Â  Â  Â  Â  Â  Â  Â  Â  onchange="fetchAuditHistory(this.value)"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  onclick="openBarcodeScanner('AUDIT_SEARCH')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="warning"Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="padding:12px 20px; font-size:18px;"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="auditResultModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:450px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; background:#f8fafc; border: none;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin:0; font-size:16px; border:none; color:white; padding:0;">Asset Lifecycle</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <small id="auditModalBarcode" style="opacity:0.8; font-family:'Courier New', monospace;">--</small>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="auditTimelineContainer" style="overflow-y:auto; padding:20px; flex-grow:1;">
Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:#64748b;">Retrieving records...</div>
Â  Â  Â  Â  </div>

Â  Â  </div>
</div>

<div id="inv-list" class="panel">
Â  Â  <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; border:none; padding:0;">Current Inventory</h3>
Â  Â  Â  Â  Â  Â  <small id="stockSummaryText" style="color:var(--metro-blue); font-weight:bold;">Syncing Database...</small>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  Â  Â  Â  <input type="text" id="mainStockSearch" onkeyup="filterStockTable()" placeholder="Search Assets..." style="width:250px; margin:0;">
Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('SEARCH_STOCK')" class="secondary" title="Scan to Search">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="table-wrapper" style="max-height:600px; overflow-y:auto;">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead style="position:sticky; top:0;">
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tag ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Asset Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Cycle Count</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Custodian</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Location</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Purchase Price</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Controls</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="inventoryBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>

</div>Â 
<div id="tab-gallery" class="hidden">
Â Â 
Â  <div class="panel">
Â  Â  <h3><i class="fas fa-folder-open"></i> Compliance Documentation</h3>
Â  Â Â 
Â  Â  <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:20px;">
Â  Â  Â  Â  <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px; text-transform: uppercase;">1. Select Target Site</label>
Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-top:5px;">
Â  Â  Â  Â  Â  Â  <select id="galleryLineSelect" onchange="handleGalleryLineChange()" style="flex:1; border:2px solid var(--metro-blue);">
Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Orange Line">Orange Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Pink Line">Pink Line</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <select id="galleryStationSelect" onchange="handleGalleryStationChange()" disabled style="flex:1; background:#f1f5f9;">
Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line First --</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="galleryUploadSection" class="hidden">
Â  Â  Â  Â  <h4 style="margin:0 0 10px 0; color:var(--metro-blue);">2. Capture or Upload Evidence</h4>
Â  Â  Â  Â  <p id="uploadTargetText" style="font-weight:bold; color:var(--success-green); margin-bottom:15px;">Target: None</p>

Â  Â  Â  Â  <div style="display:flex; gap:20px; flex-wrap:wrap;">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="panel" style="flex:1; min-width:300px; padding:20px; text-align:center; border:2px dashed var(--metro-blue);">
Â  Â  Â  Â  Â  Â  Â  Â  <h5 style="margin-top:0;"><i class="fas fa-camera"></i> Live Capture</h5>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="evidenceVideoContainer" style="background:black; width:100%; height:200px; margin-bottom:10px; border-radius:4px; display:none; overflow:hidden;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <video id="evidenceVideo" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <img id="evidencePreview" style="max-width:100%; max-height:200px; display:none; margin:0 auto 10px auto; border:2px solid #22c55e;">

Â  Â  Â  Â  Â  Â  Â  Â  <div id="evidenceCamControls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="startEvidenceCamera()" class="info" style="width:100%;"><i class="fas fa-video"></i> Start Camera</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="evidenceCaptureControls" class="hidden" style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="captureEvidencePhoto()" class="warning" style="flex:1;"><i class="fas fa-camera"></i> Click</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="stopEvidenceCamera()" class="danger" style="width:40px;"><i class="fas fa-times"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="evidenceSaveControls" class="hidden" style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="uploadCapturedEvidence()" class="success" style="flex:1;">â¬† Upload Photo</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="retryEvidencePhoto()" class="secondary" style="width:40px;"><i class="fas fa-redo"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="panel" style="flex:1; min-width:300px; padding:20px; text-align:center; border:2px dashed #cbd5e1;">
Â  Â  Â  Â  Â  Â  Â  Â  <h5 style="margin-top:0;"><i class="fas fa-upload"></i> File Upload</h5>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size:11px; color:#666;">Max Size: 3MB | Formats: JPG, PNG, PDF</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size:11px; color:#666;">Limits: PDF (3MB) | Images (10MB)</p>Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="evidenceFile" accept="image/*,application/pdf" style="margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="uploadFileEvidence()" class="info" style="width:100%;">â¬† Upload File</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <hr style="margin:25px 0; border:0; border-top:1px solid #e2e8f0;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h4 style="color:var(--metro-blue);"><i class="fas fa-images"></i> Digital Repository</h4>
Â  Â  Â  Â  <div id="galleryContainer" class="gallery-grid">
Â  Â  Â  Â  Â  Â  <p style="color:#666; font-style:italic;">Select a station to view documents.</p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>
<div id="tab-assigned" class="hidden">
Â  Â  <div class="panel"><h3><i class="fas fa-clipboard-check"></i> Assigned Operations</h3><div id="taskList"></div></div>
</div>
<div id="tab-comments" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3><i class="fas fa-comment-dots"></i> General Station Observations</h3>
Â  Â  Â  Â  <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Use this section for general commands and observations. Technical data is reserved for Audit Reports.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; font-size: 11px;">Select Site:</label>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-top:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="commentLineSelect" onchange="handleCommentLineChange()" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="commentStationSelect" disabled style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Station --</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; font-size: 11px; margin-top:20px; display:block;">Comment / Command:</label>
Â  Â  Â  Â  Â  Â  <textarea id="commentTextInput" rows="6" placeholder="Write station-specific comments here..."></textarea>

Â  Â  Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Conducting Officer:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="selCommentInspector"></select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Approving Authority:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="selCommentAuthority">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Prof. Heerok Banerjee">Prof. Heerok Banerjee</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button type="button" onclick="printStationComment()">
Â  Â  Print
</button>

Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="tab-adminPanel" class="hidden">
Â  Â  <div class="panel" style="border-top: 5px solid var(--metro-red);">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  <h3 style="color:var(--metro-red);"><i class="fas fa-shield-alt"></i> System Oversight Console</h3>
Â  Â  Â  Â  <button onclick="loadAdminPanel()" class="secondary"><i class="fas fa-sync"></i> Refresh Data</button>
Â  Â  Â  </div>

Â  Â  Â  <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 20px;">1. Personnel Status & Security</h4>
Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>User Profile</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Connection</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Task Load</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Biometrics</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Admin Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="userListBody"></tbody>
Â  Â  Â  </table>
Â  Â  Â  </div>

Â  Â  Â  <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-red); margin-top: 30px;">2. Master Security PIN (Global Bypass Code)</h4>
Â  Â  Â  <div style="background:#fff1f2; border:1px solid #fecaca; padding:20px; border-radius:6px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  <p style="font-size:12px; color:#b91c1c; margin-top:0;"><strong>Strict Security:</strong> Changing this PIN immediately invalidates the old code for all users across all terminals.</p>
Â  Â  Â  Â  Â  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; align-items:end;">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#7f1d1d;">CURRENT SYSTEM PIN</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="displayCurrentPin" disabled style="background:#f8fafc; font-weight:bold; letter-spacing:4px; text-align:center; color:#1e293b; border: 1px solid #ddd;" value="SYNCING...">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">SET NEW 4-DIGIT PIN</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="newPinInput" type="text" maxlength="4" placeholder="0000" style="letter-spacing:8px; text-align:center; font-weight:bold; border:2px solid #cbd5e1;">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button onclick="updateMasterPin()" class="danger" style="height:42px; width:100%; font-size: 12px; font-weight: 800;">UPDATE SYSTEM PIN</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 30px;">3. Task Assignment</h4>
Â  Â  Â  <label style="font-size: 12px; font-weight: bold;">Select Personnel:</label>
Â  Â  Â  <div id="userCheckboxList" class="checkbox-list"></div>
Â  Â  Â  <div style="margin-top:15px;">
Â  Â  Â  Â  <textarea id="taskDesc" rows="2" placeholder="Enter detailed operational instructions..."></textarea>
Â  Â  Â  Â  <button onclick="assignTaskMulti()" style="width:100%; margin-top:10px;">Dispatch Orders</button>
Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="adminTaskModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
Â  Â  Â  Â  <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:white; border:none; padding:0;">Task Log: <span id="modalTaskUserName">User</span></h3>
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeTaskModal()" style="padding:4px 10px; font-size:12px;">CLOSE</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="overflow-y:auto; flex-grow:1; background:#f8fafc; padding: 20px;">
Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Description</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Control</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="adminTaskBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="4" style="text-align:center;">Retrieving...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="bannedScreen" class="banned-overlay hidden">
Â  Â  <div class="banned-card">
Â  Â  Â  Â  <i class="fas fa-ban" style="font-size: 50px; color: #991b1b; margin-bottom: 20px;"></i>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h1 style="color:#991b1b; margin:0; font-size: 32px; letter-spacing: 1px; text-transform:uppercase;">ACCESS REVOKED</h1>
Â  Â  Â  Â  <p style="color:#333; margin-top: 5px; font-weight:bold;">Your account has been suspended by the System Administrator.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <hr style="border: 0; border-top: 2px solid #e2e8f0; margin: 25px 0;">

Â  Â  Â  Â  <div style="text-align:left; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase; letter-spacing:1px;">Violation Category</label>
Â  Â  Â  Â  Â  Â  <div id="displayBanReason" style="font-weight:bold; font-size: 18px; color: #1f2937; margin-top:5px;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:left; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase; letter-spacing:1px;">Suspension Duration</label>
Â  Â  Â  Â  Â  Â  <div id="bannedTimeDisplay" class="banned-timer" style="margin-top:5px; text-align:left; font-size:16px;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:left; background:#fff1f2; padding:15px; border-radius:6px; border-left:4px solid #991b1b; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:#991b1b; text-transform:uppercase;">âš  Remedial Action Required</label>
Â  Â  Â  Â  Â  Â  <div id="displayBanAction" style="color:#7f1d1d; font-weight:bold; font-size:15px; margin-top:5px; line-height:1.4;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:left; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  Â <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase; letter-spacing:1px;">Admin Remarks</label>
Â  Â  Â  Â  Â  Â  Â <div id="displayBanRemarks" style="font-size:14px; color:#4b5563; font-style:italic; margin-top:5px; background:#f8fafc; padding:10px; border-radius:4px;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button onclick="logout()" style="background:#1e293b; color:white; padding:15px 40px; font-size: 14px; border:none; border-radius: 6px; font-weight:bold; cursor:pointer; width:100%; letter-spacing:1px;">
Â  Â  Â  Â  Â  Â  <i class="fas fa-sign-out-alt"></i> ACKNOWLEDGE & LOGOUT
Â  Â  Â  Â  </button>
Â  Â  </div>
</div>
<div id="adminBanModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:500px; max-width:95%; border-top: 6px solid var(--metro-red);">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <h3 style="color:var(--metro-red); margin:0; border:none; padding:0;">â›” Suspend User Access</h3>
Â  Â  Â  Â  Â  Â  <button onclick="closeBanModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p style="background:#fee2e2; padding:15px; border-radius:6px; color:#991b1b; margin-bottom:20px; font-weight: bold; border: 1px solid #fecaca;">
Â  Â  Â  Â  Â  Â  Target: <span id="banTargetName">User</span>
Â  Â  Â  Â  </p>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; font-size: 12px; margin-bottom: 5px;">1. Violation Category</label>
Â  Â  Â  Â  <select id="banReasonInput" class="ban-input" onchange="toggleBanOtherInput()">
Â  Â  Â  Â  Â  Â  <option value="Misconduct">Code of Conduct Violation</option>
Â  Â  Â  Â  Â  Â  <option value="Security Violation">Security Protocol Breach</option>
Â  Â  Â  Â  Â  Â  <option value="Asset Damage">Asset Mishandling / Damage</option>
Â  Â  Â  Â  Â  Â  <option value="Attendance">Attendance Irregularity</option>
Â  Â  Â  Â  Â  Â  <option value="Pending Investigation">Pending Internal Investigation</option>
Â  Â  Â  Â  Â  Â  <option value="Other">Other (Specify)</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div id="divBanOther" class="hidden">
Â  Â  Â  Â  Â  Â  <input id="banReasonOther" class="ban-input" placeholder="Specify Details..." style="border-left: 4px solid var(--metro-red);">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">2. Remedial Action Required</label>
Â  Â  Â  Â  <input id="banActionInput" class="ban-input" placeholder="e.g. Report to HR, Submit Incident Report...">

Â  Â  Â  Â  <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">3. Suspension Duration</label>
Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <button class="ban-btn-select" onclick="selectBanDuration(1, this)">24 Hours</button>
Â  Â  Â  Â  Â  Â  <button class="ban-btn-select" onclick="selectBanDuration(3, this)">3 Days</button>
Â  Â  Â  Â  Â  Â  <button class="ban-btn-select" onclick="selectBanDuration(7, this)">1 Week</button>
Â  Â  Â  Â  Â  Â  <input type="date" id="banCustomDate" class="ban-input" style="margin:0; height:100%; text-align:center;" onchange="selectBanCustomDate(this)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <label style="font-weight:bold; display:block; margin-top: 15px; font-size: 12px; margin-bottom: 5px;">4. Administrative Remarks</label>
Â  Â  Â  Â  <textarea id="banRemarks" rows="2" class="ban-input" placeholder="Internal notes..."></textarea>

Â  Â  Â  Â  <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
Â  Â  Â  Â  Â  Â  <button onclick="closeBanModal()" class="secondary">Cancel</button>
Â  Â  Â  Â  Â  Â  <button onclick="submitBan()" class="danger" style="font-weight:bold; padding: 10px 20px;">CONFIRM SUSPENSION</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="tab-dataView" class="hidden">
Â Â 
Â  <div class="panel">
Â  Â  <h3><i class="fas fa-database"></i> Master Log Database</h3>
Â  Â Â 
Â  Â  <div style="background: #e2e8f0; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
Â  Â  Â  Â  <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Filter by Location:</label>
Â  Â  Â  Â  <div style="display: flex; gap: 10px; margin-top: 5px;">
Â  Â  Â  Â  Â  Â  <select id="logLineSelect" onchange="handleLogLineChange()" style="flex: 1; border:1px solid #cbd5e1;">
Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Orange Line">Orange Line</option>
Â  Â  Â  Â  Â  Â  Â  <option value="Pink Line">Pink Line</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <select id="logStationSelect" onchange="loadSpecificStationData()" disabled style="flex: 1; background:#f1f5f9;">
Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line First --</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="logResultsPanel">
Â  Â Â 
Â  Â  <div class="panel" style="border-left: 4px solid var(--metro-blue);">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  <h4 id="logTableTitle" style="margin:0; color:var(--metro-blue);">ğŸ“Š Recent Station Records</h4>
Â  Â  Â  Â  Â  <button onclick="loadSpecificStationData()" class="secondary" style="font-size:11px; padding: 6px 12px;"><i class="fas fa-sync"></i> Refresh Table</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="table-wrapper" style="margin-top:15px;">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  <th>Inspector</th>
Â  Â  Â  Â  Â  Â  Â  <th>Length</th>
Â  Â  Â  Â  Â  Â  Â  <th>Dist</th>
Â  Â  Â  Â  Â  Â  Â  <th>Thick</th>
Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  <th>Remarks</th>
Â  Â  Â  Â  Â  Â  Â  <th>Control</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="viewTable1Body">
Â  Â  Â  Â  Â  Â  <tr><td colspan="8" style="text-align:center;">â³ Syncing Database...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  </div>
</div>
<div id="tab-funds" class="hidden">
Â  Â  <div class="finance-dashboard">
Â  Â  Â  Â  <div class="fin-card income">
Â  Â  Â  Â  Â  Â  <h4>Total Grant</h4>
Â  Â  Â  Â  Â  Â  <div class="amount" id="dispTotalCredit">â‚¹ 0</div>
Â  Â  Â  Â  Â  Â  <i class="fas fa-hand-holding-usd"></i>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="fin-card expense">
Â  Â  Â  Â  Â  Â  <h4>Total Spent</h4>
Â  Â  Â  Â  Â  Â  <div class="amount" id="dispTotalDebit">â‚¹ 0</div>
Â  Â  Â  Â  Â  Â  <i class="fas fa-shopping-bag"></i>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="fin-card balance">
Â  Â  Â  Â  Â  Â  <h4>Balance Available</h4>
Â  Â  Â  Â  Â  Â  <div class="amount" id="dispBalance">â‚¹ 0</div>
Â  Â  Â  Â  Â  Â  <small id="budgetHealthText" style="color:green; font-weight:bold;">Healthy</small>
Â  Â  Â  Â  Â  Â  <i class="fas fa-wallet"></i>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="adminFundPanel" class="panel hidden" style="border-top: 4px solid var(--success-green);">
Â  Â  Â  Â  <h3 style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> Add Project Fund (Credit)</h3>
Â  Â  Â  Â  <input type="hidden" id="editFundKey">Â 

Â  Â  Â  Â  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; align-items:end;">
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Amount (â‚¹)</label><input type="number" id="fundAmount" placeholder="0"></div>
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Sender / Source</label><input id="fundSource" placeholder="e.g. Metro Railway"></div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Mode</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="fundMode" onchange="toggleFundMode()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="NEFT/RTGS">NEFT / RTGS</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Cheque">Cheque</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Cash">Cash</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="UPI">UPI</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="fundModeOther" class="hidden" placeholder="Specify Mode..." style="margin-top:5px; border-left:3px solid var(--metro-blue);">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Status</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="fundStatus">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Approved">Approved</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pending">Pending</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="submitFund()" class="success" id="btnFundSubmit" style="height:42px; width:100%;">CREDIT FUND</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="cancelFundEdit()" id="btnFundCancel" class="secondary hidden" style="height:42px;">CANCEL</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
<div id="expenseFormPanel" class="panel" style="border-top: 4px solid var(--metro-red);">
Â  Â  Â  Â  <h3 style="color:var(--metro-red);"><i class="fas fa-receipt"></i> Record Other Expense</h3>
Â  Â  Â  Â  <input type="hidden" id="editExpenseKey">
Â  Â  Â  Â  <p style="font-size:11px; color:#666; margin-bottom:10px;">For travel, food, logistics, etc. (Not for equipment procurement)</p>

Â  Â  Â  Â  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; align-items:end;">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Expense Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="expDate" style="border-color:#cbd5e1;">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Description</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="expDesc" placeholder="e.g. Travel to Site">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Amount (â‚¹)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="expAmount" placeholder="0.00">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Bill / Drive Link</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="expBillUrl" placeholder="https://drive.google.com/..." style="border-color:var(--metro-blue);">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="submitExpense()" class="danger" id="btnExpSubmit" style="height:42px; width:100%;">SUBMIT EXPENSE</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="cancelExpEdit()" id="btnExpCancel" class="secondary hidden" style="height:42px;">CANCEL</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3><i class="fas fa-file-invoice-dollar"></i> Balance Sheet & Ledger</h3>
Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Date</th><th>Type</th><th>Description</th><th>Bill</th><th>Credit (+)</th><th>Debit (-)</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="fundTableBody"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="tab-purchase" class="hidden">
Â  Â  <div id="purchaseFormPanel" class="panel" style="border-top: 4px solid var(--metro-blue);">
Â  Â  Â  Â  <h3><i class="fas fa-cart-plus"></i> New Purchase Entry</h3>
Â  Â  Â  Â  <input type="hidden" id="editPurchaseKey">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="purchase-grid">
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Product Name</label><input id="purItem" placeholder="Item Name"></div>
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Platform</label><input id="purPlatform" placeholder="Amazon/Vendor"></div>
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Order ID</label><input id="purOrderId" placeholder="Order #"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="purchase-grid">
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Price (â‚¹)</label><input type="number" id="purPrice" oninput="calcPurTotal()"></div>
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold;">Qty</label><input type="number" id="purQty" oninput="calcPurTotal()"></div>
Â  Â  Â  Â  Â  Â  <div><label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">TOTAL (â‚¹)</label><input id="purTotal" disabled style="background:#f1f5f9; font-weight:bold;"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:var(--metro-red);">Bill / Invoice Link (Google Drive)</label>
Â  Â  Â  Â  Â  Â  <input id="purBillUrl" placeholder="Paste link here (Required)..." style="border-left:4px solid var(--metro-red);">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  Â  Â <button onclick="clearPurForm()" class="secondary">Cancel</button>
Â  Â  Â  Â  Â  Â  Â <button onclick="submitPurchase()" class="info" id="btnPurSubmit">SAVE & DEDUCT FUND</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3><i class="fas fa-history"></i> Purchase History</h3>
Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>Sl</th><th>Product Details</th><th>Vendor & Order ID</th><th>Qty</th><th>Unit Price</th><th>Total</th><th>Bill</th><th>Status</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="purchaseTableBody"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="rakeDataModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:700px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; background:var(--metro-blue); color:white; padding:15px 20px;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:white; border:none; padding:0;">Rake Clearance Table</h3>
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeRakeModal()" style="font-size:12px; padding: 5px 10px;">CLOSE</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="table-wrapper" style="overflow-y:auto; flex-grow:1; padding: 20px; background: #f8fafc;">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>RAKE NO</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>TYPE</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>FRONT</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>REAR</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ACT</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="modalRakeBody"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="tab-billing" class="hidden">
Â  Â  <div class="panel" style="border-top: 6px solid var(--metro-blue);">
Â  Â  Â  Â  <h3 style="border-bottom: 2px solid var(--metro-gold); padding-bottom: 10px;">
Â  Â  Â  Â  Â  Â  <i class="fas fa-cash-register"></i> OFFICIAL BILLING & INVOICE GENERATOR
Â  Â  Â  Â  </h3>
Â  Â  Â  Â  <div style="background:#f1f5f9; padding:20px; border-radius:6px; margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; border-left: 5px solid var(--metro-blue);">
Â  Â  <div>
Â  Â  Â  Â  <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Customer Name</label>
Â  Â  Â  Â  <input id="billCustName" placeholder="Full Official Name" style="margin-top:5px;">
Â  Â  </div>
Â  Â  <div>
Â  Â  Â  Â  <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Billing Address</label>
Â  Â  Â  Â  <input id="billCustAddr" placeholder="Address / Contact" style="margin-top:5px;">
Â  Â  </div>
Â  Â  <div>
Â  Â  Â  Â  <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Client Type</label>
Â  Â  Â  Â  <select id="billClientType" onchange="toggleBillStationSource()" style="margin-top:5px; height:45px; border:1px solid #cbd5e1; width:100%;">
Â  Â  Â  Â  Â  Â  <option value="METRO">Kolkata Metro Railway</option>
Â  Â  Â  Â  Â  Â  <option value="OTHER">Other Organization / Private</option>
Â  Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div id="divBillMetroGroup" style="display: contents;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Select Corridor</label>
Â  Â  Â  Â  Â  Â  <select id="billLineSelect" onchange="handleBillLineChange()" style="margin-top:5px; height:45px; border:1px solid #cbd5e1; width:100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Orange Line">Orange Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pink Line">Pink Line</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Target Metro Station</label>
Â  Â  Â  Â  Â  Â  <select id="billMetroStation" disabled style="margin-top:5px; height:45px; border:1px solid #cbd5e1; width:100%; background:#f1f5f9;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Station --</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="divBillStationManual" class="hidden">
Â  Â  Â  Â  <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Target Site (Manual)</label>
Â  Â  Â  Â  <input id="billManualStation" placeholder="Enter Site Name" style="margin-top:5px; height:45px;">
Â  Â  </div>
</div>Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background: var(--metro-blue); padding: 25px; border-radius: 8px 8px 0 0; color: white; margin-bottom: 2px; border-bottom: 4px solid var(--metro-gold);">
Â  Â  Â  Â  Â  Â  <h4 style="margin: 0 0 20px 0; color: var(--metro-gold); font-size: 13px; letter-spacing: 1.5px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-microchip" style="font-size: 18px;"></i> A. PRIMARY ASSET REGISTRATION
Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; align-items: end;">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size: 10px; font-weight: 800; color: #cbd5e1; text-transform: uppercase;">1. Asset Identification (Tag / QR)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 5px; margin-top: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="billBarcodeInp" placeholder="Scan Asset QR Code..." style="margin: 0; background: white; color: black; font-weight: bold; height: 45px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('BILLING_SCAN')" class="secondary" style="background: var(--metro-gold); width: 55px; border: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode" style="font-size: 20px;"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size: 10px; font-weight: 800; color: #cbd5e1; text-transform: uppercase;">2. Quantity</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="billQty" value="1" style="margin-top: 5px; background: white; text-align: center; font-weight: bold; height: 45px;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="addScannedItemToBill()" class="success" style="height: 45px; padding: 0 30px; font-weight: 900; background: #15803d; border: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  + INSERT ASSET
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="background: #1e293b; padding: 25px; border-radius: 0 0 8px 8px; color: white; margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);">
Â  Â  Â  Â  Â  Â  <h4 style="margin: 0 0 20px 0; color: #94a3b8; font-size: 14px; letter-spacing: 1.5px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-tools" style="font-size: 18px;"></i> B. ADDITIONAL SERVICES / EXTRA WORK
Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; align-items: end;">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 5px;">3. Service Description</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="billAddlDesc" placeholder="e.g. Calibration, Installation" style="margin: 0; background: white; color: black; border: 2px solid #cbd5e1; height: 50px; padding: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 5px;">4. Service Charge (â‚¹)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="billAddl" value="0" style="margin: 0; background: white; color: black; font-weight: bold; height: 50px;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="addServiceOnlyToBill()" class="info" style="height: 50px; padding: 0 30px; font-weight: 900; background: #0284c7; border: none; letter-spacing: 1px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  + APPLY CHARGE
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h4 style="color:var(--metro-blue); text-transform:uppercase; font-size:13px; margin-bottom:10px; border-left:4px solid var(--metro-gold); padding-left:10px;">Cart Summary (Invoice Preview)</h4>
Â  Â  Â  Â  <div class="table-wrapper" style="border: 2px solid #000;">
Â  Â  Â  Â  Â  Â  <table style="width:100%; border-collapse: collapse;">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background:#000; color:#fff;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:white; padding:12px;">ITEM DESCRIPTION</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:white; text-align:center;">QTY</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:white; text-align:right;">UNIT RATE (â‚¹)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:white; text-align:right;">TOTAL (â‚¹)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:white; text-align:center; width:80px;">ACTION</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="billCartBody"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="display:flex; justify-content:flex-end; margin-top:20px;">
Â  Â  Â  Â  Â  Â  <div style="width:350px; background:#000; color:#fff; padding:20px; text-align:right; border:4px solid var(--metro-gold);">
Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:var(--metro-gold); font-weight:800;">GRAND TOTAL PAYABLE</small>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:32px; font-weight:900;">â‚¹ <span id="billGrandTotalDisp">0.00</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="billWordsDisp" style="font-size:10px; font-style:italic; color:#ccc; margin-top:5px;">Zero Rupees Only</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button type="button" class="info" onclick="generateInvoicePrint()" style="margin-top:25px; width:100%; padding:20px; font-weight:900; font-size:16px; background:var(--metro-blue); border:none; letter-spacing:1px;">
Â  Â  Â  Â  Â  Â  <i class="fas fa-file-invoice-dollar"></i> FINALIZE & PRINT OFFICIAL INVOICE
Â  Â  Â  Â  </button>
Â  Â  </div>
</div>
<div id="tab-directives" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3><i class="fas fa-print"></i> Permission & Instruction Generator</h3>
Â  Â  Â  Â  <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Generate official documents for personnel permissions or instructions.</p>
Â  Â  Â  Â  <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; font-size: 11px;">1. DOCUMENT TYPE:</label>
Â  Â  Â  Â  Â  Â  <select id="dirType" style="margin-top:5px; border:2px solid var(--metro-blue); font-weight:bold;">
Â  Â  <option value="OFFICIAL PERMISSION">OFFICIAL PERMISSION LETTER</option>
Â  Â  <option value="OPERATIONAL INSTRUCTION">OPERATIONAL INSTRUCTION</option>
Â  Â  <option value="OFFICIAL CORRESPONDENCE">OFFICIAL CORRESPONDENCE / DISPATCH</option>
</select>
Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; font-size: 11px; margin-top:15px; display:block;">2. ASSIGN TO PERSONNEL (Select Multiple):</label>
Â  Â  Â  Â  Â  Â  <div id="dirUserCheckboxList" class="checkbox-list" style="margin-top:5px; background:white; max-height:150px;"></div>
Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; font-size: 11px; margin-top:20px; display:block;">3. DIRECTIVE CONTENT / TERMS:</label>
Â  Â  Â  Â  Â  Â  <textarea id="dirText" rows="6" placeholder="Specify the details here..."></textarea>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; margin-top:15px; display:block;">APPROVING AUTHORITY:</label>
Â  Â  Â  Â  Â  Â  <select id="selDirAuthority">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <button type="button" class="info" onclick="generateDirectivePrint()" style="margin-top:20px; width:100%; padding:15px; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-pdf"></i> GENERATE OFFICIAL DOCUMENT
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
<div id="tab-printReport" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  Â  <h3><i class="fas fa-print"></i> Report Generation Center</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Select Inspection Site:</label>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="printLineSelect" onchange="handlePrintLineChange()" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Blue Line">Blue Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Green Line">Green Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Purple Line">Purple Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Yellow Line">Yellow Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Orange Line">Orange Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pink Line">Pink Line</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="printStationSelect" onchange="fetchLogsForPrint()" disabled style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Line First --</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="printLogList" class="hidden" style="margin-top:25px;">
Â  Â  Â  Â  Â  Â  <h4>Available Inspection Records:</h4>
Â  Â  Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Station</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Inspector</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="printLogBody"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="printOptionsModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:450px; max-width:95%;">
Â  Â  Â  Â  <h3 style="color:var(--metro-blue); border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-top:0;">Configure Audit Report</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p style="margin-bottom:20px; background: #f1f5f9; padding: 10px; border-radius: 4px;"><strong>Record Date:</strong> <span id="modalPrintDate" style="color:var(--metro-blue); font-weight:bold;">--</span></p>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">1. Data Sections to Include:</label>
Â  Â  Â  Â  <div style="display:flex; gap:15px; margin-bottom:20px;">
Â  Â  Â  Â  Â  Â  <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="chkStationDetails" checked>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Measurement Data
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="chkRakeData" checked>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Clearance Data
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">2. Authorization Signatories:</label>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  <small style="color: #64748b;">Conducting Officer:</small>
Â  Â  Â  Â  Â  Â  <select id="selPrintInspector" style="margin-top: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Loading...</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-bottom:25px;">
Â  Â  Â  Â  Â  Â  <small style="color: #64748b;">Approving Authority:</small>
Â  Â  Â  Â  Â  Â  <select id="selPrintAuthority" style="margin-top: 5px; border-color: var(--metro-gold); background: #fffbeb;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Authority --</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="display:flex; gap:10px; border-top:1px solid #e2e8f0; padding-top:20px;">
Â  Â  Â  Â  Â  Â  <button class="secondary" onclick="closePrintModal()" style="flex:1;">Cancel</button>
Â  Â  Â  Â  Â  Â  <button class="info" onclick="generateFinalReport()" style="flex:2;">GENERATE REPORT</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
Â  <div id="printableReportContainer" class="hidden">
Â  Â  <div class="no-print" style="text-align:center; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding:15px; background:#f8fafc;">
Â  Â  Â  Â  <h3 style="margin:0 0 15px 0; color: var(--metro-blue);">Official Record Preview</h3>
Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()" style="margin-right:20px;">CLOSE PREVIEW</button>
Â  Â  Â  Â  <button onclick="printReport('POS')" style="background:#1e293b; color:white; padding: 10px 20px;"><i class="fas fa-receipt"></i> PRINT OFFICIAL RECORD</button>
Â  Â  </div>

Â  Â  <div class="report-paper" style="width: 58mm; max-width: 58mm; box-sizing: border-box; padding: 1mm; margin: 0 auto; overflow: hidden;">
Â  Â  Â  Â  <div class="report-header" style="text-align: center; border-bottom: 6pt solid #000; padding-bottom: 5px;">
Â  Â  Â  Â  Â  Â  <div style="font-size: 26pt; font-weight: 900; text-transform: uppercase;">METRO RAILWAY<br>PLATFORM SAFETY<br>PROJECT</div>
Â  Â  Â  Â  Â  Â  <div style="font-size: 11pt; font-weight: 900; margin-top: 5px; line-height: 1.1;">
Â  Â  Â  Â  Â  Â  Â  Â  INSTITUTE OF ENGINEERING AND MANAGEMENT<br>
Â  Â  Â  Â  Â  Â  Â  Â  UNIVERSITY OF ENGINEERING AND MANAGEMENT
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 10px; font-size: 18pt; font-weight: 900; text-decoration: underline; text-transform: uppercase;">
Â  Â  Â  Â  Â  Â  Â  Â  OFFICIAL INSPECTION RECORD
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="border-bottom: 4pt solid #000; padding: 8px 0; text-align: left; width: 100%;">
Â  Â  Â  Â  Â  Â  <div style="font-size: 16pt; text-decoration: underline;">Site:</div>
Â  Â  Â  Â  Â  Â  <div id="rptStationName" style="font-size: 22pt; font-weight: 900; word-wrap: break-word;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="border-bottom: 4pt solid #000; padding: 8px 0; text-align: left; width: 100%;">
Â  Â  Â  Â  Â  Â  <div style="font-size: 16pt; text-decoration: underline;">Date:</div>
Â  Â  Â  Â  Â  Â  <div id="rptDate" style="font-size: 20pt; font-weight: 900;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="border-bottom: 4pt solid #000; padding: 8px 0; text-align: left; width: 100%;">
Â  Â  Â  Â  Â  Â  <div style="font-size: 16pt; text-decoration: underline;">Corridor:</div>
Â  Â  Â  Â  Â  Â  <div id="rptLineName" style="font-size: 20pt; font-weight: 900;">--</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sectionStationDetails" style="width: 100%;">
Â  Â  Â  Â  Â  Â  <div style="background: #000 !important; color: #fff !important; padding: 6px; font-weight: 900; font-size: 18pt; margin-top: 15px; text-transform: uppercase; text-align: center; -webkit-print-color-adjust: exact;">
Â  Â  Â  Â  Â  Â  Â  Â  A. YELLOW LINE COMPLIANCE
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 16pt;">Platform Length:</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="rptLen" style="font-size: 20pt; font-weight: 900;">--</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 16pt;">YL Distance:</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="rptYl" style="font-size: 20pt; font-weight: 900;">--</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 16pt;">YL Thickness:</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="rptTh" style="font-size: 20pt; font-weight: 900;">--</span>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 16pt;">Compliance Status:</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="rptStatus" style="font-size: 20pt; font-weight: 900;">--</span>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="border-bottom: 4pt solid #000; padding: 6px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 16pt;">Inspector:</span><br>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="rptUser" style="font-size: 20pt; font-weight: 900;">--</span>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="text-align: left; margin-top: 15px; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 16pt; text-decoration: underline; font-weight: 900;">Remarks:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rptRem" style="padding: 5px 0; font-size: 16pt; font-weight: 900; line-height: 1.2; word-wrap: break-word;">--</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="sectionRakeData" style="display:none;"><table style="width: 100%;"><tbody id="rptRakeBody"></tbody></table></div>

Â  Â  Â  Â  <div class="report-footer" style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-start; width: 100%; gap: 10px;">
Â  Â  Â  Â  Â  Â  <div style="width: 48%; text-align: center; display: flex; flex-direction: column;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="border-top: 3pt solid #000 !important; width: 100%; margin-bottom: 5px; -webkit-print-color-adjust: exact;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rptSigInspectorName" style="font-weight: 900; font-size: 11pt; word-wrap: break-word;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 8pt; font-weight: 900; text-transform: uppercase;">CONDUCTING OFFICER</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="width: 48%; text-align: center; display: flex; flex-direction: column;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="border-top: 3pt solid #000 !important; width: 100%; margin-bottom: 5px; -webkit-print-color-adjust: exact;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rptSigAuthName" style="font-weight: 900; font-size: 11pt; word-wrap: break-word;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 8pt; font-weight: 900; text-transform: uppercase;">APPROVING AUTHORITY</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top: 30px; font-size: 9pt; text-align: center;">[SYSTEM GENERATED RECORD]</div>
Â  Â  </div>
</div>
Â  <div id="tab-warranty" class="hidden">
Â  Â  <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; padding: 10px; background: #e2e8f0; border-radius: 6px;">
Â  Â  <button onclick="toggleWarMode('dash')" class="info"><i class="fas fa-chart-line"></i> Dashboard</button>
Â  Â  <button onclick="toggleWarMode('setup')" class="secondary"><i class="fas fa-tools"></i> Warranty Setup</button>
Â  Â  <button onclick="toggleWarMode('sales')" class="info" style="background:#6366f1; border:none;"><i class="fas fa-receipt"></i> Sales History</button>
Â  Â  <button onclick="toggleWarMode('claim')" class="warning"><i class="fas fa-qrcode"></i> Scan & Claim</button>
Â  Â  <button onclick="toggleWarMode('claims-list')" class="secondary" style="background:#4b5563;"><i class="fas fa-ticket-alt"></i> Claims Log</button>
Â  Â  <button onclick="toggleWarMode('recovery')" class="danger" style="background:#be123c;"><i class="fas fa-undo-alt"></i> Asset Recovery</button>
Â  Â  <button onclick="toggleWarMode('active')" class="success"><i class="fas fa-clipboard-list"></i> Active Coverage</button>
Â  Â  <button onclick="toggleWarMode('tech-terminal')" class="info" style="background:#232f3e;"><i class="fas fa-microchip"></i> Tech Terminal</button>
</div>

Â  Â  <div id="war-dash" class="panel">
Â  Â  Â  Â  <h3 style="color:var(--metro-blue); border-bottom: 2px solid var(--metro-gold);"><i class="fas fa-tachometer-alt"></i> Warranty Overview</h3>
Â  Â  Â  Â  <div class="finance-dashboard">
Â  Â  Â  Â  Â  Â  <div class="fin-card balance" style="border-left-color: #0284c7;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Total Assets</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="amount" id="warTotalAssets">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-boxes-stacked"></i>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="fin-card income">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Protected Assets</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="amount" id="warProtected">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-shield-check"></i>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="fin-card expense">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Claims Pending</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="amount" id="warPending">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-invoice"></i>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="war-setup" class="panel hidden">
Â  Â  <h3><i class="fas fa-plus-circle"></i> Configure Asset Warranty</h3>
Â  Â  <div style="background:#f1f5f9; padding:20px; border-radius:8px; margin-bottom:20px; border-left: 5px solid var(--metro-blue);">
Â  Â  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; align-items:end;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">1. ASSET TAG ID</label>
Â  Â  Â  Â  Â  Â  <input id="warSetupTag" placeholder="Scan or Type Tag...">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">PRODUCT CATEGORY</label>
Â  Â  Â  Â  Â  Â  <select id="warProductType" onchange="toggleWarrantyFields()">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="WARRANTY">WARRANTY PRODUCT</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="NON-WARRANTY">NON-WARRANTY PRODUCT</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="divWarTenure">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">2. TENURE VALUE</label>
Â  Â  Â  Â  Â  Â  <input type="number" id="warDuration" placeholder="e.g. 12">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="divWarUnit">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">3. UNIT</label>
Â  Â  Â  Â  Â  Â  <select id="warUnit">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Months">Months</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Years">Years</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="divWarDate">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold; color:var(--metro-red);">4. START DATE</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="warStartDate" style="border: 2px solid var(--metro-red); font-weight: bold; height:45px; padding:10px;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="success" onclick="saveWarrantyConfig()" style="height:45px; font-weight: 900;">UPDATE SYSTEM</button>
Â  Â  </div>
</div>
Â  Â Â 
Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Tag ID</th><th>Item Name</th><th>Commencement</th><th>Standard Tenure</th><th>Action</th></tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="warSetupTableBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>

Â  Â  <div id="war-claim" class="panel hidden" style="border-top: 5px solid var(--metro-red);">
Â  Â  <h3 style="color:var(--metro-red);"><i class="fas fa-magnifying-glass"></i> Verification & Claim Engine</h3>
Â  Â Â 
Â  Â  <div style="text-align:center; padding:20px; background:#fff1f2; border: 2px dashed #f87171; border-radius:12px;">
Â  Â  Â  Â  <div style="margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  <label style="display:block; font-weight:bold; margin-bottom:5px;">Manual Tag Entry:</label>
Â  Â  Â  Â  Â  Â  <input id="manualClaimTag" placeholder="Enter Tag ID..." style="max-width:300px; display:inline-block; margin-right:10px;">
Â  Â  Â  Â  Â  Â  <button class="info" onclick="handleManualClaimSearch()">Verify Tag</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <p style="margin:10px 0; font-weight:bold;">- OR -</p>
Â  Â  Â  Â  <button onclick="openBarcodeScanner('WARRANTY_CLAIM')" class="danger" style="padding:15px 40px; font-size:16px;">
Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i> INITIATE SCAN
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="claimDisplay" class="hidden" style="margin-top:25px; background:white; border:2px solid #ddd; border-radius:8px; overflow:hidden;">
Â  Â  Â  Â  <div style="background:var(--metro-blue); color:white; padding:15px; font-weight:bold;">SALE HISTORY RETRIEVED</div>
Â  Â  Â  Â  <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
Â  Â  Â  Â  Â  Â  <div style="border-right: 1px solid #eee;">
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:10px; color:#64748b; text-transform:uppercase;">Asset Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="claimItemName" style="font-size:18px; font-weight:bold;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:10px; color:#64748b; text-transform:uppercase; margin-top:15px; display:block;">Invoice Number</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="claimInv" style="font-family:monospace; font-weight:bold;">--</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:10px; color:#64748b; text-transform:uppercase;">Sold To (Site)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="claimSite" style="color:var(--metro-red); font-weight:bold;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:10px; color:#64748b; text-transform:uppercase; margin-top:15px; display:block;">Sale Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="claimDate" style="font-weight:bold;">--</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="claimStatusBox" style="padding:15px; text-align:center; font-weight:bold; font-size:20px; background: #f8fafc;">Checking...</div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="padding:20px; border-top:1px solid #eee;">
Â  Â  Â  Â  Â  Â  <label style="font-size:11px; font-weight:bold;">Describe the Fault / Issue:</label>
Â  Â  Â  Â  Â  Â  <textarea id="claimIssue" rows="3" placeholder="e.g. IR Sensor not triggering, Power supply failure..."></textarea>
Â  Â  Â  Â  Â  Â  <button id="btnFinalClaim" class="danger" style="width:100%; padding:15px; margin-top:10px; font-weight: 900;" onclick="submitWarrantyClaim()">
Â  Â  Â  Â  Â  Â  Â  Â  LODGE OFFICIAL CLAIM & GENERATE TICKET
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

Â  Â  <div id="war-active" class="panel hidden">
Â  Â  Â  Â  <h3><i class="fas fa-shield-check"></i> Active Protection List</h3>
Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Tag</th><th>Item</th><th>Site</th><th>Expiry Date</th><th>Status</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="warActiveTableBody"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="war-sales" class="panel hidden">
Â  Â  <h3><i class="fas fa-history"></i> Logged Sales & Dispatches</h3>
Â  Â  <p style="font-size:11px; color:#666;">Click on an Invoice Number to generate a Customer Warranty Support Copy.</p>
Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Invoice #</th><th>Sold To (Station)</th><th>Sale Date</th><th>Items</th><th>Action</th></tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="warSalesTableBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>

<div id="war-active" class="panel hidden">
Â  Â  <h3><i class="fas fa-shield-check"></i> Master Protection List</h3>
Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tag</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Item</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Starts From</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Expiry Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Days Left</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="warActiveTableBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>
Â  Â  <div id="war-recovery" class="panel hidden" style="border-top: 5px solid #be123c;">
Â  Â  <h3 style="color:#be123c;"><i class="fas fa-shopping-cart"></i> Asset Recovery Cart</h3>
Â  Â Â 
Â  Â  <div style="background:#fff1f2; padding:20px; border-radius:8px; margin-bottom:20px; border-left: 5px solid #be123c;">
Â  Â  Â  Â  <label style="font-weight:bold; font-size:12px;">1. RETURN REASON (APPLIES TO ALL ITEMS IN CART)</label>
Â  Â  Â  Â  <input id="recoveryReason" placeholder="Enter reason for return..." style="border:2px solid #be123c; margin-bottom:15px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-weight:bold; font-size:11px;">2. ADD TO CART (SCAN OR TYPE)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="manualRecoveryTag" placeholder="Enter ID..." style="margin:0; height:45px;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('ASSET_RECOVERY')" class="warning" style="height:45px; margin-top:15px; padding: 0 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-qrcode"></i> SCAN
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button onclick="addToRecoveryCart(document.getElementById('manualRecoveryTag').value)" class="info" style="width:100%; margin-top:10px; background:var(--metro-blue);">
Â  Â  Â  Â  Â  Â  <i class="fas fa-plus"></i> ADD ITEM TO LIST
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div class="table-wrapper" style="margin-bottom:20px; border: 1px solid #be123c;">
Â  Â  Â  Â  <table style="width:100%">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background:#be123c; color:white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Asset Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tag ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Original Site</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center;">Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="recoveryCartBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <button id="btnExecuteRecovery" onclick="finalizeRecoveryCart()" class="danger" style="width:100%; padding:18px; font-weight:900; font-size:16px; letter-spacing:1px; display:none;">
Â  Â  Â  Â  <i class="fas fa-file-invoice"></i> FINALIZE & PRINT CONSOLIDATED MEMO
Â  Â  </button>
</div>
Â  Â  <div id="war-claims-list" class="panel hidden">
Â  Â  <h3><i class="fas fa-ticket-alt"></i> Active Warranty Claims (Tickets)</h3>
Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background: var(--metro-blue); color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Ticket ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Asset Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Site</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Issue Description</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Filed By</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="warClaimsTableBody">
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="6" style="text-align:center;">Loading active tickets...</td></tr>
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
</div>
Â  Â  <div id="war-tech-terminal" class="panel hidden" style="border-top: 5px solid #ff9900; background: #fff;">
Â  Â  <h3 style="color:#232f3e; border-bottom: 2px solid #febd69; padding-bottom: 10px;">
Â  Â  Â  Â  <i class="fas fa-screwdriver-wrench"></i> Technician Diagnostic Terminal
Â  Â  </h3>
Â  Â Â 
Â  Â  <div id="techScanPrompt" style="text-align:center; padding:25px; background:#f9f9f9; border-radius:12px; border: 2px dashed #ccc; margin-bottom: 20px;">
Â  Â  Â  Â  <p id="techStepTitle" style="font-weight: 900; color: #232f3e; font-size: 14px; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 1px;">
Â  Â  Â  Â  Â  Â  Security Protocol: Physical Product Verification
Â  Â  Â  Â  </p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 650px; margin: 0 auto;">
Â  Â  Â  Â  Â  Â  <div id="stageTicket" style="padding:20px; background:white; border-radius:10px; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-ticket-alt" style="font-size: 24px; color: #ff9900; margin-bottom: 10px;"></i>
Â  Â  Â  Â  Â  Â  Â  Â  <small style="font-weight:800; color:#666; display:block; margin-bottom: 10px;">1. JOB TICKET</small>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openBarcodeScanner('TECH_TICKET_SCAN')" style="width:100%; background:#ff9900; color:#000; border: none; font-weight: bold;">SCAN QR</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:12px; border-top: 1px solid #eee; padding-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="manualTicketInp" placeholder="Enter Ticket ID" style="font-size:11px; text-align:center; height:35px; margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="info" onclick="handleManualTechVerify('TICKET')" style="width:100%; padding:5px; font-size:10px;">VERIFY ID</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="ticketVerifiedLabel" style="margin-top:10px; font-size:12px; color:#15803d; font-weight:bold;" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-check-circle"></i> TICKET LOADED
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="stageProduct" style="padding:20px; background:white; border-radius:10px; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-box-open" style="font-size: 24px; color: #232f3e; margin-bottom: 10px;"></i>
Â  Â  Â  Â  Â  Â  Â  Â  <small style="font-weight:800; color:#666; display:block; margin-bottom: 10px;">2. PHYSICAL ASSET</small>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnScanProduct" onclick="openBarcodeScanner('TECH_PRODUCT_VERIFY')" style="width:100%; background:#232f3e; color:#fff; border: none; font-weight: bold;" disabled>SCAN TAG</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:12px; border-top: 1px solid #eee; padding-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="manualProductInp" placeholder="Enter Asset Tag" style="font-size:11px; text-align:center; height:35px; margin-bottom:5px;" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnManualProduct" class="info" onclick="handleManualTechVerify('PRODUCT')" style="width:100%; padding:5px; font-size:10px;" disabled>VERIFY TAG</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="productVerifiedLabel" style="margin-top:10px; font-size:12px; color:#15803d; font-weight:bold;" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-check-circle"></i> ASSET CONFIRMED
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="techMismatchArea" class="hidden" style="margin-top: 30px; background: #fee2e2; border: 2px solid #b91c1c; padding: 20px; border-radius: 12px; max-width: 500px; margin-left: auto; margin-right: auto;">
Â  Â  Â  Â  Â  Â  <div style="color: #b91c1c; font-weight: 900; font-size: 16px; margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-exclamation-triangle"></i> ASSET MISMATCH DETECTED
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p style="font-size: 13px; color: #7f1d1d; margin-bottom: 15px;">The scanned product tag does not match the ticket record.</p>
Â  Â  Â  Â  Â  Â  <button onclick="resetTechVerification()" class="danger" style="width: 100%; font-weight: bold;">CANCEL & RESET PROTOCOL</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="techDiagnosisArea" class="hidden" style="border:1px solid #ddd; border-radius:8px; overflow:hidden;">
Â  Â  Â  Â  <div style="background:#232f3e; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between;">
Â  Â  Â  Â  Â  Â  <span>SESSION: <span id="techTicketIdDisplay" style="color:#febd69;">#---</span></span>
Â  Â  Â  Â  Â  Â  <span id="techOriginalInvoice" style="font-family:monospace; font-size:12px; opacity:0.8;">REF INV: ---</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="padding: 15px; background: #fffbeb; border-bottom: 1px solid #fed7aa; display: flex; gap: 20px;">
Â  Â  Â  Â  Â  Â  <div style="flex:1;"><small style="color:#666; font-weight:bold;">ASSET:</small><div id="techAssetData" style="font-weight:900;">--</div></div>
Â  Â  Â  Â  Â  Â  <div style="flex:1;"><small style="color:#666; font-weight:bold;">REPORTED FAULT:</small><div id="techIssueData" style="color:#b91c1c; font-weight:bold;">--</div></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="padding:25px;">
Â  Â  Â  Â  Â  Â  <label style="font-size:10px; font-weight:bold;">VERIFIED TECHNICIAN NAME</label>
Â  Â  Â  Â  Â  Â  <input id="techNameInput" placeholder="Full Name" style="border:2px solid #ff9900; font-weight:bold; margin-bottom:15px;">

Â  Â  Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div><label style="font-size:10px; font-weight:bold;">FAILED COMPONENT</label><input id="techFailedComponent" placeholder="e.g. IR Sensor"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div><label style="font-size:10px; font-weight:bold;">PART SERIAL #</label><input id="techComponentSerial" placeholder="Batch ID"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label style="font-weight:bold;">RESOLUTION COMMAND</label>
Â  Â  Â  Â  Â  Â  <select id="techActionSelect" style="border:2px solid #ff9900; font-weight:bold; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="REPAIR_COMPLETE">ğŸ”§ Repaired & Reinstalled</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="REPLACE_PRODUCT">ğŸ”„ Replace with New Unit</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="VOID_WARRANTY">âš ï¸ Void: Damage Detected</option>
Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  <label style="font-weight:bold;">DETAILED NOTES</label>
Â  Â  Â  Â  Â  Â  <textarea id="techCommandNotes" rows="3" placeholder="Fix details..."></textarea>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="success" onclick="submitTechResolution()" style="width:100%; padding:15px; background:#131a22; font-weight:900; color:white; margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  COMPLETE DIAGNOSIS & LOCK RECORD
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="techPurchasePrice" class="hidden"></div>
</div>
</div>
</section>
<script type="module">
// --- FIREBASE IMPORTS (Standard Stable Version) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
// --- NEW: FINANCE LOGIC ---
window.toggleFundMode = () => {
Â  Â  const mode = document.getElementById("fundMode").value;
Â  Â  const inp = document.getElementById("fundModeOther");
Â  Â  if(mode === 'Other') {
Â  Â  Â  Â  inp.classList.remove('hidden');
Â  Â  Â  Â  inp.focus();
Â  Â  } else {
Â  Â  Â  Â  inp.classList.add('hidden');
Â  Â  Â  Â  inp.value = "";Â 
Â  Â  }
};

window.submitFund = async () => {
Â  Â  if(!isAdmin) return alert("Admin Only");
Â  Â Â 
Â  Â  const amt = document.getElementById("fundAmount").value;
Â  Â  const src = document.getElementById("fundSource").value;
Â  Â  let mode = document.getElementById("fundMode").value;
Â  Â  const status = document.getElementById("fundStatus").value;
Â  Â  const editKey = document.getElementById("editFundKey").value; // Get Edit Key

Â  Â  // Handle 'Other' Input
Â  Â  if(mode === 'Other') {
Â  Â  Â  Â  const otherVal = document.getElementById("fundModeOther").value.trim();
Â  Â  Â  Â  if(!otherVal) return alert("Please specify the payment mode.");
Â  Â  Â  Â  mode = otherVal;
Â  Â  }

Â  Â  if(!amt || !src) return alert("Please fill Amount & Source");
Â  Â Â 
Â  Â  const fundData = {
Â  Â  Â  Â  type: "CREDIT",Â 
Â  Â  Â  Â  amount: parseFloat(amt),Â 
Â  Â  Â  Â  desc: src,
Â  Â  Â  Â  mode: mode,
Â  Â  Â  Â  status: status,
Â  Â  Â  Â  by: currentUser.email,
Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  if(editKey) {
Â  Â  Â  Â  Â  Â  // --- UPDATE EXISTING ---
Â  Â  Â  Â  Â  Â  await update(ref(db, `finance/${editKey}`), fundData);
Â  Â  Â  Â  Â  Â  alert("Fund Entry Updated!");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // --- CREATE NEW ---
Â  Â  Â  Â  Â  Â  await push(ref(db, "finance"), fundData);
Â  Â  Â  Â  Â  Â  alert("Fund Added Successfully!");Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  cancelFundEdit(); // Reset Form
Â  Â  Â  Â Â 
Â  Â  } catch(e) { alert(e.message); }
};
// --- SUBMIT OTHER EXPENSE (With Custom Date) ---
window.submitExpense = async () => {
Â  Â  const desc = document.getElementById("expDesc").value;
Â  Â  const amount = document.getElementById("expAmount").value;
Â  Â  const billUrl = document.getElementById("expBillUrl").value;
Â  Â  const dateVal = document.getElementById("expDate").value; // NEW
Â  Â  const key = document.getElementById("editExpenseKey").value;

Â  Â  if(!desc || !amount) return alert("Description and Amount are required.");
Â  Â  if(!billUrl) return alert("âš  STOP: Bill/Drive Link is REQUIRED.");
Â  Â  if(!dateVal) return alert("âš  Please select the Date of Expense.");

Â  Â  // Convert selected date string (YYYY-MM-DD) to Timestamp
Â  Â  // We append T12:00:00 to prevent timezone shifts changing the day
Â  Â  const finalTimestamp = new Date(dateVal + "T12:00:00").getTime();

Â  Â  const status = isAdmin ? "Approved" : "Pending";

Â  Â  const data = {
Â  Â  Â  Â  type: "EXPENSE",Â 
Â  Â  Â  Â  desc: desc,
Â  Â  Â  Â  amount: parseFloat(amount),
Â  Â  Â  Â  billUrl: billUrl,
Â  Â  Â  Â  mode: "Cash/Misc",
Â  Â  Â  Â  status: status,
Â  Â  Â  Â  by: currentUser.email,
Â  Â  Â  Â  timestamp: finalTimestamp // Use Custom Date
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  if(key) {
Â  Â  Â  Â  Â  Â  await update(ref(db, `finance/${key}`), data);
Â  Â  Â  Â  Â  Â  alert("Expense Updated!");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await push(ref(db, "finance"), data);
Â  Â  Â  Â  Â  Â  alert(isAdmin ? "Expense Added & Deducted." : "Expense Request Sent.");
Â  Â  Â  Â  }
Â  Â  Â  Â  cancelExpEdit();
Â  Â  } catch(e) { alert(e.message); }
};

window.editExpense = async (key) => {
Â  Â  const snap = await get(ref(db, `finance/${key}`));
Â  Â  const d = snap.val();
Â  Â Â 
Â  Â  document.getElementById("expDesc").value = d.desc;
Â  Â  document.getElementById("expAmount").value = d.amount;
Â  Â  document.getElementById("expBillUrl").value = d.billUrl || "";
Â  Â Â 
Â  Â  // Convert Timestamp back to YYYY-MM-DD for the input
Â  Â  if(d.timestamp) {
Â  Â  Â  Â  const dateObj = new Date(d.timestamp);
Â  Â  Â  Â  const yyyy = dateObj.getFullYear();
Â  Â  Â  Â  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  const dd = String(dateObj.getDate()).padStart(2, '0');
Â  Â  Â  Â  document.getElementById("expDate").value = `${yyyy}-${mm}-${dd}`;
Â  Â  }

Â  Â  document.getElementById("editExpenseKey").value = key;
Â  Â  document.getElementById("btnExpSubmit").innerText = "UPDATE EXPENSE";
Â  Â  document.getElementById("btnExpCancel").classList.remove("hidden");
Â  Â  document.getElementById("expenseFormPanel").scrollIntoView({behavior:"smooth"});
};

window.cancelExpEdit = () => {
Â  Â  document.getElementById("expDesc").value = "";
Â  Â  document.getElementById("expAmount").value = "";
Â  Â  document.getElementById("expBillUrl").value = "";
Â  Â  document.getElementById("expDate").value = ""; // Clear Date
Â  Â  document.getElementById("editExpenseKey").value = "";
Â  Â  document.getElementById("btnExpSubmit").innerText = "SUBMIT EXPENSE";
Â  Â  document.getElementById("btnExpCancel").classList.add("hidden");
};
// --- NEW: EDIT & DELETE FUNCTIONS FOR FUNDS ---
window.editFund = async (key) => {
Â  Â  const snap = await get(ref(db, `finance/${key}`));
Â  Â  const val = snap.val();
Â  Â Â 
Â  Â  document.getElementById("fundAmount").value = val.amount;
Â  Â  document.getElementById("fundSource").value = val.desc;
Â  Â  document.getElementById("fundStatus").value = val.status;
Â  Â Â 
Â  Â  // Handle Mode
Â  Â  const defaultModes = ["NEFT/RTGS", "Cheque", "Cash", "UPI"];
Â  Â  if(defaultModes.includes(val.mode)) {
Â  Â  Â  Â  document.getElementById("fundMode").value = val.mode;
Â  Â  Â  Â  document.getElementById("fundModeOther").classList.add("hidden");
Â  Â  } else {
Â  Â  Â  Â  document.getElementById("fundMode").value = "Other";
Â  Â  Â  Â  document.getElementById("fundModeOther").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("fundModeOther").value = val.mode;
Â  Â  }

Â  Â  // UI Changes
Â  Â  document.getElementById("editFundKey").value = key;
Â  Â  document.getElementById("btnFundSubmit").innerText = "UPDATE ENTRY";
Â  Â  document.getElementById("btnFundSubmit").classList.replace("success", "warning");
Â  Â  document.getElementById("btnFundCancel").classList.remove("hidden");
Â  Â  document.getElementById("adminFundPanel").scrollIntoView({behavior: "smooth"});
};

window.deleteFund = async (key) => {
Â  Â  if(confirm("âš  PERMANENTLY DELETE this fund entry?\n\nThis will affect the Balance Sheet calculation.")) {
Â  Â  Â  Â  await remove(ref(db, `finance/${key}`));
Â  Â  }
};

window.cancelFundEdit = () => {
Â  Â  document.getElementById("fundAmount").value = "";
Â  Â  document.getElementById("fundSource").value = "";
Â  Â  document.getElementById("fundMode").value = "NEFT/RTGS";
Â  Â  document.getElementById("fundStatus").value = "Approved";
Â  Â  document.getElementById("fundModeOther").classList.add("hidden");
Â  Â Â 
Â  Â  document.getElementById("editFundKey").value = "";
Â  Â  document.getElementById("btnFundSubmit").innerText = "CREDIT FUND";
Â  Â  document.getElementById("btnFundSubmit").classList.replace("warning", "success");
Â  Â  document.getElementById("btnFundCancel").classList.add("hidden");
};
window.calcPurTotal = () => {
Â  Â  const p = document.getElementById("purPrice").value || 0;
Â  Â  const q = document.getElementById("purQty").value || 0;
Â  Â  document.getElementById("purTotal").value = (p*q).toFixed(2);
};
window.submitPurchase = async () => {
Â  Â  const item = document.getElementById("purItem").value;
Â  Â  const price = document.getElementById("purPrice").value;
Â  Â  const qty = document.getElementById("purQty").value;
Â  Â  const total = document.getElementById("purTotal").value;
Â  Â  const billUrl = document.getElementById("purBillUrl").value; // New Field
Â  Â  const key = document.getElementById("editPurchaseKey").value;
Â  Â Â 
Â  Â  if(!item || !total) return alert("Please fill details");
Â  Â Â 
Â  Â  // STRICT VALIDATION: Bill is required
Â  Â  if(!billUrl) return alert("âš  STOP: Bill/Drive Link is REQUIRED for purchases.\n\n(If bill is pending, please type 'Pending' in the link box to proceed).");

Â  Â  const status = isAdmin ? "Approved" : "Pending";

Â  Â  const data = {
Â  Â  Â  Â  type: "DEBIT",Â 
Â  Â  Â  Â  productName: item,Â 
Â  Â  Â  Â  platform: document.getElementById("purPlatform").value,
Â  Â  Â  Â  orderId: document.getElementById("purOrderId").value,Â 
Â  Â  Â  Â  unitPrice: price,Â 
Â  Â  Â  Â  qty: qty,
Â  Â  Â  Â  amount: parseFloat(total),Â 
Â  Â  Â  Â  desc: `Purchase: ${item}`,Â 
Â  Â  Â  Â  billUrl: billUrl, // Save Link
Â  Â  Â  Â  status: status,
Â  Â  Â  Â  by: currentUser.email,
Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  };
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  if(key) {Â 
Â  Â  Â  Â  Â  Â  await update(ref(db, `finance/${key}`), data);Â 
Â  Â  Â  Â  Â  Â  alert("Purchase Entry Updated!");Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  await push(ref(db, "finance"), data);Â 
Â  Â  Â  Â  Â  Â  alert(isAdmin ? "Purchase Saved." : "Purchase Request Sent.");
Â  Â  Â  Â  }
Â  Â  Â  Â  clearPurForm();
Â  Â  } catch(e) { alert(e.message); }
};
window.editPurchase = async (key) => {
Â  Â  const snap = await get(ref(db, `finance/${key}`));
Â  Â  const d = snap.val();
Â  Â  document.getElementById("purItem").value = d.productName;
Â  Â  document.getElementById("purPlatform").value = d.platform;
Â  Â  document.getElementById("purOrderId").value = d.orderId;
Â  Â  document.getElementById("purPrice").value = d.unitPrice;
Â  Â  document.getElementById("purQty").value = d.qty;
Â  Â  document.getElementById("purTotal").value = d.amount;
Â  Â Â 
Â  Â  // NEW FIELD
Â  Â  document.getElementById("purBillUrl").value = d.billUrl || "";

Â  Â  document.getElementById("editPurchaseKey").value = key;
Â  Â  document.getElementById("btnPurSubmit").innerText = "UPDATE ENTRY";
Â  Â  switchTab('purchase');
};

window.clearPurForm = () => {
Â  Â  document.getElementById("purItem").value = "";Â 
Â  Â  document.getElementById("purPrice").value = "";
Â  Â  document.getElementById("purQty").value = "";Â 
Â  Â  document.getElementById("purTotal").value = "";
Â  Â  document.getElementById("purBillUrl").value = ""; // Clear new field
Â  Â  document.getElementById("editPurchaseKey").value = "";
Â  Â  document.getElementById("btnPurSubmit").innerText = "SAVE & DEDUCT FUND";
};
window.loadFinanceData = () => {
Â  Â  // 1. Show Admin Panel
Â  Â  if(isAdmin) {
Â  Â  Â  Â  const panel = document.getElementById("adminFundPanel");
Â  Â  Â  Â  if(panel) panel.classList.remove("hidden");
Â  Â  }
Â  Â Â 
Â  Â  const tbody = document.getElementById("fundTableBody");
Â  Â  if(!tbody) return;

Â  Â  // 2. Setup Headers (CHANGED: 'Mode/Bill' -> 'Bill (Proof)')
Â  Â  const theadRow = document.querySelector("#tab-funds thead tr");
Â  Â  if(theadRow) {
Â  Â  Â  Â  let headerHTML = `<th>Date</th><th>Type</th><th>Description</th><th>Bill (Proof)</th><th>Credit (+)</th><th>Debit (-)</th>`;
Â  Â  Â  Â  if(isAdmin) headerHTML += `<th>Action</th>`;
Â  Â  Â  Â  theadRow.innerHTML = headerHTML;
Â  Â  }

Â  Â  // 3. Clear Old Listener
Â  Â  if(window.financeListener) { try{ off(ref(db, "finance")); }catch(e){} }

Â  Â  // 4. Start New Listener
Â  Â  window.financeListener = onValue(ref(db, "finance"), (snap) => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "";Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let totalCredit = 0;
Â  Â  Â  Â  Â  Â  let totalDebit = 0;
Â  Â  Â  Â  Â  Â  const txs = [];

Â  Â  Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;'>No records found.</td></tr>";
Â  Â  Â  Â  Â  Â  Â  Â  updateDashboard(0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const val = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  if(val) txs.push({ key: c.key, ...val });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Sort: Newest First
Â  Â  Â  Â  Â  Â  txs.sort((a,b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const tA = a.timestamp || Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  const tB = b.timestamp || Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  return tB - tA;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  txs.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const currentStatus = t.status || 'Approved';
Â  Â  Â  Â  Â  Â  Â  Â  const isCredit = t.type === 'CREDIT';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Visibility Logic
Â  Â  Â  Â  Â  Â  Â  Â  const isDebitOrExp = (t.type === 'DEBIT' || t.type === 'EXPENSE');
Â  Â  Â  Â  Â  Â  Â  Â  if (isDebitOrExp && currentStatus !== 'Approved') return;

Â  Â  Â  Â  Â  Â  Â  Â  let amount = parseFloat(t.amount);
Â  Â  Â  Â  Â  Â  Â  Â  if(isNaN(amount)) amount = 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Balance Logic
Â  Â  Â  Â  Â  Â  Â  Â  if(isCredit) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentStatus === 'Approved') totalCredit += amount;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDebit += amount;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Formatting
Â  Â  Â  Â  Â  Â  Â  Â  let dateStr = t.timestamp ? new Date(t.timestamp).toLocaleDateString() : "Legacy";
Â  Â  Â  Â  Â  Â  Â  Â  let colorClass = 'color:black';
Â  Â  Â  Â  Â  Â  Â  Â  if(isCredit) colorClass = 'color:green';
Â  Â  Â  Â  Â  Â  Â  Â  if(isDebitOrExp) colorClass = 'color:red';

Â  Â  Â  Â  Â  Â  Â  Â  const desc = t.desc || t.productName || "-";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- NEW: BILL COLUMN LOGIC (Replaces Mode) ---
Â  Â  Â  Â  Â  Â  Â  Â  let billDisplay = `<span style="color:#ccc;">-</span>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(t.billUrl && t.billUrl.trim() !== "") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If it is a web link (http/https)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.billUrl.startsWith("http")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  billDisplay = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${t.billUrl}" target="_blank" style="
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: #e0f2fe;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: #0284c7;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid #7dd3fc;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  padding: 4px 8px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text-decoration: none;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gap: 4px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-external-link-alt"></i> View Drive
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If it's text like "Pending"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  billDisplay = `<span style="font-size:11px; color:orange; font-weight:bold;">${t.billUrl}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Action Buttons
Â  Â  Â  Â  Â  Â  Â  Â  let actionButtons = "";
Â  Â  Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let editFunc = `editFund('${t.key}')`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.type === 'EXPENSE') editFunc = `editExpense('${t.key}')`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.type === 'DEBIT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `<td><small>Edit in Procurement</small></td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `<td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="${editFunc}" class="warning" style="padding:2px 5px; font-size:10px; color:white; background:#d97706; margin-right:3px;">âœ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteFund('${t.key}')" class="danger" style="padding:2px 5px; font-size:10px; color:white; background:#B91C1C;">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">${dateStr}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; ${colorClass}">${t.type}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${desc}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${billDisplay}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:green; text-align:right;">${isCredit ? 'â‚¹'+amount.toFixed(2) : '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:red; text-align:right;">${!isCredit ? 'â‚¹'+amount.toFixed(2) : '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  updateDashboard(totalCredit, totalDebit);

Â  Â  Â  Â  } catch (globalErr) { console.error(globalErr); }
Â  Â  });
};
// Helper to update the top cards
function updateDashboard(credit, debit) {
Â  Â  const balance = credit - debit;
Â  Â  document.getElementById("dispTotalCredit").innerText = `â‚¹ ${credit.toLocaleString('en-IN')}`;
Â  Â  document.getElementById("dispTotalDebit").innerText = `â‚¹ ${debit.toLocaleString('en-IN')}`;
Â  Â  document.getElementById("dispBalance").innerText = `â‚¹ ${balance.toLocaleString('en-IN')}`;

Â  Â  const healthEl = document.getElementById("budgetHealthText");
Â  Â  const ratio = credit > 0 ? (balance / credit) * 100 : 0;
Â  Â Â 
Â  Â  // LOGIC UPDATE:
Â  Â  // 1. Critical if less than 20% of funds remain
Â  Â  // 2. Tight Budget if Balance is strictly BELOW 2000 (regardless of percentage)
Â  Â  if(ratio < 20) {Â 
Â  Â  Â  Â  healthEl.innerText = "âš  Critical Low";Â 
Â  Â  Â  Â  healthEl.style.color = "red";Â 
Â  Â  }
Â  Â  else if(balance < 2000) {Â 
Â  Â  Â  Â  healthEl.innerText = "âš  Tight Budget";Â 
Â  Â  Â  Â  healthEl.style.color = "orange";Â 
Â  Â  }
Â  Â  else {Â 
Â  Â  Â  Â  healthEl.innerText = "âœ… Healthy";Â 
Â  Â  Â  Â  healthEl.style.color = "green";Â 
Â  Â  }
}
// --- CONFIGURATION ---
const firebaseConfig = {
Â  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
Â  authDomain: "metro-railway-project.firebaseapp.com",
Â  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
Â  projectId: "metro-railway-project"
};

// --- INITIALIZE ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
let isSwitching = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project", "hodee@metro.project", "hodcseaiml@metro.project", "hodeee@metro.project", "arijita@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];
let modelsLoaded = false;
let isTransactionAuth = false;
let currentTransactionType = "";
// --- GLOBAL LISTENER TRACKERS (PREVENTS CROSSTALK) ---
Â  Â  Â // For Field Inspection (Rake Table)
let galleryListener = null;Â  Â // For Compliance Docs (Gallery Grid)
let logViewListener = null;Â  Â // For Master Log Database (Data View Table)
let printListener = null;Â  Â  Â // For Print Report List
let scanMode = 'LOGIN';

let receiverVerified = false;

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null; // Stores details of scanned item for Checkout/Return// --- GLOBAL STATE TRACKERS ---
let scanner = null;
let existingItemKey = null; // To track if we are updating existing stock

// --- SIGNATURE PAD LOGIC (UPDATED FOR MOBILE) ---
function setupCanvas(id) {
Â  Â  const canvas = document.getElementById(id);
Â  Â  if (!canvas) return; // Safety check

Â  Â  const ctx = canvas.getContext('2d');
Â  Â  ctx.lineWidth = 3;Â  Â  Â  Â // Thicker line for better visibility on mobile
Â  Â  ctx.lineCap = 'round';Â  Â // Smooth edges
Â  Â  ctx.strokeStyle = '#000000';

Â  Â  let isDrawing = false;

Â  Â  // 1. FORCE DISABLE SCROLLING ON CANVAS via JS
Â  Â  canvas.style.touchAction = 'none';

Â  Â  // Helper to get exact coordinates
Â  Â  function getPos(e) {
Â  Â  Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  Â  Â  // Calculate scaling (vital if CSS shrinks the canvas)
Â  Â  Â  Â  const scaleX = canvas.width / rect.width;
Â  Â  Â  Â  const scaleY = canvas.height / rect.height;
Â  Â  Â  Â Â 
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  x: (e.clientX - rect.left) * scaleX,
Â  Â  Â  Â  Â  Â  y: (e.clientY - rect.top) * scaleY
Â  Â  Â  Â  };
Â  Â  }

Â  Â  // --- POINTER EVENTS (Handles Mouse + Touch automatically) ---

Â  Â  // Start Drawing
Â  Â  canvas.addEventListener('pointerdown', (e) => {
Â  Â  Â  Â  isDrawing = true;
Â  Â  Â  Â  canvas.setPointerCapture(e.pointerId); // LOCKS pointer to canvas so you can't scroll away
Â  Â  Â  Â  const pos = getPos(e);
Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  ctx.moveTo(pos.x, pos.y);
Â  Â  Â  Â  e.preventDefault();
Â  Â  });

Â  Â  // Draw Line
Â  Â  canvas.addEventListener('pointermove', (e) => {
Â  Â  Â  Â  if (!isDrawing) return;
Â  Â  Â  Â  const pos = getPos(e);
Â  Â  Â  Â  ctx.lineTo(pos.x, pos.y);
Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  e.preventDefault();
Â  Â  });

Â  Â  // Stop Drawing
Â  Â  canvas.addEventListener('pointerup', (e) => {
Â  Â  Â  Â  isDrawing = false;
Â  Â  Â  Â  canvas.releasePointerCapture(e.pointerId);
Â  Â  });

Â  Â  // Cancel (e.g. finger slides off screen edge)
Â  Â  canvas.addEventListener('pointercancel', () => {
Â  Â  Â  Â  isDrawing = false;
Â  Â  });
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => {
Â  Â  const canvas = document.getElementById(id);
Â  Â  const ctx = canvas.getContext('2d');
Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
}
// A. HARD RESET FOR INPUT FORM
function resetInputForm() {
Â  Â  // 1. Cut the Connection
Â  Â  if (rowListener) { off(ref(db), rowListener); rowListener = null; }

Â  Â  // 2. Wipe Variables
Â  Â  rtStationKey = null;
Â  Â  rtRakeKey = null;

Â  Â  // 3. Wipe UI Inputs
Â  Â  const inputs = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
Â  Â  inputs.forEach(id => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if(el) { el.value = ""; el.oninput = null; el.onchange = null; } // Detach events
Â  Â  });

Â  Â  // 4. Wipe Table
Â  Â  document.getElementById("distanceBody").innerHTML = "";
Â  Â Â 
Â  Â  // 5. Reset Buttons
Â  Â  document.getElementById("btnFinalSubmit").innerText = "Loading...";
Â  Â  document.getElementById("btnFinalSubmit").disabled = true;
}
window.handleGalleryLineChange = () => {
Â  Â  const lineSel = document.getElementById("galleryLineSelect");
Â  Â  const stnSel = document.getElementById("galleryStationSelect");
Â  Â  const uploadSection = document.getElementById("galleryUploadSection");
Â  Â Â 
Â  Â  // 1. Reset Station Dropdown
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;

Â  Â  // 2. Hide Upload Section (Safety)
Â  Â  if(uploadSection) uploadSection.classList.add("hidden");

Â  Â  // 3. Populate Stations based on Line
Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};
window.handleGalleryStationChange = () => {
Â  Â  const line = document.getElementById("galleryLineSelect").value;
Â  Â  const stn = document.getElementById("galleryStationSelect").value;
Â  Â  const galleryDiv = document.getElementById("galleryContainer");
Â  Â  const uploadSection = document.getElementById("galleryUploadSection");
Â  Â  const targetText = document.getElementById("uploadTargetText");

Â  Â  // 1. CLEANUP OLD LISTENER (Stops Duplicates)
Â  Â  if (galleryListener) {
Â  Â  Â  Â  if(typeof galleryListener === "function") galleryListener();
Â  Â  Â  Â  else try { off(ref(db, "history"), galleryListener); } catch(e) {}
Â  Â  Â  Â  galleryListener = null;
Â  Â  }

Â  Â  // 2. RESET UI
Â  Â  galleryDiv.innerHTML = "";Â 
Â  Â Â 
Â  Â  if (!line || !stn) {
Â  Â  Â  Â  if(uploadSection) uploadSection.classList.add("hidden");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if(uploadSection) uploadSection.classList.remove("hidden");
Â  Â  if(targetText) targetText.innerText = `Target: ${stn} (${line})`;

Â  Â  galleryDiv.innerHTML = `<p style="text-align:center; width:100%; color:#666;">Loading evidence...</p>`;

Â  Â  // 3. LIVE DATABASE QUERY
Â  Â  const targetName = `${stn} (${line})`;
Â  Â  const q = query(ref(db, "history"), orderByChild("stationName"), equalTo(targetName));
Â  Â Â 
Â  Â  galleryListener = onValue(q, (snap) => {
Â  Â  Â  Â  galleryDiv.innerHTML = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  galleryDiv.innerHTML = `<p style="text-align:center; color:#94a3b8; width:100%; padding:20px;">No documents found for this station.</p>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  // --- SMART FORMAT DETECTION (Fixes 'Unsupported') ---
Â  Â  Â  Â  Â  Â  const fileName = (v.name || "").toLowerCase();
Â  Â  Â  Â  Â  Â  const fileType = (v.fileType || "").toLowerCase();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let isImage = fileType.includes("image") || fileName.endsWith("jpg") || fileName.endsWith("jpeg") || fileName.endsWith("png");
Â  Â  Â  Â  Â  Â  let isPdf = fileType.includes("pdf") || fileName.endsWith("pdf");

Â  Â  Â  Â  Â  Â  let media = "";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isImage) {
Â  Â  Â  Â  Â  Â  Â  Â  // SHOW IMAGE PREVIEW
Â  Â  Â  Â  Â  Â  Â  Â  media = `<img src="${v.fileData}" onclick="window.open('${v.fileData}', '_blank')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="cursor:pointer; width:100%; height:140px; object-fit:cover; border-radius:4px; border:1px solid #eee;">`;
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  else if (isPdf) {
Â  Â  Â  Â  Â  Â  Â  Â  // SHOW PDF ICON
Â  Â  Â  Â  Â  Â  Â  Â  media = `<div onclick="window.open('${v.fileData}', '_blank')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="cursor:pointer; height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#fff1f2; color:#be123c; border-radius:4px; border:1px solid #fecdd3;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-pdf" style="font-size:40px; margin-bottom:10px;"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:11px; font-weight:bold;">OPEN PDF</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  // GENERIC FILE
Â  Â  Â  Â  Â  Â  Â  Â  media = `<div style="padding:20px; color:#666; background:#f1f5f9; border-radius:4px; text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-alt"></i><br>File
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- ADMIN CONTROLS ---
Â  Â  Â  Â  Â  Â  let controls = "";
Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  controls = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:8px; display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${v.fileData}" download="${v.name || 'evidence'}" class="info" style="flex:1; text-decoration:none; padding:6px; font-size:11px; text-align:center; border-radius:4px; background:#0ea5e9; color:white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-download"></i> Save
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="removeFile('${c.key}')" style="padding:6px 10px; font-size:11px; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-trash"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  controls = `<div style="margin-top:5px; font-size:10px; color:#cbd5e1; text-align:center;">View Only</div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- RENDER CARD ---
Â  Â  Â  Â  Â  Â  const card = `
Â  Â  Â  Â  Â  Â  <div class="gallery-item" style="display:flex; flex-direction:column; justify-content:space-between; background:white; padding:10px; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${media}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:12px; margin-top:8px; font-weight:bold; color:#334155; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${v.name}">${v.name || 'Evidence'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:10px; color:#94a3b8;">By: ${v.userName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${controls}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  galleryDiv.innerHTML += card;
Â  Â  Â  Â  });
Â  Â  });
};
// --- NEW HELPER: Signature Modal ---
window.viewSignature = (sigData) => {
Â  Â  document.getElementById("modalSigImage").src = sigData;
Â  Â  document.getElementById("sigModal").classList.remove("hidden");
};
window.closeSigModal = () => document.getElementById("sigModal").classList.add("hidden");

// --- NEW BARCODE LOGIC ---
window.openBarcodeScanner = (mode) => {
Â  Â  scanMode = mode;
Â  Â  document.getElementById("barcodeModal").classList.remove("hidden");
Â  Â Â 
Â  Â  // START SCANNER
Â  Â  if(!scanner) {
Â  Â  Â  Â  scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
Â  Â  Â  Â  scanner.render(onScanSuccess, onScanFailure);
Â  Â  }
}
// ==========================================
// 1. ADMIN PANEL (With Unban Logic)
// ==========================================
let adminListener = null;

// B. Save Field Real-Time Helper
window.saveFieldRealTime = (id) => {
Â  Â  if(!rtStationKey) return;
Â  Â Â 
Â  Â  const map = {
Â  Â  Â  Â  "inpStationLength": "len",
Â  Â  Â  Â  "inpYellowDist": "yl",
Â  Â  Â  Â  "inpYellowThick": "th",
Â  Â  Â  Â  "inpRemarks": "remarks",
Â  Â  Â  Â  "inpImplementation": "impl"
Â  Â  };

Â  Â  const dbField = map[id];
Â  Â  const val = document.getElementById(id).value;

Â  Â  // Update Master Log Directly
Â  Â  update(ref(db, `station_logs/${rtStationKey}`), {
Â  Â  Â  Â  [dbField]: val,
Â  Â  Â  Â  last_modified: serverTimestamp() // Audit trail
Â  Â  });
};

// C. Load Rows from Rake Logs (Master)
let rowListener = null;
function loadRealTimeRows() {
Â  Â  if(rowListener) { off(ref(db), rowListener); rowListener = null; } // Cleanup

Â  Â  const tbody = document.getElementById("distanceBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Syncing...</td></tr>";

Â  Â  const rowsRef = ref(db, `rake_logs/${rtRakeKey}`);
Â  Â Â 
Â  Â  // Real-time listener on the MASTER LOG rake node
Â  Â  rowListener = onValue(rowsRef, (snap) => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  if(!snap.exists()) return;

Â  Â  Â  Â  let i = 1;
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const rowKey = c.key;
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  renderRealTimeRow(rowKey, v, i++);
Â  Â  Â  Â  });
Â  Â  });
}

// D. Render Row (With Direct Master Log Bindings)
function renderRealTimeRow(key, v, index) {
Â  Â  const tbody = document.getElementById("distanceBody");
Â  Â  const isSel = (val) => (v.type === val ? "selected" : "");

Â  Â  // Note the function calls: upRowRealTime and delRowRealTime
Â  Â  const html = `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:bold;">${index}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.rake || ''}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="upRowRealTime('${key}','rake',this.value)" placeholder="Rake ID">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <select style="width:100%; padding:5px;" onchange="upRowRealTime('${key}','type',this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" ${isSel("")}>-- Select --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="BHEL RAKE" ${isSel("BHEL RAKE")}>BHEL RAKE</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="MEDHA RAKE" ${isSel("MEDHA RAKE")}>MEDHA RAKE</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="DALIAN RAKE" ${isSel("DALIAN RAKE")}>DALIAN RAKE</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td><input style="width:100%" value="${v.f || ''}" oninput="upRowRealTime('${key}','f',this.value)" placeholder="Front"></td>
Â  Â  Â  Â  Â  Â  <td><input style="width:100%" value="${v.r || ''}" oninput="upRowRealTime('${key}','r',this.value)" placeholder="Rear"></td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="delRowRealTime('${key}')">X</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
Â  Â  tbody.innerHTML += html;
}
// Updated Row Edit Function
window.upRow = (k, f, v) => {
Â  Â  // ğŸ›‘ SAFETY LOCK: If we are switching, ignore this old event
Â  Â  if (isSwitching) {
Â  Â  Â  Â  console.warn("Blocked ghost write during switch.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), { [f]: v });
};

// Updated Add Row Function
window.addDistanceRow = () => {
Â  Â  if (isSwitching) return; // ğŸ›‘ Block add during switch
Â  Â  push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });
};

// Updated Delete Row Function
window.delRow = (k) => {
Â  Â  if (isSwitching) return; // ğŸ›‘ Block delete during switch
Â  Â  remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
};
window.upRowRealTime = (rowKey, field, val) => {
Â  Â  update(ref(db, `rake_logs/${rtRakeKey}/${rowKey}`), { [field]: val });
};

window.delRowRealTime = (rowKey) => {
Â  Â  if(confirm("Delete this row permanently?")) {
Â  Â  Â  Â  remove(ref(db, `rake_logs/${rtRakeKey}/${rowKey}`));
Â  Â  }
};
window.closeBarcodeScanner = () => {
Â  Â  document.getElementById("barcodeModal").classList.add("hidden");
Â  Â  if(scanner) {
Â  Â  Â  Â  scanner.clear();
Â  Â  Â  Â  scanner = null;
Â  Â  }
}
// --- NEW AUDIT LOGIC ---
window.closeAuditModal = () => document.getElementById("auditResultModal").classList.add("hidden");
window.fetchAuditHistory = async (barcode) => {
Â  Â  if (!barcode) return;

Â  Â  const modal = document.getElementById("auditResultModal");
Â  Â  const container = document.getElementById("auditTimelineContainer");
Â  Â Â 
Â  Â  if(modal) modal.classList.remove("hidden");
Â  Â  document.getElementById("auditModalBarcode").innerText = "Tag ID: " + barcode;

Â  Â  if(container) container.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-sync fa-spin"></i> Retrieving Secure Records...</div>`;

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "logs"));
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  container.innerHTML = `<div style="text-align:center;color:#777;">No history found in database</div>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let raw = [];
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  // Filter logs by the specific barcode scanned
Â  Â  Â  Â  Â  Â  if (v.barcode === barcode) {
Â  Â  Â  Â  Â  Â  Â  Â  raw.push(v);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (raw.length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = `<div style="text-align:center;color:#777;padding:20px;">No movement history for Tag: <b>${barcode}</b></div>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Sort: Newest movement first
Â  Â  Â  Â  raw.sort((a, b) => (b.time || 0) - (a.time || 0));

Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  raw.forEach(l => {
Â  Â  Â  Â  Â  Â  let cardClass = "add";
Â  Â  Â  Â  Â  Â  if(l.type === "CHECKOUT") cardClass = "checkout";
Â  Â  Â  Â  Â  Â  if(l.type === "RETURN" || l.type === "ITEM_RESTOCKED") cardClass = "return";

Â  Â  Â  Â  Â  Â  const timeStr = new Date(l.time).toLocaleString('en-IN');

Â  Â  Â  Â  Â  Â  container.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="history-card ${cardClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="hc-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hc-user">ğŸ‘¤ ${l.takenBy || l.by || 'System'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:10px; font-weight:bold; text-transform:uppercase;">${l.type}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="hc-meta">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b>Date:</b> ${timeStr}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b>Site:</b> ${l.assignedStation || l.location || 'N/A'}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${l.reason ? `<b>Reason:</b> ${l.reason}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${l.invoice ? `<b>Invoice:</b> ${l.invoice}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  if(container) container.innerHTML = `<div style="color:red;text-align:center;">Sync Error: ${e.message}</div>`;
Â  Â  }
};
// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = "";Â 
};

window.loadInventory = () => {
Â  Â  const b = document.getElementById("inventoryBody");
Â  Â  const summaryEl = document.getElementById("stockSummaryText");
Â  Â  if (!b) return;

Â  Â  // Attach real-time listener to the inventory node
Â  Â  onValue(ref(db, "inventory"), (snap) => {
Â  Â  Â  Â  b.innerHTML = "";
Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  let available = 0;

Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  b.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:20px;'>No assets found in database.</td></tr>";
Â  Â  Â  Â  Â  Â  if (summaryEl) summaryEl.innerText = "Total: 0 | Available: 0";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach((c) => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  const k = c.key;
Â  Â  Â  Â  Â  Â  total++;

Â  Â  Â  Â  Â  Â  // --- CRITICAL FIX: LOGIC FOR SOLD OUT VS IN STOCK ---
Â  Â  Â  Â  Â  Â  // An item is ONLY "Available" if it is NOT sold AND NOT checked out.
Â  Â  Â  Â  Â  Â  const isSold = (v.status === "Sold Out" || v.invoiceNo != null);
Â  Â  Â  Â  Â  Â  const isCheckedOut = (v.status === "Checked Out");

Â  Â  Â  Â  Â  Â  if (!isSold && !isCheckedOut) {
Â  Â  Â  Â  Â  Â  Â  Â  available++;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Define Status Badge Styling
Â  Â  Â  Â  Â  Â  let statusStyle = "background:#dcfce7; color:#166534; border: 1px solid #bbf7d0;"; // Default: In Stock
Â  Â  Â  Â  Â  Â  let displayStatus = v.status || "In Stock";

Â  Â  Â  Â  Â  Â  if (isSold) {
Â  Â  Â  Â  Â  Â  Â  Â  statusStyle = "background:#1e293b; color:#ffffff; border: 1px solid #0f172a;";
Â  Â  Â  Â  Â  Â  Â  Â  displayStatus = "Sold Out";
Â  Â  Â  Â  Â  Â  } else if (isCheckedOut) {
Â  Â  Â  Â  Â  Â  Â  Â  statusStyle = "background:#fef3c7; color:#d97706; border: 1px solid #fde68a;";
Â  Â  Â  Â  Â  Â  Â  Â  displayStatus = "Checked Out";
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Action Buttons Logic
Â  Â  Â  Â  Â  Â  let actionBtns = "";
Â  Â  Â  Â  Â  Â  if (isSold) {
Â  Â  Â  Â  Â  Â  Â  Â  // If Sold, only Admin can "Wipe/Restock" it via the Sales History tab.Â 
Â  Â  Â  Â  Â  Â  Â  Â  // We keep the inventory list clean by showing "Locked".
Â  Â  Â  Â  Â  Â  Â  Â  actionBtns = `<small style="color:#64748b; font-style:italic;">Asset Sold</small>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  actionBtns = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="warning" onclick="editExistingItem('${k}')" style="padding:2px 6px; font-size:10px;">EDIT</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isAdmin ? `<button class="danger" onclick="delInv('${k}')" style="padding:2px 6px; font-size:10px; margin-left:4px;">DEL</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const invoiceLabel = v.invoiceNo ? `<div style="font-size:9px; color:#64748b; font-family:monospace; margin-top:2px;">INV: ${v.invoiceNo}</div>` : "";
Â  Â  Â  Â  Â  Â  const stationLabel = v.assignedStation ? `<div style="color:#B91C1C; font-weight:bold; font-size:10px; margin-top:2px;">ğŸ“ ${v.assignedStation}</div>` : "";

Â  Â  Â  Â  Â  Â  // Construct the Table Row
Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr class="stock-row" data-invoice="${v.invoiceNo || ''}" style="${isSold ? 'background:#f8fafc; color:#64748b;' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; font-weight:bold;">${v.barcode || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${v.item}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${invoiceLabel}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${v.usageCount || 0}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${stationLabel || v.holder || 'Store'}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px; font-weight:bold;">${v.location || 'Main Lab'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; font-weight:900; color:${isSold ? '#64748b' : 'green'};">â‚¹ ${parseFloat(v.purchasePrice || 0).toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="${statusStyle} padding:4px 10px; border-radius:12px; font-size:10px; font-weight:bold; text-transform:uppercase;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${displayStatus}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; white-space:nowrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionBtns}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  b.innerHTML += row;
Â  Â  Â  Â  });

Â  Â  Â  Â  // Update the top summary card
Â  Â  Â  Â  if (summaryEl) {
Â  Â  Â  Â  Â  Â  summaryEl.innerHTML = `Total Assets: ${total} | <span style="color:#15803d; font-weight:bold;">Available: ${available}</span>`;
Â  Â  Â  Â  }
Â  Â  });
};
window.printReport = (mode) => {
Â  Â  // 1. Clean previous classes
Â  Â  document.body.classList.remove('print-a4', 'print-pos');

Â  Â  // 2. Add class based on selection
Â  Â  if (mode === 'A4') {
Â  Â  Â  Â  document.body.classList.add('print-a4');
Â  Â  } else {
Â  Â  Â  Â  // POS MODE (Receipt)
Â  Â  Â  Â  document.body.classList.add('print-pos');
Â  Â  }

Â  Â  // 3. Trigger Print Dialog
Â  Â  setTimeout(() => {
Â  Â  Â  Â  window.print();
Â  Â  }, 100); // Small delay to ensure CSS applies
};
// --- FULL FUNCTION: Close Preview Handler ---
window.closeReportPreview = () => {
Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  if (reportContainer) {
Â  Â  Â  Â  // 1. Hide it
Â  Â  Â  Â  reportContainer.classList.add("hidden");
Â  Â  Â  Â  // 2. Wipe the data so it doesn't show old info next time
Â  Â  Â  Â  reportContainer.innerHTML = "";Â 
Â  Â  }
Â  Â  // 3. Remove print classes from body
Â  Â  document.body.classList.remove('print-a4', 'print-pos');
};
// --- 4. EMPTY/DUMMY LOAD HISTORY (Prevents errors when clicking tab) ---
window.loadInventoryHistory = () => {
Â  Â  // Intentionally empty or just focuses the search box
Â  Â  // Because we removed the table
Â  Â  setTimeout(() => document.getElementById("auditSearchInput").focus(), 300);
};

// --- 2. UNIFIED SCANNER HANDLER (This replaces your old one) ---


// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = "";Â 
};


window.closeAuditModal = () => {
Â  Â  document.getElementById("auditResultModal").classList.add("hidden");
Â  Â  document.getElementById("auditSearchInput").value = ""; // Clear input
};
// --- UNIFIED SCANNER HANDLER ---

function onScanFailure(error) {
Â  Â  // Do nothing, keep scanning
}

// --- INNOVATIVE BARCODE LOGIC: CHECK EXISTENCE ---
// --- NEW LOGIC: PREVENT DUPLICATE BARCODES ---
window.checkBarcodeUnique = async (code) => {
Â  Â  if(!code) return;
Â  Â Â 
Â  Â  // Reset UI
Â  Â  document.getElementById("barcodeError").classList.add("hidden");
Â  Â  document.getElementById("btnAddStock").disabled = false;
Â  Â  document.getElementById("btnAddStock").innerText = "Save Item to Stock";

Â  Â  // Query DB to see if barcode exists
Â  Â  const invRef = ref(db, "inventory");
Â  Â  const q = query(invRef, orderByChild("barcode"), equalTo(code));
Â  Â  const snap = await get(q);

Â  Â  if(snap.exists()) {
Â  Â  Â  Â  // ERROR: DUPLICATE FOUND
Â  Â  Â  Â  document.getElementById("barcodeError").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("btnAddStock").disabled = true;
Â  Â  Â  Â  document.getElementById("btnAddStock").innerText = "â›” Duplicate Barcode";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Optional: Show who has it
Â  Â  Â  Â  let existingItem = null;
Â  Â  Â  Â  snap.forEach(c => existingItem = c.val());
Â  Â  Â  Â  alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
Â  Â  }
}
// --- HELPER: TOGGLE 'OTHER' INPUT ---
window.toggleOtherInput = () => {
Â  Â  const val = document.getElementById("returnLocSelect").value;
Â  Â  const otherDiv = document.getElementById("divOtherLoc");
Â  Â Â 
Â  Â  if(val === "Other") {
Â  Â  Â  Â  otherDiv.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("returnLocOther").focus();
Â  Â  } else {
Â  Â  Â  Â  otherDiv.classList.add("hidden");
Â  Â  }
};
// --- NEW: TRIGGER RECEIVER SCAN ---
window.startReceiverScan = (type) => {
Â  Â  scanMode = 'RECEIVER';
Â  Â  currentTransactionType = type; // 'CHECKOUT' or 'RETURN'
Â  Â Â 
Â  Â  document.getElementById("faceModal").classList.remove("hidden");
Â  Â  document.getElementById("modalTitle").innerText = "ğŸ‘¤ Receiver Verification";
Â  Â  document.getElementById("modalDesc").innerText = "Please look at the camera to verify identity.";
Â  Â  document.getElementById("regProgress").classList.add("hidden");
Â  Â  document.getElementById("btnCapture").innerText = "ğŸ“¸ Verify My Face";
Â  Â  document.getElementById("btnCapture").disabled = false;
Â  Â  document.getElementById("btnCapture").onclick = handleFaceScan;
Â  Â Â 
Â  Â  // UI Cleanup
Â  Â  document.getElementById("videoContainer").classList.remove("hidden");
Â  Â  document.getElementById("camControls").classList.remove("hidden");
Â  Â  document.getElementById("otpUI").classList.add("hidden");
Â  Â Â 
Â  Â  initCamera(true);
};
// --- 1. LOAD AI MODELS ---
async function preloadModels() {
Â  Â  if(modelsLoaded) return;
Â  Â  try {
Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
Â  Â  Â  Â  Â  Â  faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
Â  Â  Â  Â  Â  Â  faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
Â  Â  Â  Â  ]);
Â  Â  Â  Â  modelsLoaded = true;
Â  Â  } catch(e) { console.error("Model Error", e); }
}
preloadModels();
// ==========================================
// 1. UPDATED LOGIN FUNCTION
// ==========================================
window.login = () => {
Â  Â  const emailField = document.getElementById("email");
Â  Â  const passField = document.getElementById("password");
Â  Â  const btn = document.querySelector("#loginSection button");
Â  Â Â 
Â  Â  if(!emailField.value || !passField.value) return alert("Please enter credentials.");

Â  Â  btn.innerText = "ğŸ”„ Verifying credentials...";
Â  Â  btn.disabled = true;

Â  Â  signInWithEmailAndPassword(auth, emailField.value, passField.value)
Â  Â  .then(async (userCredential) => {
Â  Â  Â  Â  const user = userCredential.user;
Â  Â  Â  Â  const userSnap = await get(ref(db, `users/${user.uid}`));
Â  Â  Â  Â  const u = userSnap.val();

Â  Â  Â  Â  if (u && u.banned) {
Â  Â  Â  Â  Â  Â  alert("Access Denied: Account Suspended.");
Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- THE FIX: TRIGGER UI SEQUENTIALLY ---
Â  Â  Â  Â  // 1. Hide Login Screen
Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  // 2. Show Face Modal ONLY now
Â  Â  Â  Â  document.getElementById("faceModal").classList.remove("hidden");
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!u || !u.faceData) {
Â  Â  Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "âš ï¸ Face ID Setup";
Â  Â  Â  Â  Â  Â  document.getElementById("btnCapture").onclick = registerNewFace;
Â  Â  Â  Â  Â  Â  initCamera(false);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "Biometric Verification";
Â  Â  Â  Â  Â  Â  document.getElementById("btnCapture").onclick = handleFaceScan;
Â  Â  Â  Â  Â  Â  initCamera(true);
Â  Â  Â  Â  }
Â  Â  })
Â  Â  .catch(e => {
Â  Â  Â  Â  btn.innerText = "VERIFY CREDENTIALS";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  alert("Login Failed: " + e.message);
Â  Â  });
};
// --- EVIDENCE CAMERA LOGIC ---
let evidenceStream = null;
let capturedEvidenceBlob = null; // Stores the photo data

// 1. START CAMERA
window.startEvidenceCamera = async () => {
Â  Â  const video = document.getElementById("evidenceVideo");
Â  Â  const container = document.getElementById("evidenceVideoContainer");
Â  Â Â 
Â  Â  // UI Updates
Â  Â  container.style.display = "block";
Â  Â  document.getElementById("evidencePreview").style.display = "none";
Â  Â  document.getElementById("evidenceCamControls").classList.add("hidden");
Â  Â  document.getElementById("evidenceCaptureControls").classList.remove("hidden");
Â  Â  document.getElementById("evidenceSaveControls").classList.add("hidden");

Â  Â  try {
Â  Â  Â  Â  evidenceStream = await navigator.mediaDevices.getUserMedia({Â 
Â  Â  Â  Â  Â  Â  video: { facingMode: "environment" } // Tries to use back camera on mobile
Â  Â  Â  Â  });
Â  Â  Â  Â  video.srcObject = evidenceStream;
Â  Â  } catch(err) {
Â  Â  Â  Â  alert("Camera Error: " + err.message);
Â  Â  Â  Â  stopEvidenceCamera();
Â  Â  }
};

// 2. CAPTURE PHOTO
window.captureEvidencePhoto = () => {
Â  Â  const video = document.getElementById("evidenceVideo");
Â  Â  const canvas = document.createElement("canvas");
Â  Â Â 
Â  Â  // Set canvas size to match video
Â  Â  canvas.width = video.videoWidth;
Â  Â  canvas.height = video.videoHeight;
Â  Â Â 
Â  Â  // Draw image
Â  Â  canvas.getContext('2d').drawImage(video, 0, 0);
Â  Â Â 
Â  Â  // Convert to data (Quality 0.8 to compress slightly)
Â  Â  const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
Â  Â Â 
Â  Â  // Show Preview
Â  Â  const img = document.getElementById("evidencePreview");
Â  Â  img.src = dataUrl;
Â  Â  img.style.display = "block";
Â  Â Â 
Â  Â  // Hide Video
Â  Â  document.getElementById("evidenceVideoContainer").style.display = "none";
Â  Â Â 
Â  Â  // Store for upload
Â  Â  capturedEvidenceBlob = dataUrl;

Â  Â  // UI Updates
Â  Â  document.getElementById("evidenceCaptureControls").classList.add("hidden");
Â  Â  document.getElementById("evidenceSaveControls").classList.remove("hidden");
Â  Â Â 
Â  Â  // Stop stream to save battery
Â  Â  if(evidenceStream) {
Â  Â  Â  Â  evidenceStream.getTracks().forEach(t => t.stop());
Â  Â  }
};

// 3. RETRY PHOTO
window.retryEvidencePhoto = () => {
Â  Â  capturedEvidenceBlob = null;
Â  Â  startEvidenceCamera();
};

// 4. STOP CAMERA
window.stopEvidenceCamera = () => {
Â  Â  if(evidenceStream) {
Â  Â  Â  Â  evidenceStream.getTracks().forEach(t => t.stop());
Â  Â  Â  Â  evidenceStream = null;
Â  Â  }
Â  Â  document.getElementById("evidenceVideoContainer").style.display = "none";
Â  Â  document.getElementById("evidencePreview").style.display = "none";
Â  Â  document.getElementById("evidenceCamControls").classList.remove("hidden");
Â  Â  document.getElementById("evidenceCaptureControls").classList.add("hidden");
Â  Â  document.getElementById("evidenceSaveControls").classList.add("hidden");
};
// --- ROBUST UPLOAD LOGIC (FIXED) ---

// A. UPLOAD CAPTURED PHOTO
window.uploadCapturedEvidence = async () => {
Â  Â  // 1. Validation Checks
Â  Â  if(!capturedEvidenceBlob) {
Â  Â  Â  Â  return alert("âš ï¸ No photo found. Please capture an image first.");
Â  Â  }
Â  Â Â 
Â  Â  // Check Station Selection
Â  Â  const line = document.getElementById("galleryLineSelect").value;
Â  Â  const stn = document.getElementById("galleryStationSelect").value;
Â  Â  if(!line || !stn) {
Â  Â  Â  Â  return alert("âš ï¸ ERROR: Please select a Line and Station first.");
Â  Â  }

Â  Â  const btn = document.activeElement; // Get the button clicked
Â  Â  const originalText = btn.innerText;
Â  Â  btn.innerText = "â³ Uploading...";
Â  Â  btn.disabled = true;

Â  Â  try {
Â  Â  Â  Â  // 2. Check Size (10MB Limit)
Â  Â  Â  Â  const sizeInBytes = (capturedEvidenceBlob.length * 0.75);
Â  Â  Â  Â  if(sizeInBytes > 10 * 1024 * 1024) throw new Error("Image too large (Max 10MB).");

Â  Â  Â  Â  // 3. Upload
Â  Â  Â  Â  await processUpload(capturedEvidenceBlob, "image/jpeg", "Live Capture.jpg");
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert("âœ… Photo Uploaded Successfully!");
Â  Â  Â  Â  stopEvidenceCamera(); // Close camera on success
Â  Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("âŒ Upload Failed: " + e.message);
Â  Â  } finally {
Â  Â  Â  Â  // 4. Reset Button
Â  Â  Â  Â  btn.innerText = originalText;
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }
};

// B. UPLOAD FROM FILE
window.uploadFileEvidence = async () => {
Â  Â  // 1. Validation Checks
Â  Â  const fileInput = document.getElementById("evidenceFile");
Â  Â  const file = fileInput.files[0];

Â  Â  if(!file) return alert("âš ï¸ Please choose a file first.");

Â  Â  const line = document.getElementById("galleryLineSelect").value;
Â  Â  const stn = document.getElementById("galleryStationSelect").value;
Â  Â  if(!line || !stn) {
Â  Â  Â  Â  return alert("âš ï¸ ERROR: Please select a Line and Station from the dropdowns above.");
Â  Â  }

Â  Â  const btn = document.activeElement;
Â  Â  const originalText = btn.innerText;
Â  Â  btn.innerText = "â³ Processing...";
Â  Â  btn.disabled = true;

Â  Â  // 2. Size Limits
Â  Â  const LIMIT_PDF = 3 * 1024 * 1024;Â  // 3 MB
Â  Â  const LIMIT_IMG = 10 * 1024 * 1024; // 10 MB

Â  Â  if(file.type.includes("pdf") && file.size > LIMIT_PDF) {
Â  Â  Â  Â  btn.innerText = originalText;
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  return alert("âŒ PDF too large. Max 3MB.");
Â  Â  }
Â  Â  if(file.type.includes("image") && file.size > LIMIT_IMG) {
Â  Â  Â  Â  btn.innerText = originalText;
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  return alert("âŒ Image too large. Max 10MB.");
Â  Â  }

Â  Â  // 3. Read & Upload
Â  Â  const reader = new FileReader();
Â  Â Â 
Â  Â  reader.onload = async function(e) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await processUpload(e.target.result, file.type, file.name);
Â  Â  Â  Â  Â  Â  alert("âœ… File Uploaded Successfully!");
Â  Â  Â  Â  Â  Â  fileInput.value = ""; // Clear input
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  alert("âŒ Database Error: " + err.message);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  btn.innerText = originalText;
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  }
Â  Â  };

Â  Â  reader.onerror = function() {
Â  Â  Â  Â  alert("âŒ Error reading file.");
Â  Â  Â  Â  btn.innerText = originalText;
Â  Â  Â  Â  btn.disabled = false;
Â  Â  };

Â  Â  reader.readAsDataURL(file);
};

// C. DATABASE SAVER
async function processUpload(dataBase64, fileType, fileName) {
Â  Â  const line = document.getElementById("galleryLineSelect").value;
Â  Â  const stn = document.getElementById("galleryStationSelect").value;
Â  Â Â 
Â  Â  // Double check to prevent "undefined" entries
Â  Â  if(!line || !stn) throw new Error("Target station missing.");

Â  Â  const targetName = `${stn} (${line})`;

Â  Â  const uploadData = {
Â  Â  Â  Â  stationName: targetName,
Â  Â  Â  Â  fileData: dataBase64,
Â  Â  Â  Â  fileType: fileType,
Â  Â  Â  Â  name: fileName,
Â  Â  Â  Â  userName: currentUser.name || currentUser.email,
Â  Â  Â  Â  uploadedAt: serverTimestamp() // Ensure serverTimestamp is imported!
Â  Â  };

Â  Â  // This checks if DB connection is active
Â  Â  await push(ref(db, "history"), uploadData);
}
onAuthStateChanged(auth, (user) => {
Â  Â  if (!user) {Â 
Â  Â  Â  Â  // Use a safe check here too
Â  Â  Â  Â  const loginSec = document.getElementById("loginSection");
Â  Â  Â  Â  if (loginSec) loginSec.classList.remove("hidden");
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  currentUser = user;
Â  Â  startPresenceSystem(user);Â Â 

Â  Â  const userRef = ref(db, `users/${user.uid}`);
Â  Â Â 
Â  Â  onValue(userRef, (snap) => {
Â  Â  Â  Â  const u = snap.val();

Â  Â  Â  Â  // --- THE FIX: Create a helper to prevent "null" crashes ---
Â  Â  Â  Â  const updateClass = (id, action, className) => {
Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  Â  Â  el.classList[action](className);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`SafeUI: Element #${id} not found. Skipping.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // 1. New User Detection
Â  Â  Â  Â  if (!u || !u.name) {
Â  Â  Â  Â  Â  Â  updateClass("loginSection", "add", "hidden");
Â  Â  Â  Â  Â  Â  updateClass("appScreen", "add", "hidden");
Â  Â  Â  Â  Â  Â  updateClass("nameModal", "remove", "hidden");
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Security Checks
Â  Â  Â  Â  if (u.terminated) {Â 
Â  Â  Â  Â  Â  Â  alert("ACCOUNT TERMINATED.");Â 
Â  Â  Â  Â  Â  Â  signOut(auth);Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  if (u.banned) {
Â  Â  Â  Â  Â  Â  updateClass("header", "add", "hidden");
Â  Â  Â  Â  Â  Â  updateClass("appScreen", "add", "hidden");
Â  Â  Â  Â  Â  Â  updateClass("faceModal", "add", "hidden");
Â  Â  Â  Â  Â  Â  updateClass("bannedScreen", "remove", "hidden");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const reasonDisplay = document.getElementById("displayBanReason");
Â  Â  Â  Â  Â  Â  if (reasonDisplay) reasonDisplay.innerText = u.banReason || "Security Protocol Violation";
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. Silent Data Sync
Â  Â  Â  Â  currentUser.name = u.name;
Â  Â  Â  Â  isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userInfoDisplay = document.getElementById("userInfo");
Â  Â  Â  Â  if (userInfoDisplay) userInfoDisplay.innerText = `${u.name}`;

Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  updateClass("adminBadge", "remove", "hidden");
Â  Â  Â  Â  Â  Â  updateClass("btnAdmin", "remove", "hidden");
Â  Â  Â  Â  }

Â  Â  Â  Â  // CRITICAL: No Face Modal logic here.Â 
Â  Â  Â  Â  // It must only be triggered by the login() button success.
Â  Â  Â  Â Â 
Â  Â  }, (error) => {
Â  Â  Â  Â  console.error("Database sync failed:", error);
Â  Â  Â  Â  signOut(auth);
Â  Â  });
});
Â  Â // ==========================================
// 3. USER SESSION MANAGER
// ==========================================
// This function handles what happens when a user logs in or out.
const manageUserSession = (user) => {
Â  Â Â 
Â  Â  // A. NO USER -> SHOW LOGIN SCREEN
Â  Â  if (!user) {Â 
Â  Â  Â  Â  showLoginScreen();Â 
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  currentUser = user;
Â  Â Â 
Â  Â  // Start Presence
Â  Â  startPresenceSystem(user);Â Â 

Â  Â  // B. USER FOUND -> LOAD DATA
Â  Â  const userRef = ref(db, `users/${user.uid}`);
Â  Â Â 
Â  Â  onValue(userRef, (snap) => {
Â  Â  Â  Â  const u = snap.val();

Â  Â  Â  Â  // 1. DATA MISSING?
Â  Â  Â  Â  if (!u) {
Â  Â  Â  Â  Â  Â  alert("Account data not found. Contact admin.");
Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. TERMINATED?
Â  Â  Â  Â  if (u.terminated) {Â 
Â  Â  Â  Â  Â  Â  alert("ACCOUNT TERMINATED.");Â 
Â  Â  Â  Â  Â  Â  signOut(auth);Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. BANNED? -> SHOW RED SCREEN WITH DETAILS
Â  Â  Â  Â  if (u.banned) {
Â  Â  Â  Â  Â  Â  // Hide App Interface
Â  Â  Â  Â  Â  Â  document.querySelector("header").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Show Ban Overlay
Â  Â  Â  Â  Â  Â  const banScreen = document.getElementById("bannedScreen");
Â  Â  Â  Â  Â  Â  if(banScreen) {
Â  Â  Â  Â  Â  Â  Â  Â  banScreen.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // POPULATE DETAILS
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("displayBanReason").innerText = u.banReason || "Security Violation";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("displayBanAction").innerText = u.banAction || "Contact System Administrator Immediately.";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("displayBanRemarks").innerText = u.banRemarks || "No additional notes.";

Â  Â  Â  Â  Â  Â  Â  Â  // Populate Time
Â  Â  Â  Â  Â  Â  Â  Â  const deadline = u.banExpires || 0;
Â  Â  Â  Â  Â  Â  Â  Â  if(deadline > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateStr = new Date(deadline).toLocaleString('en-IN', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day: '2-digit', month: 'short', year: 'numeric',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit', hour12: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("bannedTimeDisplay").innerText = "Expiring: " + dateStr;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("bannedTimeDisplay").innerText = "â›” PERMANENT SUSPENSION";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.body.innerHTML = "<h1 style='color:red; text-align:center;'>â›” ACCOUNT SUSPENDED</h1><br><button onclick='logout()'>Log Out</button>";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return; // STOP HERE
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. ACTIVE USER -> SHOW APP
Â  Â  Â  Â  document.getElementById("bannedScreen")?.classList.add("hidden");
Â  Â  Â  Â  document.querySelector("header").style.display = "flex";
Â  Â  Â  Â Â 
Â  Â  Â  Â  currentUser.name = u.name;
Â  Â  Â  Â  isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());

Â  Â  Â  Â  // Name Setup Check
Â  Â  Â  Â  if (!u.name) {
Â  Â  Â  Â  Â  Â  document.getElementById("nameModal").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update Header Info
Â  Â  Â  Â  document.getElementById("userInfo").innerText = `${u.name}`;
Â  Â  Â  Â  document.getElementById("authContainer").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");

Â  Â  Â  Â  // Load Admin Tools
Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  const badge = document.getElementById("adminBadge");
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnAdmin");
Â  Â  Â  Â  Â  Â  if(badge) badge.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  if(btn) btn.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  setTimeout(loadAdminPanel, 2000);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Biometric Check
Â  Â  Â  Â  if(!isTransactionAuth) {
Â  Â  Â  Â  Â  Â  const faceModal = document.getElementById("faceModal");
Â  Â  Â  Â  Â  Â  faceModal.classList.remove("hidden");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(!u.faceData) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "âš ï¸ Face ID Setup";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("regProgress").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btnCapture").onclick = registerNewFace;
Â  Â  Â  Â  Â  Â  Â  Â  initCamera(false);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "Biometric Verification";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("regProgress").classList.add("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btnCapture").onclick = handleFaceScan;
Â  Â  Â  Â  Â  Â  Â  Â  initCamera(true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }, (error) => {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  alert("Connection Error. Logging out...");
Â  Â  Â  Â  signOut(auth);
Â  Â  });
};

// CRITICAL: ACTIVATE THE LISTENER
onAuthStateChanged(auth, manageUserSession);
// Helper to reliably show login
function showLoginScreen() {
Â  Â  document.querySelector("header").style.display = "flex";
Â  Â  document.getElementById("loginSection").classList.remove("hidden");
Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  document.getElementById("authContainer").classList.add("hidden");
Â  Â  document.getElementById("bannedScreen")?.classList.add("hidden");
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  stopCamera();
Â  Â Â 
Â  Â  // Reset Button State
Â  Â  const btn = document.querySelector("#loginSection button");
Â  Â  if(btn) {
Â  Â  Â  Â  btn.innerText = "SECURE LOGIN";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }
}

// --- HELPER: TOGGLE 'OTHER' INPUT FOR ADD STOCK ---
window.toggleAddOtherInput = () => {
Â  Â  const val = document.getElementById("addLocSelect").value;
Â  Â  const otherDiv = document.getElementById("divAddOtherLoc");
Â  Â Â 
Â  Â  if(val === "Other") {
Â  Â  Â  Â  otherDiv.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("addLocOther").focus();
Â  Â  } else {
Â  Â  Â  Â  otherDiv.classList.add("hidden");
Â  Â  }
};
// --- TOGGLE 'OTHER' INPUT ---
window.toggleBanOtherInput = () => {
Â  Â  const val = document.getElementById("banReasonInput").value;
Â  Â  const div = document.getElementById("divBanOther");
Â  Â  if(val === "Other") {
Â  Â  Â  Â  div.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("banReasonOther").focus();
Â  Â  } else {
Â  Â  Â  Â  div.classList.add("hidden");
Â  Â  }
};

// --- HANDLE CUSTOM DATE SELECTION ---
window.selectBanCustomDate = (input) => {
Â  Â  if(input.value) {
Â  Â  Â  Â  // Deselect all buttons if date is picked
Â  Â  Â  Â  currentBanDays = 'CUSTOM';
Â  Â  Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
Â  Â  Â  Â  input.style.border = "2px solid #dc3545";
Â  Â  }
};

// --- UPDATED BUTTON SELECTION ---
window.selectBanDuration = (days, btn) => {
Â  Â  currentBanDays = days;
Â  Â  // Clear Date Input
Â  Â  document.getElementById("banCustomDate").value = "";
Â  Â  document.getElementById("banCustomDate").style.border = "1px solid #ccc";
Â  Â Â 
Â  Â  // Highlight Button
Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
Â  Â  btn.classList.add("selected");
};
// ==========================================
// 4. ROBUST PRESENCE SYSTEM (Fixed)
// ==========================================
let presenceInterval = null;Â 

function startPresenceSystem(user) {
Â  Â  if (!user || !user.uid) return;

Â  Â  // Sanity Check: Ensure UID is safe (no dots/special chars allowed in keys)
Â  Â  if (user.uid.includes(".") || user.uid.includes("#") || user.uid.includes("$")) {
Â  Â  Â  Â  console.error("CRITICAL: Invalid UID detected. Presence system aborted.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const userStatusRef = ref(db, `status/${user.uid}`);
Â  Â  const connectedRef = ref(db, ".info/connected");

Â  Â  onValue(connectedRef, (snap) => {
Â  Â  Â  Â  if (snap.val() === true) {
Â  Â  Â  Â  Â  Â  // FIX: Ensure Name is a valid string, never undefined
Â  Â  Â  Â  Â  Â  const safeName = (user.name && typeof user.name === 'string') ? user.name : (user.email || "Unknown User");

Â  Â  Â  Â  Â  Â  // 1. Set Disconnect Hook
Â  Â  Â  Â  Â  Â  onDisconnect(userStatusRef).set({
Â  Â  Â  Â  Â  Â  Â  Â  state: 'offline',
Â  Â  Â  Â  Â  Â  Â  Â  last_seen: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  name: safeName
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 2. Mark as Online
Â  Â  Â  Â  Â  Â  update(userStatusRef, {
Â  Â  Â  Â  Â  Â  Â  Â  state: 'online',
Â  Â  Â  Â  Â  Â  Â  Â  last_seen: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  name: safeName
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // Heartbeat Pulse
Â  Â  if (presenceInterval) clearInterval(presenceInterval);
Â  Â  presenceInterval = setInterval(() => {
Â  Â  Â  Â  if (auth.currentUser) {
Â  Â  Â  Â  Â  Â  update(userStatusRef, {
Â  Â  Â  Â  Â  Â  Â  Â  last_seen: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  state: 'online'
Â  Â  Â  Â  Â  Â  }).catch(() => {}); // Suppress minor network errors
Â  Â  Â  Â  }
Â  Â  }, 5000);
}
function updateRegDots(count) {
Â  Â  document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
Â  Â  document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
Â  Â  document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}
Â  // ==========================================
// 6. STRICT SESSION TIMEOUT (Auto-Offline)
// ==========================================

function setupIdleTimer() {
Â  Â  // Detect any activity to keep session alive
Â  Â  window.onmousemove = resetTimer;
Â  Â  window.onmousedown = resetTimer;
Â  Â  window.onclick = resetTimer;
Â  Â  window.onkeypress = resetTimer;
Â  Â  window.ontouchstart = resetTimer;Â 
Â  Â  window.addEventListener('scroll', resetTimer, true);Â 
Â  Â Â 
Â  Â  resetTimer(); // Start the countdown
}
window.printReport = (mode) => {
Â  Â  // 1. Clean previous classes
Â  Â  document.body.classList.remove('print-a4', 'print-pos');

Â  Â  // 2. Add class based on selection
Â  Â  if (mode === 'A4') {
Â  Â  Â  Â  document.body.classList.add('print-a4');
Â  Â  Â  Â  document.title = "Metro_Inspection_A4_" + new Date().getTime();Â 
Â  Â  } else {
Â  Â  Â  Â  document.body.classList.add('print-pos');
Â  Â  Â  Â  document.title = "Metro_Receipt_58mm_" + new Date().getTime();
Â  Â  }

Â  Â  // 3. Trigger Print
Â  Â  // In most modern browsers, setting the 'Save as PDF' destinationÂ 
Â  Â  // will now use the filename we set above.
Â  Â  setTimeout(() => {
Â  Â  Â  Â  window.print();
Â  Â  }, 100);
};
function resetTimer() {
Â  Â  clearTimeout(idleTimer);
Â  Â Â 
Â  Â  // Only run if a user is actually logged in
Â  Â  if(currentUser) {
Â  Â  Â  Â  // Set Timeout for 10 Minutes (or your preferred time)
Â  Â  Â  Â  idleTimer = setTimeout(async () => {
Â  Â  Â  Â  Â  Â  console.log("Session Timed Out. Marking Offline...");

Â  Â  Â  Â  Â  Â  // 1. FORCE DATABASE STATUS TO OFFLINE
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await update(ref(db, `status/${currentUser.uid}`), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state: 'offline',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last_changed: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: currentUser.email
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Status Update Failed", e);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. LOG THE EVENT
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await push(ref(db, "logs"), {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user: currentUser.email,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: "LOGOUT",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: "Auto-Timeout (Inactivity)",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time: serverTimestamp()Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } catch(e) {}

Â  Â  Â  Â  Â  Â  // 3. KILL THE SESSION
Â  Â  Â  Â  Â  Â  await signOut(auth);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 4. NOTIFY USER
Â  Â  Â  Â  Â  Â  alert("Session Expired due to inactivity. You have been marked Offline.");
Â  Â  Â  Â  Â  Â  window.location.reload(); // Force refresh to clear old state

Â  Â  Â  Â  }, 10 * 60 * 1000); // 10 Minutes (Adjust as needed)
Â  Â  }
}
window.saveOfficialName = async () => {
Â  Â  const nameInput = document.getElementById("officialNameInput");
Â  Â  // Remove special chars from name to be safe
Â  Â  const name = nameInput.value.replace(/[.#$\[\]]/g, "").trim();Â 

Â  Â  if(name.length < 3) return alert("Please enter a valid name (3+ chars).");

Â  Â  const btn = nameInput.nextElementSibling;
Â  Â  btn.innerText = "Creating Profile...";
Â  Â  btn.disabled = true;

Â  Â  try {
Â  Â  Â  Â  await set(ref(db, `users/${currentUser.uid}`), {
Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  email: currentUser.email,
Â  Â  Â  Â  Â  Â  banned: false,
Â  Â  Â  Â  Â  Â  faceData: null,
Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  last_login: serverTimestamp()
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById("nameModal").classList.add("hidden");
Â  Â  } catch(e) {
Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  btn.innerText = "Save & Continue";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }
}
function showLogin() {
Â  Â  document.getElementById("loginSection").classList.remove("hidden");
Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  document.getElementById("authContainer").classList.add("hidden");
Â  Â  document.getElementById("nameModal").classList.add("hidden");
Â  Â  stopCamera();
}
window.logout = async () => {
Â  Â  if(!currentUser) return;
Â  Â Â 
Â  Â  const btn = document.activeElement;Â 
Â  Â  if(btn) btn.innerText = "ğŸ”Œ Terminating...";

Â  Â  try {
Â  Â  Â  Â  // 1. STOP CAMERA IMMEDIATELY
Â  Â  Â  Â  stopCamera();

Â  Â  Â  Â  // 2. FORCE UI RESET (Hide everything)
Â  Â  Â  Â  document.getElementById("faceModal").classList.add("hidden");Â 
Â  Â  Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("authContainer").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("loginSection").classList.remove("hidden");

Â  Â  Â  Â  // 3. UPDATE DATABASE STATUS
Â  Â  Â  Â  await update(ref(db, `status/${currentUser.uid}`), {
Â  Â  Â  Â  Â  Â  state: 'offline',
Â  Â  Â  Â  Â  Â  last_changed: serverTimestamp()
Â  Â  Â  Â  });

Â  Â  Â  Â  // 4. SIGN OUT AND RELOAD
Â  Â  Â  Â  await signOut(auth);
Â  Â  Â  Â  window.location.reload();Â 

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Logout Error", e);
Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  window.location.reload();
Â  Â  }
};
async function recordLogin(method) {
Â  Â  if(currentUser) {
Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
Â  Â  Â  Â  await push(ref(db, "logs"), logData);
Â  Â  }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
Â  Â  const vid = document.getElementById("cameraFeed");
Â  Â  const canvas = document.getElementById("overlayCanvas");
Â  Â 
Â  Â  try {
Â  Â  Â  Â  if(!modelsLoaded) {
Â  Â  Â  Â  Â  Â  updateStatus("Loading AI Models...", "yellow");
Â  Â  Â  Â  Â  Â  await preloadModels();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Remove specific width/height constraints to let the camera decide
stream = await navigator.mediaDevices.getUserMedia({ video: true });
Â  Â  Â  Â  vid.srcObject = stream;
Â  Â  Â  Â  vid.onloadedmetadata = () => {
Â  Â  Â  Â  Â  Â  vid.play();
Â  Â  Â  Â  Â  Â  startRealTimeDetection(vid, canvas);
Â  Â  Â  Â  };

Â  Â  Â  Â  if(isVerify) updateStatus("LOOK AT CAMERA", "white");
Â  Â  Â  Â  else updateStatus("REGISTRATION: CENTER FACE", "cyan");

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  updateStatus("Camera Hardware Error", "red");
Â  Â  }
}
// --- 1. DEFINE METRO DATA ---
const METRO_STATIONS = {
Â  Â  "Blue Line": [
Â  Â  Â  Â  "Dakshineswar", "Baranagar", "Noapara", "Dum Dum", "Belgachia",Â 
Â  Â  Â  Â  "Shyambazar", "Shobhabazar Sutanuti", "Girish Park", "Mahatma Gandhi Road",Â 
Â  Â  Â  Â  "Central", "Chandni Chowk", "Esplanade", "Park Street", "Maidan",Â 
Â  Â  Â  Â  "Rabindra Sadan", "Netaji Bhavan", "Jatin Das Park", "Kalighat",Â 
Â  Â  Â  Â  "Rabindra Sarobar", "Mahanayak Uttam Kumar", "Netaji",Â 
Â  Â  Â  Â  "Masterda Surya Sen", "Gitanjali", "Kavi Nazrul", "Shahid Khudiram",Â 
Â  Â  Â  Â  "Kavi Subhash (New Garia)"
Â  Â  ],
Â  Â  "Green Line": [
Â  Â  Â  Â  "Salt Lake Sector V", "Karunamoyee", "Central Park", "City Centre",Â 
Â  Â  Â  Â  "Bengal Chemical", "Salt Lake Stadium", "Phoolbagan", "Sealdah",Â 
Â  Â  Â  Â  "Esplanade", "Mahakaran", "Howrah", "Howrah Maidan"
Â  Â  ],
Â  Â  "Purple Line": [
Â  Â  Â  Â  "Joka", "Thakurpukur", "Sakher Bazar", "Behala Chowrasta",Â 
Â  Â  Â  Â  "Behala Bazar", "Taratala", "Majerhat"
Â  Â  ],
Â  Â  "Yellow Line": [
Â  Â  Â  Â  "Noapara", "Dum Dum Cantonment", "Jessore Road", "Jai Hind (Airport)"
Â  Â  ],
Â  Â  "Orange Line": [
Â  Â  Â  Â  "Kavi Subhash (New Garia)", "Satyajit Ray", "Jyotirindra Nandi",Â 
Â  Â  Â  Â  "Kavi Sukanta", "Hemanta Mukhopadhyay"
Â  Â  ],
Â  Â  "Pink Line": [
Â  Â  Â  Â  "Baranagar", "Barrackpore" // Endpoints added as placeholders
Â  Â  ]
};

// --- 2. HANDLE LINE CHANGE ---
window.handleLineChange = () => {
Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  const formDiv = document.getElementById("mainDataForm");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  formDiv.classList.add("hidden");
Â  Â  document.getElementById("inpStationName").value = ""; // Clear hidden input

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  // Populate Stations
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};
window.handleStationChange = async () => {
Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  const formDiv = document.getElementById("mainDataForm");
Â  Â  const submitBtn = document.getElementById("btnFinalSubmit");

Â  Â  // ğŸ›‘ STEP 1: NUCLEAR WIPE (Force the system to forget Station A)
Â  Â  await nuclearReset();Â 
Â  Â Â 
Â  Â  // ğŸ›‘ STEP 2: MANUALLY CLEAR KEYS (Double Protection)
Â  Â  currentStationKey = null;Â 
Â  Â  currentRakeKey = null;

Â  Â  if (!stnSel.value) {
Â  Â  Â  Â  formDiv.classList.add("hidden");
Â  Â  Â  Â  isSwitching = false;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // === STEP 3: SETUP NEW STATION ===
Â  Â  formDiv.classList.remove("hidden"); // This shows the form inputs
Â  Â  const fullStationName = `${stnSel.value} (${lineSel.value})`;
Â  Â Â 
Â  Â  document.getElementById("inpStationName").value = fullStationName;
Â  Â  document.getElementById("formTitle").innerText = `ğŸ“ Entry: ${stnSel.value}`;

Â  Â  // === STEP 4: CHECK IF DATA ALREADY EXISTS ===
Â  Â  // We check the database: "Do we have data for THIS specific station?"
Â  Â  const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(fullStationName));
Â  Â  const snap = await get(q);

Â  Â  if (snap.exists()) {
Â  Â  Â  Â  // --- OLD DATA FOUND (Edit Mode) ---
Â  Â  Â  Â  let data = null;
Â  Â  Â  Â  snap.forEach(c => { data = c.val(); currentStationKey = c.key; }); // Load the EXISTING ID
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Fill inputs
Â  Â  Â  Â  document.getElementById("inpStationLength").value = data.len || "";
Â  Â  Â  Â  document.getElementById("inpYellowDist").value = data.yl || "";
Â  Â  Â  Â  document.getElementById("inpYellowThick").value = data.th || "";
Â  Â  Â  Â  document.getElementById("inpRemarks").value = data.remarks || "";
Â  Â  Â  Â  document.getElementById("inpImplementation").value = data.impl || "";

Â  Â  Â  Â  // Button becomes orange
Â  Â  Â  Â  document.getElementById("dataExistsWarning").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("dataExistsWarning").innerHTML = "âš ï¸ <strong>EDIT MODE:</strong> Modifying Existing Master Record.";
Â  Â  Â  Â  submitBtn.innerText = "ğŸ’¾ Update Master Record";
Â  Â  Â  Â  submitBtn.style.background = "#d97706";Â 

Â  Â  Â  Â  // Load rows
Â  Â  Â  Â  currentRakeKey = data.linkedRakeKey || currentStationKey;
Â  Â  Â  Â  const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
Â  Â  Â  Â  if(rakeSnap.exists()) {
Â  Â  Â  Â  Â  Â  await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
Â  Â  Â  Â  }

Â  Â  } else {
Â  Â  Â  Â  // --- NO DATA FOUND (New Mode) ---
Â  Â  Â  Â  // currentStationKey MUST BE NULL here.
Â  Â  Â  Â  submitBtn.innerText = "âœ” Submit New Log";
Â  Â  Â  Â  submitBtn.style.background = "#0A2342";Â 
Â  Â  }

Â  Â  // === STEP 5: START LISTENER ===
Â  Â  loadDraft();Â 
Â  Â Â 
Â  Â  // Unlock the safety
Â  Â  setTimeout(() => {
Â  Â  Â  Â  isSwitching = false;
Â  Â  }, 300);
};
// --- 1. HANDLE TAB & DROPDOWNS ---

// Reuse Station Data Logic for Print Tab
window.handlePrintLineChange = () => {
Â  Â  const lineSel = document.getElementById("printLineSelect");
Â  Â  const stnSel = document.getElementById("printStationSelect");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  document.getElementById("printLogList").classList.add("hidden");

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  }
};
window.deleteStationLog = async (key) => {
Â  Â  if(!confirm("âš ï¸ PERMANENTLY DELETE this record?\n\nThis cannot be undone.")) return;

Â  Â  const btn = document.activeElement; // The delete button you clicked
Â  Â  if(btn) btn.innerText = "â³";

Â  Â  try {
Â  Â  Â  Â  // 1. GET DATA TO FIND LINKS
Â  Â  Â  Â  const snap = await get(ref(db, `station_logs/${key}`));
Â  Â  Â  Â  let rakeKey = key;Â 
Â  Â  Â  Â  if(snap.exists()) {
Â  Â  Â  Â  Â  Â  Â rakeKey = snap.val().linkedRakeKey || key;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. DELETE BOTH (Atomic removal)
Â  Â  Â  Â  await remove(ref(db, `station_logs/${key}`));
Â  Â  Â  Â  await remove(ref(db, `rake_logs/${rakeKey}`));

Â  Â  Â  Â  // 3. REFRESH THE VIEW INSTANTLY
Â  Â  Â  Â  // This proves to you immediately that the specific row is gone
Â  Â  Â  Â  await loadSpecificStationData();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert("âœ… Record Removed.");

Â  Â  } catch(e) {
Â  Â  Â  Â  alert("âŒ Error deleting: " + e.message);
Â  Â  Â  Â  if(btn) btn.innerText = "ğŸ—‘";
Â  Â  }
};
// --- 2. FETCH LOGS FOR STATION ---
// UPDATED: Fetch Logs for Print
window.fetchLogsForPrint = async () => {
Â  Â  const line = document.getElementById("printLineSelect").value;
Â  Â  const stn = document.getElementById("printStationSelect").value;
Â  Â  const tbody = document.getElementById("printLogBody");
Â  Â  const listDiv = document.getElementById("printLogList");

Â  Â  // 1. WIPE UI (The Fix)
Â  Â  tbody.innerHTML = "";
Â  Â  if(!line || !stn) {
Â  Â  Â  Â  listDiv.classList.add("hidden");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  listDiv.classList.remove("hidden");
Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>ğŸ” Searching Records...</td></tr>";

Â  Â  // 2. FETCH NEW
Â  Â  const searchName = `${stn} (${line})`;
Â  Â  const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const snap = await get(q);
Â  Â  Â  Â  tbody.innerHTML = ""; // Clear Loading Message

Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>No records found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const d = c.val();
Â  Â  Â  Â  Â  Â  const btn = `<button class="info" onclick="openPrintSetup('${c.key}')">ğŸ–¨ï¸ Select</button>`;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${d.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.userName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${btn}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Connection Error</td></tr>";
Â  Â  }
};
// --- 3. OPEN CONFIG MODAL ---
let currentPrintKey = null;

// --- UPDATED OPEN CONFIG MODAL ---
window.openPrintSetup = (key) => {
Â  Â  currentPrintKey = key;
Â  Â Â 
Â  Â  // 1. Fetch Date for display
Â  Â  get(ref(db, `station_logs/${key}/date`)).then(snap => {
Â  Â  Â  Â  document.getElementById("modalPrintDate").innerText = snap.val();
Â  Â  });

Â  Â  // 2. Populate the "Test Conducting Member" dropdown dynamically
Â  Â  populateUserDropdown();

Â  Â  // 3. Show Modal
Â  Â  document.getElementById("printOptionsModal").classList.remove("hidden");
};

window.closePrintModal = () => {
Â  Â  document.getElementById("printOptionsModal").classList.add("hidden");
Â  Â  currentPrintKey = null;
};
window.generateFinalReport = async () => {
Â  Â  if (!currentPrintKey) return alert("Error: No record selected.");

Â  Â  const includeRakes = document.getElementById("chkRakeData").checked;
Â  Â  let conductingOfficerName = document.getElementById("selPrintInspector").value;
Â  Â  let authName = document.getElementById("selPrintAuthority").value;

Â  Â  if (conductingOfficerName === "Self" || conductingOfficerName === "" || conductingOfficerName === "Self (Current User)") {
Â  Â  Â  Â  conductingOfficerName = currentUser.name || currentUser.email;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const sSnap = await get(ref(db, `station_logs/${currentPrintKey}`));
Â  Â  Â  Â  if (!sSnap.exists()) return alert("Station record not found.");
Â  Â  Â  Â  const sData = sSnap.val();

Â  Â  Â  Â  const siteName = (sData.name || "").split("(")[0].trim().toUpperCase();
Â  Â  Â  Â  const corridor = (sData.name || "").match(/\(([^)]+)\)/)?.[1] || "Blue Line";
Â  Â  Â  Â  const logDate = sData.date || "";
Â  Â  Â  Â  const printTime = new Date().toLocaleString("en-IN", {Â 
Â  Â  Â  Â  Â  Â  day: "2-digit", month: "short", year: "numeric",Â 
Â  Â  Â  Â  Â  Â  hour: "2-digit", minute: "2-digit", hour12: trueÂ 
Â  Â  Â  Â  });

Â  Â  Â  Â  let rakeTableHtml = "";
Â  Â  Â  Â  if (includeRakes) {
Â  Â  Â  Â  Â  Â  const rakeKey = sData.linkedRakeKey || currentPrintKey;
Â  Â  Â  Â  Â  Â  const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
Â  Â  Â  Â  Â  Â  if (rSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  rakeTableHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="black-header-bar">RAKE CLEARANCE TABLE</div>
Â  Â  Â  Â  Â  Â  Â  Â  <table class="report-table-max">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:left; border-right:4pt solid #000;">RAKE ID TYPE</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center; border-right:4pt solid #000;">FRONT</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center;">REAR</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>`;
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(rSnap.val()).forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rakeTableHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="border-right:4pt solid #000;">${r.rake || ""} ${r.type || ""}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; border-right:4pt solid #000;">${r.f || ""}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${r.r || ""}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  rakeTableHtml += `</tbody></table>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const styleSheet = `
Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  Â  Â  @page { size: A4; margin: 5mm; }
Â  Â  Â  Â  Â  Â  Â  Â  body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0; }
Â  Â  Â  Â  Â  Â  Â  Â  .no-print { display: none !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .report-wrapper { width: 100% !important; padding: 5mm !important; margin: 0 !important; border: none !important; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .report-wrapper {Â 
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%; min-height: 297mm; margin: 0 auto; padding: 10mm;Â 
Â  Â  Â  Â  Â  Â  Â  Â  background: white; font-family: "Times New Roman", Times, serif; color: #000;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .black-header-bar {Â 
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #000 !important; color: #fff !important;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 18pt !important; font-size: 38pt !important; font-weight: 900 !important;Â 
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center !important; text-transform: uppercase !important;
Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 40pt !important; -webkit-print-color-adjust: exact !important;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100% !important; box-sizing: border-box;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .header-main { font-size: 72pt; font-weight: 900; text-align: center; line-height: 1; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  .header-sub { font-size: 28pt; font-weight: 900; text-align: center; margin-top: 20pt; text-transform: uppercase; line-height: 1.2; }
Â  Â  Â  Â  Â  Â  .field-row { font-size: 42pt; border-bottom: 8pt solid #000; padding: 15pt 0; margin-bottom: 15pt; width: 100%; box-sizing: border-box; }
Â  Â  Â  Â  Â  Â  .measurement-text { font-size: 38pt; font-weight: 900; line-height: 1.8; padding: 25pt 0; border-bottom: 6pt solid #000; width: 100%; box-sizing: border-box; }
Â  Â  Â  Â  Â  Â  .report-table-max { width: 100%; border-collapse: collapse; margin-top: 15pt; font-size: 32pt; border: 8pt solid #000; font-weight: 900; table-layout: fixed; }
Â  Â  Â  Â  Â  Â  .report-table-max th, .report-table-max td { padding: 20pt; border-bottom: 6pt solid #000; overflow-wrap: break-word; }
Â  Â  Â  Â  </style>`;

Â  Â  Â  Â  reportContainer.innerHTML = styleSheet + `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:25px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 50px; font-weight:bold; font-size:24px; cursor:pointer; border-radius:8px;">PRINT OFFICIAL RECORD</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="report-wrapper">
Â  Â  Â  Â  Â  Â  <div style="border-bottom: 16pt solid #000; padding-bottom: 35pt; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-main">METRO RAILWAY</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-main" style="font-size: 56pt;">PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-sub">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><br>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; font-weight: 900; text-decoration: underline; margin-top: 35pt;">OFFICIAL INSPECTION RECORD</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 55pt;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="field-row"><b>SITE:</b> ${siteName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="field-row"><b>CORRIDOR:</b> ${corridor}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="field-row"><b>CONDUCTING OFFICER:</b> ${conductingOfficerName.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="field-row"><b>LOGGED ON (DB):</b> ${logDate}</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="black-header-bar">MEASUREMENTS</div>
Â  Â  Â  Â  Â  Â  <div class="measurement-text">
Â  Â  Â  Â  Â  Â  Â  Â  PLATFORM LENGTH: ${sData.len || "172.8"} m<br>
Â  Â  Â  Â  Â  Â  Â  Â  YELLOW LINE DISTANCE: ${sData.yl || "70"} cm<br>
Â  Â  Â  Â  Â  Â  Â  Â  LINE THICKNESS: ${sData.th || "10"} cm<br>
Â  Â  Â  Â  Â  Â  Â  Â  COMPLIANCE STATUS: ${sData.impl === "YES" ? "YES / COMPLIANT" : "NO / NON-COMPLIANT"}
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="black-header-bar">INSPECTOR REMARKS</div>
Â  Â  Â  Â  Â  Â  <div style="font-size: 36pt; font-weight: 900; line-height: 1.6; padding: 30pt 0; border-bottom: 8pt solid #000; text-align: justify;">
Â  Â  Â  Â  Â  Â  Â  Â  ${(sData.remarks || "STATION IS STRAIGHT. NO UNKNOWN CURVE FOUND.").toUpperCase()}
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  ${rakeTableHtml}

Â  Â  Â  Â  Â  Â  <div style="margin-top: 150pt; display: flex; justify-content: space-between; font-size: 28pt; font-weight: 900;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; width: 48%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="border-top: 8pt solid #000; padding-top: 15pt;">${conductingOfficerName.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 22pt;">CONDUCTING OFFICER</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; width: 48%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="border-top: 8pt solid #000; padding-top: 15pt;">${authName.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 22pt;">APPROVING AUTHORITY</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-top: 100pt; font-size: 22pt; font-weight: 900; border-top: 5pt dashed #000; padding-top: 30pt;">
Â  Â  Â  Â  Â  Â  Â  Â  SYSTEM GENERATED RECORD | PRINTED ON: ${printTime.toUpperCase()}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  closePrintModal();
Â  Â  Â  Â  reportContainer.classList.remove("hidden");
Â  Â  Â  Â  window.scrollTo(0, 0);

Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  alert("Print Error: " + err.message);
Â  Â  }
};
window.closeReportPreview = () => {
Â  Â  document.getElementById("printableReportContainer").classList.add("hidden");
};
async function startRealTimeDetection(video, canvas) {
Â  Â  const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
Â  Â  faceapi.matchDimensions(canvas, displaySize);
Â  Â  if (detectionLoop) clearInterval(detectionLoop);
Â  Â  detectionLoop = setInterval(async () => {
Â  Â  Â  Â  if (!stream) return;
Â  Â  Â  Â  const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
Â  Â  Â  Â  const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  if (detection) {
Â  Â  Â  Â  Â  Â  const resizedDetections = faceapi.resizeResults(detection, displaySize);
Â  Â  Â  Â  Â  Â  const box = resizedDetections.detection.box;
Â  Â  Â  Â  Â  Â  const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
Â  Â  Â  Â  Â  Â  drawBox.draw(canvas);
Â  Â  Â  Â  Â  Â  currentDescriptor = detection.descriptor;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  Â  Â  Â  Â  if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  currentDescriptor = null;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  Â  Â  Â  Â  if(btn) btn.style.border = "1px solid #004494";
Â  Â  Â  Â  }
Â  Â  }, 100);
}

function stopCamera() {
Â  Â  if(detectionLoop) clearInterval(detectionLoop);
Â  Â  if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
Â  Â  const vid = document.getElementById("cameraFeed");
Â  Â  const canvas = document.getElementById("overlayCanvas");
Â  Â  if(vid) vid.srcObject = null;
Â  Â  if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  isTransactionAuth = false;
Â  Â  currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }
window.handleFaceScan = async () => {
Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  if(!currentDescriptor) { updateStatus("âŒ No Face Detected.", "red"); return; }
Â  Â Â 
Â  Â  btn.disabled = true;
Â  Â  btn.innerText = "Processing...";
Â  Â  updateStatus("Analyzing Biometrics...", "cyan");

Â  Â  try {
Â  Â  Â  Â  // --- MODE 1: RECEIVER VERIFICATION ---
Â  Â  Â  Â  if(scanMode === 'RECEIVER') {
Â  Â  Â  Â  Â  Â  const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
Â  Â  Â  Â  Â  Â  const storedData = snap.val();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let match = false;
Â  Â  Â  Â  Â  Â  // Check match against logged-in user
Â  Â  Â  Â  Â  Â  if(storedData) {
Â  Â  Â  Â  Â  Â  Â  Â  const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
Â  Â  Â  Â  Â  Â  Â  Â  for (let s of samples) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(match) {
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("âœ… IDENTITY CONFIRMED", "#00ff00");
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopCamera();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  receiverVerified = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Update UI based on transaction type
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentTransactionType === 'CHECKOUT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("checkout_status_text").innerHTML = "âœ… VERIFIED: " + currentUser.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("checkout_status_text").style.color = "green";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btn_checkout_verify").classList.add("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enable Admin Button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const subBtn = document.getElementById("btn_checkout_submit");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.style.background = "#b38600";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.style.opacity = "1";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("return_status_text").innerHTML = "âœ… VERIFIED: " + currentUser.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("return_status_text").style.color = "green";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btn_return_verify").classList.add("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enable Admin Button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const subBtn = document.getElementById("btn_return_submit");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.style.background = "#17a2b8";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subBtn.style.opacity = "1";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Face Does Not Match User");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MODE 2: ADMIN AUTHORIZATION ---
Â  Â  Â  Â  else if(scanMode === 'ADMIN') {
Â  Â  // Step 1: must be logged in admin
Â  Â  if (!isAdmin) {
Â  Â  Â  Â  throw new Error("You are not an admin account");
Â  Â  }

Â  Â  // Step 2: match only against his own face
Â  Â  const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
Â  Â  const storedData = snap.val();

Â  Â  let match = false;
Â  Â  if (storedData) {
Â  Â  Â  Â  const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
Â  Â  Â  Â  for (let s of samples) {
Â  Â  Â  Â  Â  Â  if (faceapi.euclideanDistance(s, currentDescriptor) < 0.55) {
Â  Â  Â  Â  Â  Â  Â  Â  match = true;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (match) {
Â  Â  Â  Â  updateStatus("âœ… ADMIN AUTHORIZED", "#00ff00");
Â  Â  Â  Â  await processTransaction(currentUser.name);
Â  Â  } else {
Â  Â  Â  Â  throw new Error("Admin face does not match");
Â  Â  }
}
Â  Â  Â  Â  // --- MODE 3: LOGIN ---
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
Â  Â  Â  Â  Â  Â  const storedData = snap.val();
Â  Â  Â  Â  Â  Â  let match = false;
Â  Â  Â  Â  Â  Â  if(storedData) {
Â  Â  Â  Â  Â  Â  Â  Â  const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
Â  Â  Â  Â  Â  Â  Â  Â  for (let s of samples) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(match) {
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus("âœ… VERIFIED", "#00ff00");
Â  Â  Â  Â  Â  Â  Â  Â  await recordLogin("Biometric");
Â  Â  Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Face Mismatch");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  updateStatus("âŒ " + error.message, "red");
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerText = "ğŸ“¸ Retry Scan";
Â  Â  }
};

window.registerNewFace = async () => {
Â  Â  if(!currentDescriptor) { updateStatus("âŒ Camera cannot see face clearly.", "orange"); return; }
Â  Â  regSamples.push(Array.from(currentDescriptor));
Â  Â  const count = regSamples.length;
Â  Â  updateRegDots(count);
Â  Â  if(count < 3) {
Â  Â  Â  Â  updateStatus(`âœ… Sample ${count}/3 Captured.`, "lightgreen");
Â  Â  Â  Â  document.getElementById("btnCapture").innerText = `ğŸ“¸ Capture Sample ${count + 1} of 3`;
Â  Â  } else {
Â  Â  Â  Â  updateStatus("ğŸ’¾ Saving...", "yellow");
Â  Â  Â  Â  await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
Â  Â  Â  Â  alert("Registration Complete!"); location.reload();
Â  Â  }
};
// --- FIXED: LOAD ALL STATION DATA (Corrected ID Match) ---
window.loadStationData = () => {
Â  Â  // 1. SHOW THE PANEL
Â  Â  const panel = document.getElementById("logResultsPanel");
Â  Â  if(panel) panel.classList.remove("hidden");Â 
Â  Â Â 
Â  Â  const title = document.getElementById("logTableTitle");
Â  Â  if(title) title.innerText = "Recent Station Logs (All)";

Â  Â  // 2. GET THE CORRECT TABLE BODY (Updated ID for Professional HTML)
Â  Â  // We check for both IDs just to be safe
Â  Â  const tbody = document.getElementById("viewTable1Body") || document.getElementById("stationDataViewBody");
Â  Â Â 
Â  Â  // 3. CRASH PREVENTION
Â  Â  if (!tbody) {
Â  Â  Â  Â  console.warn("Table Body not found. Skipping render.");
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>â³ Loading Station Logs...</td></tr>";

Â  Â  // 4. FETCH DATA
Â  Â  const q = query(ref(db, "station_logs"), limitToLast(50));

Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No data found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse();Â 

Â  Â  Â  Â  tbody.innerHTML = "";

Â  Â  Â  Â  logs.forEach(d => {
Â  Â  Â  Â  Â  Â  // View Button
Â  Â  Â  Â  Â  Â  const rowButton = `<button class="info" onclick="fetchAndShowRakes('${d.key}')" style="padding:4px 8px; font-size:11px;">ğŸ“„ View Table</button>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Admin Delete Button
Â  Â  Â  Â  Â  Â  let deleteBtn = "";
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn = `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:4px 8px; font-size:11px; margin-left:5px;">ğŸ—‘</button>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Render Row
Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  <tr class="station-row-item">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${d.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${d.userName}</td>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${d.len || '-'} m</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${d.yl || '-'} cm</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.th || '-'} cm</td>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${d.impl === 'YES' ? '<span style="color:green">âœ… YES</span>' : '<span style="color:red">âŒ NO</span>'}</td>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-style:italic; color:#555; font-size:11px;">${d.remarks || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; white-space:nowrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${rowButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${deleteBtn}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += html;
Â  Â  Â  Â  });
Â  Â  }, { onlyOnce: true });
};
// =========================================================
// ğŸš€ ENGINE CORE: DATA ISOLATION SYSTEM (Unified)
// =========================================================

// Global State Trackers
let currentStationKey = null;Â 
let currentRakeKey = null;
let draftRef = null;
let draftListener = null;
async function nuclearReset() {
Â  Â  console.log("â˜¢ï¸ NUCLEAR RESET: Hard reset initiated.");
Â  Â Â 
Â  Â  // 1. ENGAGE SAFETY LOCK
Â  Â  isSwitching = true;Â 

Â  Â  // 2. DETACH LISTENERS (Swallow errors to prevent crash)
Â  Â  if (draftRef) {Â 
Â  Â  Â  Â  try { off(draftRef); } catch(e) { console.log("Listener clear error", e); }
Â  Â  Â  Â  draftRef = null;
Â  Â  }
Â  Â  draftListener = null;Â 

Â  Â  // 3. WIPE MEMORY
Â  Â  currentStationKey = null;
Â  Â  currentRakeKey = null;

Â  Â  // 4. WIPE INPUTS (Physically clear the box)
Â  Â  const uiIds = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
Â  Â  uiIds.forEach(id => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if(el) {Â 
Â  Â  Â  Â  Â  Â  el.value = "";Â 
Â  Â  Â  Â  Â  Â  el.disabled = false;Â 
Â  Â  Â  Â  Â  Â  el.blur(); // Remove focus
Â  Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  // 5. WIPE TABLE
Â  Â  const tbody = document.getElementById("distanceBody");
Â  Â  if(tbody) tbody.innerHTML = "";

Â  Â  // 6. RESET BUTTONS
Â  Â  const warningEl = document.getElementById("dataExistsWarning");
Â  Â  if(warningEl) warningEl.classList.add("hidden");
Â  Â Â 
Â  Â  const titleEl = document.getElementById("formTitle");
Â  Â  if(titleEl) titleEl.innerText = "ğŸ“ New Entry";
Â  Â Â 
Â  Â  const btn = document.getElementById("btnFinalSubmit");
Â  Â  if(btn) {
Â  Â  Â  Â  btn.innerText = "âœ” Submit to Master Database";
Â  Â  Â  Â  btn.style.background = "#0A2342";Â 
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }

Â  Â  // 7. DATABASE PURGE (Clear the user's draft node completely)
Â  Â  if(currentUser) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await set(ref(db, `drafts/${currentUser.uid}`), null);
Â  Â  Â  Â  } catch(e) { console.error("Draft wipe failed", e); }
Â  Â  }
}
window.handleStationChange = async () => {
Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  const formDiv = document.getElementById("mainDataForm");
Â  Â  const submitBtn = document.getElementById("btnFinalSubmit");

Â  Â  // ğŸ›‘ STEP 1: FORCE RESET & WAIT
Â  Â  await nuclearReset();Â 

Â  Â  if (!stnSel.value) {
Â  Â  Â  Â  formDiv.classList.add("hidden");
Â  Â  Â  Â  isSwitching = false;
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // === STEP 2: SHOW FORM ===
Â  Â  formDiv.classList.remove("hidden");
Â  Â  const fullStationName = `${stnSel.value} (${lineSel.value})`;
Â  Â Â 
Â  Â  document.getElementById("inpStationName").value = fullStationName;
Â  Â  document.getElementById("formTitle").innerText = `ğŸ“ Entry: ${stnSel.value}`;

Â  Â  // === STEP 3: CHECK DATABASE ===
Â  Â  // Use once() via get() to prevent lingering connections
Â  Â  const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(fullStationName));
Â  Â  const snap = await get(q);

Â  Â  if (snap.exists()) {
Â  Â  Â  Â  // --- EDIT MODE ---
Â  Â  Â  Â  let data = null;
Â  Â  Â  Â  snap.forEach(c => { data = c.val(); currentStationKey = c.key; });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById("inpStationLength").value = data.len || "";
Â  Â  Â  Â  document.getElementById("inpYellowDist").value = data.yl || "";
Â  Â  Â  Â  document.getElementById("inpYellowThick").value = data.th || "";
Â  Â  Â  Â  document.getElementById("inpRemarks").value = data.remarks || "";
Â  Â  Â  Â  document.getElementById("inpImplementation").value = data.impl || "";

Â  Â  Â  Â  document.getElementById("dataExistsWarning").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("dataExistsWarning").innerHTML = "âš ï¸ <strong>EDIT MODE:</strong> Modifying Existing Record.";
Â  Â  Â  Â  submitBtn.innerText = "ğŸ’¾ Update Master Record";
Â  Â  Â  Â  submitBtn.style.background = "#d97706";Â 

Â  Â  Â  Â  currentRakeKey = data.linkedRakeKey || currentStationKey;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Copy Rake Data to Drafts for editing
Â  Â  Â  Â  const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
Â  Â  Â  Â  if(rakeSnap.exists()) {
Â  Â  Â  Â  Â  Â  await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
Â  Â  Â  Â  }

Â  Â  } else {
Â  Â  Â  Â  // --- NEW ENTRY MODE ---
Â  Â  Â  Â  // currentStationKey is NULL from nuclearReset
Â  Â  Â  Â  submitBtn.innerText = "âœ” Submit New Log";
Â  Â  Â  Â  submitBtn.style.background = "#0A2342";Â 
Â  Â  }

Â  Â  // === STEP 4: START DRAFT LISTENER ===
Â  Â  loadDraft();Â 
Â  Â Â 
Â  Â  // Release the safety lock
Â  Â  setTimeout(() => { isSwitching = false; }, 500);
};
// --- 3. DRAFT TABLE LOADER (Corrected Name) ---
window.loadDraft = () => {
Â  Â  // 1. Set the reference to the user's draft rows
Â  Â  draftRef = ref(db, `drafts/${currentUser.uid}/rows`);
Â  Â Â 
Â  Â  // 2. Start the Realtime Listener
Â  Â  draftListener = onValue(draftRef, (snap) => {
Â  Â  Â  Â  const tbody = document.getElementById("distanceBody");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Safety check: ensure table exists before trying to write to it
Â  Â  Â  Â  if (!tbody) return;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  tbody.innerHTML = ""; // Clear existing rows

Â  Â  Â  Â  if(!snap.exists()) return; // If no data, stop here

Â  Â  Â  Â  const rows = snap.val();
Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Loop through rows and render HTML
Â  Â  Â  Â  Object.entries(rows).forEach(([key, val]) => {
Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${count++}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input value="${val.rake || ''}" onchange="upRow('${key}','rake',this.value)" placeholder="Rake ID" style="width:100%">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="upRow('${key}','type',this.value)" style="width:100%">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="BHEL" ${val.type === 'BHEL' ? 'selected' : ''}>BHEL</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="MEDHA" ${val.type === 'MEDHA' ? 'selected' : ''}>MEDHA</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="DALIAN" ${val.type === 'DALIAN' ? 'selected' : ''}>DALIAN</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CRRC" ${val.type === 'CRRC' ? 'selected' : ''}>CRRC</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input value="${val.f || ''}" onchange="upRow('${key}','f',this.value)" placeholder="Front" style="width:100%">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input value="${val.r || ''}" onchange="upRow('${key}','r',this.value)" placeholder="Rear" style="width:100%">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="delRow('${key}')">X</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += html;
Â  Â  Â  Â  });
Â  Â  });
};
window.submitStationData = async () => {
Â  Â  const btn = document.getElementById("btnFinalSubmit");
Â  Â  btn.innerText = "â³ Saving...";
Â  Â  btn.disabled = true;

Â  Â  try {
Â  Â  Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!lineSel.value || !stnSel.value) throw new Error("No station selected.");

Â  Â  Â  Â  const fullStationName = `${stnSel.value} (${lineSel.value})`;

Â  Â  Â  Â  const formData = {
Â  Â  Â  Â  Â  Â  name: fullStationName,
Â  Â  Â  Â  Â  Â  len: document.getElementById("inpStationLength").value,
Â  Â  Â  Â  Â  Â  yl: document.getElementById("inpYellowDist").value,
Â  Â  Â  Â  Â  Â  th: document.getElementById("inpYellowThick").value,
Â  Â  Â  Â  Â  Â  remarks: document.getElementById("inpRemarks").value,
Â  Â  Â  Â  Â  Â  impl: document.getElementById("inpImplementation").value,
Â  Â  Â  Â  Â  Â  user: currentUser.email,
Â  Â  Â  Â  Â  Â  userName: currentUser.name,
Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString('en-IN'),Â 
Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  };

Â  Â  Â  Â  const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/rows`));
Â  Â  Â  Â  const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  let targetKey = currentStationKey;
Â  Â  Â  Â  let targetRakeKey = currentRakeKey;

Â  Â  Â  Â  if (targetKey) {
Â  Â  Â  Â  Â  Â  updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  targetKey = push(ref(db, "station_logs")).key;
Â  Â  Â  Â  Â  Â  targetRakeKey = targetKey;Â 
Â  Â  Â  Â  Â  Â  updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
Â  Â  Â  Â  }

Â  Â  Â  Â  updates[`rake_logs/${targetRakeKey}`] = rowsData || null;

Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  await remove(ref(db, `drafts/${currentUser.uid}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert(`âœ… Saved: ${stnSel.value}`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Clear everything
Â  Â  Â  Â  await nuclearReset();Â 
Â  Â  Â  Â  document.getElementById("mainDataForm").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("stationSelect").value = "";

Â  Â  Â  Â  // 2. Switch Tab BUT DO NOT LOAD TABLE
Â  Â  Â  Â  switchTab('dataView');

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("âŒ ERROR: " + e.message);
Â  Â  } finally {
Â  Â  Â  Â  if(btn) {
Â  Â  Â  Â  Â  Â  btn.innerText = "âœ” Submit to Master Database";
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  }
Â  Â  }
};
// GLOBAL VARIABLES to track active listeners
// (This prevents duplicate connections when you click Refresh)
let adminUsersListener = null;
let adminStatusListener = null;
// =========================================================
// ğŸ› ï¸ FIXED: ADMIN PANEL (Anti-Flicker & Stable Status)
// =========================================================
window.loadAdminPanel = () => {
Â  Â  const tbody = document.getElementById("userListBody");
Â  Â  const checkboxList = document.getElementById("userCheckboxList");

Â  Â  if (!tbody || !checkboxList) return;

Â  Â  // --- NEW: CENTRALIZED PIN SYNC ---
Â  Â  // Fetches the active system PIN so the Admin can see it
Â  Â  get(ref(db, "system_settings/master_pin")).then(snap => {
Â  Â  Â  Â  const pinDisplay = document.getElementById("displayCurrentPin");
Â  Â  Â  Â  if (pinDisplay) {
Â  Â  Â  Â  Â  Â  pinDisplay.value = snap.exists() ? snap.val() : "1234";
Â  Â  Â  Â  }
Â  Â  }).catch(e => console.error("PIN Sync Error:", e));

Â  Â  // 1. CLEANUP (Stop previous listeners to prevent memory leaks/loops)
Â  Â  if (adminUsersListener) { if (typeof adminUsersListener === "function") adminUsersListener(); adminUsersListener = null; }
Â  Â  if (adminStatusListener) { if (typeof adminStatusListener === "function") adminStatusListener(); adminStatusListener = null; }

Â  Â  // Clear any existing periodic render loops
Â  Â  if (window.adminRenderInterval) clearInterval(window.adminRenderInterval);

Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-sync fa-spin'></i> Syncing...</td></tr>";
Â  Â Â 
Â  Â  let localUsers = {};
Â  Â  let localStatus = {};

Â  Â  const renderTable = () => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  checkboxList.innerHTML = "";

Â  Â  Â  Â  if (!localUsers || Object.keys(localUsers).length === 0) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>No users found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const NOW = Date.now();Â 

Â  Â  Â  Â  Object.entries(localUsers).forEach(([uid, u]) => {
Â  Â  Â  Â  Â  Â  if (!u.email) return;

Â  Â  Â  Â  Â  Â  const isSelf = (uid === currentUser.uid);
Â  Â  Â  Â  Â  Â  const isBanned = u.banned === true;
Â  Â  Â  Â  Â  Â  const hasBiometrics = !!u.faceData;Â 

Â  Â  Â  Â  Â  Â  // --- STABILIZED STATUS LOGIC ---
Â  Â  Â  Â  Â  Â  const s = localStatus[uid];
Â  Â  Â  Â  Â  Â  let isOnline = false;
Â  Â  Â  Â  Â  Â  let lastSeenText = "Never";

Â  Â  Â  Â  Â  Â  if (s && s.last_seen) {
Â  Â  Â  Â  Â  Â  Â  Â  const diff = NOW - s.last_seen;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const isRecent = diff < 35000; // 35 second tolerance for slow networks

Â  Â  Â  Â  Â  Â  Â  Â  if (diff < 10000) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isOnline = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (isRecent && s.state !== 'offline') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isOnline = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  lastSeenText = new Date(s.last_seen).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- BADGE UI ---
Â  Â  Â  Â  Â  Â  let statusBadge = "";
Â  Â  Â  Â  Â  Â  if (isOnline) {
Â  Â  Â  Â  Â  Â  Â  Â  statusBadge = hasBiometricsÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<span class="badge-online" style="background:#dcfce7; color:#166534; border:1px solid #bbf7d0;">ğŸŸ¢ Online</span>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<span style="background:#fff7ed; color:#c2410c; padding:4px 10px; border-radius:12px; font-size:10px; font-weight:800; border:1px solid #fdba74;">ğŸŸ¡ Setup Pending</span>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  statusBadge = `<span class="badge-offline">âš« Offline (${lastSeenText})</span>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const bioStatus = hasBiometricsÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<span style="color:green; font-weight:bold; font-size:11px;">âœ” Registered</span>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  : `<span style="color:red; font-weight:bold; font-size:11px;">âš  Missing</span>`;

Â  Â  Â  Â  Â  Â  // --- ADMIN BUTTONS ---
Â  Â  Â  Â  Â  Â  let actionBtns = `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="info" onclick="viewUserTasks('${uid}', '${encodeURIComponent(u.name || u.email)}')" style="padding:4px 8px; font-size:10px; margin-right:2px;" title="View Tasks"><i class="fas fa-tasks"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="secondary" onclick="resetUserName('${uid}')" style="padding:4px 8px; font-size:10px; margin-right:2px;" title="Reset Name"><i class="fas fa-eraser"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="warning" onclick="resetUserFace('${uid}')" style="padding:4px 8px; font-size:10px; margin-right:2px;" title="Reset Face ID"><i class="fas fa-user-slash"></i></button>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  if (!isSelf) {
Â  Â  Â  Â  Â  Â  Â  Â  if (isBanned) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionBtns += `<button class="success" onclick="unbanUser('${uid}', '${encodeURIComponent(u.name || u.email)}')" style="padding:4px 8px; font-size:10px;">â™» Unban</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionBtns += `<button class="danger" onclick="openBanModal('${uid}', '${encodeURIComponent(u.name || u.email)}')" style="padding:4px 8px; font-size:10px;">â›” Ban</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- RENDER TABLE ROW ---
Â  Â  Â  Â  Â  Â  const rowStyle = isBanned ? "background:#fee2e2;" : "";
Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="${rowStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:bold; color:var(--metro-blue); font-size:13px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${u.name || 'Unknown'}Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isSelf ? '<span style="font-size:9px; background:#e2e8f0; padding:2px 4px; border-radius:3px;">YOU</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:10px; color:#64748b;">${u.email}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isBanned ? '<div style="color:red; font-size:9px; font-weight:bold;">â›” ACCESS REVOKED</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle;">${statusBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle; font-size:11px; color:#334155;">-</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle;">${bioStatus}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="vertical-align:middle;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;">${actionBtns}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  if (!isBanned) {
Â  Â  Â  Â  Â  Â  Â  Â  const checkId = `chk_user_${uid}`;
Â  Â  Â  Â  Â  Â  Â  Â  checkboxList.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="checkbox-item" for="${checkId}" style="display:flex; align-items:center; justify-content:space-between;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="${checkId}" class="user-check" value="${uid}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:600; font-size:12px;">${u.name || u.email}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:10px;">${isOnline ? 'ğŸŸ¢' : 'âš«'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // 2. START LISTENERS
Â  Â  adminUsersListener = onValue(ref(db, "users"), (snap) => {
Â  Â  Â  Â  if (snap.exists()) localUsers = snap.val();
Â  Â  Â  Â  renderTable();
Â  Â  });

Â  Â  adminStatusListener = onValue(ref(db, "status"), (snap) => {
Â  Â  Â  Â  if (snap.exists()) localStatus = snap.val();
Â  Â  Â  Â  renderTable();
Â  Â  });
Â  Â Â 
Â  Â  // 3. PERIODIC RE-RENDER (To keep "Time Ago" or "Offline" text accurate)
Â  Â  window.adminRenderInterval = setInterval(renderTable, 10000);Â 
};
window.viewRakeRows = (rowsEncoded, stationName) => {
Â  Â  try {
Â  Â  Â  Â  const rows = JSON.parse(decodeURIComponent(rowsEncoded));
Â  Â  Â  Â  let msg = `DETAILS FOR: ${stationName}\n\n`;
Â  Â  Â  Â  msg += `SL | RAKE | TYPE | FRONT | REAR\n`;
Â  Â  Â  Â  msg += `--------------------------------\n`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Loop through the rows object
Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â  for (let key in rows) {
Â  Â  Â  Â  Â  Â  let r = rows[key];
Â  Â  Â  Â  Â  Â  msg += `${count}. ${r.rake || '-'} | ${r.type || '-'} | ${r.f || '-'} | ${r.r || '-'}\n`;
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  }
Â  Â  Â  Â  alert(msg);
Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Error reading row data.");
Â  Â  }
};

// --- SEARCH FILTER ---
window.filterStationData = () => {
Â  Â  const input = document.getElementById("stationLogSearch").value.toLowerCase();
Â  Â  const rows = document.getElementsByClassName("station-row-item");
Â  Â Â 
Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  const stationName = row.cells[1].innerText.toLowerCase(); // Search Station Name
Â  Â  Â  Â  const submittedBy = row.cells[2].innerText.toLowerCase(); // Search User Name
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (stationName.includes(input) || submittedBy.includes(input)) {
Â  Â  Â  Â  Â  Â  row.style.display = "";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  row.style.display = "none";
Â  Â  Â  Â  }
Â  Â  });
};
// List of allowed admin emails (LOWERCASE)
Â  function checkAdminStatus() {
Â  Â  const ADMINS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
Â  Â Â 
Â  Â  if (currentUser && ADMINS.includes(currentUser.email.toLowerCase())) {
Â  Â  Â  Â  isAdmin = true;
Â  Â  Â  Â  // Force the tab button to show
Â  Â  Â  Â  const btnAdmin = document.getElementById("btnAdmin");
Â  Â  Â  Â  const badge = document.getElementById("adminBadge");
Â  Â  Â  Â  if(btnAdmin) btnAdmin.classList.remove("hidden");
Â  Â  Â  Â  if(badge) badge.classList.remove("hidden");
Â  Â  Â  Â  console.log("âœ… Admin Mode Active for:", currentUser.email);
Â  Â  } else {
Â  Â  Â  Â  isAdmin = false;
Â  Â  Â  Â  console.log("ğŸ‘¤ User Mode Active for:", currentUser.email);
Â  Â  }
}
function handleFail() {
Â  Â  failCount++;
Â  Â  if(failCount >= 3) {
Â  Â  Â  Â  stopCamera();
Â  Â  Â  Â  document.getElementById("faceModal").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("videoContainer").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("camControls").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("otpUI").classList.remove("hidden");
Â  Â  Â  Â  updateStatus("âš ï¸ Camera Disabled. Enter PIN.", "red");
Â  Â  } else {
Â  Â  Â  Â  updateStatus(`âŒ Failed. Attempts left: ${3 - failCount}`, "orange");
Â  Â  }
}

window.verifyOTP = () => {
Â  Â  const input = document.getElementById("otpInput").value;
Â  Â  get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
Â  Â  Â  Â  const actualPin = snap.val() || "1234";
Â  Â  Â  Â  if(input === actualPin) {
Â  Â  Â  Â  Â  Â  await recordLogin("PIN Entry");
Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("Wrong PIN âŒ");
Â  Â  Â  Â  }
Â  Â  });
}

function enterApp() {
Â  Â  stopCamera();
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  document.getElementById("appScreen").classList.remove("hidden");
Â  Â Â 
Â  Â  // Load Tabs
Â  Â  switchTab('newData');
Â  Â  loadDraft();Â 
Â  Â  loadGallery();Â 
Â  Â  loadInventory();Â 
Â  Â  loadAssignments();

Â  Â  // --- FIX: START THE TIMER NOW ---
Â  Â  setupIdleTimer();Â 
}
// --- FIXED TOGGLE FUNCTION (Crash-Free for Checkout & Return) ---
window.toggleInvMode = (mode) => {
Â  Â  // 1. Hide All Panels
Â  Â  document.getElementById("inv-add").classList.add("hidden");
Â  Â  document.getElementById("inv-checkout").classList.add("hidden");
Â  Â  document.getElementById("inv-return").classList.add("hidden");
Â  Â  document.getElementById("inv-history").classList.add("hidden");
Â  Â  document.getElementById("inv-list").classList.add("hidden");
Â  Â Â 
Â  Â  // 2. Show the Selected Panel
Â  Â  const targetPanel = document.getElementById(`inv-${mode}`);
Â  Â  if(targetPanel) targetPanel.classList.remove("hidden");
Â  Â Â 
Â  Â  // 3. (REMOVED) Old Dropdown Logic
Â  Â  // We strictly removed the calls to 'populateCheckoutSelect'Â 
Â  Â  // and 'populateReturnSelect' here.Â 
Â  Â  // This stops the "innerHTML of null" error completely.

Â  Â  // 4. Special Focus Logic for History Tab
Â  Â  if(mode === 'history') {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â const searchInput = document.getElementById("auditSearchInput");
Â  Â  Â  Â  Â  Â  Â if(searchInput) searchInput.focus();
Â  Â  Â  Â  }, 100);
Â  Â  }
};
// 1. POPULATE CHECKOUT (Show All Items)
function populateCheckoutSelect() {
Â  Â  const sel = document.getElementById("checkoutSelect");
Â  Â  sel.innerHTML = "<option value=''>Loading...</option>";
Â  Â  onValue(ref(db, "inventory"), snap => {
Â  Â  Â  Â  sel.innerHTML = "<option value=''>Select Item...</option>";
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = c.key;
Â  Â  Â  Â  Â  Â  opt.text = `${v.item} (Avail: ${v.qty})`;
Â  Â  Â  Â  Â  Â  opt.dataset.qty = v.qty;
Â  Â  Â  Â  Â  Â  opt.dataset.name = v.item;
Â  Â  Â  Â  Â  Â  // NEW: STORE BARCODE
Â  Â  Â  Â  Â  Â  if(v.barcode) opt.dataset.barcode = v.barcode;
Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  }, { onlyOnce: true });
}

// 2. POPULATE RETURN (Show Only Items You Hold)
async function populateReturnSelect() {
Â  Â  const sel = document.getElementById("returnSelect");
Â  Â  sel.innerHTML = "<option value=''>Calculating your holdings...</option>";

Â  Â  try {
Â  Â  Â  Â  // A. Get current Inventory (for keys)
Â  Â  Â  Â  const invSnap = await get(ref(db, "inventory"));
Â  Â  Â  Â  const inventoryMap = {}; // Maps ItemName -> { key, exists, barcode }
Â  Â  Â  Â  invSnap.forEach(c => {
Â  Â  Â  Â  Â  Â  const val = c.val();
Â  Â  Â  Â  Â  Â  inventoryMap[val.item] = { key: c.key, exists: true, barcode: val.barcode };
Â  Â  Â  Â  });

Â  Â  Â  Â  // B. Get User Logs
Â  Â  Â  Â  const logsSnap = await get(query(ref(db, "logs")));
Â  Â  Â  Â  const myHoldings = {}; // ItemName -> NetQuantity

Â  Â  Â  Â  logsSnap.forEach(c => {
Â  Â  Â  Â  Â  Â  const l = c.val();
Â  Â  Â  Â  Â  Â  // Check if this log belongs to current user
Â  Â  Â  Â  Â  Â  const isMe = (l.takenBy === currentUser.name) || (l.takenBy === currentUser.email);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isMe) {
Â  Â  Â  Â  Â  Â  Â  Â  if(l.type === 'CHECKOUT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myHoldings[l.item] = (myHoldings[l.item] || 0) + parseInt(l.qty);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (l.type === 'RETURN') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myHoldings[l.item] = (myHoldings[l.item] || 0) - parseInt(l.qty);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // C. Render
Â  Â  Â  Â  sel.innerHTML = "<option value=''>Select Item...</option>";
Â  Â  Â  Â  let foundAny = false;

Â  Â  Â  Â  for (const [itemName, netQty] of Object.entries(myHoldings)) {
Â  Â  Â  Â  Â  Â  if (netQty > 0 && inventoryMap[itemName]) {
Â  Â  Â  Â  Â  Â  Â  Â  foundAny = true;
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = inventoryMap[itemName].key; // Use inventory key for update
Â  Â  Â  Â  Â  Â  Â  Â  opt.text = `${itemName} (You have: ${netQty})`;
Â  Â  Â  Â  Â  Â  Â  Â  opt.dataset.qty = netQty; // Max returnable
Â  Â  Â  Â  Â  Â  Â  Â  opt.dataset.name = itemName;
Â  Â  Â  Â  Â  Â  Â  Â  // NEW: STORE BARCODE
Â  Â  Â  Â  Â  Â  Â  Â  if(inventoryMap[itemName].barcode) opt.dataset.barcode = inventoryMap[itemName].barcode;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(!foundAny) {
Â  Â  Â  Â  Â  Â  sel.innerHTML = "<option value=''>No items to return.</option>";
Â  Â  Â  Â  }

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  sel.innerHTML = "<option>Error loading.</option>";
Â  Â  }
}
window.updateMasterPin = async () => {
Â  Â  const newPin = document.getElementById("newPinInput").value.trim();

Â  Â  if (!/^\d{4}$/.test(newPin)) {
Â  Â  Â  Â  return alert("âš ï¸ INVALID PIN: Enter exactly 4 digits.");
Â  Â  }

Â  Â  if (!confirm("Confirm changing the GLOBAL Master PIN? Users using '1234' will be blocked immediately.")) return;

Â  Â  try {
Â  Â  Â  Â  // Save to a central "settings" node instead of a specific user
Â  Â  Â  Â  await set(ref(db, "system_settings/master_pin"), newPin);
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert("âœ… GLOBAL PIN UPDATED: " + newPin);
Â  Â  Â  Â  document.getElementById("displayCurrentPin").value = newPin;
Â  Â  Â  Â  document.getElementById("newPinInput").value = "";
Â  Â  } catch(e) {
Â  Â  Â  Â  alert("Database Error: " + e.message);
Â  Â  }
};
window.updateMaxQty = () => {
Â  Â  const isCheckout = !document.getElementById("inv-checkout").classList.contains("hidden");
Â  Â  const selId = isCheckout ? "checkoutSelect" : "returnSelect";
Â  Â  const inpId = isCheckout ? "checkoutAvail" : "returnAvail";
Â  Â Â 
Â  Â  const sel = document.getElementById(selId);
Â  Â  const opt = sel.options[sel.selectedIndex];
Â  Â Â 
Â  Â  if(opt && opt.dataset.qty) {
Â  Â  Â  Â  document.getElementById(inpId).value = opt.dataset.qty;
Â  Â  } else {
Â  Â  Â  Â  document.getElementById(inpId).value = "";
Â  Â  }
};

// --- NEW HISTORY LOADING LOGIC (FIXED) ---

function formatTime(ts) {
Â  Â  if (!ts) return "N/A";
Â  Â  const d = new Date(ts);
Â  Â Â 
Â  Â  // Convert to Indian Standard Time (Asia/Kolkata)
Â  Â  return d.toLocaleString('en-IN', {Â 
Â  Â  Â  Â  timeZone: 'Asia/Kolkata',
Â  Â  Â  Â  day: '2-digit',Â 
Â  Â  Â  Â  month: '2-digit',Â 
Â  Â  Â  Â  year: 'numeric',Â 
Â  Â  Â  Â  hour: '2-digit',Â 
Â  Â  Â  Â  minute: '2-digit',
Â  Â  Â  Â  hour12: trueÂ 
Â  Â  });
}
// --- LINEAR HISTORY LOGIC (SIMPLE LIST + BARCODES) ---
window.loadInventoryHistory = () => {
Â  Â  const tbody = document.getElementById("invHistoryBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Retrieving Secure Records...</td></tr>";

Â  Â  // Fetch last 300 logs
Â  Â  const q = query(ref(db, "logs"), limitToLast(300));
Â  Â Â 
Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse(); // Show newest events at the top

Â  Â  Â  Â  // Filter: Show only inventory-related events
Â  Â  Â  Â  const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE');

Â  Â  Â  Â  if(invLogs.length === 0) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded in recent history.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  invLogs.forEach(l => {
Â  Â  Â  Â  Â  Â  // Badge Styling
Â  Â  Â  Â  Â  Â  let badge = "";
Â  Â  Â  Â  Â  Â  if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">ğŸ“¤ OUT</span>`;
Â  Â  Â  Â  Â  Â  else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">ğŸ“¥ IN</span>`;
Â  Â  Â  Â  Â  Â  else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">â• ADD</span>`;

Â  Â  Â  Â  Â  Â  // Barcode formatting
Â  Â  Â  Â  Â  Â  const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px;">||| ${l.barcode}</div>` : '';

Â  Â  Â  Â  Â  Â  // Row HTML
Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:#003366;">${l.barcode || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${l.takenBy || 'Unknown'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${formatTime(l.time)}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:#555;">Auth: ${l.approvedBy || 'System'}</small>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${badge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:13px;">${l.item}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  });
Â  Â  }, { onlyOnce: true });
};
// --- NEW SEARCH FUNCTION FOR INVENTORY ---
window.filterInvLogs = () => {
Â  Â  const input = document.getElementById("invSearch").value.toLowerCase();
Â  Â  const rows = document.getElementsByClassName("inv-log-row");
Â  Â 
Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  const text = row.innerText.toLowerCase();
Â  Â  Â  Â  row.style.display = text.includes(input) ? "" : "none";
Â  Â  });
};
// --- UPDATED SUBMIT FUNCTION (COMBINED LOCATION LOGIC) ---
window.submitTransactionNoFace = (type) => {
Â  Â  if(!pendingTransactionItem) return alert("Please SCAN an item first.");
Â  Â Â 
Â  Â  // --- CHECKOUT VALIDATION ---
Â  Â  if(type === 'CHECKOUT') {
Â  Â  Â  Â  const purpose = document.getElementById("checkoutPurpose").value;
Â  Â  Â  Â  if(!purpose || purpose.trim() === "") return alert("Please enter the PURPOSE for this checkout.");
Â  Â  }
Â  Â Â 
Â  Â  // --- RETURN VALIDATION & FORMATTING ---
Â  Â  let finalLocation = "";
Â  Â Â 
Â  Â  if(type === 'RETURN') {
Â  Â  Â  Â  // 1. Get Main Place
Â  Â  Â  Â  const selection = document.getElementById("returnLocSelect").value;
Â  Â  Â  Â  let mainPlace = selection;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(selection === "Other") {
Â  Â  Â  Â  Â  Â  const otherText = document.getElementById("returnLocOther").value.trim();
Â  Â  Â  Â  Â  Â  if(!otherText) return alert("Please specify the 'Other' location name.");
Â  Â  Â  Â  Â  Â  mainPlace = otherText;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Get Specific Spot (Cabinet/Almirah)
Â  Â  Â  Â  const spot = document.getElementById("returnLocSpot").value.trim();
Â  Â  Â  Â  if(!spot) return alert("Please specify the Exact Spot (e.g., Cabinet, Almirah).");

Â  Â  Â  Â  // 3. Combine them
Â  Â  Â  Â  // Format: "D2 Building - Heerok Sir Lab [Upper Cabinet]"
Â  Â  Â  Â  finalLocation = `${mainPlace} [${spot}]`;
Â  Â  }

Â  Â  scanMode = 'DIRECT';Â 
Â  Â  currentTransactionType = type;
Â  Â Â 
Â  Â  // Pass the calculated location to the processor
Â  Â  processTransaction("Self/System", finalLocation);
};
// ==========================================
// âš™ï¸ FINAL TRANSACTION PROCESSOR (LOGS & PRINT)
// ==========================================
async function processTransaction(adminName, customReturnLocation = null) {
Â  Â  if(!pendingTransactionItem) return alert("System Error: No item loaded.");

Â  Â  const itemKey = pendingTransactionItem.key;
Â  Â  const itemName = pendingTransactionItem.item;
Â  Â  const barcode = pendingTransactionItem.barcode;
Â  Â  const isCheckout = (currentTransactionType === 'CHECKOUT');

Â  Â  try {
Â  Â  Â  Â  const invRef = ref(db, `inventory/${itemKey}`);
Â  Â  Â  Â  const invSnap = await get(invRef);
Â  Â  Â  Â  const currentData = invSnap.val();

Â  Â  Â  Â  let updateData = isCheckout ? {
Â  Â  Â  Â  Â  Â  status: "Checked Out",
Â  Â  Â  Â  Â  Â  holder: currentUser.name || currentUser.email,
Â  Â  Â  Â  Â  Â  location: "Field Operations",
Â  Â  Â  Â  Â  Â  usageCount: (currentData.usageCount || 0) + 1
Â  Â  Â  Â  } : {
Â  Â  Â  Â  Â  Â  status: "In Stock",
Â  Â  Â  Â  Â  Â  holder: "Store",
Â  Â  Â  Â  Â  Â  location: customReturnLocation || "D2 Building Lab",
Â  Â  Â  Â  Â  Â  // --- NUCLEAR WIPE OF SALE DATA ON RETURN ---
Â  Â  Â  Â  Â  Â  invoiceNo: null,
Â  Â  Â  Â  Â  Â  soldAt: null,
Â  Â  Â  Â  Â  Â  assignedStation: null,
Â  Â  Â  Â  Â  Â  noWarranty: null // Optional: resets warranty status on return
Â  Â  Â  Â  };

Â  Â  Â  Â  await update(invRef, updateData);

Â  Â  Â  Â  if (!isCheckout) {
Â  Â  Â  Â  Â  Â  alert(`âœ… RETURN SUCCESSFUL: ${itemName}`);
Â  Â  Â  Â  Â  Â  generateReturnPrintout(itemName, barcode, "N/A (RESTOCKED)", "Main Store", "Standard Return");
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById(isCheckout ? "checkout_display" : "return_display").classList.add("hidden");
Â  Â  Â  Â  pendingTransactionItem = null;

Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Transaction Error: " + e.message);
Â  Â  }
}
Â  window.loadWarSales = async () => {
Â  Â  const tbody = document.getElementById("warSalesTableBody");
Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  const salesGroup = {};Â 
Â  Â Â 
Â  Â  snap.forEach(c => {
Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  if (v.invoiceNo) {
Â  Â  Â  Â  Â  Â  if (!salesGroup[v.invoiceNo]) {
Â  Â  Â  Â  Â  Â  Â  Â  salesGroup[v.invoiceNo] = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  site: v.assignedStation,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: v.soldAt,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keys: [] // Track keys to wipe them if deleted
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  salesGroup[v.invoiceNo].items.push(v.item);
Â  Â  Â  Â  Â  Â  salesGroup[v.invoiceNo].keys.push(c.key);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  tbody.innerHTML = "";
Â  Â  Object.entries(salesGroup).forEach(([inv, data]) => {
Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; font-weight:bold; color:#0284c7;">${inv}</td>
Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${data.site}</td>
Â  Â  Â  Â  Â  Â  <td>${new Date(data.date).toLocaleDateString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">${data.items.join(", ")}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center; white-space:nowrap;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="printCustomerCopy('${inv}')" class="info" title="Print Warranty"><i class="fas fa-print"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  ${isAdmin ? `<button onclick="adminDeleteInvoiceRecord('${inv}')" class="danger" style="margin-left:5px;" title="Wipe Sale Record"><i class="fas fa-trash"></i> WIPE</button>` : ''}
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
Â  Â  });
};
Â  window.adminDeleteInvoiceRecord = async (invoiceNo) => {
Â  Â  if (!isAdmin) return alert("Unauthorized");
Â  Â  if (!confirm(`âš  CRITICAL: Wiping Invoice ${invoiceNo} will restock all associated items and delete this sale record permanently. Proceed?`)) return;

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  Â  Â  const updates = {};

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  if (v.invoiceNo === invoiceNo) {
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${c.key}/status`] = "In Stock";
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${c.key}/holder`] = "Store";
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${c.key}/invoiceNo`] = null;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${c.key}/assignedStation`] = null;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${c.key}/soldAt`] = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  alert("âœ… Sale Record Wiped successfully.");
Â  Â  Â  Â  loadWarSales(); // Refresh the table
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  }
};
// --- NEW HELPER: POPULATE USER DROPDOWN ---
window.populateUserDropdown = async () => {
Â  Â  const sel = document.getElementById("selPrintInspector");
Â  Â Â 
Â  Â  // 1. Reset with "Self" option (Convenience)
Â  Â  const currentName = currentUser.name || currentUser.email;
Â  Â  sel.innerHTML = `<option value="">-- Select Member --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="Self">Self (${currentName})</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <optgroup label="All Registered Users:">`;

Â  Â  // 2. Fetch all users from DB
Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "users"));
Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const u = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  const uName = u.name || u.email; // Use email if name is missing
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Add to dropdown
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = uName;
Â  Â  Â  Â  Â  Â  Â  Â  opt.innerText = uName;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error loading users:", e);
Â  Â  Â  Â  sel.innerHTML += `<option disabled>Error loading users</option>`;
Â  Â  }
};
window.saveStationDetails = () => {
Â  Â  const name = document.getElementById("inpStationName").value.trim();
Â  Â  if(!name) return alert("Station Name Required");
Â  Â  update(ref(db, `drafts/${currentUser.uid}/details`), {
Â  Â  Â  Â  name: name,
Â  Â  Â  Â  len: document.getElementById("inpStationLength").value,
Â  Â  Â  Â  yl: document.getElementById("inpYellowDist").value,
Â  Â  Â  Â  th: document.getElementById("inpYellowThick").value,
Â  Â  Â  Â  remarks: document.getElementById("inpRemarks").value
Â  Â  });
Â  Â  alert("Draft Saved");
};
// --- 1. HANDLE LOG LINE CHANGE (Populate Station Dropdown) ---
window.handleLogLineChange = () => {
Â  Â  const lineSel = document.getElementById("logLineSelect");
Â  Â  const stnSel = document.getElementById("logStationSelect");
Â  Â  const resultsDiv = document.getElementById("logResultsPanel");
Â  Â Â 
Â  Â  // Reset
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  resultsDiv.classList.add("hidden");

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  // Populate Stations using the existing METRO_STATIONS data
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};
window.loadSpecificStationData = async () => {
Â  Â  const stnSel = document.getElementById("logStationSelect");
Â  Â  const lineSel = document.getElementById("logLineSelect");
Â  Â  const resultsDiv = document.getElementById("logResultsPanel");
Â  Â Â 
Â  Â  // 1. IDENTIFY THE TABLE BODY CORRECTLY
Â  Â  const tbody = document.getElementById("viewTable1Body") || document.getElementById("stationDataViewBody");
Â  Â  if (!tbody) return console.error("Table Body missing!");

Â  Â  // 2. CLEAR UI & SHOW LOADING
Â  Â  tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>ğŸ” Searching Database...</td></tr>";
Â  Â  resultsDiv.classList.remove("hidden");

Â  Â  if (!stnSel.value || !lineSel.value) return;
Â  Â Â 
Â  Â  // 3. STRICT SEARCH PARAMETER
Â  Â  const searchName = `${stnSel.value} (${lineSel.value})`;Â 

Â  Â  // 4. PRECISE DATABASE QUERY
Â  Â  const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const snap = await get(q);
Â  Â  Â  Â  tbody.innerHTML = ""; // Wipe "Loading..." message
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = `<tr><td colspan='8' style='text-align:center; color:red; font-weight:bold;'>âŒ No records found for ${stnSel.value}</td></tr>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 5. RENDER ONLY MATCHING RECORDS
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Sort by Newest First
Â  Â  Â  Â  logs.sort((a, b) => b.timestamp - a.timestamp);

Â  Â  Â  Â  logs.forEach(d => {
Â  Â  Â  Â  Â  Â  Â let buttonsHtml = `<button onclick="openRakeModal('${d.key}')" class="info" style="padding:2px 6px; font-size:11px; margin-right:4px;">ğŸ“„ View Table</button>`;
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Admin & Owner Controls
Â  Â  Â  Â  Â  Â  Â if (isAdmin || d.user === currentUser.email) {
Â  Â  Â  Â  Â  Â  Â  Â  buttonsHtml += `<button class="warning" onclick="editStationLog('${d.key}')" style="padding:2px 6px; font-size:11px; margin-right:4px;">âœï¸ Edit</button>`;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  buttonsHtml += `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:2px 6px; font-size:11px;">ğŸ—‘</button>`;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const row = `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${d.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${d.userName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${d.len || '-'} m</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:#e31e24;">${d.yl || '-'} cm</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${d.th || '-'} cm</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${d.impl === 'YES' ? '<span style="color:green">âœ… YES</span>' : (d.impl === 'NO' ? '<span style="color:red">âŒ NO</span>' : '-')}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-style:italic; font-size:12px;">${d.remarks || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="white-space:nowrap;">${buttonsHtml}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  });

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  tbody.innerHTML = `<tr><td colspan='8' style='color:red;'>Connection Error: ${e.message}</td></tr>`;
Â  Â  }
};
// 2. NEW: Function to open the Rake Data in a POPUP MODAL
window.openRakeModal = async (key) => {
Â  Â  const modal = document.getElementById("rakeDataModal");
Â  Â  const tbody = document.getElementById("modalRakeBody");
Â  Â Â 
Â  Â  // Show Modal immediately
Â  Â  modal.classList.remove("hidden");
Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>â³ Fetching Rake Data...</td></tr>";

Â  Â  try {
Â  Â  Â  Â  // First get the station log to find the linkedRakeKey
Â  Â  Â  Â  const sSnap = await get(ref(db, `station_logs/${key}`));
Â  Â  Â  Â  if(!sSnap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Log not found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sData = sSnap.val();
Â  Â  Â  Â  const rakeKey = sData.linkedRakeKey || key;

Â  Â  Â  Â  // Fetch the Rake Data
Â  Â  Â  Â  const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!rSnap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#666;'>No Rake Clearance Data recorded for this entry.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Populate Modal Table
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  const rows = rSnap.val();
Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Object.values(rows).forEach(r => {
Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${count++}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${r.rake || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.type || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.f || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.r || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${r.act || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += html;
Â  Â  Â  Â  });

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
Â  Â  }
};

// 3. Ensure Close Function Exists
window.closeRakeModal = () => {
Â  Â  document.getElementById("rakeDataModal").classList.add("hidden");
};
// 2. NEW: Function to open the Rake Data in the MODAL
window.openRakeModal = async (key) => {
Â  Â  const modal = document.getElementById("rakeDataModal");
Â  Â  const tbody = document.getElementById("modalRakeBody");
Â  Â Â 
Â  Â  // Show Modal immediately
Â  Â  modal.classList.remove("hidden");
Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>â³ Fetching Rake Data...</td></tr>";

Â  Â  try {
Â  Â  Â  Â  // First get the station log to find the linkedRakeKey
Â  Â  Â  Â  const sSnap = await get(ref(db, `station_logs/${key}`));
Â  Â  Â  Â  if(!sSnap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Log not found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sData = sSnap.val();
Â  Â  Â  Â  const rakeKey = sData.linkedRakeKey || key;

Â  Â  Â  Â  // Fetch the Rake Data
Â  Â  Â  Â  const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!rSnap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#666;'>No Rake Clearance Data recorded for this entry.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Populate Modal Table
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  const rows = rSnap.val();
Â  Â  Â  Â  let count = 1;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Object.values(rows).forEach(r => {
Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${count++}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${r.rake || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.type || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.f || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.r || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${r.act || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  tbody.innerHTML += html;
Â  Â  Â  Â  });

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
Â  Â  }
};
// --- 3. SUBMIT FUNCTION (Saves Station-Wise to Master DB) ---
window.submitStationData = async () => {
Â  Â  const btn = document.getElementById("btnFinalSubmit");
Â  Â  btn.innerText = "â³ Saving to Master DB...";
Â  Â  btn.disabled = true;

Â  Â  try {
Â  Â  Â  Â  const lineSel = document.getElementById("lineSelect");
Â  Â  Â  Â  const stnSel = document.getElementById("stationSelect");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Double Check: Ensure we have a valid station selected
Â  Â  Â  Â  if (!lineSel.value || !stnSel.value) {
Â  Â  Â  Â  Â  Â  throw new Error("No station selected. Please refresh.");
Â  Â  Â  Â  }

Â  Â  Â  Â  const fullStationName = `${stnSel.value} (${lineSel.value})`;

Â  Â  Â  Â  // 2. Gather UI Inputs
Â  Â  Â  Â  const formData = {
Â  Â  Â  Â  Â  Â  name: fullStationName,
Â  Â  Â  Â  Â  Â  len: document.getElementById("inpStationLength").value,
Â  Â  Â  Â  Â  Â  yl: document.getElementById("inpYellowDist").value,
Â  Â  Â  Â  Â  Â  th: document.getElementById("inpYellowThick").value,
Â  Â  Â  Â  Â  Â  remarks: document.getElementById("inpRemarks").value,
Â  Â  Â  Â  Â  Â  impl: document.getElementById("inpImplementation").value,
Â  Â  Â  Â  Â  Â  user: currentUser.email,
Â  Â  Â  Â  Â  Â  userName: currentUser.name,
Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString(),
Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  };

Â  Â  Â  Â  // 3. Fetch Your Draft Rows (The Rake Table)
Â  Â  Â  Â  const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/rows`));
Â  Â  Â  Â  const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  let targetKey = currentStationKey;
Â  Â  Â  Â  let targetRakeKey = currentRakeKey;

Â  Â  Â  Â  // 4. Logic: Are we Updating or Creating?
Â  Â  Â  Â  if (targetKey) {
Â  Â  Â  Â  Â  Â  // --- UPDATING EXISTING MASTER RECORD ---
Â  Â  Â  Â  Â  Â  updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // --- CREATING NEW MASTER RECORD ---
Â  Â  Â  Â  Â  Â  targetKey = push(ref(db, "station_logs")).key;
Â  Â  Â  Â  Â  Â  targetRakeKey = targetKey; // Link them
Â  Â  Â  Â  Â  Â  updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
Â  Â  Â  Â  }

Â  Â  Â  Â  // 5. OVERWRITE RAKE LOGS
Â  Â  Â  Â  // We replace the Public Rake Logs with exactly what is in your Draft table
Â  Â  Â  Â  // This ensures the Master DB matches your screen exactly.
Â  Â  Â  Â  updates[`rake_logs/${targetRakeKey}`] = rowsData || null;

Â  Â  Â  Â  // 6. COMMIT TO DATABASE
Â  Â  Â  Â  await update(ref(db), updates);

Â  Â  Â  Â  // 7. CLEANUP: Delete your private draft
Â  Â  Â  Â  // This ensures your personal data doesn't persist.Â 
Â  Â  Â  Â  // The data is now fully "Station-Wise" in the shared DB.
Â  Â  Â  Â  await remove(ref(db, `drafts/${currentUser.uid}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert(`âœ… SUCCESS: Data for ${stnSel.value} saved to Master Database.`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 8. Refresh and Close
Â  Â  Â  Â  document.getElementById("distanceBody").innerHTML = "";Â 
Â  Â  Â  Â  switchTab('dataView');
Â  Â  Â  Â  loadStationData();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reset inputs to prevent accidental double submission
Â  Â  Â  Â  await nuclearReset();
Â  Â  Â  Â  document.getElementById("mainDataForm").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("stationSelect").value = "";

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("âŒ ERROR: " + e.message);
Â  Â  } finally {
Â  Â  Â  Â  btn.innerText = "âœ” Submit to Master Database";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  }
};
// 3. Ensure Close Function Exists
window.closeRakeModal = () => {
Â  Â  document.getElementById("rakeDataModal").classList.add("hidden");
};
window.editStationLog = async (key) => {
Â  Â  if (!confirm("âœï¸ Edit this record?")) return;

Â  Â  try {
Â  Â  Â  Â  // 1. Fetch Station Data
Â  Â  Â  Â  const stationSnap = await get(ref(db, `station_logs/${key}`));
Â  Â  Â  Â  if (!stationSnap.exists()) return alert("Record not found.");
Â  Â  Â  Â  const sData = stationSnap.val();

Â  Â  Â  Â  // 2. Set Global Editing Keys
Â  Â  Â  Â  currentStationKey = key;
Â  Â  Â  Â  currentRakeKey = sData.linkedRakeKey || key;

Â  Â  Â  Â  // 3. CLEAN UP DRAFTS (Fixes the "Double Rows" bug)
Â  Â  Â  Â  // We wipe the draft folder clean before loading data
Â  Â  Â  Â  await remove(ref(db, `drafts/${currentUser.uid}`));
Â  Â  Â  Â  document.getElementById("distanceBody").innerHTML = "";

Â  Â  Â  Â  // 4. Switch to Form Tab
Â  Â  Â  Â  switchTab('newData');
Â  Â  Â  Â  document.getElementById("mainDataForm").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("dataExistsWarning").classList.add("hidden"); // Hide the "Locked" warning

Â  Â  Â  Â  // 5. Fill Station Details & UNLOCK THEM
Â  Â  Â  Â  document.getElementById("inpStationName").value = sData.name;
Â  Â  Â  Â  document.getElementById("formTitle").innerText = `âœï¸ EDITING: ${sData.name}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const inpLen = document.getElementById("inpStationLength");
Â  Â  Â  Â  const inpYl = document.getElementById("inpYellowDist");
Â  Â  Â  Â  const inpTh = document.getElementById("inpYellowThick");
Â  Â  Â  Â  const inpRem = document.getElementById("inpRemarks");
Â  Â  Â  Â  const inpImpl = document.getElementById("inpImplementation");

Â  Â  Â  Â  inpLen.value = sData.len || "";
Â  Â  Â  Â  inpYl.value = sData.yl || "";
Â  Â  Â  Â  inpTh.value = sData.th || "";
Â  Â  Â  Â  inpRem.value = sData.remarks || "";
Â  Â  Â  Â  inpImpl.value = sData.impl || "";

Â  Â  Â  Â  // Unlock inputs so you can edit Yellow Line details
Â  Â  Â  Â  inpLen.disabled = false;
Â  Â  Â  Â  inpYl.disabled = false;
Â  Â  Â  Â  inpTh.disabled = false;
Â  Â  Â  Â  inpRem.disabled = false;
Â  Â  Â  Â  inpImpl.disabled = false;
Â  Â  Â  Â  document.getElementById("btnSaveDraft").disabled = false;

Â  Â  Â  Â  // 6. Update Submit Button
Â  Â  Â  Â  const submitBtn = document.getElementById("btnFinalSubmit");
Â  Â  Â  Â  submitBtn.innerText = "ğŸ’¾ Save Changes";
Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  submitBtn.style.background = "#ffc107"; // Orange
Â  Â  Â  Â  submitBtn.style.color = "#000";
Â  Â  Â  Â  submitBtn.style.cursor = "pointer";

Â  Â  Â  Â  // 7. Load Rake Data (Exactly as it is in DB)
Â  Â  Â  Â  const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
Â  Â  Â  Â  if (rakeSnap.exists()) {
Â  Â  Â  Â  Â  Â  // Copy exact DB rows to Drafts
Â  Â  Â  Â  Â  Â  await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
Â  Â  Â  Â  }

Â  Â  Â  Â  // 8. Render Table
Â  Â  Â  Â  loadDraft();

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  alert("Error loading for edit: " + e.message);
Â  Â  }
};

async function hardResetForm() {
Â  Â  // A. Wipe Visual Inputs
Â  Â  document.getElementById("inpStationLength").value = "";
Â  Â  document.getElementById("inpYellowDist").value = "";
Â  Â  document.getElementById("inpYellowThick").value = "";
Â  Â  document.getElementById("inpRemarks").value = "";
Â  Â  document.getElementById("inpImplementation").value = "";
Â  Â  document.getElementById("distanceBody").innerHTML = ""; // Clear Rake Table
Â  Â Â 
Â  Â  // B. Clear Global Key variables
Â  Â  currentStationKey = null;
Â  Â  currentRakeKey = null;

Â  Â  // C. CRITICAL: Wipe the 'Draft' node in Firebase for this user
Â  Â  // This ensures data from the previous station doesn't persist
Â  Â  if(currentUser) {
Â  Â  Â  Â  await remove(ref(db, `drafts/${currentUser.uid}`));
Â  Â  }
}
window.closeTaskModal = () => {
Â  Â  document.getElementById("adminTaskModal").classList.add("hidden");
};
window.deleteUserTask = (uid, taskKey) => {
Â  Â  if(confirm("Are you sure you want to remove this task?")) {
Â  Â  Â  Â  remove(ref(db, `assignments/${uid}/${taskKey}`))
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  // View updates automatically via listener
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(err => alert("Error: " + err.message));
Â  Â  }
};
// ==========================================
// 2. CRASH-PROOF AUTH LISTENER (GENERIC ONBOARDING)
// ==========================================
onAuthStateChanged(auth, (user) => {
Â  Â  // A. NOT LOGGED IN
Â  Â  if (!user) {Â 
Â  Â  Â  Â  showLoginScreen();Â 
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  currentUser = user;
Â  Â  startPresenceSystem(user);Â Â 

Â  Â  // B. LOGGED IN - DATA SYNC ONLY
Â  Â  const userRef = ref(db, `users/${user.uid}`);
Â  Â Â 
Â  Â  onValue(userRef, (snap) => {
Â  Â  Â  Â  const u = snap.val();

Â  Â  Â  Â  // 1. New User Detection (Still needed for first-time setup)
Â  Â  Â  Â  if (!u || !u.name) {
Â  Â  Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("nameModal").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Account Status Checks (Security)
Â  Â  Â  Â  if (u.terminated) {Â 
Â  Â  Â  Â  Â  Â  alert("ACCOUNT TERMINATED.");Â 
Â  Â  Â  Â  Â  Â  signOut(auth);Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  if (u.banned) {
Â  Â  Â  Â  Â  Â  // Handle Ban Screen UI
Â  Â  Â  Â  Â  Â  document.querySelector("header").style.display = "none";
Â  Â  Â  Â  Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById("bannedScreen").classList.remove("hidden");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById("displayBanReason").innerText = u.banReason || "Violation";
Â  Â  Â  Â  Â  Â  // ... rest of your existing ban display logic ...
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. Sync User Data (Silent Sync)
Â  Â  Â  Â  currentUser.name = u.name;
Â  Â  Â  Â  isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
Â  Â  Â  Â  document.getElementById("userInfo").innerText = `${u.name}`;

Â  Â  Â  Â  // Load Admin Tools Badge
Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  const badge = document.getElementById("adminBadge");
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnAdmin");
Â  Â  Â  Â  Â  Â  if(badge) badge.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  if(btn) btn.classList.remove("hidden");
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- THE FIX: REMOVED FACE MODAL POPUP FROM HERE ---
Â  Â  Â  Â  // This function should now only watch for background data changes
Â  Â  Â  Â  // without interrupting the user's screen.
Â  Â  Â  Â Â 
Â  Â  }, (error) => {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  signOut(auth);
Â  Â  });
});
window.removeFile = async (key) => {
Â  Â  if(!confirm("âš ï¸ PERMANENTLY DELETE this document? This leaves no mark in the database.")) return;
Â  Â  try {
Â  Â  Â  Â  // Atomic removal of the entire node
Â  Â  Â  Â  await remove(ref(db, `history/${key}`));
Â  Â  Â  Â  alert("âœ… Removed Completely.");
Â  Â  } catch(e) { alert("Error: " + e.message); }
};
// --- 2. ASSIGN TASK (Multi-User) ---
window.assignTaskMulti = async () => {
Â  Â  const descInput = document.getElementById("taskDesc");
Â  Â  const desc = descInput.value.trim();
Â  Â Â 
Â  Â  if(!desc) return alert("Please enter task instructions.");

Â  Â  // Select all checked boxes
Â  Â  const checkboxes = document.querySelectorAll('.user-check:checked');
Â  Â  if(checkboxes.length === 0) return alert("Please select at least one personnel.");

Â  Â  let count = 0;
Â  Â  const updates = {};

Â  Â  checkboxes.forEach(cb => {
Â  Â  Â  Â  const uid = cb.value;
Â  Â  Â  Â  const newKey = push(ref(db, `assignments/${uid}`)).key;
Â  Â  Â  Â Â 
Â  Â  Â  Â  updates[`assignments/${uid}/${newKey}`] = {
Â  Â  Â  Â  Â  Â  desc: desc,
Â  Â  Â  Â  Â  Â  by: currentUser.email,
Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString(),
Â  Â  Â  Â  Â  Â  status: "Pending",
Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  };
Â  Â  Â  Â  count++;
Â  Â  });

Â  Â  try {
Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  alert(`âœ… Task dispatched to ${count} users.`);
Â  Â  Â  Â  descInput.value = ""; // Clear input
Â  Â  Â  Â  checkboxes.forEach(cb => cb.checked = false); // Uncheck all
Â  Â  } catch(e) {
Â  Â  Â  Â  alert("Error assigning task: " + e.message);
Â  Â  }
};

// --- 3. TRACK WORK (View User Tasks) ---
window.viewUserTasks = (uid, name) => {
Â  Â  // Show Modal
Â  Â  document.getElementById("adminTaskModal").classList.remove("hidden");
Â  Â  document.getElementById("modalTaskUserName").innerText = decodeURIComponent(name);
Â  Â Â 
Â  Â  const tbody = document.getElementById("adminTaskBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Fetching Tasks...</td></tr>";

Â  Â  // Listen to tasks
Â  Â  onValue(ref(db, `assignments/${uid}`), (snap) => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#999;'>No active tasks.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const t = c.val();
Â  Â  Â  Â  Â  Â  const statusBadge = t.status === 'Done'Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<span style="color:green; font-weight:bold; background:#dcfce7; padding:2px 6px; border-radius:4px;">âœ” DONE</span>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  : `<span style="color:#d97706; font-weight:bold; background:#fef3c7; padding:2px 6px; border-radius:4px;">â³ PENDING</span>`;

Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="border-bottom:1px solid #f1f5f9;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${t.date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:600;">${t.desc}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${statusBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="deleteUserTask('${uid}', '${c.key}')" style="font-size:10px; padding:4px 8px;">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  });
};

// --- 4. DELETE SINGLE TASK ---
window.deleteUserTask = async (uid, taskKey) => {
Â  Â  if(confirm("Remove this task?")) {
Â  Â  Â  Â  await remove(ref(db, `assignments/${uid}/${taskKey}`));
Â  Â  }
};

// --- 5. RESET NAME (Fixes "Not Reset Name") ---
window.resetUserName = async (uid) => {
Â  Â  if(confirm("âš ï¸ Reset Name?\n\nThe user will be forced to set their 'Official Name' again on next login.")) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${uid}`), { name: null });
Â  Â  Â  Â  Â  Â  alert("âœ… Name Reset. User must re-enter it.");
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};

// --- 6. RESET FACE (Fixes "Not Reset Face") ---
window.resetUserFace = async (uid) => {
Â  Â  if(confirm("âš ï¸ Reset Face ID?\n\nThis deletes their biometric data. They must re-register their face to access the system.")) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${uid}`), { faceData: null });
Â  Â  Â  Â  Â  Â  alert("âœ… Face ID Wiped. User must re-register.");
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};

// --- 7. CLOSE TASK MODAL ---
window.closeTaskModal = () => {
Â  Â  document.getElementById("adminTaskModal").classList.add("hidden");
};
// ==============================================
//Â  Â  Â  Â  Â  Â  FULL BAN SYSTEM LOGIC
// ==============================================

let currentBanTargetUid = null;
let currentBanDays = 0; // Stores days OR 'CUSTOM'

// 1. OPEN MODAL
window.openBanModal = (uid, encodedName) => {
Â  Â  if(!isAdmin) return alert("Admins Only.");
Â  Â  if(uid === currentUser.uid) return alert("You cannot ban yourself.");
Â  Â Â 
Â  Â  currentBanTargetUid = uid;
Â  Â  document.getElementById("banTargetName").innerText = decodeURIComponent(encodedName);
Â  Â  document.getElementById("adminBanModal").classList.remove("hidden");
Â  Â Â 
Â  Â  // Reset Form
Â  Â  document.getElementById("banReasonInput").selectedIndex = 0;
Â  Â  toggleBanOtherInput(); // Hide 'Other' input
Â  Â  document.getElementById("banReasonOther").value = "";
Â  Â  document.getElementById("banActionInput").value = "";
Â  Â  document.getElementById("banRemarks").value = "";
Â  Â  document.getElementById("banCustomDate").value = "";
Â  Â Â 
Â  Â  // Reset Buttons
Â  Â  currentBanDays = 0;
Â  Â  document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
};

// 2. CLOSE MODAL
window.closeBanModal = () => {
Â  Â  document.getElementById("adminBanModal").classList.add("hidden");
Â  Â  currentBanTargetUid = null;
};

// 4. SUBMIT BAN (MAIN FUNCTION)
window.submitBan = async () => {
Â  Â  if(!currentBanTargetUid) return;

Â  Â  // --- STEP A: REASON VALIDATION ---
Â  Â  let reason = document.getElementById("banReasonInput").value;
Â  Â  if(reason === "Other") {
Â  Â  Â  Â  const otherText = document.getElementById("banReasonOther").value.trim();
Â  Â  Â  Â  if(!otherText) return alert("Please specify the 'Other' reason details.");
Â  Â  Â  Â  reason = "Other: " + otherText;
Â  Â  }

Â  Â  // --- STEP B: ACTION VALIDATION ---
Â  Â  const actionInst = document.getElementById("banActionInput").value.trim();
Â  Â  if(!actionInst) return alert("Please enter 'Action Required' (How to dispose this matter).");

Â  Â  // --- STEP C: DEADLINE CALCULATION ---
Â  Â  let expiryTimestamp = 0;
Â  Â Â 
Â  Â  if(currentBanDays === 'CUSTOM') {
Â  Â  Â  Â  const dateVal = document.getElementById("banCustomDate").value;
Â  Â  Â  Â  if(!dateVal) return alert("Please select a Deadline Date.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Set expiry to the END of that day (23:59:59)
Â  Â  Â  Â  const d = new Date(dateVal);
Â  Â  Â  Â  d.setHours(23, 59, 59, 999);
Â  Â  Â  Â  expiryTimestamp = d.getTime();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Sanity check: Date cannot be in the past
Â  Â  Â  Â  if(expiryTimestamp < Date.now()) return alert("Deadline cannot be in the past.");
Â  Â  }Â 
Â  Â  else if (typeof currentBanDays === 'number' && currentBanDays > 0) {
Â  Â  Â  Â  // Calculate future timestamp: Now + (Days * ms)
Â  Â  Â  Â  expiryTimestamp = Date.now() + (currentBanDays * 24 * 60 * 60 * 1000);
Â  Â  }Â 
Â  Â  else {
Â  Â  Â  Â  return alert("Please select a valid Tenure/Deadline.");
Â  Â  }

Â  Â  const remarks = document.getElementById("banRemarks").value;
Â  Â  const deadlineDateString = new Date(expiryTimestamp).toLocaleDateString();

Â  Â  // --- STEP D: CONFIRMATION ---
Â  Â  if(confirm(`âš  CONFIRM BAN?\n\nUser: ${document.getElementById("banTargetName").innerText}\nReason: ${reason}\nDeadline: ${deadlineDateString}\n\nIf the user does not resolve this by the deadline, they will be permanently locked out.`)) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Update User Profile
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${currentBanTargetUid}`), {
Â  Â  Â  Â  Â  Â  Â  Â  banned: true,
Â  Â  Â  Â  Â  Â  Â  Â  banReason: reason,
Â  Â  Â  Â  Â  Â  Â  Â  banAction: actionInst,
Â  Â  Â  Â  Â  Â  Â  Â  banExpires: expiryTimestamp,
Â  Â  Â  Â  Â  Â  Â  Â  banRemarks: remarks,
Â  Â  Â  Â  Â  Â  Â  Â  banDate: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  bannedBy: currentUser.email
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Log to System
Â  Â  Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  Â  Â  type: "USER_BAN",
Â  Â  Â  Â  Â  Â  Â  Â  user: "System",
Â  Â  Â  Â  Â  Â  Â  Â  details: `Banned UID: ${currentBanTargetUid}`,
Â  Â  Â  Â  Â  Â  Â  Â  reason: `${reason} | Deadline: ${deadlineDateString}`,
Â  Â  Â  Â  Â  Â  Â  Â  approvedBy: currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  time: serverTimestamp()
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  alert("âœ… User Banned Successfully.");
Â  Â  Â  Â  Â  Â  closeBanModal();
Â  Â  Â  Â  Â  Â  loadAdminPanel(); // Refresh list
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("Database Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};
window.unbanUser = async (uid, name) => {
Â  Â  if(!isAdmin) return alert("Admins Only.");
Â  Â Â 
Â  Â  if(confirm(`ğŸŸ¢ Restore access for ${name}?`)) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // We set fields to null to DELETE them from the database
Â  Â  Â  Â  Â  Â  await update(ref(db, `users/${uid}`), {
Â  Â  Â  Â  Â  Â  Â  Â  banned: null,
Â  Â  Â  Â  Â  Â  Â  Â  banReason: null,
Â  Â  Â  Â  Â  Â  Â  Â  banExpires: null
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  alert("âœ… User Unbanned Successfully.");
Â  Â  Â  Â  Â  Â  // Table updates automatically via listener
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  alert("Error: " + e.message);
Â  Â  Â  Â  }
Â  Â  }
};
window.switchTab = (t) => {
Â  Â  // 1. SECURITY & UI RESET: Force hide the report preview immediately when switching tabs
Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  if (reportContainer) {
Â  Â  Â  Â  reportContainer.classList.add("hidden");
Â  Â  Â  Â  // Clear innerHTML to prevent the "shadow" of old invoices appearing
Â  Â  Â  Â  reportContainer.innerHTML = "";Â 
Â  Â  }

Â  Â  // 2. DEFINE ALL TABS: Added 'warranty' to the list to ensure it's handled
Â  Â  const allTabs = [
Â  Â  Â  Â  'newData', 'inventory', 'gallery', 'assigned', 'adminPanel',Â 
Â  Â  Â  Â  'dataView', 'printReport', 'funds', 'purchase', 'comments',Â 
Â  Â  Â  Â  'directives', 'billing', 'warranty'
Â  Â  ];

Â  Â  // 3. HIDE ALL TAB DIVS
Â  Â  allTabs.forEach(x => {
Â  Â  Â  Â  const el = document.getElementById(`tab-${x}`);
Â  Â  Â  Â  if(el) el.classList.add("hidden");
Â  Â  });

Â  Â  // 4. RESET NAVIGATION BUTTON STATES
Â  Â  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

Â  Â  // 5. SHOW THE TARGET TAB
Â  Â  const targetTab = document.getElementById(`tab-${t}`);
Â  Â  if(targetTab) {
Â  Â  Â  Â  targetTab.classList.remove("hidden");
Â  Â  } else {
Â  Â  Â  Â  console.error(`Tab 'tab-${t}' not found in HTML structure.`);
Â  Â  }

Â  Â  // 6. ACTIVATE THE CORRESPONDING NAV BUTTON
Â  Â  const activeBtn = document.getElementById('btn' + t.charAt(0).toUpperCase() + t.slice(1));
Â  Â  if(activeBtn) {
Â  Â  Â  Â  activeBtn.classList.add("active");
Â  Â  }

Â  Â  // 7. TRIGGER DATA LOADERS BASED ON TAB SELECTION
Â  Â  if (t === 'funds') {
Â  Â  Â  Â  loadFinanceData();
Â  Â  } else if (t === 'purchase') {
Â  Â  Â  Â  loadPurchaseData();
Â  Â  } else if (t === 'dataView') {
Â  Â  Â  Â  loadStationData();
Â  Â  } else if (t === 'comments') {
Â  Â  Â  Â  populateCommentUsers();
Â  Â  } else if (t === 'directives') {
Â  Â  Â  Â  populateDirectiveUsers();
Â  Â  } else if (t === 'billing') {
Â  Â  Â  Â  populateBillingAssets();
Â  Â  } else if (t === 'warranty') {
Â  Â  Â  Â  toggleWarMode('dash');
Â  Â  }

Â  Â  // 8. SCROLL TO TOP: Ensures user doesn't stay at the bottom if the previous tab was long
Â  Â  window.scrollTo(0, 0);
};

// Paste these two new functions below the switchTab function:
async function populateDirectiveUsers() {
Â  Â  const list = document.getElementById("dirUserCheckboxList");
Â  Â  if(!list) return;
Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "users"));
Â  Â  Â  Â  list.innerHTML = "";
Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const uName = c.val().name || c.val().email;
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="dir-user-check" value="${uName}"> ${uName}</label>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch (e) { console.error(e); }
}
window.generateDirectivePrint = function() {
Â  Â  const type = document.getElementById("dirType").value;
Â  Â  const content = document.getElementById("dirText").value;
Â  Â  const authority = document.getElementById("selDirAuthority").value;
Â  Â  const selectedUsers = Array.from(document.querySelectorAll('.dir-user-check:checked')).map(cb => cb.value);
Â  Â Â 
Â  Â  if (selectedUsers.length === 0 || !content) return alert("Please select recipients and enter the letter content.");

Â  Â  const now = new Date();
Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  const isCorrespondence = (type === "OFFICIAL CORRESPONDENCE");

Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; cursor:pointer; border-radius:8px; margin-left:10px;">PRINT DOCUMENT</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="font-family: 'Times New Roman', serif !important; background:white; color:black;">
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  @media print { @page { size: A4; margin: 0; } .no-print { display: none !important; } .a4-max-wrapper { width: 100% !important; padding: 15mm !important; } }
Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; box-sizing: border-box; text-align: center; }
Â  Â  Â  Â  Â  Â  Â  Â  .header-line { border-bottom: 12pt solid #000; padding-bottom: 30px; margin-bottom: 35px; }
Â  Â  Â  Â  Â  Â  Â  Â  .project-title { font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; }
Â  Â  Â  Â  Â  Â  Â  Â  .college-name { font-size: 26pt; font-weight: 900; margin-top: 20px; line-height: 1.4; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  .max-label { font-size: 28pt; text-decoration: underline; display: block; margin-top: 35px; text-align: left; font-weight: bold; }
Â  Â  Â  Â  Â  Â  Â  Â  .max-value { font-size: 38pt; font-weight: 900; display: block; border-bottom: 6pt solid #000; padding-bottom: 10px; text-align: left; word-wrap: break-word; overflow: visible; }
Â  Â  Â  Â  Â  Â  Â  Â  .heavy-bar { background: #000 !important; color: #fff !important; padding: 25px; font-size: 44pt; margin: 60px 0 35px 0; text-transform: uppercase; -webkit-print-color-adjust: exact; font-weight: 900; }
Â  Â  Â  Â  Â  Â  Â  Â  .content-body { font-size: 42pt; font-weight: 900; padding: 20px 0; text-align: left; line-height: 1.3; white-space: pre-wrap; word-wrap: break-word; }
Â  Â  Â  Â  Â  Â  </style>

Â  Â  Â  Â  Â  Â  <div class="header-line">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INSTITUTE OF ENGINEERING AND MANAGEMENT<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:5px;">UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; border: 8pt solid #000; margin-top: 30px; padding: 12px 25px; font-weight: 900; display: inline-block; text-transform: uppercase;">${type}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 25px;">DATE: ${now.toLocaleDateString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  <span class="max-label">TO PERSONNEL / FACULTY:</span>
Â  Â  Â  Â  Â  Â  <span class="max-value">${selectedUsers.join(", ").toUpperCase()}</span>
Â  Â  Â  Â  Â  Â  <div class="heavy-bar">SUBJECT / DESCRIPTION</div>
Â  Â  Â  Â  Â  Â  <div class="content-body">${content.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 140px; border-top: 10pt solid #000; width: 65%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 42pt; font-weight: 900;">${authority.split('(')[0].toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 26pt; font-weight: bold;">${authority.includes("Soham") ? "PRINCIPAL" : "CO-PRINCIPAL"} INVESTIGATOR</div>
Â  Â  Â  Â  Â  Â  Â  Â  ${isCorrespondence ? '' : '<div style="font-size: 28pt; font-weight: 900;">APPROVING AUTHORITY (MRPSP)</div>'}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  reportContainer.classList.remove("hidden");
Â  Â  window.scrollTo(0, 0);
};
window.handleCommentLineChange = () => {
Â  Â  const line = document.getElementById("commentLineSelect").value;
Â  Â  const stnSel = document.getElementById("commentStationSelect");
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  if (line && METRO_STATIONS[line]) {
Â  Â  Â  Â  METRO_STATIONS[line].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn; opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  }
};
// Dropdown Logic for Comment Tab
window.handleCommentLineChange = () => {
Â  Â  const line = document.getElementById("commentLineSelect").value;
Â  Â  const stnSel = document.getElementById("commentStationSelect");
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  if (line && METRO_STATIONS[line]) {
Â  Â  Â  Â  METRO_STATIONS[line].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn; opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  }
};

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

// --- 1. HELPER TO OPEN BIG IMAGE ---
window.openBigPhoto = (url) => {
Â  Â  const modal = document.getElementById("bigImageModal");
Â  Â  const img = document.getElementById("bigImageViewer");
Â  Â Â 
Â  Â  // Set the image source
Â  Â  img.src = url;
Â  Â Â 
Â  Â  // Show the modal
Â  Â  modal.classList.remove("hidden");
};

// --- 2. UPDATED LOAD GALLERY FUNCTION ---
function loadGallery() {
Â  Â  const div = document.getElementById("galleryContainer");
Â  Â  div.innerHTML = "<p style='text-align:center; width:100%;'>Loading images...</p>";

Â  Â  // Clean up old listener
Â  Â  if (galleryListener) { try { off(ref(db, "history")); } catch(e){} galleryListener = null; }

Â  Â  const line = document.getElementById("galleryLineSelect").value;
Â  Â  const stn = document.getElementById("galleryStationSelect").value;
Â  Â Â 
Â  Â  if(!line || !stn) { div.innerHTML = ""; return; }
Â  Â Â 
Â  Â  const targetName = `${stn} (${line})`;
Â  Â  const q = query(ref(db, "history"), orderByChild("stationName"), equalTo(targetName));

Â  Â  galleryListener = onValue(q, snap => {
Â  Â  Â  Â  div.innerHTML = "";
Â  Â  Â  Â  if(!snap.exists()) { div.innerHTML = "<p style='text-align:center; width:100%; color:#888;'>No photos found.</p>"; return; }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  let media = "";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- IMAGE LOGIC: CLICK TO OPEN BIG ---
Â  Â  Â  Â  Â  Â  if(v.fileType && v.fileType.includes("image")) {
Â  Â  Â  Â  Â  Â  Â  Â  media = `
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${v.fileData}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onclick="openBigPhoto('${v.fileData}')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="cursor:zoom-in; width:100%; height:140px; object-fit:cover; border-radius:4px; border:1px solid #ccc; transition: transform 0.2s;"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onmouseover="this.style.transform='scale(1.03)'"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onmouseout="this.style.transform='scale(1)'"
Â  Â  Â  Â  Â  Â  Â  Â  >`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  media = `<div style="height:140px; background:#eee; display:flex; align-items:center; justify-content:center; color:#555;">ğŸ“„ Document</div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- ADMIN CONTROLS (Only Admin sees Download/Delete) ---
Â  Â  Â  Â  Â  Â  let footer = `<div style="margin-top:5px; text-align:center; font-size:10px; color:#aaa;">(Click to Zoom)</div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  footer = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:5px; display:flex; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${v.fileData}" download="Evidence.jpg" class="info" style="flex:1; text-decoration:none; text-align:center; padding:5px; font-size:11px; background:#0A2342; color:white; border-radius:3px;">â¬‡ Save</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="removeFile('${c.key}')" style="padding:5px; font-size:11px; border-radius:3px;">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- RENDER CARD ---
Â  Â  Â  Â  Â  Â  div.innerHTML += `
Â  Â  Â  Â  Â  Â  <div class="gallery-item" style="background:white; padding:10px; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
Â  Â  Â  Â  Â  Â  Â  Â  ${media}
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:11px; margin-top:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <b>${v.name}</b>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:10px; color:#666;">By: ${v.userName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  ${footer}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  });
Â  Â  });
}
window.removeFile = (k) => {
Â  Â  if(confirm("Remove attached file?")) {
Â  Â  Â  Â  update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
Â  Â  }
}

async function clearPreviousSession() {
Â  Â  // A. Stop listening to the old station's draft
Â  Â  if (draftRef) { off(draftRef); draftRef = null; }
Â  Â Â 
Â  Â  // B. Wipe Global IDs
Â  Â  currentStationKey = null;
Â  Â  currentRakeKey = null;

Â  Â  // C. Wipe UI Inputs
Â  Â  document.getElementById("inpStationLength").value = "";
Â  Â  document.getElementById("inpYellowDist").value = "";
Â  Â  document.getElementById("inpYellowThick").value = "";
Â  Â  document.getElementById("inpRemarks").value = "";
Â  Â  document.getElementById("inpImplementation").value = "";
Â  Â Â 
Â  Â  // D. Wipe Table
Â  Â  document.getElementById("distanceBody").innerHTML = "";

Â  Â  // E. Wipe Draft Node in Database (Prevents data crossover)
Â  Â  if(currentUser) {
Â  Â  Â  Â  await set(ref(db, `drafts/${currentUser.uid}`), null);
Â  Â  }
}
function renderRow(k, v, i) {
Â  Â  const b = document.getElementById("distanceBody");
Â  Â Â 
Â  Â  // Helper to check which option was previously saved
Â  Â  const isSel = (val) => (v.type === val ? "selected" : "");

Â  Â  b.innerHTML += `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:bold;">${i}</td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.rake}" onchange="upRow('${k}','rake',this.value)" placeholder="Type _ if empty">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <select style="width:100%; padding:5px; font-weight:bold; border:1px solid #ced4da; border-radius:3px;" onchange="upRow('${k}','type',this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" ${isSel("")}>-- Select Type --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="BHEL RAKE (300 SERIES)" ${isSel("BHEL RAKE (300 SERIES)")}>BHEL RAKE (300 SERIES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="MEDHA RAKE (400 SERIES)" ${isSel("MEDHA RAKE (400 SERIES)")}>MEDHA RAKE (400 SERIES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="DALIAN RAKE (500 SERIES)" ${isSel("DALIAN RAKE (500 SERIES)")}>DALIAN RAKE (500 SERIES)</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.f}" onchange="upRow('${k}','f',this.value)" placeholder="_">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input style="width:100%" value="${v.r}" onchange="upRow('${k}','r',this.value)" placeholder="_">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="delRow('${k}')" style="padding:5px 10px;">X</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
}
// --- LOAD INVENTORY (STABLE VERSION) ---
function loadInventory() {
Â  Â  const b = document.getElementById("inventoryBody");
Â  Â  const summaryEl = document.getElementById("stockSummaryText");
Â  Â  if(!b) return;

Â  Â  onValue(ref(db, "inventory"), snap => {
Â  Â  Â  Â  b.innerHTML = "";
Â  Â  Â  Â  let total = 0, available = 0;

Â  Â  Â  Â  if(!snap.exists()) {
Â  Â  Â  Â  Â  Â  b.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:20px;'>Empty Stock / Database Syncing...</td></tr>";
Â  Â  Â  Â  Â  Â  if(summaryEl) summaryEl.innerText = "Total: 0 | Available: 0";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val(), k = c.key;
Â  Â  Â  Â  Â  Â  total++;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const isSold = v.status === "Sold Out";
Â  Â  Â  Â  Â  Â  if(!isSold && v.status !== "Checked Out") available++;

Â  Â  Â  Â  Â  Â  // STATUS UI STYLING
Â  Â  Â  Â  Â  Â  let statusStyle = "background:#dcfce7; color:#166534;";Â 
Â  Â  Â  Â  Â  Â  if(v.status === "Checked Out") statusStyle = "background:#fef3c7; color:#d97706;";
Â  Â  Â  Â  Â  Â  if(isSold) statusStyle = "background:#000; color:#fff; border: 1px solid #333;";

Â  Â  Â  Â  Â  Â  // --- RE-STOCK OPTION DELETED FROM HERE ---
Â  Â  Â  Â  Â  Â  // Only Edit (if not sold) and Delete (if admin) remain.
Â  Â  Â  Â  Â  Â  const editBtn = isSold ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<button disabled style="opacity:0.3; cursor:not-allowed; padding:2px 6px; font-size:10px;">EDIT</button>` :Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<button class="warning" onclick="editExistingItem('${k}')" style="padding:2px 6px; font-size:10px;">EDIT</button>`;

Â  Â  Â  Â  Â  Â  const deleteBtn = (isAdmin && !isSold) ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<button class="danger" onclick="delInv('${k}')" style="padding:2px 6px; font-size:10px; margin-left:4px;">DEL</button>` : "";

Â  Â  Â  Â  Â  Â  const soldDateStr = v.soldAt ? new Date(v.soldAt).toLocaleDateString('en-IN') : "-";
Â  Â  Â  Â  Â  Â  const invoiceLabel = v.invoiceNo ? `<div style="font-size:9px; color:#64748b; font-family:monospace; margin-top:2px;">ğŸ“œ ID: ${v.invoiceNo}</div>` : "";
Â  Â  Â  Â  Â  Â  const stationLabel = v.assignedStation ? `<div style="color:#B91C1C; font-weight:bold; font-size:10px; margin-top:2px;">ğŸ“ ${v.assignedStation}</div>` : "";

Â  Â  Â  Â  Â  Â  b.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr class="stock-row" data-invoice="${v.invoiceNo || ''}" style="${isSold ? 'background:#f1f5f9; color:#64748b;' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; font-weight:bold;">${v.barcode || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${v.item}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${invoiceLabel}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${v.usageCount || 0}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${stationLabel || v.holder || '-'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isSold ? `<div style="font-size:9px; font-weight:normal; color:#444; margin-top:2px;">Sold: ${soldDateStr}</div>` : ""}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px; font-weight:bold;">${v.location || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; font-weight:900; color:green;">â‚¹ ${parseFloat(v.purchasePrice || 0).toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="${statusStyle} padding:3px 8px; border-radius:12px; font-size:10px; font-weight:bold; text-transform:uppercase;">${v.status}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; white-space:nowrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${editBtn}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${deleteBtn}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });

Â  Â  Â  Â  if(summaryEl) {
Â  Â  Â  Â  Â  Â  summaryEl.innerHTML = `Total Assets: ${total} | <span style="color:green; font-weight:bold;">Ready for Use: ${available}</span>`;
Â  Â  Â  Â  }
Â  Â  });
}
Â  // --- RE-STOCK FUNCTION: BRING BACK SOLD ITEMS WITHIN 7 DAYS ---
window.revertSale = async (key, itemName) => {
Â  Â  const snap = await get(ref(db, `inventory/${key}`));
Â  Â  const v = snap.val();
Â  Â  const oldInvoice = v.invoiceNo || "N/A";
Â  Â  const oldStation = v.assignedStation || "Unknown Site";

Â  Â  const returnReason = prompt(`REASON FOR RETURN?\nItem: ${itemName}\nOriginal Invoice: ${oldInvoice}\n\nPlease enter the specific reason:`);
Â  Â Â 
Â  Â  if(!returnReason) return alert("Operation Cancelled: A reason is required.");

Â  Â  if(!confirm(`RESTORE TO INVENTORY?\nReason: ${returnReason}\n\nProceed to wipe Invoice data and generate Return Note?`)) return;

Â  Â  try {
Â  Â  Â  Â  await update(ref(db, `inventory/${key}`), {
Â  Â  Â  Â  Â  Â  status: "In Stock",
Â  Â  Â  Â  Â  Â  holder: "Store",
Â  Â  Â  Â  Â  Â  location: "D2 Building - Heerok Sir Lab [Returned]",
Â  Â  Â  Â  Â  Â  soldAt: null,
Â  Â  Â  Â  Â  Â  invoiceNo: null,Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  assignedStation: nullÂ Â 
Â  Â  Â  Â  });

Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  type: "ITEM_RESTOCKED",
Â  Â  Â  Â  Â  Â  item: itemName,
Â  Â  Â  Â  Â  Â  originalInvoice: oldInvoice,
Â  Â  Â  Â  Â  Â  reason: returnReason,
Â  Â  Â  Â  Â  Â  time: serverTimestamp(),
Â  Â  Â  Â  Â  Â  by: currentUser.name || currentUser.email
Â  Â  Â  Â  });

Â  Â  Â  Â  alert("âœ… Item Restored. Generating Official Return Note...");

Â  Â  Â  Â  // Trigger updated Return Note Printout with RECEIVER terminology
Â  Â  Â  Â  generateReturnPrintout(itemName, v.barcode, oldInvoice, oldStation, returnReason);

Â  Â  } catch(e) {
Â  Â  Â  Â  alert("Restoration Failed: " + e.message);
Â  Â  }
};
Â  window.processAssetRecovery = async (tagId) => {
Â  Â  // Standardize input
Â  Â  const tag = tagId ? tagId.trim() : "";
Â  Â  const reason = document.getElementById("recoveryReason").value.trim();
Â  Â  const statusDiv = document.getElementById("recoveryStatus");

Â  Â  // 1. Validation
Â  Â  if(!tag) return alert("Please Scan a Tag or Enter ID manually.");
Â  Â  if(!reason) return alert("Please enter a Return Reason first.");

Â  Â  statusDiv.innerHTML = "â³ Verifying Asset: " + tag;
Â  Â  statusDiv.style.color = "var(--metro-blue)";

Â  Â  try {
Â  Â  Â  Â  // 2. Database Query
Â  Â  Â  Â  const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(tag));
Â  Â  Â  Â  const snap = await get(q);

Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "âŒ Error: Tag ID not found.";
Â  Â  Â  Â  Â  Â  return alert("Tag ID '" + tag + "' is not registered in the system.");
Â  Â  Â  Â  }

Â  Â  Â  Â  let key, item;
Â  Â  Â  Â  snap.forEach(c => { key = c.key; item = c.val(); });

Â  Â  Â  Â  // 3. Status Gate: Only recover items that are "Sold Out"
Â  Â  Â  Â  if (item.status !== "Sold Out") {
Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = "âŒ Error: Item is already in stock.";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. Update Inventory Node
Â  Â  Â  Â  await update(ref(db, `inventory/${key}`), {
Â  Â  Â  Â  Â  Â  status: "In Stock",
Â  Â  Â  Â  Â  Â  holder: "Store",
Â  Â  Â  Â  Â  Â  location: "Recovered: " + reason,
Â  Â  Â  Â  Â  Â  soldAt: null,
Â  Â  Â  Â  Â  Â  invoiceNo: null,
Â  Â  Â  Â  Â  Â  assignedStation: null,
Â  Â  Â  Â  Â  Â  // Keep protectionActivated: true to maintain dashboard counts
Â  Â  Â  Â  });

Â  Â  Â  Â  // 5. Log for Audit Trail
Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  type: "ITEM_RECOVERED",
Â  Â  Â  Â  Â  Â  item: item.item,
Â  Â  Â  Â  Â  Â  barcode: tag,
Â  Â  Â  Â  Â  Â  originalInvoice: item.invoiceNo || "N/A",
Â  Â  Â  Â  Â  Â  reason: reason,
Â  Â  Â  Â  Â  Â  time: serverTimestamp(),
Â  Â  Â  Â  Â  Â  by: currentUser.name || currentUser.email
Â  Â  Â  Â  });

Â  Â  Â  Â  statusDiv.innerHTML = `âœ… SUCCESS: ${item.item} recovered. Generating Memo...`;
Â  Â  Â  Â  statusDiv.style.color = "green";

Â  Â  Â  Â  // 6. Generate and Show the Return Memo
Â  Â  Â  Â  // This function was provided in the previous step
Â  Â  Â  Â  generateReturnPrintout(item.item, tag, item.invoiceNo || "N/A", item.assignedStation || "Site", reason);

Â  Â  Â  Â  // 7. UI Cleanup
Â  Â  Â  Â  const manualInp = document.getElementById("manualRecoveryTag");
Â  Â  Â  Â  if(manualInp) manualInp.value = "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update Dashboard Protected Counter
Â  Â  Â  Â  if (typeof refreshWarDash === "function") refreshWarDash();

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  statusDiv.innerHTML = "âŒ System Error: " + e.message;
Â  Â  }
};
// Helper function to generate the Return Note
function generateReturnPrintout(name, tag, inv, site, reason) {
Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  const now = new Date();
Â  Â  const receiverName = (currentUser.name || 'System Auditor').toUpperCase();
Â  Â Â 
Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; cursor:pointer; border-radius:8px; margin-left:10px;">PRINT RETURN RECEIPT</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="font-family: 'Times New Roman', serif !important; background:white; color:black;">
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  @media print { @page { size: A4; margin: 0; } .a4-max-wrapper { width: 100% !important; padding: 15mm !important; } }
Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; box-sizing: border-box; text-align: center; }
Â  Â  Â  Â  Â  Â  Â  Â  .header-line { border-bottom: 12pt solid #000; padding-bottom: 30px; margin-bottom: 35px; }
Â  Â  Â  Â  Â  Â  Â  Â  .project-title { font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; }
Â  Â  Â  Â  Â  Â  Â  Â  .college-name { font-size: 26pt; font-weight: 900; margin-top: 15px; line-height: 1.2; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  .max-label { font-size: 28pt; text-decoration: underline; display: block; margin-top: 30px; text-align: left; font-weight: bold; }
Â  Â  Â  Â  Â  Â  Â  Â  .max-value { font-size: 38pt; font-weight: 900; display: block; border-bottom: 6pt solid #000; padding-bottom: 10px; text-align: left; word-wrap: break-word; }
Â  Â  Â  Â  Â  Â  </style>

Â  Â  Â  Â  Â  Â  <div class="header-line">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  METRO RAILWAY<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  PLATFORM SAFETY PROJECT
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INSTITUTE OF ENGINEERING AND MANAGEMENT<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  UNIVERSITY OF ENGINEERING AND MANAGEMENT
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; border: 8pt solid #000; margin-top: 30px; padding: 12px 25px; font-weight: 900; display: inline-block; background: #000 !important; color: #fff !important; -webkit-print-color-adjust: exact; text-transform: uppercase;">Goods Return Note</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 25px;">REF INVOICE: <span style="font-family: monospace;">${inv}</span></div>
Â  Â  Â  Â  Â  Â  <span class="max-label">RETURNED FROM SITE:</span><span class="max-value">${site.toUpperCase()}</span>
Â  Â  Â  Â  Â  Â  <span class="max-label">ITEM DESCRIPTION:</span><span class="max-value">${name.toUpperCase()}</span>
Â  Â  Â  Â  Â  Â  <span class="max-label">ASSET TAG (QR):</span><span class="max-value" style="font-family: monospace;">${tag}</span>
Â  Â  Â  Â  Â  Â  <span class="max-label">RETURN REASON:</span><span class="max-value" style="font-style: italic; border-bottom: none;">${reason.toUpperCase()}</span>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 140px; border-top: 10pt solid #000; width: 65%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 42pt; font-weight: 900;">${receiverName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 28pt; font-weight: 900;">AUTHORIZED RECEIVER / SIGNATORY</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 70px; font-size: 16pt; text-align: center; border-top: 3pt dashed #000; padding-top: 20px; font-weight: bold; text-transform: uppercase;">Certified: Item Restored to Master Inventory Database</div>
Â  Â  Â  Â  </div>`;
Â  Â  reportContainer.classList.remove("hidden");Â 
Â  Â  window.scrollTo(0, 0);
}
// --- OPEN FORM FOR NEW ASSET ---
window.openNewAssetForm = () => {
Â  Â  resetInvForm();
Â  Â  toggleInvMode('add');
};

// --- PREPARE FORM FOR EDITING ---
window.editExistingItem = async (key) => {
Â  Â  const snap = await get(ref(db, `inventory/${key}`));
Â  Â  const d = snap.val();

Â  Â  toggleInvMode('add');
Â  Â Â 
Â  Â  document.getElementById("editItemKey").value = key;
Â  Â  document.getElementById("invBarcode").value = d.barcode || "";
Â  Â  document.getElementById("invName").value = d.item || "";
Â  Â  document.getElementById("invRegPrice").value = d.purchasePrice || 0;
Â  Â Â 
Â  Â  // Clean location parsing (removes bracketed spot for inputs)
Â  Â  const locParts = (d.location || "").split(" [");
Â  Â  document.getElementById("addLocSelect").value = locParts[0] || "Other";
Â  Â  document.getElementById("addLocSpot").value = locParts[1] ? locParts[1].replace("]", "") : "";

Â  Â  document.getElementById("invFormTitle").innerHTML = "<i class='fas fa-edit'></i> Update Asset Information";
Â  Â  document.getElementById("btnAddStock").innerText = "CONFIRM CHANGES";
Â  Â  document.getElementById("btnCancelEdit").classList.remove("hidden");
Â  Â  window.scrollTo(0, 0);
};

// --- RESET FORM UI ---
window.resetInvForm = () => {
Â  Â  document.getElementById("editItemKey").value = "";
Â  Â  document.getElementById("invBarcode").value = "";
Â  Â  document.getElementById("invName").value = "";
Â  Â  document.getElementById("invRegPrice").value = "";
Â  Â  document.getElementById("addLocSpot").value = "";
Â  Â  document.getElementById("invFormTitle").innerHTML = "<i class='fas fa-plus-circle'></i> Register New Asset";
Â  Â  document.getElementById("btnAddStock").innerText = "SAVE ASSET RECORD";
Â  Â  document.getElementById("btnCancelEdit").classList.add("hidden");
};

// --- SAVE / UPDATE LOGIC ---
window.addUniqueItem = async () => {
Â  Â  const key = document.getElementById("editItemKey").value;
Â  Â  const barcode = document.getElementById("invBarcode").value.trim();
Â  Â  const name = document.getElementById("invName").value.trim();
Â  Â  const price = parseFloat(document.getElementById("invRegPrice").value) || 0;
Â  Â  const loc = document.getElementById("addLocSelect").value + " [" + document.getElementById("addLocSpot").value + "]";

Â  Â  if(!name || !barcode) return alert("Tag ID and Asset Name are required.");

Â  Â  const itemData = {
Â  Â  Â  Â  barcode: barcode,
Â  Â  Â  Â  item: name,
Â  Â  Â  Â  purchasePrice: price,
Â  Â  Â  Â  location: loc,
Â  Â  Â  Â  updatedAt: serverTimestamp()
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  if(key) {
Â  Â  Â  Â  Â  Â  // MODE: UPDATE
Â  Â  Â  Â  Â  Â  await update(ref(db, `inventory/${key}`), itemData);
Â  Â  Â  Â  Â  Â  alert("âœ… Record Updated.");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // MODE: NEW
Â  Â  Â  Â  Â  Â  itemData.status = "In Stock";
Â  Â  Â  Â  Â  Â  itemData.holder = "Store";
Â  Â  Â  Â  Â  Â  itemData.usageCount = 0;
Â  Â  Â  Â  Â  Â  await push(ref(db, "inventory"), itemData);
Â  Â  Â  Â  Â  Â  alert("âœ… New Asset Added.");
Â  Â  Â  Â  }
Â  Â  Â  Â  resetInvForm();
Â  Â  Â  Â  toggleInvMode('list');
Â  Â  } catch(e) { alert("Save Error: " + e.message); }
};
window.filterStockTable = () => {
Â  Â  const input = document.getElementById("mainStockSearch").value.trim().toLowerCase();
Â  Â  const rows = document.getElementsByClassName("stock-row");

Â  Â  Array.from(rows).forEach(row => {
Â  Â  Â  Â  const barcode = row.cells[0].innerText.toLowerCase();
Â  Â  Â  Â  const name = row.cells[1].innerText.toLowerCase();
Â  Â  Â  Â  const station = row.cells[3].innerText.toLowerCase();
Â  Â  Â  Â  const invoice = row.getAttribute("data-invoice") ? row.getAttribute("data-invoice").toLowerCase() : "";

Â  Â  Â  Â  // Show row if input matches Tag, Name, Station, or Invoice No.
Â  Â  Â  Â  if (name.includes(input) || barcode.includes(input) || station.includes(input) || invoice.includes(input)) {
Â  Â  Â  Â  Â  Â  row.style.display = "";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  row.style.display = "none";
Â  Â  Â  Â  }
Â  Â  });
};
Â  // Dropdown Logic for Comment Tab
window.handleCommentLineChange = () => {
Â  Â  const line = document.getElementById("commentLineSelect").value;
Â  Â  const stnSel = document.getElementById("commentStationSelect");
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  if (line && METRO_STATIONS[line]) {
Â  Â  Â  Â  METRO_STATIONS[line].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = stn; opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  }
};
window.printStationComment = function () {
Â  Â  const station = document.getElementById("commentStationSelect").value;
Â  Â  const corridor = document.getElementById("commentLineSelect").value;
Â  Â  const comment = document.getElementById("commentTextInput").value;
Â  Â  let inspector = document.getElementById("selCommentInspector").value;
Â  Â  const authority = document.getElementById("selCommentAuthority").value;

Â  Â  if (!station || !comment) {
Â  Â  Â  Â  alert("Please select station and enter comment.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const getTitle = (name) => {
Â  Â  Â  Â  if (name && name.includes("Soham Pal")) return "PRINCIPAL INVESTIGATOR";
Â  Â  Â  Â  if (name && name.includes("Heerok Banerjee")) return "CO-PRINCIPAL INVESTIGATOR";
Â  Â  Â  Â  return "";
Â  Â  };

Â  Â  const inspectorTitle = getTitle(inspector);
Â  Â  const authorityTitle = getTitle(authority);
Â  Â  const now = new Date();
Â  Â  const date = now.toLocaleDateString('en-IN');
Â  Â  const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
Â  Â Â 
Â  Â  // RESTORED: Footer timestamp logic
Â  Â  const printTimestamp = now.toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });

Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â Â 
Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0 0 10px 0;">Official A4 Comment Preview</h3>
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()" style="margin-right:10px;">CLOSE PREVIEW</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 30px; font-weight:bold; font-size:22px; cursor:pointer; border-radius:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-print"></i> GENERATE DOCUMENT
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="report-paper a4-max-wrapper">
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  @page { size: A4; margin: 0; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body { margin: 0; padding: 0; background: #fff !important; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .no-print { display: none !important; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 100% !important; border: none !important; box-shadow: none !important; margin: 0 !important; padding: 5mm !important; }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width: 210mm; min-height: 297mm; margin: 0 auto !important; padding: 8mm !important;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background: white !important; font-family: "Times New Roman", Times, serif !important;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: #000 !important; line-height: 1.1 !important; box-sizing: border-box; text-align: center !important;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  .header-box { border-bottom: 14pt solid #000 !important; padding-bottom: 25px !important; margin-bottom: 35px !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .title-main { font-size: 62pt !important; font-weight: 900; text-transform: uppercase !important; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  .title-sub { font-size: 38pt !important; font-weight: 900; line-height: 1.2 !important; margin-top: 15px !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .max-label { font-size: 38pt !important; text-decoration: underline !important; display: block !important; margin-top: 35px !important; text-align: left !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .max-value { font-size: 48pt !important; font-weight: 900 !important; display: block !important; word-wrap: break-word !important; border-bottom: 7pt solid #000 !important; padding-bottom: 12px !important; text-align: left !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .heavy-bar { background: #000 !important; color: #fff !important; padding: 25px !important; font-size: 52pt !important; margin: 60px 0 40px 0 !important; text-transform: uppercase !important; -webkit-print-color-adjust: exact !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .comment-body { font-size: 48pt !important; font-weight: 900 !important; padding: 30px 0 !important; word-wrap: break-word !important; text-align: left !important; line-height: 1.4; }
Â  Â  Â  Â  Â  Â  Â  Â  .sig-box-name { margin-top: 130px !important; border-top: 12pt solid #000 !important; padding-top: 25px !important; font-size: 56pt !important; font-weight: 900; text-align: left !important; line-height: 1; }
Â  Â  Â  Â  Â  Â  Â  Â  .sig-investigator-title { font-size: 36pt !important; font-weight: bold; text-align: left !important; margin-bottom: 15px; }
Â  Â  Â  Â  Â  Â  Â  Â  .sig-box-desc { font-size: 40pt !important; font-weight: 900 !important; text-transform: uppercase !important; margin-bottom: 100px !important; text-align: left !important; }
Â  Â  Â  Â  Â  Â  Â  Â  .footer-stamp { margin-top: 50px; font-size: 14pt !important; text-align: center; border-top: 3pt dashed #000; padding-top: 20px; font-weight: bold; }
Â  Â  Â  Â  Â  Â  </style>

Â  Â  Â  Â  Â  Â  <div class="header-box">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title-main">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title-sub">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><br>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 44pt; border: 8pt solid #000; margin-top: 40px; padding: 20px; font-weight: 900; display: inline-block;">OFFICIAL COMMENT RECORD</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <span class="max-label">SITE:</span><span class="max-value">${station}</span>
Â  Â  Â  Â  Â  Â  <span class="max-label">DATE & TIME:</span><span class="max-value">${date} | ${time}</span>
Â  Â  Â  Â  Â  Â  <span class="max-label">CORRIDOR:</span><span class="max-value">${corridor}</span>

Â  Â  Â  Â  Â  Â  <div class="heavy-bar">REMARKS / OBSERVATIONS</div>
Â  Â  Â  Â  Â  Â  <div class="comment-body">${comment}</div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 140px;">
Â  Â  Â  Â  Â  Â  Â  Â  ${inspector && inspector !== "" && inspector !== "Self" ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="sig-box-name">${inspector}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${inspectorTitle ? `<div class="sig-investigator-title">(${inspectorTitle})</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="sig-box-desc">CONDUCTING OFFICER</div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sig-box-name">${authority.split('(')[0]}</div>
Â  Â  Â  Â  Â  Â  Â  Â  ${authorityTitle ? `<div class="sig-investigator-title">(${authorityTitle})</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sig-box-desc">APPROVING AUTHORITY</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="footer-stamp">
Â  Â  Â  Â  Â  Â  Â  Â  SYSTEM GENERATED RECORD | PRINTED ON: ${printTimestamp}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;

Â  Â  reportContainer.classList.remove("hidden");
Â  Â  window.scrollTo(0, 0);
};
async function populateCommentUsers() {
Â  Â  const sel = document.getElementById("selCommentInspector");Â 
Â  Â  if(!sel) return;

Â  Â  // Reset list and add current user as default
Â  Â  const currentName = currentUser.name || currentUser.email;
Â  Â  sel.innerHTML = `<option value="${currentName}">Self (${currentName})</option>`;

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "users"));
Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const u = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  const uName = u.name || u.email;
Â  Â  Â  Â  Â  Â  Â  Â  if(uName !== currentName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.value = uName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.innerText = uName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch (e) {Â 
Â  Â  Â  Â  console.error("Database error fetching officers:", e);Â 
Â  Â  }
}
window.loadPurchaseData = () => {
Â  Â  const formPanel = document.getElementById("purchaseFormPanel");
Â  Â  if(formPanel) formPanel.classList.remove("hidden");

Â  Â  const tbody = document.getElementById("purchaseTableBody");
Â  Â  if(!tbody) return;
Â  Â  tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>â³ Syncing Procurement Data...</td></tr>";

Â  Â  const theadRow = document.querySelector("#tab-purchase thead tr");
Â  Â  if(theadRow) {
Â  Â  Â  Â  let headerHTML = `<th>Sl</th><th>Product Details</th><th>Vendor & Order ID</th><th>Qty</th><th>Unit Price</th><th>Total</th><th>Status</th>`;
Â  Â  Â  Â  if(isAdmin) headerHTML += `<th>Action</th>`;
Â  Â  Â  Â  theadRow.innerHTML = headerHTML;
Â  Â  }

Â  Â  if(window.purchaseListener) { try{ off(ref(db, "finance")); }catch(e){} }

Â  Â  window.purchaseListener = onValue(ref(db, "finance"), (snap) => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  Â  Â  let sl = 1;
Â  Â  Â  Â  Â  Â  const txs = [];

Â  Â  Â  Â  Â  Â  if(snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(val) txs.push({ key: c.key, ...val });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Sort: Newest First
Â  Â  Â  Â  Â  Â  txs.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

Â  Â  Â  Â  Â  Â  txs.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(t.type === 'DEBIT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Legacy Status Support
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentStatus = t.status || 'Approved';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prodName = t.productName || t.desc || "Legacy Item";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const amount = parseFloat(t.amount) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- 1. STATUS BADGES ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let statusBadge = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rowColor = "";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentStatus === 'Pending') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusBadge = `<span style="background:#fef3c7; color:#d97706; padding:3px 8px; border-radius:10px; font-weight:bold; font-size:10px;">â³ Pending</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rowColor = "background:#fffbf0;";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentStatus === 'Rejected') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusBadge = `<span style="background:#fee2e2; color:#991b1b; padding:3px 8px; border-radius:10px; font-weight:bold; font-size:10px;">ğŸš« Denied</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rowColor = "background:#fff5f5; opacity: 0.7;";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusBadge = `<span style="background:#dcfce7; color:#166534; padding:3px 8px; border-radius:10px; font-weight:bold; font-size:10px;">âœ… Approved</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- 2. ACTION BUTTONS ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionCell = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(currentStatus === 'Pending') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // PENDING: Show Approve, Deny, Edit, Delete
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionCell = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="display:flex; gap:2px; flex-wrap:wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="approvePurchase('${t.key}')" title="Approve" style="padding:4px; font-size:12px; background:#15803d; color:white; border:none; border-radius:3px; cursor:pointer;">âœ…</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="denyPurchase('${t.key}')" title="Deny" style="padding:4px; font-size:12px; background:#64748b; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸš«</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="editPurchase('${t.key}')" title="Edit" style="padding:4px; font-size:12px; background:#d97706; color:white; border:none; border-radius:3px; cursor:pointer;">âœ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deletePurchase('${t.key}')" title="Delete" style="padding:4px; font-size:12px; background:#B91C1C; color:white; border:none; border-radius:3px; cursor:pointer;">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // DONE/REJECTED: Show Edit, Delete
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionCell = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="editPurchase('${t.key}')" class="warning" style="padding:4px 8px; font-size:10px; background:#d97706; color:white; margin-right:5px;">âœ Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deletePurchase('${t.key}')" class="danger" style="padding:4px 8px; font-size:10px; background:#B91C1C; color:white;">ğŸ—‘ Delete</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="${rowColor}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${sl++}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${prodName}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.platform || '-'}<br><small style="color:#666">${t.orderId || t.mode || '-'}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.qty || 1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.unitPrice || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:var(--metro-red); font-weight:bold;">â‚¹ ${amount.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${statusBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionCell}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += row;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (rowErr) { console.warn("Skipping bad purchase row", rowErr); }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(tbody.innerHTML === "") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center; color:#999;'>No purchase records found.</td></tr>";

Â  Â  Â  Â  } catch (globalErr) { console.error(globalErr); }
Â  Â  });
};
// --- APPROVE: Deducts Fund ---
window.approvePurchase = async (key) => {
Â  Â  if(!confirm("âœ… Approve this purchase?\n\nThis will deduct funds from the Balance Sheet.")) return;
Â  Â  try {
Â  Â  Â  Â  await update(ref(db, `finance/${key}`), { status: "Approved" });
Â  Â  Â  Â  alert("Purchase Approved.");
Â  Â  } catch(e) { alert("Error: " + e.message); }
};

// --- DENY: Marks as Rejected (No Deduction) ---
window.denyPurchase = async (key) => {
Â  Â  if(!confirm("ğŸš« Deny/Reject this request?\n\nIt will remain in history but NOT affect the budget.")) return;
Â  Â  try {
Â  Â  Â  Â  await update(ref(db, `finance/${key}`), { status: "Rejected" });
Â  Â  } catch(e) { alert("Error: " + e.message); }
};

// --- DELETE: Removes Completely ---
window.deletePurchase = async (key) => {
Â  Â  if(confirm("ğŸ—‘ PERMANENTLY DELETE this record?\n\nThis cannot be undone.")) {
Â  Â  Â  Â  await remove(ref(db, `finance/${key}`));
Â  Â  }
};
// --- NEW: DELETE PURCHASE ---
window.deletePurchase = async (key) => {
Â  Â  if(confirm("âš  Delete this purchase entry?\n\nThe amount will be credited back to the available balance.")) {
Â  Â  Â  Â  await remove(ref(db, `finance/${key}`));
Â  Â  }
};
window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
Â  Â  onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
Â  Â  Â  Â  const list = document.getElementById("taskList"); list.innerHTML = "";
Â  Â  Â  Â  if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const t = c.val();
Â  Â  Â  Â  Â  Â  const div = document.createElement("div"); div.className = "panel";
Â  Â  Â  Â  Â  Â  div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #d97706";
Â  Â  Â  Â  Â  Â  div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')" class="success">Mark Done</button>` : 'Completed'}`;
Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  });
Â  Â  });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });
window.debugConnection = async () => {
Â  Â  console.log("ğŸ“¡ Testing Network Connection...");

Â  Â  try {
Â  Â  Â  Â  // We try to read 1 log.Â 
Â  Â  Â  Â  // If logged out, this WILL fail with "Permission denied".
Â  Â  Â  Â  const testRef = query(ref(db, "station_logs"), limitToLast(1));
Â  Â  Â  Â  await get(testRef);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // If we get here, it means we are logged in and connected
Â  Â  Â  Â  console.log("âœ… Database Connected (Authenticated)");

Â  Â  } catch (e) {
Â  Â  Â  Â  // CHECK: Is this a security rule error?
Â  Â  Â  Â  if (e.message.toLowerCase().includes("permission denied") ||Â 
Â  Â  Â  Â  Â  Â  e.code === "PERMISSION_DENIED") {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // This is actually a SUCCESS result for connectivity.
Â  Â  Â  Â  Â  Â  // It means we reached the server, but were (correctly) blocked.
Â  Â  Â  Â  Â  Â  console.log("âœ… Database Connected (Waiting for Login)");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Real network errors (like offline) usually say "Client is offline"
Â  Â  Â  Â  Â  Â  console.warn("âš ï¸ Connection Check:", e.message);
Â  Â  Â  Â  }
Â  Â  }
};

// Run automatically on load
setTimeout(debugConnection, 3000);

// Run automatically on load
setTimeout(debugConnection, 3000);
// Run automatically on load
setTimeout(debugConnection, 3000);
// Run automatically on load
setTimeout(debugConnection, 3000);
Â  // --- ADMIN BYPASS LOGIC FOR SOHAM PAL / TERMINAL PCS ---
window.triggerAdminBypass = () => {
Â  Â  // Show the OTP/PIN UI that already exists in your HTML
Â  Â  document.getElementById("videoContainer").classList.add("hidden");
Â  Â  document.getElementById("camControls").classList.add("hidden");
Â  Â  document.getElementById("otpUI").classList.remove("hidden");
Â  Â  document.getElementById("modalTitle").innerText = "Admin Security Bypass";
Â  Â  document.getElementById("modalDesc").innerText = "Camera unavailable. Enter Master Authorization PIN.";
Â  Â  updateStatus("Bypass Mode Active", "orange");
};

// Update your existing verifyOTP function or replace it with this smarter version
window.verifyOTP = async () => {
Â  Â  const input = document.getElementById("otpInput").value;
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  // Fetch the one true PIN from the system settings node
Â  Â  Â  Â  const snap = await get(ref(db, "system_settings/master_pin"));
Â  Â  Â  Â  const systemPin = snap.exists() ? snap.val() : "1234"; // Default only if DB is empty
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (input === systemPin) {
Â  Â  Â  Â  Â  Â  updateStatus("âœ… AUTHORIZED", "#00ff00");
Â  Â  Â  Â  Â  Â  await recordLogin("Manual PIN Bypass");
Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  Â  Â  document.getElementById("otpInput").value = "";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("âŒ Access Denied: Incorrect PIN.");
Â  Â  Â  Â  Â  Â  document.getElementById("otpInput").value = "";
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Security Error: " + e.message);
Â  Â  }
};
// --- UPDATED BILLING ENGINE WITH TWO-TABLE TEMPLATE ---
// --- RETAIL BILLING SYSTEM ENGINE ---
window.billCart = [];
window.serviceCart = [];
window.toggleBillStationSource = () => {
Â  Â  const type = document.getElementById("billClientType").value;
Â  Â  const metroGroup = document.getElementById("divBillMetroGroup");
Â  Â  const manualGroup = document.getElementById("divBillStationManual");

Â  Â  if (type === "METRO") {
Â  Â  Â  Â  metroGroup.style.display = "contents";
Â  Â  Â  Â  manualGroup.classList.add("hidden");
Â  Â  } else {
Â  Â  Â  Â  metroGroup.style.display = "none";
Â  Â  Â  Â  manualGroup.classList.remove("hidden");
Â  Â  }
};

window.handleBillLineChange = () => {
Â  Â  const lineSel = document.getElementById("billLineSelect");
Â  Â  const stnSel = document.getElementById("billMetroStation");
Â  Â Â 
Â  Â  stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
Â  Â  stnSel.disabled = true;
Â  Â  stnSel.style.background = "#f1f5f9";

Â  Â  const selectedLine = lineSel.value;
Â  Â Â 
Â  Â  if (selectedLine && METRO_STATIONS[selectedLine]) {
Â  Â  Â  Â  METRO_STATIONS[selectedLine].forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = `${stn} (${selectedLine})`;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  stnSel.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  stnSel.disabled = false;
Â  Â  Â  Â  stnSel.style.background = "#fff";
Â  Â  }
};
// Function to populate the billing dropdown with ALL stations
function populateAllMetroStations() {
Â  Â  const sel = document.getElementById("billMetroStation");
Â  Â  if(!sel) return;
Â  Â  sel.innerHTML = "<option value=''>-- Select Metro Station --</option>";
Â  Â Â 
Â  Â  // Loop through the existing METRO_STATIONS object defined in your code
Â  Â  for (const [line, stations] of Object.entries(METRO_STATIONS)) {
Â  Â  Â  Â  const group = document.createElement("optgroup");
Â  Â  Â  Â  group.label = line;
Â  Â  Â  Â  stations.forEach(stn => {
Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  opt.value = `${stn} (${line})`;
Â  Â  Â  Â  Â  Â  opt.innerText = stn;
Â  Â  Â  Â  Â  Â  group.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â  sel.appendChild(group);
Â  Â  }
}
// Run this once when billing tab is opened
// Fix for ReferenceError: Defining globally
window.populateBillingAssets = async () => {
Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  Â  Â  const sel = document.getElementById("billAssetSelect");
Â  Â  Â  Â  if(sel) {
Â  Â  Â  Â  Â  Â  sel.innerHTML = "<option value=''>-- Select Item --</option>";
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = v.barcode;
Â  Â  Â  Â  Â  Â  Â  Â  opt.text = v.item;
Â  Â  Â  Â  Â  Â  Â  Â  opt.dataset.purchase = v.purchasePrice || 0;
Â  Â  Â  Â  Â  Â  Â  Â  sel.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch(e) { console.error("Billing Load Error:", e); }
};

// Convert Total Amount to Indian Currency Words
function numberToWords(num) {
Â  Â  const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
Â  Â  const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
Â  Â  const numStr = Math.round(num).toString();
Â  Â  if (numStr.length > 9) return 'Amount too large';
Â  Â  let n = ('000000000' + numStr).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
Â  Â  if (!n) return '';Â 
Â  Â  let str = '';
Â  Â  str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
Â  Â  str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
Â  Â  str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
Â  Â  str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
Â  Â  str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
Â  Â  return str + 'Rupees Only';
}
window.addScannedItemToBill = async () => {
Â  Â  const barcode = document.getElementById("billBarcodeInp").value.trim();
Â  Â  if(!barcode) return alert("Scan Asset Tag");

Â  Â  const isAlreadyInCart = window.billCart.some(item => item.tag === barcode);
Â  Â  if(isAlreadyInCart) return alert("This item is already in the current Invoice.");

Â  Â  try {
Â  Â  Â  Â  const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(barcode));
Â  Â  Â  Â  const snap = await get(q);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!snap.exists()) return alert("Tag ID Not Found in Inventory.");

Â  Â  Â  Â  let itemKey, itemData;
Â  Â  Â  Â  snap.forEach(c => { itemKey = c.key; itemData = c.val(); });

Â  Â  Â  Â  if(itemData.status === "Sold Out") return alert(`DENIED: Item already SOLD.`);
Â  Â  Â  Â  if(itemData.status === "Checked Out") return alert(`DENIED: Item is Checked Out.`);

Â  Â  Â  Â  // --- UPDATED PROFIT MARGIN: 30% ---
Â  Â  Â  Â  const sellRate = (parseFloat(itemData.purchasePrice) || 0) * 1.30;Â 

Â  Â  Â  Â  window.billCart.push({
Â  Â  Â  Â  Â  Â  name: itemData.item,Â 
Â  Â  Â  Â  Â  Â  tag: barcode,Â 
Â  Â  Â  Â  Â  Â  dbKey: itemKey,Â 
Â  Â  Â  Â  Â  Â  qty: 1,Â 
Â  Â  Â  Â  Â  Â  rate: sellRate,Â 
Â  Â  Â  Â  Â  Â  net: sellRate
Â  Â  Â  Â  });

Â  Â  Â  Â  renderBillCartUI();
Â  Â  Â  Â  document.getElementById("billBarcodeInp").value = "";
Â  Â  } catch (e) { console.error(e); }
};
window.finalizeSaleRecords = async (targetStation) => {
Â  Â  // ALLOW PROCEEDING if either Assets OR Services exist
Â  Â  if(window.billCart.length === 0 && window.serviceCart.length === 0) return null;

Â  Â  const invoiceNo = "MRPSP-INV-" + Date.now();Â 
Â  Â  const clientType = document.getElementById("billClientType").value;
Â  Â  const recipient = (clientType === "METRO") ? "KOLKATA METRO RAILWAY" : (document.getElementById("billCustName").value || "UNSPECIFIED");

Â  Â  const updates = {};
Â  Â  const saleTime = Date.now();

Â  Â  // Only attempt to update inventory if there are assets in the cart
Â  Â  if (window.billCart.length > 0) {
Â  Â  Â  Â  window.billCart.forEach(it => {
Â  Â  Â  Â  Â  Â  if(it.dbKey) {
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${it.dbKey}/status`] = "Sold Out";
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${it.dbKey}/soldAt`] = saleTime;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${it.dbKey}/invoiceNo`] = invoiceNo;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${it.dbKey}/assignedStation`] = targetStation;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${it.dbKey}/holder`] = targetStation;
Â  Â  Â  Â  Â  Â  Â  Â  updates[`inventory/${it.dbKey}/location`] = "DEEP INSTALLED";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  if (Object.keys(updates).length > 0) {
Â  Â  Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Log the sale (whether it was assets, services, or both)
Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  type: "SALE_FINALIZED",
Â  Â  Â  Â  Â  Â  invoice: invoiceNo,
Â  Â  Â  Â  Â  Â  assignedStation: targetStation,
Â  Â  Â  Â  Â  Â  billedTo: recipient,
Â  Â  Â  Â  Â  Â  itemCount: window.billCart.length,
Â  Â  Â  Â  Â  Â  serviceCount: window.serviceCart.length,
Â  Â  Â  Â  Â  Â  time: saleTime,
Â  Â  Â  Â  Â  Â  by: currentUser.name || currentUser.email
Â  Â  Â  Â  });

Â  Â  Â  Â  return invoiceNo;
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Critical DB Error: " + e.message);
Â  Â  Â  Â  return null;
Â  Â  }
};
function renderBillCartUI() {
Â  Â  const tbody = document.getElementById("billCartBody");
Â  Â  if(!tbody) return;
Â  Â  tbody.innerHTML = "";
Â  Â Â 
Â  Â  let grand = 0;

Â  Â  // 1. Render Asset Rows
Â  Â  window.billCart.forEach((it, i) => {
Â  Â  Â  Â  grand += it.net;
Â  Â  Â  Â  const row = document.createElement("tr");
Â  Â  Â  Â  row.style.borderBottom = "1px solid #000";
Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  <td style="padding:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:bold;">${it.name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:#64748b;">Tag: ${it.tag}</small>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${it.qty}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:right;">${it.rate.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:right; font-weight:bold;">${it.net.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" style="padding:4px 8px; cursor:pointer;" onclick="removeFromCart('asset', ${i})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-trash-alt"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbody.appendChild(row);
Â  Â  });

Â  Â  // 2. Render Service Rows
Â  Â  window.serviceCart.forEach((sv, i) => {
Â  Â  Â  Â  grand += sv.net;
Â  Â  Â  Â  const row = document.createElement("tr");
Â  Â  Â  Â  row.style.background = "#f8fafc";
Â  Â  Â  Â  row.style.borderBottom = "1px solid #000";
Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  <td style="padding:12px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:900; color:var(--metro-blue);">SERVICE: ${sv.desc}</div>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:bold;">1</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:right; font-family:monospace;">${sv.price.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:right; font-weight:900;">${sv.net.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" style="padding:4px 8px; cursor:pointer;" onclick="removeFromCart('service', ${i})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-trash-alt"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbody.appendChild(row);
Â  Â  });

Â  Â  // 3. Empty State
Â  Â  if(window.billCart.length === 0 && window.serviceCart.length === 0) {
Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:30px; color:#94a3b8;'>Scan assets or add services to begin billing.</td></tr>";
Â  Â  }

Â  Â  // 4. Update Totals
Â  Â  const totalVal = grand.toFixed(2);
Â  Â  document.getElementById("billGrandTotalDisp").innerText = totalVal;
Â  Â  document.getElementById("billWordsDisp").innerText = numberToWords(grand);
}

// Add this new helper function to handle the deletion safely
window.removeFromCart = (type, index) => {
Â  Â  if (type === 'asset') {
Â  Â  Â  Â  window.billCart.splice(index, 1);
Â  Â  } else {
Â  Â  Â  Â  window.serviceCart.splice(index, 1);
Â  Â  }
Â  Â  renderBillCartUI(); // Refresh the UI immediately
};
// Updated Print Function with increased Font Sizes
window.generateInvoicePrint = async function() {
Â  Â  // 1. Validation
Â  Â  if(window.billCart.length === 0 && window.serviceCart.length === 0) {
Â  Â  Â  Â  return alert("âš ï¸ ERROR: Cannot generate empty bill. Please scan an asset or add a service charge.");
Â  Â  }

Â  Â  const clientType = document.getElementById("billClientType").value;
Â  Â  let targetStation = (clientType === "METRO") ? document.getElementById("billMetroStation").value : document.getElementById("billCustName").value;

Â  Â  if(!targetStation) return alert("Please select a target station or enter Customer Name.");

Â  Â  // 2. Finalize Database Records
Â  Â  const invoiceNo = await finalizeSaleRecords(targetStation);
Â  Â  if(!invoiceNo) return;

Â  Â  let billRows = "";
Â  Â  let billTotal = 0;Â 

Â  Â  // 3. Combine Assets and Services
Â  Â  const combinedItems = [
Â  Â  Â  Â  ...window.billCart.map(it => ({name: it.name.toUpperCase(), tag: it.tag, rate: it.rate, qty: it.qty, net: it.net})),
Â  Â  Â  Â  ...window.serviceCart.map(sv => ({name: "SERVICE: " + sv.desc.toUpperCase(), tag: "SERVICE", rate: sv.price, qty: 1, net: sv.net}))
Â  Â  ];

Â  Â  combinedItems.forEach(it => {
Â  Â  Â  Â  const roundedNet = Math.round(it.net);
Â  Â  Â  Â  billTotal += roundedNet;Â 
Â  Â  Â  Â  billRows += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 25px 10px; font-size: 32pt; font-weight: 900; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.name}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 18pt; color: #444; font-weight: bold;">(REF ID: ${it.tag})</span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; padding: 25px 10px; font-size: 30pt;">${it.rate.toFixed(0)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; padding: 25px 10px; font-size: 30pt;">${it.qty}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; padding: 25px 10px; font-weight: 900; font-size: 32pt;">${roundedNet}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  // 4. Inject into Report Container
Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  const now = new Date();
Â  Â Â 
Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:20px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <h2 style="color:var(--metro-blue);">Official Invoice Preview</h2>
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CANCEL & CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 50px; font-weight:bold; font-size:24px; cursor:pointer; border-radius:8px; margin-left:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-print"></i> PRINT INVOICE
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="background:white; color:black; font-family:'Times New Roman', serif;">
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  @media print {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  @page { size: A4; margin: 0; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .no-print { display: none !important; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 100% !important; padding: 10mm !important; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 10mm; box-sizing: border-box; }
Â  Â  Â  Â  Â  Â  Â  Â  .header-line { border-bottom: 12pt solid #000; padding-bottom: 30px; margin-bottom: 35px; text-align: center; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  /* UNIFIED PROJECT TITLE STYLE */
Â  Â  Â  Â  Â  Â  Â  Â  .project-title { font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  .college-name { font-size: 26pt; font-weight: 900; margin-top: 15px; line-height: 1.2; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  .meta-row { font-size: 32pt; font-weight: 900; border-bottom: 6pt solid #000; padding: 18pt 0; text-align: left; }
Â  Â  Â  Â  Â  Â  Â  Â  .total-bar { background: #000; color: #fff; padding: 25px; font-size: 50pt; font-weight: 900; display: flex; justify-content: space-between; margin-top: 30px; -webkit-print-color-adjust: exact; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  /* Borderless Table Style */
Â  Â  Â  Â  Â  Â  Â  Â  .invoice-table { width: 100%; border-collapse: collapse; margin-top: 50px; }
Â  Â  Â  Â  Â  Â  Â  Â  .invoice-table th { border-bottom: 10pt solid #000; padding: 15px 10px; font-size: 28pt; text-align: left; font-weight: 900; }
Â  Â  Â  Â  Â  Â  Â  Â  .invoice-table td { border-bottom: 1pt solid #ddd; } /* Faint line for alignment guidance */
Â  Â  Â  Â  Â  Â  </style>

Â  Â  Â  Â  Â  Â  <div class="header-line">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  METRO RAILWAY<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  PLATFORM SAFETY PROJECT
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  INSTITUTE OF ENGINEERING AND MANAGEMENT<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  UNIVERSITY OF ENGINEERING AND MANAGEMENT
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; border: 8pt solid #000; margin-top: 35px; padding: 12px 25px; display: inline-block; font-weight: 900; text-transform: uppercase;">TAX INVOICE</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 40px; font-family: monospace;">INV NO: ${invoiceNo}</div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>DATE:</b> ${now.toLocaleDateString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>BILLED TO:</b> ${targetStation.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>ISSUED BY:</b> ${currentUser.name.toUpperCase()}</div>

Â  Â  Â  Â  Â  Â  <table class="invoice-table">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background: #eee; -webkit-print-color-adjust: exact;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align: left;">PARTICULARS</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align: right;">RATE</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align: center;">QTY</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align: right;">TOTAL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${billRows}
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>

Â  Â  Â  Â  Â  Â  <div class="total-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <span>GRAND TOTAL:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>â‚¹ ${billTotal.toLocaleString('en-IN')}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="text-align:left; font-size: 22pt; font-style: italic; margin-top: 20px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Amount in words: ${numberToWords(billTotal)}
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 140px; border-top: 10pt solid #000; width: 65%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 42pt; font-weight: 900;">${currentUser.name.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 28pt; font-weight: 900;">AUTHORIZED SIGNATORY (MRPSP)</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 80px; border-top: 3pt dashed #000; padding-top: 20px; font-size: 16pt; text-align: center; font-weight: bold; text-transform: uppercase;">
Â  Â  Â  Â  Â  Â  Â  Â  Certified Official Record | System Authenticated Invoice
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;

Â  Â  // 5. Reset App UI
Â  Â  window.billCart = [];Â 
Â  Â  window.serviceCart = [];Â 
Â  Â  renderBillCartUI();
Â  Â  reportContainer.classList.remove("hidden");Â 
Â  Â  window.scrollTo(0, 0);
};
// Dedicated function for Service Block insertion
window.addServiceOnlyToBill = () => {
Â  Â  const extraAmt = parseFloat(document.getElementById("billAddl").value) || 0;
Â  Â  const extraDesc = document.getElementById("billAddlDesc").value.trim();

Â  Â  if (extraAmt <= 0 || extraDesc === "") {
Â  Â  Â  Â  return alert("âš  Please enter Service Description and Charge Amount.");
Â  Â  }

Â  Â  window.serviceCart.push({ desc: extraDesc, price: extraAmt, qty: 1, net: extraAmt });
Â  Â  renderBillCartUI();
Â  Â  document.getElementById("billAddl").value = 0;
Â  Â  document.getElementById("billAddlDesc").value = "";
Â  Â  alert("âœ… Service Applied.");
};
// =========================================================
// ğŸ›¡ï¸ UPDATED WARRANTY ENGINE: DATE-BASED ACTIVATION
// =========================================================

// 1. Core Logic: Prioritizes Manual Start Date over Sale Date
function calculateWarranty(saleDateTs, durationMonths, manualStartDate = null) {
Â  Â  // Use manual date if provided, otherwise fallback to sale date
Â  Â  const baseDate = manualStartDate ? new Date(manualStartDate) : (saleDateTs ? new Date(saleDateTs) : null);
Â  Â Â 
Â  Â  if(!baseDate || !durationMonths) return null;
Â  Â Â 
Â  Â  const startDate = new Date(baseDate);
Â  Â  const expiryDate = new Date(baseDate);
Â  Â  expiryDate.setMonth(expiryDate.getMonth() + parseInt(durationMonths));
Â  Â Â 
Â  Â  const today = new Date();
Â  Â  const diffTime = expiryDate - today;
Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â Â 
Â  Â  const totalTenureDays = Math.ceil((expiryDate - startDate) / (1000 * 60 * 60 * 24));
Â  Â Â 
Â  Â  return {
Â  Â  Â  Â  start: startDate.toLocaleDateString('en-IN'),
Â  Â  Â  Â  expiry: expiryDate.toLocaleDateString('en-IN'),
Â  Â  Â  Â  totalDays: totalTenureDays,
Â  Â  Â  Â  daysLeft: diffDays > 0 ? diffDays : 0,
Â  Â  Â  Â  expired: diffDays <= 0
Â  Â  };
}

// 2. Navigation Controller
window.toggleWarMode = (mode) => {
Â  Â  // 1. List ALL sub-panels here to ensure they are hidden by default
Â  Â  const panels = ['dash', 'setup', 'sales', 'claim', 'active', 'recovery', 'claims-list', 'tech-terminal'];Â 
Â  Â Â 
Â  Â  panels.forEach(m => {
Â  Â  Â  Â  const el = document.getElementById(`war-${m}`);
Â  Â  Â  Â  if(el) el.classList.add('hidden');
Â  Â  });
Â  Â Â 
Â  Â  // 2. Show only the one you clicked
Â  Â  const target = document.getElementById(`war-${mode}`);
Â  Â  if(target) {
Â  Â  Â  Â  target.classList.remove('hidden');
Â  Â  }

Â  Â  // 3. Trigger specific loaders
Â  Â  if(mode === 'dash') refreshWarDash();
Â  Â  if(mode === 'setup') loadWarSetup();
Â  Â  if(mode === 'sales') loadWarSales();
Â  Â  if(mode === 'active') loadActiveWarranty();
Â  Â  if(mode === 'claims-list') loadWarrantyClaims();
Â  Â  // No specific loader needed for tech-terminal until scan happens
};

// 3. Updated Save Logic: Stores Manual Start Date instead of Signatory
window.saveWarrantyConfig = async () => {
Â  Â  const tag = document.getElementById("warSetupTag").value.trim();
Â  Â  const type = document.getElementById("warProductType").value;
Â  Â  let duration = parseInt(document.getElementById("warDuration").value) || 0;
Â  Â  const unit = document.getElementById("warUnit").value;
Â  Â  const startDateVal = document.getElementById("warStartDate").value;

Â  Â  if(!tag) return alert("Please enter Asset Tag ID.");

Â  Â  try {
Â  Â  Â  Â  const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(tag));
Â  Â  Â  Â  const snap = await get(q);
Â  Â  Â  Â  if(!snap.exists()) return alert("âŒ Error: Tag ID not found.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  let key; snap.forEach(c => key = c.key);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const finalMonths = (type === "WARRANTY" && unit === "Years") ? duration * 12 : duration;

Â  Â  Â  Â  // Save to Database
Â  Â  Â  Â  await update(ref(db, `inventory/${key}`), {
Â  Â  Â  Â  Â  Â  warrantyMonths: finalMonths,
Â  Â  Â  Â  Â  Â  manualWarDate: startDateVal || null,
Â  Â  Â  Â  Â  Â  noWarranty: (type === "NON-WARRANTY"),
Â  Â  Â  Â  Â  Â  protectionActivated: true // This is the trigger for the dashboard
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert(`âœ… ${type} Configuration Saved.`);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- CRITICAL: REFRESH ALL UI COMPONENTS ---
Â  Â  Â  Â  loadWarSetup();Â  Â  Â // Updates the table in the current tab
Â  Â  Â  Â  refreshWarDash();Â  Â // Updates the Dashboard counters at the top
Â  Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  alert("System Error: " + e.message);
Â  Â  }
};

// 4. Official Warranty Print Layout (REMOVED SIGNATURE)
window.printCustomerCopy = async (invoiceNo) => {
Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  const items = [];
Â  Â  let site = "", saleDate = "";

Â  Â  snap.forEach(c => {
Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  if(v.invoiceNo === invoiceNo) {
Â  Â  Â  Â  Â  Â  const war = calculateWarranty(v.soldAt, v.warrantyMonths, v.manualWarDate);
Â  Â  Â  Â  Â  Â  site = v.assignedStation;
Â  Â  Â  Â  Â  Â  saleDate = war ? war.start : new Date(v.soldAt).toLocaleDateString('en-IN');
Â  Â  Â  Â  Â  Â  items.push({
Â  Â  Â  Â  Â  Â  Â  Â  name: v.item,
Â  Â  Â  Â  Â  Â  Â  Â  tag: v.barcode,
Â  Â  Â  Â  Â  Â  Â  Â  totalDays: war ? war.totalDays : 0,
Â  Â  Â  Â  Â  Â  Â  Â  expiry: war ? war.expiry : "N/A",
Â  Â  Â  Â  Â  Â  Â  Â  isNonWarranty: v.noWarranty === trueÂ 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });

Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  let rowsHtml = "";
Â  Â  items.forEach(it => {
Â  Â  Â  Â  let tenureDisplay = `${it.totalDays} DAYS`;
Â  Â  Â  Â  let expiryDisplay = it.expiry;

Â  Â  Â  Â  if (it.isNonWarranty) {
Â  Â  Â  Â  Â  Â  tenureDisplay = `<span style="color:#b91c1c; font-weight:900; font-size:24pt;">NON WARRANTY PRODUCT</span>`;
Â  Â  Â  Â  Â  Â  expiryDisplay = `<span style="color:#b91c1c;">VOID</span>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  rowsHtml += `
Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 2pt solid #ddd;">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 25px 10px; font-size: 30pt; font-weight: 900; text-align: left; width: 45%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.name.toUpperCase()}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 18pt; color: #444;">ID TAG: ${it.tag}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; padding: 25px 10px; font-weight: 900; width: 35%;">${tenureDisplay}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; padding: 25px 10px; font-weight: 900; font-size: 30pt; width: 20%;">${expiryDisplay}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; font-size:20px;">PRINT WARRANTY COPY</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="font-family: 'Times New Roman', serif !important; background:white; color:black;">
Â  Â  Â  Â  Â  Â  <div class="header-line" style="text-align: center; border-bottom: 12pt solid #000; padding-bottom: 30px; margin-bottom: 35px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title" style="font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1;">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name" style="font-size: 26pt; font-weight: 900; margin-top: 20px; line-height: 1.4; text-transform: uppercase;">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><div style="margin-top:5px;">UNIVERSITY OF ENGINEERING AND MANAGEMENT</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: center; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 35pt; font-weight: 900; border: 8pt solid #000; margin-top: 30px; padding: 10px; display: inline-block; text-transform: uppercase;">WARRANTY SUPPORT</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 28pt; font-weight: 900;">REF INVOICE: ${invoiceNo}</div>
Â  Â  Â  Â  Â  Â  <span style="font-size: 28pt; text-decoration: underline; font-weight: bold; text-align: left; display:block; margin-top: 30px;">CUSTOMER / SITE:</span>
Â  Â  Â  Â  Â  Â  <span style="font-size: 38pt; font-weight: 900; border-bottom: 6pt solid #000; display:block; text-align:left;">${site.toUpperCase()}</span>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="background: #000 !important; color: #fff !important; padding: 20px; font-size: 35pt; font-weight: 900; margin-top: 30px; -webkit-print-color-adjust: exact; text-align: center;">COVERAGE DETAILS</div>
Â  Â  Â  Â  Â  Â  <table style="width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed;">
Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr style="border-bottom: 10pt solid #000;"><th style="text-align:left; font-size: 26pt;">ASSET</th><th style="font-size: 26pt; text-align:center;">TENURE</th><th style="text-align:right; font-size: 26pt;">EXPIRY</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${rowsHtml}</tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 60px; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24pt; text-decoration: underline; font-weight: bold;">COMMENCEMENT DATE:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 50pt; font-weight: 900; border: 6pt solid #000; padding: 15px 30px; display: inline-block; margin-top:10px;">${saleDate}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  reportContainer.classList.remove("hidden");
};
window.submitWarrantyClaim = async () => {
Â  Â  const itemName = document.getElementById("claimItemName").innerText;
Â  Â  const invoiceNo = document.getElementById("claimInv").innerText;
Â  Â  const site = document.getElementById("claimSite").innerText;
Â  Â  const issue = document.getElementById("claimIssue").value.trim();
Â  Â  const statusBoxText = document.getElementById("claimStatusBox").innerText;

Â  Â  // 1. Validation
Â  Â  if (!issue) {
Â  Â  Â  Â  return alert("âš ï¸ Please describe the hardware fault or issue before lodging a claim.");
Â  Â  }

Â  Â  if (statusBoxText.includes("EXPIRED") || statusBoxText.includes("NOT REGISTERED")) {
Â  Â  Â  Â  return alert("â›” DENIED: Cannot lodge a claim for an expired or unregistered asset.");
Â  Â  }

Â  Â  if (!confirm(`CONFIRM WARRANTY CLAIM?\n\nItem: ${itemName}\nSite: ${site}\n\nProceed to notify System Administrator?`)) return;

Â  Â  const btn = document.getElementById("btnFinalClaim");
Â  Â  btn.disabled = true;
Â  Â  btn.innerText = "â³ LODGING CLAIM...";

Â  Â  try {
Â  Â  Â  Â  // 2. Prepare Claim Record
Â  Â  Â  Â  const claimData = {
Â  Â  Â  Â  Â  Â  item: itemName,
Â  Â  Â  Â  Â  Â  invoiceNo: invoiceNo,
Â  Â  Â  Â  Â  Â  site: site,
Â  Â  Â  Â  Â  Â  issue: issue,
Â  Â  Â  Â  Â  Â  filedBy: currentUser.name || currentUser.email,
Â  Â  Â  Â  Â  Â  status: "Pending Investigation",
Â  Â  Â  Â  Â  Â  filedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  priority: "HIGH"
Â  Â  Â  Â  };

Â  Â  Â  Â  // 3. Save to Firebase
Â  Â  Â  Â  await push(ref(db, "warranty_claims"), claimData);

Â  Â  Â  Â  // 4. Log the action for Audit Trail
Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  type: "WARRANTY_CLAIM_FILED",
Â  Â  Â  Â  Â  Â  item: itemName,
Â  Â  Â  Â  Â  Â  details: issue,
Â  Â  Â  Â  Â  Â  site: site,
Â  Â  Â  Â  Â  Â  time: serverTimestamp(),
Â  Â  Â  Â  Â  Â  by: currentUser.name || currentUser.email
Â  Â  Â  Â  });

Â  Â  Â  Â  alert("âœ… CLAIM LODGED SUCCESSFULLY\n\nTicket ID generated. Please wait for technician contact.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. Reset UI
Â  Â  Â  Â  document.getElementById("claimIssue").value = "";
Â  Â  Â  Â  document.getElementById("claimDisplay").classList.add("hidden");
Â  Â  Â  Â  toggleWarMode('dash');

Â  Â  } catch (e) {
Â  Â  Â  Â  alert("âŒ Database Error: " + e.message);
Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerText = "LODGE OFFICIAL CLAIM";
Â  Â  }
};
// 6. Support Loaders (Dashboard, Setup, Active List, Sales)
async function refreshWarDash() {
Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  let protectedCount = 0;

Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  total++;

Â  Â  Â  Â  Â  Â  Â  Â  // COUNT IF: Protection flag is true (set during Warranty Setup)
Â  Â  Â  Â  Â  Â  Â  Â  if (v.protectionActivated === true) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  protectedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update the visual labels
Â  Â  Â  Â  const totalEl = document.getElementById("warTotalAssets");
Â  Â  Â  Â  const protectedEl = document.getElementById("warProtected");
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(totalEl) totalEl.innerText = total;
Â  Â  Â  Â  if(protectedEl) protectedEl.innerText = protectedCount;
Â  Â  Â  Â Â 
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Dashboard Sync Error:", e);
Â  Â  }
}

async function loadWarSetup() {
Â  Â  const tbody = document.getElementById("warSetupTableBody");
Â  Â  if (!tbody) return;

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "inventory"));Â 
Â  Â  Â  Â  tbody.innerHTML = "";

Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No records.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  const displayDate = v.manualWarDate ?Â 
Â  Â  Â  Â  Â  Â  Â  Â  new Date(v.manualWarDate).toLocaleDateString('en-IN') :Â 
Â  Â  Â  Â  Â  Â  Â  Â  (v.soldAt ? new Date(v.soldAt).toLocaleDateString('en-IN') : "NOT SET");

Â  Â  Â  Â  Â  Â  // LOGIC: Check if it was marked as Non-Warranty
Â  Â  Â  Â  Â  Â  let tenureText = v.warrantyMonths ? v.warrantyMonths + ' Months' : 'NOT SET';
Â  Â  Â  Â  Â  Â  if (v.noWarranty) tenureText = '<span style="color:red; font-weight:900;">NON-WARRANTY</span>';

Â  Â  Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; font-weight:bold;">${v.barcode || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${v.item || '--'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">${displayDate}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:var(--metro-blue);">${tenureText}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><button class="info" onclick="document.getElementById('warSetupTag').value='${v.barcode}'">Select</button></td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Load Setup Error:", e);
Â  Â  }
}
async function loadWarSales() {
Â  Â  const tbody = document.getElementById("warSalesTableBody");
Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  const salesGroup = {};Â 
Â  Â Â 
Â  Â  snap.forEach(c => {
Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  if(v.invoiceNo) {
Â  Â  Â  Â  Â  Â  if(!salesGroup[v.invoiceNo]) {
Â  Â  Â  Â  Â  Â  Â  Â  salesGroup[v.invoiceNo] = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  site: v.assignedStation,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: v.soldAt,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  billedTo: v.holder || "METRO"Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  salesGroup[v.invoiceNo].items.push(v.item);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  tbody.innerHTML = "";
Â  Â  Object.entries(salesGroup).forEach(([inv, data]) => {
Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; font-weight:bold; color:#0284c7;">${inv}</td>
Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${data.site}</td>
Â  Â  Â  Â  Â  Â  <td>${new Date(data.date).toLocaleDateString('en-IN')}</td>
Â  Â  Â  Â  Â  Â  <td style="font-size:11px;">${data.items.join(", ")}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center; white-space:nowrap;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="printCustomerCopy('${inv}')" class="info" title="Warranty Copy"><i class="fas fa-shield-alt"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="reissueInvoice('${inv}', ${data.date})" class="success" style="background:#15803d; margin-left:5px;" title="Reissue Bill">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-invoice"></i> REISSUE
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
Â  Â  });
}
window.reissueInvoice = async (invoiceNo, saleDateTs) => {
Â  Â  const NOW = Date.now();
Â  Â  const TWO_MONTHS_MS = 60 * 24 * 60 * 60 * 1000;

Â  Â  if (NOW - saleDateTs > TWO_MONTHS_MS) {
Â  Â  Â  Â  return alert("â›” ACCESS DENIED: Reissue period expired (Max 60 Days).");
Â  Â  }

Â  Â  if (!confirm("Confirm Reissue of Official Tax Invoice?")) return;

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  Â  Â  const items = [];
Â  Â  Â  Â  let site = "";

Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  if(v.invoiceNo === invoiceNo) {
Â  Â  Â  Â  Â  Â  Â  Â  site = v.assignedStation;
Â  Â  Â  Â  Â  Â  Â  Â  const sellRate = (parseFloat(v.purchasePrice) || 0) * 1.20;
Â  Â  Â  Â  Â  Â  Â  Â  items.push({ name: v.item, tag: v.barcode, rate: sellRate, qty: 1, net: sellRate });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  Â  Â  let billRows = "";
Â  Â  Â  Â  let billTotal = 0;

Â  Â  Â  Â  items.forEach(it => {
Â  Â  Â  Â  Â  Â  billTotal += it.net;
Â  Â  Â  Â  Â  Â  billRows += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 5pt solid #000;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 20px 10px; font-size: 30pt; font-weight: 900; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.name.toUpperCase()}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 18pt; color: #333;">(TAG ID: ${it.tag})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; padding: 20px 10px; font-size: 30pt;">${it.rate.toFixed(0)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; padding: 20px 10px; font-size: 30pt;">${it.qty}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right; padding: 20px 10px; font-weight: 900; font-size: 30pt;">${Math.round(it.net)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });

Â  Â  Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#fff1f2; border-bottom:2px solid #e11d48;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color:#be123c; margin:0;">âš ï¸ REISSUE PREVIEW (DUPLICATE)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CANCEL</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; margin-left:10px; cursor:pointer; border-radius:8px;">PRINT REISSUE BILL</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="position:relative; background:white; color:black; font-family:'Times New Roman', serif;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="position:absolute; top:40%; left:5%; font-size:80pt; color:rgba(0,0,0,0.05); transform:rotate(-45deg); font-weight:900; pointer-events:none; z-index:0; text-transform:uppercase;">DUPLICATE REISSUE</div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-line" style="text-align: center; border-bottom: 12pt solid #000; padding-bottom: 30px; margin-bottom: 35px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title" style="font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1;">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name" style="font-size: 26pt; font-weight: 900; margin-top: 15px; line-height: 1.2; text-transform: uppercase;">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><div style="margin-top:5px;">UNIVERSITY OF ENGINEERING AND MANAGEMENT</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: center; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; border: 8pt solid #000; margin-top: 35px; padding: 12px 25px; display: inline-block; font-weight: 900; text-transform: uppercase;">REISSUE TAX INVOICE</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 30px; font-family: monospace;">INV NO: ${invoiceNo}</div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:left; font-size: 30pt; font-weight: 900; border-bottom: 6pt solid #000; padding: 15pt 0;"><b>DATE:</b> ${new Date(saleDateTs).toLocaleDateString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:left; font-size: 30pt; font-weight: 900; border-bottom: 6pt solid #000; padding: 15pt 0;"><b>BILLED TO:</b> ${site.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:left; font-size: 30pt; font-weight: 900; border-bottom: 6pt solid #000; padding: 15pt 0;"><b>ISSUED BY:</b> ${currentUser.name.toUpperCase()}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <table style="width:100%; border-collapse:collapse; margin-top:40px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background: #eee; -webkit-print-color-adjust: exact; border-bottom: 8pt solid #000;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:left; font-size:26pt; padding:15px;">PARTICULARS</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:right; font-size:26pt; padding:15px;">RATE</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:center; font-size:26pt; padding:15px;">QTY</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="text-align:right; font-size:26pt; padding:15px;">TOTAL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${billRows}</tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="background:#000; color:#fff; display:flex; justify-content:space-between; padding:25px; margin-top:10px; -webkit-print-color-adjust: exact;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:50pt; font-weight:900;">GRAND TOTAL:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:50pt; font-weight:900;">â‚¹ ${Math.round(billTotal).toLocaleString('en-IN')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:left; font-size: 22pt; font-style: italic; margin-top: 20px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Amount in words: ${numberToWords(Math.round(billTotal))}
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 130px; border-top: 10pt solid #000; width: 60%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 42pt; font-weight: 900;">${currentUser.name.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 28pt; font-weight: 900;">AUTHORIZED SIGNATORY (MRPSP)</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 80px; border-top: 3pt dashed #000; padding-top: 20px; font-size: 16pt; text-align: center; font-weight: bold; text-transform: uppercase;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Certified Duplicate Copy | Original System Record
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  reportContainer.classList.remove("hidden");
Â  Â  Â  Â  window.scrollTo(0, 0);

Â  Â  } catch (e) {
Â  Â  Â  Â  alert("Reissue Error: " + e.message);
Â  Â  }
};
async function loadActiveWarranty() {
Â  Â  const tbody = document.getElementById("warActiveTableBody");
Â  Â  const snap = await get(ref(db, "inventory"));
Â  Â  tbody.innerHTML = "";
Â  Â  snap.forEach(c => {
Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  if(v.status === "Sold Out" && v.warrantyMonths) {
Â  Â  Â  Â  Â  Â  const war = calculateWarranty(v.soldAt, v.warrantyMonths, v.manualWarDate);
Â  Â  Â  Â  Â  Â  const statusBadge = war.expired ? '<span class="badge-offline">EXPIRED</span>' : '<span class="badge-online">ACTIVE</span>';
Â  Â  Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-family:monospace; font-weight:bold;">${v.barcode}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${v.item}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${war.start}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:#b91c1c;">${war.expiry}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:900;">${war.daysLeft}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${statusBadge}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  }
Â  Â  });
}
Â  window.toggleWarrantyFields = () => {
Â  Â  const type = document.getElementById("warProductType").value;
Â  Â  const isWarranty = (type === "WARRANTY");
Â  Â Â 
Â  Â  document.getElementById("divWarTenure").style.display = isWarranty ? "block" : "none";
Â  Â  document.getElementById("divWarUnit").style.display = isWarranty ? "block" : "none";
Â  Â  document.getElementById("divWarDate").style.display = isWarranty ? "block" : "none";
Â  Â Â 
Â  Â  if(!isWarranty) {
Â  Â  Â  Â  document.getElementById("warDuration").value = 0;
Â  Â  Â  Â  document.getElementById("warStartDate").value = "";
Â  Â  }
};
Â  window.recoveryCart = [];

// A. Add Item to the temporary list
window.addToRecoveryCart = async (tagId) => {
Â  Â  const tag = tagId ? tagId.trim() : "";
Â  Â  if(!tag) return;

Â  Â  // Prevent duplicates in cart
Â  Â  if(window.recoveryCart.some(it => it.barcode === tag)) {
Â  Â  Â  Â  return alert("Item already in cart.");
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(tag));
Â  Â  Â  Â  const snap = await get(q);

Â  Â  Â  Â  if (!snap.exists()) return alert("Tag not found in database.");

Â  Â  Â  Â  let item;
Â  Â  Â  Â  snap.forEach(c => item = { key: c.key, ...c.val() });

Â  Â  Â  Â  if (item.status !== "Sold Out") {
Â  Â  Â  Â  Â  Â  return alert(`Cannot return: ${item.item} is not marked as Sold.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Add to local array
Â  Â  Â  Â  window.recoveryCart.push(item);
Â  Â  Â  Â  renderRecoveryCart();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reset manual input
Â  Â  Â  Â  document.getElementById("manualRecoveryTag").value = "";
Â  Â  } catch (e) { alert(e.message); }
};

// B. Render the Cart UI
function renderRecoveryCart() {
Â  Â  const tbody = document.getElementById("recoveryCartBody");
Â  Â  const btn = document.getElementById("btnExecuteRecovery");
Â  Â  tbody.innerHTML = "";

Â  Â  window.recoveryCart.forEach((it, i) => {
Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${i+1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold;">${it.item}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-family:monospace;">${it.barcode}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${it.assignedStation || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.recoveryCart.splice(${i},1); renderRecoveryCart();" class="danger" style="padding:2px 6px;">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  btn.style.display = window.recoveryCart.length > 0 ? "block" : "none";
}

// C. Finalize: Update DB and Print One Memo
window.finalizeRecoveryCart = async () => {
Â  Â  const reason = document.getElementById("recoveryReason").value.trim();
Â  Â  if(!reason || window.recoveryCart.length === 0) return alert("Scan items and enter reason.");
Â  Â Â 
Â  Â  if(confirm(`Recover ${window.recoveryCart.length} items? This will reset them to In-Stock.`)) {
Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  window.recoveryCart.forEach(it => {
Â  Â  Â  Â  Â  Â  updates[`inventory/${it.key}/status`] = "In Stock";
Â  Â  Â  Â  Â  Â  updates[`inventory/${it.key}/holder`] = "Store";
Â  Â  Â  Â  Â  Â  updates[`inventory/${it.key}/location`] = "Recovered: " + reason;
Â  Â  Â  Â  Â  Â  // CLEAN WIPE
Â  Â  Â  Â  Â  Â  updates[`inventory/${it.key}/invoiceNo`] = null;
Â  Â  Â  Â  Â  Â  updates[`inventory/${it.key}/assignedStation`] = null;
Â  Â  Â  Â  Â  Â  updates[`inventory/${it.key}/soldAt`] = null;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  await update(ref(db), updates);
Â  Â  Â  Â  generateConsolidatedMemo(window.recoveryCart, reason);
Â  Â  Â  Â  window.recoveryCart = [];
Â  Â  Â  Â  renderRecoveryCart();
Â  Â  Â  Â  alert("âœ… Recovery Successful. Invoice data wiped.");
Â  Â  }
};
Â  function generateConsolidatedMemo(items, reason) {
Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  const receiverName = (currentUser.name || 'System Auditor').toUpperCase();
Â  Â Â 
Â  Â  let itemRows = "";
Â  Â  items.forEach((it, i) => {
Â  Â  Â  Â  itemRows += `
Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 2pt solid #ddd;">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 25px 15px; font-size: 28pt; font-weight: 900; text-align: left; vertical-align: middle;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${i+1}. ${it.item.toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 25px 15px; font-size: 26pt; font-family: monospace; vertical-align: middle;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.barcode}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 25px 15px; font-size: 22pt; font-weight: bold; vertical-align: middle;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${(it.assignedStation || 'N/A').toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; cursor:pointer; margin-left:10px; border-radius: 8px;">PRINT BATCH MEMO</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="font-family: 'Times New Roman', serif !important; background:white; color:black;">
Â  Â  Â  Â  Â  Â  <div class="header-line" style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title" style="font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1;">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name" style="font-size: 26pt; font-weight: 900; margin-top: 20px; line-height: 1.4; text-transform: uppercase;">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><div style="margin-top: 5px;">UNIVERSITY OF ENGINEERING AND MANAGEMENT</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: center; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; border: 8pt solid #000; margin-top: 30px; padding: 12px 25px; font-weight: 900; display: inline-block; background: #000 !important; color: #fff !important; -webkit-print-color-adjust: exact; text-transform: uppercase;">Batch Return Note</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 26pt; font-weight: 900; margin-bottom: 25px; margin-top: 20px;">DATE: ${new Date().toLocaleDateString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  <table class="batch-table" style="width:100%; border-collapse: collapse; margin-top: 40px; table-layout: fixed;">
Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr style="border-bottom: 8pt solid #000;"><th style="font-size: 24pt; text-align: left;">DESCRIPTION</th><th style="font-size: 24pt; text-align: left;">TAG ID</th><th style="font-size: 24pt; text-align: left;">ORIGINAL SITE</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>${itemRows}</tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  <div style="text-align:left; margin-top:50px; font-size:28pt; font-weight:900;">REASON: ${reason.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top: 150px; border-top: 10pt solid #000; width: 65%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 42pt; font-weight: 900;">${receiverName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 28pt; font-weight: 900;">AUTHORIZED RECEIVER (SIGNATURE)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
}
Â  window.loadWarrantyClaims = () => {
Â  Â  const tbody = document.getElementById("warClaimsTableBody");
Â  Â  if (!tbody) return;

Â  Â  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px;'><i class='fas fa-sync fa-spin'></i> Syncing Claims...</td></tr>";

Â  Â  onValue(ref(db, "warranty_claims"), (snap) => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px;'>No active claims found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const claimsArray = [];
Â  Â  Â  Â  snap.forEach(c => { claimsArray.push({ key: c.key, ...c.val() }); });
Â  Â  Â  Â  claimsArray.sort((a, b) => (b.filedAt || 0) - (a.filedAt || 0));

Â  Â  Â  Â  claimsArray.forEach(claim => {
Â  Â  Â  Â  Â  Â  const ticketKey = claim.key;
Â  Â  Â  Â  Â  Â  const displayId = ticketKey.substring(1, 10).toUpperCase();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let progress = "15%";Â 
Â  Â  Â  Â  Â  Â  let statusColor = "#ff9900";Â 

Â  Â  Â  Â  Â  Â  if (claim.status === "In Progress" || claim.status === "Verification Pending") {Â 
Â  Â  Â  Â  Â  Â  Â  Â  progress = "60%";Â 
Â  Â  Â  Â  Â  Â  } else if (["Resolved", "Rejected", "Warranty Voided"].includes(claim.status)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  progress = "100%";Â 
Â  Â  Â  Â  Â  Â  Â  Â  statusColor = claim.status === "Resolved" ? "#15803d" : "#b91c1c";Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isClosed = ["Resolved", "Rejected", "Warranty Voided"].includes(claim.status);

Â  Â  Â  Â  Â  Â  // --- REPRINT BUTTON (Keeps existing options) ---
Â  Â  Â  Â  Â  Â  let actionBtns = `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="info" onclick="generateClaimTicketPrint('${ticketKey}')" style="width:100%; margin-bottom:8px; background:#0A2342; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-print"></i> REPRINT TICKET
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;

Â  Â  Â  Â  Â  Â  if (isAdmin && !isClosed) {
Â  Â  Â  Â  Â  Â  Â  Â  actionBtns += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="success" onclick="adminVerifyClaim('${ticketKey}', 'REPLACE')" style="font-size:10px; padding:8px 2px;">âœ… Replace</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="success" onclick="adminVerifyClaim('${ticketKey}', 'RESOLVE_FIXED')" style="font-size:10px; background:#065f46; padding:8px 2px;">ğŸ›  Resolved</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="warning" onclick="adminVerifyClaim('${ticketKey}', 'RECHECK')" style="font-size:10px; padding:8px 2px;">ğŸ”„ Re-Check</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="info" onclick="adminVerifyClaim('${ticketKey}', 'NEW_TECH')" style="font-size:10px; background:#1e40af; padding:8px 2px;">ğŸ‘¤ New Tech</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="adminVerifyClaim('${ticketKey}', 'REJECT')" style="font-size:10px; padding:8px 2px;">ğŸš« Reject</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="adminVerifyClaim('${ticketKey}', 'VOID')" style="font-size:10px; background:#450a0a; padding:8px 2px;">ğŸ’€ Void</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 3px solid #f1f5f9; background: ${isClosed ? '#f8fafc' : '#fff'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="7" style="padding: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-weight: 900; color: #232f3e; font-size: 15px;">TICKET ID: #${displayId}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: #666; margin-top: 4px;">Status: <b style="color:${statusColor}">${claim.status.toUpperCase()}</b></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="min-width: 200px;">${actionBtns}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="position: relative; height: 6px; background: #e7e9ec; border-radius: 3px; margin: 30px 10px 10px 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${progress}; background: ${statusColor}; transition: width 0.8s ease;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 25px; font-size: 13px; background: #f9f9f9; padding: 12px; border-radius: 6px; border-left: 4px solid ${statusColor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${claim.item}</strong> | Site: <b>${claim.site}</b><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:4px; color:#b91c1c; font-style:italic;">"Fault: ${claim.issue}"</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${claim.adminRemarks ? `<div style="margin-top:8px; font-weight:bold; border-top:1px solid #ddd; padding-top:5px;">Admin: ${claim.adminRemarks}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  });
};
// Function to update the claim status manually
window.updateClaimStatus = async (key, newStatus) => {
Â  Â  if(!confirm(`Are you sure you want to mark this ticket as ${newStatus}?`)) return;
Â  Â  try {
Â  Â  Â  Â  await update(ref(db, `warranty_claims/${key}`), {Â 
Â  Â  Â  Â  Â  Â  status: newStatus,
Â  Â  Â  Â  Â  Â  resolutionDate: serverTimestamp()Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  alert("âœ… Ticket status updated to " + newStatus);
Â  Â  } catch(e) {
Â  Â  Â  Â  alert("Update Error: " + e.message);
Â  Â  }
};
// Function for Manual Entry Verification
window.handleManualClaimSearch = () => {
Â  Â  const tag = document.getElementById('manualClaimTag').value.trim();
Â  Â  if(!tag) return alert("Please enter a Tag ID.");
Â  Â  // Force mode to WARRANTY_CLAIM so onScanSuccess knows what to do
Â  Â  scanMode = 'WARRANTY_CLAIM';Â 
Â  Â  onScanSuccess(tag);Â 
};
window.generateClaimTicketPrint = async (ticketKey) => {
Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, `warranty_claims/${ticketKey}`));
Â  Â  Â  Â  if (!snap.exists()) return alert("Error: Ticket record not found.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const data = snap.val();
Â  Â  Â  Â  const reportContainer = document.getElementById("printableReportContainer");
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const shortTicketId = ticketKey.substring(1, 10).toUpperCase();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&margin=10&data=${encodeURIComponent(shortTicketId)}`;

Â  Â  Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:20px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color:var(--metro-blue);">Official Claim Ticket</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 50px; font-weight:bold; margin-left:15px; border-radius:8px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-print"></i> PRINT RECEIPT
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="report-paper a4-max-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  @media print {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  @page { size: A4; margin: 10mm; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .no-print { display: none !important; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 100% !important; padding: 0 !important; margin: 0 !important; box-shadow: none !important; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm; background: white; color: black; font-family: 'Times New Roman', serif; box-sizing: border-box; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .header-line { border-bottom: 10pt solid #000; padding-bottom: 25px; margin-bottom: 30px; text-align: center; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .project-title { font-size: 48pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .college-name { font-size: 24pt; font-weight: 900; margin-top: 10px; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .ticket-id-container { border: 6pt solid #000; padding: 20px; display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .meta-row { font-size: 28pt; font-weight: 900; border-bottom: 5pt solid #000; padding: 15pt 0; text-align: left; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .heavy-bar { background: #000 !important; color: #fff !important; padding: 12px; font-size: 24pt; font-weight: 900; margin-top: 35px; text-align: center; -webkit-print-color-adjust: exact; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .issue-body { border: 5pt solid #000; padding: 20px; font-size: 32pt; font-weight: 900; min-height: 180px; text-align: left; line-height: 1.2; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  </style>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="header-line">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name">INSTITUTE OF ENGINEERING AND MANAGEMENT<br>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 32pt; border: 6pt solid #000; margin-top: 25px; padding: 10px 20px; display: inline-block; font-weight: 900; text-transform: uppercase;">Claim Acknowledgement Receipt</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-id-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="id-text-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24pt; font-weight: bold;">TICKET REFERENCE:</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 52pt; font-weight: 900; color: #b91c1c;">#${shortTicketId}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="width: 180px; height: 180px; border: 2pt solid #000; padding: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${qrUrl}" style="width: 100%; height: 100%;" alt="Ticket QR">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>DATE FILED:</b> ${new Date(data.filedAt).toLocaleDateString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>SITE:</b> ${(data.site || "N/A").toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>ASSET:</b> ${data.item.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>STATUS:</b> ${(data.status || "PENDING").toUpperCase()}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="heavy-bar">FAULT DESCRIPTION</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="issue-body">${data.issue}</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 100px; border-top: 8pt solid #000; width: 60%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 38pt; font-weight: 900;">${data.filedBy.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 22pt; font-weight: bold;">AUTHORIZED SIGNATORY</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 60px; font-size: 14pt; text-align: center; border-top: 2pt dashed #000; padding-top: 15px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  SYSTEM GENERATED RECORD | PRINTED ON: ${now.toLocaleString('en-IN')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  reportContainer.classList.remove("hidden");
Â  Â  Â  Â  window.scrollTo(0, 0);

Â  Â  } catch (e) { alert("Failed to generate receipt: " + e.message); }
};
Â  window.generateReplacementBill = async (ticketKey) => {
Â  Â  const snap = await get(ref(db, `warranty_claims/${ticketKey}`));
Â  Â  if (!snap.exists()) return alert("Error: Ticket data not found.");
Â  Â Â 
Â  Â  const data = snap.val();
Â  Â  const newInvoiceNo = "REP-" + (data.invoiceNo || "MISC"); // Prefix REP to original ID
Â  Â  const reportContainer = document.getElementById("printableReportContainer");

Â  Â  // 1. Update Ticket to Resolved in Database immediately
Â  Â  await update(ref(db, `warranty_claims/${ticketKey}`), {Â 
Â  Â  Â  Â  status: "Resolved",
Â  Â  Â  Â  resolutionDate: serverTimestamp()Â 
Â  Â  });

Â  Â  // 2. Render the Replacement Template
Â  Â  reportContainer.innerHTML = `
Â  Â  Â  Â  <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <button class="danger" onclick="closeReportPreview()">CLOSE</button>
Â  Â  Â  Â  Â  Â  <button onclick="window.print()" style="background:#b91c1c; color:#fff; padding:15px 40px; font-weight:bold; cursor:pointer; margin-left:10px; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-print"></i> PRINT REPLACEMENT BILL
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="report-paper a4-max-wrapper" style="font-family: 'Times New Roman', serif !important; background:white; color:black;">
Â  Â  Â  Â  Â  Â  <style>
Â  Â  Â  Â  Â  Â  Â  Â  @media print { @page { size: A4; margin: 0; } .no-print { display: none !important; } .a4-max-wrapper { width: 100% !important; padding: 15mm !important; } }
Â  Â  Â  Â  Â  Â  Â  Â  .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; box-sizing: border-box; text-align: center; }
Â  Â  Â  Â  Â  Â  Â  Â  .header-line { border-bottom: 12pt solid #000; padding-bottom: 30px; margin-bottom: 35px; }
Â  Â  Â  Â  Â  Â  Â  Â  .project-title { font-size: 52pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; }
Â  Â  Â  Â  Â  Â  Â  Â  .college-name { font-size: 26pt; font-weight: 900; margin-top: 20px; line-height: 1.4; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  .rep-label { font-size: 38pt; border: 8pt solid #b91c1c; color: #b91c1c; margin-top: 35px; padding: 12px 25px; font-weight: 900; display: inline-block; text-transform: uppercase; }
Â  Â  Â  Â  Â  Â  Â  Â  .meta-row { font-size: 32pt; font-weight: 900; border-bottom: 6pt solid #000; padding: 18pt 0; text-align: left; }
Â  Â  Â  Â  Â  Â  </style>

Â  Â  Â  Â  Â  Â  <div class="header-line">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="project-title">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="college-name">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><div>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="rep-label">REPLACEMENT INVOICE</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 40px; font-family: monospace;">
Â  Â  Â  Â  Â  Â  Â  Â  REF ORIGINAL INV: ${data.invoiceNo}<br>
Â  Â  Â  Â  Â  Â  Â  Â  REPLACEMENT ID: ${newInvoiceNo}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>DATE:</b> ${new Date().toLocaleDateString('en-IN')}</div>
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>BILLED TO:</b> ${data.site.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>ITEM:</b> ${data.item.toUpperCase()} (1 UNIT)</div>
Â  Â  Â  Â  Â  Â  <div class="meta-row"><b>VALUATION:</b> â‚¹ 0.00 (WARRANTY EXCHANGE)</div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 60px; border: 6pt solid #b91c1c; padding: 30px; text-align: left; background: #fff5f5; -webkit-print-color-adjust: exact;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 22pt; font-weight: 900; color: #b91c1c; text-decoration: underline; margin-bottom: 10px;">TECHNICAL DIAGNOSIS & REMARKS:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 32pt; font-weight: 900; line-height: 1.2;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${(data.techNotes || "Component failure confirmed by lab.").toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top: 150px; border-top: 10pt solid #000; width: 65%; text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 42pt; font-weight: 900;">${currentUser.name.toUpperCase()}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 28pt; font-weight: 900;">AUTHORIZED SIGNATORY (ADMIN)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="margin-top: 80px; border-top: 3pt dashed #000; padding-top: 20px; font-size: 16pt; text-align: center; font-weight: bold; text-transform: uppercase;">
Â  Â  Â  Â  Â  Â  Â  Â  This document serves as proof of replacement under valid warranty terms.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;

Â  Â  reportContainer.classList.remove("hidden");
Â  Â  window.scrollTo(0, 0);
};
// Toggle between Scan Prompt and Manual Input Box
window.toggleTechManualEntry = (showManual) => {
Â  Â  const scanPrompt = document.getElementById("techScanPrompt");
Â  Â  const manualBox = document.getElementById("techManualEntry");
Â  Â Â 
Â  Â  if(showManual) {
Â  Â  Â  Â  scanPrompt.classList.add("hidden");
Â  Â  Â  Â  manualBox.classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("inpTechManualId").focus();
Â  Â  } else {
Â  Â  Â  Â  scanPrompt.classList.remove("hidden");
Â  Â  Â  Â  manualBox.classList.add("hidden");
Â  Â  }
};

// Handle the "Fetch Details" button click
window.processTechManualEntry = async () => {
Â  Â  const manualId = document.getElementById("inpTechManualId").value.trim();
Â  Â  if(!manualId) return alert("Please enter a valid Ticket ID.");

Â  Â  // Set mode so onScanSuccess knows how to handle the input
Â  Â  scanMode = 'TECH_TICKET_SCAN';
Â  Â Â 
Â  Â  // We treat the manual ID exactly like a scanned QR code
Â  Â  await onScanSuccess(manualId);
Â  Â Â 
Â  Â  // Cleanup
Â  Â  document.getElementById("inpTechManualId").value = "";
Â  Â  toggleTechManualEntry(false);
};

// --- SUPPORTING TECHNICIAN FUNCTIONS ---
window.submitTechResolution = async () => {
Â  Â  const ticketId = document.getElementById("techTicketIdDisplay").innerText.replace("#", "");
Â  Â  const techName = document.getElementById("techNameInput").value.trim();
Â  Â  const notes = document.getElementById("techCommandNotes").value.trim();
Â  Â  const component = document.getElementById("techFailedComponent").value.trim();

Â  Â  if(!techName) return alert("âš ï¸ SECURITY BREACH: Technician Name is required to lock diagnosis.");
Â  Â  if(!notes || !component) return alert("âš ï¸ Missing diagnostic data.");

Â  Â  if(!confirm(`I, ${techName}, certify that this diagnosis is accurate and ready for Admin Audit?`)) return;

Â  Â  // Retrieve full key
Â  Â  const snap = await get(ref(db, "warranty_claims"));
Â  Â  let realKey = "";
Â  Â  snap.forEach(c => { if(c.key.toUpperCase().includes(ticketId)) realKey = c.key; });

Â  Â  await update(ref(db, `warranty_claims/${realKey}`), {
Â  Â  Â  Â  status: "Verification Pending",
Â  Â  Â  Â  techName: techName, // SAVED NAME
Â  Â  Â  Â  techNotes: notes,
Â  Â  Â  Â  failedComponent: component,
Â  Â  Â  Â  techAction: document.getElementById("techActionSelect").value,
Â  Â  Â  Â  diagTime: serverTimestamp()
Â  Â  });

Â  Â  alert("âœ… Sent for Admin Oversight.");
Â  Â  document.getElementById("techDiagnosisArea").classList.add("hidden");
Â  Â  toggleWarMode('claims-list');
};

async function renderTechArea(ticketKey, claim) {
Â  Â  const diagArea = document.getElementById("techDiagnosisArea");
Â  Â  if(!diagArea) return;

Â  Â  diagArea.classList.remove("hidden");
Â  Â Â 
Â  Â  // 1. Set ID and Fallback Invoice
Â  Â  const shortId = ticketKey.substring(1, 10).toUpperCase();
Â  Â  document.getElementById("techTicketIdDisplay").innerText = "#" + shortId;
Â  Â  document.getElementById("techOriginalInvoice").innerText = "REF INV: " + (claim.invoiceNo || "N/A");
Â  Â  document.getElementById("techIssueData").innerText = claim.issue || "No description.";
Â  Â Â 
Â  Â  // 2. Fetch Asset Values
Â  Â  const nameLabel = document.getElementById("techAssetData");
Â  Â  const priceLabel = document.getElementById("techPurchasePrice");

Â  Â  try {
Â  Â  Â  Â  const invSnap = await get(ref(db, "inventory"));
Â  Â  Â  Â  let matched = false;
Â  Â  Â  Â  invSnap.forEach(c => {
Â  Â  Â  Â  Â  Â  const item = c.val();
Â  Â  Â  Â  Â  Â  if(item.invoiceNo === claim.invoiceNo) {
Â  Â  Â  Â  Â  Â  Â  Â  nameLabel.innerText = item.item.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  priceLabel.innerText = "Original Value: â‚¹ " + parseFloat(item.purchasePrice || 0).toLocaleString('en-IN');
Â  Â  Â  Â  Â  Â  Â  Â  matched = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(!matched) {
Â  Â  Â  Â  Â  Â  nameLabel.innerText = claim.item ? claim.item.toUpperCase() : "Unknown Asset";
Â  Â  Â  Â  Â  Â  priceLabel.innerText = "Check Billing History";
Â  Â  Â  Â  }
Â  Â  } catch(e) { console.error(e); }

Â  Â  await update(ref(db, `warranty_claims/${ticketKey}`), { status: "In Progress" });
Â  Â  document.getElementById("techNameInput").focus();
}
// --- UPDATED ADMIN CLAIM ACTIONS ---
window.adminVerifyClaim = async (ticketKey, decision) => {
Â  Â  const snap = await get(ref(db, `warranty_claims/${ticketKey}`));
Â  Â  if (!snap.exists()) return;
Â  Â  const data = snap.val();

Â  Â  let newStatus = "";
Â  Â  let adminNote = "";
Â  Â  let updatePayload = { resolutionDate: serverTimestamp() };

Â  Â  switch(decision) {
Â  Â  Â  Â  case 'REPLACE':Â 
Â  Â  Â  Â  Â  Â  if (!confirm("Confirm and Issue Replacement?")) return;
Â  Â  Â  Â  Â  Â  newStatus = "Resolved"; // Moves progress to 'CLOSE'
Â  Â  Â  Â  Â  Â  adminNote = "Warranty claim honored. Replacement unit dispatched.";
Â  Â  Â  Â  Â  Â  generateReplacementBill(ticketKey);Â 
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'RECHECK':
Â  Â  Â  Â  Â  Â  adminNote = prompt("Enter specific instructions for the Technician to re-examine:");
Â  Â  Â  Â  Â  Â  if (!adminNote) return;
Â  Â  Â  Â  Â  Â  newStatus = "In Progress"; // Reverts progress to 'DIAGNOSIS'
Â  Â  Â  Â  Â  Â  updatePayload.techVerified = false;Â 
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'NEW_TECH':
Â  Â  Â  Â  Â  Â  const techName = prompt("Enter the name of the New Assigned Technician:");
Â  Â  Â  Â  Â  Â  if (!techName) return;
Â  Â  Â  Â  Â  Â  newStatus = "In Progress"; // Keeps progress at 'DIAGNOSIS'
Â  Â  Â  Â  Â  Â  updatePayload.techName = techName;
Â  Â  Â  Â  Â  Â  adminNote = `Ticket reassigned to ${techName} for secondary opinion.`;
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'VOID':
Â  Â  Â  Â  Â  Â  if (!confirm("Permanently VOID this product's warranty due to physical damage/misuse?")) return;
Â  Â  Â  Â  Â  Â  newStatus = "Warranty Voided"; // Final state
Â  Â  Â  Â  Â  Â  adminNote = "Claim denied: Asset shows signs of unauthorized tampering or physical impact.";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mark the actual asset as void in the master inventory
Â  Â  Â  Â  Â  Â  const assetSnap = await get(query(ref(db, "inventory"), orderByChild("barcode"), equalTo(data.barcode || "")));
Â  Â  Â  Â  Â  Â  assetSnap.forEach(c => update(ref(db, `inventory/${c.key}`), { noWarranty: true, protectionActivated: false }));
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'REJECT':
Â  Â  Â  Â  Â  Â  adminNote = prompt("Provide the official reason for claim rejection:");
Â  Â  Â  Â  Â  Â  if (!adminNote) return;
Â  Â  Â  Â  Â  Â  newStatus = "Rejected"; // Final state
Â  Â  Â  Â  Â  Â  break;

Â  Â  Â  Â  case 'RESOLVE_FIXED':
Â  Â  Â  Â  Â  Â  if (!confirm("Mark as Resolved? (Fixed via repair without replacement)")) return;
Â  Â  Â  Â  Â  Â  newStatus = "Resolved"; // Moves progress to 'CLOSE'
Â  Â  Â  Â  Â  Â  adminNote = "Issue resolved via professional repair. Original asset returned to site.";
Â  Â  Â  Â  Â  Â  break;
Â  Â  }

Â  Â  if (newStatus) {
Â  Â  Â  Â  updatePayload.status = newStatus;
Â  Â  Â  Â  updatePayload.adminRemarks = adminNote;
Â  Â  Â  Â Â 
Â  Â  Â  Â  await update(ref(db, `warranty_claims/${ticketKey}`), updatePayload);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Log decision to master audit trail
Â  Â  Â  Â  await push(ref(db, "logs"), {
Â  Â  Â  Â  Â  Â  type: "ADMIN_TICKET_DECISION",
Â  Â  Â  Â  Â  Â  ticket: ticketKey,
Â  Â  Â  Â  Â  Â  decision: newStatus,
Â  Â  Â  Â  Â  Â  by: currentUser.name || currentUser.email,
Â  Â  Â  Â  Â  Â  time: serverTimestamp()
Â  Â  Â  Â  });

Â  Â  Â  Â  alert(`âœ… Ticket updated to: ${newStatus}`);
Â  Â  }
};

Â  // --- RESET THE PROTOCOL ---
Â  let techVerifiedTicket = null;
let techVerifiedTicketKey = null;
window.resetTechVerification = () => {
Â  Â  techVerifiedTicket = null;
Â  Â  techVerifiedTicketKey = null;
Â  Â Â 
Â  Â  // UI Resets
Â  Â  document.getElementById("btnScanProduct").disabled = true;
Â  Â  document.getElementById("ticketVerifiedLabel").classList.add("hidden");
Â  Â  document.getElementById("productVerifiedLabel").classList.add("hidden");
Â  Â  document.getElementById("techMismatchArea").classList.add("hidden");
Â  Â  document.getElementById("techDiagnosisArea").classList.add("hidden");
Â  Â  document.getElementById("techStepTitle").style.color = "#232f3e";
Â  Â  document.getElementById("techStepTitle").innerText = "SECURITY PROTOCOL: PHYSICAL PRODUCT VERIFICATION";
Â  Â Â 
Â  Â  alert("Protocol Reset. Please restart from Ticket Scan.");
};
// --- ENSURE MODULE FUNCTIONS ARE GLOBAL FOR HTML BUTTONS ---
window.handleManualTechVerify = async (type) => {
Â  Â  const ticketVal = document.getElementById("manualTicketInp").value.trim();
Â  Â  const productVal = document.getElementById("manualProductInp").value.trim();
Â  Â Â 
Â  Â  if (type === 'TICKET') {
Â  Â  Â  Â  if(!ticketVal) return alert("Enter Ticket ID");
Â  Â  Â  Â  scanMode = 'TECH_TICKET_SCAN';
Â  Â  Â  Â  await window.onScanSuccess(ticketVal); // Passes the manual text to the master handler
Â  Â  } else {
Â  Â  Â  Â  if(!productVal) return alert("Enter Asset Tag ID");
Â  Â  Â  Â  scanMode = 'TECH_PRODUCT_VERIFY';
Â  Â  Â  Â  await window.onScanSuccess(productVal);
Â  Â  }
};

window.resetTechVerification = () => {
Â  Â  // 1. Clear Logic Variables
Â  Â  techVerifiedTicket = null;
Â  Â  techVerifiedTicketKey = null;

Â  Â  // 2. Reset UI Elements
Â  Â  const idsToHide = [
Â  Â  Â  Â  "ticketVerifiedLabel", "productVerifiedLabel",Â 
Â  Â  Â  Â  "techMismatchArea", "techDiagnosisArea"
Â  Â  ];
Â  Â  idsToHide.forEach(id => {
Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  if(el) el.classList.add("hidden");
Â  Â  });

Â  Â  // 3. Reset Buttons & Inputs
Â  Â  document.getElementById("btnScanProduct").disabled = true;
Â  Â  document.getElementById("manualProductInp").disabled = true;
Â  Â  document.getElementById("btnManualProduct").disabled = true;
Â  Â  document.getElementById("manualTicketInp").value = "";
Â  Â  document.getElementById("manualProductInp").value = "";

Â  Â  // 4. Reset Header Text
Â  Â  const title = document.getElementById("techStepTitle");
Â  Â  if(title) {
Â  Â  Â  Â  title.innerText = "Security Protocol: Physical Product Verification";
Â  Â  Â  Â  title.style.color = "#232f3e";
Â  Â  }

Â  Â  alert("Diagnostic Protocol Reset.");
};
Â  window.adminDeleteSaleRecord = async (itemKey) => {
Â  Â  if(!isAdmin) return alert("Unauthorized");
Â  Â  if(!confirm("CRITICAL: Wipe Invoice data for this item? The item will be restocked and the sale log deleted.")) return;

Â  Â  try {
Â  Â  Â  Â  const snap = await get(ref(db, `inventory/${itemKey}`));
Â  Â  Â  Â  const v = snap.val();
Â  Â  Â  Â Â 
Â  Â  Â  Â  await update(ref(db, `inventory/${itemKey}`), {
Â  Â  Â  Â  Â  Â  status: "In Stock",
Â  Â  Â  Â  Â  Â  holder: "Store",
Â  Â  Â  Â  Â  Â  invoiceNo: null, // Wipe Invoice
Â  Â  Â  Â  Â  Â  assignedStation: null,
Â  Â  Â  Â  Â  Â  soldAt: null
Â  Â  Â  Â  });

Â  Â  Â  Â  alert("âœ… Sale record wiped. Item is back in Store.");
Â  Â  Â  Â  loadInventory();
Â  Â  } catch(e) { alert(e.message); }
};
// ==========================================
// ğŸ› ï¸ FINAL CONSOLIDATED SCANNER CONTROLLER
// ==========================================
window.onScanSuccess = async function(decodedText) {
Â  Â  if (!decodedText) return;
Â  Â  closeBarcodeScanner();
Â  Â  const input = decodedText.trim();

Â  Â  try {
Â  Â  Â  Â  // --- MODE A: TICKET SYSTEM (TECH TICKET SCAN) ---
Â  Â  Â  Â  if (scanMode === 'TECH_TICKET_SCAN') {
Â  Â  Â  Â  Â  Â  const cleanId = input.replace("#", "").toUpperCase();
Â  Â  Â  Â  Â  Â  const allClaims = await get(ref(db, "warranty_claims"));
Â  Â  Â  Â  Â  Â  let found = false;
Â  Â  Â  Â  Â  Â  allClaims.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const shortId = c.key.substring(1, 10).toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  if (shortId === cleanId || c.key === input) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  techVerifiedTicket = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  techVerifiedTicketKey = c.key;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  found = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (found) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("ticketVerifiedLabel").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("btnScanProduct").disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("techStepTitle").innerText = "TICKET LOADED. SCAN ASSET.";
Â  Â  Â  Â  Â  Â  } else { alert("âŒ Ticket Not Found"); }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MODE B: TICKET SYSTEM (PRODUCT VERIFY + AUTO REJECT) ---
Â  Â  Â  Â  else if (scanMode === 'TECH_PRODUCT_VERIFY') {
Â  Â  Â  Â  Â  Â  const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(input));
Â  Â  Â  Â  Â  Â  const snap = await get(q);
Â  Â  Â  Â  Â  Â  let itemData = null;
Â  Â  Â  Â  Â  Â  if (snap.exists()) snap.forEach(c => itemData = c.val());

Â  Â  Â  Â  Â  Â  if (itemData && itemData.item === techVerifiedTicket.item) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("productVerifiedLabel").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  renderTechArea(techVerifiedTicketKey, techVerifiedTicket);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await update(ref(db, `warranty_claims/${techVerifiedTicketKey}`), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: "Rejected",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminRemarks: "AUTO-REJECT: Tag Mismatch.",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolutionDate: serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  alert("â›” SECURITY ALERT: MISMATCH. Ticket REJECTED.");
Â  Â  Â  Â  Â  Â  Â  Â  resetTechVerification();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MODE C: ASSET MOVEMENT (CHECKOUT/RETURN) ---
Â  Â  Â  Â  else if (scanMode === 'CHECKOUT' || scanMode === 'RETURN') {
Â  Â  Â  Â  Â  Â  const isOut = (scanMode === 'CHECKOUT');
Â  Â  Â  Â  Â  Â  const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(input));
Â  Â  Â  Â  Â  Â  const snap = await get(q);
Â  Â  Â  Â  Â  Â  if (!snap.exists()) return alert("âŒ Tag Not Registered");
Â  Â  Â  Â  Â  Â  let itm; snap.forEach(c => itm = {key: c.key, ...c.val()});

Â  Â  Â  Â  Â  Â  if (isOut && itm.status === "Sold Out") return alert("â›” SOLD OUT: Cannot Checkout.");
Â  Â  Â  Â  Â  Â  if (!isOut && itm.status === "In Stock") return alert("â›” ALREADY IN STOCK.");

Â  Â  Â  Â  Â  Â  pendingTransactionItem = itm;
Â  Â  Â  Â  Â  Â  currentTransactionType = scanMode;Â 
Â  Â  Â  Â  Â  Â  document.getElementById(isOut ? "checkout_display" : "return_display").classList.remove("hidden");
Â  Â  Â  Â  Â  Â  document.getElementById(isOut ? "checkout_item_name" : "return_item_name").innerHTML = `âœ” ${itm.item}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MODE D: WARRANTY CLAIM (SCAN & CLAIM ENGINE) ---
Â  Â  Â  Â  // This replaces the 'WARRANTY_CLAIM' block inside window.onScanSuccess
else if (scanMode === 'WARRANTY_CLAIM') {
Â  Â  const qWar = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(input));
Â  Â  const snap = await get(qWar);
Â  Â  if (!snap.exists()) return alert("âŒ Tag Not Registered");
Â  Â Â 
Â  Â  let item; snap.forEach(c => item = c.val());
Â  Â  const war = calculateWarranty(item.soldAt, item.warrantyMonths, item.manualWarDate);
Â  Â Â 
Â  Â  document.getElementById("claimDisplay").classList.remove("hidden");
Â  Â  document.getElementById("claimItemName").innerText = item.item;
Â  Â  document.getElementById("claimInv").innerText = item.invoiceNo || "N/A";
Â  Â  document.getElementById("claimSite").innerText = item.assignedStation || "IN STORE";
Â  Â Â 
Â  Â  // FIX: Populate the Sale Date field
Â  Â  const saleDateLabel = document.getElementById("claimDate");
Â  Â  if(saleDateLabel) {
Â  Â  Â  Â  saleDateLabel.innerText = item.soldAt ? new Date(item.soldAt).toLocaleDateString('en-IN') : "N/A (Stock)";
Â  Â  }
Â  Â Â 
Â  Â  const statusBox = document.getElementById("claimStatusBox");
Â  Â  if (war && !war.expired) {
Â  Â  Â  Â  statusBox.innerHTML = `<div style="color:green; font-weight:900;">âœ… WARRANTY ACTIVE: ${war.daysLeft} DAYS LEFT</div>`;
Â  Â  Â  Â  document.getElementById("btnFinalClaim").disabled = false;
Â  Â  } else {
Â  Â  Â  Â  statusBox.innerHTML = `<span style="color:red; font-weight:900;">ğŸš« WARRANTY EXPIRED / VOID</span>`;
Â  Â  Â  Â  document.getElementById("btnFinalClaim").disabled = true;
Â  Â  }
}

Â  Â  Â  Â  // --- MODE E: BINDING TO INPUTS (ADD, AUDIT, BILLING, SEARCH) ---
Â  Â  Â  Â  else if (scanMode === 'ADD') {Â 
Â  Â  Â  Â  Â  Â  document.getElementById("invBarcode").value = input;Â 
Â  Â  Â  Â  Â  Â  checkBarcodeUnique(input);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (scanMode === 'AUDIT_SEARCH') {Â 
Â  Â  Â  Â  Â  Â  document.getElementById("auditSearchInput").value = input;Â 
Â  Â  Â  Â  Â  Â  fetchAuditHistory(input);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (scanMode === 'BILLING_SCAN') {Â 
Â  Â  Â  Â  Â  Â  document.getElementById("billBarcodeInp").value = input;Â 
Â  Â  Â  Â  Â  Â  addScannedItemToBill();Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (scanMode === 'SEARCH_STOCK') {Â 
Â  Â  Â  Â  Â  Â  document.getElementById("mainStockSearch").value = input;Â 
Â  Â  Â  Â  Â  Â  filterStockTable();Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (scanMode === 'ASSET_RECOVERY') {Â 
Â  Â  Â  Â  Â  Â  addToRecoveryCart(input);Â 
Â  Â  Â  Â  }

Â  Â  } catch (err) { console.error(err); }
};
</script>
<div id="bigImageModal" class="modal-overlay hidden" onclick="document.getElementById('bigImageModal').classList.add('hidden')">
Â  Â  <div class="panel" style="background: transparent; border: none; box-shadow: none; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 0;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="position: relative; max-width: 95%; max-height: 95%;">
Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('bigImageModal').classList.add('hidden')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style="position: absolute; top: -15px; right: -15px; background: red; color: white; border: 2px solid white; border-radius: 50%; width: 40px; height: 40px; font-weight: bold; cursor: pointer; z-index: 1002;">
Â  Â  Â  Â  Â  Â  Â  Â  X
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <img id="bigImageViewer" src=""Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â style="max-width: 100%; max-height: 90vh; border: 4px solid white; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.9); object-fit: contain;">
Â  Â  Â  Â  </div>

Â  Â  </div>
</div>
</body>
</html>
