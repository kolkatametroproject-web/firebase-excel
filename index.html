<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
/* --- OFFICIAL METRO THEME (EXACTLY AS REQUESTED) --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f0f2f5;
  --panel-white: #ffffff;
  --text-dark: #212529;
}

body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text-dark); font-size: 14px; }

/* HEADER & BRANDING */
header {
  background: var(--metro-blue);
  color: white;
  padding: 12px 20px;
  border-bottom: 4px solid var(--metro-gold);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.brand { display: flex; align-items: center; gap: 12px; }
.logo-box { width: 42px; height: 42px; background: white; color: var(--metro-blue); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 24px; border-radius: 4px; }
.brand h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.5px; }
.brand small { font-size: 0.8rem; opacity: 0.8; font-weight: 400; }

/* BUTTONS */
button { padding: 8px 14px; cursor: pointer; border: 1px solid transparent; border-radius: 4px; font-weight: 600; font-size: 13px; transition: 0.2s; }
button.primary { background: #0056b3; color: white; border-color: #004085; }
button.primary:hover { background: #004085; }
button.danger { background: #dc3545; color: white; border-color: #bd2130; }
button.success { background: #28a745; color: white; border-color: #1e7e34; }
/* Added Warning style for the Re-register button */
button.warning { background: #ffc107; color: #212529; border-color: #e0a800; }
button:disabled { background: #6c757d; cursor: not-allowed; opacity: 0.7; }

/* FORMS */
input, select, textarea {
  width: 100%; padding: 9px; margin-bottom: 12px;
  border: 1px solid #ced4da; border-radius: 4px;
  box-sizing: border-box; font-size: 14px;
}
input:focus { outline: none; border-color: var(--metro-blue); box-shadow: 0 0 0 2px rgba(0,51,102,0.2); }

/* LAYOUT */
.container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
.panel { background: var(--panel-white); padding: 25px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #e9ecef; }
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2rem; }

/* UTILS */
.hidden { display: none !important; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.label-head { font-size: 0.75rem; font-weight: 700; color: #6c757d; text-transform: uppercase; margin-bottom: 5px; display: block; }

/* TABLES */
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: #f8f9fa; color: #495057; font-weight: 700; text-transform: uppercase; padding: 12px; border: 1px solid #dee2e6; text-align: left; }
td { padding: 10px; border: 1px solid #dee2e6; color: #212529; }
tr:nth-child(even) { background-color: #fcfcfc; }

/* BIOMETRIC MODAL */
#faceModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
#cameraFeed { width: 320px; height: 240px; background: #000; border: 4px solid white; box-shadow: 0 0 25px rgba(0,0,0,0.5); transform: scaleX(-1); border-radius: 4px; }
.face-status { margin-top: 15px; font-weight: bold; font-size: 1.1rem; min-height: 24px; color: var(--metro-gold); }

/* LOGS */
.log-badge { padding: 3px 8px; border-radius: 3px; color: white; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.bg-LOGIN { background: #28a745; }
.bg-SAVE { background: #007bff; }
.bg-DELETE { background: #dc3545; }
.bg-SUBMIT { background: #6610f2; }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo-box">M</div>
    <div>
      <h1>Metro Railway Safety Project</h1>
      <small>Secure Data Management Portal</small>
    </div>
  </div>
  <div id="authNav" class="hidden" style="display:flex; align-items:center; gap:15px;">
    <span id="userDisplay" style="font-weight:600; font-size:13px;"></span>
    <button class="danger" onclick="logout()">LOGOUT</button>
  </div>
</header>

<section id="loginScreen" class="container">
  <div class="panel" style="max-width:380px; margin: 60px auto; border-top: 4px solid var(--metro-blue);">
    <h3>üîê Authorized Login</h3>
    <label class="label-head">Email ID</label>
    <input id="email" type="email" placeholder="official@metro.rail">
    <label class="label-head">Password</label>
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button class="primary" style="width:100%; margin-top:10px; padding:10px;" onclick="login()">AUTHENTICATE</button>
    <p style="text-align:center; margin-top:15px; color:#6c757d; font-size:12px;">
      Only authorized personnel permitted.<br>System logs are monitored.
    </p>
  </div>
</section>

<div id="faceModal" class="hidden">
  <h2 id="modalTitle" style="margin-bottom:5px;">Identity Verification</h2>
  <p id="modalDesc" style="color:#adb5bd; margin-bottom:20px; font-size:14px;">Initializing AI Models...</p>
   
  <video id="cameraFeed" autoplay playsinline muted></video>
   
  <div id="faceStatus" class="face-status"></div>
   
  <div style="margin-top:20px; display:flex; gap:10px;">
    <button id="btnCapture" class="primary" style="background:white; color:black; border:none; padding:10px 25px;" onclick="handleFaceScan()">üì∏ Capture & Verify</button>
    <button id="btnReRegister" class="warning hidden" onclick="startReRegistration()">‚ö†Ô∏è Update Face Data</button>
  </div>
   
  <canvas id="procCanvas" width="320" height="240" class="hidden"></canvas>
  <canvas id="compCanvas" width="32" height="32" class="hidden"></canvas>
</div>

<section id="appScreen" class="container hidden">
   
  <div style="margin-bottom:20px; display:flex; gap:10px; border-bottom:1px solid #ddd; padding-bottom:15px;">
    <button class="primary" onclick="showTab('entry')">1. Data Entry</button>
    <button class="primary" onclick="showTab('history')">2. History</button>
    <button class="primary" onclick="showTab('inventory')">3. Inventory</button>
    <button class="danger hidden" id="adminBtn" onclick="showTab('admin')">4. Admin Panel</button>
  </div>

  <div id="tab-entry" class="panel">
    <h3>üìù Station Platform Details</h3>
    <div class="grid-2">
      <div><label class="label-head">Station Name</label><input id="stName" placeholder="e.g. Esplanade"></div>
      <div><label class="label-head">Platform Length (M)</label><input id="stLen" placeholder="170.5"></div>
      <div><label class="label-head">Yellow Line Offset</label><input id="ylDist" placeholder="70 cm"></div>
      <div><label class="label-head">Line Thickness</label><input id="ylThick" placeholder="10 cm"></div>
    </div>
    <div style="text-align:right; margin-bottom:20px;">
      <button class="success" onclick="saveDraft()">üíæ Save Draft</button>
    </div>

    <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">Distance Data Points</h4>
    <table id="dataTable">
      <thead><tr><th>SL</th><th>Rake No</th><th>Type</th><th>Front Dist</th><th>Rear Dist</th><th>Action</th></tr></thead>
      <tbody id="dataBody"></tbody>
    </table>
    <div style="margin-top:15px; display:flex; justify-content:space-between;">
      <button onclick="addRow()">+ Add Row</button>
      <button class="primary" onclick="submitFinal()">‚úî Submit to Archive</button>
    </div>
  </div>

  <div id="tab-history" class="panel hidden">
    <h3>üìÅ Submission History</h3>
    <table>
      <thead><tr><th>Date</th><th>Station</th><th>User</th><th>Rows</th><th id="histAction" class="hidden">Action</th></tr></thead>
      <tbody id="histBody"></tbody>
    </table>
  </div>

  <div id="tab-inventory" class="panel hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üì¶ Stock Inventory</h3>
        <button class="success" onclick="document.getElementById('invForm').classList.toggle('hidden')">+ Add Item</button>
    </div>
    
    <div id="invForm" class="hidden" style="background:#f8f9fa; padding:15px; border:1px solid #dee2e6; margin-bottom:15px;">
        <div class="grid-2">
            <input id="invItem" placeholder="Item Name">
            <input id="invQty" type="number" placeholder="Quantity">
        </div>
        <button class="primary" onclick="addInventory()">Add to Stock</button>
    </div>

    <table>
      <thead><tr><th>Item</th><th>Qty</th><th>Updated By</th><th>Action</th></tr></thead>
      <tbody id="invBody"></tbody>
    </table>
  </div>

  <div id="tab-admin" class="panel hidden" style="border-top: 4px solid var(--metro-red);">
    <h3>üõ°Ô∏è Administrator Controls</h3>
    
    <div style="margin-bottom:20px;">
        <label class="label-head">Audit User Logs (Last 10 Actions)</label>
        <div style="display:flex; gap:10px;">
            <select id="userSelect"><option>Select User...</option></select>
            <button onclick="fetchLogs()">View Logs</button>
        </div>
    </div>
    
    <table>
        <thead><tr><th>Time</th><th>Type</th><th>Description</th></tr></thead>
        <tbody id="logBody"><tr><td colspan="3">Select a user to view logs.</td></tr></tbody>
    </table>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo, get, limitToLast } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- GLOBAL STATE ---
let currentUser = null;
let isAdmin = false;
const ADMINS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let tempDescriptor = null; 
let mode = "verify"; 

// --- 1. AUTH & INIT ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        isAdmin = ADMINS.includes(user.email);
        document.getElementById("userDisplay").innerText = user.email;
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("authNav").classList.remove("hidden");
        
        if(isAdmin) {
            document.getElementById("adminBtn").classList.remove("hidden");
            document.getElementById("histAction").classList.remove("hidden");
            loadUserList();
        }

        onValue(ref(db, `users/${user.uid}/faceData`), (snap) => {
            document.getElementById("faceModal").classList.remove("hidden");
            initCamera(snap.exists()); 
        }, { onlyOnce: true });

    } else {
        currentUser = null;
        document.getElementById("loginScreen").classList.remove("hidden");
        document.getElementById("appScreen").classList.add("hidden");
        document.getElementById("authNav").classList.add("hidden");
        stopCamera();
    }
});

window.login = () => {
    const e = document.getElementById("email").value;
    const p = document.getElementById("password").value;
    signInWithEmailAndPassword(auth, e, p).catch(err => alert("Login Failed: " + err.message));
};

window.logout = () => {
    logAction("LOGOUT", "User signed out").then(() => signOut(auth));
};

// --- 2. LOGGING ---
async function logAction(type, desc) {
    if(!currentUser) return;
    const email = currentUser.email;
    await push(ref(db, "logs"), { user: email, type, desc, time: new Date().toLocaleString() });

    const logRef = ref(db, "logs");
    const q = query(logRef, orderByChild("user"), equalTo(email));
    get(q).then((snap) => {
        if(snap.exists()) {
            const logs = [];
            snap.forEach(c => logs.push({key: c.key, ...c.val()}));
            if(logs.length > 10) {
                const toDelete = logs.length - 10;
                for(let i=0; i<toDelete; i++) remove(ref(db, `logs/${logs[i].key}`));
            }
        }
    });
}

// --- 3. BIOMETRIC LOGIC (Professional) ---
async function initCamera(hasData) {
    const vid = document.getElementById("cameraFeed");
    try {
        updateStatus("üîÑ Loading AI...", "yellow");
        // Load professional models
        const modelUrl = 'https://justadudewhohacks.github.io/face-api.js/models';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
            faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
            faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
        ]);

        // MOBILE OPTIMIZATION
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } } 
        });
        vid.srcObject = stream;
        
        if (!hasData) {
            startRegistration();
        } else {
            mode = "verify";
            updateStatus("üîí VERIFICATION: Look at camera", "white");
        }
    } catch(e) { 
        console.error(e); 
        alert("Camera Error: " + e.message); 
    }
}

function startRegistration() {
    mode = "register";
    tempDescriptor = null;
    updateStatus("‚ö†Ô∏è REGISTRATION: Capture Photo 1", "white");
    document.getElementById("btnReRegister").classList.add("hidden");
    document.getElementById("btnCapture").disabled = false;
}

window.startReRegistration = () => {
    if(confirm("Start Face Re-registration process?")) {
        startRegistration();
    }
}

function stopCamera() {
    if(stream) stream.getTracks().forEach(t => t.stop());
    document.getElementById("faceModal").classList.add("hidden");
}

function updateStatus(msg, color) {
    const el = document.getElementById("faceStatus");
    el.innerText = msg;
    el.style.color = color;
}

// HELPER: Upgrade old data if needed
async function getDescriptorFromImage(base64Str) {
    return new Promise((resolve) => {
        const img = document.createElement('img');
        img.src = base64Str;
        img.onload = async () => {
            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.5 });
            const detection = await faceapi.detectSingleFace(img, options).withFaceLandmarks().withFaceDescriptor();
            resolve(detection ? detection.descriptor : null);
        };
        img.onerror = () => resolve(null);
    });
}

window.handleFaceScan = async () => {
    const vid = document.getElementById("cameraFeed");
    const btn = document.getElementById("btnCapture");
    btn.disabled = true;
    updateStatus("üß† Analyzing...", "cyan");

    // 1. Detect
    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.5 });
    const detection = await faceapi.detectSingleFace(vid, options).withFaceLandmarks().withFaceDescriptor();

    if (!detection) {
        updateStatus("‚ùå No Face Detected.", "red");
        btn.disabled = false;
        return;
    }

    const currentDescriptor = detection.descriptor;
    
    // Capture Visual for DB
    const canvas = document.getElementById("procCanvas");
    canvas.getContext("2d").drawImage(vid, 0, 0, 320, 240);
    const currentImg = canvas.toDataURL("image/png");

    if (mode === "register") {
        if (!tempDescriptor) {
            tempDescriptor = currentDescriptor;
            updateStatus("‚úÖ Photo 1 Saved. Tilt Head & Capture Photo 2.", "lime");
            btn.disabled = false;
        } else {
            // Save
            await update(ref(db, `users/${currentUser.uid}/faceData`), {
                img1: currentImg, 
                desc1: Array.from(tempDescriptor),
                desc2: Array.from(currentDescriptor)
            });
            logAction("LOGIN", "Biometric Registration Complete");
            enterApp();
        }
    } else {
        // VERIFY
        const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
        const stored = snap.val();
        
        let storedDescriptor = null;
        if (stored.desc1) {
            storedDescriptor = new Float32Array(stored.desc1);
        } else if (stored.img1) {
            updateStatus("‚ö†Ô∏è Upgrading profile...", "orange");
            storedDescriptor = await getDescriptorFromImage(stored.img1);
            if(storedDescriptor) {
                 await update(ref(db, `users/${currentUser.uid}/faceData`), { desc1: Array.from(storedDescriptor) });
            }
        }

        if (!storedDescriptor) {
             updateStatus("‚ùå Profile Error. Resetting.", "red");
             startRegistration();
             return;
        }
        
        // --- THE CONDITION LOGIC ---
        const distance = faceapi.euclideanDistance(currentDescriptor, storedDescriptor);
        let score = Math.floor((1 - distance) * 100);
        if(score > 99) score = 99;

        // 1. SUCCESS: >= 65%
        if (score >= 65) { 
            updateStatus(`‚úÖ Verified: ${score}% Match`, "lime");
            logAction("LOGIN", `Biometric Success (${score}%)`);
            setTimeout(enterApp, 1000);
            
        // 2. WARNING: 58% to 64% -> Show Update Button
        } else if (score >= 58) {
            updateStatus(`‚ö†Ô∏è Weak Match (${score}%). Update Needed.`, "orange");
            document.getElementById("btnReRegister").classList.remove("hidden");
            btn.disabled = false; 
            
        // 3. FAIL: < 58%
        } else {
            updateStatus(`‚õî Access Denied: ${score}% (Below 58)`, "red");
            document.getElementById("btnReRegister").classList.add("hidden");
            btn.disabled = false;
        }
    }
};

function enterApp() {
    stopCamera();
    document.getElementById("appScreen").classList.remove("hidden");
    showTab('entry');
    loadDraft();
    loadHistory();
    loadInventory();
}

// --- 4. APP LOGIC (ADMIN & INVENTORY - UNCHANGED) ---
window.showTab = (id) => {
    document.querySelectorAll('#appScreen > .panel').forEach(p => p.classList.add('hidden'));
    document.getElementById(`tab-${id}`).classList.remove('hidden');
}

function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("stName").value = d.details?.name || "";
            document.getElementById("stLen").value = d.details?.len || "";
            document.getElementById("ylDist").value = d.details?.yl || "";
            document.getElementById("ylThick").value = d.details?.th || "";
            renderRows(d.rows || {});
        }
    });
}

window.saveDraft = () => {
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: document.getElementById("stName").value,
        len: document.getElementById("stLen").value,
        yl: document.getElementById("ylDist").value,
        th: document.getElementById("ylThick").value
    });
    logAction("SAVE", "Draft updated");
    alert("Draft Saved");
}

window.addRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function renderRows(rows) {
    const b = document.getElementById("dataBody"); b.innerHTML = "";
    let i = 1;
    for(const [k, v] of Object.entries(rows)) {
        b.innerHTML += `<tr>
            <td>${i++}</td>
            <td><input value="${v.rake}" onchange="updateRow('${k}','rake',this.value)"></td>
            <td><input value="${v.type}" onchange="updateRow('${k}','type',this.value)"></td>
            <td><input value="${v.f}" onchange="updateRow('${k}','f',this.value)"></td>
            <td><input value="${v.r}" onchange="updateRow('${k}','r',this.value)"></td>
            <td><button class="danger" onclick="delRow('${k}')">X</button></td>
        </tr>`;
    }
}
window.updateRow = (k, f, v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));

window.submitFinal = () => {
    if(confirm("Submit Final Data?")) {
        get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
            const d = s.val();
            push(ref(db, "history"), {
                ...d.details,
                rows: d.rows,
                user: currentUser.email,
                date: new Date().toLocaleString()
            });
            remove(ref(db, `drafts/${currentUser.uid}`));
            logAction("SUBMIT", `Final submission for ${d.details.name}`);
            alert("Submitted Successfully");
            showTab("history");
        });
    }
}

// --- 5. HISTORY & INVENTORY ---
function loadHistory() {
    onValue(ref(db, "history"), snap => {
        const b = document.getElementById("histBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            const rowCount = v.rows ? Object.keys(v.rows).length : 0;
            let btn = "";
            if(isAdmin) btn = `<td><button class="danger" onclick="delHist('${c.key}')">Del</button></td>`;
            b.innerHTML += `<tr><td>${v.date}</td><td>${v.name}</td><td>${v.user}</td><td>${rowCount}</td>${btn}</tr>`;
        });
    });
}
window.delHist = (k) => remove(ref(db, `history/${k}`));

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("invBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr><td>${v.item}</td><td>${v.qty}</td><td>${v.user}</td><td><button class="danger" onclick="delInv('${c.key}')">X</button></td></tr>`;
        });
    });
}
window.addInventory = () => {
    push(ref(db, "inventory"), {
        item: document.getElementById("invItem").value,
        qty: document.getElementById("invQty").value,
        user: currentUser.email
    });
    document.getElementById("invForm").classList.add("hidden");
    logAction("SAVE", "Added Inventory Item");
}
window.delInv = (k) => { logAction("DELETE", "Removed Inventory"); remove(ref(db, `inventory/${k}`)); }

// --- 6. ADMIN ---
function loadUserList() {
    onValue(ref(db, "logs"), snap => {
        const users = new Set();
        snap.forEach(c => users.add(c.val().user));
        const sel = document.getElementById("userSelect");
        sel.innerHTML = "<option>Select User...</option>";
        users.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
    });
}

window.fetchLogs = () => {
    const u = document.getElementById("userSelect").value;
    const q = query(ref(db, "logs"), orderByChild("user"), equalTo(u), limitToLast(10));
    onValue(q, snap => {
        const b = document.getElementById("logBody"); b.innerHTML = "";
        const logs = [];
        snap.forEach(c => logs.push(c.val()));
        logs.reverse().forEach(l => {
            b.innerHTML += `<tr><td>${l.time}</td><td><span class="log-badge bg-${l.type}">${l.type}</span></td><td>${l.desc}</td></tr>`;
        });
    });
}
</script>
</body>
</html>
