<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- OFFICIAL METRO THEME --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
}

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
}
button:hover { background: #004494; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; }
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; transform: scaleX(-1); }

/* UPLOAD SECTION SPECIFIC */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div><h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:300px; text-align:center;">
        <h3>User Profile Setup</h3>
        <p>Please enter your official name for the records.</p>
        <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
  
  <video id="cameraFeed" autoplay playsinline muted></video>
  
  <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:5px; width:280px; box-shadow: 0 0 15px black;">
    <h3 style="color:#dc3545; margin-top:0;">Face ID Failed (3/3)</h3>
    <p style="color:#333; font-size:13px;">Camera Disabled for Privacy.<br>Enter OTP/PIN:</p>
    <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:18px; letter-spacing:5px; border:2px solid #dc3545;">
    <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
  </div>

  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold;"></div>
  
  <div id="camControls" style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Face Scan</button>
  </div>

  <button id="adminBypassBtn" class="danger hidden" style="margin-top:20px;" onclick="forceAdminEntry()">‚ö†Ô∏è ADMIN FORCE ENTRY</button>
  <canvas id="procCanvas" width="320" height="240" class="hidden"></canvas>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <input id="inpStationName" placeholder="STATION NAME">
          <input id="inpStationLength" placeholder="STATION LENGTH (M)">
          <input id="inpYellowDist" placeholder="YELLOW LINE DIST (CM)">
          <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS (CM)">
      </div>
      <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
      
      <div style="text-align:right;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Draft</button>
      </div>
    </div>

    <div class="panel upload-panel">
      <h3 style="color:#003366; margin-top:0;">üìé Evidence Upload Section</h3>
      <p style="font-size:12px; color:#666;">Upload site photos, videos, or PDFs separately here.</p>
      
      <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
      <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
      
      <button class="warning" onclick="uploadEvidenceOnly()">‚¨Ü Upload Evidence to Database</button>
      <div style="margin-top:5px;"><small style="color:red;">* Max 2.5 MB per file</small></div>
    </div>

    <div class="panel">
      <h4>Distance Data</h4>
      <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final Data</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between;"><h3>üì¶ Inventory</h3><button class="success" onclick="document.getElementById('addInvForm').classList.toggle('hidden')">+ New Item</button></div>
        <div id="addInvForm" class="hidden" style="padding:15px; border:1px solid #ccc; margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 100px; gap:10px;">
                <input id="invName" placeholder="Product Name"><input id="invQty" type="number" placeholder="Qty"><button onclick="addInventory()">Save</button>
            </div>
        </div>
        <table><thead><tr><th>Product</th><th>Qty</th><th>User</th><th>Action</th></tr></thead><tbody id="inventoryBody"></tbody></table>
    </div>
  </div>

  <div id="tab-gallery" class="hidden">
    <div class="panel">
      <h3>üìÅ Site Evidence Gallery</h3>
      <div id="galleryContainer" class="gallery-grid"></div>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã My Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ°Ô∏è Administrator Console</h3>
        <button onclick="loadAdminPanel()" class="primary">üîÑ Refresh</button>
      </div>

      <h4 style="background:#eee; padding:5px;">1. Work Assignment</h4>
      
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:15px; background:#f9f9f9;">
          <strong>Manage Groups:</strong>
          <div style="display:flex; gap:10px; margin-top:5px;">
              <input id="newGroupName" placeholder="New Group Name (e.g. Shift A)" style="width:50%; margin:0;">
              <button onclick="createGroup()" style="width:auto;">Create Group</button>
          </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 2fr 100px; gap:10px; margin-bottom:20px;">
        <select id="assignTarget"><option>Loading...</option></select>
        <textarea id="taskDesc" rows="1" placeholder="Task details..."></textarea>
        <button onclick="assignTask()">Assign</button>
      </div>

      <h5 style="color:#666;">Global Task Status Report</h5>
      <table style="margin-bottom:20px;">
          <thead><tr><th>To</th><th>Task</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="globalTaskBody"></tbody>
      </table>

      <h4 style="background:#eee; padding:5px;">2. User Access & Logs</h4>
      <table><thead><tr><th>Name (User)</th><th>Status</th><th>Action</th><th>Logs</th></tr></thead><tbody id="userListBody"></tbody></table>
      
      <h5 style="color:#666;">Detailed Login Logs</h5>
      <div style="max-height:200px; overflow-y:scroll; border:1px solid #ddd;">
        <table><thead><tr><th>Time</th><th>User</th><th>Method</th><th>Details</th></tr></thead><tbody id="detailedLogBody"></tbody></table>
      </div>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo, get, limitToLast } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let mode = "verify";
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0; // COUNTER FOR FAILS

// --- AUTH ---
onAuthStateChanged(auth, (user) => {
  if (!user) { showLogin(); return; }
  
  update(ref(db, `users/${user.uid}`), { email: user.email });

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const u = snap.val();
    if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    currentUser = user;
    isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
    failCount = 0; // Reset fails on fresh login
    
    if (!u.name) {
        document.getElementById("nameModal").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        return;
    }

    // Set PIN if missing
    if (!u.pin) { update(ref(db, `users/${user.uid}`), { pin: "1234" }); }

    document.getElementById("userInfo").innerText = `${u.name} (${user.email})`;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("adminBypassBtn").classList.remove("hidden");
      setTimeout(loadAdminPanel, 1000); 
    }

    document.getElementById("faceModal").classList.remove("hidden");
    initCamera(true);
  });
});

window.saveOfficialName = () => {
    const name = document.getElementById("officialNameInput").value;
    if(name.length < 3) return alert("Enter full valid name.");
    update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
        document.getElementById("nameModal").classList.add("hidden");
        location.reload(); 
    });
}

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
window.logout = () => { if(currentUser) logActivity("LOGOUT", "Exit"); signOut(auth); };

// --- BIOMETRICS ---
async function initCamera(hasData) {
    const vid = document.getElementById("cameraFeed");
    try {
        updateStatus("Loading AI...", "yellow");
        const modelUrl = 'https://justadudewhohacks.github.io/face-api.js/models';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
            faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
            faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
        ]);
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        vid.srcObject = stream;
        updateStatus("üîí VERIFICATION REQUIRED", "white");
    } catch(e) { updateStatus("Camera Failed.", "red"); }
}

// *** PRIVACY PROTECTION: HARD STOP ***
function stopCamera() { 
    if(stream) {
        stream.getTracks().forEach(t => t.stop()); // Kill hardware light
        stream = null;
    }
    const vid = document.getElementById("cameraFeed");
    if(vid) vid.srcObject = null;
    document.getElementById("faceModal").classList.add("hidden"); 
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); e.innerText=m; e.style.color=c; }

window.handleFaceScan = async () => {
    const vid = document.getElementById("cameraFeed");
    const btn = document.getElementById("btnCapture");
    btn.disabled = true; updateStatus("Scanning...", "cyan");

    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.5 });
    const detection = await faceapi.detectSingleFace(vid, options).withFaceLandmarks().withFaceDescriptor();

    if(!detection) { 
        updateStatus("‚ùå No Face Detected", "red"); 
        handleFail();
        btn.disabled = false;
        return; 
    }
    
    // Logic: In prod, compare detection.descriptor. Demo: Simulating 50% threshold logic.
    // If logic passes:
    logActivity("LOGIN [Face]", "Biometric Success");
    enterApp();
    // If fail logic needed: handleFail();
};

function handleFail() {
    failCount++;
    const attemptsLeft = 3 - failCount;
    if(failCount >= 3) {
        // TRIGGER OTP MODE
        stopCamera(); // Hard Stop Camera
        document.getElementById("faceModal").classList.remove("hidden"); // Keep modal open
        document.getElementById("cameraFeed").classList.add("hidden");
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden"); // Show PIN Input
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${attemptsLeft}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            alert("PIN Verified ‚úÖ");
            logActivity("LOGIN [OTP]", "PIN Entry Success");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

window.forceAdminEntry = () => {
    if(!isAdmin) return;
    logActivity("LOGIN [Admin Bypass]", "Force Entry Used");
    enterApp();
}

function enterApp() {
    stopCamera(); // Double Ensure camera is DEAD
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadGallery(); loadInventory(); loadAssignments();
}

// --- APP FEATURES ---

window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    const len = document.getElementById("inpStationLength").value.trim();
    const yl = document.getElementById("inpYellowDist").value.trim();
    const th = document.getElementById("inpYellowThick").value.trim();
    const rem = document.getElementById("inpRemarks").value.trim();

    if(!name || !len || !yl || !th || !rem) {
        return alert("‚ùå ERROR: All fields (including Remarks) must be filled.");
    }

    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name, len: len, yl: yl, th: th, remarks: rem
    });
    logActivity("SAVE", "Draft Updated"); alert("Draft Saved");
};

// SEPARATE EVIDENCE UPLOAD FUNCTION
window.uploadEvidenceOnly = () => {
    if(!currentFileBase64) return alert("Please select a file first.");
    
    if(confirm("Upload this file to the Evidence Gallery?")) {
        push(ref(db, "history"), { 
            name: "Evidence Upload", 
            user: currentUser.email, 
            userName: currentUser.name, 
            date: new Date().toLocaleString(),
            fileData: currentFileBase64, 
            fileType: currentFileType
        });
        
        // Reset inputs
        document.getElementById("evidenceFile").value = "";
        document.getElementById("fileStatus").innerText = "";
        currentFileBase64 = null;
        alert("Evidence Uploaded Successfully.");
        switchTab('gallery');
    }
};

window.submitStationData = () => {
    get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
        const d = s.val();
        if(!d || !d.details || !d.details.name || !d.details.len || !d.details.yl || !d.details.th || !d.details.remarks) {
            return alert("‚ùå ERROR: Station Details incomplete.");
        }
        if(!d.rows) return alert("‚ùå ERROR: Distance Data table is empty.");

        let isValid = true;
        Object.values(d.rows).forEach(row => { if(!row.rake || !row.type || !row.f || !row.r) isValid = false; });
        if(!isValid) return alert("‚ùå ERROR: Table rows are incomplete.");

        if(confirm("Submit Final Data?")) {
            push(ref(db, "history"), { 
                ...d.details, rows: d.rows, user: currentUser.email, userName: currentUser.name, date: new Date().toLocaleString()
            });
            remove(ref(db, `drafts/${currentUser.uid}`));
            alert("Submitted Successfully"); switchTab('gallery');
        }
    });
};

// 2. Admin Logic
window.loadAdminPanel = () => {
    const targetSel = document.getElementById("assignTarget");
    const userTable = document.getElementById("userListBody");
    const reportTable = document.getElementById("globalTaskBody");
    const logTable = document.getElementById("detailedLogBody");
    
    targetSel.innerHTML = `<option value="ALL">-- Assign to ALL Users --</option>`;

    get(ref(db, "groups")).then(snap => {
        if(snap.exists()) {
            snap.forEach(g => { targetSel.innerHTML += `<option value="GRP_${g.key}">üë• Group: ${g.val().name}</option>`; });
        }
    });

    get(ref(db, "users")).then(snap => {
        userTable.innerHTML = "";
        snap.forEach(c => {
            const u = c.val();
            const uid = c.key;
            targetSel.innerHTML += `<option value="${uid}">üë§ ${u.name || u.email}</option>`;

            const pinDisplay = `<small>PIN: ${u.pin || '1234'}</small>`;
            const reUploadBtn = `<button class="danger" style="padding:2px 5px;" onclick="forceReUpload('${uid}')">Force Re-upload</button>`;
            const retakeNameBtn = `<button class="warning" style="padding:2px 5px;" onclick="retakeName('${uid}')">Reset Name</button>`;

            userTable.innerHTML += `<tr><td>${u.name || "Unknown"} <br><small>${u.email}</small></td><td>${u.terminated ? "BANNED" : "Active"}</td><td>${pinDisplay} ${reUploadBtn}</td><td>${retakeNameBtn}</td></tr>`;
        });
    });

    get(ref(db, "assignments")).then(snap => {
        reportTable.innerHTML = "";
        snap.forEach(userNode => {
            userNode.forEach(task => {
                const t = task.val();
                const clearBtn = `<button class="danger" style="padding:2px 5px; font-size:10px;" onclick="removeTask('${userNode.key}', '${task.key}')">Clear</button>`;
                reportTable.innerHTML += `<tr><td>${userNode.key.substring(0,5)}...</td><td>${t.desc}</td><td style="color:${t.status=='Done'?'green':'red'}">${t.status}</td><td>${clearBtn}</td></tr>`;
            });
        });
    });

    // NEW LOG VIEWER
    onValue(query(ref(db, "logs"), limitToLast(20)), s => {
        logTable.innerHTML = "";
        const l = []; s.forEach(c=>l.push(c.val()));
        l.reverse().forEach(x => logTable.innerHTML += `<tr><td>${x.time}</td><td>${x.user}</td><td>${x.type}</td><td>${x.desc}</td></tr>`);
    });
}

window.createGroup = () => {
    const gName = document.getElementById("newGroupName").value;
    if(gName) { push(ref(db, "groups"), {name: gName}); alert("Group Created"); loadAdminPanel(); }
}

window.forceReUpload = (uid) => {
    if(confirm("Delete user's biometric data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset.")); }
}
window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));
window.removeTask = (uid, tid) => remove(ref(db, `assignments/${uid}/${tid}`)).then(loadAdminPanel);

window.assignTask = () => {
    const target = document.getElementById("assignTarget").value;
    const desc = document.getElementById("taskDesc").value;
    const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };

    if(target === "ALL") {
        get(ref(db, "users")).then(snap => { snap.forEach(u => push(ref(db, `assignments/${u.key}`), task)); });
        alert("Assigned to Everyone");
    } else {
        push(ref(db, `assignments/${target}`), task);
        alert("Assigned to User");
    }
};

async function logActivity(type, desc) { if(currentUser) await push(ref(db, "logs"), { user: currentUser.email, type, desc, time: new Date().toLocaleString() }); }

window.switchTab = (t) => {
    ['newData','inventory','gallery','assigned','adminPanel'].forEach(x => document.getElementById(`tab-${x}`).classList.add("hidden"));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.remove("hidden");
    if(t==='adminPanel' && isAdmin) loadAdminPanel();
    if(t==='gallery') loadGallery();
};

window.handleFileUpload = () => {
    const file = document.getElementById("evidenceFile").files[0];
    if(file && file.size < 2.5*1024*1024) {
        const reader = new FileReader();
        reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
        reader.readAsDataURL(file);
    } else { alert("File too large!"); }
}

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
    onValue(ref(db, "history"), snap => {
        const div = document.getElementById("galleryContainer"); div.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            if(v.fileData) {
                let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
                if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
                else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
                
                let controls = `<br><small style="color:grey;">(View Only)</small>`;
                if(isAdmin) {
                    controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
                }
                div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
            }
        });
    });
}

window.removeFile = (k) => {
    if(confirm("Remove attached file to save space?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            document.getElementById("inpRemarks").value = d.details?.remarks || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}
function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("inventoryBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr><td>${v.item}</td><td>${v.qty}</td><td>${v.user}</td><td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td></tr>`;
        });
    });
}
window.addInventory = () => { push(ref(db, "inventory"), { item: invName.value, qty: invQty.value, user: currentUser.email }); document.getElementById("addInvForm").classList.add("hidden"); };
window.delInv = (k) => remove(ref(db, `inventory/${k}`));
function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

</script>
</body>
</html>
