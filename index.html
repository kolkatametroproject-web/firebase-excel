<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metro Railway Safety System | Official Portal</title>
<style>
/* --- OFFICIAL THEME (Light Mode) --- */
:root {
  --official-blue: #003366;
  --official-accent: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--official-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
header small { font-size: 0.8rem; opacity: 0.9; display: block; font-weight: normal; }

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.danger:hover { background: #c82333; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}
input:focus { border-color: #80bdff; outline: none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 {
  margin-top: 0;
  color: var(--official-blue);
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
.nav-btn.active { background: var(--official-blue); color: white; border-color: var(--official-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }
input.cell { border: none; background: transparent; width: 100%; font-size: 13px; }
input.cell:focus { background: #fff; outline: 1px solid #80bdff; }

/* ADMIN */
.admin-badge { background: #ffc107; color: black; padding: 3px 8px; border-radius: 2px; font-size: 11px; font-weight: bold; border: 1px solid #d39e00; margin-left: 10px; }
.audit-table { border: 2px solid var(--official-blue); }
.audit-table th { background: var(--official-blue); color: white; }

/* MODAL */
#faceModal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85); /* Dark overlay */
  display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999;
}
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--official-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div>
      <h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1>
      <small>Secure Data Management Portal</small>
    </div>
    <span id="adminBadge" class="hidden admin-badge">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">User ID:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--official-blue);">
    <h3>Authorized Access Only</h3>
    <p style="font-size:13px; color:#666; margin-bottom:15px;">Please enter your credentials to proceed.</p>
    <label style="font-weight:bold; font-size:12px; display:block; margin-bottom:5px;">Email Address</label>
    <input id="email" placeholder="user@metro.project">
    <label style="font-weight:bold; font-size:12px; display:block; margin-bottom:5px;">Password</label>
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
    <div style="text-align:center; margin-top:15px; font-size:11px; color:#999;">
      Unauthorized access is prohibited.
    </div>
  </div>
</section>

<div id="faceModal" class="hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Identity confirmation required.</p>
  
  <video id="cameraFeed" autoplay playsinline></video>
  <canvas id="faceCanvas" width="320" height="240" class="hidden"></canvas>
  <canvas id="compareCanvas" width="32" height="32" class="hidden"></canvas>

  <button id="btnCapture" onclick="handleFaceCapture()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Capture Photo</button>
  <p id="faceStatus" style="color:#ffc107; margin-top:15px; font-weight:bold;"></p>
</div>

<section id="appSection" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data Entry</button>
    <button class="nav-btn" onclick="switchTab('oldData')" id="btnOld">2. Global History</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">3. My Assignments</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Session Data Entry</h3>
      <div style="background:#e9f7ef; border-left:4px solid #28a745; padding:10px; margin-bottom:15px; font-size:13px; color:#155724;">
        <strong>Status:</strong> Data entered here is auto-saved as "Draft". Use 'Submit Final' to archive.
      </div>
      <div style="margin-bottom:10px;">
        <button onclick="addSessionRow()">+ Add Record</button>
        <button onclick="submitSession()" style="background:#28a745; border-color:#1e7e34;">‚úî Submit Final</button>
      </div>
      <table>
        <thead><tr><th>Parameter A</th><th>Parameter B</th><th>Parameter C</th><th style="width:80px">Action</th></tr></thead>
        <tbody id="sessionBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-oldData" class="hidden">
    <div class="panel">
      <h3>üìÅ Global Data History</h3>
      <table>
        <thead><tr><th>Param A</th><th>Param B</th><th>Param C</th><th>Submitted By</th><th>Timestamp</th><th id="adminDelHead" class="hidden">Control</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel">
      <h3>üìã Assigned Tasks</h3>
      <p id="noWorkMsg" style="color:#6c757d; font-style:italic;">No pending assignments.</p>
      <div id="taskList"></div>
    </div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    
    <div class="panel">
      <h3>üõ† Work Assignment</h3>
      <div style="display:grid; grid-template-columns: 1fr 2fr 100px; gap:10px; align-items:start;">
        <select id="userSelectAssign"><option>Loading users...</option></select>
        <textarea id="taskDesc" rows="1" placeholder="Task description..."></textarea>
        <button onclick="assignTask()">Assign</button>
      </div>
    </div>

    <div class="panel" style="border-top: 4px solid var(--official-blue);">
      <h3>üìä Data Audit & Monitoring</h3>
      <p style="font-size:13px; margin-bottom:10px;">Select a user to generate a report of their input history.</p>
      
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <select id="userSelectAudit" style="max-width:300px;">
             <option value="">-- Select User to Inspect --</option>
        </select>
        <button onclick="auditUser()">Generate Report</button>
      </div>

      <table class="audit-table">
        <thead>
            <tr><th colspan="4" id="auditHeader">User Data Report</th></tr>
            <tr style="background:#f0f0f0; color:#333;"><th>Date</th><th>Param A</th><th>Param B</th><th>Param C</th></tr>
        </thead>
        <tbody id="auditBody">
            <tr><td colspan="4" style="text-align:center; color:#999;">Select a user above to view data.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="panel">
      <h3>üë§ User Access Control</h3>
      <table>
        <thead><tr><th>Email ID</th><th>Biometric Status</th><th>Account Status</th><th>Actions</th></tr></thead>
        <tbody id="userListBody"></tbody>
      </table>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

/* --- CONFIG --- */
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* --- STATE --- */
let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];

// BIOMETRIC STATE
let tempPhotos = [];
let verificationMode = "register"; 
let videoStream = null;

/* --- AUTH & LOGIN --- */
setPersistence(auth, browserSessionPersistence);

window.login = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert("Authentication Failed: " + e.message));
};

window.logout = () => {
  email.value = "";
  password.value = "";
  signOut(auth);
};

onAuthStateChanged(auth, user => {
  if (!user) {
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    stopCamera();
    return;
  }

  currentUser = user;
  document.getElementById("authContainer").classList.remove("hidden");
  userInfo.innerText = user.email;
  
  isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
  
  // *** CRITICAL UPDATE: AUTOMATICALLY SAVE USER ID ON LOGIN ***
  // This ensures the Admin Panel has data to display, even if they log in for the first time.
  update(ref(db, `users/${user.uid}`), { email: user.email })
    .catch(err => console.error("Auto-Save Failed (Check Rules): ", err));

  // START APP LOGIC
  const userRef = ref(db, `users/${user.uid}`);
  onValue(userRef, (snap) => {
    const userData = snap.val();
    
    if (userData && userData.terminated === true) {
      alert("ACCESS DENIED: ACCOUNT TERMINATED.");
      logout();
      return;
    }

    loginSection.classList.add("hidden");
    document.getElementById("faceModal").classList.remove("hidden");
    startCamera();

    if (!userData || !userData.faceData || !userData.faceData.photo1 || !userData.faceData.photo2) {
        verificationMode = "register";
        tempPhotos = [];
        updateModalUI("Biometric Registration", "Step 1: Capture Reference Photo 1 (Neutral Expression)");
    } else {
        verificationMode = "verify";
        tempPhotos = [userData.faceData.photo1, userData.faceData.photo2];
        updateModalUI("Identity Verification", "Please look at the camera to verify identity.");
    }
  }, { onlyOnce: true });
});

/* --- FACE LOGIC --- */
async function startCamera() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById("cameraFeed").srcObject = videoStream;
  } catch(e) { alert("Camera Hardware Access Denied."); }
}

function stopCamera() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
}

function updateModalUI(title, desc) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalDesc").innerText = desc;
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("faceStatus").innerText = "";
}

window.handleFaceCapture = () => {
  const video = document.getElementById("cameraFeed");
  const canvas = document.getElementById("faceCanvas");
  const ctx = canvas.getContext('2d');
  
  ctx.drawImage(video, 0, 0, 320, 240);
  const capturedImg = canvas.toDataURL("image/png");

  const status = document.getElementById("faceStatus");
  const btn = document.getElementById("btnCapture");
  btn.disabled = true;
  status.innerText = "Processing Biometric Data...";

  if (verificationMode === "register") {
    if (tempPhotos.length === 0) {
        tempPhotos.push(capturedImg);
        status.innerText = "Image 1 Acquired.";
        setTimeout(() => updateModalUI("Biometric Registration", "Step 2: Capture Reference Photo 2"), 1000);
    } else {
        update(ref(db, `users/${currentUser.uid}/faceData`), {
            photo1: tempPhotos[0],
            photo2: capturedImg
        }).then(() => {
            status.style.color = "#28a745";
            status.innerText = "Registration Successful. Accessing System...";
            setTimeout(accessGranted, 1500);
        });
    }
  } 
  else if (verificationMode === "verify") {
    compareFace(capturedImg, tempPhotos).then(matchScore => {
        if(matchScore >= 60) {
            status.style.color = "#28a745";
            status.innerText = `Match Verified (${matchScore}%). Access Granted.`;
            setTimeout(accessGranted, 1500);
        } else {
            status.style.color = "#dc3545";
            status.innerText = `Verification Failed (${matchScore}%). Access Denied.`;
            setTimeout(logout, 2000);
        }
    });
  }
};

function accessGranted() {
    document.getElementById("faceModal").classList.add("hidden");
    stopCamera();
    initializeAppUI();
}

function compareFace(newImg, storedImages) {
    return new Promise(resolve => {
        let bestScore = 0;
        let processed = 0;
        storedImages.forEach(stored => {
            const img1 = new Image(); img1.src = newImg;
            const img2 = new Image(); img2.src = stored;
            img1.onload = () => { img2.onload = () => {
                const score = getSimilarity(img1, img2);
                if(score > bestScore) bestScore = score;
                processed++;
                if(processed === storedImages.length) resolve(Math.floor(bestScore));
            }}
        });
    });
}

function getSimilarity(img1, img2) {
    const c = document.getElementById("compareCanvas");
    const ctx = c.getContext("2d");
    
    ctx.drawImage(img1, 0, 0, 32, 32);
    const d1 = ctx.getImageData(0,0,32,32).data;
    
    ctx.clearRect(0,0,32,32);
    ctx.drawImage(img2, 0, 0, 32, 32);
    const d2 = ctx.getImageData(0,0,32,32).data;
    
    let diff = 0;
    let pixelsChecked = 0;
    
    // Check Top-Center Region (Face) Only
    for (let y = 4; y < 20; y++) {
        for (let x = 5; x < 27; x++) {
            const i = (y * 32 + x) * 4;
            diff += Math.abs(d1[i] - d2[i]);
            diff += Math.abs(d1[i+1] - d2[i+1]);
            diff += Math.abs(d1[i+2] - d2[i+2]);
            pixelsChecked++;
        }
    }
    
    const maxDiff = 255 * 3 * pixelsChecked;
    let match = 100 - ((diff / maxDiff) * 100);
    if(match > 80) return match + 10;
    if(match > 70) return match + 5;
    return match;
}

/* --- MAIN UI --- */
function initializeAppUI() {
  loginSection.classList.add("hidden");
  appSection.classList.remove("hidden");

  if (isAdmin) {
    document.getElementById("adminBadge").classList.remove("hidden");
    document.getElementById("btnAdmin").classList.remove("hidden");
    document.getElementById("adminDelHead").classList.remove("hidden");
    loadAdminPanel();
  }

  loadSession();
  loadHistory();
  loadAssignments();
}

window.switchTab = (tabName) => {
  ['newData', 'oldData', 'assigned', 'adminPanel'].forEach(t => document.getElementById(`tab-${t}`).classList.add("hidden"));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tab-${tabName}`).classList.remove("hidden");
  const map = { 'newData': 'btnNew', 'oldData': 'btnOld', 'assigned': 'btnAssign', 'adminPanel': 'btnAdmin' };
  if(map[tabName]) document.getElementById(map[tabName]).classList.add("active");
};

/* --- DATA HANDLING --- */
function loadSession() {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    sessionBody.innerHTML = "";
    snap.forEach(r => {
      const tr = document.createElement("tr");
      ["A", "B", "C"].forEach(c => {
        const td = document.createElement("td");
        const i = document.createElement("input");
        i.className = "cell";
        i.value = r.val()[c] || "";
        i.onchange = () => set(ref(db, `excelData/session/${currentUser.uid}/${r.key}/${c}`), i.value);
        td.appendChild(i); tr.appendChild(td);
      });
      const delTd = document.createElement("td");
      delTd.innerHTML = `<button class="danger" style="padding:4px 8px;" onclick="deleteDraft('${r.key}')">Remove</button>`;
      tr.appendChild(delTd);
      sessionBody.appendChild(tr);
    });
  });
}
window.addSessionRow = () => push(ref(db, "excelData/session/" + currentUser.uid), { A: "", B: "", C: "" });
window.deleteDraft = (key) => remove(ref(db, `excelData/session/${currentUser.uid}/${key}`));

window.submitSession = () => {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    if(!snap.exists()) return alert("No draft data to submit.");
    if(confirm("Confirm final submission to Global History?")) {
        snap.forEach(r => {
          push(ref(db, "excelData/history"), {
            ...r.val(),
            user: currentUser.email,
            date: new Date().toLocaleString()
          });
        });
        remove(ref(db, "excelData/session/" + currentUser.uid));
        alert("Data Archived Successfully.");
        switchTab('oldData');
    }
  }, { onlyOnce: true });
};

function loadHistory() {
  onValue(ref(db, "excelData/history"), snap => {
    historyBody.innerHTML = "";
    snap.forEach(r => {
      const d = r.val();
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${d.A||''}</td><td>${d.B||''}</td><td>${d.C||''}</td><td>${d.user}</td><td>${d.date}</td>`;
      const actionTd = document.createElement("td");
      if(isAdmin) {
        actionTd.innerHTML = `<button class="danger" style="padding:2px 6px; font-size:11px;" onclick="deleteHistory('${r.key}')">Del</button>`;
        actionTd.style.display = "table-cell";
      } else { actionTd.style.display = "none"; }
      tr.appendChild(actionTd);
      historyBody.appendChild(tr);
    });
  });
}
window.deleteHistory = (key) => { if(confirm("Admin: Delete this official record?")) remove(ref(db, `excelData/history/${key}`)); };

/* --- ASSIGNMENTS --- */
function loadAssignments() {
  onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
    const list = document.getElementById("taskList");
    list.innerHTML = "";
    snap.forEach(task => {
      const div = document.createElement("div");
      div.className = "panel";
      div.style.borderLeft = "4px solid #ffc107";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between"><strong>Admin Instruction</strong><button onclick="completeTask('${task.key}')">Mark Completed</button></div>
        <p>${task.val().description}</p><small>Assigned: ${task.val().date}</small>`;
      list.appendChild(div);
    });
  });
}
window.completeTask = (key) => { if(confirm("Confirm task completion?")) remove(ref(db, `assignments/${currentUser.uid}/${key}`)); };

/* --- ADMIN FUNCTIONS --- */
function loadAdminPanel() {
  onValue(ref(db, "users"), snap => {
    const selectAssign = document.getElementById("userSelectAssign");
    const selectAudit = document.getElementById("userSelectAudit");
    const tbody = document.getElementById("userListBody");
    
    const currAudit = selectAudit.value;
    
    // Clear and Rebuild
    selectAssign.innerHTML = "<option value=''>-- Select User --</option>";
    selectAudit.innerHTML = "<option value=''>-- Select User to Inspect --</option>";
    tbody.innerHTML = "";

    // If Database is empty/permission block
    if(!snap.exists()) {
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='4' style='text-align:center; color:red;'>No users found. Check Database Rules or have users log in once.</td>";
        tbody.appendChild(tr);
        return;
    }

    snap.forEach(u => {
      const user = u.val();
      const uid = u.key;
      
      // Populate Dropdowns
      const opt1 = document.createElement("option"); opt1.value = uid; opt1.innerText = user.email;
      selectAssign.appendChild(opt1);
      
      const opt2 = document.createElement("option"); opt2.value = user.email; opt2.innerText = user.email;
      selectAudit.appendChild(opt2);

      // Populate Table
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user.email}</td>
        <td>${user.faceData ? "<span style='color:#28a745'>Registered</span>" : "<span style='color:#dc3545'>Pending</span>"}</td>
        <td>${user.terminated ? "<b style='color:#dc3545'>TERMINATED</b>" : "Active"}</td>
        <td>
            ${user.terminated ? `<button style="background:#28a745" onclick="toggleTerm('${uid}',false)">Activate</button>` : `<button class="danger" onclick="toggleTerm('${uid}',true)">Terminate</button>`}
            ${user.faceData ? `<button class="warning" onclick="resetFace('${uid}')">Reset Face</button>` : ``}
        </td>`;
      tbody.appendChild(tr);
    });
    if(currAudit) selectAudit.value = currAudit;
  }, (err) => {
      // PERMISSION ERROR HANDLING
      console.error(err);
      alert("Admin Panel Error: " + err.message + "\n\nPlease update your Database Rules to '.read': 'auth != null'");
  });
}

window.auditUser = () => {
    const email = document.getElementById("userSelectAudit").value;
    const body = document.getElementById("auditBody");
    const header = document.getElementById("auditHeader");
    
    if(!email) return alert("Please select a user first.");
    
    header.innerText = `Official Report: ${email}`;
    body.innerHTML = "<tr><td colspan='4'>Searching records...</td></tr>";
    
    onValue(ref(db, "excelData/history"), snap => {
        body.innerHTML = "";
        let count = 0;
        snap.forEach(r => {
            const d = r.val();
            if(d.user && d.user.toLowerCase() === email.toLowerCase()) {
                count++;
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${d.date}</td><td>${d.A}</td><td>${d.B}</td><td>${d.C}</td>`;
                body.appendChild(tr);
            }
        });
        if(count === 0) body.innerHTML = "<tr><td colspan='4' style='text-align:center'>No records found for this user.</td></tr>";
    }, {onlyOnce: true});
};

window.assignTask = () => {
  const uid = document.getElementById("userSelectAssign").value;
  const desc = document.getElementById("taskDesc").value;
  if(!uid || !desc) return alert("Incomplete details.");
  push(ref(db, `assignments/${uid}`), { description: desc, assignedBy: currentUser.email, date: new Date().toLocaleString() })
    .then(() => { alert("Task Assigned."); document.getElementById("taskDesc").value = ""; });
};

window.toggleTerm = (uid, status) => update(ref(db, `users/${uid}`), { terminated: status });
window.resetFace = (uid) => { if(confirm("Reset Biometrics?")) update(ref(db, `users/${uid}`), { faceData: null }); };

</script>
</body>
</html>
