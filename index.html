<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- OFFICIAL METRO THEME --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
}

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
  transition: all 0.2s;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; opacity: 0.7; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button.info { background: #17a2b8; border-color: #117a8b; color: white; }
button.secondary { background: #6c757d; border-color: #545b62; color: white; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; }

/* NEW HIGH PERFORMANCE CAMERA UI */
#videoContainer { 
    position: relative; 
    width: 320px; 
    height: 240px; 
    background: #000; 
    margin-bottom: 15px; 
    border: 5px solid white; 
    box-shadow: 0 0 20px rgba(0,255,0,0.2);
}
#cameraFeed { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    transform: scaleX(-1); /* Mirror effect */
}
#overlayCanvas { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 10; 
    transform: scaleX(-1); /* Mirror overlay to match video */
}

/* UPLOAD SECTION SPECIFIC */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* CHECKBOX LIST FOR ADMIN */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #ced4da;
    padding: 10px;
    background: #fff;
    text-align: left;
}
.checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; }
.checkbox-item input { width: auto; margin-right: 10px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #555; border: 2px solid #888; }
.dot.active { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 5px #00ff00; }

/* STATUS BADGES */
.badge-online { background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.badge-offline { background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }

/* SIGNATURE CANVAS */
canvas.sig-canvas { border: 2px solid #003366; background: #fff; cursor: crosshair; touch-action: none; border-radius: 4px; display:block; }

</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div><h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:300px; text-align:center;">
        <h3>User Profile Setup</h3>
        <p>Please enter your official name for the records.</p>
        <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
  
  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
      <div id="dot1" class="dot"></div>
      <div id="dot2" class="dot"></div>
      <div id="dot3" class="dot"></div>
  </div>

  <div id="videoContainer">
    <video id="cameraFeed" autoplay playsinline muted></video>
    <canvas id="overlayCanvas"></canvas>
  </div>
  
  <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:5px; width:280px; box-shadow: 0 0 15px black; position:absolute; z-index:20;">
    <h3 style="color:#dc3545; margin-top:0;">Face ID Failed (3/3)</h3>
    <p style="color:#333; font-size:13px;">Camera Disabled.<br>Enter OTP/PIN:</p>
    <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:18px; letter-spacing:5px; border:2px solid #dc3545;">
    <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
  </div>

  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold; height:20px;"></div>
  
  <div id="camControls" style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Face Scan</button>
  </div>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
    <button class="nav-btn hidden" onclick="switchTab('sysLogs')" id="btnLogs">5. System Logs</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <input id="inpStationName" placeholder="STATION NAME">
          <input id="inpStationLength" placeholder="STATION LENGTH (M)">
          <input id="inpYellowDist" placeholder="YELLOW LINE DIST (CM)">
          <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS (CM)">
      </div>
      <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
      <div style="text-align:right;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Draft</button>
      </div>
    </div>

    <div class="panel upload-panel">
      <h3 style="color:#003366; margin-top:0;">üìé Evidence Upload Section</h3>
      <p style="font-size:12px; color:#666;">Upload site photos, videos, or PDFs separately here.</p>
      
      <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
      <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
      
      <button class="warning" onclick="uploadEvidenceOnly()">‚¨Ü Upload Evidence to Database</button>
      <div style="margin-top:5px;"><small style="color:red;">* Max 1.5 MB per file (Strict Limit)</small></div>
    </div>

    <div class="panel">
      <h4>Distance Data</h4>
      <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final Data</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button onclick="toggleInvMode('list')" class="primary">üì¶ View Stock</button>
        <button onclick="toggleInvMode('add')" class="success">‚ûï Add Stock</button>
        <button onclick="toggleInvMode('checkout')" class="warning">üì§ Checkout</button>
        <button onclick="toggleInvMode('return')" class="info">üì• Return Item</button>
        <button onclick="toggleInvMode('history')" class="secondary">üìú History</button>
    </div>

    <div id="inv-add" class="panel hidden" style="background:#f8f9fa;">
        <h3 style="color:#003366;">Add Inventory Details</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
            <input id="invName" placeholder="Product Name">
            <input id="invQty" type="number" placeholder="Quantity">
            <select id="invCondition">
                <option value="" disabled selected>Select Condition</option>
                <option value="New">New</option>
                <option value="Good">Good</option>
                <option value="Fair">Fair</option>
                <option value="Damaged">Damaged</option>
            </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 2fr 100px; gap:10px;">
            <select id="invSourceType" onchange="updateSourcePlaceholder()">
                <option value="Online">Online</option>
                <option value="Offline">Offline</option>
            </select>
            <input id="invSourceName" placeholder="Name of Site">
            <button onclick="addInventory()" class="success">Save</button>
        </div>
    </div>

    <div id="inv-checkout" class="panel hidden" style="border: 2px solid #b38600;">
        <h3 style="color:#b38600;">üì§ Checkout / Issue Product</h3>
        <p>User taking the product must sign below. An <b>Admin</b> must authorize via Biometric Scan.</p>
        
        <label>Select Product (Currently in Store):</label>
        <select id="checkoutSelect" onchange="updateMaxQty()">
            <option>Loading...</option>
        </select>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <div>
                <label>Available Qty:</label>
                <input id="checkoutAvail" disabled style="background:#e9ecef;">
            </div>
            <div>
                <label>Quantity Taking:</label>
                <input id="checkoutQty" type="number" placeholder="Enter Qty">
            </div>
        </div>

        <label style="margin-top:10px; display:block;">Receiver's Signature (Draw Below):</label>
        <canvas id="sigCanvas" class="sig-canvas" width="400" height="150"></canvas>
        <br>
        <button onclick="clearSignature('sigCanvas')" style="background:#6c757d; font-size:11px; padding:4px 8px;">Clear Signature</button>

        <div style="margin-top:20px; text-align:right;">
             <button onclick="initTransactionAuth('CHECKOUT')" style="background:#b38600; padding:12px 20px; font-size:14px;">üõ°Ô∏è Admin Biometric Approve & Submit</button>
        </div>
    </div>

    <div id="inv-return" class="panel hidden" style="border: 2px solid #17a2b8;">
        <h3 style="color:#17a2b8;">üì• Return Product to Store</h3>
        <p>User returning the product must sign below. An <b>Admin</b> must authorize via Biometric Scan.</p>
        
        <label>Select Product Returning:</label>
        <select id="returnSelect">
            <option>Loading...</option>
        </select>

        <label>Quantity Returning:</label>
        <input id="returnQty" type="number" placeholder="Enter Qty">

        <label style="margin-top:10px; display:block;">Returner's Signature (Draw Below):</label>
        <canvas id="sigCanvasReturn" class="sig-canvas" width="400" height="150"></canvas>
        <br>
        <button onclick="clearSignature('sigCanvasReturn')" style="background:#6c757d; font-size:11px; padding:4px 8px;">Clear Signature</button>

        <div style="margin-top:20px; text-align:right;">
             <button onclick="initTransactionAuth('RETURN')" style="background:#17a2b8; padding:12px 20px; font-size:14px;">üõ°Ô∏è Admin Biometric Approve & Return</button>
        </div>
    </div>

    <div id="inv-history" class="panel hidden">
        <h3>üìú Inventory Transaction Log (Check-In / Check-Out)</h3>
        <div style="max-height:400px; overflow-y:scroll;">
            <table>
                <thead>
                    <tr>
                        <th style="position:sticky; top:0; background:#e9ecef;">Date & Time</th>
                        <th style="position:sticky; top:0; background:#e9ecef;">Action</th>
                        <th style="position:sticky; top:0; background:#e9ecef;">Item</th>
                        <th style="position:sticky; top:0; background:#e9ecef;">Qty</th>
                        <th style="position:sticky; top:0; background:#e9ecef;">User (Receiver/Giver)</th>
                        <th style="position:sticky; top:0; background:#e9ecef;">Admin (Biometric Auth)</th>
                    </tr>
                </thead>
                <tbody id="invHistoryBody">
                    <tr><td colspan="6" style="text-align:center;">Loading records...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="inv-list" class="panel">
        <h3>Current Inventory</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Condition</th>
                    <th>Source</th>
                    <th>Details</th>
                    <th>User</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
  </div>

  <div id="tab-gallery" class="hidden">
    <div class="panel">
      <h3>üìÅ Site Evidence Gallery</h3>
      <div id="galleryContainer" class="gallery-grid"></div>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã My Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ°Ô∏è Administrator Console</h3>
        <button onclick="loadAdminPanel()" class="primary">üîÑ Refresh</button>
      </div>

      <h4 style="background:#eee; padding:5px;">1. User Status & Permissions</h4>
      <table>
          <thead>
              <tr>
                  <th>Name (User)</th>
                  <th>Online Status</th>
                  <th>Biometric Status</th>
                  <th>Admin Actions</th>
              </tr>
          </thead>
          <tbody id="userListBody"></tbody>
      </table>
      
      <h4 style="background:#eee; padding:5px;">2. Assign Work</h4>
      <label>Select Students/Users:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="1" placeholder="Enter Task Details..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:5px;">Assign to Selected Users</button>
      </div>
      <h4 style="background:#eee; padding:5px; margin-top:25px;">3. Master Assignment Tracker</h4>
      <div style="max-height:300px; overflow-y:scroll; border:1px solid #ced4da; background:#fff;">
          <table style="margin-top:0;">
              <thead>
                  <tr>
                      <th style="position:sticky; top:0; background:#e9ecef;">Assigned To</th>
                      <th style="position:sticky; top:0; background:#e9ecef;">Task Description</th>
                      <th style="position:sticky; top:0; background:#e9ecef; text-align:center;">Status</th>
                      <th style="position:sticky; top:0; background:#e9ecef;">Action</th>
                  </tr>
              </thead>
              <tbody id="adminTaskBody">
                  <tr><td colspan="4" style="text-align:center">Loading tasks...</td></tr>
              </tbody>
          </table>
      </div>
    </div>
  </div>

  <div id="tab-sysLogs" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üìú System Activity Log (Last 60 Events)</h3>
        <button onclick="loadSysLogs()" class="primary">üîÑ Refresh Logs</button>
      </div>
      
      <div style="height:400px; overflow-y:scroll; border:1px solid #ccc; background:#fff;">
        <table style="margin-top:0;">
          <thead>
            <tr>
              <th style="position:sticky; top:0; background:#e9ecef; width:150px;">Time</th>
              <th style="position:sticky; top:0; background:#e9ecef;">User</th>
              <th style="position:sticky; top:0; background:#e9ecef;">Event</th>
              <th style="position:sticky; top:0; background:#e9ecef;">Method</th>
              <th style="position:sticky; top:0; background:#e9ecef; width:80px;">Action</th>
            </tr>
          </thead>
          <tbody id="fullLogBody">
             <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = []; 
let modelsLoaded = false; 
let isTransactionAuth = false; 
let currentTransactionType = ""; 

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;

// --- SIGNATURE PAD LOGIC ---
function setupCanvas(id) {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0; let lastY = 0;

    canvas.addEventListener('mousedown', (e) => { isDrawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke(); [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => { 
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height); 
}

// --- 1. LOAD AI MODELS ---
async function preloadModels() {
    if(modelsLoaded) return; 
    try {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]);
        modelsLoaded = true;
    } catch(e) { console.error("Model Error", e); }
}
preloadModels(); 

// --- 2. AUTH & WATCHDOG ---
onAuthStateChanged(auth, (user) => {
  if (!user) { showLogin(); return; }
  
  currentUser = user;
  startPresenceSystem(user);
  setupIdleTimer();
  update(ref(db, `users/${user.uid}`), { email: user.email });

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const u = snap.val();
    if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    if(u) currentUser.name = u.name; 

    isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
    failCount = 0;
    
    if (!u.name) {
        document.getElementById("nameModal").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        return;
    }

    if (!u.pin) { update(ref(db, `users/${user.uid}`), { pin: "1234" }); }

    document.getElementById("userInfo").innerText = `${u.name} (${user.email})`;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("btnLogs").classList.remove("hidden"); 
      setTimeout(loadAdminPanel, 2000); 
    }

    if(!isTransactionAuth) {
        const faceModal = document.getElementById("faceModal");
        faceModal.classList.remove("hidden");
        
        if(!u.faceData) {
            document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup (3 Steps)";
            document.getElementById("modalDesc").innerText = "Center your face in the box.";
            document.getElementById("regProgress").classList.remove("hidden");
            updateRegDots(regSamples.length);
            document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${regSamples.length + 1} of 3`;
            document.getElementById("btnCapture").onclick = registerNewFace; 
            initCamera(false);
        } else {
            document.getElementById("modalTitle").innerText = "Biometric Verification";
            document.getElementById("modalDesc").innerText = "System Ready.";
            document.getElementById("regProgress").classList.add("hidden");
            document.getElementById("btnCapture").innerText = "üì∏ Verify Identity";
            document.getElementById("btnCapture").onclick = handleFaceScan; 
            initCamera(true);
        }
    }
  });
});

// --- NEW HEARTBEAT SYSTEM ---
function startPresenceSystem(user) {
    const userStatusRef = ref(db, `status/${user.uid}`);
    set(userStatusRef, { state: 'online', last_changed: serverTimestamp(), email: user.email, name: user.displayName || "User" });
    onDisconnect(userStatusRef).set({ state: 'offline', last_changed: serverTimestamp(), email: user.email });
    setInterval(() => { if(currentUser) update(userStatusRef, { last_seen: serverTimestamp() }); }, 5000);
}

function updateRegDots(count) {
    document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
    document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
    document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

function setupIdleTimer() {
    clearTimeout(idleTimer);
    window.onmousemove = resetTimer;
    window.onclick = resetTimer;
    resetTimer(); 
}
function resetTimer() {
    clearTimeout(idleTimer);
    if(currentUser) {
        idleTimer = setTimeout(() => {
            const logData = { user: currentUser.email, type: "LOGOUT", method: "Auto-Timeout", time: serverTimestamp() };
            push(ref(db, "logs"), logData);
            signOut(auth);
            alert("Session Timeout.");
        }, 5 * 60 * 1000); 
    }
}

window.saveOfficialName = () => {
    const name = document.getElementById("officialNameInput").value;
    if(name.length < 3) return alert("Enter full valid name.");
    update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
        document.getElementById("nameModal").classList.add("hidden");
        location.reload(); 
    });
}

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));

window.logout = async () => { 
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGOUT", method: "Manual Click", time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
        signOut(auth);
    }
};

async function recordLogin(method) {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
    }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    
    try {
        if(!modelsLoaded) {
            updateStatus("Loading AI Models...", "yellow");
            await preloadModels();
        }
        
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 320, height: 240 } });
        vid.srcObject = stream;
        vid.onloadedmetadata = () => {
            vid.play();
            startRealTimeDetection(vid, canvas); 
        };

        if(isVerify) updateStatus("LOOK AT CAMERA", "white");
        else updateStatus("REGISTRATION: CENTER FACE", "cyan");

    } catch(e) { 
        console.error(e);
        updateStatus("Camera Hardware Error", "red"); 
    }
}

async function startRealTimeDetection(video, canvas) {
    const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
    faceapi.matchDimensions(canvas, displaySize);
    if (detectionLoop) clearInterval(detectionLoop);
    detectionLoop = setInterval(async () => {
        if (!stream) return;
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (detection) {
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            const box = resizedDetections.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
            drawBox.draw(canvas);
            currentDescriptor = detection.descriptor;
            const btn = document.getElementById("btnCapture");
            if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00"; 
        } else {
            currentDescriptor = null;
            const btn = document.getElementById("btnCapture");
            if(btn) btn.style.border = "1px solid #004494";
        }
    }, 100); 
}

function stopCamera() { 
    if(detectionLoop) clearInterval(detectionLoop);
    if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    if(vid) vid.srcObject = null;
    if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
    document.getElementById("faceModal").classList.add("hidden"); 
    isTransactionAuth = false; 
    currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }

window.handleFaceScan = async () => {
    const btn = document.getElementById("btnCapture");
    if(!currentDescriptor) { updateStatus("‚ùå No Face Detected.", "red"); return; }
    
    btn.disabled = true; 
    btn.innerText = "Processing...";
    updateStatus("Verifying Identity...", "cyan");

    try {
        if(isTransactionAuth) {
            // --- ADMIN TRANSACTION AUTHORIZATION ---
            const allUsersSnap = await get(ref(db, "users"));
            let adminFound = false;
            let adminName = "";

            allUsersSnap.forEach(userSnap => {
                const uData = userSnap.val();
                if(uData.faceData && ADMIN_EMAILS.includes(uData.email)) {
                    // Check logic
                    if(uData.faceData[0] instanceof Array || Array.isArray(uData.faceData[0])) {
                        for (let sample of uData.faceData) {
                            if(faceapi.euclideanDistance(sample, currentDescriptor) < 0.55) { 
                                adminFound = true; adminName = uData.name; break; 
                            }
                        }
                    } else {
                        if(faceapi.euclideanDistance(uData.faceData, currentDescriptor) < 0.55) {
                             adminFound = true; adminName = uData.name;
                        }
                    }
                }
            });

            if(adminFound) {
                updateStatus("‚úÖ ADMIN VERIFIED: " + adminName, "#00ff00");
                await processTransaction(adminName);
            } else {
                throw new Error("Admin Face Not Recognized");
            }

        } else {
            // --- STANDARD LOGIN ---
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            if (!storedData) throw new Error("No face data found.");
            let matchFound = false;
            if(storedData[0] instanceof Array || Array.isArray(storedData[0])) {
                 for (let sample of storedData) {
                     if(faceapi.euclideanDistance(sample, currentDescriptor) < 0.55) { matchFound = true; break; } 
                 }
            } else {
                 if(faceapi.euclideanDistance(storedData, currentDescriptor) < 0.55) matchFound = true;
            }

            if(matchFound) {
                updateStatus("‚úÖ VERIFIED", "#00ff00");
                await recordLogin("Biometric");
                enterApp();
            } else {
                throw new Error("Face Mismatch");
            }
        }
    } catch (error) {
        console.error(error);
        updateStatus("‚ùå " + error.message, "red");
        btn.disabled = false;
        btn.innerText = "üì∏ Retry Scan";
        if(!isTransactionAuth) handleFail(); 
    }
};

window.registerNewFace = async () => {
    if(!currentDescriptor) { updateStatus("‚ùå Camera cannot see face clearly.", "orange"); return; }
    regSamples.push(Array.from(currentDescriptor));
    const count = regSamples.length;
    updateRegDots(count);
    if(count < 3) {
        updateStatus(`‚úÖ Sample ${count}/3 Captured.`, "lightgreen");
        document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${count + 1} of 3`;
    } else {
        updateStatus("üíæ Saving...", "yellow");
        await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
        alert("Registration Complete!"); location.reload();
    }
};

function handleFail() {
    failCount++;
    if(failCount >= 3) {
        stopCamera(); 
        document.getElementById("faceModal").classList.remove("hidden");
        document.getElementById("videoContainer").classList.add("hidden"); 
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden"); 
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${3 - failCount}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            await recordLogin("PIN Entry");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

function enterApp() {
    stopCamera(); 
    document.getElementById("faceModal").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadGallery(); loadInventory(); loadAssignments();
}

// --- CHECKOUT & RETURN LOGIC ---

window.toggleInvMode = (mode) => {
    document.getElementById("inv-add").classList.add("hidden");
    document.getElementById("inv-checkout").classList.add("hidden");
    document.getElementById("inv-return").classList.add("hidden");
    document.getElementById("inv-history").classList.add("hidden");
    document.getElementById("inv-list").classList.add("hidden");
    document.getElementById(`inv-${mode}`).classList.remove("hidden");
    
    if(mode === 'checkout') populateSelect('checkoutSelect');
    if(mode === 'return') populateSelect('returnSelect');
    if(mode === 'history') loadInventoryHistory();
};

function populateSelect(id) {
    const sel = document.getElementById(id);
    sel.innerHTML = "<option value=''>Loading...</option>";
    onValue(ref(db, "inventory"), snap => {
        sel.innerHTML = "<option value=''>Select Item...</option>";
        snap.forEach(c => {
            const v = c.val();
            const opt = document.createElement("option");
            opt.value = c.key;
            opt.text = `${v.item} (Avail: ${v.qty})`;
            opt.dataset.qty = v.qty;
            opt.dataset.name = v.item;
            sel.appendChild(opt);
        });
    }, { onlyOnce: true });
}

window.updateMaxQty = () => {
    const sel = document.getElementById("checkoutSelect");
    const opt = sel.options[sel.selectedIndex];
    if(opt.dataset.qty) {
        document.getElementById("checkoutAvail").value = opt.dataset.qty;
    }
};

// --- NEW HISTORY LOADING LOGIC ---
function loadInventoryHistory() {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>Loading logs...</td></tr>";

    // Fetch logs (limit to last 100 for performance)
    const q = query(ref(db, "logs"), limitToLast(100));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push(c.val()));
        logs.reverse(); // Newest first

        // Filter only CHECKOUT and RETURN
        const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN');

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No inventory history found.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        invLogs.forEach(l => {
            let badge = l.type === 'CHECKOUT' 
                ? `<span style="background:#b38600; color:white; padding:2px 6px; border-radius:3px; font-size:11px;">üì§ OUT</span>` 
                : `<span style="background:#17a2b8; color:white; padding:2px 6px; border-radius:3px; font-size:11px;">üì• IN</span>`;

            tbody.innerHTML += `
            <tr>
                <td>${formatTime(l.time)}</td>
                <td style="text-align:center;">${badge}</td>
                <td><b>${l.item}</b></td>
                <td>${l.qty}</td>
                <td>${l.takenBy}</td>
                <td>
                    ${l.approvedBy} <br>
                    <small style="color:green">‚úî Verified</small>
                </td>
            </tr>`;
        });
    });
}

window.initTransactionAuth = (type) => {
    currentTransactionType = type;
    const isCheckout = type === 'CHECKOUT';
    
    const sel = document.getElementById(isCheckout ? "checkoutSelect" : "returnSelect");
    const qtyVal = document.getElementById(isCheckout ? "checkoutQty" : "returnQty").value;
    const canvasId = isCheckout ? "sigCanvas" : "sigCanvasReturn";
    
    if(!sel.value) return alert("Select an item.");
    if(!qtyVal || qtyVal <= 0) return alert("Enter valid quantity.");
    
    if(isCheckout && parseInt(qtyVal) > parseInt(sel.options[sel.selectedIndex].dataset.qty)) {
        return alert("Not enough stock.");
    }
    
    // Check Signature
    const c = document.getElementById(canvasId);
    const blank = document.createElement('canvas');
    blank.width = c.width; blank.height = c.height;
    if(c.toDataURL() === blank.toDataURL()) return alert("Signature required.");

    // Start Biometric Flow
    isTransactionAuth = true;
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = `üõ°Ô∏è Admin Authorization (${type})`;
    document.getElementById("modalDesc").innerText = "An Admin must scan their face to approve.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Scan Admin Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
    
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
    
    initCamera(true);
};

async function processTransaction(adminName) {
    const isCheckout = currentTransactionType === 'CHECKOUT';
    const sel = document.getElementById(isCheckout ? "checkoutSelect" : "returnSelect");
    const itemKey = sel.value;
    const itemName = sel.options[sel.selectedIndex].dataset.name;
    const currentQty = parseInt(sel.options[sel.selectedIndex].dataset.qty);
    const transQty = parseInt(document.getElementById(isCheckout ? "checkoutQty" : "returnQty").value);
    const canvasId = isCheckout ? "sigCanvas" : "sigCanvasReturn";
    const sigData = document.getElementById(canvasId).toDataURL();

    // 1. Update Inventory
    const newQty = isCheckout ? (currentQty - transQty) : (currentQty + transQty);
    await update(ref(db, `inventory/${itemKey}`), { qty: newQty });

    // 2. Log Transaction
    await push(ref(db, "logs"), {
        type: currentTransactionType,
        item: itemName,
        qty: transQty,
        takenBy: currentUser.name || currentUser.email, // Fallback if name null
        approvedBy: adminName,
        signature: sigData,
        time: serverTimestamp()
    });
    
    // 3. Reset
    alert(`${currentTransactionType} Approved by ${adminName}!`);
    stopCamera();
    clearSignature(canvasId);
    document.getElementById(isCheckout ? "checkoutQty" : "returnQty").value = "";
    toggleInvMode('history'); // Automatically go to history after transaction
}

// --- APP FEATURES ---

window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    if(!name) return alert("Station Name Required");
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name,
        len: document.getElementById("inpStationLength").value,
        yl: document.getElementById("inpYellowDist").value,
        th: document.getElementById("inpYellowThick").value,
        remarks: document.getElementById("inpRemarks").value
    });
    alert("Draft Saved");
};

window.uploadEvidenceOnly = () => {
    if(!currentFileBase64) return alert("Select a file first.");
    
    if(confirm("Upload Evidence?")) {
        push(ref(db, "history"), { 
            name: "Evidence Upload", 
            user: currentUser.email, 
            userName: currentUser.name, 
            date: new Date().toLocaleString(),
            fileData: currentFileBase64, 
            fileType: currentFileType
        }).then(() => {
            document.getElementById("evidenceFile").value = "";
            document.getElementById("fileStatus").innerText = "";
            currentFileBase64 = null;
            alert("Evidence Uploaded."); 
            switchTab('gallery');
        });
    }
};

window.handleFileUpload = () => {
    const file = document.getElementById("evidenceFile").files[0];
    document.getElementById("fileStatus").innerText = "Processing...";
    if(file && file.size < 1.5*1024*1024) { 
        const reader = new FileReader();
        reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
        reader.readAsDataURL(file);
    } else { 
        alert("File too large! Max 1.5MB"); 
        document.getElementById("fileStatus").innerText = "Error: File too large";
    }
}

window.submitStationData = () => {
    get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
        const d = s.val();
        if(!d || !d.details) return alert("No Data.");
        if(confirm("Submit Final?")) {
            push(ref(db, "history"), { 
                ...d.details, rows: d.rows, user: currentUser.email, userName: currentUser.name, date: new Date().toLocaleString()
            }).then(() => {
                remove(ref(db, `drafts/${currentUser.uid}`));
                alert("Submitted"); switchTab('gallery');
            });
        }
    });
};

// --- ADMIN LOGIC ---
function formatTime(ts) {
    if(!ts) return "N/A";
    return new Date(ts).toLocaleString();
}

window.loadAdminPanel = async () => {
    const userList = document.getElementById("userCheckboxList");
    const userTable = document.getElementById("userListBody");
    const taskBody = document.getElementById("adminTaskBody"); 
    
    userList.innerHTML = "Loading...";
    userTable.innerHTML = "<tr><td colspan='4'>Loading Status...</td></tr>";

    const [userSnap, statusSnap, assignSnap] = await Promise.all([
        get(ref(db, "users")),
        get(ref(db, "status")),
        get(ref(db, "assignments")) 
    ]);
    
    const statusMap = statusSnap.val() || {};
    userTable.innerHTML = "";
    userList.innerHTML = "";
    taskBody.innerHTML = ""; 

    userSnap.forEach(c => {
        const u = c.val();
        const uid = c.key;
        const displayName = u.name || u.email;

        userList.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="user-check" value="${uid}"> ${displayName}</label>`;

        let isOnline = false;
        const s = statusMap[uid];
        if(s && s.state === 'online') {
            const diff = Date.now() - (s.last_seen || 0);
            if(diff < 20000) isOnline = true; 
        }
        
        const statusBadge = isOnline ? 
            `<span class="badge-online">‚óè ONLINE</span>` : 
            `<span class="badge-offline">‚óã OFFLINE</span>`;

        const bioBadge = u.faceData ? 
            `<span style="color:green; font-weight:bold;">‚úî Registered</span>` : 
            `<span style="color:red; font-weight:bold;">‚ùå Pending</span>`;

        const pinInput = `<input id="pin_${uid}" placeholder="${u.pin||'1234'}" style="width:50px; text-align:center;"> <button onclick="savePin('${uid}')" style="padding:2px 5px;">Set</button>`;
        const reUploadBtn = `<button class="danger" style="padding:2px 5px;" onclick="forceReUpload('${uid}')">Reset Face</button>`;
        const resetNameBtn = `<button class="warning" style="padding:2px 5px;" onclick="retakeName('${uid}')">Reset Name</button>`;

        userTable.innerHTML += `<tr>
            <td>${u.name}<br><small>${u.email}</small></td>
            <td style="text-align:center;">${statusBadge}</td>
            <td style="text-align:center;">${bioBadge}</td>
            <td>${pinInput}<br>${reUploadBtn} ${resetNameBtn}</td>
        </tr>`;
    });

    if (!assignSnap.exists()) {
        taskBody.innerHTML = "<tr><td colspan='4' style='text-align:center'>No active assignments found.</td></tr>";
    } else {
        assignSnap.forEach(userNode => {
            const uid = userNode.key;
            const userName = userSnap.child(uid).val()?.name || "Unknown User";

            userNode.forEach(taskNode => {
                const t = taskNode.val();
                const taskId = taskNode.key;

                const statusBadge = t.status === 'Done'
                    ? `<span style="background:green; color:white; padding:3px 8px; border-radius:10px; font-size:11px;">‚úî COMPLETED</span>`
                    : `<span style="background:#ffc107; color:black; padding:3px 8px; border-radius:10px; font-size:11px;">‚è≥ PENDING</span>`;

                taskBody.innerHTML += `
                <tr>
                    <td><b>${userName}</b></td>
                    <td>${t.desc}<br><small style="color:#666">${t.date}</small></td>
                    <td style="text-align:center;">${statusBadge}</td>
                    <td style="text-align:center;">
                        <button class="danger" style="padding:2px 6px;" onclick="delTask('${uid}', '${taskId}')">üóë</button>
                    </td>
                </tr>`;
            });
        });
    }
};

window.delTask = (uid, taskId) => {
    if(confirm("Permanently delete this assignment?")) {
        remove(ref(db, `assignments/${uid}/${taskId}`))
            .then(() => loadAdminPanel()) 
            .catch(e => alert(e.message));
    }
};

window.loadSysLogs = () => {
    const tbody = document.getElementById("fullLogBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading data...</td></tr>";

    const q = query(ref(db, "logs"), limitToLast(60));

    onValue(q, (snap) => {
        tbody.innerHTML = "";
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse();

        if(logs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No logs found.</td></tr>";
            return;
        }

        logs.forEach(x => {
            let color = "black";
            let bg = "transparent";
            let icon = "üìù";

            if(x.type === "LOGIN") { color = "green"; bg = "#eaffea"; icon = "üü¢"; }
            else if(x.type === "LOGOUT") { color = "red"; bg = "#ffeaea"; icon = "üî¥"; }
            else if(x.type === "CHECKOUT") { color = "#b38600"; bg = "#fff8e1"; icon = "üì§"; }
            else if(x.type === "RETURN") { color = "#17a2b8"; bg = "#e0f7fa"; icon = "üì•"; }
            else if(x.type.includes("Fail")) { color = "orange"; icon = "‚ö†Ô∏è"; }

            const delBtn = isAdmin 
                ? `<button class="danger" style="padding:2px 6px; font-size:11px;" onclick="deleteLogEntry('${x.key}')">üóëÔ∏è</button>` 
                : `<span style="color:#ccc; font-size:10px;">üîí</span>`;

            let details = x.method;
            if(x.type === "CHECKOUT" || x.type === "RETURN") {
                details = `<b>${x.item}</b> (x${x.qty})<br><small>By: ${x.takenBy}<br>Auth: ${x.approvedBy}</small>`;
                if(x.signature) details += `<br><img src="${x.signature}" style="height:30px; border:1px solid #ccc;">`;
            }

            tbody.innerHTML += `
            <tr style="background:${bg}">
                <td style="font-size:12px;">${formatTime(x.time)}</td>
                <td style="font-size:12px; font-weight:bold;">${x.user || x.takenBy}</td>
                <td style="color:${color}; font-size:12px;">${icon} ${x.type}</td>
                <td style="font-size:12px;">${details}</td>
                <td style="text-align:center;">${delBtn}</td>
            </tr>`;
        });
    });
};

window.deleteLogEntry = (key) => {
    if(!isAdmin) return alert("Access Denied: Admins Only.");
    if(confirm("Permanently delete this log entry?")) {
        remove(ref(db, `logs/${key}`)).catch(e => alert("Error: " + e.message));
    }
};

window.assignTaskMulti = () => {
    const desc = document.getElementById("taskDesc").value;
    if(!desc) return alert("Please enter task details.");
    const checkboxes = document.querySelectorAll('.user-check:checked');
    if(checkboxes.length === 0) return alert("Select at least one user.");

    checkboxes.forEach(cb => {
        const uid = cb.value;
        const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };
        push(ref(db, `assignments/${uid}`), task);
    });
    alert(`Task assigned to ${checkboxes.length} user(s).`);
    document.getElementById("taskDesc").value = "";
    checkboxes.forEach(cb => cb.checked = false);
};

window.savePin = (uid) => {
    const p = document.getElementById(`pin_${uid}`).value;
    if(p.length >= 4) { update(ref(db, `users/${uid}`), { pin: p }); alert("PIN Updated"); }
}

window.forceReUpload = (uid) => {
    if(confirm("Reset Face Data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset. User must scan face on next login.")); }
}
window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));

window.switchTab = (t) => {
    ['newData','inventory','gallery','assigned','adminPanel','sysLogs'].forEach(x => {
        const el = document.getElementById(`tab-${x}`);
        if(el) el.classList.add("hidden");
    });
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    const target = document.getElementById(`tab-${t}`);
    if(target) target.classList.remove("hidden");
    
    // Highlight Button
    const btnId = t === 'sysLogs' ? 'btnLogs' : (t === 'newData' ? 'btnNew' : (t === 'inventory' ? 'btnInventory' : (t === 'gallery' ? 'btnGallery' : (t === 'assigned' ? 'btnAssign' : 'btnAdmin'))));
    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add("active");

    if(t==='adminPanel' && isAdmin) loadAdminPanel();
    if(t==='gallery') loadGallery();
    if(t==='sysLogs') loadSysLogs(); 
};

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
    const div = document.getElementById("galleryContainer"); 
    div.innerHTML = "<p>Loading...</p>";

    onValue(ref(db, "history"), snap => {
        div.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            if(v.fileData) {
                let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
                if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
                else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
                
                let controls = `<br><small style="color:grey;">(View Only)</small>`;
                if(isAdmin) {
                    controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
                }
                div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
            }
        });
        if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
    });
}

window.removeFile = (k) => {
    if(confirm("Remove attached file?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            document.getElementById("inpRemarks").value = d.details?.remarks || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}
function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("inventoryBody"); 
        b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr>
                <td>${v.item}</td>
                <td>${v.qty}</td>
                <td>${v.condition || 'N/A'}</td>
                <td>${v.sourceType || 'N/A'}</td>
                <td>${v.sourceName || 'N/A'}</td>
                <td>${v.user}</td>
                <td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td>
            </tr>`;
        });
    });
}

window.updateSourcePlaceholder = () => {
    const type = document.getElementById("invSourceType").value;
    const input = document.getElementById("invSourceName");
    input.placeholder = type === "Online" ? "Name of Site" : "Name of Store";
};

window.addInventory = () => { 
    const item = document.getElementById("invName").value;
    const qty = document.getElementById("invQty").value;
    const cond = document.getElementById("invCondition").value;
    const sType = document.getElementById("invSourceType").value;
    const sName = document.getElementById("invSourceName").value;

    if(!item || !qty || !cond || !sName) return alert("Please fill all fields.");

    push(ref(db, "inventory"), { 
        item: item, 
        qty: qty, 
        condition: cond,
        sourceType: sType,
        sourceName: sName,
        user: currentUser.email 
    }); 
    
    document.getElementById("invName").value = "";
    document.getElementById("invQty").value = "";
    document.getElementById("invSourceName").value = "";
    toggleInvMode('list');
};

window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

</script>
</body>
</html>
