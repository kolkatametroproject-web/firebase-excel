<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Watchdog Dashboard</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:#020617;
  color:#e5e7eb;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 20px;
  background:#0b1220;
}
button{
  padding:8px 14px;
  cursor:pointer;
}
section{
  padding:20px;
}
h3{margin-top:0}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #334155;
  padding:6px;
}
input.cell{
  width:100%;
  background:transparent;
  border:none;
  color:#e5e7eb;
}
.hidden{display:none}
.panel{
  background:#0b1220;
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
}
</style>
</head>

<body>

<header>
  <div><strong>SECURE WATCHDOG</strong></div>
  <div>
    <span id="userInfo"></span>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<section id="loginSection">
  <h3>Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</section>

<section id="appSection" class="hidden">

  <!-- NEW SESSION DATA -->
  <div class="panel">
    <h3>üÜï New Data Entry (Current Session)</h3>
    <button onclick="addSessionRow()">Add Row</button>
    <button onclick="submitSession()">Submit Session</button>
    <table>
      <thead><tr><th>A</th><th>B</th><th>C</th></tr></thead>
      <tbody id="sessionBody"></tbody>
    </table>
  </div>

  <!-- HISTORY -->
  <div class="panel">
    <h3>üìÅ Old Data (History)</h3>
    <table>
      <thead><tr><th>A</th><th>B</th><th>C</th><th>User</th><th>Date</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;

/* LOGIN */
window.login = ()=> {
  signInWithEmailAndPassword(auth,email.value,password.value)
    .catch(()=>alert("Login failed"));
};

/* LOGOUT */
window.logout = ()=> signOut(auth);

/* AUTH STATE */
onAuthStateChanged(auth,user=>{
  if(!user){
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    return;
  }
  currentUser = user;
  userInfo.innerText = user.email;
  loginSection.classList.add("hidden");
  appSection.classList.remove("hidden");

  loadSession();
  loadHistory();
});

/* SESSION DATA */
function loadSession(){
  onValue(ref(db,"excelData/session/"+currentUser.uid), snap=>{
    sessionBody.innerHTML="";
    snap.forEach(r=>{
      const tr=document.createElement("tr");
      ["A","B","C"].forEach(c=>{
        const td=document.createElement("td");
        const i=document.createElement("input");
        i.className="cell";
        i.value=r.val()[c]||"";
        i.onchange=()=>set(ref(db,`excelData/session/${currentUser.uid}/${r.key}/${c}`),i.value);
        td.appendChild(i);
        tr.appendChild(td);
      });
      sessionBody.appendChild(tr);
    });
  });
}

window.addSessionRow=()=>{
  push(ref(db,"excelData/session/"+currentUser.uid),{A:"",B:"",C:""});
};

/* SUBMIT SESSION */
window.submitSession=()=>{
  onValue(ref(db,"excelData/session/"+currentUser.uid), snap=>{
    snap.forEach(r=>{
      push(ref(db,"excelData/history"),{
        ...r.val(),
        user: currentUser.email,
        date: new Date().toLocaleString()
      });
    });
    remove(ref(db,"excelData/session/"+currentUser.uid));
    alert("Session submitted");
  },{onlyOnce:true});
};

/* HISTORY */
function loadHistory(){
  onValue(ref(db,"excelData/history"), snap=>{
    historyBody.innerHTML="";
    snap.forEach(r=>{
      const d=r.val();
      const tr=document.createElement("tr");
      ["A","B","C","user","date"].forEach(k=>{
        const td=document.createElement("td");
        td.innerText=d[k]||"";
        tr.appendChild(td);
      });
      historyBody.appendChild(tr);
    });
  });
}
</script>

</body>
</html>
