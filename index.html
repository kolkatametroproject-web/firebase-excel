<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
/* --- OFFICIAL METRO THEME --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
header small { font-size: 0.8rem; opacity: 0.9; display: block; font-weight: normal; }

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 {
  margin-top: 0;
  color: var(--metro-blue);
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

/* FORMATTING */
.station-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #fdfdfd; padding: 15px; border: 1px solid #eee; }
.station-label { font-weight: bold; font-size: 12px; color: var(--metro-blue); margin-bottom: 4px; display: block; }

/* LOGS & STATUS */
.log-tag { font-weight: bold; padding: 2px 6px; border-radius: 3px; color: white; font-size: 11px; display: inline-block; width: 60px; text-align: center; }
.tag-LOGIN { background: #28a745; }
.tag-LOGOUT { background: #6c757d; }
.tag-SAVE { background: #007bff; }
.tag-DELETE { background: #dc3545; }
.tag-SUBMIT { background: #6610f2; }

.status-badge { padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
.status-pending { background: #ffefc1; color: #856404; border: 1px solid #ffeeba; }
.status-completed { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODAL & SECURITY */
#faceModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; transform: scaleX(-1); }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div>
      <h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1>
      <small>Secure Data Management Portal</small>
    </div>
    <span id="adminBadge" class="hidden status-badge" style="background:#dc3545; color:white; margin-left:10px;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">User ID:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="faceModal" class="hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
  <video id="cameraFeed" autoplay playsinline muted></video>
  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold;"></div>
  <div style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Capture & Verify</button>
    <button id="btnReRegister" class="warning hidden" onclick="startReRegistration()">‚ö†Ô∏è Update Face Data</button>
  </div>
  <canvas id="procCanvas" width="320" height="240" class="hidden"></canvas>
</div>

<section id="appSection" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('oldData')" id="btnOld">3. History</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div class="station-grid">
          <div><label class="station-label">STATION NAME</label><input id="inpStationName" placeholder="e.g., Mahanayak Uttam Kumar"></div>
          <div><label class="station-label">STATION LENGTH (M)</label><input id="inpStationLength" placeholder="e.g., 172.8 M"></div>
          <div><label class="station-label">YELLOW LINE DISTANCE</label><input id="inpYellowDist" placeholder="e.g., 70 CM"></div>
          <div><label class="station-label">YELLOW LINE THICKNESS</label><input id="inpYellowThick" placeholder="e.g., 10 CM"></div>
      </div>
      <div style="text-align:right; margin-bottom:20px;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Draft</button>
      </div>

      <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px;">Distance Data (Measurements)</h4>
      <table id="distanceTable">
        <thead>
            <tr>
                <th style="width:50px">SL</th>
                <th>RAKE NO</th>
                <th>RAKE TYPE</th>
                <th>FRONT DIST</th>
                <th>REAR DIST</th>
                <th style="width:50px">ACT</th>
            </tr>
        </thead>
        <tbody id="distanceBody"></tbody>
      </table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366; border-color:#002244;">‚úî Submit Final Dataset</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üì¶ Inventory & Stock</h3>
            <button class="success" onclick="document.getElementById('addInvForm').classList.toggle('hidden')">+ Add New Item</button>
        </div>
        <div id="addInvForm" class="hidden" style="background:#f1f5f9; padding:15px; margin-bottom:15px; border:1px solid #cbd5e1;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 100px; gap:10px;">
                <input id="invName" placeholder="Product Name">
                <input id="invQty" type="number" placeholder="Qty">
                <button onclick="addInventory()">Save</button>
            </div>
        </div>
        <table>
            <thead><tr><th>Product Name</th><th>Qty</th><th>Updated By</th><th>Action</th></tr></thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
  </div>

  <div id="tab-oldData" class="hidden">
    <div class="panel">
      <h3>üìÅ Global Data History</h3>
      <table>
        <thead><tr><th>Date</th><th>Station</th><th>User</th><th>Rows</th><th id="adminDelHead" class="hidden">Action</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel">
      <h3>üìã Assigned Tasks</h3>
      <div id="taskList"></div>
    </div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <h3>üõ† Work Assignment (Govt Order)</h3>
      <div style="display:grid; grid-template-columns: 1fr 2fr 100px; gap:10px;">
        <select id="userSelectAssign"><option>Loading...</option></select>
        <textarea id="taskDesc" rows="1" placeholder="Enter specific task directives..."></textarea>
        <button onclick="assignTask()">Assign</button>
      </div>
    </div>

    <div class="panel" style="border-top: 4px solid var(--metro-blue);">
      <h3>üìä Audit & Surveillance</h3>
      <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
        <select id="userSelectAudit" style="max-width:300px;"><option value="">-- Select User --</option></select>
        <button onclick="fetchLogs()" style="background:#17a2b8; border-color:#117a8b;">View Activity Logs</button>
      </div>
      <table class="audit-table">
        <thead>
            <tr style="background:#f0f0f0; color:#333;"><th>Time</th><th>Type</th><th>Activity Details</th></tr>
        </thead>
        <tbody id="logBody"><tr><td colspan="3" style="text-align:center;">Select user to generate report.</td></tr></tbody>
      </table>
    </div>

    <div class="panel">
      <h3>üë§ User Access Control & Biometric Status</h3>
      <table>
        <thead>
            <tr>
                <th>Email ID</th>
                <th style="text-align:center">Biometric</th>
                <th>Status</th>
                <th>Govt Actions</th>
            </tr>
        </thead>
        <tbody id="userListBody"></tbody>
      </table>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let tempDescriptor = null;
let mode = "verify";

// --- AUTH ---
onAuthStateChanged(auth, (user) => {
  if (!user) {
    showLogin();
    return;
  }
  
  // Ensure user exists in DB for Admin List
  update(ref(db, `users/${user.uid}`), { email: user.email });

  // Check if banned
  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const userData = snap.val();
    if (userData && userData.terminated === true) {
        alert("ACCOUNT TERMINATED BY ADMINISTRATION.\nContact Safety Dept.");
        signOut(auth);
        return;
    }

    // Proceed if not banned
    currentUser = user;
    isAdmin = ADMIN_EMAILS.includes(user.email);
    document.getElementById("userInfo").innerText = user.email;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("adminDelHead").classList.remove("hidden");
      loadAdminPanel();
    }

    // Face Check
    onValue(ref(db, `users/${user.uid}/faceData`), (faceSnap) => {
        document.getElementById("faceModal").classList.remove("hidden");
        initCamera(faceSnap.exists());
    }, { onlyOnce: true });
  }, { onlyOnce: true });
});

function showLogin() {
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    authContainer.classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert("Auth Error: " + e.message));
window.logout = () => { logActivity("LOGOUT", "User Initiated"); signOut(auth); };

// --- BIOMETRICS ---
async function initCamera(hasData) {
    const vid = document.getElementById("cameraFeed");
    try {
        updateStatus("Loading AI...", "yellow");
        const modelUrl = 'https://justadudewhohacks.github.io/face-api.js/models';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
            faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
            faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
        ]);
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        vid.srcObject = stream;
        
        if (!hasData) startRegistration();
        else {
            mode = "verify";
            updateStatus("üîí VERIFICATION: Look at camera", "white");
        }
    } catch(e) { alert("Camera Error: " + e.message); }
}

function startRegistration() {
    mode = "register"; tempDescriptor = null;
    updateStatus("‚ö†Ô∏è REGISTRATION: Capture Photo 1", "white");
    document.getElementById("btnReRegister").classList.add("hidden");
    document.getElementById("btnCapture").disabled = false;
}

window.startReRegistration = () => confirm("Re-register face?") && startRegistration();
function stopCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById("faceModal").classList.add("hidden"); }
function updateStatus(m,c) { const e=document.getElementById("faceStatus"); e.innerText=m; e.style.color=c; }

window.handleFaceScan = async () => {
    const vid = document.getElementById("cameraFeed");
    const btn = document.getElementById("btnCapture");
    btn.disabled = true; updateStatus("Scanning...", "cyan");

    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.5 });
    const detection = await faceapi.detectSingleFace(vid, options).withFaceLandmarks().withFaceDescriptor();

    if(!detection) { updateStatus("‚ùå No Face Detected", "red"); btn.disabled=false; return; }
    
    // Capture Image
    const canvas = document.getElementById("procCanvas");
    canvas.getContext("2d").drawImage(vid, 0, 0, 320, 240);
    const img = canvas.toDataURL("image/png");

    if(mode === "register") {
        if(!tempDescriptor) {
            tempDescriptor = detection.descriptor;
            updateStatus("‚úÖ Saved. Tilt head slightly & Capture 2.", "lime");
            btn.disabled = false;
        } else {
            await update(ref(db, `users/${currentUser.uid}/faceData`), {
                img1: img, desc1: Array.from(tempDescriptor), desc2: Array.from(detection.descriptor)
            });
            logActivity("LOGIN", "Registration Complete");
            enterApp();
        }
    } else {
        const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
        const stored = snap.val();
        if(!stored.desc1) { startRegistration(); return; }

        const dist = faceapi.euclideanDistance(detection.descriptor, new Float32Array(stored.desc1));
        let score = Math.floor((1 - dist) * 100);
        if(score > 99) score = 99;

        if(score >= 58) {
            updateStatus(`‚úÖ Verified (${score}%)`, "lime");
            logActivity("LOGIN", `Biometric Success ${score}%`);
            setTimeout(enterApp, 1000);
        } else {
            updateStatus(`‚õî Denied (${score}%). Try Again.`, "red");
            btn.disabled = false;
        }
    }
};

function enterApp() {
    stopCamera();
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadHistory(); loadInventory(); loadAssignments();
}

// --- APP LOGIC ---
async function logActivity(type, desc) {
    if(!currentUser) return;
    await push(ref(db, "logs"), { user: currentUser.email, type, desc, time: new Date().toLocaleString() });
}

window.switchTab = (t) => {
    ['newData','inventory','oldData','assigned','adminPanel'].forEach(x => document.getElementById(`tab-${x}`).classList.add("hidden"));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.remove("hidden");
    const map = {'newData':'btnNew','inventory':'btnInventory','oldData':'btnOld','assigned':'btnAssign','adminPanel':'btnAdmin'};
    if(map[t]) document.getElementById(map[t]).classList.add("active");
};

// Data Entry
function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}
window.saveStationDetails = () => {
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: inpStationName.value, len: inpStationLength.value, yl: inpYellowDist.value, th: inpYellowThick.value
    });
    logActivity("SAVE", "Draft Updated"); alert("Saved");
};
window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });
function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
window.submitStationData = () => {
    if(confirm("Submit Final?")) {
        get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
            const d = s.val();
            push(ref(db, "history"), { ...d.details, rows: d.rows, user: currentUser.email, date: new Date().toLocaleString() });
            remove(ref(db, `drafts/${currentUser.uid}`));
            logActivity("SUBMIT", `Final Data: ${d.details.name}`);
            alert("Submitted"); switchTab('oldData');
        });
    }
};

// History & Inventory
function loadHistory() {
    onValue(ref(db, "history"), snap => {
        const b = document.getElementById("historyBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            const btn = isAdmin ? `<td><button class="danger" onclick="delHist('${c.key}')">Del</button></td>` : '';
            b.innerHTML += `<tr><td>${v.date}</td><td>${v.name}</td><td>${v.user}</td><td>${v.rows?Object.keys(v.rows).length:0}</td>${btn}</tr>`;
        });
    });
}
window.delHist = (k) => remove(ref(db, `history/${k}`));

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("inventoryBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr><td>${v.item}</td><td>${v.qty}</td><td>${v.user}</td><td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td></tr>`;
        });
    });
}
window.addInventory = () => {
    push(ref(db, "inventory"), { item: invName.value, qty: invQty.value, user: currentUser.email });
    document.getElementById("addInvForm").classList.add("hidden");
};
window.delInv = (k) => remove(ref(db, `inventory/${k}`));

// --- NEW FEATURES ---

// 1. User Assignments (User View)
function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList");
        list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks assigned.</p>"; return; }
        
        snap.forEach(c => {
            const task = c.val();
            const div = document.createElement("div");
            div.className = "panel";
            div.style.borderLeft = task.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between">
                    <strong>Task: ${task.desc}</strong>
                    <span class="status-badge ${task.status === 'Done' ? 'status-completed' : 'status-pending'}">${task.status}</span>
                </div>
                <small>Assigned by: ${task.by} on ${task.date}</small>
                ${task.status !== 'Done' ? `<br><button onclick="completeTask('${c.key}')" style="margin-top:10px;">Mark Done</button>` : ''}
            `;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

// 2. Admin Logic
function loadAdminPanel() {
    // Load Users for Dropdowns & Table
    onValue(ref(db, "users"), snap => {
        const assignSel = document.getElementById("userSelectAssign");
        const auditSel = document.getElementById("userSelectAudit");
        const tableBody = document.getElementById("userListBody");
        
        assignSel.innerHTML = "<option>Select User</option>";
        auditSel.innerHTML = "<option>Select User</option>";
        tableBody.innerHTML = "";

        snap.forEach(c => {
            const u = c.val();
            const uid = c.key;
            // Dropdowns
            const opt = `<option value="${uid}">${u.email}</option>`;
            const optEmail = `<option value="${u.email}">${u.email}</option>`;
            assignSel.innerHTML += opt;
            auditSel.innerHTML += optEmail;

            // Table Row
            const hasBio = u.faceData ? "‚úÖ Done" : "‚ùå Pending";
            const status = u.terminated ? "<span style='color:red;font-weight:bold'>BANNED</span>" : "<span style='color:green'>Active</span>";
            const btnBan = u.terminated ? 
                `<button style="background:green; padding:2px 8px;" onclick="toggleBan('${uid}', false)">Unban</button>` : 
                `<button class="danger" style="padding:2px 8px;" onclick="toggleBan('${uid}', true)">Ban</button>`;
            const btnReset = u.faceData ? 
                `<button class="warning" style="padding:2px 8px;" onclick="resetFace('${uid}')">Reset Face</button>` : "";

            tableBody.innerHTML += `
                <tr>
                    <td>${u.email}</td>
                    <td style="text-align:center">${hasBio}</td>
                    <td>${status}</td>
                    <td>${btnBan} ${btnReset}</td>
                </tr>
            `;
        });
    });
}

window.assignTask = () => {
    const uid = document.getElementById("userSelectAssign").value;
    const desc = document.getElementById("taskDesc").value;
    if(!uid || !desc) return alert("Fill fields");
    push(ref(db, `assignments/${uid}`), { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" });
    alert("Task Assigned");
    document.getElementById("taskDesc").value = "";
};

window.fetchLogs = () => {
    const u = document.getElementById("userSelectAudit").value;
    onValue(query(ref(db, "logs"), orderByChild("user"), equalTo(u), limitToLast(10)), s => {
        const b = document.getElementById("logBody"); b.innerHTML = "";
        const l = []; s.forEach(c=>l.push(c.val()));
        l.reverse().forEach(x => b.innerHTML += `<tr><td>${x.time}</td><td><span class="log-tag tag-${x.type}">${x.type}</span></td><td>${x.desc}</td></tr>`);
    });
};

window.toggleBan = (uid, status) => {
    if(confirm(status ? "BAN this user? They will be logged out." : "Unban user?")) {
        update(ref(db, `users/${uid}`), { terminated: status });
    }
};

window.resetFace = (uid) => {
    if(confirm("DELETE biometric data for this user? They must re-register.")) {
        remove(ref(db, `users/${uid}/faceData`));
    }
};

</script>
</body>
</html>
