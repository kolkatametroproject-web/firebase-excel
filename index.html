<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MRPSP | Metro Railway Platform Safety Project</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- OFFICIAL GOVERNMENT & METRO THEME (UPDATED) --- */
:root {
  --metro-blue: #0A2342; /* Deep Professional Navy */
  --metro-gold: #C5A059; /* Metallic Gold Accent */
  --metro-red: #B91C1C;  /* Professional Alert Red */
  --metro-slate: #4A5568; /* Official Slate Text */
  --bg-color: #F8FAFC;    /* Clean Enterprise Background */
  --panel-bg: #FFFFFF;
  --text-main: #1A202C;
  --border-color: #E2E8F0;
  --success-green: #15803d; /* Darker, professional green */
}

body { 
    margin: 0; 
    font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif; 
    background: var(--bg-color); 
    color: var(--text-main); 
    font-size: 14px; 
    line-height: 1.5;
}

/* HEADER - OFFICIAL AUTHORITY STYLE */
header {
  background: var(--metro-blue);
  color: white;
  padding: 12px 25px;
  border-bottom: 4px solid var(--metro-gold);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
  flex-wrap: wrap;
}

/* BUTTONS - ENTERPRISE GRADE */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: var(--metro-blue);
  color: white;
  border: 1px solid #001a33;
  border-radius: 4px;
  font-weight: 600;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.2s ease-in-out;
}
button:hover { background: #163a63; transform: translateY(-1px); }
button:disabled { background: #94a3b8; cursor: not-allowed; border-color: #64748b; opacity: 0.8; transform: none; }

/* STATUS BUTTON VARIANTS */
button.danger { background: var(--metro-red); border-color: #991b1b; }
button.danger:hover { background: #dc2626; }
button.success { background: var(--success-green); border-color: #14532d; }
button.success:hover { background: #166534; }
button.warning { background: #d97706; color: white; border-color: #b45309; }
button.info { background: #0284c7; border-color: #0369a1; color: white; }
button.secondary { background: #64748b; border-color: #475569; color: white; }

/* INPUTS - CLEAN FORM STYLE */
input, select, textarea {
  background: #fff;
  border: 1px solid #cbd5e1;
  color: #334155;
  padding: 10px;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 12px;
  font-size: 14px;
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--metro-blue);
    box-shadow: 0 0 0 2px rgba(10, 35, 66, 0.1);
}

/* LAYOUT */
section { padding: 25px; max-width: 1200px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS - CARD STYLE */
.panel {
  background: var(--panel-bg);
  padding: 30px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 25px;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}
.panel h3 { 
    margin-top: 0; 
    color: var(--metro-blue); 
    border-bottom: 1px solid #e2e8f0; 
    padding-bottom: 15px; 
    margin-bottom: 20px; 
    font-size: 1.15rem; 
    display: flex;
    align-items: center;
    gap: 10px;
}

/* NAVIGATION - TABS STYLE */
/* --- MODERN NAVIGATION BAR (NO SCROLLBAR) --- */
.nav-bar { 
    display: flex; 
    flex-wrap: wrap; /* Allows tabs to stack if space runs out */
    justify-content: center; /* Centers tabs for a professional look */
    gap: 8px; 
    margin: 0 auto 25px auto; 
    padding: 10px;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    max-width: 1200px; /* Keeps it contained on huge screens */
    border: 1px solid #e2e8f0;
}

/* BUTTONS - PILL STYLE */
.nav-btn { 
    background: transparent; 
    color: #64748b; 
    border: none; 
    border-radius: 6px; /* Rounded pill shape */
    padding: 10px 16px;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.nav-btn i { font-size: 14px; } /* Icon size */

/* HOVER EFFECT */
.nav-btn:hover {
    background: #f1f5f9;
    color: var(--metro-blue);
    transform: translateY(-1px);
}

/* ACTIVE STATE - HIGH CONTRAST */
.nav-btn.active { 
    background: var(--metro-blue); 
    color: white; 
    box-shadow: 0 4px 6px rgba(10, 35, 66, 0.3);
    transform: translateY(-1px);
}

/* MOBILE OPTIMIZATION */
@media (max-width: 768px) {
    .nav-bar {
        justify-content: flex-start; /* Align left on mobile */
        overflow-x: auto; /* Allow swipe on tiny screens */
        flex-wrap: nowrap; /* Prevent stacking on very small screens to save vertical space */
        scrollbar-width: none; /* Hide scrollbar Firefox */
        -ms-overflow-style: none; /* Hide scrollbar IE */
        padding: 10px 0;
        box-shadow: none;
        background: transparent;
        border: none;
    }
    
    /* Hide scrollbar Chrome/Safari/Webkit */
    .nav-bar::-webkit-scrollbar { 
        display: none; 
    }

    .nav-btn {
        flex-shrink: 0; /* Prevent buttons from shrinking too small */
        background: white;
        border: 1px solid #e2e8f0;
        margin-right: 5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .nav-btn.active {
        border-color: var(--metro-blue);
    }
}
/* DATA TABLES - GOVERNMENT STYLE */
.table-wrapper { 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
    border-radius: 6px; 
    border: 1px solid #e2e8f0; 
}
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; background: white; }
th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
th { 
    background: #f8fafc; 
    color: var(--metro-blue); 
    font-weight: 700; 
    text-transform: uppercase; 
    font-size: 11px; 
    letter-spacing: 0.5px; 
    border-bottom: 2px solid #e2e8f0;
}
tr:nth-child(even) { background-color: #fcfcfc; }
tr:hover { background-color: #f1f5f9; }

/* MODALS */
.modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(15, 23, 42, 0.85); /* Darker, more secure feel */
    backdrop-filter: blur(2px);
    display: flex; justify-content: center; align-items: center; 
    flex-direction: column; z-index: 2000; padding: 20px; box-sizing: border-box; 
}

/* CAMERA UI - HIGH TECH LOOK */
#videoContainer {
    position: relative;
    width: 320px;
    max-width: 100%;
    height: 240px;
    background: #000;
    margin-bottom: 15px;
    border: 4px solid var(--metro-slate);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}
#cameraFeed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}
#overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    transform: scaleX(-1);
}

/* UPLOAD SECTION */
.upload-panel { 
    border: 2px dashed #cbd5e1; 
    background: #f8fafc; 
    padding: 30px; 
    text-align: center; 
    border-radius: 8px; 
    margin-top: 20px; 
    transition: border-color 0.2s;
}
.upload-panel:hover { border-color: var(--metro-blue); background: #f1f5f9; }

/* ADMIN CHECKBOX LIST */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #cbd5e1;
    padding: 15px;
    background: #fff;
    border-radius: 4px;
}
.checkbox-item { 
    display: block; margin-bottom: 8px; cursor: pointer; padding: 5px; border-radius: 4px;
}
.checkbox-item:hover { background: #f1f5f9; }
.checkbox-item input { width: auto; margin-right: 10px; margin-bottom: 0; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
.gallery-item { 
    border: 1px solid #e2e8f0; 
    padding: 10px; 
    border-radius: 6px; 
    text-align: center; 
    background: #fff; 
    transition: transform 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.gallery-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
.gallery-item img { max-width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #94a3b8; border: 2px solid #64748b; }
.dot.active { background: #22c55e; border-color: #16a34a; box-shadow: 0 0 8px #22c55e; }

/* STATUS BADGES */
.badge-online { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #bbf7d0; }
.badge-offline { background: #f1f5f9; color: #64748b; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #e2e8f0; }

/* SIGNATURE CANVAS */
canvas.sig-canvas { border: 2px solid #cbd5e1; background: #fff; cursor: crosshair; touch-action: none; border-radius: 4px; display:block; max-width: 100%; }

/* NEW: BARCODE MODAL STYLES */
#reader { width: 300px; max-width: 100%; background:white; padding:15px; border-radius:8px; }

/* MOBILE RESPONSIVE TWEAKS */
@media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
    #authContainer { margin-top: 10px; align-self: flex-start; }
    .panel { padding: 15px; }
    #videoContainer { width: 100%; height: auto; aspect-ratio: 4/3; }
    .nav-bar { padding-bottom: 5px; }
    .nav-btn { font-size: 12px; padding: 10px 15px; }
    .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    #otpUI { width: 90%; }
}

/* TIMELINE CARD STYLES */
.history-card {
    background: white;
    border-left: 4px solid #cbd5e1;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: relative;
    border: 1px solid #e2e8f0; border-left-width: 4px;
}
.history-card.checkout { border-left-color: #d97706; } /* Warning Orange for OUT */
.history-card.return { border-left-color: #0284c7; }   /* Info Blue for IN */
.history-card.add { border-left-color: #15803d; }      /* Green for ADD */

.hc-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
.hc-user { font-size: 14px; font-weight: bold; color: var(--metro-blue); }
.hc-meta { font-size: 11px; color: #64748b; margin-top: 4px; }

/* --- BANNED SCREEN OVERLAY --- */
.banned-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #450a0a; /* Deep Red */
    color: white;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
}

.banned-card {
    background: white;
    color: #1A202C;
    padding: 40px;
    border-radius: 12px;
    max-width: 500px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 8px solid #991b1b;
}

.banned-timer {
    font-size: 20px;
    font-weight: bold;
    color: #991b1b;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    background: #fee2e2;
    padding: 10px;
    border-radius: 4px;
}

/* ADMIN BAN MODAL */
.ban-btn-select {
    flex: 1;
    padding: 12px;
    background: #f1f5f9;
    color: #334155 !important;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
.ban-btn-select:hover { background: #e2e6ea; }
.ban-btn-select.selected {
    background: var(--metro-red);
    color: white !important;
    border-color: #991b1b;
}

/* INPUTS STYLING FOR BAN MODAL */
.ban-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 14px;
}
@media print {
    /* 1. HIDE EVERYTHING ON THE PAGE */
    body * { visibility: hidden !important; height: 0 !important; overflow: hidden !important; }

    /* 2. ONLY SHOW THE REPORT CONTAINER AND ITS CHILDREN */
    #printableReportContainer, #printableReportContainer * { 
        visibility: visible !important; 
        height: auto !important; 
    }

    /* 3. POSITION THE REPORT AT THE VERY TOP LEFT */
    #printableReportContainer {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* 4. HIDE UI BUTTONS INSIDE THE CONTAINER */
    .no-print { display: none !important; }
}
/* PRINTER PAGE SETTINGS */
@page {
    margin: 0; /* Remove default browser margins */
    size: auto; 
}
  /* --- NEW: FINANCE & PURCHASE DASHBOARD --- */
.finance-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
.fin-card { background: white; padding: 20px; border-radius: 8px; border-left: 5px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
.fin-card h4 { margin: 0; color: #64748b; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
.fin-card .amount { font-size: 26px; font-weight: 800; color: var(--metro-blue); margin-top: 5px; }
.fin-card.balance { border-left-color: var(--metro-blue); }
.fin-card.income { border-left-color: var(--success-green); }
.fin-card.expense { border-left-color: var(--metro-red); }
.fin-card i { position: absolute; right: 15px; bottom: 15px; font-size: 40px; opacity: 0.1; color: #000; }

/* PURCHASE GRID */
.purchase-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
@media (max-width: 768px) { .purchase-grid { grid-template-columns: 1fr; } }
/* REPORT PREVIEW (SCREEN) */
.report-paper {
    background: white;
    padding: 50px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 800px;
    margin: 40px auto;
    font-family: 'Times New Roman', serif;
    color: #000;
}
.report-header { text-align: center; border-bottom: 2px solid var(--metro-blue); padding-bottom: 20px; margin-bottom: 30px; }
.report-meta { display: flex; justify-content: space-between; margin-bottom: 30px; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
.report-section-title { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px; font-weight: bold; font-size: 14px; margin-top: 30px; color: var(--metro-blue); }
.report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
.report-table th, .report-table td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; }
  /* --- PREVIEW MODAL FIX --- */
/* This ensures the report covers the screen instead of pushing to the bottom */
#printableReportContainer:not(.hidden) {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #f8fafc; /* Professional slate background */
    z-index: 99999; 
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
}

/* Hide header and nav when report is open to prevent clicking other tabs */
body:has(#printableReportContainer:not(.hidden)) header,
body:has(#printableReportContainer:not(.hidden)) .nav-bar {
    display: none !important;
}
</style>
</head>

<body>
<header>
  <div style="display:flex; align-items:center">
    <div style="width:45px;height:45px;background:var(--metro-gold);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:4px;flex-shrink:0; font-size: 24px;">M</div>
    
    <div>
        <h1 style="margin:0; line-height:1.2; font-size: 1.3rem; letter-spacing: 0.5px;">METRO RAILWAY PLATFORM SAFETY PROJECT</h1>
        <small style="color: #cbd5e1; font-weight: 600; text-transform: uppercase; font-size: 10px;">Official Audit & Inspection Portal</small>
    </div>
  </div>

  <div id="authContainer" class="hidden">
    <span style="font-size:11px; margin-right:5px; opacity:0.7;">Logged in as:</span>
    <span id="userInfo" style="margin-right:20px; font-weight:bold; color:var(--metro-gold);"></span>
    <button class="danger" onclick="logout()" style="padding:6px 12px; font-size:11px;">TERMINATE SESSION</button>
  </div>
</header>
<section id="loginSection">
  <div class="panel" style="max-width:380px; margin: 80px auto; border-top: 6px solid var(--metro-blue); padding: 40px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
    <div style="text-align:center; margin-bottom:20px;">
        <i class="fas fa-shield-alt" style="font-size: 48px; color: var(--metro-blue);"></i>
        <h3 style="border:none; margin-top:15px; justify-content:center; padding:0;">Metro Platform Safety Project Access</h3>
    </div>
    <input id="email" placeholder="Official Email ID (user@metro.gov)">
    <input id="password" type="password" placeholder="Secure Password">
    <button onclick="login()" style="width:100%; padding:12px; margin-top:15px; font-size: 14px;">VERIFY CREDENTIALS</button>
    
    <p style="font-size:11px; color:#64748b; margin-top:25px; text-align:center; line-height: 1.4;">
        <strong>RESTRICTED SYSTEM:</strong> Unauthorized access is prohibited and monitored. Use of this system constitutes consent to security monitoring and auditing.
    </p>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:350px; max-width:90%; text-align:center;">
        <h3><i class="fas fa-user-edit"></i> Profile Setup</h3>
        <p style="color:#475569; margin-bottom:20px;">Please enter your official name as per records.</p>
        <input id="officialNameInput" placeholder="Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()" class="success" style="width:100%;">Save & Continue</button>
    </div>
</div>
 <div id="faceModal" class="modal-overlay hidden">
  <div class="panel" style="background: #1e293b; border: 1px solid #334155; color: white; width: 360px; text-align:center; padding: 20px;">
      <h2 id="modalTitle" style="color:white; margin-bottom:5px; font-size: 1.2rem;">Biometric Verification</h2>
      <p id="modalDesc" style="color:#94a3b8; margin-bottom:20px; font-size:13px;">Security Level 2: Face Scan</p>
      
      <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
          <div id="dot1" class="dot"></div>
          <div id="dot2" class="dot"></div>
          <div id="dot3" class="dot"></div>
      </div>

      <div id="videoContainer" style="margin: 0 auto 20px auto;">
        <video id="cameraFeed" autoplay playsinline muted></video>
        <canvas id="overlayCanvas"></canvas>
      </div>
      
      <div id="otpUI" class="hidden" style="background:white; padding:25px; border-radius:8px; width:280px; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index:20; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <h3 style="color:var(--metro-red); margin-top:0; border-bottom: none;"><i class="fas fa-shield-alt"></i> Admin PIN</h3>
        <input id="otpInput" type="password" placeholder="PIN" style="text-align:center; font-size:20px; letter-spacing:8px; border:2px solid var(--metro-blue); font-weight: bold; color: black; margin-bottom: 15px;">
        <button class="success" onclick="verifyOTP()" style="width:100%;">Authorize Access</button>
      </div>

      <div id="faceStatus" style="color:var(--metro-gold); margin-bottom:15px; font-weight:bold; height:20px; font-size: 12px;"></div>
      
      <div id="camControls" style="display:flex; flex-direction:column; gap:10px; align-items:center;">
        <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:var(--metro-blue); border:none; padding:12px 25px; font-weight: bold; width: 100%;">üì∏ SCAN FACE</button>
        <a href="javascript:void(0)" onclick="triggerAdminBypass()" style="color:#94a3b8; font-size:11px; text-decoration:underline;">PC without camera? Use Master Bypass</a>
      </div>
  </div>
</div>
<div id="barcodeModal" class="modal-overlay hidden">
    <div class="panel" style="width:360px; max-width:95%; text-align:center; background:#0f172a; border:2px solid var(--metro-gold); padding: 20px;">
        <h3 style="color:white; margin-bottom:15px; border-bottom-color: #334155;"><i class="fas fa-qrcode"></i> Scan Asset Tag</h3>
        <div id="reader" style="border-radius: 8px; overflow: hidden;"></div>
        <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:20px; width:100%;">CANCEL SCAN</button>
    </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
    <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
        <h3>Digital Signature Record</h3>
        <img id="modalSigImage" src="" style="border:1px solid #e2e8f0; background:white; max-width:100%; margin:15px 0; padding: 10px;">
        <br>
        <button onclick="closeSigModal()" class="secondary">Close Viewer</button>
    </div>
</div>

<section id="appScreen" class="hidden">
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">
        <i class="fas fa-ruler-combined"></i> Field Inspection
    </button>
    
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">
        <i class="fas fa-boxes"></i> Asset Tracking
    </button>
    
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">
        <i class="fas fa-folder-open"></i> Compliance Docs
    </button>
    
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">
        <i class="fas fa-tasks"></i> Operation Tasks
    </button>
    <button class="nav-btn" onclick="switchTab('comments')" id="btnComments">
    <i class="fas fa-comment-dots"></i> Station Comments
</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="color:var(--metro-red);">
        <i class="fas fa-user-shield"></i> System Oversight
    </button>
    
    <button class="nav-btn" onclick="switchTab('dataView')" id="btnDataView">
        <i class="fas fa-database"></i> Master Logs
    </button>
    <button class="nav-btn" onclick="switchTab('funds')" id="btnFunds">
        <i class="fas fa-rupee-sign"></i> Project Funds
    </button>
    <button class="nav-btn" onclick="switchTab('purchase')" id="btnPurchase">
        <i class="fas fa-shopping-cart"></i> Procurement
    </button>
    <button class="nav-btn" onclick="switchTab('printReport')" id="btnPrintReport">
        <i class="fas fa-print"></i> Audit Reports
    </button>
    <button class="nav-btn" onclick="switchTab('directives')" id="btnDirectives">
    <i class="fas fa-file-contract"></i>Directives
</button>
    <button class="nav-btn" onclick="switchTab('billing')" id="btnBilling">
    <i class="fas fa-file-invoice-dollar"></i> Customer Billing
</button>
    <button class="nav-btn" onclick="switchTab('warranty')" id="btnWarranty">
    <i class="fas fa-shield-halved"></i> Warranty & Claims
</button>
    <span id="adminBadge" class="hidden" style="margin-left:auto; background:var(--metro-red); color:white; padding:6px 12px; border-radius:20px; font-size:10px; font-weight:bold; display:flex; align-items:center; letter-spacing: 0.5px;">
        <i class="fas fa-shield-alt" style="margin-right:5px;"></i> AUDITOR
    </span>
</div>

<div id="tab-newData">
  <div class="panel">
    <h3><i class="fas fa-map-marker-alt"></i> Select Inspection Site</h3>
    <label style="font-weight:700; color:var(--metro-blue); font-size: 12px; text-transform: uppercase;">Step 1: Select Corridor</label>
    <select id="lineSelect" onchange="handleLineChange()" style="border:2px solid var(--metro-blue); font-weight:600;">
      <option value="">-- Select Line --</option>
      <option value="Blue Line">Blue Line (North-South: Dakshineswar ‚Üî New Garia)</option>
      <option value="Green Line">Green Line (East-West: Sector V ‚Üî Howrah Maidan)</option>
      <option value="Purple Line">Purple Line (Joka ‚Üî Majerhat)</option>
      <option value="Yellow Line">Yellow Line (Noapara ‚Üî Airport)</option>
      <option value="Orange Line">Orange Line (New Garia ‚Üî Airport)</option>
      <option value="Pink Line">Pink Line (Baranagar ‚Üî Barrackpore)</option>
    </select>

    <label style="font-weight:700; color:var(--metro-blue); margin-top:15px; display:block; font-size: 12px; text-transform: uppercase;">Step 2: Select Station</label>
    <select id="stationSelect" onchange="handleStationChange()" disabled style="background:#f1f5f9;">
      <option value="">-- First Select a Corridor --</option>
    </select>
  </div>

  <div id="mainDataForm" class="hidden">
    
    <div id="dataExistsWarning" class="hidden" style="background:#fff7ed; color:#9a3412; padding:15px; border:1px solid #fed7aa; border-radius:6px; margin-bottom:20px; display: flex; gap: 10px; align-items: center;">
        <i class="fas fa-exclamation-circle" style="font-size: 20px;"></i>
        <div>
            <strong>Existing Record Found</strong><br>
            Primary measurement data is locked. You may append additional rake data below.
        </div>
    </div>

    <div class="panel" id="stationDetailsPanel" style="border-left: 4px solid var(--success-green);">
      <h3 id="formTitle">üìù Yellow Line Specification</h3>
      <input id="inpStationName" type="hidden"> 
      
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:20px; margin-bottom: 20px;">
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">PLATFORM LENGTH (m)</label>
            <input id="inpStationLength" placeholder="e.g. 180">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">YL DISTANCE (cm)</label>
            <input id="inpYellowDist" placeholder="e.g. 85">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">YL THICKNESS (cm)</label>
            <input id="inpYellowThick" placeholder="e.g. 10">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">IMPLEMENTATION STATUS</label>
            <select id="inpImplementation" style="font-weight:bold; border:2px solid var(--metro-blue);">
                <option value="">-- Select Status --</option>
                <option value="YES">‚úÖ COMPLIANT (YES)</option>
                <option value="NO">‚ùå NON-COMPLIANT (NO)</option>
            </select>
          </div>
      </div>
      <label style="font-size:11px; font-weight:bold; color:#64748b;">INSPECTOR REMARKS</label>
      <textarea id="inpRemarks" placeholder="Observations regarding safety compliance..." rows="3"></textarea>
      
      <div style="text-align:right; margin-top: 15px;">
          <button class="secondary" id="btnSaveDraft" onclick="saveStationDetails()"><i class="fas fa-save"></i> Save Draft</button>
      </div>
    </div>

   <div class="panel">
    <h4><i class="fas fa-train"></i> Rake Clearance Data</h4>
    
    <div class="table-wrapper" style="margin-top:15px;">
        <table style="width:100%">
            <thead>
                <tr>
                    <th style="width:50px; text-align:center;">#</th>
                    <th>Rake ID</th>
                    <th>Rake Series</th>
                    <th>Front Clearance (mm)</th>
                    <th>Rear Clearance (mm)</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="distanceBody"></tbody>
        </table>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items: center;">
        <button class="info" onclick="addDistanceRow()">+ Add Measurement Row</button>
        
        <button onclick="submitStationData()" id="btnFinalSubmit" class="success" style="padding: 12px 24px;">
            <i class="fas fa-check-circle"></i> SUBMIT FINAL REPORT
        </button>
    </div>
   </div>

  </div> 
</div>

<div id="tab-inventory" class="hidden">
    
    <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; padding: 10px; background: #e2e8f0; border-radius: 6px;">
        <button onclick="toggleInvMode('list')" class="info"><i class="fas fa-list"></i> View Stock</button>
        <button onclick="toggleInvMode('add')" class="success"><i class="fas fa-plus"></i> New Asset</button>
        <button onclick="toggleInvMode('checkout')" class="warning"><i class="fas fa-sign-out-alt"></i> Checkout</button>
        <button onclick="toggleInvMode('return')" class="info" style="background:var(--metro-blue); border-color:var(--metro-blue);"><i class="fas fa-sign-in-alt"></i> Return</button>
        <button onclick="toggleInvMode('history')" class="secondary"><i class="fas fa-history"></i> Audit Trail</button>
    </div>

<div id="inv-add" class="panel hidden" style="border-top: 4px solid var(--success-green);">
    <h3 id="invFormTitle" style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> Register New Asset</h3>
    <input type="hidden" id="editItemKey"> <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:15px;">
        <div style="display:flex; gap:5px;">
            <input id="invBarcode" placeholder="Scan/Type Tag ID" onchange="checkBarcodeUnique(this.value)">
            <button onclick="openBarcodeScanner('ADD')" class="secondary" style="width:45px; padding:0;"><i class="fas fa-qrcode"></i></button>
        </div>
        <input id="invName" placeholder="Asset Name (e.g. Raspberry Pi)">
        <input type="number" id="invRegPrice" placeholder="Purchase Price (‚Çπ)">
    </div>
      
    <div id="barcodeError" class="hidden" style="background:#fee2e2; color:#991b1b; padding:10px; border-radius:4px; margin-bottom:15px;">
        <i class="fas fa-ban"></i> Error: Tag ID already exists.
    </div>

    <div style="display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:15px; margin-bottom:15px;">
        <select id="addLocSelect">
            <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
            <option value="Soham Pal Bag">Soham Pal Bag</option>
            <option value="Other">Other (Specify...)</option>
        </select>
        <input id="addLocSpot" placeholder="Unit/Rack (e.g. Shelf 1)">
        <select id="invCondition">
            <option value="New">Condition: New</option>
            <option value="Good" selected>Condition: Good</option>
            <option value="Damaged">Condition: Damaged</option>
        </select>
    </div>

    <div style="display:flex; gap:10px;">
        <button id="btnAddStock" onclick="addUniqueItem()" class="success" style="flex:2;">SAVE ASSET DATA</button>
        <button id="btnCancelEdit" onclick="resetInvForm()" class="secondary hidden" style="flex:1;">CANCEL EDIT</button>
    </div>
</div>
  <div id="inv-checkout" class="panel hidden" style="border-top: 4px solid #d97706;">
    <h3 style="color:#d97706;"><i class="fas fa-sign-out-alt"></i> Asset Checkout Protocol</h3>
    <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
        Scan asset barcode to initiate checkout sequence.
    </p>
    
    <div style="text-align:center; padding:20px; background: #fff7ed; border-radius: 8px;">
        <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px;">
            <i class="fas fa-qrcode"></i> INITIATE SCAN
        </button>
    </div>

    <div id="checkout_display" class="hidden" style="background:#fffbeb; padding:25px; border:1px solid #fcd34d; text-align:center; margin-top:20px; border-radius:6px;">
        <h2 id="checkout_item_name" style="color:#92400e; margin:0 0 10px 0;">--</h2>
        <div style="font-family:'Courier New', monospace; font-size:14px; color:#78350f; margin-bottom:20px;">
            ID: <span id="checkout_item_code" style="font-weight:bold;">--</span>
        </div>
        
        <label style="display:block; text-align:left; font-size:11px; font-weight:bold; color:#92400e; margin-bottom: 5px;">PURPOSE OF USAGE</label>
        <input id="checkoutPurpose" placeholder="e.g. Scheduled Maintenance, Testing" style="border-color: #f59e0b;">

        <div id="btn_checkout_verify" style="margin-top: 15px;">
             <button onclick="submitTransactionNoFace('CHECKOUT')" style="background:#d97706; border:none; width:100%;">
                CONFIRM WITHDRAWAL
             </button>
        </div>
    </div>
</div>

<div id="inv-return" class="panel hidden" style="border-top: 4px solid var(--metro-blue);">
    <h3 style="color:var(--metro-blue);"><i class="fas fa-undo"></i> Asset Return Protocol</h3>
    <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
        Scan asset barcode to verify return and update inventory location.
    </p>
    
    <div style="text-align:center; padding:20px; background: #f0f9ff; border-radius: 8px;">
        <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px; background: var(--metro-blue); border-color: var(--metro-blue);">
            <i class="fas fa-qrcode"></i> INITIATE RETURN SCAN
        </button>
    </div>

    <div id="return_display" class="hidden" style="background:#f1f5f9; padding:25px; border:1px solid #cbd5e1; text-align:center; margin-top:20px; border-radius:6px;">
        
        <h2 id="return_item_name" style="color:var(--metro-blue); margin:0 0 10px 0;">--</h2>
        <div style="font-family:'Courier New', monospace; font-size:14px; color:#475569; margin-bottom:20px;">
            ID: <span id="return_item_code" style="font-weight:bold;">--</span>
        </div>

        <div style="text-align:left; background:white; padding:15px; border-radius:6px; border: 1px solid #e2e8f0;">
            
            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase;">Return Facility</label>
            <select id="returnLocSelect" onchange="toggleOtherInput()" style="margin-bottom:10px;">
                <option value="D2 Building - Heerok Sir Lab">D2 Building - Heerok Sir Lab</option>
                <option value="Other">Other (Specify...)</option>
            </select>

            <div id="divOtherLoc" class="hidden">
                <input id="returnLocOther" placeholder="Specify Facility Name">
            </div>

            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase; margin-top: 10px; display: block;">Storage Unit / Rack</label>
            <input id="returnLocSpot" placeholder="e.g. Cabinet A, Shelf 2">
        </div>

        <div id="btn_return_verify" style="margin-top:20px;">
             <button onclick="submitTransactionNoFace('RETURN')" class="info" style="width:100%; background: var(--metro-blue);">
                CONFIRM RETURN
             </button>
        </div>
    </div>
</div>

<div id="inv-history" class="panel hidden">
    <div style="text-align:center; padding:40px 20px;">
        <h2 style="color:var(--metro-blue); margin-bottom:10px;">Asset Audit Trail</h2>
        <p style="color:#64748b; margin-bottom:20px;">Scan barcode to retrieve complete lifecycle history.</p>
        
        <div style="max-width:400px; margin:0 auto; display:flex; gap:10px;">
            <input 
                id="auditSearchInput" 
                placeholder="Scan or Enter Asset Tag..." 
                style="padding:12px; font-size:16px; border:2px solid var(--metro-blue); flex-grow:1;"
                onchange="fetchAuditHistory(this.value)"
            >
            <button 
                onclick="openBarcodeScanner('AUDIT_SEARCH')" 
                class="warning" 
                style="padding:12px 20px; font-size:18px;"
            >
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>
</div>

<div id="auditResultModal" class="modal-overlay hidden">
    <div class="panel" style="width:450px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; background:#f8fafc; border: none;">
        
        <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-size:16px; border:none; color:white; padding:0;">Asset Lifecycle</h3>
                <small id="auditModalBarcode" style="opacity:0.8; font-family:'Courier New', monospace;">--</small>
            </div>
            <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div id="auditTimelineContainer" style="overflow-y:auto; padding:20px; flex-grow:1;">
            <div style="text-align:center; color:#64748b;">Retrieving records...</div>
        </div>

    </div>
</div>

<div id="inv-list" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
        <div>
            <h3 style="margin:0; border:none; padding:0;">Current Inventory</h3>
            <small id="stockSummaryText" style="color:var(--metro-blue); font-weight:bold;">Syncing Database...</small>
        </div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="mainStockSearch" onkeyup="filterStockTable()" placeholder="Search Assets..." style="width:250px; margin:0;">
            <button onclick="openBarcodeScanner('SEARCH_STOCK')" class="secondary" title="Scan to Search">
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>

    <div class="table-wrapper" style="max-height:600px; overflow-y:auto;">
        <table>
            <thead style="position:sticky; top:0;">
                <tr>
                    <th>Tag ID</th>
                    <th>Asset Name</th>
                    <th>Cycle Count</th>
                    <th>Custodian</th>
                    <th>Location</th>
                    <th>Purchase Price</th>
                    <th>Status</th>
                    <th>Controls</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
</div>

</div> 
<div id="tab-gallery" class="hidden">
  
  <div class="panel">
    <h3><i class="fas fa-folder-open"></i> Compliance Documentation</h3>
    
    <div style="background:#f8fafc; padding:15px; border-radius:6px; border:1px solid #cbd5e1; margin-bottom:20px;">
        <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px; text-transform: uppercase;">1. Select Target Site</label>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <select id="galleryLineSelect" onchange="handleGalleryLineChange()" style="flex:1; border:2px solid var(--metro-blue);">
              <option value="">-- Select Line --</option>
              <option value="Blue Line">Blue Line</option>
              <option value="Green Line">Green Line</option>
              <option value="Purple Line">Purple Line</option>
              <option value="Yellow Line">Yellow Line</option>
              <option value="Orange Line">Orange Line</option>
              <option value="Pink Line">Pink Line</option>
            </select>

            <select id="galleryStationSelect" onchange="handleGalleryStationChange()" disabled style="flex:1; background:#f1f5f9;">
              <option value="">-- Select Line First --</option>
            </select>
        </div>
    </div>

    <div id="galleryUploadSection" class="hidden">
        <h4 style="margin:0 0 10px 0; color:var(--metro-blue);">2. Capture or Upload Evidence</h4>
        <p id="uploadTargetText" style="font-weight:bold; color:var(--success-green); margin-bottom:15px;">Target: None</p>

        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            
            <div class="panel" style="flex:1; min-width:300px; padding:20px; text-align:center; border:2px dashed var(--metro-blue);">
                <h5 style="margin-top:0;"><i class="fas fa-camera"></i> Live Capture</h5>
                
                <div id="evidenceVideoContainer" style="background:black; width:100%; height:200px; margin-bottom:10px; border-radius:4px; display:none; overflow:hidden;">
                    <video id="evidenceVideo" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
                </div>
                
                <img id="evidencePreview" style="max-width:100%; max-height:200px; display:none; margin:0 auto 10px auto; border:2px solid #22c55e;">

                <div id="evidenceCamControls">
                    <button onclick="startEvidenceCamera()" class="info" style="width:100%;"><i class="fas fa-video"></i> Start Camera</button>
                </div>
                
                <div id="evidenceCaptureControls" class="hidden" style="display:flex; gap:5px;">
                    <button onclick="captureEvidencePhoto()" class="warning" style="flex:1;"><i class="fas fa-camera"></i> Click</button>
                    <button onclick="stopEvidenceCamera()" class="danger" style="width:40px;"><i class="fas fa-times"></i></button>
                </div>

                <div id="evidenceSaveControls" class="hidden" style="display:flex; gap:5px;">
                    <button onclick="uploadCapturedEvidence()" class="success" style="flex:1;">‚¨Ü Upload Photo</button>
                    <button onclick="retryEvidencePhoto()" class="secondary" style="width:40px;"><i class="fas fa-redo"></i></button>
                </div>
            </div>

            <div class="panel" style="flex:1; min-width:300px; padding:20px; text-align:center; border:2px dashed #cbd5e1;">
                <h5 style="margin-top:0;"><i class="fas fa-upload"></i> File Upload</h5>
                <p style="font-size:11px; color:#666;">Max Size: 3MB | Formats: JPG, PNG, PDF</p>
                <p style="font-size:11px; color:#666;">Limits: PDF (3MB) | Images (10MB)</p>                
                <input type="file" id="evidenceFile" accept="image/*,application/pdf" style="margin-bottom:15px;">
                <button onclick="uploadFileEvidence()" class="info" style="width:100%;">‚¨Ü Upload File</button>
            </div>
        </div>

        <hr style="margin:25px 0; border:0; border-top:1px solid #e2e8f0;">
        
        <h4 style="color:var(--metro-blue);"><i class="fas fa-images"></i> Digital Repository</h4>
        <div id="galleryContainer" class="gallery-grid">
            <p style="color:#666; font-style:italic;">Select a station to view documents.</p>
        </div>
    </div>
  </div>
</div>
<div id="tab-assigned" class="hidden">
    <div class="panel"><h3><i class="fas fa-clipboard-check"></i> Assigned Operations</h3><div id="taskList"></div></div>
</div>
<div id="tab-comments" class="hidden">
    <div class="panel">
        <h3><i class="fas fa-comment-dots"></i> General Station Observations</h3>
        <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Use this section for general commands and observations. Technical data is reserved for Audit Reports.</p>
        
        <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
            <label style="font-weight:bold; font-size: 11px;">Select Site:</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <select id="commentLineSelect" onchange="handleCommentLineChange()" style="flex:1;">
                    <option value="">-- Select Line --</option>
                    <option value="Blue Line">Blue Line</option>
                    <option value="Green Line">Green Line</option>
                    <option value="Purple Line">Purple Line</option>
                    <option value="Yellow Line">Yellow Line</option>
                </select>
                <select id="commentStationSelect" disabled style="flex:1;">
                    <option value="">-- Select Station --</option>
                </select>
            </div>

            <label style="font-weight:bold; font-size: 11px; margin-top:20px; display:block;">Comment / Command:</label>
            <textarea id="commentTextInput" rows="6" placeholder="Write station-specific comments here..."></textarea>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div>
                    <label style="font-size:11px; font-weight:bold;">Conducting Officer:</label>
                    <select id="selCommentInspector"></select>
                </div>
                <div>
                    <label style="font-size:11px; font-weight:bold;">Approving Authority:</label>
                    <select id="selCommentAuthority">
                        <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
                        <option value="Prof. Heerok Banerjee">Prof. Heerok Banerjee</option>
                    </select>
                </div>
            </div>

            <button type="button" onclick="printStationComment()">
    Print
</button>

        </div>
    </div>
</div>
<div id="tab-adminPanel" class="hidden">
    <div class="panel" style="border-top: 5px solid var(--metro-red);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="color:var(--metro-red);"><i class="fas fa-shield-alt"></i> System Oversight Console</h3>
        <button onclick="loadAdminPanel()" class="secondary"><i class="fas fa-sync"></i> Refresh Data</button>
      </div>

      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 20px;">1. Personnel Status & Security</h4>
      <div class="table-wrapper">
      <table>
          <thead>
              <tr>
                  <th>User Profile</th>
                  <th>Connection</th>
                  <th>Task Load</th>
                  <th>Biometrics</th>
                  <th>Admin Actions</th>
              </tr>
          </thead>
          <tbody id="userListBody"></tbody>
      </table>
      </div>

      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-red); margin-top: 30px;">2. Master Security PIN (Global Bypass Code)</h4>
      <div style="background:#fff1f2; border:1px solid #fecaca; padding:20px; border-radius:6px; margin-bottom: 20px;">
          <p style="font-size:12px; color:#b91c1c; margin-top:0;"><strong>Strict Security:</strong> Changing this PIN immediately invalidates the old code for all users across all terminals.</p>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; align-items:end;">
              <div>
                  <label style="font-size:11px; font-weight:bold; color:#7f1d1d;">CURRENT SYSTEM PIN</label>
                  <input id="displayCurrentPin" disabled style="background:#f8fafc; font-weight:bold; letter-spacing:4px; text-align:center; color:#1e293b; border: 1px solid #ddd;" value="SYNCING...">
              </div>
              <div>
                  <label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">SET NEW 4-DIGIT PIN</label>
                  <input id="newPinInput" type="text" maxlength="4" placeholder="0000" style="letter-spacing:8px; text-align:center; font-weight:bold; border:2px solid #cbd5e1;">
              </div>
              <button onclick="updateMasterPin()" class="danger" style="height:42px; width:100%; font-size: 12px; font-weight: 800;">UPDATE SYSTEM PIN</button>
          </div>
      </div>
      
      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 30px;">3. Task Assignment</h4>
      <label style="font-size: 12px; font-weight: bold;">Select Personnel:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="2" placeholder="Enter detailed operational instructions..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:10px;">Dispatch Orders</button>
      </div>
    </div>
</div>
<div id="adminTaskModal" class="modal-overlay hidden">
    <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
        <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:white; border:none; padding:0;">Task Log: <span id="modalTaskUserName">User</span></h3>
            <button class="danger" onclick="closeTaskModal()" style="padding:4px 10px; font-size:12px;">CLOSE</button>
        </div>
        
        <div style="overflow-y:auto; flex-grow:1; background:#f8fafc; padding: 20px;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Control</th>
                        </tr>
                    </thead>
                    <tbody id="adminTaskBody">
                        <tr><td colspan="4" style="text-align:center;">Retrieving...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="bannedScreen" class="banned-overlay hidden">
    <div class="banned-card">
        <i class="fas fa-ban" style="font-size: 50px; color: #991b1b; margin-bottom: 20px;"></i>
        
        <h1 style="color:#991b1b; margin:0; font-size: 32px; letter-spacing: 1px; text-transform:uppercase;">ACCESS REVOKED</h1>
        <p style="color:#333; margin-top: 5px; font-weight:bold;">Your account has been suspended by the System Administrator.</p>
        
        <hr style="border: 0; border-top: 2px solid #e2e8f0; margin: 25px 0;">

        <div style="text-align:left; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase; letter-spacing:1px;">Violation Category</label>
            <div id="displayBanReason" style="font-weight:bold; font-size: 18px; color: #1f2937; margin-top:5px;">--</div>
        </div>

        <div style="text-align:left; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase; letter-spacing:1px;">Suspension Duration</label>
            <div id="bannedTimeDisplay" class="banned-timer" style="margin-top:5px; text-align:left; font-size:16px;">--</div>
        </div>

        <div style="text-align:left; background:#fff1f2; padding:15px; border-radius:6px; border-left:4px solid #991b1b; margin-bottom:20px;">
            <label style="font-size:11px; font-weight:bold; color:#991b1b; text-transform:uppercase;">‚ö† Remedial Action Required</label>
            <div id="displayBanAction" style="color:#7f1d1d; font-weight:bold; font-size:15px; margin-top:5px; line-height:1.4;">--</div>
        </div>

        <div style="text-align:left; margin-bottom:20px;">
             <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform:uppercase; letter-spacing:1px;">Admin Remarks</label>
             <div id="displayBanRemarks" style="font-size:14px; color:#4b5563; font-style:italic; margin-top:5px; background:#f8fafc; padding:10px; border-radius:4px;">--</div>
        </div>

        <button onclick="logout()" style="background:#1e293b; color:white; padding:15px 40px; font-size: 14px; border:none; border-radius: 6px; font-weight:bold; cursor:pointer; width:100%; letter-spacing:1px;">
            <i class="fas fa-sign-out-alt"></i> ACKNOWLEDGE & LOGOUT
        </button>
    </div>
</div>
<div id="adminBanModal" class="modal-overlay hidden">
    <div class="panel" style="width:500px; max-width:95%; border-top: 6px solid var(--metro-red);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="color:var(--metro-red); margin:0; border:none; padding:0;">‚õî Suspend User Access</h3>
            <button onclick="closeBanModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
        </div>
        
        <p style="background:#fee2e2; padding:15px; border-radius:6px; color:#991b1b; margin-bottom:20px; font-weight: bold; border: 1px solid #fecaca;">
            Target: <span id="banTargetName">User</span>
        </p>

        <label style="font-weight:bold; display:block; font-size: 12px; margin-bottom: 5px;">1. Violation Category</label>
        <select id="banReasonInput" class="ban-input" onchange="toggleBanOtherInput()">
            <option value="Misconduct">Code of Conduct Violation</option>
            <option value="Security Violation">Security Protocol Breach</option>
            <option value="Asset Damage">Asset Mishandling / Damage</option>
            <option value="Attendance">Attendance Irregularity</option>
            <option value="Pending Investigation">Pending Internal Investigation</option>
            <option value="Other">Other (Specify)</option>
        </select>

        <div id="divBanOther" class="hidden">
            <input id="banReasonOther" class="ban-input" placeholder="Specify Details..." style="border-left: 4px solid var(--metro-red);">
        </div>

        <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">2. Remedial Action Required</label>
        <input id="banActionInput" class="ban-input" placeholder="e.g. Report to HR, Submit Incident Report...">

        <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">3. Suspension Duration</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <button class="ban-btn-select" onclick="selectBanDuration(1, this)">24 Hours</button>
            <button class="ban-btn-select" onclick="selectBanDuration(3, this)">3 Days</button>
            <button class="ban-btn-select" onclick="selectBanDuration(7, this)">1 Week</button>
            <input type="date" id="banCustomDate" class="ban-input" style="margin:0; height:100%; text-align:center;" onchange="selectBanCustomDate(this)">
        </div>
        
        <label style="font-weight:bold; display:block; margin-top: 15px; font-size: 12px; margin-bottom: 5px;">4. Administrative Remarks</label>
        <textarea id="banRemarks" rows="2" class="ban-input" placeholder="Internal notes..."></textarea>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button onclick="closeBanModal()" class="secondary">Cancel</button>
            <button onclick="submitBan()" class="danger" style="font-weight:bold; padding: 10px 20px;">CONFIRM SUSPENSION</button>
        </div>
    </div>
</div>
<div id="tab-dataView" class="hidden">
  
  <div class="panel">
    <h3><i class="fas fa-database"></i> Master Log Database</h3>
    
    <div style="background: #e2e8f0; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Filter by Location:</label>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <select id="logLineSelect" onchange="handleLogLineChange()" style="flex: 1; border:1px solid #cbd5e1;">
              <option value="">-- Select Line --</option>
              <option value="Blue Line">Blue Line</option>
              <option value="Green Line">Green Line</option>
              <option value="Purple Line">Purple Line</option>
              <option value="Yellow Line">Yellow Line</option>
              <option value="Orange Line">Orange Line</option>
              <option value="Pink Line">Pink Line</option>
            </select>

            <select id="logStationSelect" onchange="loadSpecificStationData()" disabled style="flex: 1; background:#f1f5f9;">
              <option value="">-- Select Line First --</option>
            </select>
        </div>
    </div>
  </div>

  <div id="logResultsPanel">
    
    <div class="panel" style="border-left: 4px solid var(--metro-blue);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <h4 id="logTableTitle" style="margin:0; color:var(--metro-blue);">üìä Recent Station Records</h4>
          <button onclick="loadSpecificStationData()" class="secondary" style="font-size:11px; padding: 6px 12px;"><i class="fas fa-sync"></i> Refresh Table</button>
      </div>
      <div class="table-wrapper" style="margin-top:15px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Inspector</th>
              <th>Length</th>
              <th>Dist</th>
              <th>Thick</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Control</th>
            </tr>
          </thead>
          <tbody id="viewTable1Body">
            <tr><td colspan="8" style="text-align:center;">‚è≥ Syncing Database...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    </div>
</div>
<div id="tab-funds" class="hidden">
    <div class="finance-dashboard">
        <div class="fin-card income">
            <h4>Total Grant</h4>
            <div class="amount" id="dispTotalCredit">‚Çπ 0</div>
            <i class="fas fa-hand-holding-usd"></i>
        </div>
        <div class="fin-card expense">
            <h4>Total Spent</h4>
            <div class="amount" id="dispTotalDebit">‚Çπ 0</div>
            <i class="fas fa-shopping-bag"></i>
        </div>
        <div class="fin-card balance">
            <h4>Balance Available</h4>
            <div class="amount" id="dispBalance">‚Çπ 0</div>
            <small id="budgetHealthText" style="color:green; font-weight:bold;">Healthy</small>
            <i class="fas fa-wallet"></i>
        </div>
    </div>

    <div id="adminFundPanel" class="panel hidden" style="border-top: 4px solid var(--success-green);">
        <h3 style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> Add Project Fund (Credit)</h3>
        <input type="hidden" id="editFundKey"> 

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; align-items:end;">
            <div><label style="font-size:11px; font-weight:bold;">Amount (‚Çπ)</label><input type="number" id="fundAmount" placeholder="0"></div>
            <div><label style="font-size:11px; font-weight:bold;">Sender / Source</label><input id="fundSource" placeholder="e.g. Metro Railway"></div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Mode</label>
                <select id="fundMode" onchange="toggleFundMode()">
                    <option value="NEFT/RTGS">NEFT / RTGS</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Cash">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="Other">Other</option>
                </select>
                <input id="fundModeOther" class="hidden" placeholder="Specify Mode..." style="margin-top:5px; border-left:3px solid var(--metro-blue);">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Status</label>
                <select id="fundStatus">
                    <option value="Approved">Approved</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="submitFund()" class="success" id="btnFundSubmit" style="height:42px; width:100%;">CREDIT FUND</button>
                <button onclick="cancelFundEdit()" id="btnFundCancel" class="secondary hidden" style="height:42px;">CANCEL</button>
            </div>
        </div>
    </div>
<div id="expenseFormPanel" class="panel" style="border-top: 4px solid var(--metro-red);">
        <h3 style="color:var(--metro-red);"><i class="fas fa-receipt"></i> Record Other Expense</h3>
        <input type="hidden" id="editExpenseKey">
        <p style="font-size:11px; color:#666; margin-bottom:10px;">For travel, food, logistics, etc. (Not for equipment procurement)</p>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; align-items:end;">
            <div>
                <label style="font-size:11px; font-weight:bold;">Expense Date</label>
                <input type="date" id="expDate" style="border-color:#cbd5e1;">
            </div>

            <div>
                <label style="font-size:11px; font-weight:bold;">Description</label>
                <input id="expDesc" placeholder="e.g. Travel to Site">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Amount (‚Çπ)</label>
                <input type="number" id="expAmount" placeholder="0.00">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Bill / Drive Link</label>
                <input id="expBillUrl" placeholder="https://drive.google.com/..." style="border-color:var(--metro-blue);">
            </div>
            
            <div style="display:flex; gap:5px;">
                <button onclick="submitExpense()" class="danger" id="btnExpSubmit" style="height:42px; width:100%;">SUBMIT EXPENSE</button>
                <button onclick="cancelExpEdit()" id="btnExpCancel" class="secondary hidden" style="height:42px;">CANCEL</button>
            </div>
        </div>
    </div>
    <div class="panel">
        <h3><i class="fas fa-file-invoice-dollar"></i> Balance Sheet & Ledger</h3>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>Date</th><th>Type</th><th>Description</th><th>Bill</th><th>Credit (+)</th><th>Debit (-)</th></tr>
                </thead>
                <tbody id="fundTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-purchase" class="hidden">
    <div id="purchaseFormPanel" class="panel" style="border-top: 4px solid var(--metro-blue);">
        <h3><i class="fas fa-cart-plus"></i> New Purchase Entry</h3>
        <input type="hidden" id="editPurchaseKey">
        
        <div class="purchase-grid">
            <div><label style="font-size:11px; font-weight:bold;">Product Name</label><input id="purItem" placeholder="Item Name"></div>
            <div><label style="font-size:11px; font-weight:bold;">Platform</label><input id="purPlatform" placeholder="Amazon/Vendor"></div>
            <div><label style="font-size:11px; font-weight:bold;">Order ID</label><input id="purOrderId" placeholder="Order #"></div>
        </div>
        
        <div class="purchase-grid">
            <div><label style="font-size:11px; font-weight:bold;">Price (‚Çπ)</label><input type="number" id="purPrice" oninput="calcPurTotal()"></div>
            <div><label style="font-size:11px; font-weight:bold;">Qty</label><input type="number" id="purQty" oninput="calcPurTotal()"></div>
            <div><label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">TOTAL (‚Çπ)</label><input id="purTotal" disabled style="background:#f1f5f9; font-weight:bold;"></div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="font-size:11px; font-weight:bold; color:var(--metro-red);">Bill / Invoice Link (Google Drive)</label>
            <input id="purBillUrl" placeholder="Paste link here (Required)..." style="border-left:4px solid var(--metro-red);">
        </div>

        <div style="text-align:right;">
             <button onclick="clearPurForm()" class="secondary">Cancel</button>
             <button onclick="submitPurchase()" class="info" id="btnPurSubmit">SAVE & DEDUCT FUND</button>
        </div>
    </div>
    
    <div class="panel">
        <h3><i class="fas fa-history"></i> Purchase History</h3>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Sl</th><th>Product Details</th><th>Vendor & Order ID</th><th>Qty</th><th>Unit Price</th><th>Total</th><th>Bill</th><th>Status</th></tr></thead>
                <tbody id="purchaseTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="rakeDataModal" class="modal-overlay hidden">
    <div class="panel" style="width:700px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--metro-blue); color:white; padding:15px 20px;">
            <h3 style="margin:0; color:white; border:none; padding:0;">Rake Clearance Table</h3>
            <button class="danger" onclick="closeRakeModal()" style="font-size:12px; padding: 5px 10px;">CLOSE</button>
        </div>
        
        <div class="table-wrapper" style="overflow-y:auto; flex-grow:1; padding: 20px; background: #f8fafc;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>RAKE NO</th>
                        <th>TYPE</th>
                        <th>FRONT</th>
                        <th>REAR</th>
                        <th>ACT</th>
                    </tr>
                </thead>
                <tbody id="modalRakeBody"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="tab-billing" class="hidden">
    <div class="panel" style="border-top: 6px solid var(--metro-blue);">
        <h3 style="border-bottom: 2px solid var(--metro-gold); padding-bottom: 10px;">
            <i class="fas fa-cash-register"></i> OFFICIAL BILLING & INVOICE GENERATOR
        </h3>
        <div style="background:#f1f5f9; padding:20px; border-radius:6px; margin-bottom:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; border-left: 5px solid var(--metro-blue);">
    <div>
        <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Customer Name</label>
        <input id="billCustName" placeholder="Full Official Name" style="margin-top:5px;">
    </div>
    <div>
        <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Billing Address</label>
        <input id="billCustAddr" placeholder="Address / Contact" style="margin-top:5px;">
    </div>
    <div>
        <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Client Type</label>
        <select id="billClientType" onchange="toggleBillStationSource()" style="margin-top:5px; height:45px; border:1px solid #cbd5e1; width:100%;">
            <option value="METRO">Kolkata Metro Railway</option>
            <option value="OTHER">Other Organization / Private</option>
        </select>
    </div>

    <div id="divBillMetroGroup" style="display: contents;">
        <div>
            <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Select Corridor</label>
            <select id="billLineSelect" onchange="handleBillLineChange()" style="margin-top:5px; height:45px; border:1px solid #cbd5e1; width:100%;">
                <option value="">-- Select Line --</option>
                <option value="Blue Line">Blue Line</option>
                <option value="Green Line">Green Line</option>
                <option value="Purple Line">Purple Line</option>
                <option value="Yellow Line">Yellow Line</option>
                <option value="Orange Line">Orange Line</option>
                <option value="Pink Line">Pink Line</option>
            </select>
        </div>
        <div>
            <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Target Metro Station</label>
            <select id="billMetroStation" disabled style="margin-top:5px; height:45px; border:1px solid #cbd5e1; width:100%; background:#f1f5f9;">
                <option value="">-- Select Station --</option>
            </select>
        </div>
    </div>

    <div id="divBillStationManual" class="hidden">
        <label style="font-size:11px; font-weight:900; color:var(--metro-blue); text-transform:uppercase;">Target Site (Manual)</label>
        <input id="billManualStation" placeholder="Enter Site Name" style="margin-top:5px; height:45px;">
    </div>
</div>        
        <div style="background: var(--metro-blue); padding: 25px; border-radius: 8px 8px 0 0; color: white; margin-bottom: 2px; border-bottom: 4px solid var(--metro-gold);">
            <h4 style="margin: 0 0 20px 0; color: var(--metro-gold); font-size: 13px; letter-spacing: 1.5px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-microchip" style="font-size: 18px;"></i> A. PRIMARY ASSET REGISTRATION
            </h4>
            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; align-items: end;">
                <div>
                    <label style="font-size: 10px; font-weight: 800; color: #cbd5e1; text-transform: uppercase;">1. Asset Identification (Tag / QR)</label>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <input id="billBarcodeInp" placeholder="Scan Asset QR Code..." style="margin: 0; background: white; color: black; font-weight: bold; height: 45px;">
                        <button onclick="openBarcodeScanner('BILLING_SCAN')" class="secondary" style="background: var(--metro-gold); width: 55px; border: none;">
                            <i class="fas fa-qrcode" style="font-size: 20px;"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label style="font-size: 10px; font-weight: 800; color: #cbd5e1; text-transform: uppercase;">2. Quantity</label>
                    <input type="number" id="billQty" value="1" style="margin-top: 5px; background: white; text-align: center; font-weight: bold; height: 45px;">
                </div>
                <button onclick="addScannedItemToBill()" class="success" style="height: 45px; padding: 0 30px; font-weight: 900; background: #15803d; border: none;">
                    + INSERT ASSET
                </button>
            </div>
        </div>

        <div style="background: #1e293b; padding: 25px; border-radius: 0 0 8px 8px; color: white; margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);">
            <h4 style="margin: 0 0 20px 0; color: #94a3b8; font-size: 14px; letter-spacing: 1.5px; text-transform: uppercase; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-tools" style="font-size: 18px;"></i> B. ADDITIONAL SERVICES / EXTRA WORK
            </h4>
            <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 20px; align-items: end;">
                <div>
                    <label style="font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 5px;">3. Service Description</label>
                    <input id="billAddlDesc" placeholder="e.g. Calibration, Installation" style="margin: 0; background: white; color: black; border: 2px solid #cbd5e1; height: 50px; padding: 10px;">
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 5px;">4. Service Charge (‚Çπ)</label>
                    <input type="number" id="billAddl" value="0" style="margin: 0; background: white; color: black; font-weight: bold; height: 50px;">
                </div>
                <button onclick="addServiceOnlyToBill()" class="info" style="height: 50px; padding: 0 30px; font-weight: 900; background: #0284c7; border: none; letter-spacing: 1px;">
                    + APPLY CHARGE
                </button>
            </div>
        </div>

        <h4 style="color:var(--metro-blue); text-transform:uppercase; font-size:13px; margin-bottom:10px; border-left:4px solid var(--metro-gold); padding-left:10px;">Cart Summary (Invoice Preview)</h4>
        <div class="table-wrapper" style="border: 2px solid #000;">
            <table style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr style="background:#000; color:#fff;">
                        <th style="color:white; padding:12px;">ITEM DESCRIPTION</th>
                        <th style="color:white; text-align:center;">QTY</th>
                        <th style="color:white; text-align:right;">UNIT RATE (‚Çπ)</th>
                        <th style="color:white; text-align:right;">TOTAL (‚Çπ)</th>
                        <th style="color:white; text-align:center; width:80px;">ACTION</th>
                    </tr>
                </thead>
                <tbody id="billCartBody"></tbody>
            </table>
        </div>

        <div style="display:flex; justify-content:flex-end; margin-top:20px;">
            <div style="width:350px; background:#000; color:#fff; padding:20px; text-align:right; border:4px solid var(--metro-gold);">
                <small style="color:var(--metro-gold); font-weight:800;">GRAND TOTAL PAYABLE</small>
                <div style="font-size:32px; font-weight:900;">‚Çπ <span id="billGrandTotalDisp">0.00</span></div>
                <div id="billWordsDisp" style="font-size:10px; font-style:italic; color:#ccc; margin-top:5px;">Zero Rupees Only</div>
            </div>
        </div>

        <button type="button" class="info" onclick="generateInvoicePrint()" style="margin-top:25px; width:100%; padding:20px; font-weight:900; font-size:16px; background:var(--metro-blue); border:none; letter-spacing:1px;">
            <i class="fas fa-file-invoice-dollar"></i> FINALIZE & PRINT OFFICIAL INVOICE
        </button>
    </div>
</div>
<div id="tab-directives" class="hidden">
    <div class="panel">
        <h3><i class="fas fa-print"></i> Permission & Instruction Generator</h3>
        <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Generate official documents for personnel permissions or instructions.</p>
        <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
            <label style="font-weight:bold; font-size: 11px;">1. DOCUMENT TYPE:</label>
            <select id="dirType" style="margin-top:5px; border:2px solid var(--metro-blue); font-weight:bold;">
                <option value="OFFICIAL PERMISSION">OFFICIAL PERMISSION LETTER</option>
                <option value="OPERATIONAL INSTRUCTION">OPERATIONAL INSTRUCTION</option>
            </select>
            <label style="font-weight:bold; font-size: 11px; margin-top:15px; display:block;">2. ASSIGN TO PERSONNEL (Select Multiple):</label>
            <div id="dirUserCheckboxList" class="checkbox-list" style="margin-top:5px; background:white; max-height:150px;"></div>
            <label style="font-weight:bold; font-size: 11px; margin-top:20px; display:block;">3. DIRECTIVE CONTENT / TERMS:</label>
            <textarea id="dirText" rows="6" placeholder="Specify the details here..."></textarea>
            <label style="font-size:11px; font-weight:bold; margin-top:15px; display:block;">APPROVING AUTHORITY:</label>
            <select id="selDirAuthority">
                <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
                <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
            </select>
            <button type="button" class="info" onclick="generateDirectivePrint()" style="margin-top:20px; width:100%; padding:15px; font-weight:bold;">
                <i class="fas fa-file-pdf"></i> GENERATE OFFICIAL DOCUMENT
            </button>
        </div>
    </div>
</div>
<div id="tab-printReport" class="hidden">
    <div class="panel">
        <h3><i class="fas fa-print"></i> Report Generation Center</h3>
        
        <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
            <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Select Inspection Site:</label>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
                <select id="printLineSelect" onchange="handlePrintLineChange()" style="flex:1;">
                    <option value="">-- Select Line --</option>
                    <option value="Blue Line">Blue Line</option>
                    <option value="Green Line">Green Line</option>
                    <option value="Purple Line">Purple Line</option>
                    <option value="Yellow Line">Yellow Line</option>
                    <option value="Orange Line">Orange Line</option>
                    <option value="Pink Line">Pink Line</option>
                </select>
                <select id="printStationSelect" onchange="fetchLogsForPrint()" disabled style="flex:1;">
                    <option value="">-- Select Line First --</option>
                </select>
            </div>
        </div>

        <div id="printLogList" class="hidden" style="margin-top:25px;">
            <h4>Available Inspection Records:</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Station</th>
                            <th>Inspector</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="printLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="printOptionsModal" class="modal-overlay hidden">
    <div class="panel" style="width:450px; max-width:95%;">
        <h3 style="color:var(--metro-blue); border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-top:0;">Configure Audit Report</h3>
        
        <p style="margin-bottom:20px; background: #f1f5f9; padding: 10px; border-radius: 4px;"><strong>Record Date:</strong> <span id="modalPrintDate" style="color:var(--metro-blue); font-weight:bold;">--</span></p>

        <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">1. Data Sections to Include:</label>
        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
                <input type="checkbox" id="chkStationDetails" checked> 
                Measurement Data
            </label>
            <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
                <input type="checkbox" id="chkRakeData" checked> 
                Clearance Data
            </label>
        </div>

        <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">2. Authorization Signatories:</label>
        
        <div style="margin-bottom:15px;">
            <small style="color: #64748b;">Conducting Officer:</small>
            <select id="selPrintInspector" style="margin-top: 5px;">
                <option value="">Loading...</option>
            </select>
        </div>

        <div style="margin-bottom:25px;">
            <small style="color: #64748b;">Approving Authority:</small>
            <select id="selPrintAuthority" style="margin-top: 5px; border-color: var(--metro-gold); background: #fffbeb;">
                <option value="">-- Select Authority --</option>
                <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
                <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; border-top:1px solid #e2e8f0; padding-top:20px;">
            <button class="secondary" onclick="closePrintModal()" style="flex:1;">Cancel</button>
            <button class="info" onclick="generateFinalReport()" style="flex:2;">GENERATE REPORT</button>
        </div>
    </div>
</div>
  <div id="printableReportContainer" class="hidden">
    <div class="no-print" style="text-align:center; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding:15px; background:#f8fafc;">
        <h3 style="margin:0 0 15px 0; color: var(--metro-blue);">Official Record Preview</h3>
        <button class="danger" onclick="closeReportPreview()" style="margin-right:20px;">CLOSE PREVIEW</button>
        <button onclick="printReport('POS')" style="background:#1e293b; color:white; padding: 10px 20px;"><i class="fas fa-receipt"></i> PRINT OFFICIAL RECORD</button>
    </div>

    <div class="report-paper" style="width: 58mm; max-width: 58mm; box-sizing: border-box; padding: 1mm; margin: 0 auto; overflow: hidden;">
        <div class="report-header" style="text-align: center; border-bottom: 6pt solid #000; padding-bottom: 5px;">
            <div style="font-size: 26pt; font-weight: 900; text-transform: uppercase;">METRO RAILWAY<br>PLATFORM SAFETY<br>PROJECT</div>
            <div style="font-size: 11pt; font-weight: 900; margin-top: 5px; line-height: 1.1;">
                INSTITUTE OF ENGINEERING AND MANAGEMENT<br>
                UNIVERSITY OF ENGINEERING AND MANAGEMENT
            </div>
            <div style="margin-top: 10px; font-size: 18pt; font-weight: 900; text-decoration: underline; text-transform: uppercase;">
                OFFICIAL INSPECTION RECORD
            </div>
        </div>

        <div style="border-bottom: 4pt solid #000; padding: 8px 0; text-align: left; width: 100%;">
            <div style="font-size: 16pt; text-decoration: underline;">Site:</div>
            <div id="rptStationName" style="font-size: 22pt; font-weight: 900; word-wrap: break-word;">--</div>
        </div>

        <div style="border-bottom: 4pt solid #000; padding: 8px 0; text-align: left; width: 100%;">
            <div style="font-size: 16pt; text-decoration: underline;">Date:</div>
            <div id="rptDate" style="font-size: 20pt; font-weight: 900;">--</div>
        </div>

        <div style="border-bottom: 4pt solid #000; padding: 8px 0; text-align: left; width: 100%;">
            <div style="font-size: 16pt; text-decoration: underline;">Corridor:</div>
            <div id="rptLineName" style="font-size: 20pt; font-weight: 900;">--</div>
        </div>

        <div id="sectionStationDetails" style="width: 100%;">
            <div style="background: #000 !important; color: #fff !important; padding: 6px; font-weight: 900; font-size: 18pt; margin-top: 15px; text-transform: uppercase; text-align: center; -webkit-print-color-adjust: exact;">
                A. YELLOW LINE COMPLIANCE
            </div>
            
            <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
                <span style="font-size: 16pt;">Platform Length:</span><br>
                <span id="rptLen" style="font-size: 20pt; font-weight: 900;">--</span>
            </div>
            
            <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
                <span style="font-size: 16pt;">YL Distance:</span><br>
                <span id="rptYl" style="font-size: 20pt; font-weight: 900;">--</span>
            </div>
            
            <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
                <span style="font-size: 16pt;">YL Thickness:</span><br>
                <span id="rptTh" style="font-size: 20pt; font-weight: 900;">--</span>
            </div>

            <div style="border-bottom: 2pt solid #000; padding: 6px 0;">
                <span style="font-size: 16pt;">Compliance Status:</span><br>
                <span id="rptStatus" style="font-size: 20pt; font-weight: 900;">--</span>
            </div>

            <div style="border-bottom: 4pt solid #000; padding: 6px 0;">
                <span style="font-size: 16pt;">Inspector:</span><br>
                <span id="rptUser" style="font-size: 20pt; font-weight: 900;">--</span>
            </div>

            <div style="text-align: left; margin-top: 15px; width: 100%;">
                <div style="font-size: 16pt; text-decoration: underline; font-weight: 900;">Remarks:</div>
                <div id="rptRem" style="padding: 5px 0; font-size: 16pt; font-weight: 900; line-height: 1.2; word-wrap: break-word;">--</div>
            </div>
        </div>

        <div id="sectionRakeData" style="display:none;"><table style="width: 100%;"><tbody id="rptRakeBody"></tbody></table></div>

        <div class="report-footer" style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-start; width: 100%; gap: 10px;">
            <div style="width: 48%; text-align: center; display: flex; flex-direction: column;">
                <div style="border-top: 3pt solid #000 !important; width: 100%; margin-bottom: 5px; -webkit-print-color-adjust: exact;"></div>
                <div id="rptSigInspectorName" style="font-weight: 900; font-size: 11pt; word-wrap: break-word;">--</div>
                <div style="font-size: 8pt; font-weight: 900; text-transform: uppercase;">CONDUCTING OFFICER</div>
            </div>
            <div style="width: 48%; text-align: center; display: flex; flex-direction: column;">
                <div style="border-top: 3pt solid #000 !important; width: 100%; margin-bottom: 5px; -webkit-print-color-adjust: exact;"></div>
                <div id="rptSigAuthName" style="font-weight: 900; font-size: 11pt; word-wrap: break-word;">--</div>
                <div style="font-size: 8pt; font-weight: 900; text-transform: uppercase;">APPROVING AUTHORITY</div>
            </div>
        </div>
        <div style="margin-top: 30px; font-size: 9pt; text-align: center;">[SYSTEM GENERATED RECORD]</div>
    </div>
</div>
  <div id="tab-warranty" class="hidden">
    <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; padding: 10px; background: #e2e8f0; border-radius: 6px;">
    <button onclick="toggleWarMode('dash')" class="info"><i class="fas fa-chart-line"></i> Dashboard</button>
    <button onclick="toggleWarMode('setup')" class="secondary"><i class="fas fa-tools"></i> Warranty Setup</button>
    <button onclick="toggleWarMode('sales')" class="info" style="background:#6366f1; border:none;"><i class="fas fa-receipt"></i> Sales History</button>
    <button onclick="toggleWarMode('claim')" class="warning"><i class="fas fa-qrcode"></i> Scan & Claim</button>
    <button onclick="toggleWarMode('active')" class="success"><i class="fas fa-clipboard-list"></i> Active Coverage</button>
</div>

    <div id="war-dash" class="panel">
        <h3 style="color:var(--metro-blue); border-bottom: 2px solid var(--metro-gold);"><i class="fas fa-tachometer-alt"></i> Warranty Overview</h3>
        <div class="finance-dashboard">
            <div class="fin-card balance" style="border-left-color: #0284c7;">
                <h4>Total Assets</h4>
                <div class="amount" id="warTotalAssets">0</div>
                <i class="fas fa-boxes-stacked"></i>
            </div>
            <div class="fin-card income">
                <h4>Protected Assets</h4>
                <div class="amount" id="warProtected">0</div>
                <i class="fas fa-shield-check"></i>
            </div>
            <div class="fin-card expense">
                <h4>Claims Pending</h4>
                <div class="amount" id="warPending">0</div>
                <i class="fas fa-file-invoice"></i>
            </div>
        </div>
    </div>

    <div id="war-setup" class="panel hidden">
    <h3><i class="fas fa-plus-circle"></i> Configure Asset Warranty</h3>
    <div style="background:#f1f5f9; padding:20px; border-radius:8px; margin-bottom:20px; border-left: 5px solid var(--metro-blue);">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; align-items:end;">
        <div>
            <label style="font-size:11px; font-weight:bold;">1. ASSET TAG ID</label>
            <input id="warSetupTag" placeholder="Scan or Type Tag...">
        </div>
        <div>
            <label style="font-size:11px; font-weight:bold;">PRODUCT CATEGORY</label>
            <select id="warProductType" onchange="toggleWarrantyFields()">
                <option value="WARRANTY">WARRANTY PRODUCT</option>
                <option value="NON-WARRANTY">NON-WARRANTY PRODUCT</option>
            </select>
        </div>
        <div id="divWarTenure">
            <label style="font-size:11px; font-weight:bold;">2. TENURE VALUE</label>
            <input type="number" id="warDuration" placeholder="e.g. 12">
        </div>
        <div id="divWarUnit">
            <label style="font-size:11px; font-weight:bold;">3. UNIT</label>
            <select id="warUnit">
                <option value="Months">Months</option>
                <option value="Years">Years</option>
            </select>
        </div>
        <div id="divWarDate">
            <label style="font-size:11px; font-weight:bold; color:var(--metro-red);">4. START DATE</label>
            <input type="date" id="warStartDate" style="border: 2px solid var(--metro-red); font-weight: bold; height:45px; padding:10px;">
        </div>
        <button class="success" onclick="saveWarrantyConfig()" style="height:45px; font-weight: 900;">UPDATE SYSTEM</button>
    </div>
</div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr><th>Tag ID</th><th>Item Name</th><th>Commencement</th><th>Standard Tenure</th><th>Action</th></tr>
            </thead>
            <tbody id="warSetupTableBody"></tbody>
        </table>
    </div>
</div>

    <div id="war-claim" class="panel hidden" style="border-top: 5px solid var(--metro-red);">
        <h3 style="color:var(--metro-red);"><i class="fas fa-magnifying-glass"></i> Verification & Claim Engine</h3>
        <div style="text-align:center; padding:30px; background:#fff1f2; border: 2px dashed #f87171; border-radius:12px;">
            <p>Scan Product Tag to fetch Sales History & Warranty Status</p>
            <button onclick="openBarcodeScanner('WARRANTY_CLAIM')" class="danger" style="padding:15px 40px; font-size:16px;">
                <i class="fas fa-qrcode"></i> INITIATE SCAN
            </button>
        </div>

        <div id="claimDisplay" class="hidden" style="margin-top:25px; background:white; border:2px solid #ddd; border-radius:8px; overflow:hidden;">
            <div style="background:var(--metro-blue); color:white; padding:15px; font-weight:bold;">SALE HISTORY RETRIEVED</div>
            <div style="padding:20px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="border-right: 1px solid #eee;">
                    <label style="font-size:10px; color:#64748b; text-transform:uppercase;">Asset Name</label>
                    <div id="claimItemName" style="font-size:18px; font-weight:bold;">--</div>
                    <label style="font-size:10px; color:#64748b; text-transform:uppercase; margin-top:15px; display:block;">Invoice Number</label>
                    <div id="claimInv" style="font-family:monospace; font-weight:bold;">--</div>
                </div>
                <div>
                    <label style="font-size:10px; color:#64748b; text-transform:uppercase;">Sold To (Site)</label>
                    <div id="claimSite" style="color:var(--metro-red); font-weight:bold;">--</div>
                    <label style="font-size:10px; color:#64748b; text-transform:uppercase; margin-top:15px; display:block;">Sale Date</label>
                    <div id="claimDate" style="font-weight:bold;">--</div>
                </div>
            </div>
            <div id="claimStatusBox" style="padding:15px; text-align:center; font-weight:bold; font-size:20px;">
                Checking Warranty...
            </div>
            <div style="padding:20px; border-top:1px solid #eee;">
                <label style="font-size:11px; font-weight:bold;">Claim Description / Issue:</label>
                <textarea id="claimIssue" rows="3" placeholder="Describe the hardware fault..."></textarea>
                <button id="btnFinalClaim" class="danger" style="width:100%; padding:15px; margin-top:10px;" onclick="submitWarrantyClaim()">LODGE OFFICIAL CLAIM</button>
            </div>
        </div>
    </div>

    <div id="war-active" class="panel hidden">
        <h3><i class="fas fa-shield-check"></i> Active Protection List</h3>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>Tag</th><th>Item</th><th>Site</th><th>Expiry Date</th><th>Status</th></tr>
                </thead>
                <tbody id="warActiveTableBody"></tbody>
            </table>
        </div>
    </div>
    <div id="war-sales" class="panel hidden">
    <h3><i class="fas fa-history"></i> Logged Sales & Dispatches</h3>
    <p style="font-size:11px; color:#666;">Click on an Invoice Number to generate a Customer Warranty Support Copy.</p>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr><th>Invoice #</th><th>Sold To (Station)</th><th>Sale Date</th><th>Items</th><th>Action</th></tr>
            </thead>
            <tbody id="warSalesTableBody"></tbody>
        </table>
    </div>
</div>

<div id="war-active" class="panel hidden">
    <h3><i class="fas fa-shield-check"></i> Master Protection List</h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Tag</th>
                    <th>Item</th>
                    <th>Starts From</th>
                    <th>Expiry Date</th>
                    <th>Days Left</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="warActiveTableBody"></tbody>
        </table>
    </div>
</div>
</div>
</section>
<script type="module">
// --- FIREBASE IMPORTS (Standard Stable Version) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
// --- NEW: FINANCE LOGIC ---
window.toggleFundMode = () => {
    const mode = document.getElementById("fundMode").value;
    const inp = document.getElementById("fundModeOther");
    if(mode === 'Other') {
        inp.classList.remove('hidden');
        inp.focus();
    } else {
        inp.classList.add('hidden');
        inp.value = ""; 
    }
};

window.submitFund = async () => {
    if(!isAdmin) return alert("Admin Only");
    
    const amt = document.getElementById("fundAmount").value;
    const src = document.getElementById("fundSource").value;
    let mode = document.getElementById("fundMode").value;
    const status = document.getElementById("fundStatus").value;
    const editKey = document.getElementById("editFundKey").value; // Get Edit Key

    // Handle 'Other' Input
    if(mode === 'Other') {
        const otherVal = document.getElementById("fundModeOther").value.trim();
        if(!otherVal) return alert("Please specify the payment mode.");
        mode = otherVal;
    }

    if(!amt || !src) return alert("Please fill Amount & Source");
    
    const fundData = {
        type: "CREDIT", 
        amount: parseFloat(amt), 
        desc: src,
        mode: mode,
        status: status,
        by: currentUser.email,
        timestamp: serverTimestamp()
    };

    try {
        if(editKey) {
            // --- UPDATE EXISTING ---
            await update(ref(db, `finance/${editKey}`), fundData);
            alert("Fund Entry Updated!");
        } else {
            // --- CREATE NEW ---
            await push(ref(db, "finance"), fundData);
            alert("Fund Added Successfully!"); 
        }
        cancelFundEdit(); // Reset Form
        
    } catch(e) { alert(e.message); }
};
// --- SUBMIT OTHER EXPENSE (With Custom Date) ---
window.submitExpense = async () => {
    const desc = document.getElementById("expDesc").value;
    const amount = document.getElementById("expAmount").value;
    const billUrl = document.getElementById("expBillUrl").value;
    const dateVal = document.getElementById("expDate").value; // NEW
    const key = document.getElementById("editExpenseKey").value;

    if(!desc || !amount) return alert("Description and Amount are required.");
    if(!billUrl) return alert("‚ö† STOP: Bill/Drive Link is REQUIRED.");
    if(!dateVal) return alert("‚ö† Please select the Date of Expense.");

    // Convert selected date string (YYYY-MM-DD) to Timestamp
    // We append T12:00:00 to prevent timezone shifts changing the day
    const finalTimestamp = new Date(dateVal + "T12:00:00").getTime();

    const status = isAdmin ? "Approved" : "Pending";

    const data = {
        type: "EXPENSE", 
        desc: desc,
        amount: parseFloat(amount),
        billUrl: billUrl,
        mode: "Cash/Misc",
        status: status,
        by: currentUser.email,
        timestamp: finalTimestamp // Use Custom Date
    };

    try {
        if(key) {
            await update(ref(db, `finance/${key}`), data);
            alert("Expense Updated!");
        } else {
            await push(ref(db, "finance"), data);
            alert(isAdmin ? "Expense Added & Deducted." : "Expense Request Sent.");
        }
        cancelExpEdit();
    } catch(e) { alert(e.message); }
};

window.editExpense = async (key) => {
    const snap = await get(ref(db, `finance/${key}`));
    const d = snap.val();
    
    document.getElementById("expDesc").value = d.desc;
    document.getElementById("expAmount").value = d.amount;
    document.getElementById("expBillUrl").value = d.billUrl || "";
    
    // Convert Timestamp back to YYYY-MM-DD for the input
    if(d.timestamp) {
        const dateObj = new Date(d.timestamp);
        const yyyy = dateObj.getFullYear();
        const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
        const dd = String(dateObj.getDate()).padStart(2, '0');
        document.getElementById("expDate").value = `${yyyy}-${mm}-${dd}`;
    }

    document.getElementById("editExpenseKey").value = key;
    document.getElementById("btnExpSubmit").innerText = "UPDATE EXPENSE";
    document.getElementById("btnExpCancel").classList.remove("hidden");
    document.getElementById("expenseFormPanel").scrollIntoView({behavior:"smooth"});
};

window.cancelExpEdit = () => {
    document.getElementById("expDesc").value = "";
    document.getElementById("expAmount").value = "";
    document.getElementById("expBillUrl").value = "";
    document.getElementById("expDate").value = ""; // Clear Date
    document.getElementById("editExpenseKey").value = "";
    document.getElementById("btnExpSubmit").innerText = "SUBMIT EXPENSE";
    document.getElementById("btnExpCancel").classList.add("hidden");
};
// --- NEW: EDIT & DELETE FUNCTIONS FOR FUNDS ---
window.editFund = async (key) => {
    const snap = await get(ref(db, `finance/${key}`));
    const val = snap.val();
    
    document.getElementById("fundAmount").value = val.amount;
    document.getElementById("fundSource").value = val.desc;
    document.getElementById("fundStatus").value = val.status;
    
    // Handle Mode
    const defaultModes = ["NEFT/RTGS", "Cheque", "Cash", "UPI"];
    if(defaultModes.includes(val.mode)) {
        document.getElementById("fundMode").value = val.mode;
        document.getElementById("fundModeOther").classList.add("hidden");
    } else {
        document.getElementById("fundMode").value = "Other";
        document.getElementById("fundModeOther").classList.remove("hidden");
        document.getElementById("fundModeOther").value = val.mode;
    }

    // UI Changes
    document.getElementById("editFundKey").value = key;
    document.getElementById("btnFundSubmit").innerText = "UPDATE ENTRY";
    document.getElementById("btnFundSubmit").classList.replace("success", "warning");
    document.getElementById("btnFundCancel").classList.remove("hidden");
    document.getElementById("adminFundPanel").scrollIntoView({behavior: "smooth"});
};

window.deleteFund = async (key) => {
    if(confirm("‚ö† PERMANENTLY DELETE this fund entry?\n\nThis will affect the Balance Sheet calculation.")) {
        await remove(ref(db, `finance/${key}`));
    }
};

window.cancelFundEdit = () => {
    document.getElementById("fundAmount").value = "";
    document.getElementById("fundSource").value = "";
    document.getElementById("fundMode").value = "NEFT/RTGS";
    document.getElementById("fundStatus").value = "Approved";
    document.getElementById("fundModeOther").classList.add("hidden");
    
    document.getElementById("editFundKey").value = "";
    document.getElementById("btnFundSubmit").innerText = "CREDIT FUND";
    document.getElementById("btnFundSubmit").classList.replace("warning", "success");
    document.getElementById("btnFundCancel").classList.add("hidden");
};
window.calcPurTotal = () => {
    const p = document.getElementById("purPrice").value || 0;
    const q = document.getElementById("purQty").value || 0;
    document.getElementById("purTotal").value = (p*q).toFixed(2);
};
window.submitPurchase = async () => {
    const item = document.getElementById("purItem").value;
    const price = document.getElementById("purPrice").value;
    const qty = document.getElementById("purQty").value;
    const total = document.getElementById("purTotal").value;
    const billUrl = document.getElementById("purBillUrl").value; // New Field
    const key = document.getElementById("editPurchaseKey").value;
    
    if(!item || !total) return alert("Please fill details");
    
    // STRICT VALIDATION: Bill is required
    if(!billUrl) return alert("‚ö† STOP: Bill/Drive Link is REQUIRED for purchases.\n\n(If bill is pending, please type 'Pending' in the link box to proceed).");

    const status = isAdmin ? "Approved" : "Pending";

    const data = {
        type: "DEBIT", 
        productName: item, 
        platform: document.getElementById("purPlatform").value,
        orderId: document.getElementById("purOrderId").value, 
        unitPrice: price, 
        qty: qty,
        amount: parseFloat(total), 
        desc: `Purchase: ${item}`, 
        billUrl: billUrl, // Save Link
        status: status,
        by: currentUser.email,
        timestamp: serverTimestamp()
    };
    
    try {
        if(key) { 
            await update(ref(db, `finance/${key}`), data); 
            alert("Purchase Entry Updated!"); 
        } else { 
            await push(ref(db, "finance"), data); 
            alert(isAdmin ? "Purchase Saved." : "Purchase Request Sent.");
        }
        clearPurForm();
    } catch(e) { alert(e.message); }
};
window.editPurchase = async (key) => {
    const snap = await get(ref(db, `finance/${key}`));
    const d = snap.val();
    document.getElementById("purItem").value = d.productName;
    document.getElementById("purPlatform").value = d.platform;
    document.getElementById("purOrderId").value = d.orderId;
    document.getElementById("purPrice").value = d.unitPrice;
    document.getElementById("purQty").value = d.qty;
    document.getElementById("purTotal").value = d.amount;
    
    // NEW FIELD
    document.getElementById("purBillUrl").value = d.billUrl || "";

    document.getElementById("editPurchaseKey").value = key;
    document.getElementById("btnPurSubmit").innerText = "UPDATE ENTRY";
    switchTab('purchase');
};

window.clearPurForm = () => {
    document.getElementById("purItem").value = ""; 
    document.getElementById("purPrice").value = "";
    document.getElementById("purQty").value = ""; 
    document.getElementById("purTotal").value = "";
    document.getElementById("purBillUrl").value = ""; // Clear new field
    document.getElementById("editPurchaseKey").value = "";
    document.getElementById("btnPurSubmit").innerText = "SAVE & DEDUCT FUND";
};
window.loadFinanceData = () => {
    // 1. Show Admin Panel
    if(isAdmin) {
        const panel = document.getElementById("adminFundPanel");
        if(panel) panel.classList.remove("hidden");
    }
    
    const tbody = document.getElementById("fundTableBody");
    if(!tbody) return;

    // 2. Setup Headers (CHANGED: 'Mode/Bill' -> 'Bill (Proof)')
    const theadRow = document.querySelector("#tab-funds thead tr");
    if(theadRow) {
        let headerHTML = `<th>Date</th><th>Type</th><th>Description</th><th>Bill (Proof)</th><th>Credit (+)</th><th>Debit (-)</th>`;
        if(isAdmin) headerHTML += `<th>Action</th>`;
        theadRow.innerHTML = headerHTML;
    }

    // 3. Clear Old Listener
    if(window.financeListener) { try{ off(ref(db, "finance")); }catch(e){} }

    // 4. Start New Listener
    window.financeListener = onValue(ref(db, "finance"), (snap) => {
        try {
            tbody.innerHTML = ""; 
            
            let totalCredit = 0;
            let totalDebit = 0;
            const txs = [];

            if(!snap.exists()) {
                tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;'>No records found.</td></tr>";
                updateDashboard(0, 0);
                return;
            }

            snap.forEach(c => {
                const val = c.val();
                if(val) txs.push({ key: c.key, ...val });
            });
            
            // Sort: Newest First
            txs.sort((a,b) => {
                const tA = a.timestamp || Date.now();
                const tB = b.timestamp || Date.now();
                return tB - tA;
            });

            txs.forEach(t => {
                const currentStatus = t.status || 'Approved';
                const isCredit = t.type === 'CREDIT';
                
                // Visibility Logic
                const isDebitOrExp = (t.type === 'DEBIT' || t.type === 'EXPENSE');
                if (isDebitOrExp && currentStatus !== 'Approved') return;

                let amount = parseFloat(t.amount);
                if(isNaN(amount)) amount = 0;
                
                // Balance Logic
                if(isCredit) {
                    if(currentStatus === 'Approved') totalCredit += amount;
                } else {
                    totalDebit += amount;
                }

                // Formatting
                let dateStr = t.timestamp ? new Date(t.timestamp).toLocaleDateString() : "Legacy";
                let colorClass = 'color:black';
                if(isCredit) colorClass = 'color:green';
                if(isDebitOrExp) colorClass = 'color:red';

                const desc = t.desc || t.productName || "-";
                
                // --- NEW: BILL COLUMN LOGIC (Replaces Mode) ---
                let billDisplay = `<span style="color:#ccc;">-</span>`;
                
                if(t.billUrl && t.billUrl.trim() !== "") {
                    // If it is a web link (http/https)
                    if(t.billUrl.startsWith("http")) {
                        billDisplay = `
                            <a href="${t.billUrl}" target="_blank" style="
                                background: #e0f2fe; 
                                color: #0284c7; 
                                border: 1px solid #7dd3fc; 
                                padding: 4px 8px; 
                                border-radius: 4px; 
                                text-decoration: none; 
                                font-weight: bold; 
                                font-size: 10px;
                                display: inline-flex;
                                align-items: center;
                                gap: 4px;">
                                <i class="fas fa-external-link-alt"></i> View Drive
                            </a>`;
                    } else {
                        // If it's text like "Pending"
                        billDisplay = `<span style="font-size:11px; color:orange; font-weight:bold;">${t.billUrl}</span>`;
                    }
                }

                // Action Buttons
                let actionButtons = "";
                if(isAdmin) {
                    let editFunc = `editFund('${t.key}')`;
                    if(t.type === 'EXPENSE') editFunc = `editExpense('${t.key}')`;
                    
                    if(t.type === 'DEBIT') {
                        actionButtons = `<td><small>Edit in Procurement</small></td>`;
                    } else {
                        actionButtons = `<td>
                            <button onclick="${editFunc}" class="warning" style="padding:2px 5px; font-size:10px; color:white; background:#d97706; margin-right:3px;">‚úè</button>
                            <button onclick="deleteFund('${t.key}')" class="danger" style="padding:2px 5px; font-size:10px; color:white; background:#B91C1C;">üóë</button>
                        </td>`;
                    }
                }

                const row = `
                    <tr>
                        <td style="font-size:11px;">${dateStr}</td>
                        <td style="font-weight:bold; ${colorClass}">${t.type}</td>
                        <td style="font-size:12px;">${desc}</td>
                        
                        <td style="text-align:center;">${billDisplay}</td>
                        
                        <td style="color:green; text-align:right;">${isCredit ? '‚Çπ'+amount.toFixed(2) : '-'}</td>
                        <td style="color:red; text-align:right;">${!isCredit ? '‚Çπ'+amount.toFixed(2) : '-'}</td>
                        ${actionButtons}
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            updateDashboard(totalCredit, totalDebit);

        } catch (globalErr) { console.error(globalErr); }
    });
};
// Helper to update the top cards
function updateDashboard(credit, debit) {
    const balance = credit - debit;
    document.getElementById("dispTotalCredit").innerText = `‚Çπ ${credit.toLocaleString('en-IN')}`;
    document.getElementById("dispTotalDebit").innerText = `‚Çπ ${debit.toLocaleString('en-IN')}`;
    document.getElementById("dispBalance").innerText = `‚Çπ ${balance.toLocaleString('en-IN')}`;

    const healthEl = document.getElementById("budgetHealthText");
    const ratio = credit > 0 ? (balance / credit) * 100 : 0;
    
    // LOGIC UPDATE:
    // 1. Critical if less than 20% of funds remain
    // 2. Tight Budget if Balance is strictly BELOW 2000 (regardless of percentage)
    if(ratio < 20) { 
        healthEl.innerText = "‚ö† Critical Low"; 
        healthEl.style.color = "red"; 
    }
    else if(balance < 2000) { 
        healthEl.innerText = "‚ö† Tight Budget"; 
        healthEl.style.color = "orange"; 
    }
    else { 
        healthEl.innerText = "‚úÖ Healthy"; 
        healthEl.style.color = "green"; 
    }
}
// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

// --- INITIALIZE ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
let isSwitching = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project", "hodee@metro.project", "hodcseaiml@metro.project", "hodeee@metro.project", "arijita@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];
let modelsLoaded = false;
let isTransactionAuth = false;
let currentTransactionType = "";
// --- GLOBAL LISTENER TRACKERS (PREVENTS CROSSTALK) ---
     // For Field Inspection (Rake Table)
let galleryListener = null;   // For Compliance Docs (Gallery Grid)
let logViewListener = null;   // For Master Log Database (Data View Table)
let printListener = null;     // For Print Report List
let scanMode = 'LOGIN';

let receiverVerified = false;

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null; // Stores details of scanned item for Checkout/Return// --- GLOBAL STATE TRACKERS ---
let scanner = null;
let existingItemKey = null; // To track if we are updating existing stock

// --- SIGNATURE PAD LOGIC (UPDATED FOR MOBILE) ---
function setupCanvas(id) {
    const canvas = document.getElementById(id);
    if (!canvas) return; // Safety check

    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 3;       // Thicker line for better visibility on mobile
    ctx.lineCap = 'round';   // Smooth edges
    ctx.strokeStyle = '#000000';

    let isDrawing = false;

    // 1. FORCE DISABLE SCROLLING ON CANVAS via JS
    canvas.style.touchAction = 'none';

    // Helper to get exact coordinates
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        // Calculate scaling (vital if CSS shrinks the canvas)
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    // --- POINTER EVENTS (Handles Mouse + Touch automatically) ---

    // Start Drawing
    canvas.addEventListener('pointerdown', (e) => {
        isDrawing = true;
        canvas.setPointerCapture(e.pointerId); // LOCKS pointer to canvas so you can't scroll away
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
    });

    // Draw Line
    canvas.addEventListener('pointermove', (e) => {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
    });

    // Stop Drawing
    canvas.addEventListener('pointerup', (e) => {
        isDrawing = false;
        canvas.releasePointerCapture(e.pointerId);
    });

    // Cancel (e.g. finger slides off screen edge)
    canvas.addEventListener('pointercancel', () => {
        isDrawing = false;
    });
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}
// A. HARD RESET FOR INPUT FORM
function resetInputForm() {
    // 1. Cut the Connection
    if (rowListener) { off(ref(db), rowListener); rowListener = null; }

    // 2. Wipe Variables
    rtStationKey = null;
    rtRakeKey = null;

    // 3. Wipe UI Inputs
    const inputs = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) { el.value = ""; el.oninput = null; el.onchange = null; } // Detach events
    });

    // 4. Wipe Table
    document.getElementById("distanceBody").innerHTML = "";
    
    // 5. Reset Buttons
    document.getElementById("btnFinalSubmit").innerText = "Loading...";
    document.getElementById("btnFinalSubmit").disabled = true;
}
window.handleGalleryLineChange = () => {
    const lineSel = document.getElementById("galleryLineSelect");
    const stnSel = document.getElementById("galleryStationSelect");
    const uploadSection = document.getElementById("galleryUploadSection");
    
    // 1. Reset Station Dropdown
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;

    // 2. Hide Upload Section (Safety)
    if(uploadSection) uploadSection.classList.add("hidden");

    // 3. Populate Stations based on Line
    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        
        stnSel.disabled = false;
        stnSel.style.background = "#fff";
    }
};
window.handleGalleryStationChange = () => {
    const line = document.getElementById("galleryLineSelect").value;
    const stn = document.getElementById("galleryStationSelect").value;
    const galleryDiv = document.getElementById("galleryContainer");
    const uploadSection = document.getElementById("galleryUploadSection");
    const targetText = document.getElementById("uploadTargetText");

    // 1. CLEANUP OLD LISTENER (Stops Duplicates)
    if (galleryListener) {
        if(typeof galleryListener === "function") galleryListener();
        else try { off(ref(db, "history"), galleryListener); } catch(e) {}
        galleryListener = null;
    }

    // 2. RESET UI
    galleryDiv.innerHTML = ""; 
    
    if (!line || !stn) {
        if(uploadSection) uploadSection.classList.add("hidden");
        return;
    }

    if(uploadSection) uploadSection.classList.remove("hidden");
    if(targetText) targetText.innerText = `Target: ${stn} (${line})`;

    galleryDiv.innerHTML = `<p style="text-align:center; width:100%; color:#666;">Loading evidence...</p>`;

    // 3. LIVE DATABASE QUERY
    const targetName = `${stn} (${line})`;
    const q = query(ref(db, "history"), orderByChild("stationName"), equalTo(targetName));
    
    galleryListener = onValue(q, (snap) => {
        galleryDiv.innerHTML = "";
        
        if (!snap.exists()) {
            galleryDiv.innerHTML = `<p style="text-align:center; color:#94a3b8; width:100%; padding:20px;">No documents found for this station.</p>`;
            return;
        }

        snap.forEach(c => {
            const v = c.val();
            // --- SMART FORMAT DETECTION (Fixes 'Unsupported') ---
            const fileName = (v.name || "").toLowerCase();
            const fileType = (v.fileType || "").toLowerCase();
            
            let isImage = fileType.includes("image") || fileName.endsWith("jpg") || fileName.endsWith("jpeg") || fileName.endsWith("png");
            let isPdf = fileType.includes("pdf") || fileName.endsWith("pdf");

            let media = "";
            
            if (isImage) {
                // SHOW IMAGE PREVIEW
                media = `<img src="${v.fileData}" onclick="window.open('${v.fileData}', '_blank')" 
                         style="cursor:pointer; width:100%; height:140px; object-fit:cover; border-radius:4px; border:1px solid #eee;">`;
            } 
            else if (isPdf) {
                // SHOW PDF ICON
                media = `<div onclick="window.open('${v.fileData}', '_blank')" 
                         style="cursor:pointer; height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#fff1f2; color:#be123c; border-radius:4px; border:1px solid #fecdd3;">
                            <i class="fas fa-file-pdf" style="font-size:40px; margin-bottom:10px;"></i>
                            <span style="font-size:11px; font-weight:bold;">OPEN PDF</span>
                         </div>`;
            } 
            else {
                // GENERIC FILE
                media = `<div style="padding:20px; color:#666; background:#f1f5f9; border-radius:4px; text-align:center;">
                            <i class="fas fa-file-alt"></i><br>File
                         </div>`;
            }
            
            // --- ADMIN CONTROLS ---
            let controls = "";
            if(isAdmin) {
                controls = `
                <div style="margin-top:8px; display:flex; gap:5px;">
                    <a href="${v.fileData}" download="${v.name || 'evidence'}" class="info" style="flex:1; text-decoration:none; padding:6px; font-size:11px; text-align:center; border-radius:4px; background:#0ea5e9; color:white;">
                        <i class="fas fa-download"></i> Save
                    </a>
                    <button class="danger" onclick="removeFile('${c.key}')" style="padding:6px 10px; font-size:11px; border-radius:4px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>`;
            } else {
                controls = `<div style="margin-top:5px; font-size:10px; color:#cbd5e1; text-align:center;">View Only</div>`;
            }

            // --- RENDER CARD ---
            const card = `
            <div class="gallery-item" style="display:flex; flex-direction:column; justify-content:space-between; background:white; padding:10px; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <div style="margin-bottom:5px;">
                    ${media}
                    <div style="font-size:12px; margin-top:8px; font-weight:bold; color:#334155; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${v.name}">${v.name || 'Evidence'}</div>
                    <div style="font-size:10px; color:#94a3b8;">By: ${v.userName}</div>
                </div>
                ${controls}
            </div>`;
            
            galleryDiv.innerHTML += card;
        });
    });
};
// --- NEW HELPER: Signature Modal ---
window.viewSignature = (sigData) => {
    document.getElementById("modalSigImage").src = sigData;
    document.getElementById("sigModal").classList.remove("hidden");
};
window.closeSigModal = () => document.getElementById("sigModal").classList.add("hidden");

// --- NEW BARCODE LOGIC ---
window.openBarcodeScanner = (mode) => {
    scanMode = mode;
    document.getElementById("barcodeModal").classList.remove("hidden");
    
    // START SCANNER
    if(!scanner) {
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess, onScanFailure);
    }
}
// ==========================================
// 1. ADMIN PANEL (With Unban Logic)
// ==========================================
let adminListener = null;

// B. Save Field Real-Time Helper
window.saveFieldRealTime = (id) => {
    if(!rtStationKey) return;
    
    const map = {
        "inpStationLength": "len",
        "inpYellowDist": "yl",
        "inpYellowThick": "th",
        "inpRemarks": "remarks",
        "inpImplementation": "impl"
    };

    const dbField = map[id];
    const val = document.getElementById(id).value;

    // Update Master Log Directly
    update(ref(db, `station_logs/${rtStationKey}`), {
        [dbField]: val,
        last_modified: serverTimestamp() // Audit trail
    });
};

// C. Load Rows from Rake Logs (Master)
let rowListener = null;
function loadRealTimeRows() {
    if(rowListener) { off(ref(db), rowListener); rowListener = null; } // Cleanup

    const tbody = document.getElementById("distanceBody");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Syncing...</td></tr>";

    const rowsRef = ref(db, `rake_logs/${rtRakeKey}`);
    
    // Real-time listener on the MASTER LOG rake node
    rowListener = onValue(rowsRef, (snap) => {
        tbody.innerHTML = "";
        if(!snap.exists()) return;

        let i = 1;
        snap.forEach(c => {
            const rowKey = c.key;
            const v = c.val();
            renderRealTimeRow(rowKey, v, i++);
        });
    });
}

// D. Render Row (With Direct Master Log Bindings)
function renderRealTimeRow(key, v, index) {
    const tbody = document.getElementById("distanceBody");
    const isSel = (val) => (v.type === val ? "selected" : "");

    // Note the function calls: upRowRealTime and delRowRealTime
    const html = `
        <tr>
            <td style="text-align:center; font-weight:bold;">${index}</td>
            <td>
                <input style="width:100%" value="${v.rake || ''}" 
                 oninput="upRowRealTime('${key}','rake',this.value)" placeholder="Rake ID">
            </td>
            <td>
                <select style="width:100%; padding:5px;" onchange="upRowRealTime('${key}','type',this.value)">
                    <option value="" ${isSel("")}>-- Select --</option>
                    <option value="BHEL RAKE" ${isSel("BHEL RAKE")}>BHEL RAKE</option>
                    <option value="MEDHA RAKE" ${isSel("MEDHA RAKE")}>MEDHA RAKE</option>
                    <option value="DALIAN RAKE" ${isSel("DALIAN RAKE")}>DALIAN RAKE</option>
                </select>
            </td>
            <td><input style="width:100%" value="${v.f || ''}" oninput="upRowRealTime('${key}','f',this.value)" placeholder="Front"></td>
            <td><input style="width:100%" value="${v.r || ''}" oninput="upRowRealTime('${key}','r',this.value)" placeholder="Rear"></td>
            <td style="text-align:center;">
                <button class="danger" onclick="delRowRealTime('${key}')">X</button>
            </td>
        </tr>`;
    tbody.innerHTML += html;
}
// Updated Row Edit Function
window.upRow = (k, f, v) => {
    // üõë SAFETY LOCK: If we are switching, ignore this old event
    if (isSwitching) {
        console.warn("Blocked ghost write during switch.");
        return;
    }
    update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), { [f]: v });
};

// Updated Add Row Function
window.addDistanceRow = () => {
    if (isSwitching) return; // üõë Block add during switch
    push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });
};

// Updated Delete Row Function
window.delRow = (k) => {
    if (isSwitching) return; // üõë Block delete during switch
    remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
};
window.upRowRealTime = (rowKey, field, val) => {
    update(ref(db, `rake_logs/${rtRakeKey}/${rowKey}`), { [field]: val });
};

window.delRowRealTime = (rowKey) => {
    if(confirm("Delete this row permanently?")) {
        remove(ref(db, `rake_logs/${rtRakeKey}/${rowKey}`));
    }
};
window.closeBarcodeScanner = () => {
    document.getElementById("barcodeModal").classList.add("hidden");
    if(scanner) {
        scanner.clear();
        scanner = null;
    }
}
// --- NEW AUDIT LOGIC ---
window.closeAuditModal = () => document.getElementById("auditResultModal").classList.add("hidden");
window.fetchAuditHistory = async (barcode) => {
    if (!barcode) return;

    const modal = document.getElementById("auditResultModal");
    const container = document.getElementById("auditTimelineContainer");
    
    if(modal) modal.classList.remove("hidden");
    document.getElementById("auditModalBarcode").innerText = "Tag ID: " + barcode;

    if(container) container.innerHTML = `<div style="text-align:center; padding:20px;"><i class="fas fa-sync fa-spin"></i> Retrieving Secure Records...</div>`;

    try {
        const snap = await get(ref(db, "logs"));
        if (!snap.exists()) {
            container.innerHTML = `<div style="text-align:center;color:#777;">No history found in database</div>`;
            return;
        }

        let raw = [];
        snap.forEach(c => {
            const v = c.val();
            // Filter logs by the specific barcode scanned
            if (v.barcode === barcode) {
                raw.push(v);
            }
        });

        if (raw.length === 0) {
            container.innerHTML = `<div style="text-align:center;color:#777;padding:20px;">No movement history for Tag: <b>${barcode}</b></div>`;
            return;
        }

        // Sort: Newest movement first
        raw.sort((a, b) => (b.time || 0) - (a.time || 0));

        container.innerHTML = "";
        raw.forEach(l => {
            let cardClass = "add";
            if(l.type === "CHECKOUT") cardClass = "checkout";
            if(l.type === "RETURN" || l.type === "ITEM_RESTOCKED") cardClass = "return";

            const timeStr = new Date(l.time).toLocaleString('en-IN');

            container.innerHTML += `
                <div class="history-card ${cardClass}">
                    <div class="hc-header">
                        <span class="hc-user">üë§ ${l.takenBy || l.by || 'System'}</span>
                        <span style="font-size:10px; font-weight:bold; text-transform:uppercase;">${l.type}</span>
                    </div>
                    <div class="hc-meta">
                        <b>Date:</b> ${timeStr}<br>
                        <b>Site:</b> ${l.assignedStation || l.location || 'N/A'}<br>
                        ${l.reason ? `<b>Reason:</b> ${l.reason}` : ''}
                        ${l.invoice ? `<b>Invoice:</b> ${l.invoice}` : ''}
                    </div>
                </div>
            `;
        });

    } catch (e) {
        console.error(e);
        if(container) container.innerHTML = `<div style="color:red;text-align:center;">Sync Error: ${e.message}</div>`;
    }
};
// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};

// --- 4. DUMMY FUNCTION (To prevent errors if HTML still calls it) ---
// --- REAL-TIME HISTORY LOGIC ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Syncing Live Data...</td></tr>";

    // This listener stays open and updates automatically when DB changes
    const dbRef = getDatabase();
    const q = query(ref(dbRef, "logs"), limitToLast(100));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); // Show newest events at the top

        // Filter: Show only inventory-related events (Checkout, Return, Add)
        const invLogs = logs.filter(l => 
            l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE'
        );

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded recently.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        
        invLogs.forEach(l => {
            // Badge Styling
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            // Barcode formatting
            const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px; letter-spacing:1px;">${l.barcode}</div>` : '';

            // Row HTML
            const row = `
            <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
                <td style="vertical-align:middle;">${barcodeDisplay}</td>
                <td style="font-weight:bold; vertical-align:middle;">${l.takenBy || 'Unknown'}</td>
                <td style="vertical-align:middle;">
                    ${formatTime(l.time)}
                </td>
                <td style="text-align:center; vertical-align:middle;">${badge}</td>
                <td style="vertical-align:middle;">
                    <span style="font-size:13px; font-weight:bold; color:#333;">${l.item}</span><br>
                    <small style="color:#777;">Auth: ${l.approvedBy || 'System'}</small>
                </td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    });
};
window.printReport = (mode) => {
    // 1. Clean previous classes
    document.body.classList.remove('print-a4', 'print-pos');

    // 2. Add class based on selection
    if (mode === 'A4') {
        document.body.classList.add('print-a4');
    } else {
        // POS MODE (Receipt)
        document.body.classList.add('print-pos');
    }

    // 3. Trigger Print Dialog
    setTimeout(() => {
        window.print();
    }, 100); // Small delay to ensure CSS applies
};
// --- FULL FUNCTION: Close Preview Handler ---
window.closeReportPreview = () => {
    const reportContainer = document.getElementById("printableReportContainer");
    if (reportContainer) {
        // 1. Hide it
        reportContainer.classList.add("hidden");
        // 2. Wipe the data so it doesn't show old info next time
        reportContainer.innerHTML = ""; 
    }
    // 3. Remove print classes from body
    document.body.classList.remove('print-a4', 'print-pos');
};
window.onScanSuccess = async function(decodedText) {
    // 1. Force the scanner to stop and clear UI
    closeBarcodeScanner();
    console.log("SCANNED TAG:", decodedText);
    // --- MODE: INVENTORY LIST SEARCH ---
if (scanMode === 'SEARCH_STOCK') {
    const searchInput = document.getElementById("mainStockSearch");
    if(searchInput) {
        searchInput.value = decodedText; // Set the scanned text
        window.filterStockTable();       // MANUALLY trigger the filter logic
    }
    return;
}
// --- MODE: AUDIT TRAIL SEARCH ---
if (scanMode === 'AUDIT_SEARCH') {
    const auditInput = document.getElementById("auditSearchInput");
    if(auditInput) {
        auditInput.value = decodedText;           // Set the scanned text
        window.fetchAuditHistory(decodedText);    // MANUALLY trigger the DB fetch
    }
    return;
}

    // --- MODE: ADD NEW ASSET ---
    if (scanMode === 'ADD') {
        const invInput = document.getElementById("invBarcode");
        if(invInput) {
            invInput.value = decodedText;
            checkBarcodeUnique(decodedText);
        }
        return;
    }

    // --- MODE: BILLING SCAN ---
    if (scanMode === 'BILLING_SCAN') {
        const billInput = document.getElementById("billBarcodeInp");
        if(billInput) {
            billInput.value = decodedText;
            addScannedItemToBill();
        }
        return; 
    }

    // --- MODE: CHECKOUT / RETURN ---
    if (scanMode === 'CHECKOUT' || scanMode === 'RETURN') {
        const isCheckout = scanMode === 'CHECKOUT';
        const displayId = isCheckout ? "checkout_display" : "return_display";
        const nameId    = isCheckout ? "checkout_item_name" : "return_item_name";
        const codeId    = isCheckout ? "checkout_item_code" : "return_item_code";
        const authBtnId = isCheckout ? "btn_checkout_verify" : "btn_return_verify";

        document.getElementById(displayId).classList.remove("hidden");
        document.getElementById(nameId).innerHTML = "üîç Verifying Tag ID...";
        document.getElementById(codeId).innerText = decodedText;

        try {
            const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(decodedText));
            const snap = await get(q);
            if (!snap.exists()) {
                document.getElementById(nameId).innerHTML = `<span style="color:red;">‚ùå Tag Not Registered</span>`;
                return;
            }
            let item = null;
            let itemKey = null;
            snap.forEach(c => { item = c.val(); itemKey = c.key; });

            if(item.status === "Sold Out") {
                document.getElementById(nameId).innerHTML = `<span style="color:red;">‚ùå ITEM SOLD: ${item.assignedStation}</span>`;
                alert("Restricted: This item is sold and cannot be checked out.");
                return;
            }

            pendingTransactionItem = { key: itemKey, ...item };
            document.getElementById(nameId).innerHTML = `‚úî ${item.item}`;
            document.getElementById(authBtnId).style.display = "block";
        } catch (err) { console.error(err); }
    }
};
// --- 4. EMPTY/DUMMY LOAD HISTORY (Prevents errors when clicking tab) ---
window.loadInventoryHistory = () => {
    // Intentionally empty or just focuses the search box
    // Because we removed the table
    setTimeout(() => document.getElementById("auditSearchInput").focus(), 300);
};

// --- 2. UNIFIED SCANNER HANDLER (This replaces your old one) ---


// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};


window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; // Clear input
};
// --- UNIFIED SCANNER HANDLER ---

function onScanFailure(error) {
    // Do nothing, keep scanning
}

// --- INNOVATIVE BARCODE LOGIC: CHECK EXISTENCE ---
// --- NEW LOGIC: PREVENT DUPLICATE BARCODES ---
window.checkBarcodeUnique = async (code) => {
    if(!code) return;
    
    // Reset UI
    document.getElementById("barcodeError").classList.add("hidden");
    document.getElementById("btnAddStock").disabled = false;
    document.getElementById("btnAddStock").innerText = "Save Item to Stock";

    // Query DB to see if barcode exists
    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(code));
    const snap = await get(q);

    if(snap.exists()) {
        // ERROR: DUPLICATE FOUND
        document.getElementById("barcodeError").classList.remove("hidden");
        document.getElementById("btnAddStock").disabled = true;
        document.getElementById("btnAddStock").innerText = "‚õî Duplicate Barcode";
        
        // Optional: Show who has it
        let existingItem = null;
        snap.forEach(c => existingItem = c.val());
        alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
    }
}
// --- HELPER: TOGGLE 'OTHER' INPUT ---
window.toggleOtherInput = () => {
    const val = document.getElementById("returnLocSelect").value;
    const otherDiv = document.getElementById("divOtherLoc");
    
    if(val === "Other") {
        otherDiv.classList.remove("hidden");
        document.getElementById("returnLocOther").focus();
    } else {
        otherDiv.classList.add("hidden");
    }
};
// --- NEW: TRIGGER RECEIVER SCAN ---
window.startReceiverScan = (type) => {
    scanMode = 'RECEIVER';
    currentTransactionType = type; // 'CHECKOUT' or 'RETURN'
    
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "üë§ Receiver Verification";
    document.getElementById("modalDesc").innerText = "Please look at the camera to verify identity.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Verify My Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
    
    // UI Cleanup
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
    
    initCamera(true);
};
// --- 1. LOAD AI MODELS ---
async function preloadModels() {
    if(modelsLoaded) return;
    try {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]);
        modelsLoaded = true;
    } catch(e) { console.error("Model Error", e); }
}
preloadModels();
// ==========================================
// 1. UPDATED LOGIN FUNCTION
// ==========================================
window.login = () => {
    const emailField = document.getElementById("email");
    const passField = document.getElementById("password");
    const btn = document.querySelector("#loginSection button");
    
    if(!emailField.value || !passField.value) return alert("Please enter credentials.");

    btn.innerText = "üîÑ Verifying credentials...";
    btn.disabled = true;

    signInWithEmailAndPassword(auth, emailField.value, passField.value)
    .then(async (userCredential) => {
        const user = userCredential.user;
        const userSnap = await get(ref(db, `users/${user.uid}`));
        const u = userSnap.val();

        if (u && u.banned) {
            alert("Access Denied: Account Suspended.");
            signOut(auth);
            return;
        }

        // --- THE FIX: TRIGGER UI SEQUENTIALLY ---
        // 1. Hide Login Screen
        document.getElementById("loginSection").classList.add("hidden");
        // 2. Show Face Modal ONLY now
        document.getElementById("faceModal").classList.remove("hidden");
        
        if(!u || !u.faceData) {
            document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup";
            document.getElementById("btnCapture").onclick = registerNewFace;
            initCamera(false);
        } else {
            document.getElementById("modalTitle").innerText = "Biometric Verification";
            document.getElementById("btnCapture").onclick = handleFaceScan;
            initCamera(true);
        }
    })
    .catch(e => {
        btn.innerText = "VERIFY CREDENTIALS";
        btn.disabled = false;
        alert("Login Failed: " + e.message);
    });
};
// --- EVIDENCE CAMERA LOGIC ---
let evidenceStream = null;
let capturedEvidenceBlob = null; // Stores the photo data

// 1. START CAMERA
window.startEvidenceCamera = async () => {
    const video = document.getElementById("evidenceVideo");
    const container = document.getElementById("evidenceVideoContainer");
    
    // UI Updates
    container.style.display = "block";
    document.getElementById("evidencePreview").style.display = "none";
    document.getElementById("evidenceCamControls").classList.add("hidden");
    document.getElementById("evidenceCaptureControls").classList.remove("hidden");
    document.getElementById("evidenceSaveControls").classList.add("hidden");

    try {
        evidenceStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } // Tries to use back camera on mobile
        });
        video.srcObject = evidenceStream;
    } catch(err) {
        alert("Camera Error: " + err.message);
        stopEvidenceCamera();
    }
};

// 2. CAPTURE PHOTO
window.captureEvidencePhoto = () => {
    const video = document.getElementById("evidenceVideo");
    const canvas = document.createElement("canvas");
    
    // Set canvas size to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw image
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    // Convert to data (Quality 0.8 to compress slightly)
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show Preview
    const img = document.getElementById("evidencePreview");
    img.src = dataUrl;
    img.style.display = "block";
    
    // Hide Video
    document.getElementById("evidenceVideoContainer").style.display = "none";
    
    // Store for upload
    capturedEvidenceBlob = dataUrl;

    // UI Updates
    document.getElementById("evidenceCaptureControls").classList.add("hidden");
    document.getElementById("evidenceSaveControls").classList.remove("hidden");
    
    // Stop stream to save battery
    if(evidenceStream) {
        evidenceStream.getTracks().forEach(t => t.stop());
    }
};

// 3. RETRY PHOTO
window.retryEvidencePhoto = () => {
    capturedEvidenceBlob = null;
    startEvidenceCamera();
};

// 4. STOP CAMERA
window.stopEvidenceCamera = () => {
    if(evidenceStream) {
        evidenceStream.getTracks().forEach(t => t.stop());
        evidenceStream = null;
    }
    document.getElementById("evidenceVideoContainer").style.display = "none";
    document.getElementById("evidencePreview").style.display = "none";
    document.getElementById("evidenceCamControls").classList.remove("hidden");
    document.getElementById("evidenceCaptureControls").classList.add("hidden");
    document.getElementById("evidenceSaveControls").classList.add("hidden");
};
// --- ROBUST UPLOAD LOGIC (FIXED) ---

// A. UPLOAD CAPTURED PHOTO
window.uploadCapturedEvidence = async () => {
    // 1. Validation Checks
    if(!capturedEvidenceBlob) {
        return alert("‚ö†Ô∏è No photo found. Please capture an image first.");
    }
    
    // Check Station Selection
    const line = document.getElementById("galleryLineSelect").value;
    const stn = document.getElementById("galleryStationSelect").value;
    if(!line || !stn) {
        return alert("‚ö†Ô∏è ERROR: Please select a Line and Station first.");
    }

    const btn = document.activeElement; // Get the button clicked
    const originalText = btn.innerText;
    btn.innerText = "‚è≥ Uploading...";
    btn.disabled = true;

    try {
        // 2. Check Size (10MB Limit)
        const sizeInBytes = (capturedEvidenceBlob.length * 0.75);
        if(sizeInBytes > 10 * 1024 * 1024) throw new Error("Image too large (Max 10MB).");

        // 3. Upload
        await processUpload(capturedEvidenceBlob, "image/jpeg", "Live Capture.jpg");
        
        alert("‚úÖ Photo Uploaded Successfully!");
        stopEvidenceCamera(); // Close camera on success
        
    } catch (e) {
        console.error(e);
        alert("‚ùå Upload Failed: " + e.message);
    } finally {
        // 4. Reset Button
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

// B. UPLOAD FROM FILE
window.uploadFileEvidence = async () => {
    // 1. Validation Checks
    const fileInput = document.getElementById("evidenceFile");
    const file = fileInput.files[0];

    if(!file) return alert("‚ö†Ô∏è Please choose a file first.");

    const line = document.getElementById("galleryLineSelect").value;
    const stn = document.getElementById("galleryStationSelect").value;
    if(!line || !stn) {
        return alert("‚ö†Ô∏è ERROR: Please select a Line and Station from the dropdowns above.");
    }

    const btn = document.activeElement;
    const originalText = btn.innerText;
    btn.innerText = "‚è≥ Processing...";
    btn.disabled = true;

    // 2. Size Limits
    const LIMIT_PDF = 3 * 1024 * 1024;  // 3 MB
    const LIMIT_IMG = 10 * 1024 * 1024; // 10 MB

    if(file.type.includes("pdf") && file.size > LIMIT_PDF) {
        btn.innerText = originalText;
        btn.disabled = false;
        return alert("‚ùå PDF too large. Max 3MB.");
    }
    if(file.type.includes("image") && file.size > LIMIT_IMG) {
        btn.innerText = originalText;
        btn.disabled = false;
        return alert("‚ùå Image too large. Max 10MB.");
    }

    // 3. Read & Upload
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            await processUpload(e.target.result, file.type, file.name);
            alert("‚úÖ File Uploaded Successfully!");
            fileInput.value = ""; // Clear input
        } catch (err) {
            console.error(err);
            alert("‚ùå Database Error: " + err.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

    reader.onerror = function() {
        alert("‚ùå Error reading file.");
        btn.innerText = originalText;
        btn.disabled = false;
    };

    reader.readAsDataURL(file);
};

// C. DATABASE SAVER
async function processUpload(dataBase64, fileType, fileName) {
    const line = document.getElementById("galleryLineSelect").value;
    const stn = document.getElementById("galleryStationSelect").value;
    
    // Double check to prevent "undefined" entries
    if(!line || !stn) throw new Error("Target station missing.");

    const targetName = `${stn} (${line})`;

    const uploadData = {
        stationName: targetName,
        fileData: dataBase64,
        fileType: fileType,
        name: fileName,
        userName: currentUser.name || currentUser.email,
        uploadedAt: serverTimestamp() // Ensure serverTimestamp is imported!
    };

    // This checks if DB connection is active
    await push(ref(db, "history"), uploadData);
}
onAuthStateChanged(auth, (user) => {
    if (!user) { 
        // Use a safe check here too
        const loginSec = document.getElementById("loginSection");
        if (loginSec) loginSec.classList.remove("hidden");
        return; 
    }

    currentUser = user;
    startPresenceSystem(user);  

    const userRef = ref(db, `users/${user.uid}`);
    
    onValue(userRef, (snap) => {
        const u = snap.val();

        // --- THE FIX: Create a helper to prevent "null" crashes ---
        const updateClass = (id, action, className) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList[action](className);
            } else {
                console.warn(`SafeUI: Element #${id} not found. Skipping.`);
            }
        };

        // 1. New User Detection
        if (!u || !u.name) {
            updateClass("loginSection", "add", "hidden");
            updateClass("appScreen", "add", "hidden");
            updateClass("nameModal", "remove", "hidden");
            return; 
        }

        // 2. Security Checks
        if (u.terminated) { 
            alert("ACCOUNT TERMINATED."); 
            signOut(auth); 
            return; 
        }

        if (u.banned) {
            updateClass("header", "add", "hidden");
            updateClass("appScreen", "add", "hidden");
            updateClass("faceModal", "add", "hidden");
            updateClass("bannedScreen", "remove", "hidden");
            
            const reasonDisplay = document.getElementById("displayBanReason");
            if (reasonDisplay) reasonDisplay.innerText = u.banReason || "Security Protocol Violation";
            return; 
        }

        // 3. Silent Data Sync
        currentUser.name = u.name;
        isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
        
        const userInfoDisplay = document.getElementById("userInfo");
        if (userInfoDisplay) userInfoDisplay.innerText = `${u.name}`;

        if (isAdmin) {
            updateClass("adminBadge", "remove", "hidden");
            updateClass("btnAdmin", "remove", "hidden");
        }

        // CRITICAL: No Face Modal logic here. 
        // It must only be triggered by the login() button success.
        
    }, (error) => {
        console.error("Database sync failed:", error);
        signOut(auth);
    });
});
   // ==========================================
// 3. USER SESSION MANAGER
// ==========================================
// This function handles what happens when a user logs in or out.
const manageUserSession = (user) => {
    
    // A. NO USER -> SHOW LOGIN SCREEN
    if (!user) { 
        showLoginScreen(); 
        return; 
    }

    currentUser = user;
    
    // Start Presence
    startPresenceSystem(user);  

    // B. USER FOUND -> LOAD DATA
    const userRef = ref(db, `users/${user.uid}`);
    
    onValue(userRef, (snap) => {
        const u = snap.val();

        // 1. DATA MISSING?
        if (!u) {
            alert("Account data not found. Contact admin.");
            signOut(auth);
            return;
        }

        // 2. TERMINATED?
        if (u.terminated) { 
            alert("ACCOUNT TERMINATED."); 
            signOut(auth); 
            return; 
        }

        // 3. BANNED? -> SHOW RED SCREEN WITH DETAILS
        if (u.banned) {
            // Hide App Interface
            document.querySelector("header").style.display = "none";
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("appScreen").classList.add("hidden");
            document.getElementById("faceModal").classList.add("hidden");
            
            // Show Ban Overlay
            const banScreen = document.getElementById("bannedScreen");
            if(banScreen) {
                banScreen.classList.remove("hidden");
                
                // POPULATE DETAILS
                document.getElementById("displayBanReason").innerText = u.banReason || "Security Violation";
                document.getElementById("displayBanAction").innerText = u.banAction || "Contact System Administrator Immediately.";
                document.getElementById("displayBanRemarks").innerText = u.banRemarks || "No additional notes.";

                // Populate Time
                const deadline = u.banExpires || 0;
                if(deadline > 0) {
                      const dateStr = new Date(deadline).toLocaleString('en-IN', {
                          day: '2-digit', month: 'short', year: 'numeric',
                          hour: '2-digit', minute: '2-digit', hour12: true
                      });
                      document.getElementById("bannedTimeDisplay").innerText = "Expiring: " + dateStr;
                } else {
                      document.getElementById("bannedTimeDisplay").innerText = "‚õî PERMANENT SUSPENSION";
                }
            } else {
                document.body.innerHTML = "<h1 style='color:red; text-align:center;'>‚õî ACCOUNT SUSPENDED</h1><br><button onclick='logout()'>Log Out</button>";
            }
            return; // STOP HERE
        }

        // 4. ACTIVE USER -> SHOW APP
        document.getElementById("bannedScreen")?.classList.add("hidden");
        document.querySelector("header").style.display = "flex";
        
        currentUser.name = u.name;
        isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());

        // Name Setup Check
        if (!u.name) {
            document.getElementById("nameModal").classList.remove("hidden");
            document.getElementById("loginSection").classList.add("hidden");
            return;
        }
        
        // Update Header Info
        document.getElementById("userInfo").innerText = `${u.name}`;
        document.getElementById("authContainer").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");

        // Load Admin Tools
        if (isAdmin) {
            const badge = document.getElementById("adminBadge");
            const btn = document.getElementById("btnAdmin");
            if(badge) badge.classList.remove("hidden");
            if(btn) btn.classList.remove("hidden");
            setTimeout(loadAdminPanel, 2000);
        }

        // Biometric Check
        if(!isTransactionAuth) {
            const faceModal = document.getElementById("faceModal");
            faceModal.classList.remove("hidden");
            
            if(!u.faceData) {
                document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup";
                document.getElementById("regProgress").classList.remove("hidden");
                document.getElementById("btnCapture").onclick = registerNewFace;
                initCamera(false);
            } else {
                document.getElementById("modalTitle").innerText = "Biometric Verification";
                document.getElementById("regProgress").classList.add("hidden");
                document.getElementById("btnCapture").onclick = handleFaceScan;
                initCamera(true);
            }
        }
    }, (error) => {
        console.error(error);
        alert("Connection Error. Logging out...");
        signOut(auth);
    });
};

// CRITICAL: ACTIVATE THE LISTENER
onAuthStateChanged(auth, manageUserSession);
// Helper to reliably show login
function showLoginScreen() {
    document.querySelector("header").style.display = "flex";
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("bannedScreen")?.classList.add("hidden");
    document.getElementById("faceModal").classList.add("hidden");
    stopCamera();
    
    // Reset Button State
    const btn = document.querySelector("#loginSection button");
    if(btn) {
        btn.innerText = "SECURE LOGIN";
        btn.disabled = false;
    }
}

// --- HELPER: TOGGLE 'OTHER' INPUT FOR ADD STOCK ---
window.toggleAddOtherInput = () => {
    const val = document.getElementById("addLocSelect").value;
    const otherDiv = document.getElementById("divAddOtherLoc");
    
    if(val === "Other") {
        otherDiv.classList.remove("hidden");
        document.getElementById("addLocOther").focus();
    } else {
        otherDiv.classList.add("hidden");
    }
};
// --- TOGGLE 'OTHER' INPUT ---
window.toggleBanOtherInput = () => {
    const val = document.getElementById("banReasonInput").value;
    const div = document.getElementById("divBanOther");
    if(val === "Other") {
        div.classList.remove("hidden");
        document.getElementById("banReasonOther").focus();
    } else {
        div.classList.add("hidden");
    }
};

// --- HANDLE CUSTOM DATE SELECTION ---
window.selectBanCustomDate = (input) => {
    if(input.value) {
        // Deselect all buttons if date is picked
        currentBanDays = 'CUSTOM';
        document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
        input.style.border = "2px solid #dc3545";
    }
};

// --- UPDATED BUTTON SELECTION ---
window.selectBanDuration = (days, btn) => {
    currentBanDays = days;
    // Clear Date Input
    document.getElementById("banCustomDate").value = "";
    document.getElementById("banCustomDate").style.border = "1px solid #ccc";
    
    // Highlight Button
    document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
};
// ==========================================
// 4. ROBUST PRESENCE SYSTEM (Fixed)
// ==========================================
let presenceInterval = null; 

function startPresenceSystem(user) {
    if (!user || !user.uid) return;

    // Sanity Check: Ensure UID is safe (no dots/special chars allowed in keys)
    if (user.uid.includes(".") || user.uid.includes("#") || user.uid.includes("$")) {
        console.error("CRITICAL: Invalid UID detected. Presence system aborted.");
        return;
    }

    const userStatusRef = ref(db, `status/${user.uid}`);
    const connectedRef = ref(db, ".info/connected");

    onValue(connectedRef, (snap) => {
        if (snap.val() === true) {
            // FIX: Ensure Name is a valid string, never undefined
            const safeName = (user.name && typeof user.name === 'string') ? user.name : (user.email || "Unknown User");

            // 1. Set Disconnect Hook
            onDisconnect(userStatusRef).set({
                state: 'offline',
                last_seen: serverTimestamp(),
                email: user.email,
                name: safeName
            });

            // 2. Mark as Online
            update(userStatusRef, {
                state: 'online',
                last_seen: serverTimestamp(),
                email: user.email,
                name: safeName
            });
        }
    });

    // Heartbeat Pulse
    if (presenceInterval) clearInterval(presenceInterval);
    presenceInterval = setInterval(() => {
        if (auth.currentUser) {
            update(userStatusRef, {
                last_seen: serverTimestamp(),
                state: 'online'
            }).catch(() => {}); // Suppress minor network errors
        }
    }, 5000);
}
function updateRegDots(count) {
    document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
    document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
    document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}
  // ==========================================
// 6. STRICT SESSION TIMEOUT (Auto-Offline)
// ==========================================

function setupIdleTimer() {
    // Detect any activity to keep session alive
    window.onmousemove = resetTimer;
    window.onmousedown = resetTimer;
    window.onclick = resetTimer;
    window.onkeypress = resetTimer;
    window.ontouchstart = resetTimer; 
    window.addEventListener('scroll', resetTimer, true); 
    
    resetTimer(); // Start the countdown
}
window.printReport = (mode) => {
    // 1. Clean previous classes
    document.body.classList.remove('print-a4', 'print-pos');

    // 2. Add class based on selection
    if (mode === 'A4') {
        document.body.classList.add('print-a4');
        document.title = "Metro_Inspection_A4_" + new Date().getTime(); 
    } else {
        document.body.classList.add('print-pos');
        document.title = "Metro_Receipt_58mm_" + new Date().getTime();
    }

    // 3. Trigger Print
    // In most modern browsers, setting the 'Save as PDF' destination 
    // will now use the filename we set above.
    setTimeout(() => {
        window.print();
    }, 100);
};
function resetTimer() {
    clearTimeout(idleTimer);
    
    // Only run if a user is actually logged in
    if(currentUser) {
        // Set Timeout for 10 Minutes (or your preferred time)
        idleTimer = setTimeout(async () => {
            console.log("Session Timed Out. Marking Offline...");

            // 1. FORCE DATABASE STATUS TO OFFLINE
            try {
                await update(ref(db, `status/${currentUser.uid}`), {
                    state: 'offline',
                    last_changed: serverTimestamp(),
                    email: currentUser.email
                });
            } catch(e) {
                console.error("Status Update Failed", e);
            }

            // 2. LOG THE EVENT
            try {
                await push(ref(db, "logs"), { 
                    user: currentUser.email, 
                    type: "LOGOUT", 
                    method: "Auto-Timeout (Inactivity)", 
                    time: serverTimestamp() 
                });
            } catch(e) {}

            // 3. KILL THE SESSION
            await signOut(auth);
            
            // 4. NOTIFY USER
            alert("Session Expired due to inactivity. You have been marked Offline.");
            window.location.reload(); // Force refresh to clear old state

        }, 10 * 60 * 1000); // 10 Minutes (Adjust as needed)
    }
}
window.saveOfficialName = async () => {
    const nameInput = document.getElementById("officialNameInput");
    // Remove special chars from name to be safe
    const name = nameInput.value.replace(/[.#$\[\]]/g, "").trim(); 

    if(name.length < 3) return alert("Please enter a valid name (3+ chars).");

    const btn = nameInput.nextElementSibling;
    btn.innerText = "Creating Profile...";
    btn.disabled = true;

    try {
        await set(ref(db, `users/${currentUser.uid}`), {
            name: name,
            email: currentUser.email,
            banned: false,
            faceData: null,
            createdAt: serverTimestamp(),
            last_login: serverTimestamp()
        });
        document.getElementById("nameModal").classList.add("hidden");
    } catch(e) {
        alert("Error: " + e.message);
        btn.innerText = "Save & Continue";
        btn.disabled = false;
    }
}
function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}
window.logout = async () => {
    if(!currentUser) return;
    
    const btn = document.activeElement; 
    if(btn) btn.innerText = "üîå Terminating...";

    try {
        // 1. STOP CAMERA IMMEDIATELY
        stopCamera();

        // 2. FORCE UI RESET (Hide everything)
        document.getElementById("faceModal").classList.add("hidden"); 
        document.getElementById("appScreen").classList.add("hidden");
        document.getElementById("authContainer").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");

        // 3. UPDATE DATABASE STATUS
        await update(ref(db, `status/${currentUser.uid}`), {
            state: 'offline',
            last_changed: serverTimestamp()
        });

        // 4. SIGN OUT AND RELOAD
        await signOut(auth);
        window.location.reload(); 

    } catch (e) {
        console.error("Logout Error", e);
        signOut(auth);
        window.location.reload();
    }
};
async function recordLogin(method) {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
    }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
   
    try {
        if(!modelsLoaded) {
            updateStatus("Loading AI Models...", "yellow");
            await preloadModels();
        }
        
        // Remove specific width/height constraints to let the camera decide
stream = await navigator.mediaDevices.getUserMedia({ video: true });
        vid.srcObject = stream;
        vid.onloadedmetadata = () => {
            vid.play();
            startRealTimeDetection(vid, canvas);
        };

        if(isVerify) updateStatus("LOOK AT CAMERA", "white");
        else updateStatus("REGISTRATION: CENTER FACE", "cyan");

    } catch(e) {
        console.error(e);
        updateStatus("Camera Hardware Error", "red");
    }
}
// --- 1. DEFINE METRO DATA ---
const METRO_STATIONS = {
    "Blue Line": [
        "Dakshineswar", "Baranagar", "Noapara", "Dum Dum", "Belgachia", 
        "Shyambazar", "Shobhabazar Sutanuti", "Girish Park", "Mahatma Gandhi Road", 
        "Central", "Chandni Chowk", "Esplanade", "Park Street", "Maidan", 
        "Rabindra Sadan", "Netaji Bhavan", "Jatin Das Park", "Kalighat", 
        "Rabindra Sarobar", "Mahanayak Uttam Kumar", "Netaji", 
        "Masterda Surya Sen", "Gitanjali", "Kavi Nazrul", "Shahid Khudiram", 
        "Kavi Subhash (New Garia)"
    ],
    "Green Line": [
        "Salt Lake Sector V", "Karunamoyee", "Central Park", "City Centre", 
        "Bengal Chemical", "Salt Lake Stadium", "Phoolbagan", "Sealdah", 
        "Esplanade", "Mahakaran", "Howrah", "Howrah Maidan"
    ],
    "Purple Line": [
        "Joka", "Thakurpukur", "Sakher Bazar", "Behala Chowrasta", 
        "Behala Bazar", "Taratala", "Majerhat"
    ],
    "Yellow Line": [
        "Noapara", "Dum Dum Cantonment", "Jessore Road", "Jai Hind (Airport)"
    ],
    "Orange Line": [
        "Kavi Subhash (New Garia)", "Satyajit Ray", "Jyotirindra Nandi", 
        "Kavi Sukanta", "Hemanta Mukhopadhyay"
    ],
    "Pink Line": [
        "Baranagar", "Barrackpore" // Endpoints added as placeholders
    ]
};

// --- 2. HANDLE LINE CHANGE ---
window.handleLineChange = () => {
    const lineSel = document.getElementById("lineSelect");
    const stnSel = document.getElementById("stationSelect");
    const formDiv = document.getElementById("mainDataForm");
    
    // Reset
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    formDiv.classList.add("hidden");
    document.getElementById("inpStationName").value = ""; // Clear hidden input

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        // Populate Stations
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        
        stnSel.disabled = false;
        stnSel.style.background = "#fff";
    }
};
window.handleStationChange = async () => {
    const stnSel = document.getElementById("stationSelect");
    const lineSel = document.getElementById("lineSelect");
    const formDiv = document.getElementById("mainDataForm");
    const submitBtn = document.getElementById("btnFinalSubmit");

    // üõë STEP 1: NUCLEAR WIPE (Force the system to forget Station A)
    await nuclearReset(); 
    
    // üõë STEP 2: MANUALLY CLEAR KEYS (Double Protection)
    currentStationKey = null; 
    currentRakeKey = null;

    if (!stnSel.value) {
        formDiv.classList.add("hidden");
        isSwitching = false;
        return;
    }

    // === STEP 3: SETUP NEW STATION ===
    formDiv.classList.remove("hidden"); // This shows the form inputs
    const fullStationName = `${stnSel.value} (${lineSel.value})`;
    
    document.getElementById("inpStationName").value = fullStationName;
    document.getElementById("formTitle").innerText = `üìù Entry: ${stnSel.value}`;

    // === STEP 4: CHECK IF DATA ALREADY EXISTS ===
    // We check the database: "Do we have data for THIS specific station?"
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(fullStationName));
    const snap = await get(q);

    if (snap.exists()) {
        // --- OLD DATA FOUND (Edit Mode) ---
        let data = null;
        snap.forEach(c => { data = c.val(); currentStationKey = c.key; }); // Load the EXISTING ID
        
        // Fill inputs
        document.getElementById("inpStationLength").value = data.len || "";
        document.getElementById("inpYellowDist").value = data.yl || "";
        document.getElementById("inpYellowThick").value = data.th || "";
        document.getElementById("inpRemarks").value = data.remarks || "";
        document.getElementById("inpImplementation").value = data.impl || "";

        // Button becomes orange
        document.getElementById("dataExistsWarning").classList.remove("hidden");
        document.getElementById("dataExistsWarning").innerHTML = "‚ö†Ô∏è <strong>EDIT MODE:</strong> Modifying Existing Master Record.";
        submitBtn.innerText = "üíæ Update Master Record";
        submitBtn.style.background = "#d97706"; 

        // Load rows
        currentRakeKey = data.linkedRakeKey || currentStationKey;
        const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
        if(rakeSnap.exists()) {
            await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
        }

    } else {
        // --- NO DATA FOUND (New Mode) ---
        // currentStationKey MUST BE NULL here.
        submitBtn.innerText = "‚úî Submit New Log";
        submitBtn.style.background = "#0A2342"; 
    }

    // === STEP 5: START LISTENER ===
    loadDraft(); 
    
    // Unlock the safety
    setTimeout(() => {
        isSwitching = false;
    }, 300);
};
// --- 1. HANDLE TAB & DROPDOWNS ---

// Reuse Station Data Logic for Print Tab
window.handlePrintLineChange = () => {
    const lineSel = document.getElementById("printLineSelect");
    const stnSel = document.getElementById("printStationSelect");
    
    // Reset
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    document.getElementById("printLogList").classList.add("hidden");

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        stnSel.disabled = false;
    }
};
window.deleteStationLog = async (key) => {
    if(!confirm("‚ö†Ô∏è PERMANENTLY DELETE this record?\n\nThis cannot be undone.")) return;

    const btn = document.activeElement; // The delete button you clicked
    if(btn) btn.innerText = "‚è≥";

    try {
        // 1. GET DATA TO FIND LINKS
        const snap = await get(ref(db, `station_logs/${key}`));
        let rakeKey = key; 
        if(snap.exists()) {
             rakeKey = snap.val().linkedRakeKey || key;
        }

        // 2. DELETE BOTH (Atomic removal)
        await remove(ref(db, `station_logs/${key}`));
        await remove(ref(db, `rake_logs/${rakeKey}`));

        // 3. REFRESH THE VIEW INSTANTLY
        // This proves to you immediately that the specific row is gone
        await loadSpecificStationData(); 
        
        alert("‚úÖ Record Removed.");

    } catch(e) {
        alert("‚ùå Error deleting: " + e.message);
        if(btn) btn.innerText = "üóë";
    }
};
// --- 2. FETCH LOGS FOR STATION ---
// UPDATED: Fetch Logs for Print
window.fetchLogsForPrint = async () => {
    const line = document.getElementById("printLineSelect").value;
    const stn = document.getElementById("printStationSelect").value;
    const tbody = document.getElementById("printLogBody");
    const listDiv = document.getElementById("printLogList");

    // 1. WIPE UI (The Fix)
    tbody.innerHTML = "";
    if(!line || !stn) {
        listDiv.classList.add("hidden");
        return;
    }

    listDiv.classList.remove("hidden");
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>üîç Searching Records...</td></tr>";

    // 2. FETCH NEW
    const searchName = `${stn} (${line})`;
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
    
    try {
        const snap = await get(q);
        tbody.innerHTML = ""; // Clear Loading Message

        if(!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>No records found.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const d = c.val();
            const btn = `<button class="info" onclick="openPrintSetup('${c.key}')">üñ®Ô∏è Select</button>`;
            tbody.innerHTML += `
                <tr>
                    <td>${d.date}</td>
                    <td style="font-weight:bold;">${d.name}</td>
                    <td>${d.userName}</td>
                    <td style="text-align:center;">${btn}</td>
                </tr>
            `;
        });
    } catch (e) {
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Connection Error</td></tr>";
    }
};
// --- 3. OPEN CONFIG MODAL ---
let currentPrintKey = null;

// --- UPDATED OPEN CONFIG MODAL ---
window.openPrintSetup = (key) => {
    currentPrintKey = key;
    
    // 1. Fetch Date for display
    get(ref(db, `station_logs/${key}/date`)).then(snap => {
        document.getElementById("modalPrintDate").innerText = snap.val();
    });

    // 2. Populate the "Test Conducting Member" dropdown dynamically
    populateUserDropdown();

    // 3. Show Modal
    document.getElementById("printOptionsModal").classList.remove("hidden");
};

window.closePrintModal = () => {
    document.getElementById("printOptionsModal").classList.add("hidden");
    currentPrintKey = null;
};
window.generateFinalReport = async () => {
    if (!currentPrintKey) return alert("Error: No record selected.");

    const includeRakes = document.getElementById("chkRakeData").checked;
    let conductingOfficerName = document.getElementById("selPrintInspector").value;
    let authName = document.getElementById("selPrintAuthority").value;

    if (conductingOfficerName === "Self" || conductingOfficerName === "" || conductingOfficerName === "Self (Current User)") {
        conductingOfficerName = currentUser.name || currentUser.email;
    }

    try {
        const sSnap = await get(ref(db, `station_logs/${currentPrintKey}`));
        if (!sSnap.exists()) return alert("Station record not found.");
        const sData = sSnap.val();

        const siteName = (sData.name || "").split("(")[0].trim().toUpperCase();
        const corridor = (sData.name || "").match(/\(([^)]+)\)/)?.[1] || "Blue Line";
        const logDate = sData.date || "";
        const printTime = new Date().toLocaleString("en-IN", { 
            day: "2-digit", month: "short", year: "numeric", 
            hour: "2-digit", minute: "2-digit", hour12: true 
        });

        let rakeTableHtml = "";
        if (includeRakes) {
            const rakeKey = sData.linkedRakeKey || currentPrintKey;
            const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
            if (rSnap.exists()) {
                rakeTableHtml = `
                <div class="black-header-bar">RAKE CLEARANCE TABLE</div>
                <table class="report-table-max">
                    <thead>
                        <tr>
                            <th style="text-align:left; border-right:4pt solid #000;">RAKE ID TYPE</th>
                            <th style="text-align:center; border-right:4pt solid #000;">FRONT</th>
                            <th style="text-align:center;">REAR</th>
                        </tr>
                    </thead>
                    <tbody>`;
                Object.values(rSnap.val()).forEach(r => {
                    rakeTableHtml += `
                        <tr>
                            <td style="border-right:4pt solid #000;">${r.rake || ""} ${r.type || ""}</td>
                            <td style="text-align:center; border-right:4pt solid #000;">${r.f || ""}</td>
                            <td style="text-align:center;">${r.r || ""}</td>
                        </tr>`;
                });
                rakeTableHtml += `</tbody></table>`;
            }
        }

        const reportContainer = document.getElementById("printableReportContainer");
        
        const styleSheet = `
        <style>
            @media print {
                @page { size: A4; margin: 5mm; }
                body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0; }
                .no-print { display: none !important; }
                .report-wrapper { width: 100% !important; padding: 5mm !important; margin: 0 !important; border: none !important; }
            }
            .report-wrapper { 
                width: 100%; min-height: 297mm; margin: 0 auto; padding: 10mm; 
                background: white; font-family: "Times New Roman", Times, serif; color: #000; 
                box-sizing: border-box;
            }
            .black-header-bar { 
                background-color: #000 !important; color: #fff !important; 
                padding: 18pt !important; font-size: 38pt !important; font-weight: 900 !important; 
                text-align: center !important; text-transform: uppercase !important;
                margin-top: 40pt !important; -webkit-print-color-adjust: exact !important;
                width: 100% !important; box-sizing: border-box;
            }
            .header-main { font-size: 72pt; font-weight: 900; text-align: center; line-height: 1; text-transform: uppercase; }
            .header-sub { font-size: 28pt; font-weight: 900; text-align: center; margin-top: 20pt; text-transform: uppercase; line-height: 1.2; }
            .field-row { font-size: 42pt; border-bottom: 8pt solid #000; padding: 15pt 0; margin-bottom: 15pt; width: 100%; box-sizing: border-box; }
            .measurement-text { font-size: 38pt; font-weight: 900; line-height: 1.8; padding: 25pt 0; border-bottom: 6pt solid #000; width: 100%; box-sizing: border-box; }
            .report-table-max { width: 100%; border-collapse: collapse; margin-top: 15pt; font-size: 32pt; border: 8pt solid #000; font-weight: 900; table-layout: fixed; }
            .report-table-max th, .report-table-max td { padding: 20pt; border-bottom: 6pt solid #000; overflow-wrap: break-word; }
        </style>`;

        reportContainer.innerHTML = styleSheet + `
        <div class="no-print" style="text-align:center; padding:25px; background:#f8fafc; border-bottom:1px solid #ddd;">
            <button class="danger" onclick="closeReportPreview()">CLOSE</button>
            <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 50px; font-weight:bold; font-size:24px; cursor:pointer; border-radius:8px;">PRINT OFFICIAL RECORD</button>
        </div>

        <div class="report-wrapper">
            <div style="border-bottom: 16pt solid #000; padding-bottom: 35pt; text-align: center;">
                <div class="header-main">METRO RAILWAY</div>
                <div class="header-main" style="font-size: 56pt;">PLATFORM SAFETY PROJECT</div>
                <div class="header-sub">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><br>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 38pt; font-weight: 900; text-decoration: underline; margin-top: 35pt;">OFFICIAL INSPECTION RECORD</div>
            </div>

            <div style="margin-top: 55pt;">
                <div class="field-row"><b>SITE:</b> ${siteName}</div>
                <div class="field-row"><b>CORRIDOR:</b> ${corridor}</div>
                <div class="field-row"><b>CONDUCTING OFFICER:</b> ${conductingOfficerName.toUpperCase()}</div>
                <div class="field-row"><b>LOGGED ON (DB):</b> ${logDate}</div>
            </div>

            <div class="black-header-bar">MEASUREMENTS</div>
            <div class="measurement-text">
                PLATFORM LENGTH: ${sData.len || "172.8"} m<br>
                YELLOW LINE DISTANCE: ${sData.yl || "70"} cm<br>
                LINE THICKNESS: ${sData.th || "10"} cm<br>
                COMPLIANCE STATUS: ${sData.impl === "YES" ? "YES / COMPLIANT" : "NO / NON-COMPLIANT"}
            </div>

            <div class="black-header-bar">INSPECTOR REMARKS</div>
            <div style="font-size: 36pt; font-weight: 900; line-height: 1.6; padding: 30pt 0; border-bottom: 8pt solid #000; text-align: justify;">
                ${(sData.remarks || "STATION IS STRAIGHT. NO UNKNOWN CURVE FOUND.").toUpperCase()}
            </div>

            ${rakeTableHtml}

            <div style="margin-top: 150pt; display: flex; justify-content: space-between; font-size: 28pt; font-weight: 900;">
                <div style="text-align: center; width: 48%;">
                    <div style="border-top: 8pt solid #000; padding-top: 15pt;">${conductingOfficerName.toUpperCase()}</div>
                    <div style="font-size: 22pt;">CONDUCTING OFFICER</div>
                </div>
                <div style="text-align: center; width: 48%;">
                    <div style="border-top: 8pt solid #000; padding-top: 15pt;">${authName.toUpperCase()}</div>
                    <div style="font-size: 22pt;">APPROVING AUTHORITY</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 100pt; font-size: 22pt; font-weight: 900; border-top: 5pt dashed #000; padding-top: 30pt;">
                SYSTEM GENERATED RECORD | PRINTED ON: ${printTime.toUpperCase()}
            </div>
        </div>`;

        closePrintModal();
        reportContainer.classList.remove("hidden");
        window.scrollTo(0, 0);

    } catch (err) {
        console.error(err);
        alert("Print Error: " + err.message);
    }
};
window.closeReportPreview = () => {
    document.getElementById("printableReportContainer").classList.add("hidden");
};
async function startRealTimeDetection(video, canvas) {
    const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
    faceapi.matchDimensions(canvas, displaySize);
    if (detectionLoop) clearInterval(detectionLoop);
    detectionLoop = setInterval(async () => {
        if (!stream) return;
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (detection) {
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            const box = resizedDetections.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
            drawBox.draw(canvas);
            currentDescriptor = detection.descriptor;
            const btn = document.getElementById("btnCapture");
            if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00";
        } else {
            currentDescriptor = null;
            const btn = document.getElementById("btnCapture");
            if(btn) btn.style.border = "1px solid #004494";
        }
    }, 100);
}

function stopCamera() {
    if(detectionLoop) clearInterval(detectionLoop);
    if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    if(vid) vid.srcObject = null;
    if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
    document.getElementById("faceModal").classList.add("hidden");
    isTransactionAuth = false;
    currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }
window.handleFaceScan = async () => {
    const btn = document.getElementById("btnCapture");
    if(!currentDescriptor) { updateStatus("‚ùå No Face Detected.", "red"); return; }
    
    btn.disabled = true;
    btn.innerText = "Processing...";
    updateStatus("Analyzing Biometrics...", "cyan");

    try {
        // --- MODE 1: RECEIVER VERIFICATION ---
        if(scanMode === 'RECEIVER') {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            
            let match = false;
            // Check match against logged-in user
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                    if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }

            if(match) {
                updateStatus("‚úÖ IDENTITY CONFIRMED", "#00ff00");
                setTimeout(() => {
                    stopCamera();
                    receiverVerified = true;
                    // Update UI based on transaction type
                    if(currentTransactionType === 'CHECKOUT') {
                        document.getElementById("checkout_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("checkout_status_text").style.color = "green";
                        document.getElementById("btn_checkout_verify").classList.add("hidden");
                        // Enable Admin Button
                        const subBtn = document.getElementById("btn_checkout_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#b38600";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    } else {
                        document.getElementById("return_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("return_status_text").style.color = "green";
                        document.getElementById("btn_return_verify").classList.add("hidden");
                        // Enable Admin Button
                        const subBtn = document.getElementById("btn_return_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#17a2b8";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    }
                }, 1000);
            } else {
                throw new Error("Face Does Not Match User");
            }
        }

        // --- MODE 2: ADMIN AUTHORIZATION ---
        else if(scanMode === 'ADMIN') {
    // Step 1: must be logged in admin
    if (!isAdmin) {
        throw new Error("You are not an admin account");
    }

    // Step 2: match only against his own face
    const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
    const storedData = snap.val();

    let match = false;
    if (storedData) {
        const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
        for (let s of samples) {
            if (faceapi.euclideanDistance(s, currentDescriptor) < 0.55) {
                match = true;
                break;
            }
        }
    }

    if (match) {
        updateStatus("‚úÖ ADMIN AUTHORIZED", "#00ff00");
        await processTransaction(currentUser.name);
    } else {
        throw new Error("Admin face does not match");
    }
}
        // --- MODE 3: LOGIN ---
        else {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            let match = false;
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                     if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }
            if(match) {
                updateStatus("‚úÖ VERIFIED", "#00ff00");
                await recordLogin("Biometric");
                enterApp();
            } else {
                throw new Error("Face Mismatch");
            }
        }

    } catch (error) {
        console.error(error);
        updateStatus("‚ùå " + error.message, "red");
        btn.disabled = false;
        btn.innerText = "üì∏ Retry Scan";
    }
};

window.registerNewFace = async () => {
    if(!currentDescriptor) { updateStatus("‚ùå Camera cannot see face clearly.", "orange"); return; }
    regSamples.push(Array.from(currentDescriptor));
    const count = regSamples.length;
    updateRegDots(count);
    if(count < 3) {
        updateStatus(`‚úÖ Sample ${count}/3 Captured.`, "lightgreen");
        document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${count + 1} of 3`;
    } else {
        updateStatus("üíæ Saving...", "yellow");
        await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
        alert("Registration Complete!"); location.reload();
    }
};
// --- FIXED: LOAD ALL STATION DATA (Corrected ID Match) ---
window.loadStationData = () => {
    // 1. SHOW THE PANEL
    const panel = document.getElementById("logResultsPanel");
    if(panel) panel.classList.remove("hidden"); 
    
    const title = document.getElementById("logTableTitle");
    if(title) title.innerText = "Recent Station Logs (All)";

    // 2. GET THE CORRECT TABLE BODY (Updated ID for Professional HTML)
    // We check for both IDs just to be safe
    const tbody = document.getElementById("viewTable1Body") || document.getElementById("stationDataViewBody");
    
    // 3. CRASH PREVENTION
    if (!tbody) {
        console.warn("Table Body not found. Skipping render.");
        return; 
    }

    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‚è≥ Loading Station Logs...</td></tr>";

    // 4. FETCH DATA
    const q = query(ref(db, "station_logs"), limitToLast(50));

    onValue(q, (snap) => {
        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>No data found.</td></tr>";
            return;
        }

        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); 

        tbody.innerHTML = "";

        logs.forEach(d => {
            // View Button
            const rowButton = `<button class="info" onclick="fetchAndShowRakes('${d.key}')" style="padding:4px 8px; font-size:11px;">üìÑ View Table</button>`;
            
            // Admin Delete Button
            let deleteBtn = "";
            if (isAdmin) {
                deleteBtn = `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:4px 8px; font-size:11px; margin-left:5px;">üóë</button>`;
            }

            // Render Row
            const html = `
            <tr class="station-row-item">
                <td style="font-size:12px;">${d.date}</td>
                <td style="font-size:12px;">${d.userName}</td>
                
                <td style="font-weight:bold;">${d.len || '-'} m</td>
                <td style="font-weight:bold;">${d.yl || '-'} cm</td>
                <td>${d.th || '-'} cm</td>
                
                <td style="text-align:center;">${d.impl === 'YES' ? '<span style="color:green">‚úÖ YES</span>' : '<span style="color:red">‚ùå NO</span>'}</td>
                
                <td style="font-style:italic; color:#555; font-size:11px;">${d.remarks || '--'}</td>
                
                <td style="text-align:center; white-space:nowrap;">
                    ${rowButton}
                    ${deleteBtn}
                </td>
            </tr>`;
            tbody.innerHTML += html;
        });
    }, { onlyOnce: true });
};
// =========================================================
// üöÄ ENGINE CORE: DATA ISOLATION SYSTEM (Unified)
// =========================================================

// Global State Trackers
let currentStationKey = null; 
let currentRakeKey = null;
let draftRef = null;
let draftListener = null;
async function nuclearReset() {
    console.log("‚ò¢Ô∏è NUCLEAR RESET: Hard reset initiated.");
    
    // 1. ENGAGE SAFETY LOCK
    isSwitching = true; 

    // 2. DETACH LISTENERS (Swallow errors to prevent crash)
    if (draftRef) { 
        try { off(draftRef); } catch(e) { console.log("Listener clear error", e); }
        draftRef = null;
    }
    draftListener = null; 

    // 3. WIPE MEMORY
    currentStationKey = null;
    currentRakeKey = null;

    // 4. WIPE INPUTS (Physically clear the box)
    const uiIds = ["inpStationLength", "inpYellowDist", "inpYellowThick", "inpRemarks", "inpImplementation"];
    uiIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) { 
            el.value = ""; 
            el.disabled = false; 
            el.blur(); // Remove focus
        }
    });
    
    // 5. WIPE TABLE
    const tbody = document.getElementById("distanceBody");
    if(tbody) tbody.innerHTML = "";

    // 6. RESET BUTTONS
    const warningEl = document.getElementById("dataExistsWarning");
    if(warningEl) warningEl.classList.add("hidden");
    
    const titleEl = document.getElementById("formTitle");
    if(titleEl) titleEl.innerText = "üìù New Entry";
    
    const btn = document.getElementById("btnFinalSubmit");
    if(btn) {
        btn.innerText = "‚úî Submit to Master Database";
        btn.style.background = "#0A2342"; 
        btn.disabled = false;
    }

    // 7. DATABASE PURGE (Clear the user's draft node completely)
    if(currentUser) {
        try {
            await set(ref(db, `drafts/${currentUser.uid}`), null);
        } catch(e) { console.error("Draft wipe failed", e); }
    }
}
window.handleStationChange = async () => {
    const stnSel = document.getElementById("stationSelect");
    const lineSel = document.getElementById("lineSelect");
    const formDiv = document.getElementById("mainDataForm");
    const submitBtn = document.getElementById("btnFinalSubmit");

    // üõë STEP 1: FORCE RESET & WAIT
    await nuclearReset(); 

    if (!stnSel.value) {
        formDiv.classList.add("hidden");
        isSwitching = false;
        return;
    }

    // === STEP 2: SHOW FORM ===
    formDiv.classList.remove("hidden");
    const fullStationName = `${stnSel.value} (${lineSel.value})`;
    
    document.getElementById("inpStationName").value = fullStationName;
    document.getElementById("formTitle").innerText = `üìù Entry: ${stnSel.value}`;

    // === STEP 3: CHECK DATABASE ===
    // Use once() via get() to prevent lingering connections
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(fullStationName));
    const snap = await get(q);

    if (snap.exists()) {
        // --- EDIT MODE ---
        let data = null;
        snap.forEach(c => { data = c.val(); currentStationKey = c.key; });
        
        document.getElementById("inpStationLength").value = data.len || "";
        document.getElementById("inpYellowDist").value = data.yl || "";
        document.getElementById("inpYellowThick").value = data.th || "";
        document.getElementById("inpRemarks").value = data.remarks || "";
        document.getElementById("inpImplementation").value = data.impl || "";

        document.getElementById("dataExistsWarning").classList.remove("hidden");
        document.getElementById("dataExistsWarning").innerHTML = "‚ö†Ô∏è <strong>EDIT MODE:</strong> Modifying Existing Record.";
        submitBtn.innerText = "üíæ Update Master Record";
        submitBtn.style.background = "#d97706"; 

        currentRakeKey = data.linkedRakeKey || currentStationKey;
        
        // Copy Rake Data to Drafts for editing
        const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
        if(rakeSnap.exists()) {
            await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
        }

    } else {
        // --- NEW ENTRY MODE ---
        // currentStationKey is NULL from nuclearReset
        submitBtn.innerText = "‚úî Submit New Log";
        submitBtn.style.background = "#0A2342"; 
    }

    // === STEP 4: START DRAFT LISTENER ===
    loadDraft(); 
    
    // Release the safety lock
    setTimeout(() => { isSwitching = false; }, 500);
};
// --- 3. DRAFT TABLE LOADER (Corrected Name) ---
window.loadDraft = () => {
    // 1. Set the reference to the user's draft rows
    draftRef = ref(db, `drafts/${currentUser.uid}/rows`);
    
    // 2. Start the Realtime Listener
    draftListener = onValue(draftRef, (snap) => {
        const tbody = document.getElementById("distanceBody");
        
        // Safety check: ensure table exists before trying to write to it
        if (!tbody) return; 
        
        tbody.innerHTML = ""; // Clear existing rows

        if(!snap.exists()) return; // If no data, stop here

        const rows = snap.val();
        let count = 1;
        
        // 3. Loop through rows and render HTML
        Object.entries(rows).forEach(([key, val]) => {
            const html = `
                <tr>
                    <td style="text-align:center;">${count++}</td>
                    <td>
                        <input value="${val.rake || ''}" onchange="upRow('${key}','rake',this.value)" placeholder="Rake ID" style="width:100%">
                    </td>
                    <td>
                        <select onchange="upRow('${key}','type',this.value)" style="width:100%">
                            <option value="">Select...</option>
                            <option value="BHEL" ${val.type === 'BHEL' ? 'selected' : ''}>BHEL</option>
                            <option value="MEDHA" ${val.type === 'MEDHA' ? 'selected' : ''}>MEDHA</option>
                            <option value="DALIAN" ${val.type === 'DALIAN' ? 'selected' : ''}>DALIAN</option>
                            <option value="CRRC" ${val.type === 'CRRC' ? 'selected' : ''}>CRRC</option>
                        </select>
                    </td>
                    <td>
                        <input value="${val.f || ''}" onchange="upRow('${key}','f',this.value)" placeholder="Front" style="width:100%">
                    </td>
                    <td>
                        <input value="${val.r || ''}" onchange="upRow('${key}','r',this.value)" placeholder="Rear" style="width:100%">
                    </td>
                    <td style="text-align:center;">
                        <button class="danger" onclick="delRow('${key}')">X</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += html;
        });
    });
};
window.submitStationData = async () => {
    const btn = document.getElementById("btnFinalSubmit");
    btn.innerText = "‚è≥ Saving...";
    btn.disabled = true;

    try {
        const lineSel = document.getElementById("lineSelect");
        const stnSel = document.getElementById("stationSelect");
        
        if (!lineSel.value || !stnSel.value) throw new Error("No station selected.");

        const fullStationName = `${stnSel.value} (${lineSel.value})`;

        const formData = {
            name: fullStationName,
            len: document.getElementById("inpStationLength").value,
            yl: document.getElementById("inpYellowDist").value,
            th: document.getElementById("inpYellowThick").value,
            remarks: document.getElementById("inpRemarks").value,
            impl: document.getElementById("inpImplementation").value,
            user: currentUser.email,
            userName: currentUser.name,
            date: new Date().toLocaleString('en-IN'), 
            timestamp: serverTimestamp()
        };

        const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/rows`));
        const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

        const updates = {};
        let targetKey = currentStationKey;
        let targetRakeKey = currentRakeKey;

        if (targetKey) {
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        } else {
            targetKey = push(ref(db, "station_logs")).key;
            targetRakeKey = targetKey; 
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        }

        updates[`rake_logs/${targetRakeKey}`] = rowsData || null;

        await update(ref(db), updates);
        await remove(ref(db, `drafts/${currentUser.uid}`));
        
        alert(`‚úÖ Saved: ${stnSel.value}`);
        
        // 1. Clear everything
        await nuclearReset(); 
        document.getElementById("mainDataForm").classList.add("hidden");
        document.getElementById("stationSelect").value = "";

        // 2. Switch Tab BUT DO NOT LOAD TABLE
        switchTab('dataView');

    } catch(e) {
        console.error(e);
        alert("‚ùå ERROR: " + e.message);
    } finally {
        if(btn) {
            btn.innerText = "‚úî Submit to Master Database";
            btn.disabled = false;
        }
    }
};
// GLOBAL VARIABLES to track active listeners
// (This prevents duplicate connections when you click Refresh)
let adminUsersListener = null;
let adminStatusListener = null;
// =========================================================
// üõ†Ô∏è FIXED: ADMIN PANEL (Anti-Flicker & Stable Status)
// =========================================================
window.loadAdminPanel = () => {
    const tbody = document.getElementById("userListBody");
    const checkboxList = document.getElementById("userCheckboxList");

    if (!tbody || !checkboxList) return;

    // --- NEW: CENTRALIZED PIN SYNC ---
    // Fetches the active system PIN so the Admin can see it
    get(ref(db, "system_settings/master_pin")).then(snap => {
        const pinDisplay = document.getElementById("displayCurrentPin");
        if (pinDisplay) {
            pinDisplay.value = snap.exists() ? snap.val() : "1234";
        }
    }).catch(e => console.error("PIN Sync Error:", e));

    // 1. CLEANUP (Stop previous listeners to prevent memory leaks/loops)
    if (adminUsersListener) { if (typeof adminUsersListener === "function") adminUsersListener(); adminUsersListener = null; }
    if (adminStatusListener) { if (typeof adminStatusListener === "function") adminStatusListener(); adminStatusListener = null; }

    // Clear any existing periodic render loops
    if (window.adminRenderInterval) clearInterval(window.adminRenderInterval);

    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-sync fa-spin'></i> Syncing...</td></tr>";
    
    let localUsers = {};
    let localStatus = {};

    const renderTable = () => {
        tbody.innerHTML = "";
        checkboxList.innerHTML = "";

        if (!localUsers || Object.keys(localUsers).length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>No users found.</td></tr>";
            return;
        }

        const NOW = Date.now(); 

        Object.entries(localUsers).forEach(([uid, u]) => {
            if (!u.email) return;

            const isSelf = (uid === currentUser.uid);
            const isBanned = u.banned === true;
            const hasBiometrics = !!u.faceData; 

            // --- STABILIZED STATUS LOGIC ---
            const s = localStatus[uid];
            let isOnline = false;
            let lastSeenText = "Never";

            if (s && s.last_seen) {
                const diff = NOW - s.last_seen; 
                const isRecent = diff < 35000; // 35 second tolerance for slow networks

                if (diff < 10000) {
                    isOnline = true; 
                } 
                else if (isRecent && s.state !== 'offline') {
                    isOnline = true;
                }
                lastSeenText = new Date(s.last_seen).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            // --- BADGE UI ---
            let statusBadge = "";
            if (isOnline) {
                statusBadge = hasBiometrics 
                    ? `<span class="badge-online" style="background:#dcfce7; color:#166534; border:1px solid #bbf7d0;">üü¢ Online</span>`
                    : `<span style="background:#fff7ed; color:#c2410c; padding:4px 10px; border-radius:12px; font-size:10px; font-weight:800; border:1px solid #fdba74;">üü° Setup Pending</span>`;
            } else {
                statusBadge = `<span class="badge-offline">‚ö´ Offline (${lastSeenText})</span>`;
            }

            const bioStatus = hasBiometrics 
                ? `<span style="color:green; font-weight:bold; font-size:11px;">‚úî Registered</span>` 
                : `<span style="color:red; font-weight:bold; font-size:11px;">‚ö† Missing</span>`;

            // --- ADMIN BUTTONS ---
            let actionBtns = `
                <button class="info" onclick="viewUserTasks('${uid}', '${encodeURIComponent(u.name || u.email)}')" style="padding:4px 8px; font-size:10px; margin-right:2px;" title="View Tasks"><i class="fas fa-tasks"></i></button>
                <button class="secondary" onclick="resetUserName('${uid}')" style="padding:4px 8px; font-size:10px; margin-right:2px;" title="Reset Name"><i class="fas fa-eraser"></i></button>
                <button class="warning" onclick="resetUserFace('${uid}')" style="padding:4px 8px; font-size:10px; margin-right:2px;" title="Reset Face ID"><i class="fas fa-user-slash"></i></button>
            `;

            if (!isSelf) {
                if (isBanned) {
                    actionBtns += `<button class="success" onclick="unbanUser('${uid}', '${encodeURIComponent(u.name || u.email)}')" style="padding:4px 8px; font-size:10px;">‚ôª Unban</button>`;
                } else {
                    actionBtns += `<button class="danger" onclick="openBanModal('${uid}', '${encodeURIComponent(u.name || u.email)}')" style="padding:4px 8px; font-size:10px;">‚õî Ban</button>`;
                }
            }

            // --- RENDER TABLE ROW ---
            const rowStyle = isBanned ? "background:#fee2e2;" : "";
            tbody.innerHTML += `
                <tr style="${rowStyle}">
                    <td>
                        <div style="font-weight:bold; color:var(--metro-blue); font-size:13px;">
                            ${u.name || 'Unknown'} 
                            ${isSelf ? '<span style="font-size:9px; background:#e2e8f0; padding:2px 4px; border-radius:3px;">YOU</span>' : ''}
                        </div>
                        <div style="font-size:10px; color:#64748b;">${u.email}</div>
                        ${isBanned ? '<div style="color:red; font-size:9px; font-weight:bold;">‚õî ACCESS REVOKED</div>' : ''}
                    </td>
                    <td style="vertical-align:middle;">${statusBadge}</td>
                    <td style="vertical-align:middle; font-size:11px; color:#334155;">-</td>
                    <td style="vertical-align:middle;">${bioStatus}</td>
                    <td style="vertical-align:middle;">
                        <div style="display:flex;">${actionBtns}</div>
                    </td>
                </tr>
            `;

            if (!isBanned) {
                const checkId = `chk_user_${uid}`;
                checkboxList.innerHTML += `
                    <label class="checkbox-item" for="${checkId}" style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <input type="checkbox" id="${checkId}" class="user-check" value="${uid}">
                            <span style="font-weight:600; font-size:12px;">${u.name || u.email}</span>
                        </div>
                        <span style="font-size:10px;">${isOnline ? 'üü¢' : '‚ö´'}</span>
                    </label>
                `;
            }
        });
    };

    // 2. START LISTENERS
    adminUsersListener = onValue(ref(db, "users"), (snap) => {
        if (snap.exists()) localUsers = snap.val();
        renderTable();
    });

    adminStatusListener = onValue(ref(db, "status"), (snap) => {
        if (snap.exists()) localStatus = snap.val();
        renderTable();
    });
    
    // 3. PERIODIC RE-RENDER (To keep "Time Ago" or "Offline" text accurate)
    window.adminRenderInterval = setInterval(renderTable, 10000); 
};
window.viewRakeRows = (rowsEncoded, stationName) => {
    try {
        const rows = JSON.parse(decodeURIComponent(rowsEncoded));
        let msg = `DETAILS FOR: ${stationName}\n\n`;
        msg += `SL | RAKE | TYPE | FRONT | REAR\n`;
        msg += `--------------------------------\n`;
        
        // Loop through the rows object
        let count = 1;
        for (let key in rows) {
            let r = rows[key];
            msg += `${count}. ${r.rake || '-'} | ${r.type || '-'} | ${r.f || '-'} | ${r.r || '-'}\n`;
            count++;
        }
        alert(msg);
    } catch(e) {
        console.error(e);
        alert("Error reading row data.");
    }
};

// --- SEARCH FILTER ---
window.filterStationData = () => {
    const input = document.getElementById("stationLogSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("station-row-item");
    
    Array.from(rows).forEach(row => {
        const stationName = row.cells[1].innerText.toLowerCase(); // Search Station Name
        const submittedBy = row.cells[2].innerText.toLowerCase(); // Search User Name
        
        if (stationName.includes(input) || submittedBy.includes(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};
// List of allowed admin emails (LOWERCASE)
  function checkAdminStatus() {
    const ADMINS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
    
    if (currentUser && ADMINS.includes(currentUser.email.toLowerCase())) {
        isAdmin = true;
        // Force the tab button to show
        const btnAdmin = document.getElementById("btnAdmin");
        const badge = document.getElementById("adminBadge");
        if(btnAdmin) btnAdmin.classList.remove("hidden");
        if(badge) badge.classList.remove("hidden");
        console.log("‚úÖ Admin Mode Active for:", currentUser.email);
    } else {
        isAdmin = false;
        console.log("üë§ User Mode Active for:", currentUser.email);
    }
}
function handleFail() {
    failCount++;
    if(failCount >= 3) {
        stopCamera();
        document.getElementById("faceModal").classList.remove("hidden");
        document.getElementById("videoContainer").classList.add("hidden");
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden");
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${3 - failCount}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            await recordLogin("PIN Entry");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

function enterApp() {
    stopCamera();
    document.getElementById("faceModal").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    
    // Load Tabs
    switchTab('newData');
    loadDraft(); 
    loadGallery(); 
    loadInventory(); 
    loadAssignments();

    // --- FIX: START THE TIMER NOW ---
    setupIdleTimer(); 
}
// --- FIXED TOGGLE FUNCTION (Crash-Free for Checkout & Return) ---
window.toggleInvMode = (mode) => {
    // 1. Hide All Panels
    document.getElementById("inv-add").classList.add("hidden");
    document.getElementById("inv-checkout").classList.add("hidden");
    document.getElementById("inv-return").classList.add("hidden");
    document.getElementById("inv-history").classList.add("hidden");
    document.getElementById("inv-list").classList.add("hidden");
    
    // 2. Show the Selected Panel
    const targetPanel = document.getElementById(`inv-${mode}`);
    if(targetPanel) targetPanel.classList.remove("hidden");
    
    // 3. (REMOVED) Old Dropdown Logic
    // We strictly removed the calls to 'populateCheckoutSelect' 
    // and 'populateReturnSelect' here. 
    // This stops the "innerHTML of null" error completely.

    // 4. Special Focus Logic for History Tab
    if(mode === 'history') {
        setTimeout(() => {
             const searchInput = document.getElementById("auditSearchInput");
             if(searchInput) searchInput.focus();
        }, 100);
    }
};
// 1. POPULATE CHECKOUT (Show All Items)
function populateCheckoutSelect() {
    const sel = document.getElementById("checkoutSelect");
    sel.innerHTML = "<option value=''>Loading...</option>";
    onValue(ref(db, "inventory"), snap => {
        sel.innerHTML = "<option value=''>Select Item...</option>";
        snap.forEach(c => {
            const v = c.val();
            const opt = document.createElement("option");
            opt.value = c.key;
            opt.text = `${v.item} (Avail: ${v.qty})`;
            opt.dataset.qty = v.qty;
            opt.dataset.name = v.item;
            // NEW: STORE BARCODE
            if(v.barcode) opt.dataset.barcode = v.barcode;
            sel.appendChild(opt);
        });
    }, { onlyOnce: true });
}

// 2. POPULATE RETURN (Show Only Items You Hold)
async function populateReturnSelect() {
    const sel = document.getElementById("returnSelect");
    sel.innerHTML = "<option value=''>Calculating your holdings...</option>";

    try {
        // A. Get current Inventory (for keys)
        const invSnap = await get(ref(db, "inventory"));
        const inventoryMap = {}; // Maps ItemName -> { key, exists, barcode }
        invSnap.forEach(c => {
            const val = c.val();
            inventoryMap[val.item] = { key: c.key, exists: true, barcode: val.barcode };
        });

        // B. Get User Logs
        const logsSnap = await get(query(ref(db, "logs")));
        const myHoldings = {}; // ItemName -> NetQuantity

        logsSnap.forEach(c => {
            const l = c.val();
            // Check if this log belongs to current user
            const isMe = (l.takenBy === currentUser.name) || (l.takenBy === currentUser.email);
            
            if (isMe) {
                if(l.type === 'CHECKOUT') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) + parseInt(l.qty);
                } else if (l.type === 'RETURN') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) - parseInt(l.qty);
                }
            }
        });

        // C. Render
        sel.innerHTML = "<option value=''>Select Item...</option>";
        let foundAny = false;

        for (const [itemName, netQty] of Object.entries(myHoldings)) {
            if (netQty > 0 && inventoryMap[itemName]) {
                foundAny = true;
                const opt = document.createElement("option");
                opt.value = inventoryMap[itemName].key; // Use inventory key for update
                opt.text = `${itemName} (You have: ${netQty})`;
                opt.dataset.qty = netQty; // Max returnable
                opt.dataset.name = itemName;
                // NEW: STORE BARCODE
                if(inventoryMap[itemName].barcode) opt.dataset.barcode = inventoryMap[itemName].barcode;
                sel.appendChild(opt);
            }
        }

        if(!foundAny) {
            sel.innerHTML = "<option value=''>No items to return.</option>";
        }

    } catch (e) {
        console.error(e);
        sel.innerHTML = "<option>Error loading.</option>";
    }
}
window.updateMasterPin = async () => {
    const newPin = document.getElementById("newPinInput").value.trim();

    if (!/^\d{4}$/.test(newPin)) {
        return alert("‚ö†Ô∏è INVALID PIN: Enter exactly 4 digits.");
    }

    if (!confirm("Confirm changing the GLOBAL Master PIN? Users using '1234' will be blocked immediately.")) return;

    try {
        // Save to a central "settings" node instead of a specific user
        await set(ref(db, "system_settings/master_pin"), newPin);
        
        alert("‚úÖ GLOBAL PIN UPDATED: " + newPin);
        document.getElementById("displayCurrentPin").value = newPin;
        document.getElementById("newPinInput").value = "";
    } catch(e) {
        alert("Database Error: " + e.message);
    }
};
window.updateMaxQty = () => {
    const isCheckout = !document.getElementById("inv-checkout").classList.contains("hidden");
    const selId = isCheckout ? "checkoutSelect" : "returnSelect";
    const inpId = isCheckout ? "checkoutAvail" : "returnAvail";
    
    const sel = document.getElementById(selId);
    const opt = sel.options[sel.selectedIndex];
    
    if(opt && opt.dataset.qty) {
        document.getElementById(inpId).value = opt.dataset.qty;
    } else {
        document.getElementById(inpId).value = "";
    }
};

// --- NEW HISTORY LOADING LOGIC (FIXED) ---

function formatTime(ts) {
    if (!ts) return "N/A";
    const d = new Date(ts);
    
    // Convert to Indian Standard Time (Asia/Kolkata)
    return d.toLocaleString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}
// --- LINEAR HISTORY LOGIC (SIMPLE LIST + BARCODES) ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Retrieving Secure Records...</td></tr>";

    // Fetch last 300 logs
    const q = query(ref(db, "logs"), limitToLast(300));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); // Show newest events at the top

        // Filter: Show only inventory-related events
        const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE');

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded in recent history.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        
        invLogs.forEach(l => {
            // Badge Styling
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            // Barcode formatting
            const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px;">||| ${l.barcode}</div>` : '';

            // Row HTML
            const row = `
            <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
                <td style="font-weight:bold; color:#003366;">${l.barcode || '--'}</td>
                <td style="font-weight:bold;">${l.takenBy || 'Unknown'}</td>
                <td>
                    ${formatTime(l.time)}<br>
                    <small style="color:#555;">Auth: ${l.approvedBy || 'System'}</small>
                </td>
                <td style="text-align:center;">${badge}</td>
                <td>
                    <span style="font-size:13px;">${l.item}</span>
                </td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    }, { onlyOnce: true });
};
// --- NEW SEARCH FUNCTION FOR INVENTORY ---
window.filterInvLogs = () => {
    const input = document.getElementById("invSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("inv-log-row");
   
    Array.from(rows).forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
};
// --- UPDATED SUBMIT FUNCTION (COMBINED LOCATION LOGIC) ---
window.submitTransactionNoFace = (type) => {
    if(!pendingTransactionItem) return alert("Please SCAN an item first.");
    
    // --- CHECKOUT VALIDATION ---
    if(type === 'CHECKOUT') {
        const purpose = document.getElementById("checkoutPurpose").value;
        if(!purpose || purpose.trim() === "") return alert("Please enter the PURPOSE for this checkout.");
    }
    
    // --- RETURN VALIDATION & FORMATTING ---
    let finalLocation = "";
    
    if(type === 'RETURN') {
        // 1. Get Main Place
        const selection = document.getElementById("returnLocSelect").value;
        let mainPlace = selection;
        
        if(selection === "Other") {
            const otherText = document.getElementById("returnLocOther").value.trim();
            if(!otherText) return alert("Please specify the 'Other' location name.");
            mainPlace = otherText;
        }

        // 2. Get Specific Spot (Cabinet/Almirah)
        const spot = document.getElementById("returnLocSpot").value.trim();
        if(!spot) return alert("Please specify the Exact Spot (e.g., Cabinet, Almirah).");

        // 3. Combine them
        // Format: "D2 Building - Heerok Sir Lab [Upper Cabinet]"
        finalLocation = `${mainPlace} [${spot}]`;
    }

    scanMode = 'DIRECT'; 
    currentTransactionType = type;
    
    // Pass the calculated location to the processor
    processTransaction("Self/System", finalLocation);
};
// --- UPDATED TRANSACTION LOGIC ---
// --- UPDATED PROCESSOR TO ACCEPT LOCATION ARGUMENT ---
async function processTransaction(adminName, customReturnLocation = null) {
    const isCheckout = currentTransactionType === 'CHECKOUT';
    
    if(!pendingTransactionItem) return alert("System Error: No item scanned.");

    const itemKey = pendingTransactionItem.key;
    const itemName = pendingTransactionItem.item;
    const barcode = pendingTransactionItem.barcode;

    // Get Checkout Purpose (if applicable)
    const purposeInput = isCheckout ? document.getElementById("checkoutPurpose").value : null;

    // 1. Fetch Fresh Data
    const invRef = ref(db, `inventory/${itemKey}`);
    const invSnap = await get(invRef);
    
    if(!invSnap.exists()) return alert("Item vanished from DB.");
    
    const val = invSnap.val();
    const currentStatus = val.status;
    const currentUsage = val.usageCount || 0; 

    // 2. Logic Gates
    if(isCheckout && currentStatus === 'Checked Out') return alert(`Item already taken by: ${val.holder}`);
    if(!isCheckout && currentStatus === 'In Stock') return alert(`Item is already in the store.`);

    // 3. Prepare Update Data
    const uSnap = await get(ref(db, `users/${currentUser.uid}`));
    const realUserName = uSnap.val()?.name || currentUser.email;

    let updateData = {};

    if (isCheckout) {
        // CHECKOUT
        updateData = {
            status: "Checked Out",
            holder: realUserName,
            purpose: purposeInput,
            location: "Out with User", 
            usageCount: currentUsage + 1 
        };
    } else {
        // RETURN - USE THE CUSTOM LOCATION WE BUILT
        updateData = {
            status: "In Stock",
            holder: "Store",
            purpose: null,
            location: customReturnLocation // Saves "D2 Lab [Cabinet]"
        };
    }

    // 4. Update Database
    await update(invRef, updateData);

    // 5. Log It
    const logData = {
        type: currentTransactionType,
        item: itemName,
        barcode: barcode,
        qty: 1,
        takenBy: realUserName,
        approvedBy: "Direct (No Admin)",
        location: isCheckout ? "Out" : customReturnLocation, 
        purpose: isCheckout ? purposeInput : "Return",
        time: serverTimestamp()
    };

    await push(ref(db, "logs"), logData);
    
    alert(`‚úÖ ${currentTransactionType} Successful!\nItem: ${itemName}`);
    
    // Clear Inputs
    if(document.getElementById("checkoutPurpose")) document.getElementById("checkoutPurpose").value = "";
    if(document.getElementById("returnLocOther")) document.getElementById("returnLocOther").value = "";
    if(document.getElementById("returnLocSpot")) document.getElementById("returnLocSpot").value = "";

    // UI Cleanup
    document.getElementById("checkout_display").classList.add("hidden");
    document.getElementById("return_display").classList.add("hidden");
    pendingTransactionItem = null;
    toggleInvMode('list');
}
// --- NEW HELPER: POPULATE USER DROPDOWN ---
window.populateUserDropdown = async () => {
    const sel = document.getElementById("selPrintInspector");
    
    // 1. Reset with "Self" option (Convenience)
    const currentName = currentUser.name || currentUser.email;
    sel.innerHTML = `<option value="">-- Select Member --</option>
                     <option value="Self">Self (${currentName})</option>
                     <optgroup label="All Registered Users:">`;

    // 2. Fetch all users from DB
    try {
        const snap = await get(ref(db, "users"));
        if (snap.exists()) {
            snap.forEach(c => {
                const u = c.val();
                const uName = u.name || u.email; // Use email if name is missing
                
                // Add to dropdown
                const opt = document.createElement("option");
                opt.value = uName;
                opt.innerText = uName;
                sel.appendChild(opt);
            });
        }
    } catch (e) {
        console.error("Error loading users:", e);
        sel.innerHTML += `<option disabled>Error loading users</option>`;
    }
};
window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    if(!name) return alert("Station Name Required");
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name,
        len: document.getElementById("inpStationLength").value,
        yl: document.getElementById("inpYellowDist").value,
        th: document.getElementById("inpYellowThick").value,
        remarks: document.getElementById("inpRemarks").value
    });
    alert("Draft Saved");
};
// --- 1. HANDLE LOG LINE CHANGE (Populate Station Dropdown) ---
window.handleLogLineChange = () => {
    const lineSel = document.getElementById("logLineSelect");
    const stnSel = document.getElementById("logStationSelect");
    const resultsDiv = document.getElementById("logResultsPanel");
    
    // Reset
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    resultsDiv.classList.add("hidden");

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        // Populate Stations using the existing METRO_STATIONS data
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        
        stnSel.disabled = false;
        stnSel.style.background = "#fff";
    }
};
window.loadSpecificStationData = async () => {
    const stnSel = document.getElementById("logStationSelect");
    const lineSel = document.getElementById("logLineSelect");
    const resultsDiv = document.getElementById("logResultsPanel");
    
    // 1. IDENTIFY THE TABLE BODY CORRECTLY
    const tbody = document.getElementById("viewTable1Body") || document.getElementById("stationDataViewBody");
    if (!tbody) return console.error("Table Body missing!");

    // 2. CLEAR UI & SHOW LOADING
    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>üîç Searching Database...</td></tr>";
    resultsDiv.classList.remove("hidden");

    if (!stnSel.value || !lineSel.value) return;
    
    // 3. STRICT SEARCH PARAMETER
    const searchName = `${stnSel.value} (${lineSel.value})`; 

    // 4. PRECISE DATABASE QUERY
    const q = query(ref(db, "station_logs"), orderByChild("name"), equalTo(searchName));
    
    try {
        const snap = await get(q);
        tbody.innerHTML = ""; // Wipe "Loading..." message
        
        if (!snap.exists()) {
            tbody.innerHTML = `<tr><td colspan='8' style='text-align:center; color:red; font-weight:bold;'>‚ùå No records found for ${stnSel.value}</td></tr>`;
            return;
        }

        // 5. RENDER ONLY MATCHING RECORDS
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        
        // Sort by Newest First
        logs.sort((a, b) => b.timestamp - a.timestamp);

        logs.forEach(d => {
             let buttonsHtml = `<button onclick="openRakeModal('${d.key}')" class="info" style="padding:2px 6px; font-size:11px; margin-right:4px;">üìÑ View Table</button>`;
             
             // Admin & Owner Controls
             if (isAdmin || d.user === currentUser.email) {
                buttonsHtml += `<button class="warning" onclick="editStationLog('${d.key}')" style="padding:2px 6px; font-size:11px; margin-right:4px;">‚úèÔ∏è Edit</button>`;
             }
             if (isAdmin) {
                buttonsHtml += `<button class="danger" onclick="deleteStationLog('${d.key}')" style="padding:2px 6px; font-size:11px;">üóë</button>`;
             }

             const row = `
            <tr>
                <td style="font-size:12px;">${d.date}</td>
                <td style="font-size:12px;">${d.userName}</td>
                <td style="font-weight:bold;">${d.len || '-'} m</td>
                <td style="font-weight:bold; color:#e31e24;">${d.yl || '-'} cm</td>
                <td>${d.th || '-'} cm</td>
                <td style="text-align:center; font-weight:bold;">
                    ${d.impl === 'YES' ? '<span style="color:green">‚úÖ YES</span>' : (d.impl === 'NO' ? '<span style="color:red">‚ùå NO</span>' : '-')}
                </td>
                <td style="font-style:italic; font-size:12px;">${d.remarks || '--'}</td>
                <td style="white-space:nowrap;">${buttonsHtml}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan='8' style='color:red;'>Connection Error: ${e.message}</td></tr>`;
    }
};
// 2. NEW: Function to open the Rake Data in a POPUP MODAL
window.openRakeModal = async (key) => {
    const modal = document.getElementById("rakeDataModal");
    const tbody = document.getElementById("modalRakeBody");
    
    // Show Modal immediately
    modal.classList.remove("hidden");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>‚è≥ Fetching Rake Data...</td></tr>";

    try {
        // First get the station log to find the linkedRakeKey
        const sSnap = await get(ref(db, `station_logs/${key}`));
        if(!sSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Log not found.</td></tr>";
            return;
        }
        
        const sData = sSnap.val();
        const rakeKey = sData.linkedRakeKey || key;

        // Fetch the Rake Data
        const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
        
        if(!rSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#666;'>No Rake Clearance Data recorded for this entry.</td></tr>";
            return;
        }

        // Populate Modal Table
        tbody.innerHTML = "";
        const rows = rSnap.val();
        let count = 1;
        
        Object.values(rows).forEach(r => {
            const html = `
                <tr>
                    <td style="text-align:center;">${count++}</td>
                    <td style="font-weight:bold;">${r.rake || '-'}</td>
                    <td>${r.type || '-'}</td>
                    <td>${r.f || '-'}</td>
                    <td>${r.r || '-'}</td>
                    <td style="text-align:center;">${r.act || '-'}</td>
                </tr>
            `;
            tbody.innerHTML += html;
        });

    } catch(e) {
        console.error(e);
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
    }
};

// 3. Ensure Close Function Exists
window.closeRakeModal = () => {
    document.getElementById("rakeDataModal").classList.add("hidden");
};
// 2. NEW: Function to open the Rake Data in the MODAL
window.openRakeModal = async (key) => {
    const modal = document.getElementById("rakeDataModal");
    const tbody = document.getElementById("modalRakeBody");
    
    // Show Modal immediately
    modal.classList.remove("hidden");
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>‚è≥ Fetching Rake Data...</td></tr>";

    try {
        // First get the station log to find the linkedRakeKey
        const sSnap = await get(ref(db, `station_logs/${key}`));
        if(!sSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Log not found.</td></tr>";
            return;
        }
        
        const sData = sSnap.val();
        const rakeKey = sData.linkedRakeKey || key;

        // Fetch the Rake Data
        const rSnap = await get(ref(db, `rake_logs/${rakeKey}`));
        
        if(!rSnap.exists()) {
            tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#666;'>No Rake Clearance Data recorded for this entry.</td></tr>";
            return;
        }

        // Populate Modal Table
        tbody.innerHTML = "";
        const rows = rSnap.val();
        let count = 1;
        
        Object.values(rows).forEach(r => {
            const html = `
                <tr>
                    <td style="text-align:center;">${count++}</td>
                    <td style="font-weight:bold;">${r.rake || '-'}</td>
                    <td>${r.type || '-'}</td>
                    <td>${r.f || '-'}</td>
                    <td>${r.r || '-'}</td>
                    <td style="text-align:center;">${r.act || '-'}</td>
                </tr>
            `;
            tbody.innerHTML += html;
        });

    } catch(e) {
        console.error(e);
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:red;'>Error loading data.</td></tr>";
    }
};
// --- 3. SUBMIT FUNCTION (Saves Station-Wise to Master DB) ---
window.submitStationData = async () => {
    const btn = document.getElementById("btnFinalSubmit");
    btn.innerText = "‚è≥ Saving to Master DB...";
    btn.disabled = true;

    try {
        const lineSel = document.getElementById("lineSelect");
        const stnSel = document.getElementById("stationSelect");
        
        // 1. Double Check: Ensure we have a valid station selected
        if (!lineSel.value || !stnSel.value) {
            throw new Error("No station selected. Please refresh.");
        }

        const fullStationName = `${stnSel.value} (${lineSel.value})`;

        // 2. Gather UI Inputs
        const formData = {
            name: fullStationName,
            len: document.getElementById("inpStationLength").value,
            yl: document.getElementById("inpYellowDist").value,
            th: document.getElementById("inpYellowThick").value,
            remarks: document.getElementById("inpRemarks").value,
            impl: document.getElementById("inpImplementation").value,
            user: currentUser.email,
            userName: currentUser.name,
            date: new Date().toLocaleString(),
            timestamp: serverTimestamp()
        };

        // 3. Fetch Your Draft Rows (The Rake Table)
        const rowsSnap = await get(ref(db, `drafts/${currentUser.uid}/rows`));
        const rowsData = rowsSnap.exists() ? rowsSnap.val() : null;

        const updates = {};
        let targetKey = currentStationKey;
        let targetRakeKey = currentRakeKey;

        // 4. Logic: Are we Updating or Creating?
        if (targetKey) {
            // --- UPDATING EXISTING MASTER RECORD ---
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        } else {
            // --- CREATING NEW MASTER RECORD ---
            targetKey = push(ref(db, "station_logs")).key;
            targetRakeKey = targetKey; // Link them
            updates[`station_logs/${targetKey}`] = { ...formData, linkedRakeKey: targetRakeKey };
        }

        // 5. OVERWRITE RAKE LOGS
        // We replace the Public Rake Logs with exactly what is in your Draft table
        // This ensures the Master DB matches your screen exactly.
        updates[`rake_logs/${targetRakeKey}`] = rowsData || null;

        // 6. COMMIT TO DATABASE
        await update(ref(db), updates);

        // 7. CLEANUP: Delete your private draft
        // This ensures your personal data doesn't persist. 
        // The data is now fully "Station-Wise" in the shared DB.
        await remove(ref(db, `drafts/${currentUser.uid}`));
        
        alert(`‚úÖ SUCCESS: Data for ${stnSel.value} saved to Master Database.`);
        
        // 8. Refresh and Close
        document.getElementById("distanceBody").innerHTML = ""; 
        switchTab('dataView');
        loadStationData(); 
        
        // Reset inputs to prevent accidental double submission
        await nuclearReset();
        document.getElementById("mainDataForm").classList.add("hidden");
        document.getElementById("stationSelect").value = "";

    } catch(e) {
        console.error(e);
        alert("‚ùå ERROR: " + e.message);
    } finally {
        btn.innerText = "‚úî Submit to Master Database";
        btn.disabled = false;
    }
};
// 3. Ensure Close Function Exists
window.closeRakeModal = () => {
    document.getElementById("rakeDataModal").classList.add("hidden");
};
window.editStationLog = async (key) => {
    if (!confirm("‚úèÔ∏è Edit this record?")) return;

    try {
        // 1. Fetch Station Data
        const stationSnap = await get(ref(db, `station_logs/${key}`));
        if (!stationSnap.exists()) return alert("Record not found.");
        const sData = stationSnap.val();

        // 2. Set Global Editing Keys
        currentStationKey = key;
        currentRakeKey = sData.linkedRakeKey || key;

        // 3. CLEAN UP DRAFTS (Fixes the "Double Rows" bug)
        // We wipe the draft folder clean before loading data
        await remove(ref(db, `drafts/${currentUser.uid}`));
        document.getElementById("distanceBody").innerHTML = "";

        // 4. Switch to Form Tab
        switchTab('newData');
        document.getElementById("mainDataForm").classList.remove("hidden");
        document.getElementById("dataExistsWarning").classList.add("hidden"); // Hide the "Locked" warning

        // 5. Fill Station Details & UNLOCK THEM
        document.getElementById("inpStationName").value = sData.name;
        document.getElementById("formTitle").innerText = `‚úèÔ∏è EDITING: ${sData.name}`;
        
        const inpLen = document.getElementById("inpStationLength");
        const inpYl = document.getElementById("inpYellowDist");
        const inpTh = document.getElementById("inpYellowThick");
        const inpRem = document.getElementById("inpRemarks");
        const inpImpl = document.getElementById("inpImplementation");

        inpLen.value = sData.len || "";
        inpYl.value = sData.yl || "";
        inpTh.value = sData.th || "";
        inpRem.value = sData.remarks || "";
        inpImpl.value = sData.impl || "";

        // Unlock inputs so you can edit Yellow Line details
        inpLen.disabled = false;
        inpYl.disabled = false;
        inpTh.disabled = false;
        inpRem.disabled = false;
        inpImpl.disabled = false;
        document.getElementById("btnSaveDraft").disabled = false;

        // 6. Update Submit Button
        const submitBtn = document.getElementById("btnFinalSubmit");
        submitBtn.innerText = "üíæ Save Changes";
        submitBtn.disabled = false;
        submitBtn.style.background = "#ffc107"; // Orange
        submitBtn.style.color = "#000";
        submitBtn.style.cursor = "pointer";

        // 7. Load Rake Data (Exactly as it is in DB)
        const rakeSnap = await get(ref(db, `rake_logs/${currentRakeKey}`));
        if (rakeSnap.exists()) {
            // Copy exact DB rows to Drafts
            await set(ref(db, `drafts/${currentUser.uid}/rows`), rakeSnap.val());
        }

        // 8. Render Table
        loadDraft();

    } catch (e) {
        console.error(e);
        alert("Error loading for edit: " + e.message);
    }
};

async function hardResetForm() {
    // A. Wipe Visual Inputs
    document.getElementById("inpStationLength").value = "";
    document.getElementById("inpYellowDist").value = "";
    document.getElementById("inpYellowThick").value = "";
    document.getElementById("inpRemarks").value = "";
    document.getElementById("inpImplementation").value = "";
    document.getElementById("distanceBody").innerHTML = ""; // Clear Rake Table
    
    // B. Clear Global Key variables
    currentStationKey = null;
    currentRakeKey = null;

    // C. CRITICAL: Wipe the 'Draft' node in Firebase for this user
    // This ensures data from the previous station doesn't persist
    if(currentUser) {
        await remove(ref(db, `drafts/${currentUser.uid}`));
    }
}
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
};
window.deleteUserTask = (uid, taskKey) => {
    if(confirm("Are you sure you want to remove this task?")) {
        remove(ref(db, `assignments/${uid}/${taskKey}`))
            .then(() => {
                // View updates automatically via listener
            })
            .catch(err => alert("Error: " + err.message));
    }
};
// ==========================================
// 2. CRASH-PROOF AUTH LISTENER (GENERIC ONBOARDING)
// ==========================================
onAuthStateChanged(auth, (user) => {
    // A. NOT LOGGED IN
    if (!user) { 
        showLoginScreen(); 
        return; 
    }

    currentUser = user;
    startPresenceSystem(user);  

    // B. LOGGED IN - DATA SYNC ONLY
    const userRef = ref(db, `users/${user.uid}`);
    
    onValue(userRef, (snap) => {
        const u = snap.val();

        // 1. New User Detection (Still needed for first-time setup)
        if (!u || !u.name) {
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("appScreen").classList.add("hidden");
            document.getElementById("nameModal").classList.remove("hidden");
            return; 
        }

        // 2. Account Status Checks (Security)
        if (u.terminated) { 
            alert("ACCOUNT TERMINATED."); 
            signOut(auth); 
            return; 
        }

        if (u.banned) {
            // Handle Ban Screen UI
            document.querySelector("header").style.display = "none";
            document.getElementById("appScreen").classList.add("hidden");
            document.getElementById("faceModal").classList.add("hidden");
            document.getElementById("bannedScreen").classList.remove("hidden");
            
            document.getElementById("displayBanReason").innerText = u.banReason || "Violation";
            // ... rest of your existing ban display logic ...
            return; 
        }

        // 3. Sync User Data (Silent Sync)
        currentUser.name = u.name;
        isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
        document.getElementById("userInfo").innerText = `${u.name}`;

        // Load Admin Tools Badge
        if (isAdmin) {
            const badge = document.getElementById("adminBadge");
            const btn = document.getElementById("btnAdmin");
            if(badge) badge.classList.remove("hidden");
            if(btn) btn.classList.remove("hidden");
        }

        // --- THE FIX: REMOVED FACE MODAL POPUP FROM HERE ---
        // This function should now only watch for background data changes
        // without interrupting the user's screen.
        
    }, (error) => {
        console.error(error);
        signOut(auth);
    });
});
window.removeFile = async (key) => {
    if(!confirm("‚ö†Ô∏è Delete this file permanently?")) return;
    try {
        await remove(ref(db, `history/${key}`));
        // No alert needed - the list will update automatically!
    } catch(e) {
        alert("Error: " + e.message);
    }
};
// --- 2. ASSIGN TASK (Multi-User) ---
window.assignTaskMulti = async () => {
    const descInput = document.getElementById("taskDesc");
    const desc = descInput.value.trim();
    
    if(!desc) return alert("Please enter task instructions.");

    // Select all checked boxes
    const checkboxes = document.querySelectorAll('.user-check:checked');
    if(checkboxes.length === 0) return alert("Please select at least one personnel.");

    let count = 0;
    const updates = {};

    checkboxes.forEach(cb => {
        const uid = cb.value;
        const newKey = push(ref(db, `assignments/${uid}`)).key;
        
        updates[`assignments/${uid}/${newKey}`] = {
            desc: desc,
            by: currentUser.email,
            date: new Date().toLocaleString(),
            status: "Pending",
            timestamp: serverTimestamp()
        };
        count++;
    });

    try {
        await update(ref(db), updates);
        alert(`‚úÖ Task dispatched to ${count} users.`);
        descInput.value = ""; // Clear input
        checkboxes.forEach(cb => cb.checked = false); // Uncheck all
    } catch(e) {
        alert("Error assigning task: " + e.message);
    }
};

// --- 3. TRACK WORK (View User Tasks) ---
window.viewUserTasks = (uid, name) => {
    // Show Modal
    document.getElementById("adminTaskModal").classList.remove("hidden");
    document.getElementById("modalTaskUserName").innerText = decodeURIComponent(name);
    
    const tbody = document.getElementById("adminTaskBody");
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Fetching Tasks...</td></tr>";

    // Listen to tasks
    onValue(ref(db, `assignments/${uid}`), (snap) => {
        tbody.innerHTML = "";
        
        if(!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#999;'>No active tasks.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const t = c.val();
            const statusBadge = t.status === 'Done' 
                ? `<span style="color:green; font-weight:bold; background:#dcfce7; padding:2px 6px; border-radius:4px;">‚úî DONE</span>` 
                : `<span style="color:#d97706; font-weight:bold; background:#fef3c7; padding:2px 6px; border-radius:4px;">‚è≥ PENDING</span>`;

            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #f1f5f9;">
                    <td style="font-size:12px;">${t.date}</td>
                    <td style="font-weight:600;">${t.desc}</td>
                    <td style="text-align:center;">${statusBadge}</td>
                    <td style="text-align:center;">
                        <button class="danger" onclick="deleteUserTask('${uid}', '${c.key}')" style="font-size:10px; padding:4px 8px;">üóë</button>
                    </td>
                </tr>
            `;
        });
    });
};

// --- 4. DELETE SINGLE TASK ---
window.deleteUserTask = async (uid, taskKey) => {
    if(confirm("Remove this task?")) {
        await remove(ref(db, `assignments/${uid}/${taskKey}`));
    }
};

// --- 5. RESET NAME (Fixes "Not Reset Name") ---
window.resetUserName = async (uid) => {
    if(confirm("‚ö†Ô∏è Reset Name?\n\nThe user will be forced to set their 'Official Name' again on next login.")) {
        try {
            await update(ref(db, `users/${uid}`), { name: null });
            alert("‚úÖ Name Reset. User must re-enter it.");
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
};

// --- 6. RESET FACE (Fixes "Not Reset Face") ---
window.resetUserFace = async (uid) => {
    if(confirm("‚ö†Ô∏è Reset Face ID?\n\nThis deletes their biometric data. They must re-register their face to access the system.")) {
        try {
            await update(ref(db, `users/${uid}`), { faceData: null });
            alert("‚úÖ Face ID Wiped. User must re-register.");
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
};

// --- 7. CLOSE TASK MODAL ---
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
};
// ==============================================
//            FULL BAN SYSTEM LOGIC
// ==============================================

let currentBanTargetUid = null;
let currentBanDays = 0; // Stores days OR 'CUSTOM'

// 1. OPEN MODAL
window.openBanModal = (uid, encodedName) => {
    if(!isAdmin) return alert("Admins Only.");
    if(uid === currentUser.uid) return alert("You cannot ban yourself.");
    
    currentBanTargetUid = uid;
    document.getElementById("banTargetName").innerText = decodeURIComponent(encodedName);
    document.getElementById("adminBanModal").classList.remove("hidden");
    
    // Reset Form
    document.getElementById("banReasonInput").selectedIndex = 0;
    toggleBanOtherInput(); // Hide 'Other' input
    document.getElementById("banReasonOther").value = "";
    document.getElementById("banActionInput").value = "";
    document.getElementById("banRemarks").value = "";
    document.getElementById("banCustomDate").value = "";
    
    // Reset Buttons
    currentBanDays = 0;
    document.querySelectorAll(".ban-btn-select").forEach(b => b.classList.remove("selected"));
};

// 2. CLOSE MODAL
window.closeBanModal = () => {
    document.getElementById("adminBanModal").classList.add("hidden");
    currentBanTargetUid = null;
};

// 4. SUBMIT BAN (MAIN FUNCTION)
window.submitBan = async () => {
    if(!currentBanTargetUid) return;

    // --- STEP A: REASON VALIDATION ---
    let reason = document.getElementById("banReasonInput").value;
    if(reason === "Other") {
        const otherText = document.getElementById("banReasonOther").value.trim();
        if(!otherText) return alert("Please specify the 'Other' reason details.");
        reason = "Other: " + otherText;
    }

    // --- STEP B: ACTION VALIDATION ---
    const actionInst = document.getElementById("banActionInput").value.trim();
    if(!actionInst) return alert("Please enter 'Action Required' (How to dispose this matter).");

    // --- STEP C: DEADLINE CALCULATION ---
    let expiryTimestamp = 0;
    
    if(currentBanDays === 'CUSTOM') {
        const dateVal = document.getElementById("banCustomDate").value;
        if(!dateVal) return alert("Please select a Deadline Date.");
        
        // Set expiry to the END of that day (23:59:59)
        const d = new Date(dateVal);
        d.setHours(23, 59, 59, 999);
        expiryTimestamp = d.getTime();
        
        // Sanity check: Date cannot be in the past
        if(expiryTimestamp < Date.now()) return alert("Deadline cannot be in the past.");
    } 
    else if (typeof currentBanDays === 'number' && currentBanDays > 0) {
        // Calculate future timestamp: Now + (Days * ms)
        expiryTimestamp = Date.now() + (currentBanDays * 24 * 60 * 60 * 1000);
    } 
    else {
        return alert("Please select a valid Tenure/Deadline.");
    }

    const remarks = document.getElementById("banRemarks").value;
    const deadlineDateString = new Date(expiryTimestamp).toLocaleDateString();

    // --- STEP D: CONFIRMATION ---
    if(confirm(`‚ö† CONFIRM BAN?\n\nUser: ${document.getElementById("banTargetName").innerText}\nReason: ${reason}\nDeadline: ${deadlineDateString}\n\nIf the user does not resolve this by the deadline, they will be permanently locked out.`)) {
        try {
            // Update User Profile
            await update(ref(db, `users/${currentBanTargetUid}`), {
                banned: true,
                banReason: reason,
                banAction: actionInst,
                banExpires: expiryTimestamp,
                banRemarks: remarks,
                banDate: serverTimestamp(),
                bannedBy: currentUser.email
            });
            
            // Log to System
            await push(ref(db, "logs"), {
                type: "USER_BAN",
                user: "System",
                details: `Banned UID: ${currentBanTargetUid}`,
                reason: `${reason} | Deadline: ${deadlineDateString}`,
                approvedBy: currentUser.email,
                time: serverTimestamp()
            });

            alert("‚úÖ User Banned Successfully.");
            closeBanModal();
            loadAdminPanel(); // Refresh list
            
        } catch(e) {
            console.error(e);
            alert("Database Error: " + e.message);
        }
    }
};
window.unbanUser = async (uid, name) => {
    if(!isAdmin) return alert("Admins Only.");
    
    if(confirm(`üü¢ Restore access for ${name}?`)) {
        try {
            // We set fields to null to DELETE them from the database
            await update(ref(db, `users/${uid}`), {
                banned: null,
                banReason: null,
                banExpires: null
            });
            alert("‚úÖ User Unbanned Successfully.");
            // Table updates automatically via listener
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
};
window.switchTab = (t) => {
    // 1. SECURITY & UI RESET: Force hide the report preview immediately when switching tabs
    const reportContainer = document.getElementById("printableReportContainer");
    if (reportContainer) {
        reportContainer.classList.add("hidden");
        // Clear innerHTML to prevent the "shadow" of old invoices appearing
        reportContainer.innerHTML = ""; 
    }

    // 2. DEFINE ALL TABS: Added 'warranty' to the list to ensure it's handled
    const allTabs = [
        'newData', 'inventory', 'gallery', 'assigned', 'adminPanel', 
        'dataView', 'printReport', 'funds', 'purchase', 'comments', 
        'directives', 'billing', 'warranty'
    ];

    // 3. HIDE ALL TAB DIVS
    allTabs.forEach(x => {
        const el = document.getElementById(`tab-${x}`);
        if(el) el.classList.add("hidden");
    });

    // 4. RESET NAVIGATION BUTTON STATES
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

    // 5. SHOW THE TARGET TAB
    const targetTab = document.getElementById(`tab-${t}`);
    if(targetTab) {
        targetTab.classList.remove("hidden");
    } else {
        console.error(`Tab 'tab-${t}' not found in HTML structure.`);
    }

    // 6. ACTIVATE THE CORRESPONDING NAV BUTTON
    const activeBtn = document.getElementById('btn' + t.charAt(0).toUpperCase() + t.slice(1));
    if(activeBtn) {
        activeBtn.classList.add("active");
    }

    // 7. TRIGGER DATA LOADERS BASED ON TAB SELECTION
    if (t === 'funds') {
        loadFinanceData();
    } else if (t === 'purchase') {
        loadPurchaseData();
    } else if (t === 'dataView') {
        loadStationData();
    } else if (t === 'comments') {
        populateCommentUsers();
    } else if (t === 'directives') {
        populateDirectiveUsers();
    } else if (t === 'billing') {
        populateBillingAssets();
    } else if (t === 'warranty') {
        toggleWarMode('dash');
    }

    // 8. SCROLL TO TOP: Ensures user doesn't stay at the bottom if the previous tab was long
    window.scrollTo(0, 0);
};

// Paste these two new functions below the switchTab function:
async function populateDirectiveUsers() {
    const list = document.getElementById("dirUserCheckboxList");
    if(!list) return;
    try {
        const snap = await get(ref(db, "users"));
        list.innerHTML = "";
        if (snap.exists()) {
            snap.forEach(c => {
                const uName = c.val().name || c.val().email;
                list.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="dir-user-check" value="${uName}"> ${uName}</label>`;
            });
        }
    } catch (e) { console.error(e); }
}
window.generateDirectivePrint = function() {
    const type = document.getElementById("dirType").value;
    const content = document.getElementById("dirText").value;
    const authority = document.getElementById("selDirAuthority").value;
    const selectedUsers = Array.from(document.querySelectorAll('.dir-user-check:checked')).map(cb => cb.value);
    if (selectedUsers.length === 0 || !content) return alert("Select users and enter content.");

    const now = new Date();
    const reportContainer = document.getElementById("printableReportContainer");
    reportContainer.innerHTML = `
        <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
            <button class="danger" onclick="closeReportPreview()">CLOSE</button>
            <button onclick="window.print()" style="background:#000; color:#fff; padding:10px 20px; margin-left:10px;">PRINT</button>
        </div>
        <div class="report-paper a4-max-wrapper">
            <style>
                @media print { @page { size: A4; margin: 0; } .no-print { display: none !important; } .a4-max-wrapper { width: 100% !important; padding: 10mm !important; } }
                .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 10mm; background: white; font-family: "Times New Roman", serif; color: #000; text-align: center; box-sizing: border-box; }
                .header-box { border-bottom: 12pt solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                .title-main { font-size: 55pt; font-weight: 900; text-transform: uppercase; }
                .title-sub { font-size: 32pt; font-weight: 900; margin-top: 10px; }
                .max-label { font-size: 32pt; text-decoration: underline; display: block; margin-top: 30px; text-align: left; }
                .max-value { font-size: 42pt; font-weight: 900; display: block; border-bottom: 5pt solid #000; padding-bottom: 8px; text-align: left; }
                .heavy-bar { background: #000; color: #fff; padding: 20px; font-size: 48pt; margin: 50px 0 30px 0; text-transform: uppercase; -webkit-print-color-adjust: exact; }
                .content-body { font-size: 42pt; font-weight: 900; padding: 20px 0; text-align: left; line-height: 1.3; white-space: pre-wrap; word-wrap: break-word; }
                .sig-box-name { margin-top: 150px; border-top: 10pt solid #000; padding-top: 20px; font-size: 50pt; font-weight: 900; text-align: left; }
            </style>
            <div class="header-box">
                <div class="title-main">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
                <div class="title-sub">INSTITUTE OF ENGINEERING AND MANAGEMENT<br>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 40pt; border: 8pt solid #000; margin-top: 30px; padding: 15px; font-weight: 900; display: inline-block;">${type}</div>
            </div>
            <span class="max-label">DATE:</span><span class="max-value">${now.toLocaleDateString('en-IN')}</span>
            <span class="max-label">PERSONNEL:</span><span class="max-value">${selectedUsers.join(", ")}</span>
            <div class="heavy-bar">DIRECTIVE / TERMS</div>
            <div class="content-body">${content}</div>
            <div class="sig-box-name">${authority.split('(')[0]}</div>
            <div style="font-size: 34pt; text-align:left; font-weight:bold;">${authority.includes("Soham") ? "PRINCIPAL" : "CO-PRINCIPAL"} INVESTIGATOR</div>
            <div style="font-size: 38pt; font-weight: 900; text-align: left; text-transform: uppercase;">APPROVING AUTHORITY</div>
        </div>`;
    reportContainer.classList.remove("hidden");
    window.scrollTo(0, 0);
};
window.handleCommentLineChange = () => {
    const line = document.getElementById("commentLineSelect").value;
    const stnSel = document.getElementById("commentStationSelect");
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    if (line && METRO_STATIONS[line]) {
        METRO_STATIONS[line].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn; opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        stnSel.disabled = false;
    }
};
// Dropdown Logic for Comment Tab
window.handleCommentLineChange = () => {
    const line = document.getElementById("commentLineSelect").value;
    const stnSel = document.getElementById("commentStationSelect");
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    if (line && METRO_STATIONS[line]) {
        METRO_STATIONS[line].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn; opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        stnSel.disabled = false;
    }
};

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

// --- 1. HELPER TO OPEN BIG IMAGE ---
window.openBigPhoto = (url) => {
    const modal = document.getElementById("bigImageModal");
    const img = document.getElementById("bigImageViewer");
    
    // Set the image source
    img.src = url;
    
    // Show the modal
    modal.classList.remove("hidden");
};

// --- 2. UPDATED LOAD GALLERY FUNCTION ---
function loadGallery() {
    const div = document.getElementById("galleryContainer");
    div.innerHTML = "<p style='text-align:center; width:100%;'>Loading images...</p>";

    // Clean up old listener
    if (galleryListener) { try { off(ref(db, "history")); } catch(e){} galleryListener = null; }

    const line = document.getElementById("galleryLineSelect").value;
    const stn = document.getElementById("galleryStationSelect").value;
    
    if(!line || !stn) { div.innerHTML = ""; return; }
    
    const targetName = `${stn} (${line})`;
    const q = query(ref(db, "history"), orderByChild("stationName"), equalTo(targetName));

    galleryListener = onValue(q, snap => {
        div.innerHTML = "";
        if(!snap.exists()) { div.innerHTML = "<p style='text-align:center; width:100%; color:#888;'>No photos found.</p>"; return; }

        snap.forEach(c => {
            const v = c.val();
            let media = "";
            
            // --- IMAGE LOGIC: CLICK TO OPEN BIG ---
            if(v.fileType && v.fileType.includes("image")) {
                media = `
                <img src="${v.fileData}" 
                     onclick="openBigPhoto('${v.fileData}')" 
                     style="cursor:zoom-in; width:100%; height:140px; object-fit:cover; border-radius:4px; border:1px solid #ccc; transition: transform 0.2s;"
                     onmouseover="this.style.transform='scale(1.03)'"
                     onmouseout="this.style.transform='scale(1)'"
                >`;
            } else {
                media = `<div style="height:140px; background:#eee; display:flex; align-items:center; justify-content:center; color:#555;">üìÑ Document</div>`;
            }

            // --- ADMIN CONTROLS (Only Admin sees Download/Delete) ---
            let footer = `<div style="margin-top:5px; text-align:center; font-size:10px; color:#aaa;">(Click to Zoom)</div>`;
            
            if(isAdmin) {
                footer = `
                <div style="margin-top:5px; display:flex; gap:5px;">
                    <a href="${v.fileData}" download="Evidence.jpg" class="info" style="flex:1; text-decoration:none; text-align:center; padding:5px; font-size:11px; background:#0A2342; color:white; border-radius:3px;">‚¨á Save</a>
                    <button class="danger" onclick="removeFile('${c.key}')" style="padding:5px; font-size:11px; border-radius:3px;">üóë</button>
                </div>`;
            }

            // --- RENDER CARD ---
            div.innerHTML += `
            <div class="gallery-item" style="background:white; padding:10px; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                ${media}
                <div style="font-size:11px; margin-top:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    <b>${v.name}</b>
                </div>
                <div style="font-size:10px; color:#666;">By: ${v.userName}</div>
                ${footer}
            </div>`;
        });
    });
}
window.removeFile = (k) => {
    if(confirm("Remove attached file?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

async function clearPreviousSession() {
    // A. Stop listening to the old station's draft
    if (draftRef) { off(draftRef); draftRef = null; }
    
    // B. Wipe Global IDs
    currentStationKey = null;
    currentRakeKey = null;

    // C. Wipe UI Inputs
    document.getElementById("inpStationLength").value = "";
    document.getElementById("inpYellowDist").value = "";
    document.getElementById("inpYellowThick").value = "";
    document.getElementById("inpRemarks").value = "";
    document.getElementById("inpImplementation").value = "";
    
    // D. Wipe Table
    document.getElementById("distanceBody").innerHTML = "";

    // E. Wipe Draft Node in Database (Prevents data crossover)
    if(currentUser) {
        await set(ref(db, `drafts/${currentUser.uid}`), null);
    }
}
function renderRow(k, v, i) {
    const b = document.getElementById("distanceBody");
    
    // Helper to check which option was previously saved
    const isSel = (val) => (v.type === val ? "selected" : "");

    b.innerHTML += `
        <tr>
            <td style="text-align:center; font-weight:bold;">${i}</td>
            
            <td>
                <input style="width:100%" value="${v.rake}" onchange="upRow('${k}','rake',this.value)" placeholder="Type _ if empty">
            </td>
            
            <td>
                <select style="width:100%; padding:5px; font-weight:bold; border:1px solid #ced4da; border-radius:3px;" onchange="upRow('${k}','type',this.value)">
                    <option value="" ${isSel("")}>-- Select Type --</option>
                    <option value="BHEL RAKE (300 SERIES)" ${isSel("BHEL RAKE (300 SERIES)")}>BHEL RAKE (300 SERIES)</option>
                    <option value="MEDHA RAKE (400 SERIES)" ${isSel("MEDHA RAKE (400 SERIES)")}>MEDHA RAKE (400 SERIES)</option>
                    <option value="DALIAN RAKE (500 SERIES)" ${isSel("DALIAN RAKE (500 SERIES)")}>DALIAN RAKE (500 SERIES)</option>
                </select>
            </td>

            <td>
                <input style="width:100%" value="${v.f}" onchange="upRow('${k}','f',this.value)" placeholder="_">
            </td>
            
            <td>
                <input style="width:100%" value="${v.r}" onchange="upRow('${k}','r',this.value)" placeholder="_">
            </td>
            
            <td style="text-align:center;">
                <button class="danger" onclick="delRow('${k}')" style="padding:5px 10px;">X</button>
            </td>
        </tr>`;
}
// --- LOAD INVENTORY (STABLE VERSION) ---
function loadInventory() {
    const b = document.getElementById("inventoryBody");
    const summaryEl = document.getElementById("stockSummaryText");
    if(!b) return;

    // Real-time listener for Inventory changes
    onValue(ref(db, "inventory"), snap => {
        b.innerHTML = "";
        let total = 0, available = 0;
        const NOW = Date.now();
        const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000; // 604,800,000 ms

        if(!snap.exists()) {
            b.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:20px;'>Empty Stock / Database Syncing...</td></tr>";
            if(summaryEl) summaryEl.innerText = "Total: 0 | Available: 0";
            return;
        }

        snap.forEach(c => {
            const v = c.val(), k = c.key;
            total++;
            
            const isSold = v.status === "Sold Out";
            if(!isSold && v.status !== "Checked Out") available++;

            // 1. RE-STOCK LOGIC: Check if sale is within 7-day window for warranty/revert
            const canRevert = isSold && v.soldAt && (NOW - v.soldAt < SEVEN_DAYS);
            
            // 2. STATUS UI STYLING
            let statusStyle = "background:#dcfce7; color:#166534;"; // Default: In Stock
            if(v.status === "Checked Out") statusStyle = "background:#fef3c7; color:#d97706;";
            if(isSold) statusStyle = "background:#000; color:#fff; border: 1px solid #333;";

            // 3. ACTION LOCKING: Lock Edit/Delete for Sold items
            const editBtn = isSold ? 
                `<button disabled style="opacity:0.3; cursor:not-allowed; padding:2px 6px; font-size:10px;">EDIT</button>` : 
                `<button class="warning" onclick="editExistingItem('${k}')" style="padding:2px 6px; font-size:10px;">EDIT</button>`;

            // 4. RE-STOCK BUTTON: Visible only if item was sold < 7 days ago
            const bringBackBtn = canRevert ? 
                `<button class="success" onclick="revertSale('${k}', '${v.item}')" style="padding:2px 6px; font-size:10px; margin-left:4px; background:#15803d; color:white;">RE-STOCK</button>` : "";

            const deleteBtn = (isAdmin && !isSold) ? 
                `<button class="danger" onclick="delInv('${k}')" style="padding:2px 6px; font-size:10px; margin-left:4px;">DEL</button>` : "";

            // 5. DATA LABELS (Station, Invoice, and Sold Date)
            const soldDateStr = v.soldAt ? new Date(v.soldAt).toLocaleDateString('en-IN') : "-";
            const invoiceLabel = v.invoiceNo ? `<div style="font-size:9px; color:#64748b; font-family:monospace; margin-top:2px;">üìú ID: ${v.invoiceNo}</div>` : "";
            const stationLabel = v.assignedStation ? `<div style="color:#B91C1C; font-weight:bold; font-size:10px; margin-top:2px;">üìç ${v.assignedStation}</div>` : "";

            // 6. RENDER ROW
            b.innerHTML += `
            <tr class="stock-row" data-invoice="${v.invoiceNo || ''}" style="${isSold ? 'background:#f1f5f9; color:#64748b;' : ''}">
                <td style="font-family:monospace; font-weight:bold;">${v.barcode || '--'}</td>
                <td style="font-weight:bold;">
                    ${v.item}
                    ${invoiceLabel}
                </td>
                <td style="text-align:center;">${v.usageCount || 0}</td>
                <td style="font-weight:bold;">
                    ${stationLabel || v.holder || '-'}
                    ${isSold ? `<div style="font-size:9px; font-weight:normal; color:#444; margin-top:2px;">Sold: ${soldDateStr}</div>` : ""}
                </td>
                <td style="font-size:11px; font-weight:bold;">${v.location || '-'}</td>
                <td style="text-align:right; font-weight:900; color:green;">‚Çπ ${parseFloat(v.purchasePrice || 0).toFixed(2)}</td>
                <td style="text-align:center;">
                    <span style="${statusStyle} padding:3px 8px; border-radius:12px; font-size:10px; font-weight:bold; text-transform:uppercase;">${v.status}</span>
                </td>
                <td style="text-align:center; white-space:nowrap;">
                    ${editBtn}
                    ${bringBackBtn}
                    ${deleteBtn}
                </td>
            </tr>`;
        });

        // Update top summary text
        if(summaryEl) {
            summaryEl.innerHTML = `Total Assets: ${total} | <span style="color:green; font-weight:bold;">Ready for Use: ${available}</span>`;
        }
    });
}
  // --- RE-STOCK FUNCTION: BRING BACK SOLD ITEMS WITHIN 7 DAYS ---
window.revertSale = async (key, itemName) => {
    const snap = await get(ref(db, `inventory/${key}`));
    const v = snap.val();
    const oldInvoice = v.invoiceNo || "N/A";
    const oldStation = v.assignedStation || "Unknown Site";

    const returnReason = prompt(`REASON FOR RETURN?\nItem: ${itemName}\nOriginal Invoice: ${oldInvoice}\n\nPlease enter the specific reason:`);
    
    if(!returnReason) return alert("Operation Cancelled: A reason is required.");

    if(!confirm(`RESTORE TO INVENTORY?\nReason: ${returnReason}\n\nProceed to wipe Invoice data and generate Return Note?`)) return;

    try {
        await update(ref(db, `inventory/${key}`), {
            status: "In Stock",
            holder: "Store",
            location: "D2 Building - Heerok Sir Lab [Returned]",
            soldAt: null,
            invoiceNo: null,       
            assignedStation: null  
        });

        await push(ref(db, "logs"), {
            type: "ITEM_RESTOCKED",
            item: itemName,
            originalInvoice: oldInvoice,
            reason: returnReason,
            time: serverTimestamp(),
            by: currentUser.name || currentUser.email
        });

        alert("‚úÖ Item Restored. Generating Official Return Note...");

        // Trigger updated Return Note Printout with RECEIVER terminology
        generateReturnPrintout(itemName, v.barcode, oldInvoice, oldStation, returnReason);

    } catch(e) {
        alert("Restoration Failed: " + e.message);
    }
};
// Helper function to generate the Return Note
function generateReturnPrintout(name, tag, inv, site, reason) {
    const reportContainer = document.getElementById("printableReportContainer");
    const now = new Date();
    const receiverName = (currentUser.name || 'System Auditor').toUpperCase();
    
    reportContainer.innerHTML = `
        <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
            <button class="danger" onclick="closeReportPreview()">CLOSE</button>
            <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; cursor:pointer; border-radius:8px;">PRINT RETURN RECEIPT</button>
        </div>
        <div class="report-paper a4-max-wrapper" style="font-family: 'Segoe UI', Roboto, sans-serif !important; -webkit-print-color-adjust: exact;">
            <style>
                @media print { @page { size: A4; margin: 0; } .a4-max-wrapper { width: 100% !important; padding: 15mm !important; } }
                .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; background: white; color: #000; text-align: center; box-sizing: border-box; }
                .max-label { font-size: 28pt; text-decoration: underline; display: block; margin-top: 30px; text-align: left; font-weight: bold; }
                .max-value { font-size: 38pt; font-weight: 900; display: block; border-bottom: 6pt solid #000; padding-bottom: 10px; text-align: left; word-wrap: break-word; }
            </style>
            <div style="border-bottom: 14pt solid #000; padding-bottom: 25px; margin-bottom: 35px;">
                <div style="font-size: 55pt; font-weight: 900; text-transform: uppercase;">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
                <div style="font-size: 26pt; font-weight: 900; margin-top: 15px;">INSTITUTE OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 26pt; font-weight: 900; margin-top: 5px;">UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 38pt; border: 10pt solid #000; margin-top: 30px; padding: 20px; font-weight: 900; display: inline-block; background: #000 !important; color: #fff !important; -webkit-print-color-adjust: exact;">GOODS RETURN NOTE</div>
            </div>
            
            <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 25px;">REF INVOICE: <span style="font-family: monospace;">${inv}</span></div>
            <span class="max-label">RETURNED FROM SITE:</span><span class="max-value" style="background:#fee2e2 !important;">${site.toUpperCase()}</span>
            <span class="max-label">ITEM DESCRIPTION:</span><span class="max-value">${name.toUpperCase()}</span>
            <span class="max-label">ASSET TAG (QR):</span><span class="max-value" style="font-family: monospace;">${tag}</span>
            <span class="max-label">RETURN REASON:</span><span class="max-value" style="font-style: italic; border-bottom: none;">${reason.toUpperCase()}</span>

            <div style="margin-top: 140px; border-top: 12pt solid #000; width: 60%; text-align: left;">
                <div style="font-size: 48pt; font-weight: 900;">${receiverName}</div>
                <div style="font-size: 34pt; font-weight: 900;">RECEIVER / AUTHORIZED SIGNATORY</div>
            </div>
            <div style="margin-top: 70px; font-size: 16pt; text-align: center; border-top: 4pt dashed #000; padding-top: 20px; font-weight: bold;">CERTIFIED: ITEM RESTORED TO MASTER INVENTORY DATABASE</div>
        </div>`;
    reportContainer.classList.remove("hidden"); window.scrollTo(0, 0);
}
// --- OPEN FORM FOR NEW ASSET ---
window.openNewAssetForm = () => {
    resetInvForm();
    toggleInvMode('add');
};

// --- PREPARE FORM FOR EDITING ---
window.editExistingItem = async (key) => {
    const snap = await get(ref(db, `inventory/${key}`));
    const d = snap.val();

    toggleInvMode('add');
    
    document.getElementById("editItemKey").value = key;
    document.getElementById("invBarcode").value = d.barcode || "";
    document.getElementById("invName").value = d.item || "";
    document.getElementById("invRegPrice").value = d.purchasePrice || 0;
    
    // Clean location parsing (removes bracketed spot for inputs)
    const locParts = (d.location || "").split(" [");
    document.getElementById("addLocSelect").value = locParts[0] || "Other";
    document.getElementById("addLocSpot").value = locParts[1] ? locParts[1].replace("]", "") : "";

    document.getElementById("invFormTitle").innerHTML = "<i class='fas fa-edit'></i> Update Asset Information";
    document.getElementById("btnAddStock").innerText = "CONFIRM CHANGES";
    document.getElementById("btnCancelEdit").classList.remove("hidden");
    window.scrollTo(0, 0);
};

// --- RESET FORM UI ---
window.resetInvForm = () => {
    document.getElementById("editItemKey").value = "";
    document.getElementById("invBarcode").value = "";
    document.getElementById("invName").value = "";
    document.getElementById("invRegPrice").value = "";
    document.getElementById("addLocSpot").value = "";
    document.getElementById("invFormTitle").innerHTML = "<i class='fas fa-plus-circle'></i> Register New Asset";
    document.getElementById("btnAddStock").innerText = "SAVE ASSET RECORD";
    document.getElementById("btnCancelEdit").classList.add("hidden");
};

// --- SAVE / UPDATE LOGIC ---
window.addUniqueItem = async () => {
    const key = document.getElementById("editItemKey").value;
    const barcode = document.getElementById("invBarcode").value.trim();
    const name = document.getElementById("invName").value.trim();
    const price = parseFloat(document.getElementById("invRegPrice").value) || 0;
    const loc = document.getElementById("addLocSelect").value + " [" + document.getElementById("addLocSpot").value + "]";

    if(!name || !barcode) return alert("Tag ID and Asset Name are required.");

    const itemData = {
        barcode: barcode,
        item: name,
        purchasePrice: price,
        location: loc,
        updatedAt: serverTimestamp()
    };

    try {
        if(key) {
            // MODE: UPDATE
            await update(ref(db, `inventory/${key}`), itemData);
            alert("‚úÖ Record Updated.");
        } else {
            // MODE: NEW
            itemData.status = "In Stock";
            itemData.holder = "Store";
            itemData.usageCount = 0;
            await push(ref(db, "inventory"), itemData);
            alert("‚úÖ New Asset Added.");
        }
        resetInvForm();
        toggleInvMode('list');
    } catch(e) { alert("Save Error: " + e.message); }
};
window.filterStockTable = () => {
    const input = document.getElementById("mainStockSearch").value.trim().toLowerCase();
    const rows = document.getElementsByClassName("stock-row");

    Array.from(rows).forEach(row => {
        const barcode = row.cells[0].innerText.toLowerCase();
        const name = row.cells[1].innerText.toLowerCase();
        const station = row.cells[3].innerText.toLowerCase();
        const invoice = row.getAttribute("data-invoice") ? row.getAttribute("data-invoice").toLowerCase() : "";

        // Show row if input matches Tag, Name, Station, or Invoice No.
        if (name.includes(input) || barcode.includes(input) || station.includes(input) || invoice.includes(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};
  // Dropdown Logic for Comment Tab
window.handleCommentLineChange = () => {
    const line = document.getElementById("commentLineSelect").value;
    const stnSel = document.getElementById("commentStationSelect");
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    if (line && METRO_STATIONS[line]) {
        METRO_STATIONS[line].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = stn; opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        stnSel.disabled = false;
    }
};
window.printStationComment = function () {
    const station = document.getElementById("commentStationSelect").value;
    const corridor = document.getElementById("commentLineSelect").value;
    const comment = document.getElementById("commentTextInput").value;
    let inspector = document.getElementById("selCommentInspector").value;
    const authority = document.getElementById("selCommentAuthority").value;

    if (!station || !comment) {
        alert("Please select station and enter comment.");
        return;
    }

    const getTitle = (name) => {
        if (name && name.includes("Soham Pal")) return "PRINCIPAL INVESTIGATOR";
        if (name && name.includes("Heerok Banerjee")) return "CO-PRINCIPAL INVESTIGATOR";
        return "";
    };

    const inspectorTitle = getTitle(inspector);
    const authorityTitle = getTitle(authority);
    const now = new Date();
    const date = now.toLocaleDateString('en-IN');
    const time = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
    
    // RESTORED: Footer timestamp logic
    const printTimestamp = now.toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });

    const reportContainer = document.getElementById("printableReportContainer");
    
    reportContainer.innerHTML = `
        <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
            <h3 style="margin:0 0 10px 0;">Official A4 Comment Preview</h3>
            <button class="danger" onclick="closeReportPreview()" style="margin-right:10px;">CLOSE PREVIEW</button>
            <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 30px; font-weight:bold; font-size:22px; cursor:pointer; border-radius:8px;">
                <i class="fas fa-print"></i> GENERATE DOCUMENT
            </button>
        </div>

        <div class="report-paper a4-max-wrapper">
            <style>
                @media print {
                    @page { size: A4; margin: 0; }
                    body { margin: 0; padding: 0; background: #fff !important; }
                    .no-print { display: none !important; }
                    .a4-max-wrapper { width: 100% !important; border: none !important; box-shadow: none !important; margin: 0 !important; padding: 5mm !important; }
                }
                .a4-max-wrapper {
                    width: 210mm; min-height: 297mm; margin: 0 auto !important; padding: 8mm !important;
                    background: white !important; font-family: "Times New Roman", Times, serif !important;
                    color: #000 !important; line-height: 1.1 !important; box-sizing: border-box; text-align: center !important;
                }
                .header-box { border-bottom: 14pt solid #000 !important; padding-bottom: 25px !important; margin-bottom: 35px !important; }
                .title-main { font-size: 62pt !important; font-weight: 900; text-transform: uppercase !important; } 
                .title-sub { font-size: 38pt !important; font-weight: 900; line-height: 1.2 !important; margin-top: 15px !important; }
                .max-label { font-size: 38pt !important; text-decoration: underline !important; display: block !important; margin-top: 35px !important; text-align: left !important; }
                .max-value { font-size: 48pt !important; font-weight: 900 !important; display: block !important; word-wrap: break-word !important; border-bottom: 7pt solid #000 !important; padding-bottom: 12px !important; text-align: left !important; }
                .heavy-bar { background: #000 !important; color: #fff !important; padding: 25px !important; font-size: 52pt !important; margin: 60px 0 40px 0 !important; text-transform: uppercase !important; -webkit-print-color-adjust: exact !important; }
                .comment-body { font-size: 48pt !important; font-weight: 900 !important; padding: 30px 0 !important; word-wrap: break-word !important; text-align: left !important; line-height: 1.4; }
                .sig-box-name { margin-top: 130px !important; border-top: 12pt solid #000 !important; padding-top: 25px !important; font-size: 56pt !important; font-weight: 900; text-align: left !important; line-height: 1; }
                .sig-investigator-title { font-size: 36pt !important; font-weight: bold; text-align: left !important; margin-bottom: 15px; }
                .sig-box-desc { font-size: 40pt !important; font-weight: 900 !important; text-transform: uppercase !important; margin-bottom: 100px !important; text-align: left !important; }
                .footer-stamp { margin-top: 50px; font-size: 14pt !important; text-align: center; border-top: 3pt dashed #000; padding-top: 20px; font-weight: bold; }
            </style>

            <div class="header-box">
                <div class="title-main">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
                <div class="title-sub">INSTITUTE OF ENGINEERING AND MANAGEMENT<br><br>UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 44pt; border: 8pt solid #000; margin-top: 40px; padding: 20px; font-weight: 900; display: inline-block;">OFFICIAL COMMENT RECORD</div>
            </div>

            <span class="max-label">SITE:</span><span class="max-value">${station}</span>
            <span class="max-label">DATE & TIME:</span><span class="max-value">${date} | ${time}</span>
            <span class="max-label">CORRIDOR:</span><span class="max-value">${corridor}</span>

            <div class="heavy-bar">REMARKS / OBSERVATIONS</div>
            <div class="comment-body">${comment}</div>

            <div style="margin-top: 140px;">
                ${inspector && inspector !== "" && inspector !== "Self" ? `
                    <div class="sig-box-name">${inspector}</div>
                    ${inspectorTitle ? `<div class="sig-investigator-title">(${inspectorTitle})</div>` : ''}
                    <div class="sig-box-desc">CONDUCTING OFFICER</div>
                ` : ''}
                <div class="sig-box-name">${authority.split('(')[0]}</div>
                ${authorityTitle ? `<div class="sig-investigator-title">(${authorityTitle})</div>` : ''}
                <div class="sig-box-desc">APPROVING AUTHORITY</div>
            </div>
            
            <div class="footer-stamp">
                SYSTEM GENERATED RECORD | PRINTED ON: ${printTimestamp}
            </div>
        </div>`;

    reportContainer.classList.remove("hidden");
    window.scrollTo(0, 0);
};
async function populateCommentUsers() {
    const sel = document.getElementById("selCommentInspector"); 
    if(!sel) return;

    // Reset list and add current user as default
    const currentName = currentUser.name || currentUser.email;
    sel.innerHTML = `<option value="${currentName}">Self (${currentName})</option>`;

    try {
        const snap = await get(ref(db, "users"));
        if (snap.exists()) {
            snap.forEach(c => {
                const u = c.val();
                const uName = u.name || u.email;
                if(uName !== currentName) {
                    const opt = document.createElement("option");
                    opt.value = uName;
                    opt.innerText = uName;
                    sel.appendChild(opt);
                }
            });
        }
    } catch (e) { 
        console.error("Database error fetching officers:", e); 
    }
}
window.loadPurchaseData = () => {
    const formPanel = document.getElementById("purchaseFormPanel");
    if(formPanel) formPanel.classList.remove("hidden");

    const tbody = document.getElementById("purchaseTableBody");
    if(!tbody) return;
    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‚è≥ Syncing Procurement Data...</td></tr>";

    const theadRow = document.querySelector("#tab-purchase thead tr");
    if(theadRow) {
        let headerHTML = `<th>Sl</th><th>Product Details</th><th>Vendor & Order ID</th><th>Qty</th><th>Unit Price</th><th>Total</th><th>Status</th>`;
        if(isAdmin) headerHTML += `<th>Action</th>`;
        theadRow.innerHTML = headerHTML;
    }

    if(window.purchaseListener) { try{ off(ref(db, "finance")); }catch(e){} }

    window.purchaseListener = onValue(ref(db, "finance"), (snap) => {
        try {
            tbody.innerHTML = "";
            let sl = 1;
            const txs = [];

            if(snap.exists()) {
                snap.forEach(c => {
                    const val = c.val();
                    if(val) txs.push({ key: c.key, ...val });
                });
            }
            
            // Sort: Newest First
            txs.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

            txs.forEach(t => {
                try {
                    if(t.type === 'DEBIT') {
                        // FIX: Legacy Status Support
                        let currentStatus = t.status || 'Approved'; 
                        
                        const prodName = t.productName || t.desc || "Legacy Item";
                        const amount = parseFloat(t.amount) || 0;
                        
                        // --- 1. STATUS BADGES ---
                        let statusBadge = "";
                        let rowColor = "";

                        if(currentStatus === 'Pending') {
                            statusBadge = `<span style="background:#fef3c7; color:#d97706; padding:3px 8px; border-radius:10px; font-weight:bold; font-size:10px;">‚è≥ Pending</span>`;
                            rowColor = "background:#fffbf0;";
                        } else if (currentStatus === 'Rejected') {
                            statusBadge = `<span style="background:#fee2e2; color:#991b1b; padding:3px 8px; border-radius:10px; font-weight:bold; font-size:10px;">üö´ Denied</span>`;
                            rowColor = "background:#fff5f5; opacity: 0.7;";
                        } else {
                            statusBadge = `<span style="background:#dcfce7; color:#166534; padding:3px 8px; border-radius:10px; font-weight:bold; font-size:10px;">‚úÖ Approved</span>`;
                        }

                        // --- 2. ACTION BUTTONS ---
                        let actionCell = "";
                        if(isAdmin) {
                            if(currentStatus === 'Pending') {
                                // PENDING: Show Approve, Deny, Edit, Delete
                                actionCell = `
                                    <td style="display:flex; gap:2px; flex-wrap:wrap;">
                                        <button onclick="approvePurchase('${t.key}')" title="Approve" style="padding:4px; font-size:12px; background:#15803d; color:white; border:none; border-radius:3px; cursor:pointer;">‚úÖ</button>
                                        <button onclick="denyPurchase('${t.key}')" title="Deny" style="padding:4px; font-size:12px; background:#64748b; color:white; border:none; border-radius:3px; cursor:pointer;">üö´</button>
                                        <button onclick="editPurchase('${t.key}')" title="Edit" style="padding:4px; font-size:12px; background:#d97706; color:white; border:none; border-radius:3px; cursor:pointer;">‚úè</button>
                                        <button onclick="deletePurchase('${t.key}')" title="Delete" style="padding:4px; font-size:12px; background:#B91C1C; color:white; border:none; border-radius:3px; cursor:pointer;">üóë</button>
                                    </td>
                                `;
                            } else {
                                // DONE/REJECTED: Show Edit, Delete
                                actionCell = `
                                    <td>
                                        <button onclick="editPurchase('${t.key}')" class="warning" style="padding:4px 8px; font-size:10px; background:#d97706; color:white; margin-right:5px;">‚úè Edit</button>
                                        <button onclick="deletePurchase('${t.key}')" class="danger" style="padding:4px 8px; font-size:10px; background:#B91C1C; color:white;">üóë Delete</button>
                                    </td>
                                `;
                            }
                        }

                        const row = `
                            <tr style="${rowColor}">
                                <td>${sl++}</td>
                                <td style="font-weight:bold;">${prodName}</td>
                                <td>${t.platform || '-'}<br><small style="color:#666">${t.orderId || t.mode || '-'}</small></td>
                                <td>${t.qty || 1}</td>
                                <td>${t.unitPrice || '-'}</td>
                                <td style="color:var(--metro-red); font-weight:bold;">‚Çπ ${amount.toFixed(2)}</td>
                                <td>${statusBadge}</td>
                                ${actionCell}
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    }
                } catch (rowErr) { console.warn("Skipping bad purchase row", rowErr); }
            });
            
            if(tbody.innerHTML === "") tbody.innerHTML = "<tr><td colspan='8' style='text-align:center; color:#999;'>No purchase records found.</td></tr>";

        } catch (globalErr) { console.error(globalErr); }
    });
};
// --- APPROVE: Deducts Fund ---
window.approvePurchase = async (key) => {
    if(!confirm("‚úÖ Approve this purchase?\n\nThis will deduct funds from the Balance Sheet.")) return;
    try {
        await update(ref(db, `finance/${key}`), { status: "Approved" });
        alert("Purchase Approved.");
    } catch(e) { alert("Error: " + e.message); }
};

// --- DENY: Marks as Rejected (No Deduction) ---
window.denyPurchase = async (key) => {
    if(!confirm("üö´ Deny/Reject this request?\n\nIt will remain in history but NOT affect the budget.")) return;
    try {
        await update(ref(db, `finance/${key}`), { status: "Rejected" });
    } catch(e) { alert("Error: " + e.message); }
};

// --- DELETE: Removes Completely ---
window.deletePurchase = async (key) => {
    if(confirm("üóë PERMANENTLY DELETE this record?\n\nThis cannot be undone.")) {
        await remove(ref(db, `finance/${key}`));
    }
};
// --- NEW: DELETE PURCHASE ---
window.deletePurchase = async (key) => {
    if(confirm("‚ö† Delete this purchase entry?\n\nThe amount will be credited back to the available balance.")) {
        await remove(ref(db, `finance/${key}`));
    }
};
window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #d97706";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')" class="success">Mark Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });
window.debugConnection = async () => {
    console.log("üì° Testing Network Connection...");

    try {
        // We try to read 1 log. 
        // If logged out, this WILL fail with "Permission denied".
        const testRef = query(ref(db, "station_logs"), limitToLast(1));
        await get(testRef);
        
        // If we get here, it means we are logged in and connected
        console.log("‚úÖ Database Connected (Authenticated)");

    } catch (e) {
        // CHECK: Is this a security rule error?
        if (e.message.toLowerCase().includes("permission denied") || 
            e.code === "PERMISSION_DENIED") {
            
            // This is actually a SUCCESS result for connectivity.
            // It means we reached the server, but were (correctly) blocked.
            console.log("‚úÖ Database Connected (Waiting for Login)");
            
        } else {
            // Real network errors (like offline) usually say "Client is offline"
            console.warn("‚ö†Ô∏è Connection Check:", e.message);
        }
    }
};

// Run automatically on load
setTimeout(debugConnection, 3000);

// Run automatically on load
setTimeout(debugConnection, 3000);
// Run automatically on load
setTimeout(debugConnection, 3000);
// Run automatically on load
setTimeout(debugConnection, 3000);
  // --- ADMIN BYPASS LOGIC FOR SOHAM PAL / TERMINAL PCS ---
window.triggerAdminBypass = () => {
    // Show the OTP/PIN UI that already exists in your HTML
    document.getElementById("videoContainer").classList.add("hidden");
    document.getElementById("camControls").classList.add("hidden");
    document.getElementById("otpUI").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "Admin Security Bypass";
    document.getElementById("modalDesc").innerText = "Camera unavailable. Enter Master Authorization PIN.";
    updateStatus("Bypass Mode Active", "orange");
};

// Update your existing verifyOTP function or replace it with this smarter version
window.verifyOTP = async () => {
    const input = document.getElementById("otpInput").value;
    
    try {
        // Fetch the one true PIN from the system settings node
        const snap = await get(ref(db, "system_settings/master_pin"));
        const systemPin = snap.exists() ? snap.val() : "1234"; // Default only if DB is empty
        
        if (input === systemPin) {
            updateStatus("‚úÖ AUTHORIZED", "#00ff00");
            await recordLogin("Manual PIN Bypass");
            enterApp();
            document.getElementById("otpInput").value = "";
        } else {
            alert("‚ùå Access Denied: Incorrect PIN.");
            document.getElementById("otpInput").value = "";
        }
    } catch (e) {
        alert("Security Error: " + e.message);
    }
};
// --- UPDATED BILLING ENGINE WITH TWO-TABLE TEMPLATE ---
// --- RETAIL BILLING SYSTEM ENGINE ---
window.billCart = [];
window.serviceCart = [];
window.toggleBillStationSource = () => {
    const type = document.getElementById("billClientType").value;
    const metroGroup = document.getElementById("divBillMetroGroup");
    const manualGroup = document.getElementById("divBillStationManual");

    if (type === "METRO") {
        metroGroup.style.display = "contents";
        manualGroup.classList.add("hidden");
    } else {
        metroGroup.style.display = "none";
        manualGroup.classList.remove("hidden");
    }
};

window.handleBillLineChange = () => {
    const lineSel = document.getElementById("billLineSelect");
    const stnSel = document.getElementById("billMetroStation");
    
    stnSel.innerHTML = "<option value=''>-- Select Station --</option>";
    stnSel.disabled = true;
    stnSel.style.background = "#f1f5f9";

    const selectedLine = lineSel.value;
    
    if (selectedLine && METRO_STATIONS[selectedLine]) {
        METRO_STATIONS[selectedLine].forEach(stn => {
            const opt = document.createElement("option");
            opt.value = `${stn} (${selectedLine})`;
            opt.innerText = stn;
            stnSel.appendChild(opt);
        });
        stnSel.disabled = false;
        stnSel.style.background = "#fff";
    }
};
// Function to populate the billing dropdown with ALL stations
function populateAllMetroStations() {
    const sel = document.getElementById("billMetroStation");
    if(!sel) return;
    sel.innerHTML = "<option value=''>-- Select Metro Station --</option>";
    
    // Loop through the existing METRO_STATIONS object defined in your code
    for (const [line, stations] of Object.entries(METRO_STATIONS)) {
        const group = document.createElement("optgroup");
        group.label = line;
        stations.forEach(stn => {
            const opt = document.createElement("option");
            opt.value = `${stn} (${line})`;
            opt.innerText = stn;
            group.appendChild(opt);
        });
        sel.appendChild(group);
    }
}
// Run this once when billing tab is opened
// Fix for ReferenceError: Defining globally
window.populateBillingAssets = async () => {
    try {
        const snap = await get(ref(db, "inventory"));
        const sel = document.getElementById("billAssetSelect");
        if(sel) {
            sel.innerHTML = "<option value=''>-- Select Item --</option>";
            snap.forEach(c => {
                const v = c.val();
                const opt = document.createElement("option");
                opt.value = v.barcode;
                opt.text = v.item;
                opt.dataset.purchase = v.purchasePrice || 0;
                sel.appendChild(opt);
            });
        }
    } catch(e) { console.error("Billing Load Error:", e); }
};

// Convert Total Amount to Indian Currency Words
function numberToWords(num) {
    const a = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 'Eighteen ', 'Nineteen '];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    const numStr = Math.round(num).toString();
    if (numStr.length > 9) return 'Amount too large';
    let n = ('000000000' + numStr).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if (!n) return ''; 
    let str = '';
    str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
    str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
    str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
    str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
    str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
    return str + 'Rupees Only';
}
window.addScannedItemToBill = async () => {
    const barcode = document.getElementById("billBarcodeInp").value.trim();
    if(!barcode) return alert("Scan Asset Tag");

    // 1. Check if the tag is already in the current cart (Prevent duplicate scanning in one session)
    const isAlreadyInCart = window.billCart.some(item => item.tag === barcode);
    if(isAlreadyInCart) return alert("This item is already added to the current Invoice.");

    try {
        const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(barcode));
        const snap = await get(q);
        
        if (!snap.exists()) return alert("Tag ID Not Found in Inventory.");

        let itemKey, itemData;
        snap.forEach(c => { itemKey = c.key; itemData = c.val(); });

        // 2. STRICT VALIDATION: If item is SOLD or CHECKED OUT, it cannot be assigned again
        if(itemData.status === "Sold Out") {
            return alert(`DENIED: Item ${itemData.item} is already SOLD to ${itemData.assignedStation}.\nInvoice: ${itemData.invoiceNo}`);
        }
        
        if(itemData.status === "Checked Out") {
            return alert(`DENIED: Item is currently Checked Out by ${itemData.holder}. Return it to stock first.`);
        }

        // 3. Process to Cart
        const sellRate = (parseFloat(itemData.purchasePrice) || 0) * 1.20; 
        window.billCart.push({
            name: itemData.item, 
            tag: barcode, 
            dbKey: itemKey, 
            qty: 1, 
            rate: sellRate, 
            net: sellRate
        });

        renderBillCartUI();
        document.getElementById("billBarcodeInp").value = "";
        document.getElementById("billBarcodeInp").focus();
        
    } catch (e) { console.error(e); }
};
window.finalizeSaleRecords = async (targetStation) => {
    if(window.billCart.length === 0) return null;

    // Unique Invoice ID using current timestamp
    const invoiceNo = "MRPSP-INV-" + Date.now(); 
    const clientType = document.getElementById("billClientType").value;
    const recipient = (clientType === "METRO") ? "KOLKATA METRO RAILWAY" : (document.getElementById("billCustName").value || "UNSPECIFIED");

    const updates = {};
    const saleTime = Date.now();

    window.billCart.forEach(it => {
        if(it.dbKey) {
            updates[`inventory/${it.dbKey}/status`] = "Sold Out";
            updates[`inventory/${it.dbKey}/soldAt`] = saleTime;
            updates[`inventory/${it.dbKey}/invoiceNo`] = invoiceNo;
            updates[`inventory/${it.dbKey}/assignedStation`] = targetStation;
            updates[`inventory/${it.dbKey}/holder`] = targetStation;
            updates[`inventory/${it.dbKey}/location`] = "DEEP INSTALLED";
        }
    });

    try {
        await update(ref(db), updates);
        
        await push(ref(db, "logs"), {
            type: "SALE_FINALIZED",
            invoice: invoiceNo,
            assignedStation: targetStation,
            billedTo: recipient,
            time: saleTime,
            by: currentUser.name || currentUser.email
        });

        return invoiceNo;
    } catch (e) {
        alert("Critical DB Error: " + e.message);
        return null;
    }
};
function renderBillCartUI() {
    const tbody = document.getElementById("billCartBody");
    if(!tbody) return;
    tbody.innerHTML = "";
    
    let grand = 0;

    // 1. Render Asset Rows
    window.billCart.forEach((it, i) => {
        grand += it.net;
        const row = document.createElement("tr");
        row.style.borderBottom = "1px solid #000";
        row.innerHTML = `
            <td style="padding:12px;">
                <div style="font-weight:bold;">${it.name}</div>
                <small style="color:#64748b;">Tag: ${it.tag}</small>
            </td>
            <td style="text-align:center;">${it.qty}</td>
            <td style="text-align:right;">${it.rate.toFixed(2)}</td>
            <td style="text-align:right; font-weight:bold;">${it.net.toFixed(2)}</td>
            <td style="text-align:center;">
                <button class="danger" style="padding:4px 8px; cursor:pointer;" onclick="removeFromCart('asset', ${i})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // 2. Render Service Rows
    window.serviceCart.forEach((sv, i) => {
        grand += sv.net;
        const row = document.createElement("tr");
        row.style.background = "#f8fafc";
        row.style.borderBottom = "1px solid #000";
        row.innerHTML = `
            <td style="padding:12px;">
                <div style="font-weight:900; color:var(--metro-blue);">SERVICE: ${sv.desc}</div>
            </td>
            <td style="text-align:center; font-weight:bold;">1</td>
            <td style="text-align:right; font-family:monospace;">${sv.price.toFixed(2)}</td>
            <td style="text-align:right; font-weight:900;">${sv.net.toFixed(2)}</td>
            <td style="text-align:center;">
                <button class="danger" style="padding:4px 8px; cursor:pointer;" onclick="removeFromCart('service', ${i})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // 3. Empty State
    if(window.billCart.length === 0 && window.serviceCart.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:30px; color:#94a3b8;'>Scan assets or add services to begin billing.</td></tr>";
    }

    // 4. Update Totals
    const totalVal = grand.toFixed(2);
    document.getElementById("billGrandTotalDisp").innerText = totalVal;
    document.getElementById("billWordsDisp").innerText = numberToWords(grand);
}

// Add this new helper function to handle the deletion safely
window.removeFromCart = (type, index) => {
    if (type === 'asset') {
        window.billCart.splice(index, 1);
    } else {
        window.serviceCart.splice(index, 1);
    }
    renderBillCartUI(); // Refresh the UI immediately
};
// Updated Print Function with increased Font Sizes
window.generateInvoicePrint = async function() {
    if(window.billCart.length === 0 && window.serviceCart.length === 0) {
        return alert("Cart is empty. Scan items first.");
    }

    const clientType = document.getElementById("billClientType").value;
    let recipientName = (clientType === "METRO") ? "KOLKATA METRO RAILWAY" : document.getElementById("billCustName").value;
    let targetStation = (clientType === "METRO") ? document.getElementById("billMetroStation").value : document.getElementById("billManualStation").value;
    const custAddr = (clientType === "METRO") ? "" : document.getElementById("billCustAddr").value.trim();

    if(!targetStation) return alert("Please select a target station.");

    const invoiceNo = await finalizeSaleRecords(targetStation);
    if(!invoiceNo) return;

    let billRows = "";
    let billTotal = 0; 
    const combined = [
        ...window.billCart.map(it => ({name: it.name, tag: it.tag, rate: it.rate, qty: it.qty, net: it.net})),
        ...window.serviceCart.map(sv => ({name: sv.desc, tag: 'SERVICE', rate: sv.price, qty: 1, net: sv.net}))
    ];

    combined.forEach(it => {
        const roundedNet = Math.round(it.net); 
        billTotal += roundedNet; 
        billRows += `
            <tr style="border-bottom: 5pt solid #000;">
                <td style="padding: 15px 10px; font-size: 32pt; font-weight: 900; text-align: left;">
                    ${it.name.toUpperCase()}<br>
                    <span style="font-size: 20pt; color: #333;">(TAG: ${it.tag})</span>
                </td>
                <td style="text-align:right; padding: 15px 10px; font-size: 32pt;">${it.rate.toFixed(0)}</td>
                <td style="text-align:center; padding: 15px 10px; font-size: 32pt;">${it.qty}</td>
                <td style="text-align:right; padding: 15px 10px; font-weight: 900; font-size: 32pt;">${roundedNet}</td>
            </tr>`;
    });

    const reportContainer = document.getElementById("printableReportContainer");
    reportContainer.innerHTML = `
        <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
            <button class="danger" onclick="closeReportPreview()">CLOSE</button>
            <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; font-size:22px; cursor:pointer; border-radius:8px;">PRINT OFFICIAL INVOICE</button>
        </div>
        <div class="report-paper a4-max-wrapper" style="font-family: 'Segoe UI', Roboto, sans-serif !important; -webkit-print-color-adjust: exact;">
            <style>
                @media print { @page { size: A4; margin: 0; } .no-print { display: none !important; } .a4-max-wrapper { width: 100% !important; padding: 10mm !important; } }
                .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 10mm; background: white; color: #000; box-sizing: border-box; }
                .header-box { border-bottom: 14pt solid #000; padding-bottom: 25px; margin-bottom: 35px; text-align: center; }
                .max-label { font-size: 30pt; text-decoration: underline; display: block; margin-top: 30px; text-align: left; font-weight: bold; }
                .max-value { font-size: 40pt; font-weight: 900; display: block; border-bottom: 7pt solid #000; padding-bottom: 10px; text-align: left; }
                .heavy-bar { background: #000 !important; color: #fff !important; padding: 25px; font-size: 48pt; margin-top: 40px; text-transform: uppercase; -webkit-print-color-adjust: exact; text-align: center; font-weight: 900; }
            </style>
            <div class="header-box">
                <div style="font-size: 55pt; font-weight: 900; text-transform: uppercase;">METRO RAILWAY<br>PLATFORM SAFETY PROJECT</div>
                <div style="font-size: 28pt; font-weight: 900; margin-top: 15px;">INSTITUTE OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 28pt; font-weight: 900; margin-top: 5px;">UNIVERSITY OF ENGINEERING AND MANAGEMENT</div>
                <div style="font-size: 38pt; border: 10pt solid #000; margin-top: 30px; padding: 20px; font-weight: 900; display: inline-block;">OFFICIAL TAX INVOICE</div>
            </div>
            
            <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 20px; white-space: nowrap;">INVOICE NO: <span style="font-family: monospace;">${invoiceNo}</span></div>
            <span class="max-label">TO:</span><span class="max-value">${recipientName.toUpperCase()}</span>
            <span class="max-label">TARGET SITE:</span><span class="max-value" style="background:#eee;">${targetStation.toUpperCase()}</span>
            ${custAddr ? `<span class="max-label">ADDRESS:</span><span class="max-value">${custAddr.toUpperCase()}</span>` : ''}
            <span class="max-label">INVOICE DATE:</span><span class="max-value">${new Date().toLocaleDateString('en-IN')}</span>
            
            <div class="heavy-bar">BILL PARTICULARS</div>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead><tr style="border-bottom: 8pt solid #000;"><th style="text-align:left; font-size: 28pt;">DESCRIPTION</th><th style="text-align:right; font-size: 28pt;">RATE</th><th style="text-align:center; font-size: 28pt;">QTY</th><th style="text-align:right; font-size: 28pt;">TOTAL</th></tr></thead>
                <tbody>${billRows}</tbody>
            </table>
            <div style="background: #000 !important; color: #fff !important; display: flex; justify-content: space-between; padding: 25px; margin-top: 10px; -webkit-print-color-adjust: exact;">
                <span style="font-size: 50pt; font-weight: 900;">GRAND TOTAL:</span>
                <span style="font-size: 50pt; font-weight: 900;">‚Çπ ${billTotal.toLocaleString('en-IN')}</span>
            </div>
            <div style="font-size: 26pt; font-weight: 900; text-align: left; margin-top: 20px; font-style: italic;">Words: ${numberToWords(billTotal)}</div>
            <div style="margin-top: 130px; border-top: 12pt solid #000; width: 60%; text-align: left;">
                <div style="font-size: 48pt; font-weight: 900;">${(currentUser.name || 'System Issuer').toUpperCase()}</div>
                <div style="font-size: 34pt; font-weight: 900;">AUTHORIZED SIGNATORY</div>
            </div>
        </div>`;
    window.billCart = []; window.serviceCart = []; renderBillCartUI();
    reportContainer.classList.remove("hidden"); window.scrollTo(0, 0);
};
// Dedicated function for Service Block insertion
window.addServiceOnlyToBill = () => {
    const extraAmt = parseFloat(document.getElementById("billAddl").value) || 0;
    const extraDesc = document.getElementById("billAddlDesc").value.trim();

    if (extraAmt <= 0 || extraDesc === "") {
        return alert("‚ö† Please enter Service Description and Charge Amount.");
    }

    window.serviceCart.push({ desc: extraDesc, price: extraAmt, qty: 1, net: extraAmt });
    renderBillCartUI();
    document.getElementById("billAddl").value = 0;
    document.getElementById("billAddlDesc").value = "";
    alert("‚úÖ Service Applied.");
};
// =========================================================
// üõ°Ô∏è UPDATED WARRANTY ENGINE: DATE-BASED ACTIVATION
// =========================================================

// 1. Core Logic: Prioritizes Manual Start Date over Sale Date
function calculateWarranty(saleDateTs, durationMonths, manualStartDate = null) {
    // Use manual date if provided, otherwise fallback to sale date
    const baseDate = manualStartDate ? new Date(manualStartDate) : (saleDateTs ? new Date(saleDateTs) : null);
    
    if(!baseDate || !durationMonths) return null;
    
    const startDate = new Date(baseDate);
    const expiryDate = new Date(baseDate);
    expiryDate.setMonth(expiryDate.getMonth() + parseInt(durationMonths));
    
    const today = new Date();
    const diffTime = expiryDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const totalTenureDays = Math.ceil((expiryDate - startDate) / (1000 * 60 * 60 * 24));
    
    return {
        start: startDate.toLocaleDateString('en-IN'),
        expiry: expiryDate.toLocaleDateString('en-IN'),
        totalDays: totalTenureDays,
        daysLeft: diffDays > 0 ? diffDays : 0,
        expired: diffDays <= 0
    };
}

// 2. Navigation Controller
window.toggleWarMode = (mode) => {
    const panels = ['dash', 'setup', 'sales', 'claim', 'active'];
    panels.forEach(m => {
        const el = document.getElementById(`war-${m}`);
        if(el) el.classList.add('hidden');
    });
    
    const target = document.getElementById(`war-${mode}`);
    if(target) target.classList.remove('hidden');

    if(mode === 'dash') refreshWarDash();
    if(mode === 'setup') loadWarSetup();
    if(mode === 'sales') loadWarSales();
    if(mode === 'active') loadActiveWarranty();
};

// 3. Updated Save Logic: Stores Manual Start Date instead of Signatory
window.saveWarrantyConfig = async () => {
    const tag = document.getElementById("warSetupTag").value.trim();
    const type = document.getElementById("warProductType").value;
    let duration = parseInt(document.getElementById("warDuration").value) || 0;
    const unit = document.getElementById("warUnit").value;
    const startDateVal = document.getElementById("warStartDate").value;

    if(!tag) return alert("Please enter Asset Tag ID.");

    try {
        const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(tag));
        const snap = await get(q);
        if(!snap.exists()) return alert("‚ùå Error: Tag ID not found.");
        
        let key; snap.forEach(c => key = c.key);
        
        const finalMonths = (type === "WARRANTY" && unit === "Years") ? duration * 12 : duration;

        // Save to Database
        await update(ref(db, `inventory/${key}`), {
            warrantyMonths: finalMonths,
            manualWarDate: startDateVal || null,
            noWarranty: (type === "NON-WARRANTY"),
            protectionActivated: true // This is the trigger for the dashboard
        });
        
        alert(`‚úÖ ${type} Configuration Saved.`);
        
        // --- CRITICAL: REFRESH ALL UI COMPONENTS ---
        loadWarSetup();     // Updates the table in the current tab
        refreshWarDash();   // Updates the Dashboard counters at the top
        
    } catch (e) {
        alert("System Error: " + e.message);
    }
};

// 4. Official Warranty Print Layout (REMOVED SIGNATURE)
window.printCustomerCopy = async (invoiceNo) => {
    const snap = await get(ref(db, "inventory"));
    const items = [];
    let site = "", saleDate = "";

    snap.forEach(c => {
        const v = c.val();
        if(v.invoiceNo === invoiceNo) {
            // Calculate using manual date if it exists in DB
            const war = calculateWarranty(v.soldAt, v.warrantyMonths, v.manualWarDate);
            site = v.assignedStation;
            saleDate = war ? war.start : new Date(v.soldAt).toLocaleDateString('en-IN');
            
            items.push({
                name: v.item,
                tag: v.barcode,
                totalDays: war ? war.totalDays : "N/A",
                expiry: war ? war.expiry : "PENDING"
            });
        }
    });

    const reportContainer = document.getElementById("printableReportContainer");
    let rowsHtml = "";
    // Inside window.printCustomerCopy loop:
items.forEach(it => {
    // If totalDays is 0, display "NO WARRANTY PRODUCT"
    const tenureDisplay = it.totalDays === 0 ? 
        `<span style="color:red; font-weight:900;">NO WARRANTY PRODUCT</span>` : 
        `${it.totalDays} DAYS`;

    const expiryDisplay = it.totalDays === 0 ? "N/A" : it.expiry;

    rowsHtml += `
        <tr style="border-bottom: 6pt solid #000;">
            <td style="padding: 25px 10px; font-size: 30pt; font-weight: 900; text-align: left;">
                ${it.name.toUpperCase()}<br>
                <span style="font-size: 18pt; color: #444;">ID TAG: ${it.tag}</span>
            </td>
            <td style="text-align:center; padding: 25px 10px; font-size: 30pt; font-weight: 900;">
                ${tenureDisplay}
            </td>
            <td style="text-align:right; padding: 25px 10px; font-weight: 900; font-size: 30pt;">
                ${expiryDisplay}
            </td>
        </tr>`;
});

    reportContainer.innerHTML = `
        <div class="no-print" style="text-align:center; padding:15px; background:#f8fafc; border-bottom:1px solid #ddd;">
            <button class="danger" onclick="closeReportPreview()">CLOSE</button>
            <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 50px; font-weight:bold; font-size:20px;">
                <i class="fas fa-print"></i> PRINT OFFICIAL WARRANTY COPY
            </button>
        </div>
        <div class="report-paper a4-max-wrapper" style="font-family: 'Times New Roman', serif !important;">
            <style>
                @media print { @page { size: A4; margin: 0; } .no-print { display: none !important; } .a4-max-wrapper { width: 100% !important; padding: 15mm !important; margin: 0 !important; border: none !important; } }
                .a4-max-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 12mm; background: white; color: #000; box-sizing: border-box; }
                .header-main { font-size: 55pt; font-weight: 900; text-align: center; text-transform: uppercase; line-height: 1; }
                .max-label { font-size: 32pt; text-decoration: underline; display: block; margin-top: 30px; text-align: left; font-weight: bold; }
                .max-value { font-size: 46pt; font-weight: 900; display: block; border-bottom: 8pt solid #000; padding-bottom: 8px; text-align: left; }
                .heavy-bar { background: #000 !important; color: #fff !important; padding: 25px; font-size: 48pt; margin-top: 50px; text-transform: uppercase; text-align: center; font-weight: 900; }
            </style>
            <div style="border-bottom: 16pt solid #000; padding-bottom: 30px; margin-bottom: 40px; text-align: center;">
                <div class="header-main">METRO RAILWAY</div>
                <div style="font-size: 35pt; font-weight: 900;">WARRANTY SUPPORT DOCUMENT</div>
            </div>
            <div style="text-align:right; font-size: 28pt; font-weight: 900;">REF INVOICE: ${invoiceNo}</div>
            <span class="max-label">CUSTOMER / SITE:</span><span class="max-value">${site.toUpperCase()}</span>
            
            <div class="heavy-bar">WARRANTY COVERAGE PERIOD</div>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead><tr style="border-bottom: 10pt solid #000;"><th style="text-align:left; font-size: 26pt;">ASSET DESCRIPTION</th><th style="font-size: 26pt;">TENURE</th><th style="text-align:right; font-size: 26pt;">EXPIRY DATE</th></tr></thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            
            <div style="margin-top: 100px; display: flex; justify-content: flex-start;">
                <div style="width: 100%;">
                    <div style="font-size: 24pt; text-decoration: underline; font-weight: bold; margin-bottom: 10px;">WARRANTY COMMENCEMENT:</div>
                    <div style="font-size: 50pt; font-weight: 900; border: 6pt solid #000; padding: 15px 30px; display: inline-block;">${saleDate}</div>
                    <div style="font-size: 18pt; margin-top: 10px; font-weight: bold; text-transform: uppercase;">OFFICIAL SYSTEM VALIDATED START DATE</div>
                </div>
            </div>

            <div style="margin-top: 150px; font-size: 16pt; text-align: center; border-top: 3pt dashed #000; padding-top: 20px; font-weight:bold; text-transform:uppercase;">
                [DOCUMENT AUTHENTICATED VIA MASTER DATABASE - NO PHYSICAL SIGNATURE REQUIRED]
            </div>
        </div>`;
    reportContainer.classList.remove("hidden");
    window.scrollTo(0, 0);
};

// 5. Scan Success Handler
const oldOnScanSuccess = window.onScanSuccess;
window.onScanSuccess = async function(decodedText) {
    if(scanMode === 'WARRANTY_CLAIM') {
        closeBarcodeScanner();
        const display = document.getElementById("claimDisplay");
        if(display) display.classList.remove("hidden");
        
        const q = query(ref(db, "inventory"), orderByChild("barcode"), equalTo(decodedText));
        const snap = await get(q);
        
        if(!snap.exists()) {
            const statusBox = document.getElementById("claimStatusBox");
            if(statusBox) statusBox.innerHTML = `<span style="color:red;">‚ùå TAG ID NOT REGISTERED</span>`;
            return;
        }

        let item; snap.forEach(c => item = c.val());
        const war = calculateWarranty(item.soldAt, item.warrantyMonths, item.manualWarDate);
        
        document.getElementById("claimItemName").innerText = item.item;
        document.getElementById("claimInv").innerText = item.invoiceNo || "N/A";
        document.getElementById("claimSite").innerText = item.assignedStation || "IN STORE";
        document.getElementById("claimDate").innerText = war ? war.start : "NOT DEPLOYED";
        
        const statusBox = document.getElementById("claimStatusBox");
        if(item.status !== "Sold Out") {
            statusBox.innerHTML = `<span style="color:#d97706;">‚ùå ITEM NOT YET DEPLOYED</span>`;
            document.getElementById("btnFinalClaim").disabled = true;
        } else if (!war) {
             statusBox.innerHTML = `<span style="color:#d97706;">‚ö†Ô∏è WARRANTY NOT SET UP</span>`;
             document.getElementById("btnFinalClaim").disabled = true;
        } else if (war.expired) {
            statusBox.innerHTML = `<div style="color:#b91c1c;">üö´ COVERAGE EXPIRED ON: ${war.expiry}</div>`;
            document.getElementById("btnFinalClaim").disabled = true;
        } else {
            statusBox.innerHTML = `
                <div style="background:#f0fdf4; border: 2px solid #15803d; padding:15px; border-radius:10px; color:#15803d;">
                    <span style="font-size:32px; font-weight:900;">${war.daysLeft} DAYS LEFT</span><br>
                    <small>Valid Until: ${war.expiry}</small>
                </div>`;
            document.getElementById("btnFinalClaim").disabled = false;
        }
        return;
    }
    if(typeof oldOnScanSuccess === "function") oldOnScanSuccess(decodedText);
};

// 6. Support Loaders (Dashboard, Setup, Active List, Sales)
async function refreshWarDash() {
    try {
        const snap = await get(ref(db, "inventory"));
        let total = 0;
        let protectedCount = 0;

        if (snap.exists()) {
            snap.forEach(c => {
                const v = c.val();
                total++;

                // COUNT IF: Protection flag is true (set during Warranty Setup)
                if (v.protectionActivated === true) {
                    protectedCount++;
                }
            });
        }
        
        // Update the visual labels
        const totalEl = document.getElementById("warTotalAssets");
        const protectedEl = document.getElementById("warProtected");
        
        if(totalEl) totalEl.innerText = total;
        if(protectedEl) protectedEl.innerText = protectedCount;
        
    } catch (e) {
        console.error("Dashboard Sync Error:", e);
    }
}

async function loadWarSetup() {
    const tbody = document.getElementById("warSetupTableBody");
    if (!tbody) return;

    try {
        const snap = await get(ref(db, "inventory")); 
        tbody.innerHTML = "";

        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No records.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const v = c.val();
            const displayDate = v.manualWarDate ? 
                new Date(v.manualWarDate).toLocaleDateString('en-IN') : 
                (v.soldAt ? new Date(v.soldAt).toLocaleDateString('en-IN') : "NOT SET");

            // LOGIC: Check if it was marked as Non-Warranty
            let tenureText = v.warrantyMonths ? v.warrantyMonths + ' Months' : 'NOT SET';
            if (v.noWarranty) tenureText = '<span style="color:red; font-weight:900;">NON-WARRANTY</span>';

            tbody.innerHTML += `<tr>
                <td style="font-family:monospace; font-weight:bold;">${v.barcode || '--'}</td>
                <td>${v.item || '--'}</td>
                <td style="font-size:11px;">${displayDate}</td>
                <td style="font-weight:bold; color:var(--metro-blue);">${tenureText}</td>
                <td><button class="info" onclick="document.getElementById('warSetupTag').value='${v.barcode}'">Select</button></td>
            </tr>`;
        });
    } catch (e) {
        console.error("Load Setup Error:", e);
    }
}
async function loadWarSales() {
    const tbody = document.getElementById("warSalesTableBody");
    const snap = await get(ref(db, "inventory"));
    const salesGroup = {}; 
    
    snap.forEach(c => {
        const v = c.val();
        if(v.invoiceNo) {
            if(!salesGroup[v.invoiceNo]) {
                salesGroup[v.invoiceNo] = { 
                    site: v.assignedStation, 
                    date: v.soldAt, 
                    items: [],
                    billedTo: v.holder || "METRO" 
                };
            }
            salesGroup[v.invoiceNo].items.push(v.item);
        }
    });

    tbody.innerHTML = "";
    Object.entries(salesGroup).forEach(([inv, data]) => {
        tbody.innerHTML += `<tr>
            <td style="font-family:monospace; font-weight:bold; color:#0284c7;">${inv}</td>
            <td style="font-weight:bold;">${data.site}</td>
            <td>${new Date(data.date).toLocaleDateString('en-IN')}</td>
            <td style="font-size:11px;">${data.items.join(", ")}</td>
            <td style="text-align:center; white-space:nowrap;">
                <button onclick="printCustomerCopy('${inv}')" class="info" title="Warranty Copy"><i class="fas fa-shield-alt"></i></button>
                <button onclick="reissueInvoice('${inv}', ${data.date})" class="success" style="background:#15803d; margin-left:5px;" title="Reissue Bill">
                    <i class="fas fa-file-invoice"></i> REISSUE
                </button>
            </td>
        </tr>`;
    });
}
window.reissueInvoice = async (invoiceNo, saleDateTs) => {
    const NOW = Date.now();
    const TWO_MONTHS_MS = 60 * 24 * 60 * 60 * 1000; // Approx 60 days

    // 1. Check Date Constraint
    if (NOW - saleDateTs > TWO_MONTHS_MS) {
        return alert("‚õî ACCESS DENIED: This invoice was issued more than 2 months ago. Original bills cannot be reissued after 60 days for security reasons.");
    }

    if (!confirm("Confirm Reissue of Official Tax Invoice?")) return;

    try {
        const snap = await get(ref(db, "inventory"));
        const items = [];
        let site = "";
        let billedTo = "";

        snap.forEach(c => {
            const v = c.val();
            if(v.invoiceNo === invoiceNo) {
                site = v.assignedStation;
                billedTo = v.holder || "KOLKATA METRO RAILWAY";
                const sellRate = (parseFloat(v.purchasePrice) || 0) * 1.20;
                items.push({ name: v.item, tag: v.barcode, rate: sellRate, qty: 1, net: sellRate });
            }
        });

        // 2. Reuse the Invoice Print Template but add "REISSUE" watermark
        const reportContainer = document.getElementById("printableReportContainer");
        let billRows = "";
        let billTotal = 0;

        items.forEach(it => {
            billTotal += it.net;
            billRows += `
                <tr style="border-bottom: 5pt solid #000;">
                    <td style="padding: 15px 10px; font-size: 32pt; font-weight: 900; text-align: left;">
                        ${it.name.toUpperCase()}<br>
                        <span style="font-size: 20pt; color: #333;">(TAG: ${it.tag})</span>
                    </td>
                    <td style="text-align:right; padding: 15px 10px; font-size: 32pt;">${it.rate.toFixed(0)}</td>
                    <td style="text-align:center; padding: 15px 10px; font-size: 32pt;">${it.qty}</td>
                    <td style="text-align:right; padding: 15px 10px; font-weight: 900; font-size: 32pt;">${Math.round(it.net)}</td>
                </tr>`;
        });

        reportContainer.innerHTML = `
            <div class="no-print" style="text-align:center; padding:15px; background:#fff1f2; border-bottom:2px solid #e11d48;">
                <h3 style="color:#be123c; margin:0;">‚ö†Ô∏è DUPLICATE REISSUE PREVIEW</h3>
                <button class="danger" onclick="closeReportPreview()">CANCEL</button>
                <button onclick="window.print()" style="background:#000; color:#fff; padding:15px 40px; font-weight:bold; margin-left:10px;">PRINT REISSUE BILL</button>
            </div>
            <div class="report-paper a4-max-wrapper" style="position:relative;">
                <div style="position:absolute; top:40%; left:10%; font-size:100pt; color:rgba(0,0,0,0.05); transform:rotate(-45deg); font-weight:900; pointer-events:none; z-index:0;">DUPLICATE REISSUE</div>
                
                <div class="header-box" style="text-align:center; border-bottom:14pt solid #000; padding-bottom:25px; margin-bottom:35px;">
                    <div style="font-size: 55pt; font-weight: 900;">METRO RAILWAY</div>
                    <div style="font-size: 38pt; border: 10pt solid #000; margin-top: 30px; padding: 10px; font-weight: 900; display: inline-block;">OFFICIAL TAX INVOICE (REISSUE)</div>
                </div>

                <div style="text-align:right; font-size: 28pt; font-weight: 900; margin-bottom: 20px;">INVOICE NO: ${invoiceNo}</div>
                <div style="text-align:left; font-size: 28pt; font-weight: 900;">REISSUE DATE: ${new Date().toLocaleDateString('en-IN')}</div>
                <div style="text-align:left; font-size: 24pt; font-weight: bold; margin-top:10px;">ORIGINAL DATE: ${new Date(saleDateTs).toLocaleDateString('en-IN')}</div>
                
                <div style="background:#000; color:#fff; padding:20px; font-size:35pt; font-weight:900; margin-top:30px; text-align:center;">BILL PARTICULARS</div>
                <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                    <thead><tr style="border-bottom:8pt solid #000;"><th style="text-align:left; font-size:28pt;">DESCRIPTION</th><th style="text-align:right; font-size:28pt;">RATE</th><th style="text-align:center; font-size:28pt;">QTY</th><th style="text-align:right; font-size:28pt;">TOTAL</th></tr></thead>
                    <tbody>${billRows}</tbody>
                </table>
                <div style="background:#000; color:#fff; display:flex; justify-content:space-between; padding:25px; margin-top:10px;">
                    <span style="font-size:50pt; font-weight:900;">GRAND TOTAL:</span>
                    <span style="font-size:50pt; font-weight:900;">‚Çπ ${Math.round(billTotal).toLocaleString('en-IN')}</span>
                </div>
                <div style="margin-top:130px; border-top:12pt solid #000; width:50%; text-align:left;">
                    <div style="font-size:40pt; font-weight:900;">${currentUser.name.toUpperCase()}</div>
                    <div style="font-size:28pt; font-weight:900;">AUTHORIZED SIGNATORY</div>
                </div>
            </div>`;

        reportContainer.classList.remove("hidden");
        window.scrollTo(0, 0);

    } catch (e) {
        alert("Reissue Error: " + e.message);
    }
};
async function loadActiveWarranty() {
    const tbody = document.getElementById("warActiveTableBody");
    const snap = await get(ref(db, "inventory"));
    tbody.innerHTML = "";
    snap.forEach(c => {
        const v = c.val();
        if(v.status === "Sold Out" && v.warrantyMonths) {
            const war = calculateWarranty(v.soldAt, v.warrantyMonths, v.manualWarDate);
            const statusBadge = war.expired ? '<span class="badge-offline">EXPIRED</span>' : '<span class="badge-online">ACTIVE</span>';
            tbody.innerHTML += `<tr>
                <td style="font-family:monospace; font-weight:bold;">${v.barcode}</td>
                <td>${v.item}</td>
                <td>${war.start}</td>
                <td style="font-weight:bold; color:#b91c1c;">${war.expiry}</td>
                <td style="text-align:center; font-weight:900;">${war.daysLeft}</td>
                <td>${statusBadge}</td>
            </tr>`;
        }
    });
}
  window.toggleWarrantyFields = () => {
    const type = document.getElementById("warProductType").value;
    const isWarranty = (type === "WARRANTY");
    
    document.getElementById("divWarTenure").style.display = isWarranty ? "block" : "none";
    document.getElementById("divWarUnit").style.display = isWarranty ? "block" : "none";
    document.getElementById("divWarDate").style.display = isWarranty ? "block" : "none";
    
    if(!isWarranty) {
        document.getElementById("warDuration").value = 0;
        document.getElementById("warStartDate").value = "";
    }
};
</script>
<div id="bigImageModal" class="modal-overlay hidden" onclick="document.getElementById('bigImageModal').classList.add('hidden')">
    <div class="panel" style="background: transparent; border: none; box-shadow: none; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 0;">
        
        <div style="position: relative; max-width: 95%; max-height: 95%;">
            <button onclick="document.getElementById('bigImageModal').classList.add('hidden')" 
                    style="position: absolute; top: -15px; right: -15px; background: red; color: white; border: 2px solid white; border-radius: 50%; width: 40px; height: 40px; font-weight: bold; cursor: pointer; z-index: 1002;">
                X
            </button>
            
            <img id="bigImageViewer" src="" 
                 style="max-width: 100%; max-height: 90vh; border: 4px solid white; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.9); object-fit: contain;">
        </div>

    </div>
</div>
</body>
</html>
