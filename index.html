<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SECURE WATCHDOG</title>

<style>
*{
  box-sizing:border-box;
  user-select:none;
}
body{
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:Segoe UI,system-ui;
  overflow:hidden;
}
#lockScreen{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#020617;
  z-index:9999;
  text-align:center;
}
#app{
  display:none;
  padding:20px;
}
input,button{
  padding:10px;
  margin:5px;
}
button{
  cursor:pointer;
}
table{
  border-collapse:collapse;
  width:100%;
  margin-top:20px;
}
th,td{
  border:1px solid #334155;
  padding:8px;
}
input.cell{
  background:transparent;
  border:none;
  color:#e5e7eb;
  width:100%;
}
.blur{
  filter:blur(20px);
}
</style>
</head>

<body>

<!-- LOCK SCREEN -->
<div id="lockScreen">
  <div>
    <h1>ðŸ”’ SECURE WATCHDOG</h1>
    <p>Authentication Required</p>
    <input id="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">LOGIN</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <h2>Secure Dashboard</h2>
  <p id="roleInfo"></p>

  <button onclick="addRow()">Add Row</button>

  <table>
    <thead>
      <tr>
        <th>A</th><th>B</th><th>C</th><th id="adminCol">Action</th>
      </tr>
    </thead>
    <tbody id="sheetBody"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  set,
  onValue,
  remove,
  get
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project",
  storageBucket: "metro-railway-project.firebasestorage.app",
  messagingSenderId: "376569064381",
  appId: "1:376569064381:web:492cae73871212158180d4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let role = "user";

/* LOGIN */
window.login = ()=>{
  signInWithEmailAndPassword(auth,email.value,password.value)
    .catch(e=>alert("Access Denied"));
};

/* AUTH STATE */
onAuthStateChanged(auth, async user=>{
  if(!user) return;

  document.getElementById("lockScreen").style.display="none";
  document.getElementById("app").style.display="block";

  if(user.email === "soham@metro.project"){
    role="admin";
  }else{
    const snap = await get(ref(db,"users/"+user.uid+"/role"));
    role = snap.val() || "user";
  }

  roleInfo.innerText = "Role: " + role.toUpperCase();
  loadData();
});

/* LOAD DATA */
function loadData(){
  onValue(ref(db,"excelData"), snap=>{
    sheetBody.innerHTML="";
    snap.forEach(row=>{
      const id=row.key;
      const d=row.val();
      const tr=document.createElement("tr");

      ["A","B","C"].forEach(c=>{
        const td=document.createElement("td");
        const i=document.createElement("input");
        i.className="cell";
        i.value=d[c]||"";
        i.onchange=()=>set(ref(db,`excelData/${id}/${c}`),i.value);
        td.appendChild(i);
        tr.appendChild(td);
      });

      if(role==="admin"){
        const td=document.createElement("td");
        const b=document.createElement("button");
        b.innerText="Delete";
        b.onclick=()=>remove(ref(db,"excelData/"+id));
        td.appendChild(b);
        tr.appendChild(td);
      }

      sheetBody.appendChild(tr);
    });
  });
}

window.addRow=()=>push(ref(db,"excelData"),{A:"",B:"",C:""});

/* MAX SECURITY */
document.addEventListener("contextmenu",e=>e.preventDefault());
document.addEventListener("keydown",e=>{
  if(
    e.key==="PrintScreen" ||
    e.ctrlKey || e.altKey || e.metaKey ||
    ["F12","F5","F11","F10"].includes(e.key)
  ){
    e.preventDefault();
    document.body.classList.add("blur");
    setTimeout(()=>document.body.classList.remove("blur"),1000);
  }
});
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){
    document.body.classList.add("blur");
  }else{
    document.body.classList.remove("blur");
  }
});
</script>

</body>
</html>
