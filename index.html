<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- OFFICIAL METRO THEME (PRESERVED) --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
  flex-wrap: wrap; /* Mobile friendly */
}

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
  transition: all 0.2s;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; opacity: 0.7; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button.info { background: #17a2b8; border-color: #117a8b; color: white; }
button.secondary { background: #6c757d; border-color: #545b62; color: white; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; white-space: nowrap; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES (UPDATED FOR GOVT STYLE + MOBILE RESPONSIVE) */
.table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; min-width: 600px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; padding: 20px; box-sizing: border-box; }

/* NEW HIGH PERFORMANCE CAMERA UI */
#videoContainer {
    position: relative;
    width: 320px;
    max-width: 100%;
    height: 240px;
    background: #000;
    margin-bottom: 15px;
    border: 5px solid white;
    box-shadow: 0 0 20px rgba(0,255,0,0.2);
}
#cameraFeed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1); /* Mirror effect */
}
#overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    transform: scaleX(-1); /* Mirror overlay to match video */
}

/* UPLOAD SECTION SPECIFIC */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* CHECKBOX LIST FOR ADMIN */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #ced4da;
    padding: 10px;
    background: #fff;
    text-align: left;
}
.checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; }
.checkbox-item input { width: auto; margin-right: 10px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #555; border: 2px solid #888; }
.dot.active { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 5px #00ff00; }

/* STATUS BADGES */
.badge-online { background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.badge-offline { background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }

/* SIGNATURE CANVAS */
canvas.sig-canvas { border: 2px solid #003366; background: #fff; cursor: crosshair; touch-action: none; border-radius: 4px; display:block; max-width: 100%; }

/* NEW: BARCODE MODAL STYLES */
#reader { width: 300px; max-width: 100%; background:white; padding:10px; border-radius:4px; }

/* MOBILE RESPONSIVE TWEAKS */
@media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; gap: 10px; }
    #authContainer { margin-top: 10px; align-self: flex-start; }
    .panel { padding: 15px; }
    #videoContainer { width: 100%; height: auto; aspect-ratio: 4/3; }
    .nav-bar { padding-bottom: 15px; }
    .nav-btn { font-size: 12px; padding: 6px 10px; }
    .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    #otpUI { width: 90%; }
}
@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}
/* TIMELINE CARD STYLES */
.history-card {
    background: white;
    border-left: 5px solid #ccc; /* Default color */
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: relative;
}

.history-card.checkout { border-left-color: #b38600; } /* Yellow for OUT */
.history-card.return { border-left-color: #17a2b8; }   /* Blue for IN */
.history-card.add { border-left-color: #28a745; }      /* Green for ADD */

.hc-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
.hc-user { font-size: 14px; font-weight: bold; color: #333; }
.hc-meta { font-size: 11px; color: #666; margin-top: 4px; }
.hc-sig { position: absolute; right: 10px; bottom: 10px; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;flex-shrink:0;">M</div>
    <div><h1 style="margin:0; line-height:1.2; font-size: 1.2rem;">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:300px; max-width:90%; text-align:center;">
        <h3>User Profile Setup</h3>
        <p>Please enter your official name for the records.</p>
        <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px; text-align:center;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px; text-align:center;">Initializing AI Models...</p>
 
  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
      <div id="dot1" class="dot"></div>
      <div id="dot2" class="dot"></div>
      <div id="dot3" class="dot"></div>
  </div>

  <div id="videoContainer">
    <video id="cameraFeed" autoplay playsinline muted></video>
    <canvas id="overlayCanvas"></canvas>
  </div>
 
  <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:5px; width:280px; box-shadow: 0 0 15px black; position:absolute; z-index:20;">
    <h3 style="color:#dc3545; margin-top:0;">Face ID Failed (3/3)</h3>
    <p style="color:#333; font-size:13px;">Camera Disabled.<br>Enter OTP/PIN:</p>
    <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:18px; letter-spacing:5px; border:2px solid #dc3545;">
    <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
  </div>

  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold; height:20px; text-align:center;"></div>
 
  <div id="camControls" style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Face Scan</button>
  </div>
</div>

<div id="barcodeModal" class="modal-overlay hidden">
    <div class="panel" style="width:340px; max-width:95%; text-align:center; background:#000; border:2px solid #b38600;">
        <h3 style="color:white; margin-bottom:10px;">Scan Barcode</h3>
        <div id="reader"></div>
        <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:15px; width:100%;">Cancel / Close</button>
    </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
    <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
        <h3>Digital Signature Verification</h3>
        <img id="modalSigImage" src="" style="border:1px solid #000; background:white; max-width:100%; margin:10px 0;">
        <br>
        <button onclick="closeSigModal()">Close</button>
    </div>
</div>

<section id="appScreen" class="hidden">
 
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
    <button class="nav-btn hidden" onclick="switchTab('sysLogs')" id="btnLogs">5. System Logs</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
          <input id="inpStationName" placeholder="STATION NAME">
          <input id="inpStationLength" placeholder="STATION LENGTH (M)">
          <input id="inpYellowDist" placeholder="YELLOW LINE DIST (CM)">
          <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS (CM)">
      </div>
      <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
      <div style="text-align:right;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Draft</button>
      </div>
    </div>

    <div class="panel upload-panel">
      <h3 style="color:#003366; margin-top:0;">üìé Evidence Upload Section</h3>
      <p style="font-size:12px; color:#666;">Upload site photos, videos, or PDFs separately here.</p>
     
      <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
      <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
     
      <button class="warning" onclick="uploadEvidenceOnly()">‚¨Ü Upload Evidence to Database</button>
      <div style="margin-top:5px;"><small style="color:red;">* Max 1.5 MB per file (Strict Limit)</small></div>
    </div>

    <div class="panel">
      <h4>Distance Data</h4>
      <div class="table-wrapper">
        <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final Data</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button onclick="toggleInvMode('list')" class="primary">üì¶ View Stock</button>
        <button onclick="toggleInvMode('add')" class="success">‚ûï Add New Item</button>
        <button onclick="toggleInvMode('checkout')" class="warning">üì§ Checkout</button>
        <button onclick="toggleInvMode('return')" class="info">üì• Return Item</button>
        <button onclick="toggleInvMode('history')" class="secondary">üìú Audit Trail</button>
    </div>

    <div id="inv-add" class="panel hidden" style="background:#f8f9fa;">
      <h3 style="color:#003366;">Add Unique Item (Serialize)</h3>
      <p style="font-size:12px; color:#666;">
        <strong>Strict Rule:</strong> Every physical item must have a unique barcode.<br>
        If you have 5 drills, scan each one separately.
      </p>
      
      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px;">
           <div style="display:flex; gap:5px;">
               <input id="invBarcode" placeholder="Scan Unique Barcode" onchange="checkBarcodeUnique(this.value)">
               <button onclick="openBarcodeScanner('ADD')" class="info" style="width:60px; padding:0;"><i class="fas fa-qrcode"></i></button>
           </div>
           <input id="invName" placeholder="Product Name (e.g. Drill Machine)">
      </div>
      
      <div id="barcodeError" class="hidden" style="background:#f8d7da; color:#721c24; padding:10px; border-radius:4px; margin-bottom:10px;">
          ‚ùå <strong>Error:</strong> This barcode already exists! You cannot add duplicates.
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <select id="invCondition">
              <option value="New">New</option>
              <option value="Good" selected>Good</option>
              <option value="Fair">Fair</option>
              <option value="Damaged">Damaged</option>
          </select>
          <button id="btnAddStock" onclick="addUniqueItem()" class="success">Save Item to Stock</button>
      </div>
    </div>

    <div id="inv-checkout" class="panel hidden" style="border: 2px solid #b38600;">
        <h3 style="color:#b38600;">üì§ Checkout Item</h3>
        <p style="text-align:center; color:#666; font-size:12px;">
            Scan a unique barcode to check it out to a user.
        </p>
        
        <div style="text-align:center; padding:20px;">
            <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:16px; padding:15px 30px; width:100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <i class="fas fa-qrcode"></i> SCAN ITEM BARCODE
            </button>
        </div>

        <div id="checkout_display" class="hidden" style="background:#fff3cd; padding:15px; border:1px solid #ffeeba; text-align:center; margin-top:10px; border-radius:4px;">
            <h2 id="checkout_item_name" style="color:#856404; margin:10px 0 5px 0;">--</h2>
            <div style="font-family:monospace; font-size:14px; color:#555; margin-bottom:15px;">
                Barcode: <span id="checkout_item_code" style="font-weight:bold;">--</span>
            </div>
            
            <div id="btn_checkout_verify">
                 <button onclick="initTransactionAuth('CHECKOUT')" style="background:#b38600; color:white; padding:12px 20px; width:100%; font-weight:bold; border:none; border-radius:4px; cursor:pointer;">
                    üõ°Ô∏è Admin Face Approve
                 </button>
            </div>
        </div>
    </div>

    <div id="inv-return" class="panel hidden" style="border: 2px solid #17a2b8;">
        <h3 style="color:#17a2b8;">üì• Return Item</h3>
        <p style="text-align:center; color:#666; font-size:12px;">
            Scan an item to return it to the store.
        </p>
        
        <div style="text-align:center; padding:20px;">
            <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:16px; padding:15px 30px; width:100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <i class="fas fa-qrcode"></i> SCAN ITEM TO RETURN
            </button>
        </div>

        <div id="return_display" class="hidden" style="background:#d1ecf1; padding:15px; border:1px solid #bee5eb; text-align:center; margin-top:10px; border-radius:4px;">
            <h2 id="return_item_name" style="color:#0c5460; margin:10px 0 5px 0;">--</h2>
            <div style="font-family:monospace; font-size:14px; color:#555; margin-bottom:15px;">
                Barcode: <span id="return_item_code" style="font-weight:bold;">--</span>
            </div>

            <div id="btn_return_verify">
                 <button onclick="initTransactionAuth('RETURN')" style="background:#17a2b8; color:white; padding:12px 20px; width:100%; font-weight:bold; border:none; border-radius:4px; cursor:pointer;">
                    üõ°Ô∏è Admin Face Approve
                 </button>
            </div>
        </div>
    </div>
<div id="inv-history" class="panel hidden">
    <div style="text-align:center; padding:40px 20px;">
        <h2 style="color:#003366; margin-bottom:10px;">üîç Item Audit Trail</h2>
        <p style="color:#666; margin-bottom:20px;">Scan a barcode to open the history window.</p>
        
        <div style="max-width:400px; margin:0 auto; display:flex; gap:10px;">
            <input 
                id="auditSearchInput" 
                placeholder="Scan or Enter Barcode..." 
                style="padding:12px; font-size:16px; border:2px solid #003366; border-radius:5px; flex-grow:1;"
                onchange="fetchAuditHistory(this.value)"
            >
            <button 
                onclick="openBarcodeScanner('AUDIT_SEARCH')" 
                class="warning" 
                style="padding:12px 20px; font-size:18px;"
            >
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>
    </div>

<div id="auditResultModal" class="modal-overlay hidden">
    <div class="panel" style="width:400px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; background:#f4f6f9;">
        
        <div style="background:#003366; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-size:16px; border:none; color:white;">üì¶ Item Lifecycle</h3>
                <small id="auditModalBarcode" style="opacity:0.8; font-family:monospace;">--</small>
            </div>
            <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div id="auditTimelineContainer" style="overflow-y:auto; padding:15px; flex-grow:1;">
            <div style="text-align:center; color:#777;">Loading data...</div>
        </div>

    </div>
</div>
<div id="auditResultModal" class="modal-overlay hidden">
    <div class="panel" style="width:400px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
        
        <div style="background:#003366; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-size:16px; border:none; color:white;">üì¶ Item History</h3>
                <small id="auditModalBarcode" style="opacity:0.8;">--</small>
            </div>
            <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:20px;">‚úï</button>
        </div>

        <div id="auditTimelineContainer" style="overflow-y:auto; padding:15px; background:#f4f6f9; flex-grow:1;">
            <div style="text-align:center; color:#777;">Loading data...</div>
        </div>

    </div>
</div>
    <div id="inv-list" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #003366; padding-bottom:10px; margin-bottom:10px;">
        <div>
            <h3 style="margin:0;">Current Stock</h3>
            <small id="stockSummaryText" style="color:#003366; font-weight:bold;">Loading...</small>
        </div>
        
        <div style="display:flex; gap:5px;">
            <input type="text" id="mainStockSearch" onkeyup="filterStockTable()" placeholder="üîç Search Product or Barcode..." style="width:200px; margin:0;">
            <button onclick="openBarcodeScanner('SEARCH_STOCK')" class="info" style="padding:5px 10px;" title="Scan to Search">
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>

    <div class="table-wrapper" style="max-height:600px; overflow-y:auto;">
        <table>
            <thead style="position:sticky; top:0; background:#e9ecef;">
                <tr>
                    <th>Barcode</th>
                    <th>Product</th>
                    <th>Added By</th>
                    <th>Usage (Times Out)</th>
                    <th>Current Holder</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
</div>
  </div>

  <div id="tab-gallery" class="hidden">
    <div class="panel">
      <h3>üìÅ Site Evidence Gallery</h3>
      <div id="galleryContainer" class="gallery-grid"></div>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã My Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ°Ô∏è Administrator Console</h3>
        <button onclick="loadAdminPanel()" class="primary">üîÑ Refresh</button>
      </div>

      <h4 style="background:#eee; padding:5px;">1. User Status & Permissions</h4>
      <div class="table-wrapper">
      <table>
          <thead>
              <tr>
                  <th>Name (User)</th>
                  <th>Online Status</th>
                  <th>Work Progress (Live)</th>
                  <th>Biometric Status</th>
                  <th>Admin Actions</th>
              </tr>
          </thead>
          <tbody id="userListBody"></tbody>
      </table>
      </div>
     
      <h4 style="background:#eee; padding:5px;">2. Assign Work</h4>
      <label>Select Students/Users:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="1" placeholder="Enter Task Details..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:5px;">Assign to Selected Users</button>
</div> <div id="adminTaskModal" class="modal-overlay hidden">
    <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #003366; padding-bottom:10px; margin-bottom:10px;">
            <h3 style="margin:0; color:#003366;">üìã Task Tracking: <span id="modalTaskUserName">User</span></h3>
            <button class="danger" onclick="closeTaskModal()" style="padding:5px 10px;">Close X</button>
        </div>
       
        <div style="overflow-y:auto; flex-grow:1;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr style="background:#003366; color:white;">
                            <th>Date</th>
                            <th>Task Description</th>
                            <th>Assigned By</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="adminTaskBody">
                        <tr><td colspan="5" style="text-align:center;">Loading tasks...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
    </div>
  </div>

  <div id="tab-sysLogs" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #ddd; padding-bottom:10px; margin-bottom:15px; flex-wrap:wrap;">
            <h3 style="margin:0;">üñ•Ô∏è System Master Logs</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="sysLogSearch" onkeyup="filterSysLogs()" placeholder="üîç Filter Logs..." style="padding:6px;">
                <button onclick="loadSysLogs()" class="primary">üîÑ Live Sync</button>
            </div>
        </div>
       
        <div style="height:500px; overflow-y:scroll; border:1px solid #ccc; background:#fafafa; font-family:'Consolas', monospace;">
            <div class="table-wrapper">
            <table style="width:100%; border-collapse:collapse;">
                <thead style="position:sticky; top:0; background:#e9ecef;">
                    <tr>
                        <th style="width:140px;">Timestamp</th>
                        <th style="width:80px;">Level</th>
                        <th>Event Type</th>
                        <th>User</th>
                        <th>Details / Payload</th>
                    </tr>
                </thead>
                <tbody id="fullLogBody">
                      <tr><td colspan="5" style="text-align:center;">Initializing Log Stream...</td></tr>
                </tbody>
            </table>
            </div>
        </div>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];
let modelsLoaded = false;
let isTransactionAuth = false;
let currentTransactionType = "";

// --- UNIFIED SCAN MODE VARIABLE ---
// I have removed the duplicate 'let scanMode'.
// This single variable now handles ALL modes: 'LOGIN', 'RECEIVER', 'ADMIN', 'ADD', 'CHECKOUT', 'RETURN'
let scanMode = 'LOGIN';

let receiverVerified = false;

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null; // Stores details of scanned item for Checkout/Return
// --- NEW BARCODE VARS ---
let scanner = null;
let existingItemKey = null; // To track if we are updating existing stock

// --- SIGNATURE PAD LOGIC (UPDATED FOR MOBILE) ---
// --- ROBUST SIGNATURE LOGIC (PC + MOBILE FIX) ---
// --- FINAL ROBUST SIGNATURE (POINTER EVENTS) ---
function setupCanvas(id) {
    const canvas = document.getElementById(id);
    if (!canvas) return; // Safety check

    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 3;       // Thicker line for better visibility on mobile
    ctx.lineCap = 'round';   // Smooth edges
    ctx.strokeStyle = '#000000';

    let isDrawing = false;

    // 1. FORCE DISABLE SCROLLING ON CANVAS via JS
    // This effectively tells the browser: "The user cannot scroll when touching this box"
    canvas.style.touchAction = 'none';

    // Helper to get exact coordinates
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        // Calculate scaling (vital if CSS shrinks the canvas)
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
       
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    // --- POINTER EVENTS (Handles Mouse + Touch automatically) ---

    // Start Drawing
    canvas.addEventListener('pointerdown', (e) => {
        isDrawing = true;
        canvas.setPointerCapture(e.pointerId); // LOCKS pointer to canvas so you can't scroll away
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
    });

    // Draw Line
    canvas.addEventListener('pointermove', (e) => {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
    });

    // Stop Drawing
    canvas.addEventListener('pointerup', (e) => {
        isDrawing = false;
        canvas.releasePointerCapture(e.pointerId);
    });

    // Cancel (e.g. finger slides off screen edge)
    canvas.addEventListener('pointercancel', () => {
        isDrawing = false;
    });
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => {
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// --- NEW HELPER: Signature Modal ---
window.viewSignature = (sigData) => {
    document.getElementById("modalSigImage").src = sigData;
    document.getElementById("sigModal").classList.remove("hidden");
};
window.closeSigModal = () => document.getElementById("sigModal").classList.add("hidden");

// --- NEW BARCODE LOGIC ---
window.openBarcodeScanner = (mode) => {
    scanMode = mode;
    document.getElementById("barcodeModal").classList.remove("hidden");
   
    // START SCANNER
    if(!scanner) {
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess, onScanFailure);
    }
}

window.closeBarcodeScanner = () => {
    document.getElementById("barcodeModal").classList.add("hidden");
    if(scanner) {
        scanner.clear();
        scanner = null;
    }
}
// --- NEW AUDIT LOGIC ---
window.closeAuditModal = () => document.getElementById("auditResultModal").classList.add("hidden");
window.fetchAuditHistory = async (barcode) => {
    if (!barcode) return;

    // Open popup
    const modal = document.getElementById("auditResultModal");
    const container = document.getElementById("auditTimelineContainer");
    document.getElementById("auditModalBarcode").innerText = "Barcode: " + barcode;
    modal.classList.remove("hidden");

    container.innerHTML = `<div style="text-align:center; padding:20px;">Loading...</div>`;

    try {
        const q = query(
            ref(db, "logs"),
            orderByChild("barcode"),
            equalTo(barcode)
        );

        const snap = await get(q);

        if (!snap.exists()) {
            container.innerHTML = `<div style="text-align:center;color:#777;">No history found</div>`;
            return;
        }

        // 1. collect only checkout & return
        let raw = [];
        snap.forEach(c => {
            const v = c.val();
            if (v.type === "CHECKOUT" || v.type === "RETURN") {
                raw.push(v);
            }
        });

        // 2. sort old ‚Üí new
        raw.sort((a, b) => a.time - b.time);

        // 3. pair checkout + return
        let records = [];
        let open = null;

        raw.forEach(l => {
            if (l.type === "CHECKOUT") {
                open = {
                    user: l.takenBy,
                    checkout: l.time,
                    return: null
                };
                records.push(open);
            }

            if (l.type === "RETURN" && open) {
                open.return = l.time;
                open = null;
            }
        });

        // 4. last 4 only (latest first)
        records = records.slice(-20).reverse();

        // 5. render popup cards
        container.innerHTML = "";

        records.forEach(r => {
            const co = new Date(r.checkout).toLocaleString("en-IN", {
                timeZone: "Asia/Kolkata",
                day: "2-digit",
                month: "short",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                hour12: true
            });

            const ro = r.return
                ? new Date(r.return).toLocaleString("en-IN", {
                    timeZone: "Asia/Kolkata",
                    day: "2-digit",
                    month: "short",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true
                })
                : "Still Holding";

            container.innerHTML += `
                <div class="history-card ${r.return ? 'return' : 'checkout'}">
                    <div class="hc-header">
                        <span class="hc-user">üë§ ${r.user}</span>
                        <span style="font-size:11px;color:#666;">
                            ${r.return ? 'RETURNED' : 'OUT'}
                        </span>
                    </div>
                    <div class="hc-meta">
                        üì§ Checkout: <b>${co}</b><br>
                        üì• Return: <b>${ro}</b>
                    </div>
                </div>
            `;
        });

    } catch (e) {
        console.error(e);
        container.innerHTML = `<div style="color:red;text-align:center;">Error loading data</div>`;
    }
};

// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};

// --- 4. DUMMY FUNCTION (To prevent errors if HTML still calls it) ---
// --- REAL-TIME HISTORY LOGIC ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Syncing Live Data...</td></tr>";

    // This listener stays open and updates automatically when DB changes
    const dbRef = getDatabase();
    const q = query(ref(dbRef, "logs"), limitToLast(100));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); // Show newest events at the top

        // Filter: Show only inventory-related events (Checkout, Return, Add)
        const invLogs = logs.filter(l => 
            l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE'
        );

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded recently.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        
        invLogs.forEach(l => {
            // Badge Styling
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            // Barcode formatting
            const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px; letter-spacing:1px;">${l.barcode}</div>` : '';

            // Row HTML
            const row = `
            <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
                <td style="vertical-align:middle;">${barcodeDisplay}</td>
                <td style="font-weight:bold; vertical-align:middle;">${l.takenBy || 'Unknown'}</td>
                <td style="vertical-align:middle;">
                    ${formatTime(l.time)}
                </td>
                <td style="text-align:center; vertical-align:middle;">${badge}</td>
                <td style="vertical-align:middle;">
                    <span style="font-size:13px; font-weight:bold; color:#333;">${l.item}</span><br>
                    <small style="color:#777;">Auth: ${l.approvedBy || 'System'}</small>
                </td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    });
};
window.onScanSuccess = async function(decodedText) {
    closeBarcodeScanner();
    console.log("SCANNED:", decodedText, "MODE:", scanMode);

    // ---------------- ADD STOCK ----------------
    if (scanMode === 'ADD') {
        document.getElementById("invBarcode").value = decodedText;
        checkBarcodeUnique(decodedText);
        return;
    }

    // ---------------- CHECKOUT / RETURN ----------------
    if (scanMode === 'CHECKOUT' || scanMode === 'RETURN') {

        const isCheckout = scanMode === 'CHECKOUT';

        const displayId = isCheckout ? "checkout_display" : "return_display";
        const nameId    = isCheckout ? "checkout_item_name" : "return_item_name";
        const codeId    = isCheckout ? "checkout_item_code" : "return_item_code";
        const authBtnId = isCheckout ? "btn_checkout_verify" : "btn_return_verify";

        document.getElementById(displayId).classList.remove("hidden");
        document.getElementById(nameId).innerHTML = "üîç Checking inventory...";
        document.getElementById(codeId).innerText = decodedText;

        try {
            const q = query(
                ref(db, "inventory"),
                orderByChild("barcode"),
                equalTo(decodedText)
            );

            const snap = await get(q);

            if (!snap.exists()) {
                document.getElementById(nameId).innerHTML =
                    `<span style="color:red;">‚ùå Item not found</span>`;
                alert("This barcode does not exist in inventory.");
                return;
            }

            let item = null;
            let itemKey = null;
            snap.forEach(c => {
                item = c.val();
                itemKey = c.key;
            });

            const currentUserName =
                currentUser.name || currentUser.email;

            // ---------- CHECKOUT RULE ----------
            if (isCheckout && item.status !== "In Stock") {
                document.getElementById(nameId).innerHTML = `
                    <span style="color:red;font-weight:bold;">‚õî ALREADY CHECKED OUT</span><br>
                    ${item.item}<br>
                    <small>Held by: <b>${item.holder}</b></small>
                `;
                document.getElementById(authBtnId).style.display = "none";
                return;
            }

            // ---------- RETURN RULE ----------
            if (!isCheckout) {

                if (item.status === "In Stock") {
                    document.getElementById(nameId).innerHTML = `
                        <span style="color:red;font-weight:bold;">‚õî ALREADY RETURNED</span><br>
                        ${item.item}
                    `;
                    document.getElementById(authBtnId).style.display = "none";
                    return;
                }

                // üö® CORE SECURITY RULE
                if (item.holder !== currentUserName) {
                    document.getElementById(nameId).innerHTML = `
                        <span style="color:red;font-weight:bold;">‚õî RETURN DENIED</span><br>
                        ${item.item}<br>
                        <small>
                            Checked out by: <b>${item.holder}</b>
                        </small>
                    `;
                    document.getElementById(authBtnId).style.display = "none";

                    alert(
                        "Return blocked.\n\n" +
                        "Item was checked out by:\n" +
                        item.holder + "\n\n" +
                        "Only the same user can return it."
                    );
                    return;
                }
            }

            // ---------- SUCCESS ----------
            document.getElementById(nameId).innerHTML = `
                <span style="color:${isCheckout ? '#b38600' : '#17a2b8'}; font-weight:bold;">
                    ‚úî Ready to ${isCheckout ? 'Checkout' : 'Return'}
                </span><br>
                <span style="font-size:1.2em">${item.item}</span>
            `;

            pendingTransactionItem = {
                key: itemKey,
                ...item
            };

            document.getElementById(authBtnId).style.display = "block";

        } catch (err) {
            console.error(err);
            alert("Database error.");
        }
    }

    // ---------------- AUDIT SEARCH ----------------
    if (scanMode === 'AUDIT_SEARCH') {
        document.getElementById("auditSearchInput").value = decodedText;
        fetchAuditHistory(decodedText);
    }

    // ---------------- STOCK SEARCH ----------------
    if (scanMode === 'SEARCH_STOCK') {
        document.getElementById("mainStockSearch").value = decodedText;
        filterStockTable();
    }
};

// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};

// --- 4. EMPTY/DUMMY LOAD HISTORY (Prevents errors when clicking tab) ---
window.loadInventoryHistory = () => {
    // Intentionally empty or just focuses the search box
    // Because we removed the table
    setTimeout(() => document.getElementById("auditSearchInput").focus(), 300);
};

// --- 2. UNIFIED SCANNER HANDLER (This replaces your old one) ---


// --- 3. HELPER TO CLOSE MODAL ---
window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; 
};


window.closeAuditModal = () => {
    document.getElementById("auditResultModal").classList.add("hidden");
    document.getElementById("auditSearchInput").value = ""; // Clear input
};
// --- UNIFIED SCANNER HANDLER ---

function onScanFailure(error) {
    // Do nothing, keep scanning
}

// --- INNOVATIVE BARCODE LOGIC: CHECK EXISTENCE ---
// --- NEW LOGIC: PREVENT DUPLICATE BARCODES ---
window.checkBarcodeUnique = async (code) => {
    if(!code) return;
    
    // Reset UI
    document.getElementById("barcodeError").classList.add("hidden");
    document.getElementById("btnAddStock").disabled = false;
    document.getElementById("btnAddStock").innerText = "Save Item to Stock";

    // Query DB to see if barcode exists
    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(code));
    const snap = await get(q);

    if(snap.exists()) {
        // ERROR: DUPLICATE FOUND
        document.getElementById("barcodeError").classList.remove("hidden");
        document.getElementById("btnAddStock").disabled = true;
        document.getElementById("btnAddStock").innerText = "‚õî Duplicate Barcode";
        
        // Optional: Show who has it
        let existingItem = null;
        snap.forEach(c => existingItem = c.val());
        alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
    }
}
// --- NEW: TRIGGER RECEIVER SCAN ---
window.startReceiverScan = (type) => {
    scanMode = 'RECEIVER';
    currentTransactionType = type; // 'CHECKOUT' or 'RETURN'
   
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "üë§ Receiver Verification";
    document.getElementById("modalDesc").innerText = "Please look at the camera to verify identity.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Verify My Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
   
    // UI Cleanup
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
   
    initCamera(true);
};
// --- 1. LOAD AI MODELS ---
async function preloadModels() {
    if(modelsLoaded) return;
    try {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]);
        modelsLoaded = true;
    } catch(e) { console.error("Model Error", e); }
}
preloadModels();

// --- 2. AUTH & WATCHDOG (RESTORED: FACE ID REQUIRED) ---
onAuthStateChanged(auth, (user) => {
  if (!user) { showLogin(); return; }
 
  currentUser = user;
  startPresenceSystem(user);
  setupIdleTimer();
  update(ref(db, `users/${user.uid}`), { email: user.email });

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const u = snap.val();
    if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    if(u) currentUser.name = u.name;

    isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
    failCount = 0;
   
    if (!u.name) {
        document.getElementById("nameModal").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        return;
    }

    if (!u.pin) { update(ref(db, `users/${user.uid}`), { pin: "1234" }); }

    document.getElementById("userInfo").innerText = `${u.name} (${user.email})`;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("btnLogs").classList.remove("hidden");
      setTimeout(loadAdminPanel, 2000);
      const auditBtn = document.getElementById("btnAuditScan");
      if(auditBtn) auditBtn.style.display = "block";
    }

    // --- RESTORED SECURITY CHECK ---
    // If not currently authorizing a transaction, force Face ID to enter
    if(!isTransactionAuth) {
        const faceModal = document.getElementById("faceModal");
        faceModal.classList.remove("hidden");
       
        if(!u.faceData) {
            // REGISTRATION FLOW
            document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup (3 Steps)";
            document.getElementById("modalDesc").innerText = "Center your face in the box.";
            document.getElementById("regProgress").classList.remove("hidden");
            updateRegDots(regSamples.length);
            document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${regSamples.length + 1} of 3`;
            document.getElementById("btnCapture").onclick = registerNewFace;
            initCamera(false);
        } else {
            // LOGIN FLOW
            document.getElementById("modalTitle").innerText = "Biometric Verification";
            document.getElementById("modalDesc").innerText = "System Ready.";
            document.getElementById("regProgress").classList.add("hidden");
            document.getElementById("btnCapture").innerText = "üì∏ Verify Identity";
            document.getElementById("btnCapture").onclick = handleFaceScan;
            initCamera(true);
        }
    }
  });
});
// --- NEW HEARTBEAT SYSTEM ---
function startPresenceSystem(user) {
    const userStatusRef = ref(db, `status/${user.uid}`);
    set(userStatusRef, { state: 'online', last_changed: serverTimestamp(), email: user.email, name: user.displayName || "User" });
    onDisconnect(userStatusRef).set({ state: 'offline', last_changed: serverTimestamp(), email: user.email });
    setInterval(() => { if(currentUser) update(userStatusRef, { last_seen: serverTimestamp() }); }, 5000);
}

function updateRegDots(count) {
    document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
    document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
    document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

function setupIdleTimer() {
    clearTimeout(idleTimer);
    window.onmousemove = resetTimer;
    window.onclick = resetTimer;
    resetTimer();
}
function resetTimer() {
    clearTimeout(idleTimer);
    if(currentUser) {
        idleTimer = setTimeout(() => {
            const logData = { user: currentUser.email, type: "LOGOUT", method: "Auto-Timeout", time: serverTimestamp() };
            push(ref(db, "logs"), logData);
            signOut(auth);
            alert("Session Timeout.");
        }, 5 * 60 * 1000);
    }
}

window.saveOfficialName = () => {
    const name = document.getElementById("officialNameInput").value;
    if(name.length < 3) return alert("Enter full valid name.");
    update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
        document.getElementById("nameModal").classList.add("hidden");
        location.reload();
    });
}

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));

window.logout = async () => {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGOUT", method: "Manual Click", time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
        signOut(auth);
    }
};

async function recordLogin(method) {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
    }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
   
    try {
        if(!modelsLoaded) {
            updateStatus("Loading AI Models...", "yellow");
            await preloadModels();
        }
       
        // Remove specific width/height constraints to let the camera decide
stream = await navigator.mediaDevices.getUserMedia({ video: true });
        vid.srcObject = stream;
        vid.onloadedmetadata = () => {
            vid.play();
            startRealTimeDetection(vid, canvas);
        };

        if(isVerify) updateStatus("LOOK AT CAMERA", "white");
        else updateStatus("REGISTRATION: CENTER FACE", "cyan");

    } catch(e) {
        console.error(e);
        updateStatus("Camera Hardware Error", "red");
    }
}

async function startRealTimeDetection(video, canvas) {
    const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
    faceapi.matchDimensions(canvas, displaySize);
    if (detectionLoop) clearInterval(detectionLoop);
    detectionLoop = setInterval(async () => {
        if (!stream) return;
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (detection) {
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            const box = resizedDetections.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
            drawBox.draw(canvas);
            currentDescriptor = detection.descriptor;
            const btn = document.getElementById("btnCapture");
            if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00";
        } else {
            currentDescriptor = null;
            const btn = document.getElementById("btnCapture");
            if(btn) btn.style.border = "1px solid #004494";
        }
    }, 100);
}

function stopCamera() {
    if(detectionLoop) clearInterval(detectionLoop);
    if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    if(vid) vid.srcObject = null;
    if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
    document.getElementById("faceModal").classList.add("hidden");
    isTransactionAuth = false;
    currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }
window.handleFaceScan = async () => {
    const btn = document.getElementById("btnCapture");
    if(!currentDescriptor) { updateStatus("‚ùå No Face Detected.", "red"); return; }
   
    btn.disabled = true;
    btn.innerText = "Processing...";
    updateStatus("Analyzing Biometrics...", "cyan");

    try {
        // --- MODE 1: RECEIVER VERIFICATION ---
        if(scanMode === 'RECEIVER') {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
           
            let match = false;
            // Check match against logged-in user
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                    if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }

            if(match) {
                updateStatus("‚úÖ IDENTITY CONFIRMED", "#00ff00");
                setTimeout(() => {
                    stopCamera();
                    receiverVerified = true;
                    // Update UI based on transaction type
                    if(currentTransactionType === 'CHECKOUT') {
                        document.getElementById("checkout_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("checkout_status_text").style.color = "green";
                        document.getElementById("btn_checkout_verify").classList.add("hidden");
                        // Enable Admin Button
                        const subBtn = document.getElementById("btn_checkout_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#b38600";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    } else {
                        document.getElementById("return_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("return_status_text").style.color = "green";
                        document.getElementById("btn_return_verify").classList.add("hidden");
                        // Enable Admin Button
                        const subBtn = document.getElementById("btn_return_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#17a2b8";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    }
                }, 1000);
            } else {
                throw new Error("Face Does Not Match User");
            }
        }

        // --- MODE 2: ADMIN AUTHORIZATION ---
        else if(scanMode === 'ADMIN') {
             const allUsersSnap = await get(ref(db, "users"));
             let adminFound = false;
             let adminName = "Unknown";

             allUsersSnap.forEach(userSnap => {
                const uData = userSnap.val();
                if(uData.faceData && ADMIN_EMAILS.includes(uData.email)) {
                    const samples = (uData.faceData[0] instanceof Array) ? uData.faceData : [uData.faceData];
                    for (let s of samples) {
                        if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) {
                            adminFound = true; adminName = uData.name; break;
                        }
                    }
                }
             });

             if(adminFound) {
                 updateStatus("‚úÖ AUTHORIZED: " + adminName, "#00ff00");
                 await processTransaction(adminName);
             } else {
                 throw new Error("Not an Admin Face");
             }
        }

        // --- MODE 3: LOGIN ---
        else {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            let match = false;
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                     if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }
            if(match) {
                updateStatus("‚úÖ VERIFIED", "#00ff00");
                await recordLogin("Biometric");
                enterApp();
            } else {
                throw new Error("Face Mismatch");
            }
        }

    } catch (error) {
        console.error(error);
        updateStatus("‚ùå " + error.message, "red");
        btn.disabled = false;
        btn.innerText = "üì∏ Retry Scan";
    }
};

window.registerNewFace = async () => {
    if(!currentDescriptor) { updateStatus("‚ùå Camera cannot see face clearly.", "orange"); return; }
    regSamples.push(Array.from(currentDescriptor));
    const count = regSamples.length;
    updateRegDots(count);
    if(count < 3) {
        updateStatus(`‚úÖ Sample ${count}/3 Captured.`, "lightgreen");
        document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${count + 1} of 3`;
    } else {
        updateStatus("üíæ Saving...", "yellow");
        await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
        alert("Registration Complete!"); location.reload();
    }
};

function handleFail() {
    failCount++;
    if(failCount >= 3) {
        stopCamera();
        document.getElementById("faceModal").classList.remove("hidden");
        document.getElementById("videoContainer").classList.add("hidden");
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden");
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${3 - failCount}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            await recordLogin("PIN Entry");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

function enterApp() {
    stopCamera();
    document.getElementById("faceModal").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadGallery(); loadInventory(); loadAssignments();
}
// --- FIXED TOGGLE FUNCTION (Crash-Free for Checkout & Return) ---
window.toggleInvMode = (mode) => {
    // 1. Hide All Panels
    document.getElementById("inv-add").classList.add("hidden");
    document.getElementById("inv-checkout").classList.add("hidden");
    document.getElementById("inv-return").classList.add("hidden");
    document.getElementById("inv-history").classList.add("hidden");
    document.getElementById("inv-list").classList.add("hidden");
    
    // 2. Show the Selected Panel
    const targetPanel = document.getElementById(`inv-${mode}`);
    if(targetPanel) targetPanel.classList.remove("hidden");
    
    // 3. (REMOVED) Old Dropdown Logic
    // We strictly removed the calls to 'populateCheckoutSelect' 
    // and 'populateReturnSelect' here. 
    // This stops the "innerHTML of null" error completely.

    // 4. Special Focus Logic for History Tab
    if(mode === 'history') {
        setTimeout(() => {
             const searchInput = document.getElementById("auditSearchInput");
             if(searchInput) searchInput.focus();
        }, 100);
    }
};
// 1. POPULATE CHECKOUT (Show All Items)
function populateCheckoutSelect() {
    const sel = document.getElementById("checkoutSelect");
    sel.innerHTML = "<option value=''>Loading...</option>";
    onValue(ref(db, "inventory"), snap => {
        sel.innerHTML = "<option value=''>Select Item...</option>";
        snap.forEach(c => {
            const v = c.val();
            const opt = document.createElement("option");
            opt.value = c.key;
            opt.text = `${v.item} (Avail: ${v.qty})`;
            opt.dataset.qty = v.qty;
            opt.dataset.name = v.item;
            // NEW: STORE BARCODE
            if(v.barcode) opt.dataset.barcode = v.barcode;
            sel.appendChild(opt);
        });
    }, { onlyOnce: true });
}

// 2. POPULATE RETURN (Show Only Items You Hold)
async function populateReturnSelect() {
    const sel = document.getElementById("returnSelect");
    sel.innerHTML = "<option value=''>Calculating your holdings...</option>";

    try {
        // A. Get current Inventory (for keys)
        const invSnap = await get(ref(db, "inventory"));
        const inventoryMap = {}; // Maps ItemName -> { key, exists, barcode }
        invSnap.forEach(c => {
            const val = c.val();
            inventoryMap[val.item] = { key: c.key, exists: true, barcode: val.barcode };
        });

        // B. Get User Logs
        const logsSnap = await get(query(ref(db, "logs")));
        const myHoldings = {}; // ItemName -> NetQuantity

        logsSnap.forEach(c => {
            const l = c.val();
            // Check if this log belongs to current user
            const isMe = (l.takenBy === currentUser.name) || (l.takenBy === currentUser.email);
           
            if (isMe) {
                if(l.type === 'CHECKOUT') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) + parseInt(l.qty);
                } else if (l.type === 'RETURN') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) - parseInt(l.qty);
                }
            }
        });

        // C. Render
        sel.innerHTML = "<option value=''>Select Item...</option>";
        let foundAny = false;

        for (const [itemName, netQty] of Object.entries(myHoldings)) {
            if (netQty > 0 && inventoryMap[itemName]) {
                foundAny = true;
                const opt = document.createElement("option");
                opt.value = inventoryMap[itemName].key; // Use inventory key for update
                opt.text = `${itemName} (You have: ${netQty})`;
                opt.dataset.qty = netQty; // Max returnable
                opt.dataset.name = itemName;
                // NEW: STORE BARCODE
                if(inventoryMap[itemName].barcode) opt.dataset.barcode = inventoryMap[itemName].barcode;
                sel.appendChild(opt);
            }
        }

        if(!foundAny) {
            sel.innerHTML = "<option value=''>No items to return.</option>";
        }

    } catch (e) {
        console.error(e);
        sel.innerHTML = "<option>Error loading.</option>";
    }
}

window.updateMaxQty = () => {
    const isCheckout = !document.getElementById("inv-checkout").classList.contains("hidden");
    const selId = isCheckout ? "checkoutSelect" : "returnSelect";
    const inpId = isCheckout ? "checkoutAvail" : "returnAvail";
   
    const sel = document.getElementById(selId);
    const opt = sel.options[sel.selectedIndex];
   
    if(opt && opt.dataset.qty) {
        document.getElementById(inpId).value = opt.dataset.qty;
    } else {
        document.getElementById(inpId).value = "";
    }
};

// --- NEW HISTORY LOADING LOGIC (FIXED) ---

function formatTime(ts) {
    if (!ts) return "N/A";
    const d = new Date(ts);
    
    // Convert to Indian Standard Time (Asia/Kolkata)
    return d.toLocaleString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}
// --- LINEAR HISTORY LOGIC (SIMPLE LIST + BARCODES) ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Retrieving Secure Records...</td></tr>";

    // Fetch last 300 logs
    const q = query(ref(db, "logs"), limitToLast(300));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse(); // Show newest events at the top

        // Filter: Show only inventory-related events
        const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE');

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded in recent history.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        
        invLogs.forEach(l => {
            // Badge Styling
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:3px 6px; border-radius:3px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            // Barcode formatting
            const barcodeDisplay = l.barcode ? `<div style="font-family:monospace; color:#003366; font-size:11px; margin-top:2px;">||| ${l.barcode}</div>` : '';

            // Row HTML
            const row = `
            <tr class="inv-log-row" style="border-bottom:1px solid #eee;">
                <td style="font-weight:bold; color:#003366;">${l.barcode || '--'}</td>
                <td style="font-weight:bold;">${l.takenBy || 'Unknown'}</td>
                <td>
                    ${formatTime(l.time)}<br>
                    <small style="color:#555;">Auth: ${l.approvedBy || 'System'}</small>
                </td>
                <td style="text-align:center;">${badge}</td>
                <td>
                    <span style="font-size:13px;">${l.item}</span>
                </td>
            </tr>`;
            
            tbody.innerHTML += row;
        });
    }, { onlyOnce: true });
};
// --- NEW SEARCH FUNCTION FOR INVENTORY ---
window.filterInvLogs = () => {
    const input = document.getElementById("invSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("inv-log-row");
   
    Array.from(rows).forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
};
window.initTransactionAuth = (type) => {
    if(!pendingTransactionItem) return alert("Please SCAN an item first.");

    scanMode = 'ADMIN';
    currentTransactionType = type;
   
    // Start Admin Biometric Flow
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = `üõ°Ô∏è Admin Authorization`;
    document.getElementById("modalDesc").innerText = "Admin: Scan face to approve 1 Unit.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Scan Admin Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
   
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
   
    initCamera(true);
};
// --- STRICT TRANSACTION LOGIC ---
async function processTransaction(adminName) {
    const isCheckout = currentTransactionType === 'CHECKOUT';
    
    if(!pendingTransactionItem) return alert("System Error: No item scanned.");

    const itemKey = pendingTransactionItem.key;
    const itemName = pendingTransactionItem.item;
    const barcode = pendingTransactionItem.barcode;

    // 1. Fetch Fresh Data (Avoid race conditions)
    const invRef = ref(db, `inventory/${itemKey}`);
    const invSnap = await get(invRef);
    
    if(!invSnap.exists()) return alert("Item vanished from DB.");
    
    const val = invSnap.val();
    const currentStatus = val.status;
    const currentUsage = val.usageCount || 0; 

    // 2. STRICT LOGIC GATES
    if(isCheckout) {
        if(currentStatus === 'Checked Out') {
            stopCamera();
            alert(`CRITICAL ERROR:\nItem is already taken by: ${val.holder}`);
            return;
        }
    } else {
        if(currentStatus === 'In Stock') {
            stopCamera();
            alert(`CRITICAL ERROR:\nItem is already in the store.`);
            return;
        }
    }

    // 3. Prepare Update Data
    const uSnap = await get(ref(db, `users/${currentUser.uid}`));
    const realUserName = uSnap.val()?.name || currentUser.email;

    let updateData = {};

    if (isCheckout) {
        // CHECKOUT: Set Holder, Status "Checked Out", INCREMENT COUNT
        updateData = {
            status: "Checked Out",
            holder: realUserName,
            usageCount: currentUsage + 1 
        };
    } else {
        // RETURN: Set Holder to Store, Status "In Stock"
        updateData = {
            status: "In Stock",
            holder: "Store"
        };
    }

    // 4. Update Database
    await update(invRef, updateData);

    // 5. Log It
    const logData = {
        type: currentTransactionType,
        item: itemName,
        barcode: barcode,
        qty: 1,
        takenBy: realUserName,
        approvedBy: adminName,
        signature: "Admin Verified",
        time: serverTimestamp()
    };

    await push(ref(db, "logs"), logData);
    
    alert(`‚úÖ ${currentTransactionType} Successful!\nItem: ${itemName}`);
    stopCamera();
    
    // UI Cleanup
    document.getElementById("checkout_display").classList.add("hidden");
    document.getElementById("return_display").classList.add("hidden");
    pendingTransactionItem = null;
    toggleInvMode('list');
}
// --- APP FEATURES ---

window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    if(!name) return alert("Station Name Required");
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name,
        len: document.getElementById("inpStationLength").value,
        yl: document.getElementById("inpYellowDist").value,
        th: document.getElementById("inpYellowThick").value,
        remarks: document.getElementById("inpRemarks").value
    });
    alert("Draft Saved");
};

window.uploadEvidenceOnly = () => {
    if(!currentFileBase64) return alert("Select a file first.");
   
    if(confirm("Upload Evidence?")) {
        push(ref(db, "history"), {
            name: "Evidence Upload",
            user: currentUser.email,
            userName: currentUser.name,
            date: new Date().toLocaleString(),
            fileData: currentFileBase64,
            fileType: currentFileType
        }).then(() => {
            document.getElementById("evidenceFile").value = "";
            document.getElementById("fileStatus").innerText = "";
            currentFileBase64 = null;
            alert("Evidence Uploaded.");
            switchTab('gallery');
        });
    }
};

window.handleFileUpload = () => {
    const file = document.getElementById("evidenceFile").files[0];
    document.getElementById("fileStatus").innerText = "Processing...";
    if(file && file.size < 1.5*1024*1024) {
        const reader = new FileReader();
        reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
        reader.readAsDataURL(file);
    } else {
        alert("File too large! Max 1.5MB");
        document.getElementById("fileStatus").innerText = "Error: File too large";
    }
}

window.submitStationData = () => {
    get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
        const d = s.val();
        if(!d || !d.details) return alert("No Data.");
        if(confirm("Submit Final?")) {
            push(ref(db, "history"), {
                ...d.details, rows: d.rows, user: currentUser.email, userName: currentUser.name, date: new Date().toLocaleString()
            }).then(() => {
                remove(ref(db, `drafts/${currentUser.uid}`));
                alert("Submitted"); switchTab('gallery');
            });
        }
    });
};

// --- ADMIN LOGIC ---
// --- UPDATED ADMIN PANEL (WITH TRACKING BUTTON) ---
window.loadAdminPanel = async () => {
    const userList = document.getElementById("userCheckboxList");
    const userTable = document.getElementById("userListBody");
   
    userList.innerHTML = "Loading...";
    userTable.innerHTML = "<tr><td colspan='5'>Loading Status...</td></tr>";

    // FETCH TASKS AND USERS
    const [userSnap, statusSnap, tasksSnap] = await Promise.all([
        get(ref(db, "users")),
        get(ref(db, "status")),
        get(ref(db, "assignments"))
    ]);
   
    const statusMap = statusSnap.val() || {};
    const allTasks = tasksSnap.val() || {};
   
    userTable.innerHTML = "";
    userList.innerHTML = "";

    userSnap.forEach(c => {
        const u = c.val();
        const uid = c.key;
        const displayName = u.name || u.email;

        // 1. Checkbox for assigning new work
        userList.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="user-check" value="${uid}"> ${displayName}</label>`;

        // 2. Online Status Logic
        let isOnline = false;
        const s = statusMap[uid];
        if(s && s.state === 'online') {
            const diff = Date.now() - (s.last_seen || 0);
            if(diff < 20000) isOnline = true;
        }
       
        const statusBadge = isOnline ?
            `<span class="badge-online">‚óè ONLINE</span>` :
            `<span class="badge-offline">‚óã OFFLINE</span>`;

        // 3. WORK PROGRESS LOGIC (UPDATED)
        let pending = 0;
        let done = 0;
        if(allTasks[uid]) {
            Object.values(allTasks[uid]).forEach(t => {
                if(t.status === 'Done') done++; else pending++;
            });
        }
       
        // The "View" Button
        const workBadge = (pending + done > 0)
    ? `<div style="font-size:11px; font-weight:bold; color:#003366; margin-bottom:5px;">${done} Done / ${pending} Pending</div>
       <button class="info" onclick="viewUserTasks('${uid}', '${encodeURIComponent(displayName)}')" style="padding:2px 8px; font-size:10px;">üëÅ View Details</button>`
    : `<span style="color:#aaa; font-size:11px;">No Tasks</span>`;

        const bioBadge = u.faceData ?
            `<span style="color:green; font-weight:bold;">‚úî Registered</span>` :
            `<span style="color:red; font-weight:bold;">‚ùå Pending</span>`;

        const pinInput = `<input id="pin_${uid}" placeholder="${u.pin||'1234'}" style="width:50px; text-align:center;"> <button onclick="savePin('${uid}')" style="padding:2px 5px;">Set</button>`;
        const reUploadBtn = `<button class="danger" style="padding:2px 5px;" onclick="forceReUpload('${uid}')">Reset Face</button>`;
        const resetNameBtn = `<button class="warning" style="padding:2px 5px;" onclick="retakeName('${uid}')">Reset Name</button>`;

        userTable.innerHTML += `<tr>
            <td>${u.name}<br><small>${u.email}</small></td>
            <td style="text-align:center;">${statusBadge}</td>
            <td style="text-align:center;">${workBadge}</td>
            <td style="text-align:center;">${bioBadge}</td>
            <td>${pinInput}<br>${reUploadBtn} ${resetNameBtn}</td>
        </tr>`;
    });
};
// --- NEW: VIEW USER TASKS ---
// --- FIXED TASK VIEWER (Paste inside module script) ---

// 1. SAFE View Function (Handles quotes in names & debugs connection)
window.viewUserTasks = (uid, rawName) => {
    console.log("Opening tasks for UID:", uid); // Debug log
   
    // safe name decoding
    const userName = decodeURIComponent(rawName);
   
    document.getElementById("modalTaskUserName").innerText = userName;
    document.getElementById("adminTaskModal").classList.remove("hidden");
   
    const tbody = document.getElementById("adminTaskBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>üîÑ Connecting to Database...</td></tr>";

    if(!db) { alert("Database connection lost! Refresh page."); return; }

    // Listen for updates
    const taskRef = ref(db, `assignments/${uid}`);
    onValue(taskRef, (snap) => {
        tbody.innerHTML = ""; // Clear loading message
       
        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:#777; padding:20px;'>üì≠ No tasks assigned to this user.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const task = c.val();
            const key = c.key;
           
            // Status styling
            const isDone = task.status === 'Done';
            const statusColor = isDone ? '#28a745' : '#ffc107'; // Green or Yellow
            const statusText = isDone ? '‚úî COMPLETED' : '‚è≥ PENDING';
            const rowBg = isDone ? '#f0fff4' : '#fff';

            tbody.innerHTML += `
            <tr style="font-size:12px; background:${rowBg};">
                <td>${task.date || '--'}</td>
                <td style="font-weight:bold; color:#003366;">${task.desc}</td>
                <td>${task.by || 'Admin'}</td>
                <td><span style="color:${statusColor}; font-weight:bold; border:1px solid ${statusColor}; padding:2px 6px; border-radius:4px;">${statusText}</span></td>
                <td style="text-align:center;">
                    <button class="danger" onclick="deleteUserTask('${uid}', '${key}')" style="padding:4px 8px; font-size:11px; cursor:pointer;">üóë Remove</button>
                </td>
            </tr>`;
        });
    }, (error) => {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan='5' style='color:red; text-align:center;'>Error loading data: ${error.message}</td></tr>`;
    });
};

// 2. Close Modal
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
    // Optional: Stop listening to data to save bandwidth (requires off() method if optimized)
};

// 3. Delete Task
window.deleteUserTask = (uid, taskKey) => {
    if(confirm("Permanently delete this task?")) {
        remove(ref(db, `assignments/${uid}/${taskKey}`))
            .then(() => console.log("Task deleted"))
            .catch(err => alert("Error: " + err.message));
    }
};
// --- NEW: CLOSE MODAL ---
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
};

// --- NEW: DELETE TASK (ADMIN OVERRIDE) ---
window.deleteUserTask = (uid, taskKey) => {
    if(confirm("Are you sure you want to remove this task?")) {
        remove(ref(db, `assignments/${uid}/${taskKey}`))
            .catch(err => alert("Error: " + err.message));
    }
};
// --- NEW SYSTEM LOGS LOGIC (AUDIT READY) ---
window.loadSysLogs = () => {
    const tbody = document.getElementById("fullLogBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>Syncing System Logs...</td></tr>";

    const q = query(ref(db, "logs"), limitToLast(200));

    onValue(q, (snap) => {
        tbody.innerHTML = "";
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse();

        if(logs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>System Clean. No logs generated.</td></tr>";
            return;
        }

        logs.forEach(x => {
            // Contextual Styling
            let rowStyle = "border-bottom:1px solid #eee;";
            let level = `<span style="color:gray; font-weight:bold;">INFO</span>`;
           
            if(x.type === "LOGIN") {
                level = `<span style="color:green; font-weight:bold;">AUTH</span>`;
                rowStyle += "background:#f0fff4;";
            }
            if(x.type === "LOGOUT") {
                level = `<span style="color:orange; font-weight:bold;">EXIT</span>`;
                rowStyle += "background:#fffbf0;";
            }
            if(x.type.includes("Fail") || x.type.includes("Error")) {
                level = `<span style="color:red; font-weight:bold;">ALERT</span>`;
                rowStyle += "background:#fff0f0;";
            }
            if(x.type === "CHECKOUT" || x.type === "RETURN" || x.type.includes("STOCK")) {
                level = `<span style="color:#003366; font-weight:bold;">TRANS</span>`;
            }

            // Clean up details
            let details = x.method || x.item || "System Event";
            if(x.qty) details += ` (Qty: ${x.qty})`;
            if(x.approvedBy) details += ` | Auth: ${x.approvedBy}`;

            tbody.innerHTML += `
            <tr class="sys-log-row" style="${rowStyle}">
                <td style="font-size:12px; color:#555;">${formatTime(x.time)}</td>
                <td style="font-size:11px;">${level}</td>
                <td style="font-weight:bold; font-size:12px;">${x.type}</td>
                <td style="font-size:12px;">${x.user || x.takenBy}</td>
                <td style="font-size:12px; font-family:monospace;">${details}</td>
            </tr>`;
        });
    });
};

// --- SEARCH FUNCTION FOR SYSTEM LOGS ---
window.filterSysLogs = () => {
    const input = document.getElementById("sysLogSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("sys-log-row");
   
    Array.from(rows).forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
};

window.deleteLogEntry = (key) => {
    if(!isAdmin) return alert("Access Denied: Admins Only.");
    if(confirm("Permanently delete this log entry?")) {
        remove(ref(db, `logs/${key}`)).catch(e => alert("Error: " + e.message));
    }
};

window.assignTaskMulti = () => {
    const desc = document.getElementById("taskDesc").value;
    if(!desc) return alert("Please enter task details.");
    const checkboxes = document.querySelectorAll('.user-check:checked');
    if(checkboxes.length === 0) return alert("Select at least one user.");

    checkboxes.forEach(cb => {
        const uid = cb.value;
        const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };
        push(ref(db, `assignments/${uid}`), task);
    });
    alert(`Task assigned to ${checkboxes.length} user(s).`);
    document.getElementById("taskDesc").value = "";
    checkboxes.forEach(cb => cb.checked = false);
};

window.savePin = (uid) => {
    const p = document.getElementById(`pin_${uid}`).value;
    if(p.length >= 4) { update(ref(db, `users/${uid}`), { pin: p }); alert("PIN Updated"); }
}

window.forceReUpload = (uid) => {
    if(confirm("Reset Face Data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset. User must scan face on next login.")); }
}
window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));

window.switchTab = (t) => {
    ['newData','inventory','gallery','assigned','adminPanel','sysLogs'].forEach(x => {
        const el = document.getElementById(`tab-${x}`);
        if(el) el.classList.add("hidden");
    });
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
   
    const target = document.getElementById(`tab-${t}`);
    if(target) target.classList.remove("hidden");
   
    // Highlight Button
    const btnId = t === 'sysLogs' ? 'btnLogs' : (t === 'newData' ? 'btnNew' : (t === 'inventory' ? 'btnInventory' : (t === 'gallery' ? 'btnGallery' : (t === 'assigned' ? 'btnAssign' : 'btnAdmin'))));
    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add("active");

    if(t==='adminPanel' && isAdmin) loadAdminPanel();
    if(t==='gallery') loadGallery();
    if(t==='sysLogs') loadSysLogs();
};

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
    const div = document.getElementById("galleryContainer");
    div.innerHTML = "<p>Loading...</p>";

    onValue(ref(db, "history"), snap => {
        div.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            if(v.fileData) {
                let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
                if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
                else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
               
                let controls = `<br><small style="color:grey;">(View Only)</small>`;
                if(isAdmin) {
                    controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
                }
                div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
            }
        });
        if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
    });
}

window.removeFile = (k) => {
    if(confirm("Remove attached file?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            document.getElementById("inpRemarks").value = d.details?.remarks || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}
function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));
// --- NEW LOGIC: LOAD STOCK WITH STATUS & SEARCH ---
// --- LIVE STOCK DISPLAY ---
function loadInventory() {
    const b = document.getElementById("inventoryBody");
    const summaryEl = document.getElementById("stockSummaryText");
    
    b.innerHTML = "<tr><td colspan='7' style='text-align:center;'>Loading live stock...</td></tr>";

    onValue(ref(db, "inventory"), snap => {
        b.innerHTML = "";
        let totalItems = 0;
        let inStockCount = 0;

        snap.forEach(c => {
            const v = c.val();
            const k = c.key;
            
            totalItems++;
            // Count items NOT checked out as available
            if(v.status !== "Checked Out") inStockCount++;

            let holderDisplay = "-";
            if(v.status === "Checked Out") {
                holderDisplay = `<span style="color:#b38600; font-weight:bold;">üë§ ${v.holder}</span>`;
            }

            let statusBadge = `<span style="color:green; font-weight:bold; background:#d4edda; padding:2px 6px; border-radius:4px;">In Stock</span>`;
            if(v.status === "Checked Out") {
                statusBadge = `<span style="color:#856404; font-weight:bold; background:#fff3cd; padding:2px 6px; border-radius:4px;">üì§ Checked Out</span>`;
            }

            const addedBy = v.addedBy || "Unknown";
            const usage = v.usageCount || 0;
            const barcode = v.barcode || "--";

            const row = `
            <tr class="stock-row">
                <td style="font-family:monospace; color:#003366; font-weight:bold;">${barcode}</td>
                <td class="search-name">${v.item}</td>
                <td style="font-size:12px; color:#555;">${addedBy}</td>
                <td style="text-align:center; font-weight:bold;">${usage}</td>
                <td>${holderDisplay}</td>
                <td>${statusBadge}</td>
                <td>
                    ${isAdmin ? `<button class="danger" onclick="delInv('${k}')" style="padding:2px 5px; font-size:10px;">Remove</button>` : ''}
                </td>
            </tr>`;
            
            b.innerHTML += row;
        });

        if(summaryEl) {
            summaryEl.innerHTML = `Total Items: ${totalItems} | <span style="color:green;">Available: ${inStockCount}</span>`;
        }
    });
}

// --- DUPLICATE CHECK ---
window.checkBarcodeUnique = async (code) => {
    if(!code) return;
    
    document.getElementById("barcodeError").classList.add("hidden");
    document.getElementById("btnAddStock").disabled = false;
    document.getElementById("btnAddStock").innerText = "Save Item to Stock";

    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(code));
    const snap = await get(q);

    if(snap.exists()) {
        document.getElementById("barcodeError").classList.remove("hidden");
        document.getElementById("btnAddStock").disabled = true;
        document.getElementById("btnAddStock").innerText = "‚õî Duplicate Barcode";
        
        let existingItem = null;
        snap.forEach(c => existingItem = c.val());
        alert(`STOP: Barcode '${code}' is already registered as:\n"${existingItem.item}"\nStatus: ${existingItem.status}`);
    }
}

// --- ADD ITEM ---
window.addUniqueItem = async () => {
    const item = document.getElementById("invName").value;
    const cond = document.getElementById("invCondition").value;
    const barcode = document.getElementById("invBarcode").value;

    if(!item || !barcode) return alert("Product Name and Barcode are required.");

    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(barcode));
    const snap = await get(q);

    if(snap.exists()) return alert("CRITICAL ERROR: Barcode already exists.");

    await push(ref(db, "inventory"), {
        barcode: barcode,
        item: item,
        condition: cond,
        status: "In Stock",
        holder: "Store",
        usageCount: 0, 
        addedBy: currentUser.name || currentUser.email,
        dateAdded: serverTimestamp()
    });

    await push(ref(db, "logs"), {
        type: "STOCK_ADD",
        item: item,
        barcode: barcode,
        qty: 1,
        takenBy: currentUser.name,
        approvedBy: "Self",
        time: serverTimestamp()
    });

    alert("‚úÖ Item Added!");
    document.getElementById("invBarcode").value = "";
    document.getElementById("invName").value = "";
    document.getElementById("invBarcode").focus();
};
// --- NEW SEARCH FUNCTION ---
window.filterStockTable = () => {
    const input = document.getElementById("mainStockSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("stock-row");

    Array.from(rows).forEach(row => {
        // Search in Barcode (col 0) and Name (col 1)
        const barcode = row.cells[0].innerText.toLowerCase();
        const name = row.cells[1].innerText.toLowerCase();
        const holder = row.cells[3].innerText.toLowerCase();

        if (name.includes(input) || barcode.includes(input) || holder.includes(input)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
};
window.updateSourcePlaceholder = () => {
    const type = document.getElementById("invSourceType").value;
    const input = document.getElementById("invSourceName");
    input.placeholder = type === "Online" ? "Name of Site" : "Name of Store";
};
// --- NEW LOGIC: ADD UNIQUE ITEM ---
window.addUniqueItem = async () => {
    const item = document.getElementById("invName").value;
    const cond = document.getElementById("invCondition").value;
    const barcode = document.getElementById("invBarcode").value;

    if(!item || !barcode) return alert("Product Name and Barcode are required.");

    // Check Uniqueness
    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(barcode));
    const snap = await get(q);

    if(snap.exists()) return alert("CRITICAL ERROR: Barcode already exists.");

    // Save with Name
    await push(ref(db, "inventory"), {
        barcode: barcode,
        item: item,
        condition: cond,
        status: "In Stock",
        holder: "Store",
        usageCount: 0, // Start with 0 usage
        addedBy: currentUser.name || currentUser.email, // <--- Save Name
        dateAdded: serverTimestamp()
    });

    // Log
    await push(ref(db, "logs"), {
        type: "STOCK_ADD",
        item: item,
        barcode: barcode,
        qty: 1,
        takenBy: currentUser.name,
        approvedBy: "Self",
        time: serverTimestamp()
    });

    alert("‚úÖ Item Added!");
    document.getElementById("invBarcode").value = "";
    document.getElementById("invName").value = "";
    document.getElementById("invBarcode").focus();
};
window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

</script>
</body>
</html>
