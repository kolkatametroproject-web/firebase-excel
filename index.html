<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- OFFICIAL METRO THEME (PRESERVED) --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
  flex-wrap: wrap;
}

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
  transition: all 0.2s;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; opacity: 0.7; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button.info { background: #17a2b8; border-color: #117a8b; color: white; }
button.secondary { background: #6c757d; border-color: #545b62; color: white; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; white-space: nowrap; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
.table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; min-width: 600px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; padding: 20px; box-sizing: border-box; }

/* CAMERA UI */
#videoContainer { 
    position: relative; 
    width: 320px; 
    max-width: 100%;
    height: 240px; 
    background: #000; 
    margin-bottom: 15px; 
    border: 5px solid white; 
    box-shadow: 0 0 20px rgba(0,255,0,0.2);
}
#cameraFeed { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    transform: scaleX(-1);
}
#overlayCanvas { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 10; 
    transform: scaleX(-1);
}

/* UPLOAD SECTION */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* CHECKBOX LIST */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #ced4da;
    padding: 10px;
    background: #fff;
    text-align: left;
}
.checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; }
.checkbox-item input { width: auto; margin-right: 10px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }

/* STATUS BADGES */
.badge-online { background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.badge-offline { background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }

/* NEW: REAL-TIME STATS BOXES */
.stats-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 15px; 
    margin-bottom: 20px;
}
.stat-box {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    text-align: center;
    border: 1px solid #dee2e6;
}
.stat-box .stat-number {
    font-size: 32px;
    font-weight: bold;
    color: var(--metro-blue);
    margin: 10px 0;
}
.stat-box .stat-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* LIVE FEED */
.live-feed {
    height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    background: #fafafa;
    padding: 10px;
    border-radius: 5px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
}
.live-item {
    padding: 8px;
    margin-bottom: 5px;
    background: white;
    border-left: 4px solid #003366;
    border-radius: 3px;
    animation: slideIn 0.3s ease;
}
@keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
}

/* TIMELINE */
.timeline {
    position: relative;
    padding-left: 20px;
    border-left: 2px solid #003366;
}
.timeline-item {
    margin-bottom: 20px;
    position: relative;
    padding-left: 20px;
}
.timeline-item::before {
    content: '';
    position: absolute;
    left: -26px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #003366;
    border: 3px solid white;
}
.timeline-time {
    font-size: 11px;
    color: #666;
    margin-bottom: 5px;
}
.timeline-event {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

/* MOBILE RESPONSIVE */
@media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; gap: 10px; }
    #authContainer { margin-top: 10px; align-self: flex-start; }
    .panel { padding: 15px; }
    #videoContainer { width: 100%; height: auto; aspect-ratio: 4/3; }
    .nav-bar { padding-bottom: 15px; }
    .nav-btn { font-size: 12px; padding: 6px 10px; }
    .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    #otpUI { width: 90%; }
    .stats-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;flex-shrink:0;">M</div>
    <div><h1 style="margin:0; line-height:1.2; font-size: 1.2rem;">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:300px; max-width:90%; text-align:center;">
        <h3>User Profile Setup</h3>
        <p>Please enter your official name for the records.</p>
        <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px; text-align:center;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px; text-align:center;">Initializing AI Models...</p>
  
  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
      <div id="dot1" class="dot"></div>
      <div id="dot2" class="dot"></div>
      <div id="dot3" class="dot"></div>
  </div>

  <div id="videoContainer">
    <video id="cameraFeed" autoplay playsinline muted></video>
    <canvas id="overlayCanvas"></canvas>
  </div>
  
  <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:5px; width:280px; box-shadow: 0 0 15px black; position:absolute; z-index:20;">
    <h3 style="color:#dc3545; margin-top:0;">Face ID Failed (3/3)</h3>
    <p style="color:#333; font-size:13px;">Camera Disabled.<br>Enter OTP/PIN:</p>
    <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:18px; letter-spacing:5px; border:2px solid #dc3545;">
    <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
  </div>

  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold; height:20px; text-align:center;"></div>
  
  <div id="camControls" style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Face Scan</button>
  </div>
</div>

<div id="barcodeModal" class="modal-overlay hidden">
    <div class="panel" style="width:340px; max-width:95%; text-align:center; background:#000; border:2px solid #b38600;">
        <h3 style="color:white; margin-bottom:10px;">Scan Barcode</h3>
        <div id="reader"></div>
        <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:15px; width:100%;">Cancel / Close</button>
    </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
    <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
        <h3>Digital Signature Verification</h3>
        <img id="modalSigImage" src="" style="border:1px solid #000; background:white; max-width:100%; margin:10px 0;">
        <br>
        <button onclick="closeSigModal()">Close</button>
    </div>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
    <button class="nav-btn hidden" onclick="switchTab('sysLogs')" id="btnLogs">5. System Logs</button>
    <button class="nav-btn" onclick="switchTab('realtimeDashboard')" id="btnDashboard">üìä Live Dashboard</button>
  </div>

  <!-- NEW: REAL-TIME DASHBOARD TAB -->
  <div id="tab-realtimeDashboard" class="hidden">
    <div class="panel">
      <h3>üìä Real-Time Activity Dashboard</h3>
      
      <!-- STATS SUMMARY -->
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-number" id="onlineUsersCount">0</div>
          <div class="stat-label">Online Users</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="activeSessionsCount">0</div>
          <div class="stat-label">Active Sessions</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="todayTransactions">0</div>
          <div class="stat-label">Today's Transactions</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="itemsCheckedOut">0</div>
          <div class="stat-label">Items Checked Out</div>
        </div>
      </div>

      <!-- LIVE USER ACTIVITY -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
        <div>
          <h4>üë• Live User Status</h4>
          <div class="live-feed" id="liveUserStatus">
            <!-- User status will appear here -->
            <div class="live-item">Loading user status...</div>
          </div>
        </div>
        
        <div>
          <h4>üîÑ Live Transactions</h4>
          <div class="live-feed" id="liveTransactionFeed">
            <!-- Transactions will appear here -->
            <div class="live-item">Loading transactions...</div>
          </div>
        </div>
      </div>

      <!-- LOGIN/LOGOUT TIMELINE -->
      <div style="margin-top: 20px;">
        <h4>üìÖ User Session Timeline (Today)</h4>
        <div class="timeline" id="sessionTimeline">
          <!-- Timeline items will appear here -->
          <div class="timeline-item">
            <div class="timeline-time">Loading...</div>
            <div class="timeline-event">Loading session data</div>
          </div>
        </div>
      </div>

      <!-- ITEM MOVEMENT TRACKING -->
      <div style="margin-top: 20px;">
        <h4>üì¶ Current Item Locations</h4>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Barcode</th>
                <th>Current Holder</th>
                <th>Status</th>
                <th>Since</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody id="itemLocationsBody">
              <tr><td colspan="6">Loading item locations...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
          <input id="inpStationName" placeholder="STATION NAME">
          <input id="inpStationLength" placeholder="STATION LENGTH (M)">
          <input id="inpYellowDist" placeholder="YELLOW LINE DIST (CM)">
          <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS (CM)">
      </div>
      <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
      <div style="text-align:right;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Draft</button>
      </div>
    </div>

    <div class="panel upload-panel">
      <h3 style="color:#003366; margin-top:0;">üìé Evidence Upload Section</h3>
      <p style="font-size:12px; color:#666;">Upload site photos, videos, or PDFs separately here.</p>
      
      <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
      <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
      
      <button class="warning" onclick="uploadEvidenceOnly()">‚¨Ü Upload Evidence to Database</button>
      <div style="margin-top:5px;"><small style="color:red;">* Max 1.5 MB per file (Strict Limit)</small></div>
    </div>

    <div class="panel">
      <h4>Distance Data</h4>
      <div class="table-wrapper">
        <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final Data</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button onclick="toggleInvMode('list')" class="primary">üì¶ View Stock</button>
        <button onclick="toggleInvMode('add')" class="success">‚ûï Add Stock</button>
        <button onclick="toggleInvMode('checkout')" class="warning">üì§ Checkout</button>
        <button onclick="toggleInvMode('return')" class="info">üì• Return Item</button>
        <button onclick="toggleInvMode('history')" class="secondary">üìú Audit Trail</button>
    </div>

    <div id="inv-add" class="panel hidden" style="background:#f8f9fa;">
      <h3 style="color:#003366;">Add Inventory (1 Unit)</h3>
      <p style="font-size:12px; color:#666;">Scan barcode. Each addition equals <strong>1 Item</strong>.</p>
      
      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px;">
           <div style="display:flex; gap:5px;">
               <input id="invBarcode" placeholder="Scan Barcode (Mandatory)" onchange="checkBarcodeExistence(this.value)">
               <button onclick="openBarcodeScanner('ADD')" class="info" style="width:60px; padding:0;"><i class="fas fa-qrcode"></i></button>
           </div>
           <input id="invName" placeholder="Product Name">
      </div>
      
      <div id="existingItemNotice" class="hidden" style="background:#d4edda; color:#155724; padding:10px; border:1px solid #c3e6cb; border-radius:4px; margin-bottom:10px;">
          <strong>‚ú® Item Found!</strong> Clicking save will add +1 to stock.
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <select id="invCondition">
              <option value="" disabled selected>Condition</option>
              <option value="New">New</option>
              <option value="Good">Good</option>
              <option value="Fair">Fair</option>
              <option value="Damaged">Damaged</option>
          </select>
           <button id="btnAddStock" onclick="addInventory()" class="success">Save (+1 Unit)</button>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
          <select id="invSourceType" onchange="updateSourcePlaceholder()">
              <option value="Online">Online</option>
              <option value="Offline">Offline</option>
          </select>
          <input id="invSourceName" placeholder="Name of Site">
      </div>
    </div>

    <div id="inv-checkout" class="panel hidden" style="border: 2px solid #b38600;">
      <h3 style="color:#b38600;">üì§ Checkout (1 Unit)</h3>
      
      <div style="text-align:center; padding:20px;">
          <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:16px; padding:15px 30px; width:100%;">
              <i class="fas fa-qrcode"></i> SCAN ITEM TO CHECKOUT
          </button>
      </div>

      <div id="checkout_display" class="hidden" style="background:#fff3cd; padding:15px; border:1px solid #ffeeba; text-align:center;">
          <strong style="color:#856404; display:block; font-size:16px;" id="checkout_item_name">--</strong>
          <small style="color:#555;">Barcode: <span id="checkout_item_code">--</span></small>
          <div style="margin-top:15px;">
               <button onclick="initTransactionAuth('CHECKOUT')" style="background:#b38600; padding:10px 20px; width:100%;">üõ°Ô∏è Admin Face Approve</button>
          </div>
      </div>
    </div>

    <div id="inv-return" class="panel hidden" style="border: 2px solid #17a2b8;">
      <h3 style="color:#17a2b8;">üì• Return (1 Unit)</h3>
      
      <div style="text-align:center; padding:20px;">
          <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:16px; padding:15px 30px; width:100%;">
              <i class="fas fa-qrcode"></i> SCAN ITEM TO RETURN
          </button>
      </div>

      <div id="return_display" class="hidden" style="background:#d1ecf1; padding:15px; border:1px solid #bee5eb; text-align:center;">
          <strong style="color:#0c5460; display:block; font-size:16px;" id="return_item_name">--</strong>
          <small style="color:#555;">Barcode: <span id="return_item_code">--</span></small>
          <div style="margin-top:15px;">
               <button onclick="initTransactionAuth('RETURN')" style="background:#17a2b8; padding:10px 20px; width:100%;">üõ°Ô∏è Admin Face Approve</button>
          </div>
      </div>
    </div>

    <div id="inv-history" class="panel hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
          <h3>üìú Stock Ledger (Audit Trail)</h3>
          <input type="text" id="invSearch" onkeyup="filterInvLogs()" placeholder="üîç Search Item, Barcode or User..." style="width:250px; max-width:100%; padding:8px; border:1px solid #aaa;">
      </div>
      
      <div style="max-height:450px; overflow-y:scroll; border:1px solid #d1d5db;">
          <div class="table-wrapper">
            <table style="margin-top:0;">
              <thead style="position:sticky; top:0; z-index:100;">
                <tr style="background:#003366; color:white;">
                  <th>Txn ID</th>
                  <th>Date & Time</th>
                  <th>Type</th>
                  <th>Item Details</th>
                  <th>User (Receiver)</th>
                  <th>Authorized By</th>
                  <th>Signature</th>
                </tr>
              </thead>
              <tbody id="invHistoryBody" style="background:white;">
                <tr><td colspan="7" style="text-align:center; padding:20px;">Loading Audit Records...</td></tr>
              </tbody>
            </table>
          </div>
      </div>
    </div>

    <div id="inv-list" class="panel">
      <h3>Current Inventory</h3>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Barcode</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Condition</th>
              <th>Source</th>
              <th>User</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="inventoryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-gallery" class="hidden">
    <div class="panel">
      <h3>üìÅ Site Evidence Gallery</h3>
      <div id="galleryContainer" class="gallery-grid"></div>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã My Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ°Ô∏è Administrator Console</h3>
        <button onclick="loadAdminPanel()" class="primary">üîÑ Refresh</button>
      </div>

      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-number" id="adminOnlineUsers">0</div>
          <div class="stat-label">Online Now</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="adminActiveSessions">0</div>
          <div class="stat-label">Active Sessions</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="adminTodayLogins">0</div>
          <div class="stat-label">Logins Today</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="adminPendingTxns">0</div>
          <div class="stat-label">Pending Approvals</div>
        </div>
      </div>

      <h4 style="background:#eee; padding:5px;">1. User Status & Permissions</h4>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Name (User)</th>
              <th>Online Status</th>
              <th>Current Session</th>
              <th>Last Login</th>
              <th>Biometric Status</th>
              <th>Admin Actions</th>
            </tr>
          </thead>
          <tbody id="userListBody"></tbody>
        </table>
      </div>
      
      <h4 style="background:#eee; padding:5px;">2. Assign Work</h4>
      <label>Select Students/Users:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="1" placeholder="Enter Task Details..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:5px;">Assign to Selected Users</button>
      </div>

      <h4 style="background:#eee; padding:5px; margin-top:20px;">3. Session History</h4>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Login Time</th>
              <th>Logout Time</th>
              <th>Duration</th>
              <th>Method</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="sessionHistoryBody">
            <tr><td colspan="6">Loading session history...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-sysLogs" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #ddd; padding-bottom:10px; margin-bottom:15px; flex-wrap:wrap;">
          <h3 style="margin:0;">üñ•Ô∏è System Master Logs</h3>
          <div style="display:flex; gap:10px;">
              <input type="text" id="sysLogSearch" onkeyup="filterSysLogs()" placeholder="üîç Filter Logs..." style="padding:6px;">
              <button onclick="loadSysLogs()" class="primary">üîÑ Live Sync</button>
          </div>
      </div>
      
      <div style="height:500px; overflow-y:scroll; border:1px solid #ccc; background:#fafafa; font-family:'Consolas', monospace;">
          <div class="table-wrapper">
            <table style="width:100%; border-collapse:collapse;">
              <thead style="position:sticky; top:0; background:#e9ecef;">
                <tr>
                  <th style="width:140px;">Timestamp</th>
                  <th style="width:80px;">Level</th>
                  <th>Event Type</th>
                  <th>User</th>
                  <th>Details / Payload</th>
                </tr>
              </thead>
              <tbody id="fullLogBody">
                <tr><td colspan="5" style="text-align:center;">Initializing Log Stream...</td></tr>
              </tbody>
            </table>
          </div>
      </div>
    </div>
  </div>

</section>

<!-- Task Modal -->
<div id="adminTaskModal" class="modal-overlay hidden">
  <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #003366; padding-bottom:10px; margin-bottom:10px;">
      <h3 style="margin:0; color:#003366;">üìã Task Tracking: <span id="modalTaskUserName">User</span></h3>
      <button class="danger" onclick="closeTaskModal()" style="padding:5px 10px;">Close X</button>
    </div>
    
    <div style="overflow-y:auto; flex-grow:1;">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr style="background:#003366; color:white;">
              <th>Date</th>
              <th>Task Description</th>
              <th>Assigned By</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="adminTaskBody">
            <tr><td colspan="5" style="text-align:center;">Loading tasks...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = []; 
let modelsLoaded = false; 
let isTransactionAuth = false; 
let currentTransactionType = ""; 
let scanMode = 'LOGIN';
let receiverVerified = false;
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null;
let scanner = null;
let existingItemKey = null;
let realTimeListeners = [];

// --- ENHANCED PRESENCE SYSTEM ---
async function startEnhancedPresenceSystem(user) {
    const userStatusRef = ref(db, `status/${user.uid}`);
    const sessionId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    const loginTime = serverTimestamp();
    const userIP = await getUserIP();
    
    // Get user name
    const userSnap = await get(ref(db, `users/${user.uid}`));
    const userName = userSnap.val()?.name || user.email;
    
    // 1. Update current status
    await update(userStatusRef, {
        state: 'online',
        last_login: loginTime,
        email: user.email,
        name: userName,
        session_id: sessionId,
        ip_address: userIP,
        device_info: navigator.userAgent,
        login_method: 'Biometric'
    });
    
    // 2. Create session record
    const sessionRef = ref(db, `sessions/${user.uid}/${sessionId}`);
    await set(sessionRef, {
        user_id: user.uid,
        user_email: user.email,
        user_name: userName,
        start_time: loginTime,
        end_time: null,
        duration: null,
        status: 'ACTIVE',
        ip_address: userIP,
        device: navigator.userAgent,
        login_method: 'Biometric'
    });
    
    // 3. Log to login history
    const loginLogRef = ref(db, `loginHistory`);
    await push(loginLogRef, {
        user_id: user.uid,
        user_email: user.email,
        user_name: userName,
        timestamp: loginTime,
        type: 'LOGIN',
        method: 'Biometric',
        session_id: sessionId,
        ip_address: userIP
    });
    
    // 4. Setup disconnect handlers
    onDisconnect(userStatusRef).update({
        state: 'offline',
        last_logout: serverTimestamp()
    });
    
    onDisconnect(sessionRef).update({
        end_time: serverTimestamp(),
        status: 'ENDED'
    });
    
    const logoutLogRef = ref(db, `logoutHistory`);
    onDisconnect(logoutLogRef).push({
        user_id: user.uid,
        user_email: user.email,
        user_name: userName,
        timestamp: serverTimestamp(),
        type: 'LOGOUT',
        session_id: sessionId,
        reason: 'Disconnect'
    });
    
    // Store session ID for logout
    window.currentSessionId = sessionId;
}

async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch {
        return 'Unknown';
    }
}

// --- ENHANCED LOGOUT ---
window.logout = async () => { 
    if(currentUser) {
        const userSnap = await get(ref(db, `users/${currentUser.uid}`));
        const userName = userSnap.val()?.name || currentUser.email;
        
        // Log manual logout
        const logoutLogRef = ref(db, `logoutHistory`);
        await push(logoutLogRef, {
            user_id: currentUser.uid,
            user_email: currentUser.email,
            user_name: userName,
            timestamp: serverTimestamp(),
            type: 'LOGOUT',
            session_id: window.currentSessionId,
            reason: 'Manual'
        });
        
        // Update session record
        if(window.currentSessionId) {
            const sessionRef = ref(db, `sessions/${currentUser.uid}/${window.currentSessionId}`);
            await update(sessionRef, {
                end_time: serverTimestamp(),
                status: 'ENDED',
                logout_reason: 'Manual'
            });
        }
        
        // Update status
        const statusRef = ref(db, `status/${currentUser.uid}`);
        await update(statusRef, {
            state: 'offline',
            last_logout: serverTimestamp()
        });
        
        // Clear session ID
        window.currentSessionId = null;
        
        // Sign out
        await signOut(auth);
    }
};

// --- REAL-TIME DASHBOARD FUNCTIONS ---
function startRealTimeDashboard() {
    // Clear existing listeners
    realTimeListeners.forEach(unsubscribe => unsubscribe());
    realTimeListeners = [];
    
    // 1. User Status Monitoring
    const statusRef = ref(db, "status");
    const statusUnsub = onValue(statusRef, (snap) => {
        const users = snap.val() || {};
        updateUserStatusDashboard(users);
    });
    realTimeListeners.push(statusUnsub);
    
    // 2. Transaction Monitoring
    const transRef = ref(db, "transactions");
    const transUnsub = onValue(transRef, (snap) => {
        const transactions = snap.val() || {};
        updateTransactionDashboard(transactions);
    });
    realTimeListeners.push(transUnsub);
    
    // 3. Session History
    const sessionsRef = ref(db, "sessions");
    const sessionsUnsub = onValue(sessionsRef, (snap) => {
        const sessions = snap.val() || {};
        updateSessionDashboard(sessions);
    });
    realTimeListeners.push(sessionsUnsub);
    
    // 4. Item Locations
    const itemsRef = ref(db, "inventory");
    const itemsUnsub = onValue(itemsRef, (snap) => {
        const items = snap.val() || {};
        updateItemLocations(items);
    });
    realTimeListeners.push(itemsUnsub);
    
    // 5. Login History
    const loginRef = ref(db, "loginHistory");
    const loginUnsub = onValue(loginRef, (snap) => {
        const logins = snap.val() || {};
        updateLoginHistory(logins);
    });
    realTimeListeners.push(loginUnsub);
}

function updateUserStatusDashboard(users) {
    const onlineCount = Object.values(users).filter(u => u.state === 'online').length;
    document.getElementById('onlineUsersCount').textContent = onlineCount;
    document.getElementById('adminOnlineUsers').textContent = onlineCount;
    
    // Update live user status feed
    const liveFeed = document.getElementById('liveUserStatus');
    liveFeed.innerHTML = '';
    
    Object.entries(users).forEach(([uid, user]) => {
        const isOnline = user.state === 'online';
        const timeAgo = user.last_login ? getTimeAgo(user.last_login) : 'Unknown';
        
        const statusItem = document.createElement('div');
        statusItem.className = 'live-item';
        statusItem.innerHTML = `
            <strong>${user.name || user.email}</strong><br>
            <span style="color: ${isOnline ? 'green' : 'gray'}">
                ${isOnline ? 'üü¢ ONLINE' : '‚ö´ OFFLINE'}
            </span>
            ${isOnline ? `<br><small>Since: ${timeAgo}</small>` : ''}
        `;
        liveFeed.appendChild(statusItem);
    });
    
    if(Object.keys(users).length === 0) {
        liveFeed.innerHTML = '<div class="live-item">No users online</div>';
    }
}

function updateTransactionDashboard(transactions) {
    const today = new Date().toDateString();
    let todayCount = 0;
    let checkedOutCount = 0;
    
    const liveFeed = document.getElementById('liveTransactionFeed');
    liveFeed.innerHTML = '';
    
    // Get last 10 transactions
    const sortedTxns = Object.values(transactions)
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
        .slice(0, 10);
    
    sortedTxns.forEach(txn => {
        const txnDate = new Date(txn.timestamp).toDateString();
        if(txnDate === today) {
            todayCount++;
            if(txn.type === 'CHECKOUT') checkedOutCount++;
        }
        
        const txnItem = document.createElement('div');
        txnItem.className = 'live-item';
        txnItem.innerHTML = `
            <strong>${txn.type}</strong>: ${txn.item_name}<br>
            <small>By: ${txn.user_name}</small><br>
            <small>${formatTime(txn.timestamp)}</small>
        `;
        liveFeed.appendChild(txnItem);
    });
    
    document.getElementById('todayTransactions').textContent = todayCount;
    document.getElementById('itemsCheckedOut').textContent = checkedOutCount;
    document.getElementById('adminPendingTxns').textContent = Object.values(transactions)
        .filter(t => t.status === 'PENDING').length;
    
    if(sortedTxns.length === 0) {
        liveFeed.innerHTML = '<div class="live-item">No recent transactions</div>';
    }
}

function updateSessionDashboard(sessions) {
    let activeCount = 0;
    let todayLogins = 0;
    const today = new Date().toDateString();
    
    Object.values(sessions).forEach(userSessions => {
        if(userSessions && typeof userSessions === 'object') {
            Object.values(userSessions).forEach(session => {
                if(session.status === 'ACTIVE') activeCount++;
                const sessionDate = new Date(session.start_time).toDateString();
                if(sessionDate === today) todayLogins++;
            });
        }
    });
    
    document.getElementById('activeSessionsCount').textContent = activeCount;
    document.getElementById('adminActiveSessions').textContent = activeCount;
    document.getElementById('adminTodayLogins').textContent = todayLogins;
}

async function updateItemLocations(items) {
    const tbody = document.getElementById('itemLocationsBody');
    tbody.innerHTML = '';
    
    const holders = await getCurrentItemHolders();
    
    Object.entries(items).forEach(([key, item]) => {
        const holder = holders[key] || { user_name: 'Storage', since: item.last_updated };
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.item}</td>
            <td style="font-family:monospace;">${item.barcode || '--'}</td>
            <td>${holder.user_name}</td>
            <td><span style="color: ${holder.user_name === 'Storage' ? 'green' : 'orange'}">
                ${holder.user_name === 'Storage' ? 'IN STORAGE' : 'WITH USER'}
            </span></td>
            <td>${holder.since ? formatTime(holder.since) : 'Unknown'}</td>
            <td>${holder.location || '--'}</td>
        `;
        tbody.appendChild(row);
    });
    
    if(Object.keys(items).length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No items in inventory</td></tr>';
    }
}

async function getCurrentItemHolders() {
    const holders = {};
    
    // Get all transactions
    const transSnap = await get(ref(db, "transactions"));
    const transactions = transSnap.val() || {};
    
    // Process to find current holder
    Object.values(transactions)
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
        .forEach(txn => {
            if(!holders[txn.item_id]) {
                holders[txn.item_id] = {
                    user_name: txn.user_name,
                    since: txn.timestamp,
                    location: txn.type === 'CHECKOUT' ? 'With User' : 'Storage'
                };
            }
        });
    
    return holders;
}

function updateLoginHistory(logins) {
    const timeline = document.getElementById('sessionTimeline');
    timeline.innerHTML = '';
    
    const today = new Date().toDateString();
    const todayLogins = Object.values(logins)
        .filter(login => new Date(login.timestamp).toDateString() === today)
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
        .slice(0, 10);
    
    todayLogins.forEach(login => {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        item.innerHTML = `
            <div class="timeline-time">${formatTime(login.timestamp)}</div>
            <div class="timeline-event">
                <strong>${login.user_name}</strong> ${login.type === 'LOGIN' ? 'logged in' : 'logged out'}<br>
                <small>Method: ${login.method || 'Unknown'}</small>
            </div>
        `;
        timeline.appendChild(item);
    });
    
    if(todayLogins.length === 0) {
        timeline.innerHTML = '<div class="timeline-item"><div class="timeline-event">No activity today</div></div>';
    }
}

// --- ENHANCED TRANSACTION LOGGING ---
async function logTransaction(type, itemData, user, admin, signature = null) {
    const transId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    const transRef = ref(db, `transactions/${transId}`);
    
    const transData = {
        transaction_id: transId,
        type: type,
        item_id: itemData.key,
        item_name: itemData.item,
        barcode: itemData.barcode,
        quantity: 1,
        user_id: currentUser.uid,
        user_email: currentUser.email,
        user_name: user,
        admin_id: admin,
        timestamp: serverTimestamp(),
        signature: signature,
        status: 'COMPLETED',
        location: type === 'CHECKOUT' ? 'With User' : 'Storage'
    };
    
    await set(transRef, transData);
    
    // Also log to item-specific history
    const itemTransRef = ref(db, `items/${itemData.key}/transactions/${transId}`);
    await set(itemTransRef, transData);
    
    // Update item current holder
    const itemHolderRef = ref(db, `itemCurrentHolder/${itemData.key}`);
    if(type === 'CHECKOUT') {
        await set(itemHolderRef, {
            user_id: currentUser.uid,
            user_name: user,
            since: serverTimestamp(),
            location: 'With User'
        });
    } else if(type === 'RETURN') {
        await set(itemHolderRef, {
            user_id: 'STORAGE',
            user_name: 'Central Storage',
            since: serverTimestamp(),
            location: 'Storage'
        });
    }
    
    return transData;
}

// --- ENHANCED PROCESS TRANSACTION ---
async function processTransaction(adminName) {
    const isCheckout = currentTransactionType === 'CHECKOUT';
    
    const itemKey = pendingTransactionItem.key;
    const itemName = pendingTransactionItem.item;
    const transQty = 1;
    
    // 1. Update Stock
    const invRef = ref(db, `inventory/${itemKey}`);
    const invSnap = await get(invRef);
    if(!invSnap.exists()) return alert("Item error.");
    
    const realStoreQty = parseInt(invSnap.val().qty);
    if(isCheckout && realStoreQty < 1) {
        stopCamera();
        return alert("‚ùå Out of Stock!");
    }
    
    const newStoreQty = isCheckout ? (realStoreQty - 1) : (realStoreQty + 1);
    await update(invRef, { 
        qty: newStoreQty,
        last_updated: serverTimestamp(),
        last_transaction: currentTransactionType
    });
    
    // 2. Get User Name
    const uSnap = await get(ref(db, `users/${currentUser.uid}`));
    const realUserName = uSnap.val()?.name || currentUser.email;
    
    // 3. Log Transaction
    const logData = {
        type: currentTransactionType,
        item: itemName,
        qty: 1,
        takenBy: realUserName,
        approvedBy: adminName,
        signature: "Admin Authorized (1 Unit)",
        time: serverTimestamp()
    };
    
    await push(ref(db, "logs"), logData);
    
    // 4. Enhanced Transaction Logging
    await logTransaction(currentTransactionType, pendingTransactionItem, realUserName, adminName);
    
    alert(`${currentTransactionType} Successful!`);
    stopCamera();
    
    // Reset UI
    document.getElementById("checkout_display").classList.add("hidden");
    document.getElementById("return_display").classList.add("hidden");
    pendingTransactionItem = null;
    
    toggleInvMode('history');
}

// --- ADMIN SESSION HISTORY ---
async function loadSessionHistory() {
    const tbody = document.getElementById('sessionHistoryBody');
    tbody.innerHTML = '<tr><td colspan="6">Loading session history...</td></tr>';
    
    try {
        const sessionsSnap = await get(ref(db, "sessions"));
        const loginsSnap = await get(ref(db, "loginHistory"));
        const logoutsSnap = await get(ref(db, "logoutHistory"));
        
        const sessions = sessionsSnap.val() || {};
        const logins = loginsSnap.val() || {};
        const logouts = logoutsSnap.val() || {};
        
        let allSessions = [];
        
        // Process login/logout pairs
        Object.values(logins).forEach(login => {
            const matchingLogout = Object.values(logouts).find(
                logout => logout.session_id === login.session_id
            );
            
            const duration = matchingLogout ? 
                calculateDuration(login.timestamp, matchingLogout.timestamp) : 
                'Active';
            
            allSessions.push({
                user: login.user_name,
                login_time: formatTime(login.timestamp),
                logout_time: matchingLogout ? formatTime(matchingLogout.timestamp) : 'Active',
                duration: duration,
                method: login.method || 'Unknown',
                ip: login.ip_address || 'Unknown'
            });
        });
        
        // Sort by login time (newest first)
        allSessions.sort((a, b) => new Date(b.login_time) - new Date(a.login_time));
        
        // Display
        tbody.innerHTML = '';
        allSessions.slice(0, 20).forEach(session => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${session.user}</td>
                <td>${session.login_time}</td>
                <td>${session.logout_time}</td>
                <td>${session.duration}</td>
                <td>${session.method}</td>
                <td>${session.ip}</td>
            `;
            tbody.appendChild(row);
        });
        
        if(allSessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No session history found</td></tr>';
        }
        
    } catch (error) {
        console.error("Error loading session history:", error);
        tbody.innerHTML = '<tr><td colspan="6">Error loading session history</td></tr>';
    }
}

function calculateDuration(start, end) {
    if(!start || !end) return 'N/A';
    
    const startTime = new Date(start);
    const endTime = new Date(end);
    const diffMs = endTime - startTime;
    
    if(diffMs < 0) return 'Invalid';
    
    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if(hours > 0) return `${hours}h ${minutes}m`;
    return `${minutes}m`;
}

function getTimeAgo(timestamp) {
    if(!timestamp) return 'Unknown';
    
    const now = new Date();
    const time = new Date(timestamp);
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    
    if(diffMins < 1) return 'Just now';
    if(diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    
    const diffHours = Math.floor(diffMins / 60);
    if(diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
}

// --- ENHANCED LOAD ADMIN PANEL ---
window.loadAdminPanel = async () => {
    await loadSessionHistory(); // Load session history
    
    // Rest of your existing admin panel code...
    const userList = document.getElementById("userCheckboxList");
    const userTable = document.getElementById("userListBody");
    
    userList.innerHTML = "Loading...";
    userTable.innerHTML = "<tr><td colspan='5'>Loading Status...</td></tr>";

    const [userSnap, statusSnap, tasksSnap] = await Promise.all([
        get(ref(db, "users")),
        get(ref(db, "status")),
        get(ref(db, "assignments"))
    ]);
    
    const statusMap = statusSnap.val() || {};
    const allTasks = tasksSnap.val() || {};
    
    userTable.innerHTML = "";
    userList.innerHTML = "";

    userSnap.forEach(c => {
        const u = c.val();
        const uid = c.key;
        const displayName = u.name || u.email;

        userList.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="user-check" value="${uid}"> ${displayName}</label>`;

        let isOnline = false;
        const s = statusMap[uid];
        if(s && s.state === 'online') {
            const diff = Date.now() - (s.last_seen || 0);
            if(diff < 20000) isOnline = true; 
        }
        
        const statusBadge = isOnline ? 
            `<span class="badge-online">‚óè ONLINE</span>` : 
            `<span class="badge-offline">‚óã OFFLINE</span>`;

        let pending = 0;
        let done = 0;
        if(allTasks[uid]) {
            Object.values(allTasks[uid]).forEach(t => {
                if(t.status === 'Done') done++; else pending++;
            });
        }
        
        const workBadge = (pending + done > 0) 
            ? `<div style="font-size:11px; font-weight:bold; color:#003366; margin-bottom:5px;">${done} Done / ${pending} Pending</div>
               <button class="info" onclick="viewUserTasks('${uid}', '${encodeURIComponent(displayName)}')" style="padding:2px 8px; font-size:10px;">üëÅ View Details</button>`
            : `<span style="color:#aaa; font-size:11px;">No Tasks</span>`;

        const bioBadge = u.faceData ? 
            `<span style="color:green; font-weight:bold;">‚úî Registered</span>` : 
            `<span style="color:red; font-weight:bold;">‚ùå Pending</span>`;

        const currentSession = s ? getTimeAgo(s.last_login) : 'Never';
        const lastLogin = s?.last_login ? formatTime(s.last_login) : 'Never';

        const pinInput = `<input id="pin_${uid}" placeholder="${u.pin||'1234'}" style="width:50px; text-align:center;"> <button onclick="savePin('${uid}')" style="padding:2px 5px;">Set</button>`;
        const reUploadBtn = `<button class="danger" style="padding:2px 5px;" onclick="forceReUpload('${uid}')">Reset Face</button>`;
        const resetNameBtn = `<button class="warning" style="padding:2px 5px;" onclick="retakeName('${uid}')">Reset Name</button>`;

        userTable.innerHTML += `<tr>
            <td>${u.name}<br><small>${u.email}</small></td>
            <td style="text-align:center;">${statusBadge}</td>
            <td style="text-align:center;">${currentSession}</td>
            <td style="text-align:center;">${lastLogin}</td>
            <td style="text-align:center;">${bioBadge}</td>
            <td>${pinInput}<br>${reUploadBtn} ${resetNameBtn}</td>
        </tr>`;
    });
};

// --- ENHANCED TAB SWITCHING ---
window.switchTab = (t) => {
    ['newData','inventory','gallery','assigned','adminPanel','sysLogs','realtimeDashboard'].forEach(x => {
        const el = document.getElementById(`tab-${x}`);
        if(el) el.classList.add("hidden");
    });
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    const target = document.getElementById(`tab-${t}`);
    if(target) target.classList.remove("hidden");
    
    const btnId = t === 'realtimeDashboard' ? 'btnDashboard' : 
                  t === 'sysLogs' ? 'btnLogs' : 
                  t === 'newData' ? 'btnNew' : 
                  t === 'inventory' ? 'btnInventory' : 
                  t === 'gallery' ? 'btnGallery' : 
                  t === 'assigned' ? 'btnAssign' : 'btnAdmin';
    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add("active");

    if(t === 'adminPanel' && isAdmin) {
        loadAdminPanel();
        loadSessionHistory();
    }
    if(t === 'gallery') loadGallery();
    if(t === 'sysLogs') loadSysLogs();
    if(t === 'realtimeDashboard') {
        startRealTimeDashboard();
    }
};

// --- ENHANCED AUTH STATE HANDLER ---
onAuthStateChanged(auth, async (user) => {
  if (!user) { showLogin(); return; }
  
  currentUser = user;
  await startEnhancedPresenceSystem(user);
  setupIdleTimer();
  update(ref(db, `users/${user.uid}`), { email: user.email });

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const u = snap.val();
    if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    if(u) currentUser.name = u.name; 

    isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
    failCount = 0;
    
    if (!u.name) {
        document.getElementById("nameModal").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
        return;
    }

    if (!u.pin) { update(ref(db, `users/${user.uid}`), { pin: "1234" }); }

    document.getElementById("userInfo").innerText = `${u.name} (${user.email})`;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("btnLogs").classList.remove("hidden");
      setTimeout(() => {
          loadAdminPanel();
          loadSessionHistory();
      }, 2000);
    }

    if(!isTransactionAuth) {
        const faceModal = document.getElementById("faceModal");
        faceModal.classList.remove("hidden");
        
        if(!u.faceData) {
            document.getElementById("modalTitle").innerText = "‚ö†Ô∏è Face ID Setup (3 Steps)";
            document.getElementById("modalDesc").innerText = "Center your face in the box.";
            document.getElementById("regProgress").classList.remove("hidden");
            updateRegDots(regSamples.length);
            document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${regSamples.length + 1} of 3`;
            document.getElementById("btnCapture").onclick = registerNewFace; 
            initCamera(false);
        } else {
            document.getElementById("modalTitle").innerText = "Biometric Verification";
            document.getElementById("modalDesc").innerText = "System Ready.";
            document.getElementById("regProgress").classList.add("hidden");
            document.getElementById("btnCapture").innerText = "üì∏ Verify Identity";
            document.getElementById("btnCapture").onclick = handleFaceScan; 
            initCamera(true);
        }
    }
  });
});

// --- UTILITY FUNCTIONS ---
function formatTime(ts) {
    if (!ts) return "N/A";
    const d = new Date(ts);
    return d.toLocaleDateString('en-GB') + " " + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// --- SIGNATURE PAD LOGIC ---
function setupCanvas(id) {
    const canvas = document.getElementById(id);
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000000';

    let isDrawing = false;
    canvas.style.touchAction = 'none';

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    // Start Drawing
    canvas.addEventListener('pointerdown', (e) => {
        isDrawing = true;
        canvas.setPointerCapture(e.pointerId);
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        e.preventDefault();
    });

    // Draw Line
    canvas.addEventListener('pointermove', (e) => {
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
    });

    // Stop Drawing
    canvas.addEventListener('pointerup', (e) => {
        isDrawing = false;
        canvas.releasePointerCapture(e.pointerId);
    });

    // Cancel
    canvas.addEventListener('pointercancel', () => {
        isDrawing = false;
    });
}
setupCanvas('sigCanvas');
setupCanvas('sigCanvasReturn');

window.clearSignature = (id) => { 
    const canvas = document.getElementById(id);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height); 
}

// --- NEW HELPER: Signature Modal ---
window.viewSignature = (sigData) => {
    document.getElementById("modalSigImage").src = sigData;
    document.getElementById("sigModal").classList.remove("hidden");
};
window.closeSigModal = () => document.getElementById("sigModal").classList.add("hidden");

// --- NEW BARCODE LOGIC ---
window.openBarcodeScanner = (mode) => {
    scanMode = mode;
    document.getElementById("barcodeModal").classList.remove("hidden");
    
    if(!scanner) {
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess, onScanFailure);
    }
}

window.closeBarcodeScanner = () => {
    document.getElementById("barcodeModal").classList.add("hidden");
    if(scanner) {
        scanner.clear();
        scanner = null;
    }
}

function onScanSuccess(decodedText) {
    closeBarcodeScanner();

    if(scanMode === 'ADD') {
        document.getElementById("invBarcode").value = decodedText;
        checkBarcodeExistence(decodedText); 
        alert("Barcode Captured: " + decodedText);
    } 
    else if (scanMode === 'CHECKOUT' || scanMode === 'RETURN') {
        
        // Show scanned number first
        if(scanMode === 'CHECKOUT') {
            document.getElementById("checkout_display").classList.remove("hidden");
            document.getElementById("checkout_item_name").innerText = "Verifying..."; 
            document.getElementById("checkout_item_code").innerText = decodedText;
        } else {
            document.getElementById("return_display").classList.remove("hidden");
            document.getElementById("return_item_name").innerText = "Verifying..."; 
            document.getElementById("return_item_code").innerText = decodedText;
        }

        if(!confirm("Scanned Barcode: " + decodedText + "\n\nPress OK to search DB and take this item.")) {
            if(scanMode === 'CHECKOUT') document.getElementById("checkout_display").classList.add("hidden");
            else document.getElementById("return_display").classList.add("hidden");
            return;
        }

        // DIRECT LOOKUP
        const invRef = ref(db, "inventory");
        const q = query(invRef, orderByChild("barcode"), equalTo(decodedText));
        
        get(q).then(snap => {
            if(!snap.exists()) {
                alert("‚ùå Item not found in inventory!\n(Scanned Code: " + decodedText + ")");
                return;
            }
            
            // Get the first match
            let foundItem = null;
            let foundKey = null;
            snap.forEach(c => { foundItem = c.val(); foundKey = c.key; });

            pendingTransactionItem = { key: foundKey, ...foundItem };

            if(scanMode === 'CHECKOUT') {
                document.getElementById("checkout_display").classList.remove("hidden");
                document.getElementById("checkout_item_name").innerText = foundItem.item;
                document.getElementById("checkout_item_code").innerText = foundItem.barcode;
            } else {
                document.getElementById("return_display").classList.remove("hidden");
                document.getElementById("return_item_name").innerText = foundItem.item;
                document.getElementById("return_item_code").innerText = foundItem.barcode;
            }
        });
    }
}

function onScanFailure(error) {
    // Do nothing, keep scanning
}

// --- BARCODE EXISTENCE CHECK ---
window.checkBarcodeExistence = async (code) => {
    if(!code) return;
    
    existingItemKey = null;
    document.getElementById("existingItemNotice").classList.add("hidden");
    document.getElementById("invName").disabled = false;
    document.getElementById("invCondition").disabled = false;
    document.getElementById("invSourceType").disabled = false;
    document.getElementById("invSourceName").disabled = false;
    document.getElementById("btnAddStock").innerText = "Save New Item";
    document.getElementById("btnAddStock").classList.remove("warning");
    document.getElementById("btnAddStock").classList.add("success");

    const invRef = ref(db, "inventory");
    const q = query(invRef, orderByChild("barcode"), equalTo(code));
    const snap = await get(q);

    if(snap.exists()) {
        snap.forEach(c => {
            const val = c.val();
            existingItemKey = c.key;
            
            document.getElementById("invName").value = val.item;
            document.getElementById("invName").disabled = true;
            
            document.getElementById("invCondition").value = val.condition;
            document.getElementById("invCondition").disabled = true;
            
            document.getElementById("invSourceType").value = val.sourceType || "Online";
            document.getElementById("invSourceType").disabled = true;
            
            document.getElementById("invSourceName").value = val.sourceName || "";
            document.getElementById("invSourceName").disabled = true;

            document.getElementById("existingItemNotice").classList.remove("hidden");
            document.getElementById("btnAddStock").innerText = "Update Existing Stock";
            document.getElementById("btnAddStock").classList.remove("success");
            document.getElementById("btnAddStock").classList.add("warning");
        });
    }
}

// --- RECEIVER SCAN ---
window.startReceiverScan = (type) => {
    scanMode = 'RECEIVER';
    currentTransactionType = type;
    
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "üë§ Receiver Verification";
    document.getElementById("modalDesc").innerText = "Please look at the camera to verify identity.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Verify My Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
    
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
    
    initCamera(true);
};

// --- 1. LOAD AI MODELS ---
async function preloadModels() {
    if(modelsLoaded) return; 
    try {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
        ]);
        modelsLoaded = true;
    } catch(e) { console.error("Model Error", e); }
}
preloadModels(); 

// --- 2. AUTH & WATCHDOG ---
function setupIdleTimer() {
    clearTimeout(idleTimer);
    window.onmousemove = resetTimer;
    window.onclick = resetTimer;
    resetTimer(); 
}
function resetTimer() {
    clearTimeout(idleTimer);
    if(currentUser) {
        idleTimer = setTimeout(() => {
            const logData = { user: currentUser.email, type: "LOGOUT", method: "Auto-Timeout", time: serverTimestamp() };
            push(ref(db, "logs"), logData);
            signOut(auth);
            alert("Session Timeout.");
        }, 5 * 60 * 1000);
    }
}

window.saveOfficialName = () => {
    const name = document.getElementById("officialNameInput").value.trim();
    if(name.length < 3) return alert("Enter full valid name.");
    update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
        document.getElementById("nameModal").classList.add("hidden");
        location.reload(); 
    });
}

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    document.getElementById("nameModal").classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));

async function recordLogin(method) {
    if(currentUser) {
        const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
        await push(ref(db, "logs"), logData);
    }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    
    try {
        if(!modelsLoaded) {
            updateStatus("Loading AI Models...", "yellow");
            await preloadModels();
        }
        
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 320, height: 240 } });
        vid.srcObject = stream;
        vid.onloadedmetadata = () => {
            vid.play();
            startRealTimeDetection(vid, canvas); 
        };

        if(isVerify) updateStatus("LOOK AT CAMERA", "white");
        else updateStatus("REGISTRATION: CENTER FACE", "cyan");

    } catch(e) { 
        console.error(e);
        updateStatus("Camera Hardware Error", "red"); 
    }
}

async function startRealTimeDetection(video, canvas) {
    const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
    faceapi.matchDimensions(canvas, displaySize);
    if (detectionLoop) clearInterval(detectionLoop);
    detectionLoop = setInterval(async () => {
        if (!stream) return;
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (detection) {
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            const box = resizedDetections.detection.box;
            const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
            drawBox.draw(canvas);
            currentDescriptor = detection.descriptor;
            const btn = document.getElementById("btnCapture");
            if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00"; 
        } else {
            currentDescriptor = null;
            const btn = document.getElementById("btnCapture");
            if(btn) btn.style.border = "1px solid #004494";
        }
    }, 100); 
}

function stopCamera() { 
    if(detectionLoop) clearInterval(detectionLoop);
    if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    const vid = document.getElementById("cameraFeed");
    const canvas = document.getElementById("overlayCanvas");
    if(vid) vid.srcObject = null;
    if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
    document.getElementById("faceModal").classList.add("hidden"); 
    isTransactionAuth = false; 
    currentTransactionType = "";
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }

window.handleFaceScan = async () => {
    const btn = document.getElementById("btnCapture");
    if(!currentDescriptor) { updateStatus("‚ùå No Face Detected.", "red"); return; }
    
    btn.disabled = true; 
    btn.innerText = "Processing...";
    updateStatus("Analyzing Biometrics...", "cyan");

    try {
        // --- MODE 1: RECEIVER VERIFICATION ---
        if(scanMode === 'RECEIVER') {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            
            let match = false;
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                    if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }

            if(match) {
                updateStatus("‚úÖ IDENTITY CONFIRMED", "#00ff00");
                setTimeout(() => {
                    stopCamera();
                    receiverVerified = true;
                    if(currentTransactionType === 'CHECKOUT') {
                        document.getElementById("checkout_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("checkout_status_text").style.color = "green";
                        document.getElementById("btn_checkout_verify").classList.add("hidden");
                        const subBtn = document.getElementById("btn_checkout_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#b38600";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    } else {
                        document.getElementById("return_status_text").innerHTML = "‚úÖ VERIFIED: " + currentUser.name;
                        document.getElementById("return_status_text").style.color = "green";
                        document.getElementById("btn_return_verify").classList.add("hidden");
                        const subBtn = document.getElementById("btn_return_submit");
                        subBtn.disabled = false;
                        subBtn.style.background = "#17a2b8";
                        subBtn.style.cursor = "pointer";
                        subBtn.style.opacity = "1";
                    }
                }, 1000);
            } else {
                throw new Error("Face Does Not Match User");
            }
        }

        // --- MODE 2: ADMIN AUTHORIZATION ---
        else if(scanMode === 'ADMIN') {
             const allUsersSnap = await get(ref(db, "users"));
             let adminFound = false;
             let adminName = "Unknown";

             allUsersSnap.forEach(userSnap => {
                const uData = userSnap.val();
                if(uData.faceData && ADMIN_EMAILS.includes(uData.email)) {
                    const samples = (uData.faceData[0] instanceof Array) ? uData.faceData : [uData.faceData];
                    for (let s of samples) {
                        if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { 
                            adminFound = true; adminName = uData.name; break; 
                        }
                    }
                }
             });

             if(adminFound) {
                 updateStatus("‚úÖ AUTHORIZED: " + adminName, "#00ff00");
                 await processTransaction(adminName);
             } else {
                 throw new Error("Not an Admin Face");
             }
        }

        // --- MODE 3: LOGIN ---
        else {
            const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
            const storedData = snap.val();
            let match = false;
            if(storedData) {
                const samples = (storedData[0] instanceof Array) ? storedData : [storedData];
                for (let s of samples) {
                     if(faceapi.euclideanDistance(s, currentDescriptor) < 0.55) { match = true; break; }
                }
            }
            if(match) {
                updateStatus("‚úÖ VERIFIED", "#00ff00");
                await recordLogin("Biometric");
                enterApp();
            } else {
                throw new Error("Face Mismatch");
            }
        }

    } catch (error) {
        console.error(error);
        updateStatus("‚ùå " + error.message, "red");
        btn.disabled = false;
        btn.innerText = "üì∏ Retry Scan";
    }
};

window.registerNewFace = async () => {
    if(!currentDescriptor) { updateStatus("‚ùå Camera cannot see face clearly.", "orange"); return; }
    regSamples.push(Array.from(currentDescriptor));
    const count = regSamples.length;
    updateRegDots(count);
    if(count < 3) {
        updateStatus(`‚úÖ Sample ${count}/3 Captured.`, "lightgreen");
        document.getElementById("btnCapture").innerText = `üì∏ Capture Sample ${count + 1} of 3`;
    } else {
        updateStatus("üíæ Saving...", "yellow");
        await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
        alert("Registration Complete!"); location.reload();
    }
};

function handleFail() {
    failCount++;
    if(failCount >= 3) {
        stopCamera(); 
        document.getElementById("faceModal").classList.remove("hidden");
        document.getElementById("videoContainer").classList.add("hidden"); 
        document.getElementById("camControls").classList.add("hidden");
        document.getElementById("otpUI").classList.remove("hidden"); 
        updateStatus("‚ö†Ô∏è Camera Disabled. Enter PIN.", "red");
    } else {
        updateStatus(`‚ùå Failed. Attempts left: ${3 - failCount}`, "orange");
    }
}

window.verifyOTP = () => {
    const input = document.getElementById("otpInput").value;
    get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
        const actualPin = snap.val() || "1234";
        if(input === actualPin) {
            await recordLogin("PIN Entry");
            enterApp();
        } else {
            alert("Wrong PIN ‚ùå");
        }
    });
}

function enterApp() {
    stopCamera(); 
    document.getElementById("faceModal").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadGallery(); loadInventory(); loadAssignments();
}

// --- CHECKOUT & RETURN LOGIC ---

window.toggleInvMode = (mode) => {
    document.getElementById("inv-add").classList.add("hidden");
    document.getElementById("inv-checkout").classList.add("hidden");
    document.getElementById("inv-return").classList.add("hidden");
    document.getElementById("inv-history").classList.add("hidden");
    document.getElementById("inv-list").classList.add("hidden");
    document.getElementById(`inv-${mode}`).classList.remove("hidden");
    
    if(mode === 'checkout') populateCheckoutSelect();
    if(mode === 'return') populateReturnSelect();
    if(mode === 'history') loadInventoryHistory();
};

// 1. POPULATE CHECKOUT
function populateCheckoutSelect() {
    const sel = document.getElementById("checkoutSelect");
    sel.innerHTML = "<option value=''>Loading...</option>";
    onValue(ref(db, "inventory"), snap => {
        sel.innerHTML = "<option value=''>Select Item...</option>";
        snap.forEach(c => {
            const v = c.val();
            const opt = document.createElement("option");
            opt.value = c.key;
            opt.text = `${v.item} (Avail: ${v.qty})`;
            opt.dataset.qty = v.qty;
            opt.dataset.name = v.item;
            if(v.barcode) opt.dataset.barcode = v.barcode;
            sel.appendChild(opt);
        });
    }, { onlyOnce: true });
}

// 2. POPULATE RETURN
async function populateReturnSelect() {
    const sel = document.getElementById("returnSelect");
    sel.innerHTML = "<option value=''>Calculating your holdings...</option>";

    try {
        const invSnap = await get(ref(db, "inventory"));
        const inventoryMap = {};
        invSnap.forEach(c => {
            const val = c.val();
            inventoryMap[val.item] = { key: c.key, exists: true, barcode: val.barcode };
        });

        const logsSnap = await get(query(ref(db, "logs")));
        const myHoldings = {};

        logsSnap.forEach(c => {
            const l = c.val();
            const isMe = (l.takenBy === currentUser.name) || (l.takenBy === currentUser.email);
            
            if (isMe) {
                if(l.type === 'CHECKOUT') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) + parseInt(l.qty);
                } else if (l.type === 'RETURN') {
                    myHoldings[l.item] = (myHoldings[l.item] || 0) - parseInt(l.qty);
                }
            }
        });

        sel.innerHTML = "<option value=''>Select Item...</option>";
        let foundAny = false;

        for (const [itemName, netQty] of Object.entries(myHoldings)) {
            if (netQty > 0 && inventoryMap[itemName]) {
                foundAny = true;
                const opt = document.createElement("option");
                opt.value = inventoryMap[itemName].key;
                opt.text = `${itemName} (You have: ${netQty})`;
                opt.dataset.qty = netQty;
                opt.dataset.name = itemName;
                if(inventoryMap[itemName].barcode) opt.dataset.barcode = inventoryMap[itemName].barcode;
                sel.appendChild(opt);
            }
        }

        if(!foundAny) {
            sel.innerHTML = "<option value=''>No items to return.</option>";
        }

    } catch (e) {
        console.error(e);
        sel.innerHTML = "<option>Error loading.</option>";
    }
}

window.updateMaxQty = () => {
    const isCheckout = !document.getElementById("inv-checkout").classList.contains("hidden");
    const selId = isCheckout ? "checkoutSelect" : "returnSelect";
    const inpId = isCheckout ? "checkoutAvail" : "returnAvail";
    
    const sel = document.getElementById(selId);
    const opt = sel.options[sel.selectedIndex];
    
    if(opt && opt.dataset.qty) {
        document.getElementById(inpId).value = opt.dataset.qty;
    } else {
        document.getElementById(inpId).value = "";
    }
};

// --- NEW HISTORY LOADING LOGIC ---
window.loadInventoryHistory = () => {
    const tbody = document.getElementById("invHistoryBody");
    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> Retrieving Secure Records...</td></tr>";

    const q = query(ref(db, "logs"), limitToLast(300));
    
    onValue(q, (snap) => {
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse();

        const invLogs = logs.filter(l => l.type === 'CHECKOUT' || l.type === 'RETURN' || l.type === 'STOCK_ADD' || l.type === 'STOCK_UPDATE');

        if(invLogs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px; color:#666;'>No stock movement recorded in recent history.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        invLogs.forEach(l => {
            const txnId = l.key.substring(l.key.length - 6).toUpperCase();
            
            let badge = "";
            if(l.type === 'CHECKOUT') badge = `<span style="background:#b38600; color:white; padding:2px 5px; border-radius:3px; font-weight:bold; font-size:11px;">üì§ OUT</span>`;
            else if(l.type === 'RETURN') badge = `<span style="background:#17a2b8; color:white; padding:2px 5px; border-radius:3px; font-weight:bold; font-size:11px;">üì• IN</span>`;
            else if(l.type.includes('STOCK')) badge = `<span style="background:#28a745; color:white; padding:2px 5px; border-radius:3px; font-weight:bold; font-size:11px;">‚ûï ADD</span>`;

            const sigBtn = l.signature 
                ? `<button class="info" style="padding:2px 5px; font-size:11px;" onclick="viewSignature('${l.signature}')">View</button>`
                : `<span style="color:#ccc;">--</span>`;

            const row = `
            <tr class="inv-log-row">
                <td style="font-family:monospace; color:#003366; font-weight:bold;">#${txnId}</td>
                <td>${formatTime(l.time)}</td>
                <td>${badge}</td>
                <td>
                    <span style="font-weight:bold; font-size:13px;">${l.item}</span><br>
                    <span style="color:#666; font-size:11px;">Qty: ${l.qty}</span>
                </td>
                <td>${l.takenBy}</td>
                <td>
                    <span style="color:green; font-weight:bold;">‚úî ${l.approvedBy || 'System'}</span>
                </td>
                <td style="text-align:center;">${sigBtn}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }, { onlyOnce: true });
};

// --- SEARCH FUNCTION FOR INVENTORY ---
window.filterInvLogs = () => {
    const input = document.getElementById("invSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("inv-log-row");
    
    Array.from(rows).forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
};

window.initTransactionAuth = (type) => {
    if(!pendingTransactionItem) return alert("Please SCAN an item first.");

    scanMode = 'ADMIN'; 
    currentTransactionType = type;
    
    document.getElementById("faceModal").classList.remove("hidden");
    document.getElementById("modalTitle").innerText = `üõ°Ô∏è Admin Authorization`;
    document.getElementById("modalDesc").innerText = "Admin: Scan face to approve 1 Unit.";
    document.getElementById("regProgress").classList.add("hidden");
    document.getElementById("btnCapture").innerText = "üì∏ Scan Admin Face";
    document.getElementById("btnCapture").disabled = false;
    document.getElementById("btnCapture").onclick = handleFaceScan;
    
    document.getElementById("videoContainer").classList.remove("hidden");
    document.getElementById("camControls").classList.remove("hidden");
    document.getElementById("otpUI").classList.add("hidden");
    
    initCamera(true);
};

// --- APP FEATURES ---

window.saveStationDetails = () => {
    const name = document.getElementById("inpStationName").value.trim();
    if(!name) return alert("Station Name Required");
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: name,
        len: document.getElementById("inpStationLength").value,
        yl: document.getElementById("inpYellowDist").value,
        th: document.getElementById("inpYellowThick").value,
        remarks: document.getElementById("inpRemarks").value
    });
    alert("Draft Saved");
};

window.uploadEvidenceOnly = () => {
    if(!currentFileBase64) return alert("Select a file first.");
    
    if(confirm("Upload Evidence?")) {
        push(ref(db, "history"), { 
            name: "Evidence Upload", 
            user: currentUser.email, 
            userName: currentUser.name, 
            date: new Date().toLocaleString(),
            fileData: currentFileBase64, 
            fileType: currentFileType
        }).then(() => {
            document.getElementById("evidenceFile").value = "";
            document.getElementById("fileStatus").innerText = "";
            currentFileBase64 = null;
            alert("Evidence Uploaded."); 
            switchTab('gallery');
        });
    }
};

window.handleFileUpload = () => {
    const file = document.getElementById("evidenceFile").files[0];
    document.getElementById("fileStatus").innerText = "Processing...";
    if(file && file.size < 1.5*1024*1024) { 
        const reader = new FileReader();
        reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
        reader.readAsDataURL(file);
    } else { 
        alert("File too large! Max 1.5MB"); 
        document.getElementById("fileStatus").innerText = "Error: File too large";
    }
}

window.submitStationData = () => {
    get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
        const d = s.val();
        if(!d || !d.details) return alert("No Data.");
        if(confirm("Submit Final?")) {
            push(ref(db, "history"), { 
                ...d.details, rows: d.rows, user: currentUser.email, userName: currentUser.name, date: new Date().toLocaleString()
            }).then(() => {
                remove(ref(db, `drafts/${currentUser.uid}`));
                alert("Submitted"); switchTab('gallery');
            });
        }
    });
};

// --- ADMIN LOGIC ---

// --- TASK VIEWER ---
window.viewUserTasks = (uid, rawName) => {
    const userName = decodeURIComponent(rawName);
    
    document.getElementById("modalTaskUserName").innerText = userName;
    document.getElementById("adminTaskModal").classList.remove("hidden");
    
    const tbody = document.getElementById("adminTaskBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>üîÑ Connecting to Database...</td></tr>";

    const taskRef = ref(db, `assignments/${uid}`);
    onValue(taskRef, (snap) => {
        tbody.innerHTML = "";
        
        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:#777; padding:20px;'>üì≠ No tasks assigned to this user.</td></tr>";
            return;
        }

        snap.forEach(c => {
            const task = c.val();
            const key = c.key;
            
            const isDone = task.status === 'Done';
            const statusColor = isDone ? '#28a745' : '#ffc107';
            const statusText = isDone ? '‚úî COMPLETED' : '‚è≥ PENDING';
            const rowBg = isDone ? '#f0fff4' : '#fff';

            tbody.innerHTML += `
            <tr style="font-size:12px; background:${rowBg};">
                <td>${task.date || '--'}</td>
                <td style="font-weight:bold; color:#003366;">${task.desc}</td>
                <td>${task.by || 'Admin'}</td>
                <td><span style="color:${statusColor}; font-weight:bold; border:1px solid ${statusColor}; padding:2px 6px; border-radius:4px;">${statusText}</span></td>
                <td style="text-align:center;">
                    <button class="danger" onclick="deleteUserTask('${uid}', '${key}')" style="padding:4px 8px; font-size:11px; cursor:pointer;">üóë Remove</button>
                </td>
            </tr>`;
        });
    }, (error) => {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan='5' style='color:red; text-align:center;'>Error loading data: ${error.message}</td></tr>`;
    });
};

// --- CLOSE MODAL ---
window.closeTaskModal = () => {
    document.getElementById("adminTaskModal").classList.add("hidden");
};

// --- DELETE TASK ---
window.deleteUserTask = (uid, taskKey) => {
    if(confirm("Are you sure you want to remove this task?")) {
        remove(ref(db, `assignments/${uid}/${taskKey}`))
            .catch(err => alert("Error: " + err.message));
    }
};

// --- SYSTEM LOGS LOGIC ---
window.loadSysLogs = () => {
    const tbody = document.getElementById("fullLogBody");
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>Syncing System Logs...</td></tr>";

    const q = query(ref(db, "logs"), limitToLast(200));

    onValue(q, (snap) => {
        tbody.innerHTML = "";
        const logs = [];
        snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
        logs.reverse();

        if(logs.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>System Clean. No logs generated.</td></tr>";
            return;
        }

        logs.forEach(x => {
            let rowStyle = "border-bottom:1px solid #eee;";
            let level = `<span style="color:gray; font-weight:bold;">INFO</span>`;
            
            if(x.type === "LOGIN") { 
                level = `<span style="color:green; font-weight:bold;">AUTH</span>`; 
                rowStyle += "background:#f0fff4;";
            }
            if(x.type === "LOGOUT") { 
                level = `<span style="color:orange; font-weight:bold;">EXIT</span>`; 
                rowStyle += "background:#fffbf0;";
            }
            if(x.type.includes("Fail") || x.type.includes("Error")) { 
                level = `<span style="color:red; font-weight:bold;">ALERT</span>`; 
                rowStyle += "background:#fff0f0;";
            }
            if(x.type === "CHECKOUT" || x.type === "RETURN" || x.type.includes("STOCK")) {
                level = `<span style="color:#003366; font-weight:bold;">TRANS</span>`;
            }

            let details = x.method || x.item || "System Event";
            if(x.qty) details += ` (Qty: ${x.qty})`;
            if(x.approvedBy) details += ` | Auth: ${x.approvedBy}`;

            tbody.innerHTML += `
            <tr class="sys-log-row" style="${rowStyle}">
                <td style="font-size:12px; color:#555;">${formatTime(x.time)}</td>
                <td style="font-size:11px;">${level}</td>
                <td style="font-weight:bold; font-size:12px;">${x.type}</td>
                <td style="font-size:12px;">${x.user || x.takenBy}</td>
                <td style="font-size:12px; font-family:monospace;">${details}</td>
            </tr>`;
        });
    });
};

// --- SEARCH FUNCTION FOR SYSTEM LOGS ---
window.filterSysLogs = () => {
    const input = document.getElementById("sysLogSearch").value.toLowerCase();
    const rows = document.getElementsByClassName("sys-log-row");
    
    Array.from(rows).forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
};

window.deleteLogEntry = (key) => {
    if(!isAdmin) return alert("Access Denied: Admins Only.");
    if(confirm("Permanently delete this log entry?")) {
        remove(ref(db, `logs/${key}`)).catch(e => alert("Error: " + e.message));
    }
};

window.assignTaskMulti = () => {
    const desc = document.getElementById("taskDesc").value;
    if(!desc) return alert("Please enter task details.");
    const checkboxes = document.querySelectorAll('.user-check:checked');
    if(checkboxes.length === 0) return alert("Select at least one user.");

    checkboxes.forEach(cb => {
        const uid = cb.value;
        const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };
        push(ref(db, `assignments/${uid}`), task);
    });
    alert(`Task assigned to ${checkboxes.length} user(s).`);
    document.getElementById("taskDesc").value = "";
    checkboxes.forEach(cb => cb.checked = false);
};

window.savePin = (uid) => {
    const p = document.getElementById(`pin_${uid}`).value;
    if(p.length >= 4) { update(ref(db, `users/${uid}`), { pin: p }); alert("PIN Updated"); }
}

window.forceReUpload = (uid) => {
    if(confirm("Reset Face Data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset. User must scan face on next login.")); }
}

window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));

// --- GALLERY FUNCTIONS ---
function loadGallery() {
    const div = document.getElementById("galleryContainer"); 
    div.innerHTML = "<p>Loading...</p>";

    onValue(ref(db, "history"), snap => {
        div.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            if(v.fileData) {
                let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
                if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
                else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">üìÑ PDF</div>`;
                
                let controls = `<br><small style="color:grey;">(View Only)</small>`;
                if(isAdmin) {
                    controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">‚¨á Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
                }
                div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
            }
        });
        if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
    });
}

window.removeFile = (k) => {
    if(confirm("Remove attached file?")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            document.getElementById("inpRemarks").value = d.details?.remarks || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}

function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}

window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("inventoryBody"); 
        b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr>
                <td style="font-family:monospace; color:#003366;">${v.barcode || '--'}</td>
                <td>${v.item}</td>
                <td>${v.qty}</td>
                <td>${v.condition || 'N/A'}</td>
                <td>${v.sourceType || 'N/A'}</td>
                <td>${v.user}</td>
                <td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td>
            </tr>`;
        });
    });
}

window.updateSourcePlaceholder = () => {
    const type = document.getElementById("invSourceType").value;
    const input = document.getElementById("invSourceName");
    input.placeholder = type === "Online" ? "Name of Site" : "Name of Store";
};

window.addInventory = async () => { 
    const item = document.getElementById("invName").value;
    const cond = document.getElementById("invCondition").value;
    const sType = document.getElementById("invSourceType").value;
    const sName = document.getElementById("invSourceName").value;
    const barcode = document.getElementById("invBarcode").value; 
    
    const qty = 1;

    if(!item || !cond || !sName || !barcode) {
        return alert("‚ö†Ô∏è All fields + Barcode are required.");
    }

    if(existingItemKey) {
         const itemRef = ref(db, `inventory/${existingItemKey}`);
         const snap = await get(itemRef);
         const currentQty = parseInt(snap.val().qty);
         await update(itemRef, { qty: currentQty + qty });
         
         await push(ref(db, "logs"), { 
            type: "STOCK_UPDATE", 
            item: item, 
            qty: qty, 
            takenBy: currentUser.name, 
            approvedBy: "Self", 
            time: serverTimestamp() 
        });
         alert("Stock Updated (+1 Unit)");
    } else {
         await push(ref(db, "inventory"), { 
            item: item, 
            qty: qty, 
            condition: cond,
            sourceType: sType,
            sourceName: sName,
            user: currentUser.email,
            barcode: barcode 
        });
        
        await push(ref(db, "logs"), { 
            type: "STOCK_ADD", 
            item: item, 
            qty: qty, 
            takenBy: currentUser.name, 
            approvedBy: "Self", 
            time: serverTimestamp() 
        });
        alert("New Item Added (1 Unit)");
    }
    
    document.getElementById("invName").value = "";
    document.getElementById("invName").disabled = false;
    document.getElementById("invBarcode").value = "";
    document.getElementById("existingItemNotice").classList.add("hidden");
    document.getElementById("btnAddStock").innerText = "Save (+1 Unit)";
    document.getElementById("btnAddStock").classList.add("success");
    document.getElementById("btnAddStock").classList.remove("warning");
    existingItemKey = null;
    toggleInvMode('list');
};

window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}

window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });
// --- GLOBAL FUNCTIONS FOR HTML BUTTONS ---
window.login = function() {
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    
    if (!email || !password) {
        alert("Email or password input not found!");
        return;
    }
    
    signInWithEmailAndPassword(auth, email.value, password.value)
        .catch(e => alert("Login Error: " + e.message));
};
// --- REGISTRATION DOTS ---
function updateRegDots(count) {
    document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
    document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
    document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    // Your initialization code here
});
</script>
</body>
</html>
