<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
/* --- OFFICIAL METRO THEME --- */
:root {
  --metro-blue: #003366;
  --metro-gold: #b38600;
  --metro-red: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--metro-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
}

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
}
button:hover { background: #004494; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 {
  margin-top: 0;
  color: var(--metro-blue);
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* UPLOAD BOX */
.upload-zone { border: 2px dashed #ccc; padding: 15px; text-align: center; background: #fafafa; border-radius: 4px; margin-bottom: 15px; }
.file-status { font-size: 12px; color: green; font-weight: bold; margin-top: 5px; }

/* MODAL */
#faceModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; transform: scaleX(-1); }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div><h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">User ID:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="faceModal" class="hidden">
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
  <video id="cameraFeed" autoplay playsinline muted></video>
  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold;"></div>
  <div style="display:flex; gap:10px;">
    <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Capture & Verify</button>
    <button id="btnReRegister" class="warning hidden" onclick="startReRegistration()">‚ö†Ô∏è Update Face Data</button>
  </div>
  <button id="adminBypassBtn" class="danger hidden" style="margin-top:20px;" onclick="forceAdminEntry()">‚ö†Ô∏è ADMIN FORCE ENTRY</button>
  <canvas id="procCanvas" width="320" height="240" class="hidden"></canvas>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('oldData')" id="btnOld">3. History</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <input id="inpStationName" placeholder="STATION NAME">
          <input id="inpStationLength" placeholder="STATION LENGTH (M)">
          <input id="inpYellowDist" placeholder="YELLOW LINE DIST">
          <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS">
      </div>

      <div class="upload-zone">
        <h4>üìé Attach Site Evidence (PDF/Image/Video)</h4>
        <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
        <div id="fileStatus" class="file-status"></div>
        <small style="color:red; display:block; margin-top:5px;">* Max File Size: 2.5 MB (System Limit)</small>
      </div>

      <button class="success" onclick="saveStationDetails()">üíæ Save Draft</button>
      
      <h4 style="margin-top:20px; border-bottom:1px solid #ccc;">Distance Data</h4>
      <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between;"><h3>üì¶ Inventory</h3><button class="success" onclick="document.getElementById('addInvForm').classList.toggle('hidden')">+ New Item</button></div>
        <div id="addInvForm" class="hidden" style="padding:15px; border:1px solid #ccc; margin-bottom:10px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 100px; gap:10px;">
                <input id="invName" placeholder="Product Name"><input id="invQty" type="number" placeholder="Qty"><button onclick="addInventory()">Save</button>
            </div>
        </div>
        <table><thead><tr><th>Product</th><th>Qty</th><th>User</th><th>Action</th></tr></thead><tbody id="inventoryBody"></tbody></table>
    </div>
  </div>

  <div id="tab-oldData" class="hidden">
    <div class="panel">
      <h3>üìÅ History & Files</h3>
      <table><thead><tr><th>Date</th><th>Station</th><th>User</th><th>Evidence File</th><th>Action</th></tr></thead><tbody id="historyBody"></tbody></table>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã My Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>üõ°Ô∏è Administrator Console</h3>
        <button onclick="loadAdminPanel()" class="primary">üîÑ Refresh Data</button>
      </div>

      <h4 style="background:#eee; padding:5px; margin-top:10px;">1. Work Assignment & Tracking</h4>
      <div style="display:grid; grid-template-columns: 1fr 2fr 100px; gap:10px; margin-bottom:20px;">
        <select id="userSelectAssign">
            <option>Loading...</option>
        </select>
        <textarea id="taskDesc" rows="1" placeholder="Task details..."></textarea>
        <button onclick="assignTask()">Assign</button>
      </div>

      <h5 style="color:#666;">Global Task Status Report</h5>
      <table style="margin-bottom:20px;"><thead><tr><th>To User</th><th>Task</th><th>Date</th><th>Status</th></tr></thead><tbody id="globalTaskBody"><tr><td colspan="4">Loading...</td></tr></tbody></table>

      <h4 style="background:#eee; padding:5px;">2. Surveillance</h4>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <select id="userSelectAudit" style="max-width:300px;"><option>Loading...</option></select>
        <button onclick="fetchLogs()" style="background:#17a2b8;">View Logs</button>
      </div>
      <table style="margin-bottom:20px;"><thead><tr><th>Time</th><th>Type</th><th>Activity</th></tr></thead><tbody id="logBody"></tbody></table>

      <h4 style="background:#eee; padding:5px;">3. User Access Control</h4>
      <table><thead><tr><th>Email</th><th>Biometric</th><th>Status</th><th>Actions</th></tr></thead><tbody id="userListBody"></tbody></table>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo, get, limitToLast } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "admin@metro.project"];
let stream = null;
let tempDescriptor = null;
let mode = "verify";
let currentFileBase64 = null;
let currentFileType = null;

// --- AUTH ---
onAuthStateChanged(auth, (user) => {
  if (!user) { showLogin(); return; }
  update(ref(db, `users/${user.uid}`), { email: user.email });

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const u = snap.val();
    if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    currentUser = user;
    isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
    document.getElementById("userInfo").innerText = user.email;
    document.getElementById("authContainer").classList.remove("hidden");
    document.getElementById("loginSection").classList.add("hidden");

    if (isAdmin) {
      document.getElementById("adminBadge").classList.remove("hidden");
      document.getElementById("btnAdmin").classList.remove("hidden");
      document.getElementById("adminBypassBtn").classList.remove("hidden");
      setTimeout(loadAdminPanel, 1000); 
    }

    onValue(ref(db, `users/${user.uid}/faceData`), (s) => {
        document.getElementById("faceModal").classList.remove("hidden");
        initCamera(s.exists());
    }, { onlyOnce: true });
  });
});

function showLogin() {
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appScreen").classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));
window.logout = () => { if(currentUser) logActivity("LOGOUT", "Exit"); signOut(auth); };

// --- BIOMETRICS ---
async function initCamera(hasData) {
    const vid = document.getElementById("cameraFeed");
    try {
        updateStatus("Loading AI...", "yellow");
        const modelUrl = 'https://justadudewhohacks.github.io/face-api.js/models';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(modelUrl),
            faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
            faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl)
        ]);
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        vid.srcObject = stream;
        
        if (!hasData) startRegistration();
        else { mode = "verify"; updateStatus("üîí VERIFICATION: Look at camera", "white"); }
    } catch(e) { alert("Camera Error: " + e.message); updateStatus("Camera Failed.", "red"); }
}

function startRegistration() {
    mode = "register"; tempDescriptor = null;
    updateStatus("‚ö†Ô∏è REGISTRATION: Capture Photo 1", "white");
    document.getElementById("btnReRegister").classList.add("hidden");
    document.getElementById("btnCapture").disabled = false;
}

window.startReRegistration = () => confirm("Re-register?") && startRegistration();
function stopCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById("faceModal").classList.add("hidden"); }
function updateStatus(m,c) { const e=document.getElementById("faceStatus"); e.innerText=m; e.style.color=c; }

window.handleFaceScan = async () => {
    const vid = document.getElementById("cameraFeed");
    const btn = document.getElementById("btnCapture");
    btn.disabled = true; updateStatus("Scanning...", "cyan");

    const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.5 });
    const detection = await faceapi.detectSingleFace(vid, options).withFaceLandmarks().withFaceDescriptor();

    if(!detection) { updateStatus("‚ùå No Face", "red"); btn.disabled=false; return; }
    
    const canvas = document.getElementById("procCanvas");
    canvas.getContext("2d").drawImage(vid, 0, 0, 320, 240);
    const img = canvas.toDataURL("image/png");

    if(mode === "register") {
        if(!tempDescriptor) {
            tempDescriptor = detection.descriptor;
            updateStatus("‚úÖ Saved. Capture Photo 2.", "lime");
            btn.disabled = false;
        } else {
            await update(ref(db, `users/${currentUser.uid}/faceData`), {
                img1: img, desc1: Array.from(tempDescriptor), desc2: Array.from(detection.descriptor)
            });
            logActivity("LOGIN", "Register Success");
            enterApp();
        }
    } else {
        const snap = await get(ref(db, `users/${currentUser.uid}/faceData`));
        const stored = snap.val();
        if(!stored.desc1) { startRegistration(); return; }

        const dist = faceapi.euclideanDistance(detection.descriptor, new Float32Array(stored.desc1));
        let score = Math.floor((1 - dist) * 100);
        if(score > 99) score = 99;

        if(score >= 50) {
            updateStatus(`‚úÖ Verified (${score}%)`, "lime");
            logActivity("LOGIN", `Biometric Success ${score}%`);
            setTimeout(enterApp, 1000);
        } else {
            updateStatus(`‚õî Denied (${score}%). Need 50%.`, "red");
            btn.disabled = false;
        }
    }
};

window.forceAdminEntry = () => { if(isAdmin && confirm("Force entry?")) { logActivity("LOGIN", "ADMIN BYPASS"); enterApp(); } }

function enterApp() {
    stopCamera();
    document.getElementById("appScreen").classList.remove("hidden");
    switchTab('newData');
    loadDraft(); loadHistory(); loadInventory(); loadAssignments();
}

async function logActivity(type, desc) {
    if(!currentUser) return;
    await push(ref(db, "logs"), { user: currentUser.email, type, desc, time: new Date().toLocaleString() });
}

window.switchTab = (t) => {
    ['newData','inventory','oldData','assigned','adminPanel'].forEach(x => document.getElementById(`tab-${x}`).classList.add("hidden"));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.remove("hidden");
    const map = {'newData':'btnNew','inventory':'btnInventory','oldData':'btnOld','assigned':'btnAssign','adminPanel':'btnAdmin'};
    if(map[t]) document.getElementById(map[t]).classList.add("active");
    if(t === 'adminPanel' && isAdmin) loadAdminPanel();
};

// --- FILE UPLOAD LOGIC ---
window.handleFileUpload = () => {
    const file = document.getElementById("evidenceFile").files[0];
    const status = document.getElementById("fileStatus");
    if(!file) return;

    if(file.size > 2.5 * 1024 * 1024) { // 2.5 MB Limit
        alert("File too large! Max 2.5MB allow.");
        document.getElementById("evidenceFile").value = "";
        status.innerText = "";
        currentFileBase64 = null;
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        currentFileBase64 = e.target.result;
        currentFileType = file.type;
        status.innerText = "‚úÖ File Ready to Save: " + file.name;
    };
    reader.readAsDataURL(file);
}

// --- DATA ENTRY ---
function loadDraft() {
    onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
        const d = snap.val();
        if(d) {
            document.getElementById("inpStationName").value = d.details?.name || "";
            document.getElementById("inpStationLength").value = d.details?.len || "";
            document.getElementById("inpYellowDist").value = d.details?.yl || "";
            document.getElementById("inpYellowThick").value = d.details?.th || "";
            const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
            if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
        }
    });
}
window.saveStationDetails = () => {
    update(ref(db, `drafts/${currentUser.uid}/details`), {
        name: inpStationName.value, len: inpStationLength.value, yl: inpYellowDist.value, th: inpYellowThick.value
    });
    logActivity("SAVE", "Draft Updated"); alert("Saved");
};
window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });
function renderRow(k,v,i) {
    const b = document.getElementById("distanceBody");
    b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));

window.submitStationData = () => {
    if(confirm("Submit Final Data?")) {
        get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
            const d = s.val();
            // Include file if exists
            const payload = { 
                ...d.details, 
                rows: d.rows, 
                user: currentUser.email, 
                date: new Date().toLocaleString(),
                fileData: currentFileBase64,
                fileType: currentFileType
            };
            
            push(ref(db, "history"), payload);
            remove(ref(db, `drafts/${currentUser.uid}`));
            logActivity("SUBMIT", `Final Data: ${d.details.name}`);
            
            // Reset File
            document.getElementById("evidenceFile").value = "";
            document.getElementById("fileStatus").innerText = "";
            currentFileBase64 = null;
            
            alert("Submitted"); switchTab('oldData');
        });
    }
};

// --- HISTORY & FILES ---
function loadHistory() {
    onValue(ref(db, "history"), snap => {
        const b = document.getElementById("historyBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            
            // Admin File Controls
            let fileAction = "No File";
            if(v.fileData) {
                fileAction = `<a href="${v.fileData}" download="Evidence_File">View/Download</a>`;
                if(isAdmin) {
                    fileAction += ` <button class="danger" style="padding:2px 5px; font-size:10px; margin-left:5px;" onclick="removeFile('${c.key}')">X</button>`;
                }
            } else if (v.fileRemoved) {
                fileAction = "<span style='color:grey; font-style:italic;'>Removed by Admin</span>";
            }

            const delBtn = isAdmin ? `<td><button class="danger" onclick="delHist('${c.key}')">Del</button></td>` : '<td>-</td>';
            b.innerHTML += `<tr><td>${v.date}</td><td>${v.name}</td><td>${v.user}</td><td>${fileAction}</td>${delBtn}</tr>`;
        });
    });
}
window.delHist = (k) => remove(ref(db, `history/${k}`));

// Remove File Data Only (Admin)
window.removeFile = (k) => {
    if(confirm("Remove attached file to save space? Data will remain.")) {
        update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
    }
}

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const b = document.getElementById("inventoryBody"); b.innerHTML = "";
        snap.forEach(c => {
            const v = c.val();
            b.innerHTML += `<tr><td>${v.item}</td><td>${v.qty}</td><td>${v.user}</td><td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td></tr>`;
        });
    });
}
window.addInventory = () => { push(ref(db, "inventory"), { item: invName.value, qty: invQty.value, user: currentUser.email }); document.getElementById("addInvForm").classList.add("hidden"); };
window.delInv = (k) => remove(ref(db, `inventory/${k}`));

// --- TASKS ---
function loadAssignments() {
    onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
        const list = document.getElementById("taskList"); list.innerHTML = "";
        if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
        snap.forEach(c => {
            const t = c.val();
            const div = document.createElement("div"); div.className = "panel";
            div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
            div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
            list.appendChild(div);
        });
    });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

// --- ADMIN PANEL ---
window.loadAdminPanel = () => {
    const btn = document.querySelector("button[onclick='loadAdminPanel()']");
    if(btn) btn.innerText = "Loading...";

    const assignSel = document.getElementById("userSelectAssign");
    const auditSel = document.getElementById("userSelectAudit");
    const tableBody = document.getElementById("userListBody");
    const globalTaskBody = document.getElementById("globalTaskBody");
    
    // 1. Load Users
    get(ref(db, "users")).then(snap => {
        assignSel.innerHTML = `<option value="ALL" style="font-weight:bold; color:blue;">-- ASSIGN TO ALL (GROUP) --</option>`;
        auditSel.innerHTML = "<option>Select User</option>";
        tableBody.innerHTML = "";

        if(snap.exists()) {
            snap.forEach(c => {
                const u = c.val();
                const uid = c.key;
                assignSel.innerHTML += `<option value="${uid}">${u.email}</option>`;
                auditSel.innerHTML += `<option value="${u.email}">${u.email}</option>`;

                const hasBio = u.faceData ? "‚úÖ Done" : "‚ùå Pending";
                const status = u.terminated ? "<span style='color:red;'>BANNED</span>" : "Active";
                const btnBan = u.terminated ? `<button onclick="toggleBan('${uid}', false)">Unban</button>` : `<button class="danger" onclick="toggleBan('${uid}', true)">Ban</button>`;
                
                tableBody.innerHTML += `<tr><td>${u.email}</td><td>${hasBio}</td><td>${status}</td><td>${btnBan}</td></tr>`;
            });
        }
        if(btn) btn.innerText = "üîÑ Refresh Data";
    });

    // 2. Load Global Task Status (Track Progress)
    get(ref(db, "assignments")).then(snap => {
        globalTaskBody.innerHTML = "";
        if(!snap.exists()) { globalTaskBody.innerHTML = "<tr><td colspan='4'>No active tasks.</td></tr>"; return; }
        
        // Loop through all users
        snap.forEach(userNode => {
            // Loop through tasks of that user
            userNode.forEach(task => {
                const t = task.val();
                // Get Email from ID (Approximate) or just show Task details
                const statusColor = t.status === 'Done' ? 'green' : '#ffc107';
                globalTaskBody.innerHTML += `<tr>
                    <td>${userNode.key.substring(0,5)}...</td>
                    <td>${t.desc}</td>
                    <td>${t.date}</td>
                    <td><span style="font-weight:bold; color:${statusColor}">${t.status}</span></td>
                </tr>`;
            });
        });
    });
}

window.assignTask = () => {
    const uid = document.getElementById("userSelectAssign").value;
    const desc = document.getElementById("taskDesc").value;
    if(!desc) return alert("Enter task description");

    const payload = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };

    if(uid === "ALL") {
        if(!confirm("Assign this task to ALL users?")) return;
        // Fetch all users and assign
        get(ref(db, "users")).then(snap => {
            snap.forEach(u => {
                push(ref(db, `assignments/${u.key}`), payload);
            });
            alert("Group Assignment Sent!");
        });
    } else {
        push(ref(db, `assignments/${uid}`), payload);
        alert("Assigned to specific user.");
    }
};

window.fetchLogs = () => {
    const u = document.getElementById("userSelectAudit").value;
    onValue(query(ref(db, "logs"), orderByChild("user"), equalTo(u), limitToLast(10)), s => {
        const b = document.getElementById("logBody"); b.innerHTML = "";
        const l = []; s.forEach(c=>l.push(c.val()));
        l.reverse().forEach(x => b.innerHTML += `<tr><td>${x.time}</td><td>${x.type}</td><td>${x.desc}</td></tr>`);
    });
};

window.toggleBan = (uid, status) => update(ref(db, `users/${uid}`), { terminated: status }).then(loadAdminPanel);

</script>
</body>
</html>
