<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metro Railway Safety System | Official Portal (Privacy Pro)</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
/* --- OFFICIAL THEME --- */
:root { --official-blue: #003366; --official-accent: #e31e24; --bg-color: #f4f6f9; --panel-bg: #ffffff; --text-main: #212529; }
body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER & LAYOUT */
header { background: var(--official-blue); color: white; padding: 15px 25px; border-bottom: 4px solid #b38600; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }
.panel { background: var(--panel-bg); padding: 25px; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 20px; }
.panel h3 { margin-top: 0; color: var(--official-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

/* UI ELEMENTS */
button { padding: 8px 16px; cursor: pointer; background: #0056b3; color: white; border: 1px solid #004494; border-radius: 3px; font-weight: bold; }
button:disabled { background: #6c757d; cursor: not-allowed; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 3px; box-sizing: border-box; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; }
.station-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; background: #fdfdfd; }
.station-label { font-weight: bold; font-size: 12px; color: var(--official-blue); display: block; margin-bottom: 4px; }

/* NAV & LOGS */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
.nav-btn.active { background: var(--official-blue); color: white; border-color: var(--official-blue); }
.log-tag { font-weight: bold; padding: 2px 6px; border-radius: 3px; color: white; font-size: 11px; }
.tag-LOGIN { background: #28a745; } .tag-ACTION { background: #007bff; } .tag-VIOLATION { background: #dc3545; }

/* MODAL */
#faceModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; transform: scaleX(-1); }
#countdownDisplay { font-size: 4rem; color: #ffc107; font-weight: bold; margin-bottom: 10px; }
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--official-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div><h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1><small>Privacy Secured Portal</small></div>
    <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; padding:2px 6px; border-radius:4px; font-size:11px; margin-left:10px;">ADMIN</span>
  </div>
  <div id="authContainer" class="hidden">
    <span id="userInfo" style="margin-right:15px; font-weight:bold;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--official-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="faceModal" class="hidden">
  <div id="countdownDisplay" class="hidden">5</div>
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing...</p>
  <video id="cameraFeed" autoplay playsinline muted></video>
  <canvas id="faceCanvas" width="320" height="240" class="hidden"></canvas>
  <canvas id="compareCanvas" width="32" height="32" class="hidden"></canvas>
  <button id="btnCapture" onclick="handleFaceCapture(false)" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Capture Photo</button>
  <p id="faceStatus" style="color:#ffc107; margin-top:15px; font-weight:bold;"></p>
</div>

<section id="appSection" class="hidden">
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('oldData')" id="btnOld">3. History</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px;">A. Station Remarks (Save Separately)</h4>
      <div class="station-grid">
          <div><label class="station-label">STATION NAME (Required)</label><input id="inpStationName" placeholder="e.g., Mahanayak Uttam Kumar"></div>
          <div><label class="station-label">STATION LENGTH (M)</label><input id="inpStationLength"></div>
          <div><label class="station-label">YELLOW LINE DISTANCE</label><input id="inpYellowDist"></div>
          <div><label class="station-label">YELLOW LINE THICKNESS</label><input id="inpYellowThick"></div>
      </div>
      <div style="text-align:right; margin-bottom:20px;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Details Only</button>
      </div>

      <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px; margin-top:20px;">B. Distance Data (Save Separately)</h4>
      <table id="distanceTable">
        <thead>
            <tr>
                <th style="width:50px">SL</th>
                <th>RAKE NO</th>
                <th>RAKE TYPE</th>
                <th style="color:#003366">SHAID KHUDIRAM END</th>
                <th style="color:#003366">DAKSHINESWAR END</th>
                <th style="width:50px">ACT</th>
            </tr>
        </thead>
        <tbody id="distanceBody"></tbody>
      </table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366;">‚úî Submit Final Dataset</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üì¶ Inventory & Stock</h3>
            <span id="adminInvControls" class="hidden"><button class="success" onclick="toggleInvForm()">+ Add New Item</button></span>
        </div>
        <div id="addInvForm" class="hidden" style="background:#f1f5f9; padding:15px; margin-bottom:15px; border:1px solid #cbd5e1;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 100px; gap:10px; align-items:end;">
                <div><label class="station-label">Name</label><input id="invName"></div>
                <div><label class="station-label">Source</label><select id="invSource"><option>Offline</option><option>Online</option></select></div>
                <div><label class="station-label">Qty</label><input id="invQty" type="number"></div>
                <div><label class="station-label">Condition</label><select id="invCond"><option>New</option><option>Used</option></select></div>
                <button onclick="addInventory()">Save</button>
            </div>
        </div>
        <table>
            <thead><tr><th>Product Name</th><th>Source</th><th>Qty</th><th>Condition</th><th>Updated</th><th id="invActionHead" class="hidden">Action</th></tr></thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
  </div>

  <div id="tab-oldData" class="hidden">
    <div class="panel">
      <h3>üìÅ Global Data History</h3>
      <table><thead><tr><th>Date</th><th>Station</th><th>Length</th><th>User</th><th id="adminDelHead" class="hidden">Action</th></tr></thead><tbody id="historyBody"></tbody></table>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel"><h3>üìã Assigned Tasks</h3><div id="taskList"></div></div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <h3>üìä Audit & Surveillance</h3>
      <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
        <select id="userSelectAudit" style="max-width:300px;"><option value="">-- Select User --</option></select>
        <button onclick="auditUser('data')">View Excel Data</button>
        <button onclick="auditUser('logs')" style="background:#17a2b8; border-color:#117a8b;">View Activity Logs</button>
      </div>
      <table class="audit-table">
        <thead><tr><th colspan="5" id="auditHeader">Report Output</th></tr><tr style="background:#f0f0f0;"><th>Time</th><th>Type</th><th>Details</th></tr></thead>
        <tbody id="auditBody"><tr><td colspan="5" style="text-align:center;">Select user to view logs.</td></tr></tbody>
      </table>
    </div>
    <div class="panel">
      <h3>üë§ User Access</h3>
      <table><thead><tr><th>Email</th><th>Bio</th><th>Status</th><th>Action</th></tr></thead><tbody id="userListBody"></tbody></table>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];

// BIOMETRIC & CAMERA
let tempPhotos = [];
let verificationMode = "register"; 
let videoStream = null;
let reVerifyTimer = null;
let faceModel = null;
let retryAttempts = 0;

setPersistence(auth, browserSessionPersistence);

// --- LOAD AI ---
async function loadAI() {
    try { faceModel = await blazeface.load(); console.log("AI Ready"); } 
    catch(e) { console.error("AI Error", e); }
}

// --- LOGGING ---
function logActivity(type, desc) {
  if(!currentUser) return;
  push(ref(db, "activityLogs"), {
    user: currentUser.email, uid: currentUser.uid, type: type, description: desc, timestamp: new Date().toLocaleString()
  }).catch(e => console.warn("Log failed:", e)); // Silent fail for logs
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert("Auth Failed: " + e.message));

window.logout = () => {
  logActivity("LOGOUT", "User logged out.");
  if(reVerifyTimer) clearTimeout(reVerifyTimer);
  stopCamera(); // Ensure camera is off
  email.value = ""; password.value = ""; signOut(auth);
};

onAuthStateChanged(auth, user => {
  if (!user) {
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    stopCamera();
    return;
  }
  currentUser = user;
  retryAttempts = 0;
  document.getElementById("authContainer").classList.remove("hidden");
  userInfo.innerText = user.email;
  isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
  
  update(ref(db, `users/${user.uid}`), { email: user.email }).catch(() => {});

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const userData = snap.val();
    if (userData && userData.terminated === true) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    loginSection.classList.add("hidden");
    document.getElementById("faceModal").classList.remove("hidden");
    startCamera(); // Camera ON only for Modal

    if (!userData || !userData.faceData) {
        verificationMode = "register"; tempPhotos = [];
        updateModalUI("Biometric Registration", "Step 1: Capture Photo 1");
    } else {
        verificationMode = "verify";
        tempPhotos = [userData.faceData.photo1, userData.faceData.photo2];
        updateModalUI("Identity Verification", "Position face...");
    }
  }, { onlyOnce: true });
});

/* --- CAMERA PRIVACY CONTROL --- */
async function startCamera() { 
    try { 
        if(!videoStream) {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true }); 
            document.getElementById("cameraFeed").srcObject = videoStream;
        }
        if(!faceModel) await loadAI();
    } catch(e) { alert("Camera Error: " + e.message); } 
}

function stopCamera() { 
    if (videoStream) { 
        videoStream.getTracks().forEach(track => track.stop()); 
        videoStream = null; 
        document.getElementById("cameraFeed").srcObject = null;
        console.log("üîí Privacy Mode: Camera Stopped");
    } 
}

function updateModalUI(title, desc) { 
    document.getElementById("modalTitle").innerText = title; 
    document.getElementById("modalDesc").innerText = desc; 
    document.getElementById("btnCapture").disabled = false; 
    document.getElementById("faceStatus").innerText = ""; 
}

window.handleFaceCapture = async (isAuto = false) => {
    const video = document.getElementById("cameraFeed");
    const status = document.getElementById("faceStatus");
    const btn = document.getElementById("btnCapture");

    btn.disabled = true;
    status.innerText = "Analyzing...";

    if(faceModel) {
        const predictions = await faceModel.estimateFaces(video, false);
        if (predictions.length === 0) {
            status.style.color = "red"; status.innerText = "‚ùå No Face Detected"; btn.disabled = false;
            if(isAuto) setTimeout(logout, 2000);
            return;
        }
    }

    const canvas = document.getElementById("faceCanvas");
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, 320, 240);
    const capturedImg = canvas.toDataURL("image/png");

    if (verificationMode === "register") {
        if (tempPhotos.length === 0) {
            tempPhotos.push(capturedImg); 
            status.innerText = "Saved. Next..."; btn.disabled = false;
            setTimeout(() => updateModalUI("Registration", "Step 2: Capture Photo 2"), 1000);
        } else {
            update(ref(db, `users/${currentUser.uid}/faceData`), { photo1: tempPhotos[0], photo2: capturedImg }).then(() => { 
                status.innerText = "Done."; 
                setTimeout(() => { logActivity("LOGIN", "Reg Success"); accessGranted(); }, 1500); 
            });
        }
    } else {
        compareFace(capturedImg, tempPhotos).then(score => {
            if(score >= 75) { 
                status.style.color = "#28a745"; status.innerText = `Verified (${score}%).`; retryAttempts = 0;
                setTimeout(() => { 
                    if(isAuto) logActivity("AUTO", "Security Check Passed");
                    else logActivity("LOGIN", "Login Passed");
                    accessGranted(); 
                }, 1000);
            } else { 
                retryAttempts++;
                const triesLeft = 3 - retryAttempts;
                logActivity("VIOLATION", `Mismatch (${score}%). Try ${retryAttempts}/3`);
                if (triesLeft > 0) {
                    status.style.color = "#ffc107"; status.innerText = `Mismatch. ${triesLeft} tries left.`; btn.disabled = false;
                } else {
                    status.style.color = "#dc3545"; status.innerText = "Locked Out."; setTimeout(() => logout(), 2000); 
                }
            }
        });
    }
};

function accessGranted() { 
    stopCamera(); // PRIVACY: TURN OFF CAMERA IMMEDIATELY
    document.getElementById("faceModal").classList.add("hidden"); 
    document.getElementById("countdownDisplay").classList.add("hidden");
    initializeAppUI();
    
    // 15 MIN TIMER
    if(reVerifyTimer) clearTimeout(reVerifyTimer);
    reVerifyTimer = setTimeout(triggerSecurityCheck, 15 * 60 * 1000); 
}

function triggerSecurityCheck() {
    startCamera(); // Turn camera ON just for check
    const modal = document.getElementById("faceModal");
    const countDisplay = document.getElementById("countdownDisplay");
    
    modal.classList.remove("hidden");
    countDisplay.classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "SECURITY CHECK";
    document.getElementById("modalDesc").innerText = "Scanning...";
    document.getElementById("btnCapture").disabled = true;

    let timeLeft = 5;
    countDisplay.innerText = timeLeft;

    const countdownInterval = setInterval(() => {
        timeLeft--;
        countDisplay.innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(countdownInterval);
            countDisplay.innerText = "SCANNING";
            window.handleFaceCapture(true); // Auto Capture
        }
    }, 1000);
}

function compareFace(newImg, storedImages) {
    return new Promise(resolve => {
        let best = 0; let count = 0;
        storedImages.forEach(st => {
            const i1 = new Image(); i1.src = newImg; const i2 = new Image(); i2.src = st;
            i1.onload = () => { i2.onload = () => {
                const s = getSimilarity(i1, i2); if(s > best) best = s;
                count++; if(count === storedImages.length) resolve(Math.floor(best));
            }}
        });
    });
}
function getSimilarity(img1, img2) {
    const ctx = document.getElementById("compareCanvas").getContext("2d");
    ctx.drawImage(img1,0,0,32,32); const d1 = ctx.getImageData(0,0,32,32).data;
    ctx.clearRect(0,0,32,32); ctx.drawImage(img2,0,0,32,32); const d2 = ctx.getImageData(0,0,32,32).data;
    let diff = 0, px = 0;
    for (let y=4; y<20; y++) { for (let x=5; x<27; x++) { const i=(y*32+x)*4; diff += Math.abs(d1[i]-d2[i]) + Math.abs(d1[i+1]-d2[i+1]) + Math.abs(d1[i+2]-d2[i+2]); px++; }}
    let m = 100 - ((diff / (255*3*px)) * 100); return m > 80 ? m+10 : (m > 70 ? m+5 : m);
}

/* --- APP --- */
function initializeAppUI() {
  loginSection.classList.add("hidden"); appSection.classList.remove("hidden");
  if (isAdmin) {
    document.getElementById("adminBadge").classList.remove("hidden");
    document.getElementById("btnAdmin").classList.remove("hidden");
    document.getElementById("adminDelHead").classList.remove("hidden");
    document.getElementById("adminInvControls").classList.remove("hidden"); 
    document.getElementById("invActionHead").classList.remove("hidden");
    loadAdminPanel();
  }
  loadStationDraft(); loadHistory(); loadAssignments(); loadInventory();
}

window.switchTab = (t) => {
  ['newData','inventory','oldData','assigned','adminPanel'].forEach(x => document.getElementById(`tab-${x}`).classList.add("hidden"));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tab-${t}`).classList.remove("hidden");
  const map = {'newData':'btnNew','inventory':'btnInventory','oldData':'btnOld','assigned':'btnAssign','adminPanel':'btnAdmin'};
  if(map[t]) document.getElementById(map[t]).classList.add("active");
};

/* --- INVENTORY (PERMISSION FIX) --- */
window.toggleInvForm = () => document.getElementById('addInvForm').classList.toggle('hidden');

window.addInventory = () => {
    if(!currentUser) return alert("Session Expired. Login again.");
    const n = document.getElementById("invName").value;
    const s = document.getElementById("invSource").value;
    const q = document.getElementById("invQty").value;
    const c = document.getElementById("invCond").value;
    if(!n || !q) return alert("Name/Qty required.");
    
    // Using simple object to avoid permission issues with complex nested paths
    const item = { name: n, source: s, qty: q, condition: c, updatedBy: currentUser.email, timestamp: new Date().toLocaleString() };

    push(ref(db, "inventory"), item)
    .then(() => {
        logActivity("ACTION", `Added inventory: ${n}`);
        alert("Saved!");
        document.getElementById("addInvForm").classList.add("hidden");
    })
    .catch(err => {
        console.error(err);
        alert("DB Error: " + err.code + "\nNote: Firebase Rules might be blocking writes. Ask Admin.");
    });
};

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const tbody = document.getElementById("inventoryBody"); tbody.innerHTML = "";
        if(!snap.exists()) return;
        snap.forEach(r => {
            const d = r.val();
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${d.name}</td><td>${d.source}</td><td>${d.qty}</td><td>${d.condition}</td><td><small>${d.updatedBy}</small></td>`;
            if(isAdmin) {
                const td = document.createElement("td"); td.innerHTML = `<button class="danger" onclick="deleteInv('${r.key}')">X</button>`; tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
    }, (error) => {
        console.error(error);
        // Only alert if it's a permission error
        if(error.code.includes("permission")) document.getElementById("inventoryBody").innerHTML = "<tr><td colspan='6' style='color:red'>Access Denied to Inventory Data</td></tr>";
    });
}
window.deleteInv = (k) => confirm("Remove Item?") && remove(ref(db, `inventory/${k}`));

/* --- STATION DATA (SEPARATE SAVES) --- */
function loadStationDraft() {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    const data = snap.val() || {};
    if(data.details) {
        document.getElementById("inpStationName").value = data.details.stationName || "";
        document.getElementById("inpStationLength").value = data.details.stationLength || "";
        document.getElementById("inpYellowDist").value = data.details.yellowDist || "";
        document.getElementById("inpYellowThick").value = data.details.yellowThick || "";
    }
    const tbody = document.getElementById("distanceBody"); tbody.innerHTML = "";
    if(data.rows) { Object.entries(data.rows).forEach(([key, row], index) => { renderRow(key, row, index + 1); }); }
  });
}

window.saveStationDetails = () => {
    const sName = document.getElementById("inpStationName").value;
    if(!sName) return alert("Station Name Required.");
    update(ref(db, `excelData/session/${currentUser.uid}/details`), { 
        stationName: sName, stationLength: document.getElementById("inpStationLength").value, 
        yellowDist: document.getElementById("inpYellowDist").value, yellowThick: document.getElementById("inpYellowThick").value 
    }).then(() => alert("Details Saved."));
}

window.addDistanceRow = () => {
    if(!document.getElementById("inpStationName").value) return alert("Save Station Name first.");
    push(ref(db, `excelData/session/${currentUser.uid}/rows`), { rakeNo: "", rakeType: "", distFront: "", distRear: "" });
};

function renderRow(key, data, slNo) {
    const tbody = document.getElementById("distanceBody");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${slNo}</td><td><input onchange="updateRow('${key}','rakeNo',this.value)" value="${data.rakeNo||''}"></td><td><input onchange="updateRow('${key}','rakeType',this.value)" value="${data.rakeType||''}"></td><td><input onchange="updateRow('${key}','distFront',this.value)" value="${data.distFront||''}"></td><td><input onchange="updateRow('${key}','distRear',this.value)" value="${data.distRear||''}"></td><td><button class="danger" onclick="removeRow('${key}')">X</button></td>`;
    tbody.appendChild(tr);
}
window.updateRow = (k, f, v) => update(ref(db, `excelData/session/${currentUser.uid}/rows/${k}`), { [f]: v });
window.removeRow = (k) => remove(ref(db, `excelData/session/${currentUser.uid}/rows/${k}`));

window.submitStationData = () => {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    const d = snap.val();
    if(!d || !d.details) return alert("No data to submit.");
    if(confirm("Submit Final Data?")) {
        push(ref(db, "excelData/history"), { ...d.details, rows: d.rows || {}, user: currentUser.email, date: new Date().toLocaleString() });
        remove(ref(db, "excelData/session/" + currentUser.uid));
        alert("Submitted!"); switchTab('oldData');
    }
  }, { onlyOnce: true });
};

function loadHistory() {
  onValue(ref(db, "excelData/history"), snap => {
    const tbody = document.getElementById("historyBody"); tbody.innerHTML = "";
    snap.forEach(r => {
      const d = r.val();
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${d.date}</td><td>${d.stationName||'-'}</td><td>${d.stationLength||'-'}</td><td>${d.user}</td>`;
      if(isAdmin) { const td=document.createElement("td"); td.innerHTML=`<button class="danger" onclick="deleteHistory('${r.key}')">Del</button>`; tr.appendChild(td); }
      tbody.appendChild(tr);
    });
  });
}
window.deleteHistory = (k) => confirm("Delete?") && remove(ref(db, `excelData/history/${k}`));

/* --- ADMIN PANEL (AUDIT FIX) --- */
function loadAdminPanel() {
  onValue(ref(db, "users"), snap => {
    const selAud = document.getElementById("userSelectAudit");
    const body = document.getElementById("userListBody");
    selAud.innerHTML = "<option value=''>-- Select --</option>";
    body.innerHTML = "";
    snap.forEach(u => {
      const user = u.val(); const uid = u.key;
      const o = document.createElement("option"); o.value = user.email; o.innerText = user.email; selAud.appendChild(o);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${user.email}</td><td>${user.faceData?"‚úÖ":"‚ùå"}</td><td>${user.terminated?"TERM":"Active"}</td><td>${user.terminated?`<button class="success" onclick="toggleTerm('${uid}',false)">Unban</button>`:`<button class="danger" onclick="toggleTerm('${uid}',true)">Ban</button>`}</td>`;
      body.appendChild(tr);
    });
  });
}

window.auditUser = (mode) => {
    const email = document.getElementById("userSelectAudit").value;
    const body = document.getElementById("auditBody");
    if(!email) return alert("Select user");
    body.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

    if(mode === 'data') {
        document.getElementById("auditHeader").innerText = `Excel Data: ${email}`;
        onValue(ref(db, "excelData/history"), snap => {
            body.innerHTML = ""; let c = 0;
            if(snap.exists()) {
                snap.forEach(r => {
                    const d = r.val();
                    if(d.user && d.user.toLowerCase() === email.toLowerCase()) {
                        c++;
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td>${d.date}</td><td><span class="log-tag tag-ACTION">DATA</span></td><td>Station: ${d.stationName}</td>`;
                        body.appendChild(tr);
                    }
                });
            }
            if(c===0) body.innerHTML = "<tr><td colspan='5'>No Data Found</td></tr>";
        }, {onlyOnce:true});
    } else {
        document.getElementById("auditHeader").innerText = `Logs: ${email}`;
        onValue(ref(db, "activityLogs"), snap => {
            body.innerHTML = ""; let c = 0;
            if(snap.exists()) {
                const entries = [];
                snap.forEach(r => { if(r.val().user && r.val().user.toLowerCase().trim() === email.toLowerCase().trim()) entries.push(r.val()); });
                entries.reverse().forEach(log => {
                    c++;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${log.timestamp}</td><td><span class="log-tag tag-${log.type}">${log.type}</span></td><td>${log.description}</td>`;
                    body.appendChild(tr);
                });
            }
            if(c===0) body.innerHTML = "<tr><td colspan='5'>No Logs Found</td></tr>";
        }, (err) => {
            console.error(err);
            body.innerHTML = "<tr><td colspan='5' style='color:red'>Error loading logs (Permission Denied).</td></tr>";
        }, {onlyOnce:true});
    }
};

window.toggleTerm = (u, s) => update(ref(db, `users/${u}`), {terminated:s});
</script>
</body>
</html>
