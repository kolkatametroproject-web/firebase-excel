<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
/* --- OFFICIAL THEME (Light Mode) --- */
:root {
  --official-blue: #003366;
  --official-accent: #e31e24;
  --bg-color: #f4f6f9;
  --panel-bg: #ffffff;
  --text-main: #212529;
  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
  background: var(--official-blue);
  color: white;
  padding: 15px 25px;
  border-bottom: 4px solid #b38600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
header small { font-size: 0.8rem; opacity: 0.9; display: block; font-weight: normal; }

/* BUTTONS */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: #0056b3;
  color: white;
  border: 1px solid #004494;
  border-radius: 3px;
  font-weight: bold;
  font-size: 13px;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }

/* INPUTS */
input, select, textarea {
  background: #fff;
  border: 1px solid #ced4da;
  color: #495057;
  padding: 8px;
  border-radius: 3px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 10px;
  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
  background: var(--panel-bg);
  padding: 25px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 {
  margin-top: 0;
  color: var(--official-blue);
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

/* FORMATTING */
.station-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #fdfdfd; padding: 15px; border: 1px solid #eee; }
.station-label { font-weight: bold; font-size: 12px; color: var(--official-blue); margin-bottom: 4px; display: block; }

/* LOGS & STATUS */
.log-tag { font-weight: bold; padding: 2px 6px; border-radius: 3px; color: white; font-size: 11px; display: inline-block; width: 60px; text-align: center; }
.tag-LOGIN { background: #28a745; }
.tag-LOGOUT { background: #6c757d; }
.tag-SAVE { background: #007bff; }
.tag-DELETE { background: #dc3545; }
.tag-SUBMIT { background: #6610f2; }

.status-badge { padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
.status-pending { background: #ffefc1; color: #856404; border: 1px solid #ffeeba; }
.status-completed { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
.nav-btn.active { background: var(--official-blue); color: white; border-color: var(--official-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }
input.cell { border: none; background: transparent; width: 100%; font-size: 13px; }
input.cell:focus { background: #fff; outline: 1px solid #80bdff; }

/* MODAL & SECURITY */
#faceModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
#cameraFeed { border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 320px; height: 240px; background: #000; margin-bottom: 15px; transform: scaleX(-1); }
#countdownDisplay { font-size: 4rem; color: #ffc107; font-weight: bold; margin-bottom: 10px; text-shadow: 0 0 10px orange; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:40px;height:40px;background:white;color:var(--official-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
    <div>
      <h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1>
      <small>Secure Data Management Portal</small>
    </div>
    <span id="adminBadge" class="hidden status-badge" style="background:#dc3545; color:white; margin-left:10px;">ADMINISTRATOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:12px; margin-right:5px; opacity:0.8">User ID:</span>
    <span id="userInfo" style="margin-right:15px; font-weight:bold;"></span>
    <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--official-blue);">
    <h3>Authorized Access Only</h3>
    <input id="email" placeholder="user@metro.project">
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
  </div>
</section>

<div id="faceModal" class="hidden">
  <div id="countdownDisplay" class="hidden">5</div>
  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
  <video id="cameraFeed" autoplay playsinline muted></video>
  <canvas id="faceCanvas" width="320" height="240" class="hidden"></canvas>
  <canvas id="compareCanvas" width="32" height="32" class="hidden"></canvas>
  <button id="btnCapture" onclick="handleFaceCapture(false)" style="background:white; color:black; border:none; padding:10px 20px;">üì∏ Capture Photo</button>
  <p id="faceStatus" style="color:#ffc107; margin-top:15px; font-weight:bold;"></p>
</div>

<section id="appSection" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
    <button class="nav-btn" onclick="switchTab('oldData')" id="btnOld">3. History</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
  </div>

  <div id="tab-newData">
    <div class="panel">
      <h3>üÜï Station Data Entry</h3>
      <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px;">A. Station Remarks (Save Separately)</h4>
      <div class="station-grid">
          <div><label class="station-label">STATION NAME (Required)</label><input id="inpStationName" placeholder="e.g., Mahanayak Uttam Kumar"></div>
          <div><label class="station-label">STATION LENGTH (M)</label><input id="inpStationLength" placeholder="e.g., 172.8 M"></div>
          <div><label class="station-label">YELLOW LINE DISTANCE</label><input id="inpYellowDist" placeholder="e.g., 70 CM"></div>
          <div><label class="station-label">YELLOW LINE THICKNESS</label><input id="inpYellowThick" placeholder="e.g., 10 CM"></div>
      </div>
      <div style="text-align:right; margin-bottom:20px;">
          <button class="success" onclick="saveStationDetails()">üíæ Save Station Details Only</button>
      </div>

      <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px; margin-top:20px;">B. Distance Data (Save Separately)</h4>
      <table id="distanceTable">
        <thead>
            <tr>
                <th style="width:50px">SL</th>
                <th>RAKE NO</th>
                <th>RAKE TYPE</th>
                <th style="color:#003366">SHAID KHUDIRAM END</th>
                <th style="color:#003366">DAKSHINESWAR END</th>
                <th style="width:50px">ACT</th>
            </tr>
        </thead>
        <tbody id="distanceBody"></tbody>
      </table>
      <div style="margin-top:10px; display:flex; justify-content:space-between;">
          <button onclick="addDistanceRow()">+ Add Row</button>
          <button onclick="submitStationData()" style="background:#003366; border-color:#002244;">‚úî Submit Final Dataset (Archives)</button>
      </div>
    </div>
  </div>

  <div id="tab-inventory" class="hidden">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üì¶ Inventory & Stock</h3>
            <span id="adminInvControls" class="hidden">
                <button class="success" onclick="toggleInvForm()">+ Add New Item</button>
            </span>
        </div>

        <div id="addInvForm" class="hidden" style="background:#f1f5f9; padding:15px; margin-bottom:15px; border:1px solid #cbd5e1;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 100px; gap:10px; align-items:end;">
                <div><label class="station-label">Product Name</label><input id="invName"></div>
                <div><label class="station-label">Source</label>
                    <select id="invSource"><option>Offline</option><option>Online</option></select>
                </div>
                <div><label class="station-label">Qty</label><input id="invQty" type="number"></div>
                <div><label class="station-label">Condition</label>
                    <select id="invCond"><option>New</option><option>Used</option><option>Damaged</option></select>
                </div>
                <button onclick="addInventory()">Save</button>
            </div>
        </div>

        <table>
            <thead><tr><th>Product Name</th><th>Source</th><th>Qty</th><th>Condition</th><th style="width:140px">Updated</th><th id="invActionHead" class="hidden">Action</th></tr></thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
  </div>

  <div id="tab-oldData" class="hidden">
    <div class="panel">
      <h3>üìÅ Global Data History</h3>
      <table>
        <thead><tr><th>Date</th><th>Station</th><th>Length</th><th>Y.L. Dist</th><th>User</th><th id="adminDelHead" class="hidden">Action</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>

  <div id="tab-assigned" class="hidden">
    <div class="panel">
      <h3>üìã Assigned Tasks</h3>
      <div id="taskList"></div>
    </div>
  </div>

  <div id="tab-adminPanel" class="hidden">
    <div class="panel">
      <h3>üõ† Work Assignment</h3>
      <div style="display:grid; grid-template-columns: 1fr 2fr 100px; gap:10px;">
        <select id="userSelectAssign"><option>Loading...</option></select>
        <textarea id="taskDesc" rows="1" placeholder="Task description..."></textarea>
        <button onclick="assignTask()">Assign</button>
      </div>
    </div>
    <div class="panel" style="border-top: 4px solid var(--official-blue);">
      <h3>üìä Audit & Surveillance</h3>
      <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
        <select id="userSelectAudit" style="max-width:300px;"><option value="">-- Select User --</option></select>
        <button onclick="auditUser('data')">View Excel Data</button>
        <button onclick="auditUser('logs')" style="background:#17a2b8; border-color:#117a8b;">View Activity Logs</button>
      </div>
      <table class="audit-table">
        <thead>
            <tr><th colspan="5" id="auditHeader">Report Output</th></tr>
            <tr style="background:#f0f0f0; color:#333;"><th>Time</th><th>Type</th><th>Details/Data</th></tr>
        </thead>
        <tbody id="auditBody"><tr><td colspan="5" style="text-align:center;">Select user and report type.</td></tr></tbody>
      </table>
    </div>
    <div class="panel">
      <h3>üë§ User Access Control</h3>
      <table>
        <thead><tr><th>Email ID</th><th>Biometric</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="userListBody"></tbody>
      </table>
    </div>
  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];

// BIOMETRIC AI
let tempPhotos = [];
let verificationMode = "register"; 
let videoStream = null;
let reVerifyTimer = null;
let faceModel = null;
let retryAttempts = 0;

setPersistence(auth, browserSessionPersistence);

// --- LOAD AI MODEL ---
async function loadAI() {
    document.getElementById("modalDesc").innerText = "Loading AI Face Detection Model...";
    try {
        faceModel = await blazeface.load();
        console.log("AI Model Loaded");
        document.getElementById("modalDesc").innerText = "AI Ready. Position your face.";
    } catch(e) {
        console.error("AI Load Failed", e);
        alert("CRITICAL ERROR: AI Face Model failed to load. Check internet.");
    }
}

// --- ACTIVITY LOGGING & CLEANUP (LAST 50 RULE) ---
async function logActivity(type, desc) {
  if(!currentUser) return;
  // STRICT FILTER: ONLY LOGIN, LOGOUT, SAVE, DELETE, SUBMIT
  const allowed = ["LOGIN", "LOGOUT", "SAVE", "DELETE", "SUBMIT"];
  if(!allowed.includes(type)) return; 

  const userEmail = currentUser.email;

  // 1. ADD NEW LOG
  await push(ref(db, "activityLogs"), {
    user: userEmail,
    uid: currentUser.uid,
    type: type, 
    description: desc,
    timestamp: new Date().toLocaleString()
  });

  // 2. CLEANUP: Keep only last 50 for this user
  try {
      const logsRef = ref(db, "activityLogs");
      const q = query(logsRef, orderByChild("user"), equalTo(userEmail));
      
      const snapshot = await get(q);
      if (snapshot.exists()) {
          const logs = [];
          snapshot.forEach(child => {
              logs.push({ key: child.key, ...child.val() });
          });

          // If more than 50, delete oldest
          if (logs.length > 50) {
              const toDeleteCount = logs.length - 50;
              for (let i = 0; i < toDeleteCount; i++) {
                  remove(ref(db, `activityLogs/${logs[i].key}`));
              }
          }
      }
  } catch(e) {
      console.error("Auto-cleanup failed (check rules):", e);
  }
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert("Auth Failed: " + e.message));

window.logout = () => {
  logActivity("LOGOUT", "User initiated logout or failed check.");
  if(reVerifyTimer) clearTimeout(reVerifyTimer);
  email.value = ""; password.value = ""; signOut(auth);
};

onAuthStateChanged(auth, user => {
  if (!user) {
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    document.getElementById("authContainer").classList.add("hidden");
    stopCamera();
    return;
  }
  currentUser = user;
  retryAttempts = 0; 
  document.getElementById("authContainer").classList.remove("hidden");
  userInfo.innerText = user.email;
  isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
  
  update(ref(db, `users/${user.uid}`), { email: user.email }).catch(console.error);

  onValue(ref(db, `users/${user.uid}`), (snap) => {
    const userData = snap.val();
    if (userData && userData.terminated === true) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

    loginSection.classList.add("hidden");
    document.getElementById("faceModal").classList.remove("hidden");
    startCamera(); 

    if (!userData || !userData.faceData) {
        verificationMode = "register"; tempPhotos = [];
        updateModalUI("Biometric Registration", "Step 1: Capture Photo 1");
    } else {
        verificationMode = "verify";
        tempPhotos = [userData.faceData.photo1, userData.faceData.photo2];
        updateModalUI("Identity Verification", "AI Scanning for human face...");
    }
  }, { onlyOnce: true });
});

/* --- FACE LOGIC & PRIVACY HANDLING --- */
async function startCamera() { 
    try { 
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true }); 
        document.getElementById("cameraFeed").srcObject = videoStream;
        if(!faceModel) await loadAI();
    } catch(e) { alert("Camera Error: " + e.message); } 
}

// PRIVACY: Stops camera stream completely
function stopCamera() { 
    if (videoStream) { 
        videoStream.getTracks().forEach(track => track.stop()); 
        videoStream = null; 
        document.getElementById("cameraFeed").srcObject = null;
        console.log("Camera Stopped for Privacy.");
    } 
}

function updateModalUI(title, desc) { document.getElementById("modalTitle").innerText = title; document.getElementById("modalDesc").innerText = desc; document.getElementById("btnCapture").disabled = false; document.getElementById("faceStatus").innerText = ""; }

window.handleFaceCapture = async (isAuto = false) => {
    const video = document.getElementById("cameraFeed");
    const status = document.getElementById("faceStatus");
    const btn = document.getElementById("btnCapture");

    if(!videoStream || !video.srcObject) {
         status.innerText = "Camera not active."; return;
    }

    btn.disabled = true;
    status.innerText = "AI Analyzing...";

    if(faceModel) {
        const predictions = await faceModel.estimateFaces(video, false);
        if (predictions.length === 0) {
            status.style.color = "red";
            status.innerText = "‚ùå NO HUMAN FACE DETECTED";
            btn.disabled = false;
            if(isAuto) {
                setTimeout(logout, 2000);
            }
            return;
        }
    }

    const canvas = document.getElementById("faceCanvas");
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, 320, 240);
    const capturedImg = canvas.toDataURL("image/png");

    if (verificationMode === "register") {
        if (tempPhotos.length === 0) {
            tempPhotos.push(capturedImg); 
            status.innerText = "Photo 1 Saved. Move slightly."; 
            btn.disabled = false;
            setTimeout(() => updateModalUI("Biometric Registration", "Step 2: Capture Photo 2"), 1000);
        } else {
            update(ref(db, `users/${currentUser.uid}/faceData`), { photo1: tempPhotos[0], photo2: capturedImg }).then(() => { 
                status.innerText = "Registration Complete."; 
                setTimeout(() => { logActivity("LOGIN", "First time registration."); accessGranted(); }, 1500); 
            });
        }
    } else {
        compareFace(capturedImg, tempPhotos).then(score => {
            if(score >= 75) { 
                status.style.color = "#28a745"; 
                status.innerText = `Verified (Match: ${score}%).`; 
                retryAttempts = 0; 
                setTimeout(() => { 
                    if(!isAuto) logActivity("LOGIN", "Login Success");
                    accessGranted(); 
                }, 1000);
            } else { 
                retryAttempts++;
                const triesLeft = 3 - retryAttempts;
                
                if (triesLeft > 0) {
                    status.style.color = "#ffc107";
                    status.innerText = `Mismatch (${score}%). Try Again (${triesLeft} left).`;
                    btn.disabled = false; 
                } else {
                    status.style.color = "#dc3545";
                    status.innerText = `Identity Mismatch. Locked Out.`;
                    setTimeout(() => logout(), 2000); 
                }
            }
        });
    }
};

function accessGranted() { 
    document.getElementById("faceModal").classList.add("hidden"); 
    document.getElementById("countdownDisplay").classList.add("hidden");
    stopCamera(); // Privacy enforcement
    initializeAppUI();
    
    if(reVerifyTimer) clearTimeout(reVerifyTimer);
    reVerifyTimer = setTimeout(triggerSecurityCheck, 15 * 60 * 1000); 
}

async function triggerSecurityCheck() {
    await startCamera();
    const modal = document.getElementById("faceModal");
    const countDisplay = document.getElementById("countdownDisplay");
    
    modal.classList.remove("hidden");
    countDisplay.classList.remove("hidden");
    document.getElementById("modalTitle").innerText = "SECURITY CHECK";
    document.getElementById("modalDesc").innerText = "Presence Verification Required";
    document.getElementById("btnCapture").disabled = true;

    let timeLeft = 5;
    countDisplay.innerText = timeLeft;

    const countdownInterval = setInterval(() => {
        timeLeft--;
        countDisplay.innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(countdownInterval);
            countDisplay.innerText = "SCANNING";
            window.handleFaceCapture(true); 
        }
    }, 1000);
}

function compareFace(newImg, storedImages) {
    return new Promise(resolve => {
        let best = 0; let count = 0;
        storedImages.forEach(st => {
            const i1 = new Image(); i1.src = newImg; const i2 = new Image(); i2.src = st;
            i1.onload = () => { i2.onload = () => {
                const s = getSimilarity(i1, i2); if(s > best) best = s;
                count++; if(count === storedImages.length) resolve(Math.floor(best));
            }}
        });
    });
}
function getSimilarity(img1, img2) {
    const ctx = document.getElementById("compareCanvas").getContext("2d");
    ctx.drawImage(img1,0,0,32,32); const d1 = ctx.getImageData(0,0,32,32).data;
    ctx.clearRect(0,0,32,32); ctx.drawImage(img2,0,0,32,32); const d2 = ctx.getImageData(0,0,32,32).data;
    let diff = 0, px = 0;
    for (let y=4; y<20; y++) { for (let x=5; x<27; x++) {
        const i=(y*32+x)*4; diff += Math.abs(d1[i]-d2[i]) + Math.abs(d1[i+1]-d2[i+1]) + Math.abs(d1[i+2]-d2[i+2]); px++;
    }}
    let m = 100 - ((diff / (255*3*px)) * 100);
    return m > 80 ? m+10 : (m > 70 ? m+5 : m);
}

/* --- APP LOGIC --- */
function initializeAppUI() {
  loginSection.classList.add("hidden"); appSection.classList.remove("hidden");
  if (isAdmin) {
    document.getElementById("adminBadge").classList.remove("hidden");
    document.getElementById("btnAdmin").classList.remove("hidden");
    document.getElementById("adminDelHead").classList.remove("hidden");
    document.getElementById("adminInvControls").classList.remove("hidden"); 
    document.getElementById("invActionHead").classList.remove("hidden");
    loadAdminPanel();
  }
  loadStationDraft(); loadHistory(); loadAssignments(); loadInventory();
}

window.switchTab = (t) => {
  ['newData','inventory','oldData','assigned','adminPanel'].forEach(x => document.getElementById(`tab-${x}`).classList.add("hidden"));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`tab-${t}`).classList.remove("hidden");
  const map = {'newData':'btnNew','inventory':'btnInventory','oldData':'btnOld','assigned':'btnAssign','adminPanel':'btnAdmin'};
  if(map[t]) document.getElementById(map[t]).classList.add("active");
};

/* --- INVENTORY LOGIC --- */
window.toggleInvForm = () => {
    document.getElementById('addInvForm').classList.toggle('hidden');
}

window.addInventory = () => {
    const n = document.getElementById("invName").value;
    const s = document.getElementById("invSource").value;
    const q = document.getElementById("invQty").value;
    const c = document.getElementById("invCond").value;
    if(!n || !q) { alert("Error: Product Name and Quantity are required."); return; }
    
    push(ref(db, "inventory"), {
        name: n, source: s, qty: q, condition: c, updatedBy: currentUser.email, timestamp: new Date().toLocaleString()
    }).then(() => {
        logActivity("SAVE", `Added inventory: ${n}`);
        document.getElementById("invName").value = "";
        document.getElementById("invQty").value = "";
        alert("Inventory Saved Successfully!");
        document.getElementById("addInvForm").classList.add("hidden");
    }).catch(err => alert("PERMISSION DENIED: Update Firebase Console Rules.\n\n" + err.message));
};

function loadInventory() {
    onValue(ref(db, "inventory"), snap => {
        const tbody = document.getElementById("inventoryBody"); tbody.innerHTML = "";
        if(!snap.exists()) return;
        snap.forEach(r => {
            const d = r.val();
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${d.name}</td><td>${d.source}</td><td>${d.qty}</td><td>${d.condition}</td><td><small>${d.updatedBy}<br>${d.timestamp}</small></td>`;
            if(isAdmin) {
                const td = document.createElement("td");
                td.innerHTML = `<button class="danger" onclick="deleteInv('${r.key}')">X</button>`;
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
    }, (error) => {
        console.error(error);
        document.getElementById("inventoryBody").innerHTML = `<tr><td colspan='6' style='color:red;'>Error: ${error.message} (Fix Database Rules)</td></tr>`;
    });
}

window.deleteInv = (k) => {
    if(confirm("Remove Item?")) {
        remove(ref(db, `inventory/${k}`));
        logActivity("DELETE", "Removed Inventory Item");
    }
};

/* --- DATA ENTRY --- */
function loadStationDraft() {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    const data = snap.val() || {};
    if(data.details) {
        document.getElementById("inpStationName").value = data.details.stationName || "";
        document.getElementById("inpStationLength").value = data.details.stationLength || "";
        document.getElementById("inpYellowDist").value = data.details.yellowDist || "";
        document.getElementById("inpYellowThick").value = data.details.yellowThick || "";
    }
    const tbody = document.getElementById("distanceBody");
    tbody.innerHTML = "";
    if(data.rows) { Object.entries(data.rows).forEach(([key, row], index) => { renderRow(key, row, index + 1); }); }
  });
}

window.saveStationDetails = () => {
    const sName = document.getElementById("inpStationName").value;
    const sLen = document.getElementById("inpStationLength").value;
    const yDist = document.getElementById("inpYellowDist").value;
    const yThick = document.getElementById("inpYellowThick").value;

    if(!sName) return alert("Please enter Station Name before saving.");

    update(ref(db, `excelData/session/${currentUser.uid}/details`), { 
        stationName: sName, stationLength: sLen, yellowDist: yDist, yellowThick: yThick 
    }).then(() => {
        logActivity("SAVE", `Saved draft details for ${sName}`);
        alert("Station Details Saved (Draft). Now add rows.");
    });
}

window.addDistanceRow = () => {
    const sName = document.getElementById("inpStationName").value;
    if(!sName) return alert("STOP: Please enter and SAVE the Station Name first.");
    push(ref(db, `excelData/session/${currentUser.uid}/rows`), { rakeNo: "", rakeType: "", distFront: "", distRear: "" });
};

function renderRow(key, data, slNo) {
    const tbody = document.getElementById("distanceBody");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${slNo}</td><td><input class="cell" value="${data.rakeNo||''}" onchange="updateRow('${key}','rakeNo',this.value)"></td><td><input class="cell" value="${data.rakeType||''}" onchange="updateRow('${key}','rakeType',this.value)"></td><td><input class="cell" value="${data.distFront||''}" onchange="updateRow('${key}','distFront',this.value)"></td><td><input class="cell" value="${data.distRear||''}" onchange="updateRow('${key}','distRear',this.value)"></td><td><button class="danger" onclick="removeRow('${key}')">X</button></td>`;
    tbody.appendChild(tr);
}

window.updateRow = (k, f, v) => update(ref(db, `excelData/session/${currentUser.uid}/rows/${k}`), { [f]: v });
window.removeRow = (k) => remove(ref(db, `excelData/session/${currentUser.uid}/rows/${k}`));

window.submitStationData = () => {
  onValue(ref(db, "excelData/session/" + currentUser.uid), snap => {
    const d = snap.val();
    if(!d || !d.details || !d.details.stationName) return alert("Fill Station Name and Save Details first.");
    
    if(confirm("Submit Final Data to Archives?")) {
        const finalObj = { 
            ...d.details, 
            rows: d.rows || {},
            user: currentUser.email, 
            date: new Date().toLocaleString(), 
            rowCount: d.rows ? Object.keys(d.rows).length : 0 
        };
        push(ref(db, "excelData/history"), finalObj);
        remove(ref(db, "excelData/session/" + currentUser.uid));
        logActivity("SUBMIT", `Submitted data for ${d.details.stationName}`);
        alert("Submitted Successfully."); switchTab('oldData');
    }
  }, { onlyOnce: true });
};

/* --- HISTORY & TASKS --- */
function loadHistory() {
  onValue(ref(db, "excelData/history"), snap => {
    const tbody = document.getElementById("historyBody"); tbody.innerHTML = "";
    snap.forEach(r => {
      const d = r.val();
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${d.date}</td><td>${d.stationName||'-'}</td><td>${d.stationLength||'-'}</td><td>${d.yellowDist||'-'}</td><td>${d.user}</td>`;
      if(isAdmin) {
         const td = document.createElement("td"); td.innerHTML = `<button class="danger" style="padding:2px;" onclick="deleteHistory('${r.key}')">Del</button>`; tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
  });
}
window.deleteHistory = (k) => {
    if(confirm("Delete?")) {
        remove(ref(db, `excelData/history/${k}`));
        logActivity("DELETE", "Deleted History Record");
    }
};

function loadAssignments() {
  onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
    const l = document.getElementById("taskList"); l.innerHTML = "";
    snap.forEach(t => {
      const val = t.val();
      const d = document.createElement("div"); d.className="panel"; d.style.borderLeft="4px solid #ffc107";
      const isDone = val.status === "Completed";
      if(isDone) d.style.borderLeft = "4px solid #28a745";
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between">
            <strong>Task</strong>
            <span class="status-badge ${isDone ? 'status-completed' : 'status-pending'}">${val.status || 'Pending'}</span>
        </div>
        <p>${val.description}</p>
        <div style="margin-top:10px;">
            ${!isDone ? `<button onclick="markTaskDone('${t.key}')">Mark Done</button>` : `<small>Completed on ${val.completedAt}</small>`}
        </div>`;
      l.appendChild(d);
    });
  });
}
window.markTaskDone = (k) => {
    update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Completed", completedAt: new Date().toLocaleString() });
    logActivity("SAVE", "Task marked completed");
};

/* --- ADMIN PANEL --- */
function loadAdminPanel() {
  onValue(ref(db, "users"), snap => {
    const selAss = document.getElementById("userSelectAssign");
    const selAud = document.getElementById("userSelectAudit");
    const body = document.getElementById("userListBody");
    selAss.innerHTML = "<option value=''>-- Select --</option>";
    selAud.innerHTML = "<option value=''>-- Select --</option>";
    body.innerHTML = "";
    snap.forEach(u => {
      const user = u.val(); const uid = u.key;
      const o1 = document.createElement("option"); o1.value = uid; o1.innerText = user.email; selAss.appendChild(o1);
      const o2 = document.createElement("option"); o2.value = user.email; o2.innerText = user.email; selAud.appendChild(o2);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${user.email}</td><td>${user.faceData?"‚úÖ":"‚ùå"}</td><td>${user.terminated?"TERM":"Active"}</td><td>${user.terminated?`<button style="background:green" onclick="toggleTerm('${uid}',false)">Unban</button>`:`<button class="danger" onclick="toggleTerm('${uid}',true)">Ban</button>`} ${user.faceData?`<button class="warning" onclick="resetFace('${uid}')">Reset Face</button>`:``}</td>`;
      body.appendChild(tr);
    });
  }, (error) => {
      console.error("Admin Load Error", error);
      document.getElementById("userListBody").innerHTML = `<tr><td colspan='4' style='color:red;'>Access Denied. Check Rules.</td></tr>`;
  });
}

window.auditUser = (mode) => {
    const email = document.getElementById("userSelectAudit").value;
    const body = document.getElementById("auditBody");
    const header = document.getElementById("auditHeader");
    
    if(!email) return alert("Select user");
    body.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

    if(mode === 'data') {
        header.innerText = `Excel Data: ${email}`;
        onValue(ref(db, "excelData/history"), snap => {
            body.innerHTML = ""; let c = 0;
            snap.forEach(r => {
                const d = r.val();
                if(d.user && d.user.toLowerCase() === email.toLowerCase()) {
                    c++;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${d.date}</td><td><span class="log-tag tag-SAVE">DATA</span></td><td>Station: ${d.stationName} (${d.rowCount} rows)</td>`;
                    body.appendChild(tr);
                }
            });
            if(c===0) body.innerHTML = "<tr><td colspan='5'>No Data Found</td></tr>";
        });
    } else {
        header.innerText = `Activity Logs: ${email}`;
        // Query to get user specific logs
        const logsRef = ref(db, "activityLogs");
        const q = query(logsRef, orderByChild("user"), equalTo(email));
        
        get(q).then((snap) => {
             body.innerHTML = ""; 
             if(!snap.exists()) {
                 body.innerHTML = `<tr><td colspan='5'>No Logs Found for ${email}</td></tr>`;
                 return;
             }
             
             const logs = [];
             snap.forEach(c => logs.push(c.val()));
             logs.reverse(); // Show newest first
             
             logs.forEach(log => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${log.timestamp}</td><td><span class="log-tag tag-${log.type}">${log.type}</span></td><td>${log.description}</td>`;
                body.appendChild(tr);
             });
        }).catch(error => {
            body.innerHTML = `<tr><td colspan='5' style="color:red">PERMISSION DENIED (Fix Firebase Rules)</td></tr>`;
        });
    }
};

window.assignTask = () => { const uid = document.getElementById("userSelectAssign").value; const desc = document.getElementById("taskDesc").value; if(uid && desc) push(ref(db, `assignments/${uid}`), {description:desc, status: "Pending", assignedBy:currentUser.email, date:new Date().toLocaleString()}).then(()=>alert("Assigned")); };
window.toggleTerm = (u, s) => update(ref(db, `users/${u}`), {terminated:s});
window.resetFace = (u) => confirm("Reset?") && update(ref(db, `users/${u}`), {faceData:null});

</script>
</body>
</html>
