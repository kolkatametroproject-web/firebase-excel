<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MSMS | Metro Safety Management System</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* --- OFFICIAL GOVERNMENT & METRO THEME (UPDATED) --- */
:root {
  --metro-blue: #0A2342; /* Deep Professional Navy */
  --metro-gold: #C5A059; /* Metallic Gold Accent */
  --metro-red: #B91C1C;  /* Professional Alert Red */
  --metro-slate: #4A5568; /* Official Slate Text */
  --bg-color: #F8FAFC;    /* Clean Enterprise Background */
  --panel-bg: #FFFFFF;
  --text-main: #1A202C;
  --border-color: #E2E8F0;
  --success-green: #15803d; /* Darker, professional green */
}

body { 
    margin: 0; 
    font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif; 
    background: var(--bg-color); 
    color: var(--text-main); 
    font-size: 14px; 
    line-height: 1.5;
}

/* HEADER - OFFICIAL AUTHORITY STYLE */
header {
  background: var(--metro-blue);
  color: white;
  padding: 12px 25px;
  border-bottom: 4px solid var(--metro-gold);
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  position: relative; z-index: 1001;
  flex-wrap: wrap;
}

/* BUTTONS - ENTERPRISE GRADE */
button {
  padding: 8px 16px;
  cursor: pointer;
  background: var(--metro-blue);
  color: white;
  border: 1px solid #001a33;
  border-radius: 4px;
  font-weight: 600;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all 0.2s ease-in-out;
}
button:hover { background: #163a63; transform: translateY(-1px); }
button:disabled { background: #94a3b8; cursor: not-allowed; border-color: #64748b; opacity: 0.8; transform: none; }

/* STATUS BUTTON VARIANTS */
button.danger { background: var(--metro-red); border-color: #991b1b; }
button.danger:hover { background: #dc2626; }
button.success { background: var(--success-green); border-color: #14532d; }
button.success:hover { background: #166534; }
button.warning { background: #d97706; color: white; border-color: #b45309; }
button.info { background: #0284c7; border-color: #0369a1; color: white; }
button.secondary { background: #64748b; border-color: #475569; color: white; }

/* INPUTS - CLEAN FORM STYLE */
input, select, textarea {
  background: #fff;
  border: 1px solid #cbd5e1;
  color: #334155;
  padding: 10px;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
  margin-bottom: 12px;
  font-size: 14px;
  transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--metro-blue);
    box-shadow: 0 0 0 2px rgba(10, 35, 66, 0.1);
}

/* LAYOUT */
section { padding: 25px; max-width: 1200px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS - CARD STYLE */
.panel {
  background: var(--panel-bg);
  padding: 30px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 25px;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}
.panel h3 { 
    margin-top: 0; 
    color: var(--metro-blue); 
    border-bottom: 1px solid #e2e8f0; 
    padding-bottom: 15px; 
    margin-bottom: 20px; 
    font-size: 1.15rem; 
    display: flex;
    align-items: center;
    gap: 10px;
}

/* NAVIGATION - TABS STYLE */
.nav-bar { 
    display: flex; 
    gap: 2px; 
    margin-bottom: 25px; 
    border-bottom: 2px solid #e2e8f0; 
    padding-bottom: 0; 
    overflow-x: auto; 
    white-space: nowrap; 
    background: #f1f5f9;
    border-radius: 6px 6px 0 0;
    padding: 5px 5px 0 5px;
}
.nav-btn { 
    background: transparent; 
    color: #64748b; 
    border: none; 
    border-radius: 6px 6px 0 0;
    padding: 12px 20px;
    font-weight: 600;
    transition: all 0.2s;
}
.nav-btn:hover {
    background: #e2e8f0;
    color: var(--metro-blue);
}
.nav-btn.active { 
    background: var(--panel-bg); 
    color: var(--metro-blue); 
    border: 1px solid #e2e8f0;
    border-bottom: 2px solid white; /* Blend with panel */
    margin-bottom: -2px; 
    box-shadow: 0 -2px 5px rgba(0,0,0,0.02);
}

/* DATA TABLES - GOVERNMENT STYLE */
.table-wrapper { 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
    border-radius: 6px; 
    border: 1px solid #e2e8f0; 
}
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; background: white; }
th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
th { 
    background: #f8fafc; 
    color: var(--metro-blue); 
    font-weight: 700; 
    text-transform: uppercase; 
    font-size: 11px; 
    letter-spacing: 0.5px; 
    border-bottom: 2px solid #e2e8f0;
}
tr:nth-child(even) { background-color: #fcfcfc; }
tr:hover { background-color: #f1f5f9; }

/* MODALS */
.modal-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(15, 23, 42, 0.85); /* Darker, more secure feel */
    backdrop-filter: blur(2px);
    display: flex; justify-content: center; align-items: center; 
    flex-direction: column; z-index: 2000; padding: 20px; box-sizing: border-box; 
}

/* CAMERA UI - HIGH TECH LOOK */
#videoContainer {
    position: relative;
    width: 320px;
    max-width: 100%;
    height: 240px;
    background: #000;
    margin-bottom: 15px;
    border: 4px solid var(--metro-slate);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}
#cameraFeed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}
#overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    transform: scaleX(-1);
}

/* UPLOAD SECTION */
.upload-panel { 
    border: 2px dashed #cbd5e1; 
    background: #f8fafc; 
    padding: 30px; 
    text-align: center; 
    border-radius: 8px; 
    margin-top: 20px; 
    transition: border-color 0.2s;
}
.upload-panel:hover { border-color: var(--metro-blue); background: #f1f5f9; }

/* ADMIN CHECKBOX LIST */
.checkbox-list {
    max-height: 200px;
    overflow-y: scroll;
    border: 1px solid #cbd5e1;
    padding: 15px;
    background: #fff;
    border-radius: 4px;
}
.checkbox-item { 
    display: block; margin-bottom: 8px; cursor: pointer; padding: 5px; border-radius: 4px;
}
.checkbox-item:hover { background: #f1f5f9; }
.checkbox-item input { width: auto; margin-right: 10px; margin-bottom: 0; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
.gallery-item { 
    border: 1px solid #e2e8f0; 
    padding: 10px; 
    border-radius: 6px; 
    text-align: center; 
    background: #fff; 
    transition: transform 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.gallery-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
.gallery-item img { max-width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #94a3b8; border: 2px solid #64748b; }
.dot.active { background: #22c55e; border-color: #16a34a; box-shadow: 0 0 8px #22c55e; }

/* STATUS BADGES */
.badge-online { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #bbf7d0; }
.badge-offline { background: #f1f5f9; color: #64748b; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid #e2e8f0; }

/* SIGNATURE CANVAS */
canvas.sig-canvas { border: 2px solid #cbd5e1; background: #fff; cursor: crosshair; touch-action: none; border-radius: 4px; display:block; max-width: 100%; }

/* NEW: BARCODE MODAL STYLES */
#reader { width: 300px; max-width: 100%; background:white; padding:15px; border-radius:8px; }

/* MOBILE RESPONSIVE TWEAKS */
@media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
    #authContainer { margin-top: 10px; align-self: flex-start; }
    .panel { padding: 15px; }
    #videoContainer { width: 100%; height: auto; aspect-ratio: 4/3; }
    .nav-bar { padding-bottom: 5px; }
    .nav-btn { font-size: 12px; padding: 10px 15px; }
    .gallery-grid { grid-template-columns: repeat(2, 1fr); }
    #otpUI { width: 90%; }
}

/* TIMELINE CARD STYLES */
.history-card {
    background: white;
    border-left: 4px solid #cbd5e1;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: relative;
    border: 1px solid #e2e8f0; border-left-width: 4px;
}
.history-card.checkout { border-left-color: #d97706; } /* Warning Orange for OUT */
.history-card.return { border-left-color: #0284c7; }   /* Info Blue for IN */
.history-card.add { border-left-color: #15803d; }      /* Green for ADD */

.hc-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
.hc-user { font-size: 14px; font-weight: bold; color: var(--metro-blue); }
.hc-meta { font-size: 11px; color: #64748b; margin-top: 4px; }

/* --- BANNED SCREEN OVERLAY --- */
.banned-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #450a0a; /* Deep Red */
    color: white;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
}

.banned-card {
    background: white;
    color: #1A202C;
    padding: 40px;
    border-radius: 12px;
    max-width: 500px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 8px solid #991b1b;
}

.banned-timer {
    font-size: 20px;
    font-weight: bold;
    color: #991b1b;
    margin: 15px 0;
    font-family: 'Courier New', monospace;
    background: #fee2e2;
    padding: 10px;
    border-radius: 4px;
}

/* ADMIN BAN MODAL */
.ban-btn-select {
    flex: 1;
    padding: 12px;
    background: #f1f5f9;
    color: #334155 !important;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
.ban-btn-select:hover { background: #e2e6ea; }
.ban-btn-select.selected {
    background: var(--metro-red);
    color: white !important;
    border-color: #991b1b;
}

/* INPUTS STYLING FOR BAN MODAL */
.ban-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 14px;
}

/* --- FULL PRINT CSS (LARGE FONTS - AUTHORITY STANDARD) --- */
@media print {
    body { visibility: hidden; background: white; margin: 0; padding: 0; }
    #printableReportContainer {
        visibility: visible;
        position: absolute;
        top: 0; left: 0; width: 100%;
        z-index: 9999;
        background: white;
    }
    #printableReportContainer * { visibility: visible; }
    .no-print { display: none !important; }

    /* A4 MODE */
    body.print-a4 .report-paper {
        width: 100%;
        padding: 40px;
        font-family: 'Times New Roman', serif;
        color: black;
        border: none;
        box-shadow: none;
    }
    body.print-a4 .report-header h2 { 
        font-size: 24pt !important; 
        text-align: center; 
        margin-bottom: 10px; 
        border-bottom: 2px solid black;
        padding-bottom: 15px;
    }
    body.print-a4 .report-meta { font-size: 14pt !important; margin-bottom: 20px; line-height: 1.5; }
    body.print-a4 .report-section-title {
        font-size: 16pt !important;
        font-weight: bold;
        background: #e5e7eb !important;
        border: 2px solid #000;
        padding: 8px;
        margin-top: 25px;
        -webkit-print-color-adjust: exact;
    }
    body.print-a4 .report-table th, 
    body.print-a4 .report-table td {
        font-size: 12pt !important;
        padding: 8px;
        border: 1px solid black;
    }

    /* POS MODE */
    body.print-pos .report-paper {
        width: 100%;
        padding: 0;
        margin: 0;
        font-family: 'Courier New', monospace;
        color: black;
    }
    body.print-pos .report-header h2 { 
        font-size: 18pt !important; 
        text-align: center; 
        font-weight: 900;
        border-bottom: 3px solid black;
        padding-bottom: 5px;
    }
    body.print-pos .report-table td { font-size: 12pt !important; border-bottom: 1px dashed #333; }
}

/* REPORT PREVIEW (SCREEN) */
.report-paper {
    background: white;
    padding: 50px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-width: 800px;
    margin: 40px auto;
    font-family: 'Times New Roman', serif;
    color: #000;
}
.report-header { text-align: center; border-bottom: 2px solid var(--metro-blue); padding-bottom: 20px; margin-bottom: 30px; }
.report-meta { display: flex; justify-content: space-between; margin-bottom: 30px; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
.report-section-title { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px; font-weight: bold; font-size: 14px; margin-top: 30px; color: var(--metro-blue); }
.report-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
.report-table th, .report-table td { border: 1px solid #cbd5e1; padding: 10px; text-align: left; }
</style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
    <div style="width:45px;height:45px;background:var(--metro-gold);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:4px;flex-shrink:0; font-size: 24px;">M</div>
    <div>
        <h1 style="margin:0; line-height:1.2; font-size: 1.3rem; letter-spacing: 0.5px;">METRO SAFETY MANAGEMENT SYSTEM</h1>
        <small style="color: #cbd5e1; font-weight: 600; text-transform: uppercase; font-size: 10px;">Official Audit & Inspection Portal</small>
    </div>
    <span id="adminBadge" class="hidden" style="background:var(--metro-red); color:white; margin-left:15px; padding:4px 10px; border-radius:12px; font-size:10px; font-weight:bold; letter-spacing: 0.5px;">SYSTEM AUDITOR</span>
  </div>
  <div id="authContainer" class="hidden">
    <span style="font-size:11px; margin-right:5px; opacity:0.7;">Logged in as:</span>
    <span id="userInfo" style="margin-right:20px; font-weight:bold; color:var(--metro-gold);"></span>
    <button class="danger" onclick="logout()" style="padding:6px 12px; font-size:11px;">TERMINATE SESSION</button>
  </div>
</header>

<section id="loginSection">
  <div class="panel" style="max-width:380px; margin: 80px auto; border-top: 6px solid var(--metro-blue); padding: 40px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
    <div style="text-align:center; margin-bottom:20px;">
        <i class="fas fa-shield-alt" style="font-size: 48px; color: var(--metro-blue);"></i>
        <h3 style="border:none; margin-top:15px; justify-content:center; padding:0;">Security Access</h3>
    </div>
    <input id="email" placeholder="Official Email ID (user@metro.gov)">
    <input id="password" type="password" placeholder="Secure Password">
    <button onclick="login()" style="width:100%; padding:12px; margin-top:15px; font-size: 14px;">VERIFY CREDENTIALS</button>
    
    <p style="font-size:11px; color:#64748b; margin-top:25px; text-align:center; line-height: 1.4;">
        <strong>RESTRICTED SYSTEM:</strong> Unauthorized access is prohibited and monitored. Use of this system constitutes consent to security monitoring and auditing.
    </p>
  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
    <div class="panel" style="width:350px; max-width:90%; text-align:center;">
        <h3><i class="fas fa-user-edit"></i> Profile Setup</h3>
        <p style="color:#475569; margin-bottom:20px;">Please enter your official name as per records.</p>
        <input id="officialNameInput" placeholder="Full Name (e.g. Rahul Roy)">
        <button onclick="saveOfficialName()" class="success" style="width:100%;">Save & Continue</button>
    </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
  <div class="panel" style="background: #1e293b; border: 1px solid #334155; color: white; width: 360px; text-align:center; padding: 20px;">
      <h2 id="modalTitle" style="color:white; margin-bottom:5px; font-size: 1.2rem;">Biometric Verification</h2>
      <p id="modalDesc" style="color:#94a3b8; margin-bottom:20px; font-size:13px;">Initializing AI Security Models...</p>
      
      <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
          <div id="dot1" class="dot"></div>
          <div id="dot2" class="dot"></div>
          <div id="dot3" class="dot"></div>
      </div>

      <div id="videoContainer" style="margin: 0 auto 20px auto;">
        <video id="cameraFeed" autoplay playsinline muted></video>
        <canvas id="overlayCanvas"></canvas>
      </div>
      
      <div id="otpUI" class="hidden" style="background:white; padding:25px; border-radius:8px; width:280px; position:absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index:20; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
        <h3 style="color:var(--metro-red); margin-top:0; border-bottom: none;"><i class="fas fa-exclamation-triangle"></i> Verification Failed</h3>
        <p style="color:#333; font-size:13px; margin-bottom: 15px;">Biometric lockout active.<br>Enter Security PIN:</p>
        <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:20px; letter-spacing:8px; border:2px solid var(--metro-red); font-weight: bold;">
        <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
      </div>

      <div id="faceStatus" style="color:var(--metro-gold); margin-bottom:15px; font-weight:bold; height:20px; font-size: 12px; letter-spacing: 0.5px;"></div>
      
      <div id="camControls" style="display:flex; gap:10px; justify-content: center;">
        <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:var(--metro-blue); border:none; padding:12px 25px; font-weight: bold;">üì∏ SCAN FACE</button>
      </div>
  </div>
</div>

<div id="barcodeModal" class="modal-overlay hidden">
    <div class="panel" style="width:360px; max-width:95%; text-align:center; background:#0f172a; border:2px solid var(--metro-gold); padding: 20px;">
        <h3 style="color:white; margin-bottom:15px; border-bottom-color: #334155;"><i class="fas fa-qrcode"></i> Scan Asset Tag</h3>
        <div id="reader" style="border-radius: 8px; overflow: hidden;"></div>
        <button class="danger" onclick="closeBarcodeScanner()" style="margin-top:20px; width:100%;">CANCEL SCAN</button>
    </div>
</div>

<div id="sigModal" class="modal-overlay hidden" onclick="closeSigModal()">
    <div class="panel" style="text-align:center; min-width:300px; max-width:90%;" onclick="event.stopPropagation()">
        <h3>Digital Signature Record</h3>
        <img id="modalSigImage" src="" style="border:1px solid #e2e8f0; background:white; max-width:100%; margin:15px 0; padding: 10px;">
        <br>
        <button onclick="closeSigModal()" class="secondary">Close Viewer</button>
    </div>
</div>

<section id="appScreen" class="hidden">
  
  <div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew"><i class="fas fa-ruler-combined"></i> Field Inspection</button>
    <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory"><i class="fas fa-boxes"></i> Asset Tracking</button>
    <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery"><i class="fas fa-folder-open"></i> Compliance Docs</button>
    <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign"><i class="fas fa-tasks"></i> Operation Tasks</button>
    <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="color:var(--metro-red); border-color: var(--metro-red);"><i class="fas fa-user-shield"></i> System Oversight</button>
    <button class="nav-btn" onclick="switchTab('dataView')" id="btnDataView"><i class="fas fa-database"></i> Master Logs</button>
    <button class="nav-btn" onclick="switchTab('printReport')" id="btnPrintReport"><i class="fas fa-print"></i> Audit Reports</button>
  </div>

<div id="tab-newData">
  <div class="panel">
    <h3><i class="fas fa-map-marker-alt"></i> Select Inspection Site</h3>
    <label style="font-weight:700; color:var(--metro-blue); font-size: 12px; text-transform: uppercase;">Step 1: Select Corridor</label>
    <select id="lineSelect" onchange="handleLineChange()" style="border:2px solid var(--metro-blue); font-weight:600;">
      <option value="">-- Select Line --</option>
      <option value="Blue Line">Blue Line (North-South: Dakshineswar ‚Üî New Garia)</option>
      <option value="Green Line">Green Line (East-West: Sector V ‚Üî Howrah Maidan)</option>
      <option value="Purple Line">Purple Line (Joka ‚Üî Majerhat)</option>
      <option value="Yellow Line">Yellow Line (Noapara ‚Üî Airport)</option>
      <option value="Orange Line">Orange Line (New Garia ‚Üî Airport)</option>
      <option value="Pink Line">Pink Line (Baranagar ‚Üî Barrackpore)</option>
    </select>

    <label style="font-weight:700; color:var(--metro-blue); margin-top:15px; display:block; font-size: 12px; text-transform: uppercase;">Step 2: Select Station</label>
    <select id="stationSelect" onchange="handleStationChange()" disabled style="background:#f1f5f9;">
      <option value="">-- First Select a Corridor --</option>
    </select>
  </div>

  <div id="mainDataForm" class="hidden">
    
    <div id="dataExistsWarning" class="hidden" style="background:#fff7ed; color:#9a3412; padding:15px; border:1px solid #fed7aa; border-radius:6px; margin-bottom:20px; display: flex; gap: 10px; align-items: center;">
        <i class="fas fa-exclamation-circle" style="font-size: 20px;"></i>
        <div>
            <strong>Existing Record Found</strong><br>
            Primary measurement data is locked. You may append additional rake data below.
        </div>
    </div>

    <div class="panel" id="stationDetailsPanel" style="border-left: 4px solid var(--success-green);">
      <h3 id="formTitle">üìù Yellow Line Specification</h3>
      <input id="inpStationName" type="hidden"> 
      
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:20px; margin-bottom: 20px;">
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">PLATFORM LENGTH (m)</label>
            <input id="inpStationLength" placeholder="e.g. 180">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">YL DISTANCE (cm)</label>
            <input id="inpYellowDist" placeholder="e.g. 85">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:#64748b;">YL THICKNESS (cm)</label>
            <input id="inpYellowThick" placeholder="e.g. 10">
          </div>
          <div>
            <label style="font-size:11px; font-weight:bold; color:var(--metro-blue);">IMPLEMENTATION STATUS</label>
            <select id="inpImplementation" style="font-weight:bold; border:2px solid var(--metro-blue);">
                <option value="">-- Select Status --</option>
                <option value="YES">‚úÖ COMPLIANT (YES)</option>
                <option value="NO">‚ùå NON-COMPLIANT (NO)</option>
            </select>
          </div>
      </div>
      <label style="font-size:11px; font-weight:bold; color:#64748b;">INSPECTOR REMARKS</label>
      <textarea id="inpRemarks" placeholder="Observations regarding safety compliance..." rows="3"></textarea>
      
      <div style="text-align:right; margin-top: 15px;">
          <button class="secondary" id="btnSaveDraft" onclick="saveStationDetails()"><i class="fas fa-save"></i> Save Draft</button>
      </div>
    </div>

   <div class="panel">
    <h4><i class="fas fa-train"></i> Rake Clearance Data</h4>
    
    <div class="table-wrapper" style="margin-top:15px;">
        <table style="width:100%">
            <thead>
                <tr>
                    <th style="width:50px; text-align:center;">#</th>
                    <th>Rake ID</th>
                    <th>Rake Series</th>
                    <th>Front Clearance (mm)</th>
                    <th>Rear Clearance (mm)</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="distanceBody"></tbody>
        </table>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:space-between; align-items: center;">
        <button class="info" onclick="addDistanceRow()">+ Add Measurement Row</button>
        
        <button onclick="submitStationData()" id="btnFinalSubmit" class="success" style="padding: 12px 24px;">
            <i class="fas fa-check-circle"></i> SUBMIT FINAL REPORT
        </button>
    </div>
   </div>

  </div> 
</div>

<div id="tab-inventory" class="hidden">
    
    <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap; padding: 10px; background: #e2e8f0; border-radius: 6px;">
        <button onclick="toggleInvMode('list')" class="info"><i class="fas fa-list"></i> View Stock</button>
        <button onclick="toggleInvMode('add')" class="success"><i class="fas fa-plus"></i> New Asset</button>
        <button onclick="toggleInvMode('checkout')" class="warning"><i class="fas fa-sign-out-alt"></i> Checkout</button>
        <button onclick="toggleInvMode('return')" class="info" style="background:var(--metro-blue); border-color:var(--metro-blue);"><i class="fas fa-sign-in-alt"></i> Return</button>
        <button onclick="toggleInvMode('history')" class="secondary"><i class="fas fa-history"></i> Audit Trail</button>
    </div>

<div id="inv-add" class="panel hidden" style="border-top: 4px solid var(--success-green);">
    <h3 style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> Register New Asset</h3>
    <p style="font-size:12px; color:#64748b; margin-bottom: 20px;">
        <strong>Protocol:</strong> Every physical asset must be serialized. Scan unique barcode to verify database availability.
    </p>
      
    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:15px;">
        <div style="display:flex; gap:5px;">
            <input id="invBarcode" placeholder="Scan Unique Asset Tag / Barcode" onchange="checkBarcodeUnique(this.value)">
            <button onclick="openBarcodeScanner('ADD')" class="secondary" style="width:60px; padding:0;"><i class="fas fa-qrcode"></i></button>
        </div>
        <input id="invName" placeholder="Asset Name (e.g. Hilti Drill X4)">
    </div>
      
    <div id="barcodeError" class="hidden" style="background:#fee2e2; color:#991b1b; padding:12px; border-radius:4px; margin-bottom:15px; font-weight: bold; border: 1px solid #fecaca;">
        <i class="fas fa-ban"></i> Error: Duplicate Barcode Detected.
    </div>

    <div style="text-align:left; background:#f8fafc; padding:20px; border:1px solid #e2e8f0; border-radius:6px; margin-bottom:20px;">
        
        <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase;">Storage Facility</label>
        <select id="addLocSelect" onchange="toggleAddOtherInput()" style="margin-bottom:10px;">
            <option value="D2 Building - Heerok Sir Lab">D2 Building - Central Lab</option>
            <option value="Other">Other (Specify...)</option>
        </select>

        <div id="divAddOtherLoc" class="hidden">
            <input id="addLocOther" placeholder="Specify Facility Name" style="background:white;">
        </div>

        <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase; margin-top: 10px; display: block;">Storage Unit / Rack</label>
        <input id="addLocSpot" placeholder="e.g. Cabinet A, Shelf 2">
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <select id="invCondition">
            <option value="New">Condition: New</option>
            <option value="Good" selected>Condition: Good</option>
            <option value="Fair">Condition: Fair</option>
            <option value="Damaged">Condition: Damaged</option>
        </select>
        <button id="btnAddStock" onclick="addUniqueItem()" class="success">REGISTER ASSET</button>
    </div>
</div><div id="inv-checkout" class="panel hidden" style="border-top: 4px solid #d97706;">
    <h3 style="color:#d97706;"><i class="fas fa-sign-out-alt"></i> Asset Checkout Protocol</h3>
    <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
        Scan asset barcode to initiate checkout sequence.
    </p>
    
    <div style="text-align:center; padding:20px; background: #fff7ed; border-radius: 8px;">
        <button onclick="openBarcodeScanner('CHECKOUT')" class="warning" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px;">
            <i class="fas fa-qrcode"></i> INITIATE SCAN
        </button>
    </div>

    <div id="checkout_display" class="hidden" style="background:#fffbeb; padding:25px; border:1px solid #fcd34d; text-align:center; margin-top:20px; border-radius:6px;">
        <h2 id="checkout_item_name" style="color:#92400e; margin:0 0 10px 0;">--</h2>
        <div style="font-family:'Courier New', monospace; font-size:14px; color:#78350f; margin-bottom:20px;">
            ID: <span id="checkout_item_code" style="font-weight:bold;">--</span>
        </div>
        
        <label style="display:block; text-align:left; font-size:11px; font-weight:bold; color:#92400e; margin-bottom: 5px;">PURPOSE OF USAGE</label>
        <input id="checkoutPurpose" placeholder="e.g. Scheduled Maintenance, Testing" style="border-color: #f59e0b;">

        <div id="btn_checkout_verify" style="margin-top: 15px;">
             <button onclick="submitTransactionNoFace('CHECKOUT')" style="background:#d97706; border:none; width:100%;">
                CONFIRM WITHDRAWAL
             </button>
        </div>
    </div>
</div>

<div id="inv-return" class="panel hidden" style="border-top: 4px solid var(--metro-blue);">
    <h3 style="color:var(--metro-blue);"><i class="fas fa-undo"></i> Asset Return Protocol</h3>
    <p style="text-align:center; color:#64748b; font-size:13px; margin-bottom: 25px;">
        Scan asset barcode to verify return and update inventory location.
    </p>
    
    <div style="text-align:center; padding:20px; background: #f0f9ff; border-radius: 8px;">
        <button onclick="openBarcodeScanner('RETURN')" class="info" style="font-size:14px; padding:15px 30px; width:100%; max-width: 300px; background: var(--metro-blue); border-color: var(--metro-blue);">
            <i class="fas fa-qrcode"></i> INITIATE RETURN SCAN
        </button>
    </div>

    <div id="return_display" class="hidden" style="background:#f1f5f9; padding:25px; border:1px solid #cbd5e1; text-align:center; margin-top:20px; border-radius:6px;">
        
        <h2 id="return_item_name" style="color:var(--metro-blue); margin:0 0 10px 0;">--</h2>
        <div style="font-family:'Courier New', monospace; font-size:14px; color:#475569; margin-bottom:20px;">
            ID: <span id="return_item_code" style="font-weight:bold;">--</span>
        </div>

        <div style="text-align:left; background:white; padding:15px; border-radius:6px; border: 1px solid #e2e8f0;">
            
            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase;">Return Facility</label>
            <select id="returnLocSelect" onchange="toggleOtherInput()" style="margin-bottom:10px;">
                <option value="D2 Building - Heerok Sir Lab">D2 Building - Central Lab</option>
                <option value="Other">Other (Specify...)</option>
            </select>

            <div id="divOtherLoc" class="hidden">
                <input id="returnLocOther" placeholder="Specify Facility Name">
            </div>

            <label style="font-size:11px; font-weight:bold; color:#64748b; text-transform: uppercase; margin-top: 10px; display: block;">Storage Unit / Rack</label>
            <input id="returnLocSpot" placeholder="e.g. Cabinet A, Shelf 2">
        </div>

        <div id="btn_return_verify" style="margin-top:20px;">
             <button onclick="submitTransactionNoFace('RETURN')" class="info" style="width:100%; background: var(--metro-blue);">
                CONFIRM RETURN
             </button>
        </div>
    </div>
</div>

<div id="inv-history" class="panel hidden">
    <div style="text-align:center; padding:40px 20px;">
        <h2 style="color:var(--metro-blue); margin-bottom:10px;">Asset Audit Trail</h2>
        <p style="color:#64748b; margin-bottom:20px;">Scan barcode to retrieve complete lifecycle history.</p>
        
        <div style="max-width:400px; margin:0 auto; display:flex; gap:10px;">
            <input 
                id="auditSearchInput" 
                placeholder="Scan or Enter Asset Tag..." 
                style="padding:12px; font-size:16px; border:2px solid var(--metro-blue); flex-grow:1;"
                onchange="fetchAuditHistory(this.value)"
            >
            <button 
                onclick="openBarcodeScanner('AUDIT_SEARCH')" 
                class="warning" 
                style="padding:12px 20px; font-size:18px;"
            >
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>
</div>

<div id="auditResultModal" class="modal-overlay hidden">
    <div class="panel" style="width:450px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; background:#f8fafc; border: none;">
        
        <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h3 style="margin:0; font-size:16px; border:none; color:white; padding:0;">Asset Lifecycle</h3>
                <small id="auditModalBarcode" style="opacity:0.8; font-family:'Courier New', monospace;">--</small>
            </div>
            <button onclick="closeAuditModal()" style="background:transparent; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div id="auditTimelineContainer" style="overflow-y:auto; padding:20px; flex-grow:1;">
            <div style="text-align:center; color:#64748b;">Retrieving records...</div>
        </div>

    </div>
</div>

<div id="inv-list" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #e2e8f0; padding-bottom:15px; margin-bottom:15px;">
        <div>
            <h3 style="margin:0; border:none; padding:0;">Current Inventory</h3>
            <small id="stockSummaryText" style="color:var(--metro-blue); font-weight:bold;">Syncing Database...</small>
        </div>
        
        <div style="display:flex; gap:10px;">
            <input type="text" id="mainStockSearch" onkeyup="filterStockTable()" placeholder="Search Assets..." style="width:250px; margin:0;">
            <button onclick="openBarcodeScanner('SEARCH_STOCK')" class="secondary" title="Scan to Search">
                <i class="fas fa-qrcode"></i>
            </button>
        </div>
    </div>

    <div class="table-wrapper" style="max-height:600px; overflow-y:auto;">
        <table>
            <thead style="position:sticky; top:0;">
                <tr>
                    <th>Tag ID</th>
                    <th>Asset Name</th>
                    <th>Registrar</th>
                    <th>Cycle Count</th>
                    <th>Custodian</th>
                    <th>Location</th> 
                    <th>Status</th>
                    <th>Controls</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>
    </div>
</div>

</div> <div id="tab-gallery" class="hidden">
  
  <div class="panel">
    <h3><i class="fas fa-camera"></i> Documentation & Evidence</h3>
    
    <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px; text-transform: uppercase;">Step 1: Corridor</label>
    <select id="galleryLineSelect" onchange="handleGalleryLineChange()" style="background:#f8fafc; font-weight:bold; border:1px solid #cbd5e1;">
      <option value="">-- Select Line --</option>
      <option value="Blue Line">Blue Line</option>
      <option value="Green Line">Green Line</option>
      <option value="Purple Line">Purple Line</option>
      <option value="Yellow Line">Yellow Line</option>
      <option value="Orange Line">Orange Line</option>
      <option value="Pink Line">Pink Line</option>
    </select>

    <label style="font-weight:bold; color:var(--metro-blue); margin-top:15px; display:block; font-size: 11px; text-transform: uppercase;">Step 2: Station</label>
    <select id="galleryStationSelect" onchange="handleGalleryStationChange()" disabled style="background:#f1f5f9;">
      <option value="">-- Select Line First --</option>
    </select>
  </div>

  <div id="galleryUploadSection" class="hidden">
      <div class="panel upload-panel">
        <h3 style="color:var(--metro-blue); margin-top:0; border:none; justify-content:center;"><i class="fas fa-cloud-upload-alt"></i> Upload Evidence</h3>
        <p id="uploadTargetText" style="font-weight:bold; color:var(--success-green);">Target: None</p>
        <p style="font-size:12px; color:#64748b;">Supported Formats: JPG, PNG, PDF (Max 1.5MB)</p>
        
        <input type="file" id="evidenceFile" accept="image/*,application/pdf" onchange="handleFileUpload()" style="max-width:300px;">
        <div id="fileStatus" style="font-size:13px; color:var(--success-green); font-weight:bold; margin:15px 0;"></div>
        
        <button class="info" onclick="uploadEvidenceOnly()">UPLOAD TO SERVER</button>
      </div>

      <div class="panel">
        <h3><i class="fas fa-archive"></i> Digital Repository</h3>
        <div id="galleryContainer" class="gallery-grid"></div>
      </div>
  </div>
</div>

<div id="tab-assigned" class="hidden">
    <div class="panel"><h3><i class="fas fa-clipboard-check"></i> Assigned Operations</h3><div id="taskList"></div></div>
</div>

<div id="tab-adminPanel" class="hidden">
    <div class="panel" style="border-top: 5px solid var(--metro-red);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="color:var(--metro-red);"><i class="fas fa-shield-alt"></i> System Oversight Console</h3>
        <button onclick="loadAdminPanel()" class="secondary"><i class="fas fa-sync"></i> Refresh Data</button>
      </div>

      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 20px;">1. Personnel Status & Security</h4>
      <div class="table-wrapper">
      <table>
          <thead>
              <tr>
                  <th>User Profile</th>
                  <th>Connection</th>
                  <th>Task Load</th>
                  <th>Biometrics</th>
                  <th>Admin Actions</th>
              </tr>
          </thead>
          <tbody id="userListBody"></tbody>
      </table>
      </div>
      
      <h4 style="background:#f1f5f9; padding:10px; border-left: 3px solid var(--metro-blue); margin-top: 30px;">2. Task Assignment</h4>
      <label style="font-size: 12px; font-weight: bold;">Select Personnel:</label>
      <div id="userCheckboxList" class="checkbox-list"></div>
      <div style="margin-top:15px;">
        <textarea id="taskDesc" rows="2" placeholder="Enter detailed operational instructions..."></textarea>
        <button onclick="assignTaskMulti()" style="width:100%; margin-top:10px;">Dispatch Orders</button>
      </div>
    </div>
</div>

<div id="adminTaskModal" class="modal-overlay hidden">
    <div class="panel" style="width:600px; max-width:95%; max-height:80vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
        <div style="background:var(--metro-blue); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:white; border:none; padding:0;">Task Log: <span id="modalTaskUserName">User</span></h3>
            <button class="danger" onclick="closeTaskModal()" style="padding:4px 10px; font-size:12px;">CLOSE</button>
        </div>
        
        <div style="overflow-y:auto; flex-grow:1; background:#f8fafc; padding: 20px;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Control</th>
                        </tr>
                    </thead>
                    <tbody id="adminTaskBody">
                        <tr><td colspan="4" style="text-align:center;">Retrieving...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="bannedScreen" class="banned-overlay hidden">
    <div class="banned-card">
        <h1 style="color:#991b1b; margin:0; font-size: 32px; letter-spacing: 2px;">ACCESS DENIED</h1>
        <p style="color:#333; margin-top: 10px;">Security protocols have suspended this account.</p>
        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 20px 0;">
        <div id="displayBanReason" style="font-weight:bold; font-size: 18px; color: #1f2937;">--</div>
        <div id="bannedTimeDisplay" class="banned-timer">--</div>
        <div style="margin-top:30px;">
            <button onclick="logout()" style="background:#991b1b; color:white; padding:15px 30px; font-size: 16px; border:none; border-radius: 6px;">FORCE LOGOUT</button>
        </div>
    </div>
</div>

<div id="adminBanModal" class="modal-overlay hidden">
    <div class="panel" style="width:500px; max-width:95%; border-top: 6px solid var(--metro-red);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="color:var(--metro-red); margin:0; border:none; padding:0;">‚õî Suspend User Access</h3>
            <button onclick="closeBanModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#64748b;">&times;</button>
        </div>
        
        <p style="background:#fee2e2; padding:15px; border-radius:6px; color:#991b1b; margin-bottom:20px; font-weight: bold; border: 1px solid #fecaca;">
            Target: <span id="banTargetName">User</span>
        </p>

        <label style="font-weight:bold; display:block; font-size: 12px; margin-bottom: 5px;">1. Violation Category</label>
        <select id="banReasonInput" class="ban-input" onchange="toggleBanOtherInput()">
            <option value="Misconduct">Code of Conduct Violation</option>
            <option value="Security Violation">Security Protocol Breach</option>
            <option value="Asset Damage">Asset Mishandling / Damage</option>
            <option value="Attendance">Attendance Irregularity</option>
            <option value="Pending Investigation">Pending Internal Investigation</option>
            <option value="Other">Other (Specify)</option>
        </select>

        <div id="divBanOther" class="hidden">
            <input id="banReasonOther" class="ban-input" placeholder="Specify Details..." style="border-left: 4px solid var(--metro-red);">
        </div>

        <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">2. Remedial Action Required</label>
        <input id="banActionInput" class="ban-input" placeholder="e.g. Report to HR, Submit Incident Report...">

        <label style="font-weight:bold; display:block; margin-top:15px; font-size: 12px; margin-bottom: 5px;">3. Suspension Duration</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <button class="ban-btn-select" onclick="selectBanDuration(1, this)">24 Hours</button>
            <button class="ban-btn-select" onclick="selectBanDuration(3, this)">3 Days</button>
            <button class="ban-btn-select" onclick="selectBanDuration(7, this)">1 Week</button>
            <input type="date" id="banCustomDate" class="ban-input" style="margin:0; height:100%; text-align:center;" onchange="selectBanCustomDate(this)">
        </div>
        
        <label style="font-weight:bold; display:block; margin-top: 15px; font-size: 12px; margin-bottom: 5px;">4. Administrative Remarks</label>
        <textarea id="banRemarks" rows="2" class="ban-input" placeholder="Internal notes..."></textarea>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button onclick="closeBanModal()" class="secondary">Cancel</button>
            <button onclick="submitBan()" class="danger" style="font-weight:bold; padding: 10px 20px;">CONFIRM SUSPENSION</button>
        </div>
    </div>
</div>

<div id="tab-dataView" class="hidden">
  
  <div class="panel">
    <h3><i class="fas fa-database"></i> Master Log Database</h3>
    <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Corridor</label>
    <select id="logLineSelect" onchange="handleLogLineChange()" style="border:1px solid #cbd5e1;">
      <option value="">-- Select Line --</option>
      <option value="Blue Line">Blue Line</option>
      <option value="Green Line">Green Line</option>
      <option value="Purple Line">Purple Line</option>
      <option value="Yellow Line">Yellow Line</option>
      <option value="Orange Line">Orange Line</option>
      <option value="Pink Line">Pink Line</option>
    </select>

    <label style="font-weight:bold; color:var(--metro-blue); margin-top:15px; display:block; font-size: 11px;">Station</label>
    <select id="logStationSelect" onchange="loadSpecificStationData()" disabled style="background:#f1f5f9;">
      <option value="">-- Select Line First --</option>
    </select>
  </div>

  <div id="logResultsPanel" class="hidden">
    
    <div class="panel" style="border-left: 4px solid var(--metro-blue);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <h4 style="margin:0; color:var(--metro-blue);">üìä Station Measurement Records</h4>
          <button onclick="loadSpecificStationData()" class="info" style="font-size:11px; padding: 6px 12px;"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      <div class="table-wrapper" style="margin-top:15px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Inspector</th>
              <th>Length</th>
              <th>Dist</th>
              <th>Thick</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Control</th>
            </tr>
          </thead>
          <tbody id="viewTable1Body">
            <tr><td colspan="8" style="text-align:center;">Select parameters to view data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="panel" style="border-left: 4px solid var(--success-green);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
      <h4 style="margin:0; color:var(--success-green);">üöÜ Rake Clearance Data</h4>
      <button id="btnDeleteAllRakes" class="danger" style="padding:4px 10px; font-size:11px; display:none;" onclick="triggerDeleteAll()">Purge All Rake Data</button>
    </div>
      <div class="table-wrapper" style="margin-top:15px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Rake ID</th>
              <th>Series</th>
              <th>Front</th>
              <th>Rear</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="viewTable2Body">
            <tr><td colspan="6" style="text-align:center;">...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<div id="rakeDataModal" class="modal-overlay hidden">
    <div class="panel" style="width:700px; max-width:95%; max-height:85vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--metro-blue); color:white; padding:15px 20px;">
            <h3 style="margin:0; color:white; border:none; padding:0;">Rake Clearance Table</h3>
            <button class="danger" onclick="closeRakeModal()" style="font-size:12px; padding: 5px 10px;">CLOSE</button>
        </div>
        
        <div class="table-wrapper" style="overflow-y:auto; flex-grow:1; padding: 20px; background: #f8fafc;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>RAKE NO</th>
                        <th>TYPE</th>
                        <th>FRONT</th>
                        <th>REAR</th>
                        <th>ACT</th>
                    </tr>
                </thead>
                <tbody id="modalRakeBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="tab-printReport" class="hidden">
    <div class="panel">
        <h3><i class="fas fa-print"></i> Report Generation Center</h3>
        
        <div style="background:#f1f5f9; padding:20px; border-radius:6px; border:1px solid #cbd5e1;">
            <label style="font-weight:bold; color:var(--metro-blue); font-size: 11px;">Select Inspection Site:</label>
            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
                <select id="printLineSelect" onchange="handlePrintLineChange()" style="flex:1;">
                    <option value="">-- Select Line --</option>
                    <option value="Blue Line">Blue Line</option>
                    <option value="Green Line">Green Line</option>
                    <option value="Purple Line">Purple Line</option>
                    <option value="Yellow Line">Yellow Line</option>
                    <option value="Orange Line">Orange Line</option>
                    <option value="Pink Line">Pink Line</option>
                </select>
                <select id="printStationSelect" onchange="fetchLogsForPrint()" disabled style="flex:1;">
                    <option value="">-- Select Line First --</option>
                </select>
            </div>
        </div>

        <div id="printLogList" class="hidden" style="margin-top:25px;">
            <h4>Available Inspection Records:</h4>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Station</th>
                            <th>Inspector</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="printLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="printOptionsModal" class="modal-overlay hidden">
    <div class="panel" style="width:450px; max-width:95%;">
        <h3 style="color:var(--metro-blue); border-bottom:1px solid #e2e8f0; padding-bottom:15px; margin-top:0;">Configure Audit Report</h3>
        
        <p style="margin-bottom:20px; background: #f1f5f9; padding: 10px; border-radius: 4px;"><strong>Record Date:</strong> <span id="modalPrintDate" style="color:var(--metro-blue); font-weight:bold;">--</span></p>

        <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">1. Data Sections to Include:</label>
        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
                <input type="checkbox" id="chkStationDetails" checked> 
                Measurement Data
            </label>
            <label class="checkbox-item" style="flex:1; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px;">
                <input type="checkbox" id="chkRakeData" checked> 
                Clearance Data
            </label>
        </div>

        <label style="font-weight:bold; display:block; color:var(--metro-blue); font-size: 12px; margin-bottom: 5px;">2. Authorization Signatories:</label>
        
        <div style="margin-bottom:15px;">
            <small style="color: #64748b;">Conducting Officer:</small>
            <select id="selPrintInspector" style="margin-top: 5px;">
                <option value="">Loading...</option>
            </select>
        </div>

        <div style="margin-bottom:25px;">
            <small style="color: #64748b;">Approving Authority:</small>
            <select id="selPrintAuthority" style="margin-top: 5px; border-color: var(--metro-gold); background: #fffbeb;">
                <option value="">-- Select Authority --</option>
                <option value="Soham Pal (Principal Investigator)">Soham Pal (Principal Investigator)</option>
                <option value="Prof. Heerok Banerjee (Co-Principal Investigator)">Prof. Heerok Banerjee (Co-Principal Investigator)</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; border-top:1px solid #e2e8f0; padding-top:20px;">
            <button class="secondary" onclick="closePrintModal()" style="flex:1;">Cancel</button>
            <button class="info" onclick="generateFinalReport()" style="flex:2;">GENERATE REPORT</button>
        </div>
    </div>
</div>

<div id="printableReportContainer" class="hidden">
    <div class="no-print" style="text-align:center; margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding:15px; background:#f8fafc;">
        <h3 style="margin:0 0 15px 0; color: var(--metro-blue);">Report Preview</h3>
        
        <button class="danger" onclick="closeReportPreview()" style="margin-right:20px;">CLOSE PREVIEW</button>

        <button onclick="printReport('A4')" style="background:var(--metro-blue); color:white; margin-right:10px;">
            <i class="fas fa-file-pdf"></i> PRINT STANDARD (A4)
        </button>

        <button onclick="printReport('POS')" style="background:#1e293b; color:white;">
            <i class="fas fa-receipt"></i> PRINT RECEIPT
        </button>
    </div>

    <div class="report-paper">
        <div class="report-header">
            <h2 style="margin:0; text-transform:uppercase; color:var(--metro-blue);">METRO RAILWAY SAFETY</h2>
            <small style="letter-spacing: 2px; font-weight:bold; text-transform: uppercase;">Official Inspection Record</small>
        </div>

        <div class="report-meta">
            <div>
                <strong>Site:</strong> <span id="rptStationName">--</span><br>
                <strong>Corridor:</strong> <span id="rptLineName">--</span>
            </div>
            <div style="text-align:right;">
                <strong>Date:</strong> <span id="rptDate">--</span><br>
                <strong>Inspector:</strong> <span id="rptUser">--</span>
            </div>
        </div>

        <div id="sectionStationDetails">
            <div class="report-section-title">A. YELLOW LINE COMPLIANCE</div>
            <table class="report-table">
                <tr>
                    <td style="background:#f8fafc; width:40%; font-weight: bold;">Platform Length</td>
                    <td id="rptLen">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">YL Distance</td>
                    <td id="rptYl">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">YL Thickness</td>
                    <td id="rptTh">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">Compliance Status</td>
                    <td id="rptStatus">--</td>
                </tr>
                <tr>
                    <td style="background:#f8fafc; font-weight: bold;">Remarks</td>
                    <td id="rptRem">--</td>
                </tr>
            </table>
        </div>

        <div id="sectionRakeData" style="margin-top:20px;">
            <div class="report-section-title">B. RAKE CLEARANCE DATA</div>
            <table class="report-table">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="width:30px;">#</th>
                        <th>Rake ID</th>
                        <th>Type</th>
                        <th>Front</th>
                        <th>Rear</th>
                    </tr>
                </thead>
                <tbody id="rptRakeBody"></tbody>
            </table>
        </div>

        <div class="report-footer" style="margin-top:60px; display:flex; justify-content:space-between; page-break-inside: avoid;">
            <div style="text-align:center; min-width:180px;">
                <p style="margin-bottom:5px;">_______________________</p>
                <div id="rptSigInspectorName" style="font-weight:bold; font-size:12px;">--</div>
                <small style="text-transform: uppercase; color: #64748b;">Conducting Officer</small>
            </div>

            <div style="text-align:center; min-width:180px;">
                <p style="margin-bottom:5px;">_______________________</p>
                <div id="rptSigAuthName" style="font-weight:bold; font-size:12px;">--</div>
                <small style="text-transform: uppercase; color: #64748b;">Approving Authority</small>
            </div>
        </div>
    </div>
</div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// YOUR EXACT FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
  authDomain: "metro-railway-project.firebaseapp.com",
  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// GLOBAL VARIABLES
let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project", "sujoy@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];
let modelsLoaded = false;
let isTransactionAuth = false;
let currentTransactionType = "";
let scanMode = 'LOGIN';
let receiverVerified = false;
let detectionLoop;
let currentDescriptor = null;
let pendingTransactionItem = null;
let scanner = null;
