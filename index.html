<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metro Railway Safety System | Official Portal</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- OFFICIAL METRO THEME --- */
:root {
Â  --metro-blue: #003366;
Â  --metro-gold: #b38600;
Â  --metro-red: #e31e24;
Â  --bg-color: #f4f6f9;
Â  --panel-bg: #ffffff;
Â  --text-main: #212529;
Â  --border-color: #d1d5db;
}

body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-main); font-size: 14px; }

/* HEADER */
header {
Â  background: var(--metro-blue);
Â  color: white;
Â  padding: 15px 25px;
Â  border-bottom: 4px solid #b38600;
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  position: relative; z-index: 1001;
}

/* BUTTONS */
button {
Â  padding: 8px 16px;
Â  cursor: pointer;
Â  background: #0056b3;
Â  color: white;
Â  border: 1px solid #004494;
Â  border-radius: 3px;
Â  font-weight: bold;
Â  font-size: 13px;
Â  transition: all 0.2s;
}
button:hover { background: #004494; }
button:disabled { background: #6c757d; cursor: not-allowed; border-color: #6c757d; opacity: 0.7; }
button.danger { background: #dc3545; border-color: #bd2130; }
button.success { background: #28a745; border-color: #1e7e34; }
button.warning { background: #ffc107; color: black; border-color: #d39e00; }

/* INPUTS */
input, select, textarea {
Â  background: #fff;
Â  border: 1px solid #ced4da;
Â  color: #495057;
Â  padding: 8px;
Â  border-radius: 3px;
Â  width: 100%;
Â  box-sizing: border-box;
Â  margin-bottom: 10px;
Â  font-size: 14px;
}

/* LAYOUT */
section { padding: 20px; max-width: 1100px; margin: 0 auto; }
.hidden { display: none !important; }

/* PANELS */
.panel {
Â  background: var(--panel-bg);
Â  padding: 25px;
Â  border: 1px solid var(--border-color);
Â  border-radius: 4px;
Â  margin-bottom: 20px;
Â  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.panel h3 { margin-top: 0; color: var(--metro-blue); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.1rem; }

/* NAVIGATION */
.nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; overflow-x: auto; }
.nav-btn { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; white-space: nowrap; }
.nav-btn.active { background: var(--metro-blue); color: white; border-color: var(--metro-blue); }

/* TABLES */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
th { background: #e9ecef; color: #212529; font-weight: bold; text-transform: uppercase; font-size: 12px; }
tr:nth-child(even) { background-color: #f8f9fa; }

/* MODALS */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 2000; }

/* NEW HIGH PERFORMANCE CAMERA UI */
#videoContainer {Â 
Â  Â  position: relative;Â 
Â  Â  width: 320px;Â 
Â  Â  height: 240px;Â 
Â  Â  background: #000;Â 
Â  Â  margin-bottom: 15px;Â 
Â  Â  border: 5px solid white;Â 
Â  Â  box-shadow: 0 0 20px rgba(0,255,0,0.2);
}
#cameraFeed {Â 
Â  Â  width: 100%;Â 
Â  Â  height: 100%;Â 
Â  Â  object-fit: cover;Â 
Â  Â  transform: scaleX(-1); /* Mirror effect */
}
#overlayCanvas {Â 
Â  Â  position: absolute;Â 
Â  Â  top: 0;Â 
Â  Â  left: 0;Â 
Â  Â  width: 100%;Â 
Â  Â  height: 100%;Â 
Â  Â  z-index: 10;Â 
Â  Â  transform: scaleX(-1); /* Mirror overlay to match video */
}

/* UPLOAD SECTION SPECIFIC */
.upload-panel { border: 2px dashed #003366; background: #eef2f7; padding: 20px; text-align: center; border-radius: 6px; margin-top: 20px; }

/* CHECKBOX LIST FOR ADMIN */
.checkbox-list {
Â  Â  max-height: 200px;
Â  Â  overflow-y: scroll;
Â  Â  border: 1px solid #ced4da;
Â  Â  padding: 10px;
Â  Â  background: #fff;
Â  Â  text-align: left;
}
.checkbox-item { display: block; margin-bottom: 5px; cursor: pointer; }
.checkbox-item input { width: auto; margin-right: 10px; }

/* GALLERY GRID */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
.gallery-item { border: 1px solid #ddd; padding: 10px; border-radius: 4px; text-align: center; background: #fff; }
.gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }

/* REGISTRATION DOTS */
.step-dots { display: flex; gap: 10px; margin-bottom: 15px; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: #555; border: 2px solid #888; }
.dot.active { background: #00ff00; border-color: #00ff00; box-shadow: 0 0 5px #00ff00; }

/* STATUS BADGES */
.badge-online { background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.badge-offline { background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
</style>
</head>

<body>

<header>
Â  <div style="display:flex; align-items:center">
Â  Â  <div style="width:40px;height:40px;background:white;color:var(--metro-blue);display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;border-radius:3px;">M</div>
Â  Â  <div><h1 style="margin:0; line-height:1.2">Metro Railway Safety Project</h1><small>Secure Data Management Portal</small></div>
Â  Â  <span id="adminBadge" class="hidden" style="background:#dc3545; color:white; margin-left:10px; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:bold;">ADMINISTRATOR</span>
Â  </div>
Â  <div id="authContainer" class="hidden">
Â  Â  <span style="font-size:12px; margin-right:5px; opacity:0.8">Logged in as:</span>
Â  Â  <span id="userInfo" style="margin-right:15px; font-weight:bold; color:#ffc107;"></span>
Â  Â  <button class="danger" onclick="logout()" style="padding:5px 10px; font-size:12px;">LOGOUT</button>
Â  </div>
</header>

<section id="loginSection">
Â  <div class="panel" style="max-width:400px; margin: 60px auto; border-top: 5px solid var(--metro-blue);">
Â  Â  <h3>Authorized Access Only</h3>
Â  Â  <input id="email" placeholder="user@metro.project">
Â  Â  <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
Â  Â  <button onclick="login()" style="width:100%; padding:10px; margin-top:10px;">SECURE LOGIN</button>
Â  </div>
</section>

<div id="nameModal" class="modal-overlay hidden">
Â  Â  <div class="panel" style="width:300px; text-align:center;">
Â  Â  Â  Â  <h3>User Profile Setup</h3>
Â  Â  Â  Â  <p>Please enter your official name for the records.</p>
Â  Â  Â  Â  <input id="officialNameInput" placeholder="Enter Full Name (e.g. Rahul Roy)">
Â  Â  Â  Â  <button onclick="saveOfficialName()">Save & Continue</button>
Â  Â  </div>
</div>

<div id="faceModal" class="modal-overlay hidden">
Â  <h2 id="modalTitle" style="color:white; margin-bottom:5px;">Biometric Verification</h2>
Â  <p id="modalDesc" style="color:#ccc; margin-bottom:15px; font-size:14px;">Initializing AI Models...</p>
Â Â 
Â  <div id="regProgress" class="step-dots hidden" style="justify-content:center;">
Â  Â  Â  <div id="dot1" class="dot"></div>
Â  Â  Â  <div id="dot2" class="dot"></div>
Â  Â  Â  <div id="dot3" class="dot"></div>
Â  </div>

Â  <div id="videoContainer">
Â  Â  <video id="cameraFeed" autoplay playsinline muted></video>
Â  Â  <canvas id="overlayCanvas"></canvas>
Â  </div>
Â Â 
Â  <div id="otpUI" class="hidden" style="text-align:center; background:white; padding:20px; border-radius:5px; width:280px; box-shadow: 0 0 15px black; position:absolute; z-index:20;">
Â  Â  <h3 style="color:#dc3545; margin-top:0;">Face ID Failed (3/3)</h3>
Â  Â  <p style="color:#333; font-size:13px;">Camera Disabled.<br>Enter OTP/PIN:</p>
Â  Â  <input id="otpInput" type="password" placeholder="PIN (Default: 1234)" style="text-align:center; font-size:18px; letter-spacing:5px; border:2px solid #dc3545;">
Â  Â  <button class="success" onclick="verifyOTP()" style="width:100%;">Verify PIN</button>
Â  </div>

Â  <div id="faceStatus" style="color:#ffc107; margin-bottom:15px; font-weight:bold; height:20px;"></div>
Â Â 
Â  <div id="camControls" style="display:flex; gap:10px;">
Â  Â  <button id="btnCapture" onclick="handleFaceScan()" style="background:white; color:black; border:none; padding:10px 20px;">ğŸ“¸ Face Scan</button>
Â  </div>

Â  <button id="adminBypassBtn" class="danger hidden" style="margin-top:20px;" onclick="forceAdminEntry()">âš ï¸ ADMIN FORCE ENTRY</button>
</div>

<section id="appScreen" class="hidden">
Â Â 
Â  <div class="nav-bar">
Â  Â  <button class="nav-btn active" onclick="switchTab('newData')" id="btnNew">1. New Data</button>
Â  Â  <button class="nav-btn" onclick="switchTab('inventory')" id="btnInventory">2. Inventory</button>
Â  Â  <button class="nav-btn" onclick="switchTab('gallery')" id="btnGallery">3. Evidence Gallery</button>
Â  Â  <button class="nav-btn" onclick="switchTab('assigned')" id="btnAssign">4. My Tasks</button>
Â  Â  <button class="nav-btn hidden" onclick="switchTab('adminPanel')" id="btnAdmin" style="background:#721c24; color:white; border-color:#721c24;">Admin Control</button>
Â  Â  <button class="nav-btn hidden" onclick="switchTab('sysLogs')" id="btnLogs">5. System Logs</button>
Â  </div>

Â  <div id="tab-newData">
Â  Â  <div class="panel">
Â  Â  Â  <h3>ğŸ†• Station Data Entry</h3>
Â  Â  Â  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
Â  Â  Â  Â  Â  <input id="inpStationName" placeholder="STATION NAME">
Â  Â  Â  Â  Â  <input id="inpStationLength" placeholder="STATION LENGTH (M)">
Â  Â  Â  Â  Â  <input id="inpYellowDist" placeholder="YELLOW LINE DIST (CM)">
Â  Â  Â  Â  Â  <input id="inpYellowThick" placeholder="YELLOW LINE THICKNESS (CM)">
Â  Â  Â  </div>
Â  Â  Â  <textarea id="inpRemarks" placeholder="Remarks / Observations (Mandatory)" rows="2"></textarea>
Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  <button class="success" onclick="saveStationDetails()">ğŸ’¾ Save Station Draft</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="panel upload-panel">
Â  Â  Â  <h3 style="color:#003366; margin-top:0;">ğŸ“ Evidence Upload Section</h3>
Â  Â  Â  <p style="font-size:12px; color:#666;">Upload site photos, videos, or PDFs separately here.</p>
Â  Â  Â Â 
Â  Â  Â  <input type="file" id="evidenceFile" accept="image/*,application/pdf,video/*" onchange="handleFileUpload()">
Â  Â  Â  <div id="fileStatus" style="font-size:13px; color:green; font-weight:bold; margin:10px 0;"></div>
Â  Â  Â Â 
Â  Â  Â  <button class="warning" onclick="uploadEvidenceOnly()">â¬† Upload Evidence to Database</button>
Â  Â  Â  <div style="margin-top:5px;"><small style="color:red;">* Max 1.5 MB per file (Strict Limit)</small></div>
Â  Â  </div>

Â  Â  <div class="panel">
Â  Â  Â  <h4>Distance Data</h4>
Â  Â  Â  <table><thead><tr><th>SL</th><th>RAKE NO</th><th>TYPE</th><th>FRONT</th><th>REAR</th><th>ACT</th></tr></thead><tbody id="distanceBody"></tbody></table>
Â  Â  Â  <div style="margin-top:10px; display:flex; justify-content:space-between;">
Â  Â  Â  Â  Â  <button onclick="addDistanceRow()">+ Add Row</button>
Â  Â  Â  Â  Â  <button onclick="submitStationData()" style="background:#003366;">âœ” Submit Final Data</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="tab-inventory" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between;"><h3>ğŸ“¦ Inventory</h3><button class="success" onclick="document.getElementById('addInvForm').classList.toggle('hidden')">+ New Item</button></div>
Â  Â  Â  Â  <div id="addInvForm" class="hidden" style="padding:15px; border:1px solid #ccc; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  <div style="display:grid; grid-template-columns: 2fr 1fr 100px; gap:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="invName" placeholder="Product Name"><input id="invQty" type="number" placeholder="Qty"><button onclick="addInventory()">Save</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <table><thead><tr><th>Product</th><th>Qty</th><th>User</th><th>Action</th></tr></thead><tbody id="inventoryBody"></tbody></table>
Â  Â  </div>
Â  </div>

Â  <div id="tab-gallery" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  <h3>ğŸ“ Site Evidence Gallery</h3>
Â  Â  Â  <div id="galleryContainer" class="gallery-grid"></div>
Â  Â  </div>
Â  </div>

Â  <div id="tab-assigned" class="hidden">
Â  Â  <div class="panel"><h3>ğŸ“‹ My Assigned Tasks</h3><div id="taskList"></div></div>
Â  </div>

Â  <div id="tab-adminPanel" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  <h3>ğŸ›¡ï¸ Administrator Console</h3>
Â  Â  Â  Â  <button onclick="loadAdminPanel()" class="primary">ğŸ”„ Refresh</button>
Â  Â  Â  </div>

Â  Â  Â  <h4 style="background:#eee; padding:5px;">1. User Status & Permissions</h4>
Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Name (User)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Online Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Biometric Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Admin Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="userListBody"></tbody>
Â  Â  Â  </table>
Â  Â  Â Â 
Â  Â  Â  <h4 style="background:#eee; padding:5px;">2. Assign Work</h4>
Â  Â  Â  <label>Select Students/Users:</label>
Â  Â  Â  <div id="userCheckboxList" class="checkbox-list"></div>
Â  Â  Â  <div style="margin-top:15px;">
Â  Â  Â  Â  <textarea id="taskDesc" rows="1" placeholder="Enter Task Details..."></textarea>
Â  Â  Â  Â  <button onclick="assignTaskMulti()" style="width:100%; margin-top:5px;">Assign to Selected Users</button>
Â  Â  Â  </div>
Â  Â  Â  <h4 style="background:#eee; padding:5px; margin-top:25px;">3. Master Assignment Tracker</h4>
Â  Â  Â  <div style="max-height:300px; overflow-y:scroll; border:1px solid #ced4da; background:#fff;">
Â  Â  Â  Â  Â  <table style="margin-top:0;">
Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef;">Assigned To</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef;">Task Description</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef; text-align:center;">Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef;">Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  <tbody id="adminTaskBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="4" style="text-align:center">Loading tasks...</td></tr>
Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="tab-sysLogs" class="hidden">
Â  Â  <div class="panel">
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  <h3>ğŸ“œ System Activity Log (Last 60 Events)</h3>
Â  Â  Â  Â  <button onclick="loadSysLogs()" class="primary">ğŸ”„ Refresh Logs</button>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div style="height:400px; overflow-y:scroll; border:1px solid #ccc; background:#fff;">
Â  Â  Â  Â  <table style="margin-top:0;">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef; width:150px;">Time</th>
Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef;">User</th>
Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef;">Event</th>
Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef;">Method</th>
Â  Â  Â  Â  Â  Â  Â  <th style="position:sticky; top:0; background:#e9ecef; width:80px;">Action</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="fullLogBody">
Â  Â  Â  Â  Â  Â  Â <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update, query, limitToLast, onDisconnect, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyAuoKptZlbl1TB3l7fZb_BeK4Oo_P9kuEw",
Â  authDomain: "metro-railway-project.firebaseapp.com",
Â  databaseURL: "https://metro-railway-project-default-rtdb.firebaseio.com",
Â  projectId: "metro-railway-project"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let isAdmin = false;
const ADMIN_EMAILS = ["soham@metro.project", "heerok@metro.project"];
let stream = null;
let currentFileBase64 = null;
let currentFileType = null;
let failCount = 0;
let idleTimer;
let regSamples = [];Â 
let modelsLoaded = false;Â 

// --- NEW HIGH-PERFORMANCE VARS ---
let detectionLoop;
let currentDescriptor = null;

// --- 1. LOAD AI MODELS ---
async function preloadModels() {
Â  Â  if(modelsLoaded) return;Â 
Â  Â  try {
Â  Â  Â  Â  await Promise.all([
Â  Â  Â  Â  Â  Â  faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
Â  Â  Â  Â  Â  Â  faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
Â  Â  Â  Â  Â  Â  faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
Â  Â  Â  Â  ]);
Â  Â  Â  Â  modelsLoaded = true;
Â  Â  } catch(e) { console.error("Model Error", e); }
}
preloadModels();Â 

// --- 2. AUTH & WATCHDOG ---
onAuthStateChanged(auth, (user) => {
Â  if (!user) { showLogin(); return; }
Â Â 
Â  currentUser = user;
Â Â 
Â  // START HEARTBEAT MONITORING
Â  startPresenceSystem(user);
Â Â 
Â  setupIdleTimer();
Â  update(ref(db, `users/${user.uid}`), { email: user.email });

Â  onValue(ref(db, `users/${user.uid}`), (snap) => {
Â  Â  const u = snap.val();
Â  Â  if (u && u.terminated) { alert("ACCOUNT TERMINATED."); signOut(auth); return; }

Â  Â  isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
Â  Â  failCount = 0;
Â  Â Â 
Â  Â  // Check Name
Â  Â  if (!u.name) {
Â  Â  Â  Â  document.getElementById("nameModal").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("loginSection").classList.add("hidden");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (!u.pin) { update(ref(db, `users/${user.uid}`), { pin: "1234" }); }

Â  Â  document.getElementById("userInfo").innerText = `${u.name} (${user.email})`;
Â  Â  document.getElementById("authContainer").classList.remove("hidden");
Â  Â  document.getElementById("loginSection").classList.add("hidden");

Â  Â  if (isAdmin) {
Â  Â  Â  document.getElementById("adminBadge").classList.remove("hidden");
Â  Â  Â  document.getElementById("btnAdmin").classList.remove("hidden");
Â  Â  Â  document.getElementById("btnLogs").classList.remove("hidden"); // SHOW TAB 5
Â  Â  Â  document.getElementById("adminBypassBtn").classList.remove("hidden");
Â  Â  Â  // Pre-load admin data
Â  Â  Â  setTimeout(loadAdminPanel, 2000);Â 
Â  Â  }

Â  Â  // BIOMETRICS
Â  Â  const faceModal = document.getElementById("faceModal");
Â  Â  faceModal.classList.remove("hidden");
Â  Â Â 
Â  Â  if(!u.faceData) {
Â  Â  Â  Â  // REGISTRATION MODE
Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "âš ï¸ Face ID Setup (3 Steps)";
Â  Â  Â  Â  document.getElementById("modalDesc").innerText = "Center your face in the box.";
Â  Â  Â  Â  document.getElementById("regProgress").classList.remove("hidden");
Â  Â  Â  Â  updateRegDots(regSamples.length);
Â  Â  Â  Â  document.getElementById("btnCapture").innerText = `ğŸ“¸ Capture Sample ${regSamples.length + 1} of 3`;
Â  Â  Â  Â  document.getElementById("btnCapture").onclick = registerNewFace;Â 
Â  Â  Â  Â  initCamera(false);
Â  Â  } else {
Â  Â  Â  Â  // VERIFICATION MODE
Â  Â  Â  Â  document.getElementById("modalTitle").innerText = "Biometric Verification";
Â  Â  Â  Â  document.getElementById("modalDesc").innerText = "System Ready.";
Â  Â  Â  Â  document.getElementById("regProgress").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("btnCapture").innerText = "ğŸ“¸ Verify Identity";
Â  Â  Â  Â  document.getElementById("btnCapture").onclick = handleFaceScan;Â 
Â  Â  Â  Â  initCamera(true);
Â  Â  }
Â  });
});

// --- NEW HEARTBEAT SYSTEM ---
function startPresenceSystem(user) {
Â  Â  const userStatusRef = ref(db, `status/${user.uid}`);
Â  Â Â 
Â  Â  // 1. Set online
Â  Â  set(userStatusRef, {
Â  Â  Â  Â  state: 'online',
Â  Â  Â  Â  last_changed: serverTimestamp(),
Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  name: user.displayName || "User"
Â  Â  });

Â  Â  // 2. Set offline on disconnect
Â  Â  onDisconnect(userStatusRef).set({
Â  Â  Â  Â  state: 'offline',
Â  Â  Â  Â  last_changed: serverTimestamp(),
Â  Â  Â  Â  email: user.email
Â  Â  });

Â  Â  // 3. Update heartbeat every 5 sec
Â  Â  setInterval(() => {
Â  Â  Â  Â  if(currentUser) update(userStatusRef, { last_seen: serverTimestamp() });
Â  Â  }, 5000);
}

function updateRegDots(count) {
Â  Â  document.getElementById("dot1").className = count >= 1 ? "dot active" : "dot";
Â  Â  document.getElementById("dot2").className = count >= 2 ? "dot active" : "dot";
Â  Â  document.getElementById("dot3").className = count >= 3 ? "dot active" : "dot";
}

// --- IDLE LOGIC ---
function setupIdleTimer() {
Â  Â  clearTimeout(idleTimer);
Â  Â  window.onmousemove = resetTimer;
Â  Â  window.onclick = resetTimer;
Â  Â  resetTimer();Â 
}
function resetTimer() {
Â  Â  clearTimeout(idleTimer);
Â  Â  if(currentUser) {
Â  Â  Â  Â  idleTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  // Auto Logout
Â  Â  Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGOUT", method: "Auto-Timeout", time: serverTimestamp() };
Â  Â  Â  Â  Â  Â  push(ref(db, "logs"), logData);
Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  alert("Session Timeout.");
Â  Â  Â  Â  }, 5 * 60 * 1000);Â 
Â  Â  }
}

window.saveOfficialName = () => {
Â  Â  const name = document.getElementById("officialNameInput").value;
Â  Â  if(name.length < 3) return alert("Enter full valid name.");
Â  Â  update(ref(db, `users/${currentUser.uid}`), { name: name }).then(() => {
Â  Â  Â  Â  document.getElementById("nameModal").classList.add("hidden");
Â  Â  Â  Â  location.reload();Â 
Â  Â  });
}

function showLogin() {
Â  Â  document.getElementById("loginSection").classList.remove("hidden");
Â  Â  document.getElementById("appScreen").classList.add("hidden");
Â  Â  document.getElementById("authContainer").classList.add("hidden");
Â  Â  document.getElementById("nameModal").classList.add("hidden");
Â  Â  stopCamera();
}

window.login = () => signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert(e.message));

window.logout = async () => {Â 
Â  Â  if(currentUser) {
Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGOUT", method: "Manual Click", time: serverTimestamp() };
Â  Â  Â  Â  await push(ref(db, "logs"), logData);
Â  Â  Â  Â  signOut(auth);
Â  Â  }
};

async function recordLogin(method) {
Â  Â  if(currentUser) {
Â  Â  Â  Â  const logData = { user: currentUser.email, type: "LOGIN", method: method, time: serverTimestamp() };
Â  Â  Â  Â  await push(ref(db, "logs"), logData);
Â  Â  }
}

// --- 3. HIGH PERFORMANCE CAMERA LOGIC ---

async function initCamera(isVerify) {
Â  Â  const vid = document.getElementById("cameraFeed");
Â  Â  const canvas = document.getElementById("overlayCanvas");
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  if(!modelsLoaded) {
Â  Â  Â  Â  Â  Â  updateStatus("Loading AI Models...", "yellow");
Â  Â  Â  Â  Â  Â  await preloadModels();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 320, height: 240 } });
Â  Â  Â  Â  vid.srcObject = stream;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Wait for video to actually play before starting detection loop
Â  Â  Â  Â  vid.onloadedmetadata = () => {
Â  Â  Â  Â  Â  Â  vid.play();
Â  Â  Â  Â  Â  Â  startRealTimeDetection(vid, canvas); // START THE LOOP
Â  Â  Â  Â  };

Â  Â  Â  Â  if(isVerify) updateStatus("LOOK AT CAMERA", "white");
Â  Â  Â  Â  else updateStatus("REGISTRATION: CENTER FACE", "cyan");

Â  Â  } catch(e) {Â 
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  updateStatus("Camera Hardware Error", "red");Â 
Â  Â  }
}

async function startRealTimeDetection(video, canvas) {
Â  Â  const displaySize = { width: video.videoWidth || 320, height: video.videoHeight || 240 };
Â  Â  faceapi.matchDimensions(canvas, displaySize);

Â  Â  if (detectionLoop) clearInterval(detectionLoop);

Â  Â  detectionLoop = setInterval(async () => {
Â  Â  Â  Â  if (!stream) return;

Â  Â  Â  Â  // Optimized settings for speed
Â  Â  Â  Â  const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor();

Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);

Â  Â  Â  Â  if (detection) {
Â  Â  Â  Â  Â  Â  // Draw Box
Â  Â  Â  Â  Â  Â  const resizedDetections = faceapi.resizeResults(detection, displaySize);
Â  Â  Â  Â  Â  Â  const box = resizedDetections.detection.box;
Â  Â  Â  Â  Â  Â  const drawBox = new faceapi.draw.DrawBox(box, { label: "Face Locked", boxColor: "#00ff00" });
Â  Â  Â  Â  Â  Â  drawBox.draw(canvas);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  currentDescriptor = detection.descriptor;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Visual Cue
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  Â  Â  Â  Â  if(btn && !btn.disabled) btn.style.border = "2px solid #00ff00";Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  currentDescriptor = null;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btnCapture");
Â  Â  Â  Â  Â  Â  if(btn) btn.style.border = "1px solid #004494";
Â  Â  Â  Â  }
Â  Â  }, 100); // 10 FPS
}

function stopCamera() {Â 
Â  Â  if(detectionLoop) clearInterval(detectionLoop);
Â  Â  if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
Â  Â Â 
Â  Â  const vid = document.getElementById("cameraFeed");
Â  Â  const canvas = document.getElementById("overlayCanvas");
Â  Â  if(vid) vid.srcObject = null;
Â  Â  if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); }
Â  Â Â 
Â  Â  document.getElementById("faceModal").classList.add("hidden");Â 
}

function updateStatus(m,c) { const e=document.getElementById("faceStatus"); if(e) {e.innerText=m; e.style.color=c;} }

// FAST CAPTURE WITH TIMEOUT AND TRY/CATCH
window.handleFaceScan = async () => {
Â  Â  const btn = document.getElementById("btnCapture");
Â  Â Â 
Â  Â  if(!currentDescriptor) {
Â  Â  Â  Â  updateStatus("âŒ No Face Detected. Look at camera.", "red");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  btn.disabled = true;Â 
Â  Â  btn.innerText = "Processing...";
Â  Â  updateStatus("Verifying Identity...", "cyan");

Â  Â  try {
Â  Â  Â  Â  // 5-Second Timeout Limit (Prevents hanging)
Â  Â  Â  Â  const timeoutPromise = new Promise((_, reject) =>Â 
Â  Â  Â  Â  Â  Â  setTimeout(() => reject(new Error("Network Timeout")), 5000)
Â  Â  Â  Â  );

Â  Â  Â  Â  // Race: Database Fetch vs 5-Second Timer
Â  Â  Â  Â  const snap = await Promise.race([
Â  Â  Â  Â  Â  Â  get(ref(db, `users/${currentUser.uid}/faceData`)),
Â  Â  Â  Â  Â  Â  timeoutPromise
Â  Â  Â  Â  ]);

Â  Â  Â  Â  const storedData = snap.val();

Â  Â  Â  Â  if (!storedData) throw new Error("No face data found.");

Â  Â  Â  Â  let matchFound = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Compare Face
Â  Â  Â  Â  if(storedData[0] instanceof Array || Array.isArray(storedData[0])) {
Â  Â  Â  Â  Â  Â  Â for (let sample of storedData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const dist = faceapi.euclideanDistance(sample, currentDescriptor);
Â  Â  Â  Â  Â  Â  Â  Â  Â if(dist < 0.55) { matchFound = true; break; }Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â const dist = faceapi.euclideanDistance(storedData, currentDescriptor);
Â  Â  Â  Â  Â  Â  Â if(dist < 0.55) matchFound = true;
Â  Â  Â  Â  }

Â  Â  Â  Â  if(matchFound) {
Â  Â  Â  Â  Â  Â  updateStatus("âœ… VERIFIED", "#00ff00");
Â  Â  Â  Â  Â  Â  await recordLogin("Biometric");
Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error("Face Mismatch");
Â  Â  Â  Â  }

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  updateStatus("âŒ " + (error.message.includes("Timeout") ? "Slow Connection" : "Access Denied"), "red");
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerText = "ğŸ“¸ Retry Scan";
Â  Â  Â  Â  handleFail();
Â  Â  }
};

window.registerNewFace = async () => {
Â  Â  if(!currentDescriptor) {
Â  Â  Â  Â  updateStatus("âŒ Camera cannot see face clearly.", "orange");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  regSamples.push(Array.from(currentDescriptor));
Â  Â  const count = regSamples.length;
Â  Â  updateRegDots(count);

Â  Â  if(count < 3) {
Â  Â  Â  Â  updateStatus(`âœ… Sample ${count}/3 Captured. Move head slightly.`, "lightgreen");
Â  Â  Â  Â  document.getElementById("btnCapture").innerText = `ğŸ“¸ Capture Sample ${count + 1} of 3`;
Â  Â  } else {
Â  Â  Â  Â  updateStatus("ğŸ’¾ Saving Biometric Profile...", "yellow");
Â  Â  Â  Â  await update(ref(db, `users/${currentUser.uid}`), { faceData: regSamples });
Â  Â  Â  Â  alert("Registration Complete!");
Â  Â  Â  Â  location.reload();
Â  Â  }
};

function handleFail() {
Â  Â  failCount++;
Â  Â  if(failCount >= 3) {
Â  Â  Â  Â  stopCamera();Â 
Â  Â  Â  Â  document.getElementById("faceModal").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("videoContainer").classList.add("hidden");Â 
Â  Â  Â  Â  document.getElementById("camControls").classList.add("hidden");
Â  Â  Â  Â  document.getElementById("otpUI").classList.remove("hidden");Â 
Â  Â  Â  Â  updateStatus("âš ï¸ Camera Disabled. Enter PIN.", "red");
Â  Â  } else {
Â  Â  Â  Â  updateStatus(`âŒ Failed. Attempts left: ${3 - failCount}`, "orange");
Â  Â  }
}

window.verifyOTP = () => {
Â  Â  const input = document.getElementById("otpInput").value;
Â  Â  get(ref(db, `users/${currentUser.uid}/pin`)).then(async snap => {
Â  Â  Â  Â  const actualPin = snap.val() || "1234";
Â  Â  Â  Â  if(input === actualPin) {
Â  Â  Â  Â  Â  Â  await recordLogin("PIN Entry");
Â  Â  Â  Â  Â  Â  enterApp();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("Wrong PIN âŒ");
Â  Â  Â  Â  }
Â  Â  });
}

window.forceAdminEntry = async () => {
Â  Â  if(!isAdmin) return;
Â  Â  await recordLogin("Admin Bypass");
Â  Â  enterApp();
}

function enterApp() {
Â  Â  stopCamera();Â 
Â  Â  document.getElementById("faceModal").classList.add("hidden");
Â  Â  document.getElementById("appScreen").classList.remove("hidden");
Â  Â  switchTab('newData');
Â  Â  loadDraft(); loadGallery(); loadInventory(); loadAssignments();
}

// --- APP FEATURES ---

window.saveStationDetails = () => {
Â  Â  const name = document.getElementById("inpStationName").value.trim();
Â  Â  if(!name) return alert("Station Name Required");
Â  Â  update(ref(db, `drafts/${currentUser.uid}/details`), {
Â  Â  Â  Â  name: name,
Â  Â  Â  Â  len: document.getElementById("inpStationLength").value,
Â  Â  Â  Â  yl: document.getElementById("inpYellowDist").value,
Â  Â  Â  Â  th: document.getElementById("inpYellowThick").value,
Â  Â  Â  Â  remarks: document.getElementById("inpRemarks").value
Â  Â  });
Â  Â  alert("Draft Saved");
};

window.uploadEvidenceOnly = () => {
Â  Â  if(!currentFileBase64) return alert("Select a file first.");
Â  Â Â 
Â  Â  if(confirm("Upload Evidence?")) {
Â  Â  Â  Â  push(ref(db, "history"), {Â 
Â  Â  Â  Â  Â  Â  name: "Evidence Upload",Â 
Â  Â  Â  Â  Â  Â  user: currentUser.email,Â 
Â  Â  Â  Â  Â  Â  userName: currentUser.name,Â 
Â  Â  Â  Â  Â  Â  date: new Date().toLocaleString(),
Â  Â  Â  Â  Â  Â  fileData: currentFileBase64,Â 
Â  Â  Â  Â  Â  Â  fileType: currentFileType
Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  document.getElementById("evidenceFile").value = "";
Â  Â  Â  Â  Â  Â  document.getElementById("fileStatus").innerText = "";
Â  Â  Â  Â  Â  Â  currentFileBase64 = null;
Â  Â  Â  Â  Â  Â  alert("Evidence Uploaded.");Â 
Â  Â  Â  Â  Â  Â  switchTab('gallery');
Â  Â  Â  Â  });
Â  Â  }
};

window.handleFileUpload = () => {
Â  Â  const file = document.getElementById("evidenceFile").files[0];
Â  Â  document.getElementById("fileStatus").innerText = "Processing...";
Â  Â  if(file && file.size < 1.5*1024*1024) {Â 
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = e => { currentFileBase64 = e.target.result; currentFileType = file.type; document.getElementById("fileStatus").innerText = "Ready: " + file.name; };
Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  } else {Â 
Â  Â  Â  Â  alert("File too large! Max 1.5MB");Â 
Â  Â  Â  Â  document.getElementById("fileStatus").innerText = "Error: File too large";
Â  Â  }
}

window.submitStationData = () => {
Â  Â  get(ref(db, `drafts/${currentUser.uid}`)).then(s => {
Â  Â  Â  Â  const d = s.val();
Â  Â  Â  Â  if(!d || !d.details) return alert("No Data.");
Â  Â  Â  Â  if(confirm("Submit Final?")) {
Â  Â  Â  Â  Â  Â  push(ref(db, "history"), {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ...d.details, rows: d.rows, user: currentUser.email, userName: currentUser.name, date: new Date().toLocaleString()
Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  remove(ref(db, `drafts/${currentUser.uid}`));
Â  Â  Â  Â  Â  Â  Â  Â  alert("Submitted"); switchTab('gallery');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
};

// --- ADMIN LOGIC ---
function formatTime(ts) {
Â  Â  if(!ts) return "N/A";
Â  Â  return new Date(ts).toLocaleString();
}

// --- UPDATED ADMIN PANEL LOADER ---
window.loadAdminPanel = async () => {
Â  Â  const userList = document.getElementById("userCheckboxList");
Â  Â  const userTable = document.getElementById("userListBody");
Â  Â  const taskBody = document.getElementById("adminTaskBody"); // New Target
Â  Â Â 
Â  Â  userList.innerHTML = "Loading...";
Â  Â  userTable.innerHTML = "<tr><td colspan='4'>Loading Status...</td></tr>";

Â  Â  // FETCH USERS, STATUS, AND ASSIGNMENTS
Â  Â  const [userSnap, statusSnap, assignSnap] = await Promise.all([
Â  Â  Â  Â  get(ref(db, "users")),
Â  Â  Â  Â  get(ref(db, "status")),
Â  Â  Â  Â  get(ref(db, "assignments")) // Now fetching assignments too
Â  Â  ]);
Â  Â Â 
Â  Â  const statusMap = statusSnap.val() || {};
Â  Â  userTable.innerHTML = "";
Â  Â  userList.innerHTML = "";
Â  Â  taskBody.innerHTML = ""; // Clear task table

Â  Â  // 1. RENDER USER LIST & STATUS
Â  Â  userSnap.forEach(c => {
Â  Â  Â  Â  const u = c.val();
Â  Â  Â  Â  const uid = c.key;
Â  Â  Â  Â  const displayName = u.name || u.email;

Â  Â  Â  Â  // Checkbox
Â  Â  Â  Â  userList.innerHTML += `<label class="checkbox-item"><input type="checkbox" class="user-check" value="${uid}"> ${displayName}</label>`;

Â  Â  Â  Â  // Online/Offline Logic
Â  Â  Â  Â  let isOnline = false;
Â  Â  Â  Â  const s = statusMap[uid];
Â  Â  Â  Â  if(s && s.state === 'online') {
Â  Â  Â  Â  Â  Â  const diff = Date.now() - (s.last_seen || 0);
Â  Â  Â  Â  Â  Â  if(diff < 20000) isOnline = true;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const statusBadge = isOnline ?Â 
Â  Â  Â  Â  Â  Â  `<span class="badge-online">â— ONLINE</span>` :Â 
Â  Â  Â  Â  Â  Â  `<span class="badge-offline">â—‹ OFFLINE</span>`;

Â  Â  Â  Â  const bioBadge = u.faceData ?Â 
Â  Â  Â  Â  Â  Â  `<span style="color:green; font-weight:bold;">âœ” Registered</span>` :Â 
Â  Â  Â  Â  Â  Â  `<span style="color:red; font-weight:bold;">âŒ Pending</span>`;

Â  Â  Â  Â  const pinInput = `<input id="pin_${uid}" placeholder="${u.pin||'1234'}" style="width:50px; text-align:center;"> <button onclick="savePin('${uid}')" style="padding:2px 5px;">Set</button>`;
Â  Â  Â  Â  const reUploadBtn = `<button class="danger" style="padding:2px 5px;" onclick="forceReUpload('${uid}')">Reset Face</button>`;
Â  Â  Â  Â  const resetNameBtn = `<button class="warning" style="padding:2px 5px;" onclick="retakeName('${uid}')">Reset Name</button>`;

Â  Â  Â  Â  userTable.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  <td>${u.name}<br><small>${u.email}</small></td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${statusBadge}</td>
Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${bioBadge}</td>
Â  Â  Â  Â  Â  Â  <td>${pinInput}<br>${reUploadBtn} ${resetNameBtn}</td>
Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  // 2. RENDER ASSIGNMENT TRACKER (NEW LOGIC)
Â  Â  if (!assignSnap.exists()) {
Â  Â  Â  Â  taskBody.innerHTML = "<tr><td colspan='4' style='text-align:center'>No active assignments found.</td></tr>";
Â  Â  } else {
Â  Â  Â  Â  assignSnap.forEach(userNode => {
Â  Â  Â  Â  Â  Â  const uid = userNode.key;
Â  Â  Â  Â  Â  Â  // Resolve Name from User Snapshot
Â  Â  Â  Â  Â  Â  const userName = userSnap.child(uid).val()?.name || "Unknown User";

Â  Â  Â  Â  Â  Â  userNode.forEach(taskNode => {
Â  Â  Â  Â  Â  Â  Â  Â  const t = taskNode.val();
Â  Â  Â  Â  Â  Â  Â  Â  const taskId = taskNode.key;

Â  Â  Â  Â  Â  Â  Â  Â  const statusBadge = t.status === 'Done'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<span style="background:green; color:white; padding:3px 8px; border-radius:10px; font-size:11px;">âœ” COMPLETED</span>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<span style="background:#ffc107; color:black; padding:3px 8px; border-radius:10px; font-size:11px;">â³ PENDING</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  taskBody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${userName}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${t.desc}<br><small style="color:#666">${t.date}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${statusBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" style="padding:2px 6px;" onclick="delTask('${uid}', '${taskId}')">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }
};

// NEW FUNCTION TO DELETE ASSIGNMENT
window.delTask = (uid, taskId) => {
Â  Â  if(confirm("Permanently delete this assignment?")) {
Â  Â  Â  Â  remove(ref(db, `assignments/${uid}/${taskId}`))
Â  Â  Â  Â  Â  Â  .then(() => loadAdminPanel()) // Refresh to see changes
Â  Â  Â  Â  Â  Â  .catch(e => alert(e.message));
Â  Â  }
};

// --- TAB 5: SYSTEM LOGS LOGIC ---
window.loadSysLogs = () => {
Â  Â  const tbody = document.getElementById("fullLogBody");
Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading data...</td></tr>";

Â  Â  const q = query(ref(db, "logs"), limitToLast(60));

Â  Â  onValue(q, (snap) => {
Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  snap.forEach(c => logs.push({ key: c.key, ...c.val() }));
Â  Â  Â  Â  logs.reverse();

Â  Â  Â  Â  if(logs.length === 0) {
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No logs found.</td></tr>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  logs.forEach(x => {
Â  Â  Â  Â  Â  Â  let color = "black";
Â  Â  Â  Â  Â  Â  let bg = "transparent";
Â  Â  Â  Â  Â  Â  let icon = "ğŸ“";

Â  Â  Â  Â  Â  Â  if(x.type === "LOGIN") { color = "green"; bg = "#eaffea"; icon = "ğŸŸ¢"; }
Â  Â  Â  Â  Â  Â  else if(x.type === "LOGOUT") { color = "red"; bg = "#ffeaea"; icon = "ğŸ”´"; }
Â  Â  Â  Â  Â  Â  else if(x.type.includes("Fail")) { color = "orange"; icon = "âš ï¸"; }

Â  Â  Â  Â  Â  Â  // Delete Button (Admins Only)
Â  Â  Â  Â  Â  Â  const delBtn = isAdminÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<button class="danger" style="padding:2px 6px; font-size:11px;" onclick="deleteLogEntry('${x.key}')">ğŸ—‘ï¸</button>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  : `<span style="color:#ccc; font-size:10px;">ğŸ”’</span>`;

Â  Â  Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr style="background:${bg}">
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${formatTime(x.time)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px; font-weight:bold;">${x.user}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:${color}; font-size:12px;">${icon} ${x.type}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-size:12px;">${x.method}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center;">${delBtn}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  });
Â  Â  });
};

window.deleteLogEntry = (key) => {
Â  Â  if(!isAdmin) return alert("Access Denied: Admins Only.");
Â  Â  if(confirm("Permanently delete this log entry?")) {
Â  Â  Â  Â  remove(ref(db, `logs/${key}`)).catch(e => alert("Error: " + e.message));
Â  Â  }
};

window.assignTaskMulti = () => {
Â  Â  const desc = document.getElementById("taskDesc").value;
Â  Â  if(!desc) return alert("Please enter task details.");
Â  Â  const checkboxes = document.querySelectorAll('.user-check:checked');
Â  Â  if(checkboxes.length === 0) return alert("Select at least one user.");

Â  Â  checkboxes.forEach(cb => {
Â  Â  Â  Â  const uid = cb.value;
Â  Â  Â  Â  const task = { desc, by: currentUser.email, date: new Date().toLocaleString(), status: "Pending" };
Â  Â  Â  Â  push(ref(db, `assignments/${uid}`), task);
Â  Â  });
Â  Â  alert(`Task assigned to ${checkboxes.length} user(s).`);
Â  Â  document.getElementById("taskDesc").value = "";
Â  Â  checkboxes.forEach(cb => cb.checked = false);
};

window.savePin = (uid) => {
Â  Â  const p = document.getElementById(`pin_${uid}`).value;
Â  Â  if(p.length >= 4) { update(ref(db, `users/${uid}`), { pin: p }); alert("PIN Updated"); }
}

window.forceReUpload = (uid) => {
Â  Â  if(confirm("Reset Face Data?")) { remove(ref(db, `users/${uid}/faceData`)).then(() => alert("Face Data Reset. User must scan face on next login.")); }
}
window.retakeName = (uid) => update(ref(db, `users/${uid}`), { name: null }).then(() => alert("Name Reset."));

window.switchTab = (t) => {
Â  Â  ['newData','inventory','gallery','assigned','adminPanel','sysLogs'].forEach(x => {
Â  Â  Â  Â  const el = document.getElementById(`tab-${x}`);
Â  Â  Â  Â  if(el) el.classList.add("hidden");
Â  Â  });
Â  Â  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
Â  Â Â 
Â  Â  const target = document.getElementById(`tab-${t}`);
Â  Â  if(target) target.classList.remove("hidden");
Â  Â Â 
Â  Â  // Highlight Button
Â  Â  const btnId = t === 'sysLogs' ? 'btnLogs' : (t === 'newData' ? 'btnNew' : (t === 'inventory' ? 'btnInventory' : (t === 'gallery' ? 'btnGallery' : (t === 'assigned' ? 'btnAssign' : 'btnAdmin'))));
Â  Â  const btn = document.getElementById(btnId);
Â  Â  if(btn) btn.classList.add("active");

Â  Â  if(t==='adminPanel' && isAdmin) loadAdminPanel();
Â  Â  if(t==='gallery') loadGallery();
Â  Â  if(t==='sysLogs') loadSysLogs();Â 
};

window.addDistanceRow = () => push(ref(db, `drafts/${currentUser.uid}/rows`), { rake: "", type: "", f: "", r: "" });

function loadGallery() {
Â  Â  const div = document.getElementById("galleryContainer");Â 
Â  Â  div.innerHTML = "<p>Loading...</p>";

Â  Â  onValue(ref(db, "history"), snap => {
Â  Â  Â  Â  div.innerHTML = "";
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  if(v.fileData) {
Â  Â  Â  Â  Â  Â  Â  Â  let media = `<div style="padding:10px; color:#666;">Unsupported</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(v.fileType.includes("image")) media = `<img src="${v.fileData}">`;
Â  Â  Â  Â  Â  Â  Â  Â  else if(v.fileType.includes("pdf")) media = `<div style="height:100px; display:flex; align-items:center; justify-content:center; background:#f0f0f0;">ğŸ“„ PDF</div>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let controls = `<br><small style="color:grey;">(View Only)</small>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  controls = `<div style="margin-top:5px; display:flex; justify-content:center; gap:5px;"><a href="${v.fileData}" download="Evidence" style="background:#003366; color:white; padding:3px 8px; text-decoration:none; font-size:11px; border-radius:3px;">â¬‡ Download</a><button class="danger" style="padding:2px 5px; font-size:11px;" onclick="removeFile('${c.key}')">Remove File</button></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML += `<div class="gallery-item">${media}<div style="font-size:11px; margin-top:5px;"><b>${v.name}</b><br>by ${v.userName}</div>${controls}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(div.innerHTML === "") div.innerHTML = "<p>No evidence found.</p>";
Â  Â  });
}

window.removeFile = (k) => {
Â  Â  if(confirm("Remove attached file?")) {
Â  Â  Â  Â  update(ref(db, `history/${k}`), { fileData: null, fileType: null, fileRemoved: true });
Â  Â  }
}

function loadDraft() {
Â  Â  onValue(ref(db, `drafts/${currentUser.uid}`), snap => {
Â  Â  Â  Â  const d = snap.val();
Â  Â  Â  Â  if(d) {
Â  Â  Â  Â  Â  Â  document.getElementById("inpStationName").value = d.details?.name || "";
Â  Â  Â  Â  Â  Â  document.getElementById("inpStationLength").value = d.details?.len || "";
Â  Â  Â  Â  Â  Â  document.getElementById("inpYellowDist").value = d.details?.yl || "";
Â  Â  Â  Â  Â  Â  document.getElementById("inpYellowThick").value = d.details?.th || "";
Â  Â  Â  Â  Â  Â  document.getElementById("inpRemarks").value = d.details?.remarks || "";
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById("distanceBody"); tbody.innerHTML="";
Â  Â  Â  Â  Â  Â  if(d.rows) Object.entries(d.rows).forEach(([k,v], i) => renderRow(k,v,i+1));
Â  Â  Â  Â  }
Â  Â  });
}
function renderRow(k,v,i) {
Â  Â  const b = document.getElementById("distanceBody");
Â  Â  b.innerHTML += `<tr><td>${i}</td><td><input value="${v.rake}" onchange="upRow('${k}','rake',this.value)"></td><td><input value="${v.type}" onchange="upRow('${k}','type',this.value)"></td><td><input value="${v.f}" onchange="upRow('${k}','f',this.value)"></td><td><input value="${v.r}" onchange="upRow('${k}','r',this.value)"></td><td><button class="danger" onclick="delRow('${k}')">X</button></td></tr>`;
}
window.upRow = (k,f,v) => update(ref(db, `drafts/${currentUser.uid}/rows/${k}`), {[f]:v});
window.delRow = (k) => remove(ref(db, `drafts/${currentUser.uid}/rows/${k}`));

function loadInventory() {
Â  Â  onValue(ref(db, "inventory"), snap => {
Â  Â  Â  Â  const b = document.getElementById("inventoryBody"); b.innerHTML = "";
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const v = c.val();
Â  Â  Â  Â  Â  Â  b.innerHTML += `<tr><td>${v.item}</td><td>${v.qty}</td><td>${v.user}</td><td>${isAdmin ? `<button class="danger" onclick="delInv('${c.key}')">X</button>`:''}</td></tr>`;
Â  Â  Â  Â  });
Â  Â  });
}
window.addInventory = () => { push(ref(db, "inventory"), { item: invName.value, qty: invQty.value, user: currentUser.email }); document.getElementById("addInvForm").classList.add("hidden"); };
window.delInv = (k) => remove(ref(db, `inventory/${k}`));

function loadAssignments() {
Â  Â  onValue(ref(db, `assignments/${currentUser.uid}`), snap => {
Â  Â  Â  Â  const list = document.getElementById("taskList"); list.innerHTML = "";
Â  Â  Â  Â  if(!snap.exists()) { list.innerHTML = "<p>No tasks.</p>"; return; }
Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  const t = c.val();
Â  Â  Â  Â  Â  Â  const div = document.createElement("div"); div.className = "panel";
Â  Â  Â  Â  Â  Â  div.style.borderLeft = t.status === 'Done' ? "5px solid green" : "5px solid #ffc107";
Â  Â  Â  Â  Â  Â  div.innerHTML = `<strong>${t.desc}</strong><br><small>By: ${t.by}</small><br>${t.status !== 'Done' ? `<button onclick="completeTask('${c.key}')">Done</button>` : 'Completed'}`;
Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  });
Â  Â  });
}
window.completeTask = (k) => update(ref(db, `assignments/${currentUser.uid}/${k}`), { status: "Done" });

</script>
</body>
</html>

admin not able to track the log in and log out time of user 
